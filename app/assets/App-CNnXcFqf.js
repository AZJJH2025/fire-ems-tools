var js=Object.defineProperty;var vs=(t,n,r)=>n in t?js(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r;var it=(t,n,r)=>vs(t,typeof n!="symbol"?n+"":n,r);import{g as Ts,a as Ss,r as N,u as Es,j as e,s as ft,c as Fs,b as Cs,m as Ds,d as ws,_ as ts,e as at,f as Be,B as j,t as Lt,h as Is,C as Ve,i as Me,k as As,l as _s,n as ss,o as Le,p as he,R as Je,q as Ne,v as $s,G as Rs,w as Os,x as Ms,y as Ns}from"./index-BF8t0v4A.js";import{U as zt}from"./CloudUpload-BBMFXPVM.js";import{T as f,c as de,P as fe,u as Mt}from"./Typography-13spNxpp.js";import{G as pe,C as le}from"./listItemTextClasses-DcyqPnkc.js";import{F as Ae,I as $e,S as Re,A as ce,a as Ce,T as be,b as Ps,M as ks}from"./TextField-Hjysagf8.js";import{M as ne}from"./MenuItem-C9DJM4RZ.js";import{B as oe,L as Ue}from"./List-D1Q15Lzo.js";import{D as ye,a as Ke,b as Xe,c as Ze,d as Qe}from"./Divider-l9Dy5u4B.js";import{A as tt}from"./ArrowBack-Ds_kCt1r.js";import{S as Ls,a as rs}from"./Save-VYY2iQ2o.js";import{C as zs,S as rt}from"./Search-CU3--lpA.js";import{F as Vs}from"./FormGroup-6qniv6y6.js";import{F as We}from"./FormControlLabel-CIehn-jQ.js";import{T as dt,a as ut,b as Pe,c as Se,d as pt,e as wt}from"./TableRow-BOXLLnhp.js";import{T as ze,A as Us,E as Bs}from"./Edit-C0W5H3oW.js";import{S as st,L as Hs,C as It,T as Gs,P as ns}from"./PictureAsPdf-rFfe4RgS.js";import{C as qe}from"./CheckCircle-Cesk47JM.js";import{D as nt}from"./Delete-UZ7rf-Pk.js";import{I as Oe}from"./InputAdornment-dY1szujT.js";import{A as os,a as as,E as xt,b as is,C as ls}from"./ExpandMore-CboZzTz9.js";import{S as cs}from"./Settings-DG6sLf-z.js";import{E as ds}from"./Error-wSECUA_9.js";import{W as us}from"./Warning-D0hxiUFI.js";import{T as Vt,E as ps,D as Tt}from"./dataTransformer-B7lYSPiT.js";import{T as yt,a as De}from"./Tabs-DrDMGG0h.js";import{C as Ws}from"./Close-DBt6x466.js";import{H as Ys}from"./HelpOutline-CZ90qP0o.js";import{L as Ee,a as ke,b as Fe,c as At}from"./ListItemText-B7p02niH.js";import{B as St}from"./Business-DYYjdM5F.js";import{C as bt,a as jt}from"./CardContent-bn2tLDvM.js";import{S as ms}from"./Snackbar-CFFZcxVC.js";import{D as qs}from"./Download-DF8RrpwM.js";import{D as mt}from"./Description-B6RRwf5A.js";import{E as Js}from"./jspdf.es.min-DvaYIF7J.js";import{T as Ks}from"./TableChart-Bc525vGa.js";import{R as Xs,a as lt}from"./RadioGroup-yXgt85IL.js";import{M as Zs}from"./Map-B9G5UxCM.js";import{T as Qs}from"./AccessTime-BzPq7Y7q.js";import{L as er}from"./LocalFireDepartment-BmdzJLcE.js";import{S as tr}from"./Security-Cvgl4g1H.js";import{C as sr}from"./CardActions-B9Bvzdv0.js";import{B as rr}from"./Badge-Eo2wSwx6.js";import{S as nr,a as or,b as ar}from"./Stepper-WUxZV9uY.js";import"./dividerClasses-DMj-e4ki.js";import"./Popper-n8cYu7w1.js";function ir(t){return Ts("MuiAlertTitle",t)}Ss("MuiAlertTitle",["root"]);const lr=t=>{const{classes:n}=t;return Cs({root:["root"]},ir,n)},cr=ft(f,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(t,n)=>n.root})(Ds(({theme:t})=>({fontWeight:t.typography.fontWeightMedium,marginTop:-2}))),dr=N.forwardRef(function(n,r){const s=Es({props:n,name:"MuiAlertTitle"}),{className:a,...o}=s,l=s,p=lr(l);return e.jsx(cr,{gutterBottom:!0,component:"div",ownerState:l,ref:r,className:Fs(p.root,a),...o})}),Nt=de(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}));var ct={exports:{}};/* @license
Papa Parse
v5.5.3
https://github.com/mholt/PapaParse
License: MIT
*/var ur=ct.exports,Ut;function pr(){return Ut||(Ut=1,function(t,n){((r,s)=>{t.exports=s()})(ur,function r(){var s=typeof self<"u"?self:typeof window<"u"?window:s!==void 0?s:{},a,o=!s.document&&!!s.postMessage,l=s.IS_PAPA_WORKER||!1,p={},u=0,d={};function h(i){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(c){var y=H(c);y.chunkSize=parseInt(y.chunkSize),c.step||c.chunk||(y.chunkSize=null),this._handle=new A(y),(this._handle.streamer=this)._config=y}).call(this,i),this.parseChunk=function(c,y){var w=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<w){let T=this._config.newline;T||(P=this._config.quoteChar||'"',T=this._handle.guessLineEndings(c,P)),c=[...c.split(T).slice(w)].join(T)}this.isFirstChunk&&J(this._config.beforeFirstChunk)&&(P=this._config.beforeFirstChunk(c))!==void 0&&(c=P),this.isFirstChunk=!1,this._halted=!1;var w=this._partialLine+c,P=(this._partialLine="",this._handle.parse(w,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(c=P.meta.cursor,w=(this._finished||(this._partialLine=w.substring(c-this._baseIndex),this._baseIndex=c),P&&P.data&&(this._rowCount+=P.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),l)s.postMessage({results:P,workerId:d.WORKER_ID,finished:w});else if(J(this._config.chunk)&&!y){if(this._config.chunk(P,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=P=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(P.data),this._completeResults.errors=this._completeResults.errors.concat(P.errors),this._completeResults.meta=P.meta),this._completed||!w||!J(this._config.complete)||P&&P.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),w||P&&P.meta.paused||this._nextChunk(),P}this._halted=!0},this._sendError=function(c){J(this._config.error)?this._config.error(c):l&&this._config.error&&s.postMessage({workerId:d.WORKER_ID,error:c,finished:!1})}}function x(i){var c;(i=i||{}).chunkSize||(i.chunkSize=d.RemoteChunkSize),h.call(this,i),this._nextChunk=o?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(y){this._input=y,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(c=new XMLHttpRequest,this._config.withCredentials&&(c.withCredentials=this._config.withCredentials),o||(c.onload=X(this._chunkLoaded,this),c.onerror=X(this._chunkError,this)),c.open(this._config.downloadRequestBody?"POST":"GET",this._input,!o),this._config.downloadRequestHeaders){var y,w=this._config.downloadRequestHeaders;for(y in w)c.setRequestHeader(y,w[y])}var P;this._config.chunkSize&&(P=this._start+this._config.chunkSize-1,c.setRequestHeader("Range","bytes="+this._start+"-"+P));try{c.send(this._config.downloadRequestBody)}catch(T){this._chunkError(T.message)}o&&c.status===0&&this._chunkError()}},this._chunkLoaded=function(){c.readyState===4&&(c.status<200||400<=c.status?this._chunkError():(this._start+=this._config.chunkSize||c.responseText.length,this._finished=!this._config.chunkSize||this._start>=(y=>(y=y.getResponseHeader("Content-Range"))!==null?parseInt(y.substring(y.lastIndexOf("/")+1)):-1)(c),this.parseChunk(c.responseText)))},this._chunkError=function(y){y=c.statusText||y,this._sendError(new Error(y))}}function S(i){(i=i||{}).chunkSize||(i.chunkSize=d.LocalChunkSize),h.call(this,i);var c,y,w=typeof FileReader<"u";this.stream=function(P){this._input=P,y=P.slice||P.webkitSlice||P.mozSlice,w?((c=new FileReader).onload=X(this._chunkLoaded,this),c.onerror=X(this._chunkError,this)):c=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var P=this._input,T=(this._config.chunkSize&&(T=Math.min(this._start+this._config.chunkSize,this._input.size),P=y.call(P,this._start,T)),c.readAsText(P,this._config.encoding));w||this._chunkLoaded({target:{result:T}})},this._chunkLoaded=function(P){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(P.target.result)},this._chunkError=function(){this._sendError(c.error)}}function C(i){var c;h.call(this,i=i||{}),this.stream=function(y){return c=y,this._nextChunk()},this._nextChunk=function(){var y,w;if(!this._finished)return y=this._config.chunkSize,c=y?(w=c.substring(0,y),c.substring(y)):(w=c,""),this._finished=!c,this.parseChunk(w)}}function $(i){h.call(this,i=i||{});var c=[],y=!0,w=!1;this.pause=function(){h.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){h.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(P){this._input=P,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){w&&c.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),c.length?this.parseChunk(c.shift()):y=!0},this._streamData=X(function(P){try{c.push(typeof P=="string"?P:P.toString(this._config.encoding)),y&&(y=!1,this._checkIsFinished(),this.parseChunk(c.shift()))}catch(T){this._streamError(T)}},this),this._streamError=X(function(P){this._streamCleanUp(),this._sendError(P)},this),this._streamEnd=X(function(){this._streamCleanUp(),w=!0,this._streamData("")},this),this._streamCleanUp=X(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function A(i){var c,y,w,P,T=Math.pow(2,53),k=-T,ie=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,R=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,L=this,te=0,g=0,U=!1,O=!1,B=[],D={data:[],errors:[],meta:{}};function v(I){return i.skipEmptyLines==="greedy"?I.join("").trim()==="":I.length===1&&I[0].length===0}function F(){if(D&&w&&(G("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),w=!1),i.skipEmptyLines&&(D.data=D.data.filter(function(m){return!v(m)})),K()){let m=function(z,W){J(i.transformHeader)&&(z=i.transformHeader(z,W)),B.push(z)};if(D)if(Array.isArray(D.data[0])){for(var I=0;K()&&I<D.data.length;I++)D.data[I].forEach(m);D.data.splice(0,1)}else D.data.forEach(m)}function M(m,z){for(var W=i.header?{}:[],Z=0;Z<m.length;Z++){var ae=Z,re=m[Z],re=((je,ee)=>(ue=>(i.dynamicTypingFunction&&i.dynamicTyping[ue]===void 0&&(i.dynamicTyping[ue]=i.dynamicTypingFunction(ue)),(i.dynamicTyping[ue]||i.dynamicTyping)===!0))(je)?ee==="true"||ee==="TRUE"||ee!=="false"&&ee!=="FALSE"&&((ue=>{if(ie.test(ue)&&(ue=parseFloat(ue),k<ue&&ue<T))return 1})(ee)?parseFloat(ee):R.test(ee)?new Date(ee):ee===""?null:ee):ee)(ae=i.header?Z>=B.length?"__parsed_extra":B[Z]:ae,re=i.transform?i.transform(re,ae):re);ae==="__parsed_extra"?(W[ae]=W[ae]||[],W[ae].push(re)):W[ae]=re}return i.header&&(Z>B.length?G("FieldMismatch","TooManyFields","Too many fields: expected "+B.length+" fields but parsed "+Z,g+z):Z<B.length&&G("FieldMismatch","TooFewFields","Too few fields: expected "+B.length+" fields but parsed "+Z,g+z)),W}var b;D&&(i.header||i.dynamicTyping||i.transform)&&(b=1,!D.data.length||Array.isArray(D.data[0])?(D.data=D.data.map(M),b=D.data.length):D.data=M(D.data,0),i.header&&D.meta&&(D.meta.fields=B),g+=b)}function K(){return i.header&&B.length===0}function G(I,M,b,m){I={type:I,code:M,message:b},m!==void 0&&(I.row=m),D.errors.push(I)}J(i.step)&&(P=i.step,i.step=function(I){D=I,K()?F():(F(),D.data.length!==0&&(te+=I.data.length,i.preview&&te>i.preview?y.abort():(D.data=D.data[0],P(D,L))))}),this.parse=function(I,M,b){var m=i.quoteChar||'"',m=(i.newline||(i.newline=this.guessLineEndings(I,m)),w=!1,i.delimiter?J(i.delimiter)&&(i.delimiter=i.delimiter(I),D.meta.delimiter=i.delimiter):((m=((z,W,Z,ae,re)=>{var je,ee,ue,Te;re=re||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var se=0;se<re.length;se++){for(var Q,me=re[se],ge=0,we=0,xe=0,ve=(ue=void 0,new _({comments:ae,delimiter:me,newline:W,preview:10}).parse(z)),_e=0;_e<ve.data.length;_e++)Z&&v(ve.data[_e])?xe++:(Q=ve.data[_e].length,we+=Q,ue===void 0?ue=Q:0<Q&&(ge+=Math.abs(Q-ue),ue=Q));0<ve.data.length&&(we/=ve.data.length-xe),(ee===void 0||ge<=ee)&&(Te===void 0||Te<we)&&1.99<we&&(ee=ge,je=me,Te=we)}return{successful:!!(i.delimiter=je),bestDelimiter:je}})(I,i.newline,i.skipEmptyLines,i.comments,i.delimitersToGuess)).successful?i.delimiter=m.bestDelimiter:(w=!0,i.delimiter=d.DefaultDelimiter),D.meta.delimiter=i.delimiter),H(i));return i.preview&&i.header&&m.preview++,c=I,y=new _(m),D=y.parse(c,M,b),F(),U?{meta:{paused:!0}}:D||{meta:{paused:!1}}},this.paused=function(){return U},this.pause=function(){U=!0,y.abort(),c=J(i.chunk)?"":c.substring(y.getCharIndex())},this.resume=function(){L.streamer._halted?(U=!1,L.streamer.parseChunk(c,!0)):setTimeout(L.resume,3)},this.aborted=function(){return O},this.abort=function(){O=!0,y.abort(),D.meta.aborted=!0,J(i.complete)&&i.complete(D),c=""},this.guessLineEndings=function(z,m){z=z.substring(0,1048576);var m=new RegExp(Y(m)+"([^]*?)"+Y(m),"gm"),b=(z=z.replace(m,"")).split("\r"),m=z.split(`
`),z=1<m.length&&m[0].length<b[0].length;if(b.length===1||z)return`
`;for(var W=0,Z=0;Z<b.length;Z++)b[Z][0]===`
`&&W++;return W>=b.length/2?`\r
`:"\r"}}function Y(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _(i){var c=(i=i||{}).delimiter,y=i.newline,w=i.comments,P=i.step,T=i.preview,k=i.fastMode,ie=null,R=!1,L=i.quoteChar==null?'"':i.quoteChar,te=L;if(i.escapeChar!==void 0&&(te=i.escapeChar),(typeof c!="string"||-1<d.BAD_DELIMITERS.indexOf(c))&&(c=","),w===c)throw new Error("Comment character same as delimiter");w===!0?w="#":(typeof w!="string"||-1<d.BAD_DELIMITERS.indexOf(w))&&(w=!1),y!==`
`&&y!=="\r"&&y!==`\r
`&&(y=`
`);var g=0,U=!1;this.parse=function(O,B,D){if(typeof O!="string")throw new Error("Input must be a string");var v=O.length,F=c.length,K=y.length,G=w.length,I=J(P),M=[],b=[],m=[],z=g=0;if(!O)return ge();if(k||k!==!1&&O.indexOf(L)===-1){for(var W=O.split(y),Z=0;Z<W.length;Z++){if(m=W[Z],g+=m.length,Z!==W.length-1)g+=y.length;else if(D)return ge();if(!w||m.substring(0,G)!==w){if(I){if(M=[],Te(m.split(c)),we(),U)return ge()}else Te(m.split(c));if(T&&T<=Z)return M=M.slice(0,T),ge(!0)}}return ge()}for(var ae=O.indexOf(c,g),re=O.indexOf(y,g),je=new RegExp(Y(te)+Y(L),"g"),ee=O.indexOf(L,g);;)if(O[g]===L)for(ee=g,g++;;){if((ee=O.indexOf(L,ee+1))===-1)return D||b.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:M.length,index:g}),Q();if(ee===v-1)return Q(O.substring(g,ee).replace(je,L));if(L===te&&O[ee+1]===te)ee++;else if(L===te||ee===0||O[ee-1]!==te){ae!==-1&&ae<ee+1&&(ae=O.indexOf(c,ee+1));var ue=se((re=re!==-1&&re<ee+1?O.indexOf(y,ee+1):re)===-1?ae:Math.min(ae,re));if(O.substr(ee+1+ue,F)===c){m.push(O.substring(g,ee).replace(je,L)),O[g=ee+1+ue+F]!==L&&(ee=O.indexOf(L,g)),ae=O.indexOf(c,g),re=O.indexOf(y,g);break}if(ue=se(re),O.substring(ee+1+ue,ee+1+ue+K)===y){if(m.push(O.substring(g,ee).replace(je,L)),me(ee+1+ue+K),ae=O.indexOf(c,g),ee=O.indexOf(L,g),I&&(we(),U))return ge();if(T&&M.length>=T)return ge(!0);break}b.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:M.length,index:g}),ee++}}else if(w&&m.length===0&&O.substring(g,g+G)===w){if(re===-1)return ge();g=re+K,re=O.indexOf(y,g),ae=O.indexOf(c,g)}else if(ae!==-1&&(ae<re||re===-1))m.push(O.substring(g,ae)),g=ae+F,ae=O.indexOf(c,g);else{if(re===-1)break;if(m.push(O.substring(g,re)),me(re+K),I&&(we(),U))return ge();if(T&&M.length>=T)return ge(!0)}return Q();function Te(xe){M.push(xe),z=g}function se(xe){var ve=0;return ve=xe!==-1&&(xe=O.substring(ee+1,xe))&&xe.trim()===""?xe.length:ve}function Q(xe){return D||(xe===void 0&&(xe=O.substring(g)),m.push(xe),g=v,Te(m),I&&we()),ge()}function me(xe){g=xe,Te(m),m=[],re=O.indexOf(y,g)}function ge(xe){if(i.header&&!B&&M.length&&!R){var ve=M[0],_e=Object.create(null),vt=new Set(ve);let Pt=!1;for(let He=0;He<ve.length;He++){let Ie=ve[He];if(_e[Ie=J(i.transformHeader)?i.transformHeader(Ie,He):Ie]){let et,kt=_e[Ie];for(;et=Ie+"_"+kt,kt++,vt.has(et););vt.add(et),ve[He]=et,_e[Ie]++,Pt=!0,(ie=ie===null?{}:ie)[et]=Ie}else _e[Ie]=1,ve[He]=Ie;vt.add(Ie)}Pt&&console.warn("Duplicate headers found and renamed."),R=!0}return{data:M,errors:b,meta:{delimiter:c,linebreak:y,aborted:U,truncated:!!xe,cursor:z+(B||0),renamedHeaders:ie}}}function we(){P(ge()),M=[],b=[]}},this.abort=function(){U=!0},this.getCharIndex=function(){return g}}function q(i){var c=i.data,y=p[c.workerId],w=!1;if(c.error)y.userError(c.error,c.file);else if(c.results&&c.results.data){var P={abort:function(){w=!0,V(c.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:E,resume:E};if(J(y.userStep)){for(var T=0;T<c.results.data.length&&(y.userStep({data:c.results.data[T],errors:c.results.errors,meta:c.results.meta},P),!w);T++);delete c.results}else J(y.userChunk)&&(y.userChunk(c.results,P,c.file),delete c.results)}c.finished&&!w&&V(c.workerId,c.results)}function V(i,c){var y=p[i];J(y.userComplete)&&y.userComplete(c),y.terminate(),delete p[i]}function E(){throw new Error("Not implemented.")}function H(i){if(typeof i!="object"||i===null)return i;var c,y=Array.isArray(i)?[]:{};for(c in i)y[c]=H(i[c]);return y}function X(i,c){return function(){i.apply(c,arguments)}}function J(i){return typeof i=="function"}return d.parse=function(i,c){var y=(c=c||{}).dynamicTyping||!1;if(J(y)&&(c.dynamicTypingFunction=y,y={}),c.dynamicTyping=y,c.transform=!!J(c.transform)&&c.transform,!c.worker||!d.WORKERS_SUPPORTED)return y=null,d.NODE_STREAM_INPUT,typeof i=="string"?(i=(w=>w.charCodeAt(0)!==65279?w:w.slice(1))(i),y=new(c.download?x:C)(c)):i.readable===!0&&J(i.read)&&J(i.on)?y=new $(c):(s.File&&i instanceof File||i instanceof Object)&&(y=new S(c)),y.stream(i);(y=(()=>{var w;return!!d.WORKERS_SUPPORTED&&(w=(()=>{var P=s.URL||s.webkitURL||null,T=r.toString();return d.BLOB_URL||(d.BLOB_URL=P.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",T,")();"],{type:"text/javascript"})))})(),(w=new s.Worker(w)).onmessage=q,w.id=u++,p[w.id]=w)})()).userStep=c.step,y.userChunk=c.chunk,y.userComplete=c.complete,y.userError=c.error,c.step=J(c.step),c.chunk=J(c.chunk),c.complete=J(c.complete),c.error=J(c.error),delete c.worker,y.postMessage({input:i,config:c,workerId:y.id})},d.unparse=function(i,c){var y=!1,w=!0,P=",",T=`\r
`,k='"',ie=k+k,R=!1,L=null,te=!1,g=((()=>{if(typeof c=="object"){if(typeof c.delimiter!="string"||d.BAD_DELIMITERS.filter(function(B){return c.delimiter.indexOf(B)!==-1}).length||(P=c.delimiter),typeof c.quotes!="boolean"&&typeof c.quotes!="function"&&!Array.isArray(c.quotes)||(y=c.quotes),typeof c.skipEmptyLines!="boolean"&&typeof c.skipEmptyLines!="string"||(R=c.skipEmptyLines),typeof c.newline=="string"&&(T=c.newline),typeof c.quoteChar=="string"&&(k=c.quoteChar),typeof c.header=="boolean"&&(w=c.header),Array.isArray(c.columns)){if(c.columns.length===0)throw new Error("Option columns is empty");L=c.columns}c.escapeChar!==void 0&&(ie=c.escapeChar+k),c.escapeFormulae instanceof RegExp?te=c.escapeFormulae:typeof c.escapeFormulae=="boolean"&&c.escapeFormulae&&(te=/^[=+\-@\t\r].*$/)}})(),new RegExp(Y(k),"g"));if(typeof i=="string"&&(i=JSON.parse(i)),Array.isArray(i)){if(!i.length||Array.isArray(i[0]))return U(null,i,R);if(typeof i[0]=="object")return U(L||Object.keys(i[0]),i,R)}else if(typeof i=="object")return typeof i.data=="string"&&(i.data=JSON.parse(i.data)),Array.isArray(i.data)&&(i.fields||(i.fields=i.meta&&i.meta.fields||L),i.fields||(i.fields=Array.isArray(i.data[0])?i.fields:typeof i.data[0]=="object"?Object.keys(i.data[0]):[]),Array.isArray(i.data[0])||typeof i.data[0]=="object"||(i.data=[i.data])),U(i.fields||[],i.data||[],R);throw new Error("Unable to serialize unrecognized input");function U(B,D,v){var F="",K=(typeof B=="string"&&(B=JSON.parse(B)),typeof D=="string"&&(D=JSON.parse(D)),Array.isArray(B)&&0<B.length),G=!Array.isArray(D[0]);if(K&&w){for(var I=0;I<B.length;I++)0<I&&(F+=P),F+=O(B[I],I);0<D.length&&(F+=T)}for(var M=0;M<D.length;M++){var b=(K?B:D[M]).length,m=!1,z=K?Object.keys(D[M]).length===0:D[M].length===0;if(v&&!K&&(m=v==="greedy"?D[M].join("").trim()==="":D[M].length===1&&D[M][0].length===0),v==="greedy"&&K){for(var W=[],Z=0;Z<b;Z++){var ae=G?B[Z]:Z;W.push(D[M][ae])}m=W.join("").trim()===""}if(!m){for(var re=0;re<b;re++){0<re&&!z&&(F+=P);var je=K&&G?B[re]:re;F+=O(D[M][je],re)}M<D.length-1&&(!v||0<b&&!z)&&(F+=T)}}return F}function O(B,D){var v,F;return B==null?"":B.constructor===Date?JSON.stringify(B).slice(1,25):(F=!1,te&&typeof B=="string"&&te.test(B)&&(B="'"+B,F=!0),v=B.toString().replace(g,ie),(F=F||y===!0||typeof y=="function"&&y(B,D)||Array.isArray(y)&&y[D]||((K,G)=>{for(var I=0;I<G.length;I++)if(-1<K.indexOf(G[I]))return!0;return!1})(v,d.BAD_DELIMITERS)||-1<v.indexOf(P)||v.charAt(0)===" "||v.charAt(v.length-1)===" ")?k+v+k:v)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!o&&!!s.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=_,d.ParserHandle=A,d.NetworkStreamer=x,d.FileStreamer=S,d.StringStreamer=C,d.ReadableStreamStreamer=$,s.jQuery&&((a=s.jQuery).fn.parse=function(i){var c=i.config||{},y=[];return this.each(function(T){if(!(a(this).prop("tagName").toUpperCase()==="INPUT"&&a(this).attr("type").toLowerCase()==="file"&&s.FileReader)||!this.files||this.files.length===0)return!0;for(var k=0;k<this.files.length;k++)y.push({file:this.files[k],inputElem:this,instanceConfig:a.extend({},c)})}),w(),this;function w(){if(y.length===0)J(i.complete)&&i.complete();else{var T,k,ie,R,L=y[0];if(J(i.before)){var te=i.before(L.file,L.inputElem);if(typeof te=="object"){if(te.action==="abort")return T="AbortError",k=L.file,ie=L.inputElem,R=te.reason,void(J(i.error)&&i.error({name:T},k,ie,R));if(te.action==="skip")return void P();typeof te.config=="object"&&(L.instanceConfig=a.extend(L.instanceConfig,te.config))}else if(te==="skip")return void P()}var g=L.instanceConfig.complete;L.instanceConfig.complete=function(U){J(g)&&g(U,L.file,L.inputElem),P()},d.parse(L.file,L.instanceConfig)}}function P(){y.splice(0,1),w()}}),l&&(s.onmessage=function(i){i=i.data,d.WORKER_ID===void 0&&i&&(d.WORKER_ID=i.workerId),typeof i.input=="string"?s.postMessage({workerId:d.WORKER_ID,results:d.parse(i.input,i.config),finished:!0}):(s.File&&i.input instanceof File||i.input instanceof Object)&&(i=d.parse(i.input,i.config))&&s.postMessage({workerId:d.WORKER_ID,results:i,finished:!0})}),(x.prototype=Object.create(h.prototype)).constructor=x,(S.prototype=Object.create(h.prototype)).constructor=S,(C.prototype=Object.create(C.prototype)).constructor=C,($.prototype=Object.create(h.prototype)).constructor=$,d})}(ct)),ct.exports}var mr=pr();const hr=ws(mr),gr=async(t,n)=>{switch(n){case"csv":return fr(t);case"excel":return xr(t);case"json":return yr(t);case"xml":return br(t);case"pdf":return jr(t);case"txt":return vr(t);default:throw new Error(`Unsupported file type: ${n}`)}},fr=t=>new Promise((n,r)=>{hr.parse(t,{header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:s=>{const a=s.meta.fields||[],o=s.data;n({columns:a,data:o.slice(0,100)})},error:s=>{r(new Error(`Error parsing CSV: ${s.message}`))}})}),xr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=async a=>{var o;try{const l=(o=a.target)==null?void 0:o.result;if(!l){r(new Error("Failed to read Excel file"));return}const p=await ts(()=>import("./xlsx-DkH2s96g.js"),[]),u=p.read(l,{type:"array"}),d=u.SheetNames[0],h=u.Sheets[d],x=p.utils.sheet_to_json(h,{header:1});if(x.length===0){r(new Error("Excel file is empty"));return}const S=x[0].map(String),C=x.slice(1).map($=>{const A={};return $.forEach((Y,_)=>{_<S.length&&(A[S[_]]=Y)}),A});n({columns:S,data:C.slice(0,100)})}catch(l){r(new Error(`Error parsing Excel file: ${l instanceof Error?l.message:"Unknown error"}`))}},s.onerror=()=>{r(new Error("Error reading Excel file"))},s.readAsArrayBuffer(t)}),yr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=a=>{var o;try{const l=(o=a.target)==null?void 0:o.result,p=JSON.parse(l);if(Array.isArray(p)){if(p.length===0){r(new Error("JSON file contains an empty array"));return}const u=Array.from(new Set(p.flatMap(d=>Object.keys(d))));n({columns:u,data:p.slice(0,100)})}else if(p&&typeof p=="object"){const u=Object.keys(p).find(d=>Array.isArray(p[d]));if(u&&p[u].length>0){const d=p[u],h=Array.from(new Set(d.flatMap(x=>Object.keys(x))));n({columns:h,data:d.slice(0,100)})}else{const d=Object.keys(p);n({columns:d,data:[p]})}}else r(new Error("JSON file format not recognized"))}catch(l){r(new Error(`Error parsing JSON file: ${l instanceof Error?l.message:"Invalid JSON"}`))}},s.onerror=()=>{r(new Error("Error reading JSON file"))},s.readAsText(t)}),br=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=a=>{var o,l;try{const p=(o=a.target)==null?void 0:o.result,d=new DOMParser().parseFromString(p,"text/xml"),h=d.getElementsByTagName("*"),x=new Map;for(let V=0;V<h.length;V++){const E=h[V].tagName;x.set(E,(x.get(E)||0)+1)}const S=Array.from(x.entries()).filter(([V,E])=>E>1).map(([V])=>V).sort((V,E)=>(x.get(E)||0)-(x.get(V)||0));if(S.length===0){r(new Error("Could not identify repeating elements in XML"));return}const C=S[0],$=d.getElementsByTagName(C);if($.length===0){r(new Error(`No elements found with tag ${C}`));return}const A=$[0],_=Array.from(A.children).map(V=>V.tagName),q=[];for(let V=0;V<Math.min($.length,100);V++){const E=$[V],H={};for(const X of _){const J=((l=E.getElementsByTagName(X)[0])==null?void 0:l.textContent)||"";H[X]=J}q.push(H)}n({columns:_,data:q})}catch(p){r(new Error(`Error parsing XML file: ${p instanceof Error?p.message:"Invalid XML"}`))}},s.onerror=()=>{r(new Error("Error reading XML file"))},s.readAsText(t)}),jr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=async a=>{var o;try{if(!((o=a.target)==null?void 0:o.result)){r(new Error("Failed to read PDF file"));return}n({columns:["Information"],data:[{Information:"PDF files are not currently supported for direct parsing in the browser."},{Information:"Please convert your PDF to CSV, Excel, or JSON format for processing."},{Information:"Alternatively, copy and paste the data from your PDF into a text file."},{Information:`File name: ${t.name}`},{Information:`File size: ${(t.size/1024).toFixed(2)} KB`},{Information:"Supported formats: CSV, Excel (.xlsx, .xls), JSON, XML, TXT"}]})}catch(l){r(new Error(`Error processing PDF: ${l instanceof Error?l.message:"Unknown error"}`))}},s.onerror=()=>{r(new Error("Error reading PDF file"))},s.readAsArrayBuffer(t)}),vr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=a=>{var o;try{const l=(o=a.target)==null?void 0:o.result;if(!l){r(new Error("Failed to read text file"));return}const p=l.split(`
`).map(x=>x.trim()).filter(x=>x.length>0);if(p.length===0){r(new Error("Text file is empty"));return}const u=[",","	","|",";"];let d="",h=0;for(const x of u){const S=p.slice(0,10).map(A=>A.split(x).length),C=S.reduce((A,Y)=>A+Y,0)/S.length;S.every(A=>Math.abs(A-C)<=1&&A>1)&&C>h&&(h=C,d=x)}if(d&&h>1){const x=p[0].split(d).map(C=>C.trim()),S=[];for(let C=1;C<Math.min(p.length,100);C++){const $=p[C].split(d).map(Y=>Y.trim()),A={};for(let Y=0;Y<x.length;Y++)A[x[Y]]=$[Y]||"";S.push(A)}n({columns:x,data:S})}else{const x=p.slice(0,100).map((S,C)=>({LineNumber:C+1,Text:S}));n({columns:["LineNumber","Text"],data:x})}}catch(l){r(new Error(`Error parsing text file: ${l instanceof Error?l.message:"Unknown error"}`))}},s.onerror=()=>{r(new Error("Error reading text file"))},s.readAsText(t)}),Tr=()=>{const t=at(),n=Be(s=>s.formatter.selectedTool),r=s=>{const a=s.target.value,o=Lt.find(l=>l.id===a);o&&t(Is(o))};return e.jsxs(j,{sx:{my:3},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Select Target Tool"}),e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(Ae,{fullWidth:!0,children:[e.jsx($e,{id:"tool-select-label",children:"Tool"}),e.jsx(Re,{labelId:"tool-select-label",id:"tool-select",value:(n==null?void 0:n.id)||"",label:"Tool",onChange:r,children:Lt.map(s=>e.jsx(ne,{value:s.id,children:s.name},s.id))})]})}),e.jsx(pe,{size:12,children:n&&e.jsxs(fe,{variant:"outlined",sx:{p:2,mt:2,borderColor:"primary.light"},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:n.name}),e.jsx(f,{variant:"body2",paragraph:!0,children:n.description}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Required fields: ",n.requiredFields.map(s=>s.name).join(", ")]})]})})]})]})},Sr=()=>{const t=at(),n=N.useRef(null),{sourceColumns:r,selectedTool:s}=Be(V=>V.formatter),[a,o]=N.useState("csv"),[l,p]=N.useState(!1),[u,d]=N.useState(null),[h,x]=N.useState(null),S=V=>{o(V.target.value)},C=async V=>{var H;const E=(H=V.target.files)==null?void 0:H[0];if(E){x(E.name),p(!0),d(null);try{t(Me("uploading"));const X={id:`file-${Date.now()}`,name:E.name,type:a,size:E.size,lastModified:E.lastModified},{columns:J,data:i}=await gr(E,a);t(As(X)),t(_s(J)),t(ss(i)),t(Me("idle")),setTimeout(()=>{t(Le(1))},500)}catch(X){d(X instanceof Error?X.message:"Failed to parse file"),t(Me("error"))}finally{p(!1)}}},$=()=>{var V;(V=n.current)==null||V.click()},A=V=>{var H;V.preventDefault(),V.stopPropagation();const E=(H=V.dataTransfer.files)==null?void 0:H[0];if(E&&n.current){const X=new DataTransfer;X.items.add(E),n.current.files=X.files,C({target:{files:X.files}})}},Y=V=>{V.preventDefault(),V.stopPropagation()},_=()=>{t(Le(1))},q=r.length>0&&s!==null;return e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(f,{variant:"h5",gutterBottom:!0,children:"Upload Data File"}),e.jsx(f,{variant:"body1",paragraph:!0,children:"Select a file to upload. The formatter supports CSV, Excel (.xlsx, .xls, .xlsm), PDF, JSON, XML, and plain text files."}),e.jsxs(pe,{container:!0,spacing:3,children:[e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(Ae,{fullWidth:!0,children:[e.jsx($e,{id:"file-type-select-label",children:"File Type"}),e.jsxs(Re,{labelId:"file-type-select-label",id:"file-type-select",value:a,label:"File Type",onChange:S,children:[e.jsx(ne,{value:"csv",children:"CSV"}),e.jsx(ne,{value:"excel",children:"Excel (.xlsx/.xls/.xlsm)"}),e.jsx(ne,{value:"json",children:"JSON"}),e.jsx(ne,{value:"xml",children:"XML"}),e.jsx(ne,{value:"pdf",children:"PDF"}),e.jsx(ne,{value:"txt",children:"Text File"})]})]})}),e.jsxs(pe,{size:12,children:[e.jsx("input",{type:"file",ref:n,onChange:C,style:{display:"none"},accept:a==="csv"?".csv":a==="excel"?".xlsx,.xls,.xlsm":a==="json"?".json":a==="xml"?".xml":a==="pdf"?".pdf":a==="txt"?".txt":void 0}),e.jsx(fe,{elevation:0,onDrop:A,onDragOver:Y,sx:{border:"2px dashed #ccc",borderRadius:2,p:3,textAlign:"center",cursor:"pointer",bgcolor:"#f8f9fa","&:hover":{borderColor:"primary.main"}},onClick:$,children:l?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(Ve,{}),e.jsx(f,{variant:"body1",sx:{mt:2},children:"Processing file..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(zt,{fontSize:"large",color:"primary"}),e.jsx(f,{variant:"h6",sx:{mt:2},children:h?`Selected: ${h}`:"Drag & drop file here or click to browse"}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Supports ",a==="csv"?"CSV":a==="excel"?"Excel (.xlsx, .xls, .xlsm)":a==="json"?"JSON":a==="xml"?"XML":a==="pdf"?"PDF":"Text"," files"]})]})}),u&&e.jsx(ce,{severity:"error",sx:{mt:2},children:u}),h&&!l&&!u&&e.jsxs(ce,{severity:"success",sx:{mt:2},children:["File selected: ",h]})]}),e.jsx(pe,{size:12,sx:{mt:2,display:"flex",justifyContent:"center"},children:e.jsx(oe,{variant:"contained",size:"large",onClick:$,startIcon:e.jsx(zt,{}),disabled:l,children:"Browse Files"})})]}),e.jsx(ye,{sx:{my:4}}),e.jsx(Tr,{}),e.jsx(j,{sx:{display:"flex",justifyContent:"flex-end",mt:4},children:e.jsx(oe,{variant:"contained",size:"large",endIcon:e.jsx(Nt,{}),onClick:_,disabled:!q,children:"Continue to Field Mapping"})}),!q&&e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mt:2,textAlign:"right"},children:r.length?"Select a target tool to continue":"Upload a file to continue"})]})},Bt=t=>["dispatch_time","enroute_time","arrival_time","clear_time"].includes(t),Et=t=>["incident_date"].includes(t),Er=t=>{if(!t||typeof t!="string")return t;const n=[/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2})$/,/^.+\s+(\d{1,2}:\d{2}(?::\d{2})?)$/];for(const s of n){const a=t.match(s);if(a&&a[1])return a[1]}return/^\d{1,2}:\d{2}(?::\d{2})?$/.test(t.trim())?t.trim():t},Fr=t=>{if(console.log(`üîç DATE EXTRACTION: Input "${t}" (type: ${typeof t})`),!t||typeof t!="string")return console.log("üîç DATE EXTRACTION: Invalid input, returning original"),t;const n=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^(\d{4}-\d{2}-\d{2})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^([^\\s]+)\s+\d{1,2}:\d{2}(?::\d{2})?$/];for(let s=0;s<n.length;s++){const a=n[s],o=t.match(a);if(console.log(`üîç Pattern ${s+1} test: "${t}" ‚Üí ${o?`MATCH: "${o[1]}"`:"NO MATCH"}`),o&&o[1])return console.log(`üîç DATE EXTRACTION SUCCESS: "${t}" ‚Üí "${o[1]}"`),o[1]}const r=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const s of r)if(s.test(t.trim()))return t.trim();return t},hs=(t,n)=>!t||!t.length||!n||!n.length?[]:t.map(r=>{const s={},a=new Set;return n.forEach(o=>{const{sourceField:l,targetField:p,transformations:u}=o;let d;if(l==="__default__"&&u&&u.length>0){const h=u.find(x=>x.type==="convert"&&x.params.defaultValue);h?(console.log(`Using default value for ${p}:`,h.params.defaultValue),d=h.params.defaultValue):(console.log(`No default value found for ${p}, using null`),d=null)}else if(l.includes("_")&&l.split("_").length>=2){const[h,...x]=l.split("_"),S=x.join("_"),C=[`${h}_parsed_${S}`,`${h}_parsed_${p}`,l];console.log(`ü§ñ DEBUG: Looking for parsed data with sourceField: "${l}"`),console.log("ü§ñ DEBUG: Trying keys:",C),console.log("ü§ñ DEBUG: Available row keys:",Object.keys(r));let $=!1;for(const A of C)if(r[A]!==void 0&&r[A]!==null){d=r[A],console.log(`ü§ñ ‚úÖ Using PARSED value for ${p} from key "${A}": "${d}"`),$=!0;break}else console.log(`ü§ñ ‚ùå No data found at key: "${A}"`);$||(d=r[l],console.log(`ü§ñ ‚ö†Ô∏è No parsed data found, using source value for ${p} from ${l}:`,d))}else d=r[l],console.log(`Using source value for ${p} from ${l}:`,d);if(u&&u.length>0){console.log(`Applying ${u.length} transformations to ${p}:`,u);const h=d;d=Cr(d,u,p,r),console.log(`Transformation result for ${p}:`,h,"‚Üí",d)}if(p==="incident_type"&&d!==null&&d!==void 0&&(typeof d=="number"?(console.log(`üî¢ Converting numeric incident_type to string: ${d} ‚Üí "${String(d)}"`),d=String(d)):typeof d!="string"&&(console.log(`üîÑ Converting incident_type to string: ${d} (${typeof d}) ‚Üí "${String(d)}"`),d=String(d))),console.log(`üîß CHECKING FIELD: ${p}, isTimeOnly: ${Bt(p)}, isDateOnly: ${Et(p)}, value type: ${typeof d}`),d&&typeof d=="string")if(Bt(p)){const h=Er(d);h!==d?(console.log(`üïí Auto-extracted time for ${p}: "${d}" ‚Üí "${h}"`),d=h):console.log(`üïí No time extraction needed for ${p}: "${d}"`)}else if(Et(p)){console.log(`üìÖ ATTEMPTING DATE EXTRACTION for ${p}: Input value "${d}"`);const h=Fr(d);console.log(`üìÖ DATE EXTRACTION RESULT: "${d}" ‚Üí "${h}" (changed: ${h!==d})`),h!==d?(console.log(`üìÖ ‚úÖ Auto-extracted date for ${p}: "${d}" ‚Üí "${h}"`),d=h):console.log(`üìÖ ‚ùå No date extraction needed for ${p}: "${d}"`)}else p==="incident_time"&&console.log(`üïí Keeping full datetime for ${p}: "${d}"`);if(s[p]=d,l!==p&&l!=="__default__"&&!a.has(l)&&!l.includes("_parsed_")){if(n.some(x=>x.targetField===l))console.log(`üö´ SKIPPING PRESERVATION: "${l}" is also a target field - keeping transformed value`);else{let x=d;Et(p)&&r[l]&&typeof r[l]=="string"&&r[l].includes(" ")&&(x=r[l],console.log(`üìÖ PRESERVING FULL DATETIME for original field "${l}": "${x}" (target "${p}" gets date-only: "${d}")`)),s[l]=x,console.log(`üîÑ PRESERVED ORIGINAL FIELD NAME: "${l}" ‚Üí "${x}" (also mapped to ${p})`)}a.add(l)}else l.includes("_parsed_")&&console.log(`ü§ñ SKIPPING PARSED FIELD PRESERVATION: "${l}" (parsed field injection key)`)}),Object.keys(s).forEach(o=>{o.includes("_parsed_")&&(console.log(`üßπ CLEANUP: Removing parsed field injection key "${o}" from transformed data`),delete s[o])}),s}),Cr=(t,n,r,s)=>n.reduce((a,o)=>gs(a,o,r,s),t),gs=(t,n,r,s)=>{const{type:a,params:o}=n,l={...o,...r&&{fieldName:r},...s&&{rowData:s}};switch(a){case"split":return Ir(t,l);case"join":return Ar(t,l);case"format":return _r(t,l);case"convert":return $r(t,l);case"extract":return Dr(t,l);case"replace":return wr(t,l);case"datetime_combine":return Rr(t,l);case"datetime_extract":return Or(t,l);case"parseCoordinates":return Mr(t,l);default:return t}},Dr=(t,n)=>{if(typeof t!="string")return t;const{pattern:r}=n;try{const s=new RegExp(r),a=t.match(s);if(a&&a.length>0)return a[1]||a[0]}catch{console.error("Invalid regex pattern:",r)}return t},wr=(t,n)=>{if(typeof t!="string")return t;const{from:r,to:s="",useRegex:a=!1}=n;if(!r)return t;try{if(a){const o=new RegExp(r,"g");return t.replace(o,s)}else return t.replace(new RegExp(r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),s)}catch(o){return console.error("Error in replace transformation:",o),t}},Ir=(t,n)=>{if(typeof t!="string")return t;const{delimiter:r,index:s}=n,a=t.split(r);return s!==void 0?a[s]||"":a},Ar=(t,n)=>{if(!Array.isArray(t))return t;const{delimiter:r=", "}=n;return t.join(r)},_r=(t,n)=>{const{format:r,type:s,fieldName:a}=n;if(console.log("applyFormatTransformation called with:",{value:t,format:r,type:s,fieldName:a}),s==="date"&&t)try{const o=new Date(t);if(isNaN(o.getTime()))return t;switch(r){case"MM/DD/YYYY":return`${o.getMonth()+1}/${o.getDate()}/${o.getFullYear()}`;case"YYYY-MM-DD":return`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${o.getDate()}/${o.getMonth()+1}/${o.getFullYear()}`;case"date-only":return o.toLocaleDateString();case"custom":return(n.customFormat||"YYYY-MM-DD").replace("YYYY",o.getFullYear().toString()).replace("MM",(o.getMonth()+1).toString().padStart(2,"0")).replace("DD",o.getDate().toString().padStart(2,"0")).replace("HH",o.getHours().toString().padStart(2,"0")).replace("mm",o.getMinutes().toString().padStart(2,"0")).replace("ss",o.getSeconds().toString().padStart(2,"0"));case"ISO":return o.toISOString();default:return t}}catch{return t}if(s==="number"&&t!==void 0&&t!==null)try{const o=Number(t);if(isNaN(o))return t;switch(r){case"integer":return Math.round(o);case"fixed2":return o.toFixed(2);case"currency":return`$${o.toFixed(2)}`;case"percent":return`${(o*100).toFixed(1)}%`;default:return t}}catch{return t}return t},$r=(t,n)=>{const{targetType:r}=n;switch(r){case"string":return t!=null?String(t):"";case"number":if(t==null||t==="")return null;const s=Number(t);return isNaN(s)?t:s;case"boolean":return typeof t=="string"?["true","yes","1","y"].includes(t.toLowerCase()):!!t;case"date":if(!t)return null;try{const a=new Date(t);return isNaN(a.getTime())?t:a}catch{return t}default:return t}},Rr=(t,n)=>{const{sourceFields:r,description:s,rowData:a}=n;if(console.log("üïê DATETIME COMBINE: Starting transformation"),console.log("üïê Source fields:",r),console.log("üïê Primary value:",t),console.log("üïê Description:",s),!r||r.length<2)return console.log("‚ö†Ô∏è DATETIME COMBINE: Need at least 2 source fields"),t;if(!a)return console.log("‚ö†Ô∏è DATETIME COMBINE: No row data provided for field combination"),t;const[o,l]=r,p=String(a[o]||"").trim(),u=String(a[l]||"").trim();if(console.log(`üïê Date field "${o}":`,p),console.log(`üïê Time field "${l}":`,u),!p||!u)return console.log("‚ö†Ô∏è DATETIME COMBINE: Missing date or time component"),t;const d=`${p} ${u}`;return console.log("‚úÖ DATETIME COMBINE: Result:",d),d},Or=(t,n)=>{const{extractType:r,description:s}=n;if(console.log("üïê DATETIME EXTRACT: Starting transformation"),console.log("üïê Extract type:",r),console.log("üïê Input value:",t),console.log("üïê Description:",s),!t||typeof t!="string")return console.log("‚ö†Ô∏è DATETIME EXTRACT: Invalid input value"),t;const a=t.trim();if(r==="date"){const o=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+/,/^(\d{4}-\d{2}-\d{2})\s+/];for(const p of o){const u=a.match(p);if(u){const d=u[1];return console.log("‚úÖ DATETIME EXTRACT (date):",d),d}}const l=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const p of l)if(p.test(a))return console.log("‚úÖ DATETIME EXTRACT (date): Already date-only format"),a}else if(r==="time"){const o=[/\s+(\d{1,2}:\d{2}:\d{2})$/,/\s+(\d{1,2}:\d{2})$/];for(const p of o){const u=a.match(p);if(u){const d=u[1];return console.log("‚úÖ DATETIME EXTRACT (time):",d),d}}const l=[/^\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}:\d{2}$/];for(const p of l)if(p.test(a))return console.log("‚úÖ DATETIME EXTRACT (time): Already time-only format"),a}return console.log("‚ö†Ô∏è DATETIME EXTRACT: No matching pattern found, returning original value"),t},Mr=(t,n)=>{if(!t||typeof t!="string")return console.log("üó∫Ô∏è COORDINATE PARSE: Invalid input value:",t),t;const{format:r="point",component:s="longitude"}=n,a=t.toString().trim();console.log(`üó∫Ô∏è COORDINATE PARSE: Parsing "${a}" with format "${r}", extracting "${s}"`);try{if(r==="point"){const o=a.match(/POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)/i);if(o){const l=parseFloat(o[1]),p=parseFloat(o[2]);switch(console.log(`üó∫Ô∏è COORDINATE PARSE: Extracted longitude=${l}, latitude=${p}`),s){case"longitude":return l;case"latitude":return p;case"both":return`${l}, ${p}`;default:return console.log(`üó∫Ô∏è COORDINATE PARSE: Unknown component "${s}", returning longitude`),l}}else return console.log("üó∫Ô∏è COORDINATE PARSE: Invalid POINT format"),t}return console.log(`üó∫Ô∏è COORDINATE PARSE: Unsupported format "${r}"`),t}catch(o){return console.error("üó∫Ô∏è COORDINATE PARSE ERROR:",o),t}},Nr=(t,n)=>{console.log("üïê SMART DATETIME DETECTION: Starting analysis..."),console.log("üïê Column names:",t);const r=n.find(l=>Object.keys(l).length>0)||{};console.log("üïê Sample data keys:",Object.keys(r));const s=Pr(t,r);if(s.confidence>.7)return console.log("‚úÖ DETECTED: Tyler CAD split datetime pattern"),{pattern:s,suggestedMappings:zr(s)};const a=kr(t,r);if(a.confidence>.7)return console.log("‚úÖ DETECTED: Hexagon/CentralSquare combined datetime pattern"),{pattern:a,suggestedMappings:Vr(a)};const o=Lr(t,r);return o.confidence>.5?(console.log("‚úÖ DETECTED: Volunteer department simple pattern"),{pattern:o,suggestedMappings:Ur(o)}):(console.log("‚ö†Ô∏è NO CLEAR DATETIME PATTERN DETECTED"),{pattern:{type:"unknown",confidence:0,description:"No clear datetime pattern detected - manual mapping required"},suggestedMappings:[]})},Pr=(t,n)=>{console.log("üîç Testing split datetime pattern (Tyler CAD style)...");const r=[/^inc_date$/i,/^incident_date$/i,/^date$/i,/^call_date$/i,/^event_date$/i],s=[/^alarm_time$/i,/^call_time$/i,/^time$/i,/^incident_time$/i,/^receive_time$/i,/^dispatch_time$/i];let a,o,l=0;for(const p of t){for(const u of r)if(u.test(p)){a=p,l+=.3,console.log(`üìÖ Found potential date field: "${p}"`);break}if(a)break}for(const p of t){for(const u of s)if(u.test(p)){o=p,l+=.3,console.log(`‚è∞ Found potential time field: "${p}"`);break}if(o)break}if(a&&o&&n[a]&&n[o]){const p=String(n[a]),u=String(n[o]);console.log("üß™ Sample data validation:"),console.log(`  Date field "${a}": "${p}"`),console.log(`  Time field "${o}": "${u}"`);const h=/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(p.trim()),S=/^\d{1,2}:\d{2}(:\d{2})?$/.test(u.trim());h&&S?(l+=.4,console.log("‚úÖ Data validation passed - date-only + time-only pattern confirmed")):(console.log("‚ö†Ô∏è Data validation failed - not clean date-only + time-only pattern"),console.log(`  Date-only check: ${h}, Time-only check: ${S}`))}return{type:"split",confidence:l,dateField:a,timeField:o,description:l>.7?`Split datetime pattern detected: "${a}" + "${o}" should be combined`:"Potential split pattern found but low confidence"}},kr=(t,n)=>{console.log("üîç Testing combined datetime pattern (Hexagon/CentralSquare style)...");const r=[/^calldatetime$/i,/^call_datetime$/i,/^incident_datetime$/i,/^event_datetime$/i,/^call_received_date\/time$/i,/^call.*time$/i,/^received.*time$/i];let s,a=0;for(const o of t){for(const l of r)if(l.test(o)){s=o,a+=.4,console.log(`üìÖ‚è∞ Found potential combined datetime field: "${o}"`);break}if(s)break}if(!s)for(const o of t){const l=n[o];if(l&&typeof l=="string"&&/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/.test(l.trim())){s=o,a+=.3,console.log(`üìÖ‚è∞ Found combined datetime by content analysis: "${o}" = "${l}"`);break}}if(s&&n[s]){const o=String(n[s]);console.log(`üß™ Sample data validation for combined field "${s}": "${o}"`),[/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}$/,/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/].some(u=>u.test(o.trim()))?(a+=.4,console.log("‚úÖ Data validation passed - full datetime pattern confirmed")):console.log("‚ö†Ô∏è Data validation failed - not a full datetime pattern")}return{type:"combined",confidence:a,combinedField:s,description:a>.7?`Combined datetime pattern detected: "${s}" contains full date and time`:"Potential combined pattern found but low confidence"}},Lr=(t,n)=>{console.log("üîç Testing simple datetime pattern (volunteer department style)...");const r=/^date$/i,s=/^time$/i,a=t.find(p=>r.test(p)),o=t.find(p=>s.test(p));let l=0;return a&&o&&(l+=.4,console.log(`üìÖ Found simple date field: "${a}"`),console.log(`‚è∞ Found simple time field: "${o}"`),n[a]&&n[o]&&(l+=.3,console.log("üß™ Sample data available for validation"))),{type:"simple",confidence:l,dateField:a,timeField:o,description:l>.5?`Simple datetime pattern detected: basic "${a}" + "${o}" fields`:"Simple pattern check completed - low confidence"}},zr=t=>{const n=[];return t.dateField&&t.timeField&&(n.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine "${t.dateField}" + "${t.timeField}" into full datetime for incident time`}),n.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"extract",description:`Extract date from "${t.dateField}" for incident date`})),n},Vr=t=>{const n=[];return t.combinedField&&(n.push({sourceFields:[t.combinedField],targetField:"incident_time",transformationType:"direct",description:`Use "${t.combinedField}" directly for incident time`}),n.push({sourceFields:[t.combinedField],targetField:"incident_date",transformationType:"extract",description:`Extract date portion from "${t.combinedField}" for incident date`})),n},Ur=t=>{const n=[];return t.dateField&&t.timeField&&(n.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine simple "${t.dateField}" + "${t.timeField}" for incident time`}),n.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"direct",description:`Use "${t.dateField}" for incident date`})),n},Br=de(e.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"})),Ht=de(e.jsx("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"})),Hr=de(e.jsx("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"})),Gr=de(e.jsx("path",{d:"M16.01 11H4v2h12.01v3L20 12l-3.99-4z"})),Wr=de(e.jsx("path",{d:"m19 9 1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25z"})),ot=de(e.jsx("path",{d:"M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.996.996 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"})),Yr=de(e.jsx("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"})),qr=de(e.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2m-9 14-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),fs=de(e.jsx("path",{d:"M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),Jr=de(e.jsx("path",{d:"M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6z"})),Kr=de(e.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),_t=de(e.jsx("path",{d:"M15 4v2h3v12h-3v2h5V4zM4 20h5v-2H6V6h3V4H4z"})),xs=de(e.jsx("path",{d:"M4 7v2c0 .55-.45 1-1 1H2v4h1c.55 0 1 .45 1 1v2c0 1.65 1.35 3 3 3h3v-2H7c-.55 0-1-.45-1-1v-2c0-1.3-.84-2.42-2-2.83v-.34C5.16 11.42 6 10.3 6 9V7c0-.55.45-1 1-1h3V4H7C5.35 4 4 5.35 4 7m17 3c-.55 0-1-.45-1-1V7c0-1.65-1.35-3-3-3h-3v2h3c.55 0 1 .45 1 1v2c0 1.3.84 2.42 2 2.83v.34c-1.16.41-2 1.52-2 2.83v2c0 .55-.45 1-1 1h-3v2h3c1.65 0 3-1.35 3-3v-2c0-.55.45-1 1-1h1v-4z"})),ht=de(e.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),Gt=de(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2m0 12H4V8h16z"})),Xr=de(e.jsx("path",{d:"M2 17h2v.5H3v1h1v.5H2v1h3v-4H2zm1-9h1V4H2v1h1zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2zm5-6v2h14V5zm0 14h14v-2H7zm0-6h14v-2H7z"})),$t=de(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"})),Wt=de(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),Zr=de(e.jsx("path",{d:"m20.5 10 .5-2h-4l1-4h-2l-1 4h-4l1-4h-2L9 8H5l-.5 2h4l-1 4h-4L3 16h4l-1 4h2l1-4h4l-1 4h2l1-4h4l.5-2h-4l1-4zm-7 4h-4l1-4h4z"})),Yt=de([e.jsx("path",{d:"M13 8.57c-.79 0-1.43.64-1.43 1.43s.64 1.43 1.43 1.43 1.43-.64 1.43-1.43-.64-1.43-1.43-1.43"},"0"),e.jsx("path",{d:"M13 3C9.25 3 6.2 5.94 6.02 9.64L4.1 12.2c-.25.33-.01.8.4.8H6v3c0 1.1.9 2 2 2h1v3h7v-4.68c2.36-1.12 4-3.53 4-6.32 0-3.87-3.13-7-7-7m3 7c0 .13-.01.26-.02.39l.83.66c.08.06.1.16.05.25l-.8 1.39c-.05.09-.16.12-.24.09l-.99-.4c-.21.16-.43.29-.67.39L14 13.83c-.01.1-.1.17-.2.17h-1.6c-.1 0-.18-.07-.2-.17l-.15-1.06c-.25-.1-.47-.23-.68-.39l-.99.4c-.09.03-.2 0-.25-.09l-.8-1.39c-.05-.08-.03-.19.05-.25l.84-.66c-.01-.13-.02-.26-.02-.39s.02-.27.04-.39l-.85-.66c-.08-.06-.1-.16-.05-.26l.8-1.38c.05-.09.15-.12.24-.09l1 .4c.2-.15.43-.29.67-.39L12 6.17c.02-.1.1-.17.2-.17h1.6c.1 0 .18.07.2.17l.15 1.06c.24.1.46.23.67.39l1-.4c.09-.03.2 0 .24.09l.8 1.38c.05.09.03.2-.05.26l-.85.66c.03.12.04.25.04.39"},"1")]),Qr=de(e.jsx("path",{d:"M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3m1-4.3h-2V7h2z"})),ys=de(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),qt=de(e.jsx("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3M7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5M16 17H8v-2h8zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13"})),en=de(e.jsx("path",{d:"m23 12-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69zm-12.91 4.72-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48z"})),tn=de([e.jsx("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),e.jsx("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")]),Ft=[{id:"incident_type",name:"üî• Incident Type",description:"Fire, medical, accident, alarm, etc.",pattern:/(fire|medical|ems|accident|mva|alarm|rescue|hazmat)/gi,enabled:!0},{id:"response_time",name:"‚è±Ô∏è Response Time",description:'Time values like "30 min", "1:20", "half hour"',pattern:/(\d+)\s*(min|minutes|hour|hours|hr|hrs)|(\d{1,2}):(\d{2})|half.hour|quarter.hour/gi,enabled:!0},{id:"location",name:"üìç Location",description:"Addresses, street names, landmarks",pattern:/\d+\s+[\w\s]+(street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd)/gi,enabled:!1},{id:"date_time",name:"üìÖ Date/Time",description:'Dates like "12/04/25", "April 12", times',pattern:/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})|(\w+\s+\d{1,2})|(\d{1,2}:\d{2})/gi,enabled:!1},{id:"units_resources",name:"üöí Units/Resources",description:"Fire trucks, ambulances, personnel count",pattern:/(engine|truck|ambulance|rescue|ladder|chief|\d+\s*(firefighter|personnel|crew))/gi,enabled:!1}],sn=({open:t,onClose:n,columnName:r,sampleData:s,onParse:a})=>{const[o,l]=N.useState(["incident_type","response_time"]),[p,u]=N.useState(!1),[d,h]=N.useState([]),[x,S]=N.useState(!1);N.useEffect(()=>{o.length>0&&s.length>0&&$()},[o,s]);const C=i=>{l(c=>c.includes(i)?c.filter(y=>y!==i):[...c,i])},$=async()=>{u(!0);try{await new Promise(c=>setTimeout(c,500));const i=s.slice(0,5).map((c,y)=>({rowIndex:y,originalText:c,parsedFields:A(c,o)}));h(i)}catch(i){console.error("Error generating preview:",i)}finally{u(!1)}},A=(i,c)=>{const y={};return c.forEach(w=>{const P=Ft.find(k=>k.id===w);if(!P)return;const T=i.match(P.pattern);if(T&&T.length>0){const k=T[0];console.log(`üîç PARSING DEBUG - Field: ${w}, Pattern: ${P.pattern}, Text: "${i}", Match: "${k}"`),y[w]={value:Y(w,k),confidence:E(w,k),original:k}}}),y},Y=(i,c)=>{switch(i){case"incident_type":return _(c);case"response_time":return q(c);case"location":return V(c);default:return c}},_=i=>{const c=i.toLowerCase();return c.includes("fire")?"Structure Fire":c.includes("medical")||c.includes("ems")?"Medical Emergency":c.includes("accident")||c.includes("mva")?"Motor Vehicle Accident":c.includes("alarm")?"Alarm Response":i},q=i=>{const c=i.match(/(\d+)\s*(min|minutes|hour|hours|hr|hrs)/i);if(c){const w=parseInt(c[1]);return c[2].toLowerCase().startsWith("h")?`${w} hour${w!==1?"s":""}`:`${w} minute${w!==1?"s":""}`}const y=i.match(/(\d{1,2}):(\d{2})/);if(y){const w=parseInt(y[1]),P=parseInt(y[2]);return`${w}:${P.toString().padStart(2,"0")}`}return i},V=i=>i.replace(/\b\w/g,c=>c.toUpperCase()),E=(i,c,y)=>i==="response_time"&&c.match(/\d+\s*(min|minutes)/i)?.95:i==="incident_type"&&["fire","medical","accident"].includes(c.toLowerCase())?.9:.7,H=async()=>{if(o.length!==0){S(!0);try{await new Promise(c=>setTimeout(c,1e3));const i=s.map((c,y)=>({rowIndex:y,originalText:c,parsedFields:A(c,o)}));a(o,i),n()}catch(i){console.error("Error parsing narrative data:",i)}finally{S(!1)}}},X=()=>o.length,J=()=>d.filter(i=>Object.keys(i.parsedFields).length>0).length;return e.jsxs(Ke,{open:t,onClose:n,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"70vh"}},children:[e.jsxs(Xe,{sx:{display:"flex",alignItems:"center",pb:1},children:[e.jsx(qt,{sx:{mr:1,color:"primary.main"}}),'Parse Narrative: "',r,'"']}),e.jsxs(Ze,{sx:{pb:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Extract structured data from narrative text using pattern matching and NLP. Select the fields you want to extract and preview the results."}),e.jsx(f,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"1. Select Fields to Extract"}),e.jsx(Vs,{sx:{mb:3},children:Ft.map(i=>e.jsx(We,{control:e.jsx(zs,{checked:o.includes(i.id),onChange:()=>C(i.id)}),label:e.jsxs(j,{children:[e.jsx(f,{variant:"body2",sx:{fontWeight:"medium"},children:i.name}),e.jsx(f,{variant:"caption",color:"text.secondary",children:i.description})]})},i.id))}),e.jsx(ye,{sx:{my:2}}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(f,{variant:"h6",sx:{flexGrow:1},children:"2. Preview Results"}),p&&e.jsx(Ve,{size:20,sx:{ml:2}})]}),o.length===0?e.jsx(ce,{severity:"info",sx:{mb:2},children:"Select at least one field to see preview results."}):e.jsxs(e.Fragment,{children:[e.jsxs(j,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(le,{label:`${X()} fields selected`,size:"small",color:"primary"}),e.jsx(le,{label:`${J()}/${d.length} rows with data`,size:"small",color:"success"})]}),e.jsxs(dt,{size:"small",sx:{mb:2},children:[e.jsx(ut,{children:e.jsxs(Pe,{children:[e.jsx(Se,{children:"Original Text"}),o.map(i=>{const c=Ft.find(y=>y.id===i);return e.jsx(Se,{children:c==null?void 0:c.name},i)})]})}),e.jsx(pt,{children:d.map((i,c)=>e.jsxs(Pe,{children:[e.jsx(Se,{sx:{maxWidth:200},children:e.jsx(f,{variant:"body2",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i.originalText})}),o.map(y=>e.jsx(Se,{children:i.parsedFields[y]?e.jsxs(j,{children:[e.jsx(f,{variant:"body2",children:i.parsedFields[y].value}),e.jsxs(f,{variant:"caption",color:"success.main",children:[Math.round(i.parsedFields[y].confidence*100),"% confident"]})]}):e.jsx(f,{variant:"caption",color:"text.secondary",children:"No match"})},y))]},c))})]}),e.jsx(ce,{severity:"info",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Preview shows first 5 rows."})," Parsing accuracy is typically 70-85%. You can edit any incorrect values after parsing."]})})]})]}),e.jsxs(Qe,{sx:{p:3,pt:1},children:[e.jsx(oe,{onClick:n,children:"Cancel"}),e.jsx(oe,{variant:"contained",onClick:H,disabled:o.length===0||x,startIcon:x?e.jsx(Ve,{size:20}):e.jsx(qt,{}),children:x?"Parsing...":`Parse ${r}`})]})]})},rn=({columnName:t,onClick:n,variant:r="icon",size:s="small",disabled:a=!1})=>{const o=()=>{n(t)};return r==="button"?e.jsx(oe,{size:s,startIcon:e.jsx(ot,{}),onClick:o,disabled:a,sx:{minWidth:"auto",textTransform:"none",color:"primary.main","&:hover":{backgroundColor:"primary.50"}},children:"Parse"}):e.jsx(ze,{title:`Parse narrative text in "${t}" column`,children:e.jsx("span",{children:e.jsx(Ce,{size:s,onClick:o,disabled:a,sx:{color:"primary.main","&:hover":{backgroundColor:"primary.50",transform:"scale(1.1)"},transition:"all 0.2s ease-in-out"},children:e.jsx(ot,{fontSize:s})})})})},nn=({parsedFields:t,onFieldDragStart:n,onDeleteParsedField:r})=>{if(t.length===0)return null;const s=o=>o>=.9?"success":o>=.7?"warning":"error",a=o=>o>=.9?"High confidence":o>=.7?"Medium confidence":"Low confidence";return e.jsxs(j,{sx:{mt:1,ml:2},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(Yt,{sx:{fontSize:16,color:"primary.main",mr:.5}}),e.jsx(f,{variant:"caption",color:"primary.main",sx:{fontWeight:"medium"},children:"Parsed Fields"})]}),e.jsx(st,{spacing:.5,children:t.map(o=>e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(le,{label:o.name,size:"small",color:"secondary",variant:"outlined",draggable:!0,onDragStart:l=>{l.stopPropagation(),n(l,o.id)},sx:{cursor:"grab","&:active":{cursor:"grabbing"},"&:hover":{backgroundColor:"secondary.50"}},icon:e.jsx(Yt,{})}),e.jsx(ze,{title:`${o.parsedCount}/${o.totalRows} rows parsed`,children:e.jsxs(f,{variant:"caption",color:"text.secondary",children:[Math.round(o.parsedCount/o.totalRows*100),"%"]})}),e.jsx(ze,{title:a(o.confidence),children:e.jsx(qe,{sx:{fontSize:14,color:`${s(o.confidence)}.main`}})}),e.jsx(ze,{title:"Delete parsed field",children:e.jsx(Ce,{size:"small",onClick:()=>r(o.id),sx:{ml:.5,"&:hover":{color:"error.main"}},children:e.jsx(nt,{sx:{fontSize:14}})})})]},o.id))}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"Drag parsed fields to target fields ‚Üí"})]})},on=({id:t,isMapped:n,targetFields:r,sampleValue:s,dataType:a,onParseColumn:o,parsedFields:l=[],onParsedFieldDragStart:p,onDeleteParsedField:u})=>{const d=(a==="Text"||!a&&typeof s=="string")&&typeof s=="string"&&s.length>20;t==="Notes"&&console.log("üîç NARRATIVE PARSER DEBUG for Notes column:",{fieldId:t,dataType:a,sampleValue:s,sampleValueType:typeof s,sampleValueLength:typeof s=="string"?s.length:"N/A",isTextColumn:d,onParseColumn:!!o});const h={backgroundColor:n?"#f0f7ff":void 0,border:n?"1px solid #90caf9":"1px solid #e0e0e0",cursor:"grab",padding:"8px 12px",borderRadius:"4px",marginBottom:"8px",position:"relative"},x=C=>{console.log("DRAG START on source field:",t),C.dataTransfer.setData("text/plain",t),C.dataTransfer.effectAllowed="move",console.log("Verifying dataTransfer was set:",C.dataTransfer.types);const $=document.createElement("div");$.className="drag-ghost",$.innerHTML=`<div style="padding: 10px; background: #1976d2; color: white; border-radius: 4px;">Dragging: ${t}</div>`,document.body.appendChild($),C.dataTransfer.setDragImage($,20,20);const A=C.currentTarget;A.style.opacity="0.6",A.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.2)",setTimeout(()=>{document.body.removeChild($)},0),console.log("Drag started with field:",t)},S=C=>{const $=C.currentTarget;$.style.opacity="",$.style.boxShadow="",console.log("Drag ended for field:",t)};return e.jsx("div",{style:h,"data-field-id":t,className:"draggable-source-field",draggable:!0,onDragStart:x,onDragEnd:S,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsxs(j,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(f,{variant:"body2",fontWeight:"medium",children:t}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[d&&o&&e.jsx(rn,{columnName:t,onClick:o,variant:"icon",size:"small"}),n&&e.jsx(le,{size:"small",icon:e.jsx(Br,{fontSize:"small"}),label:r.length===1?r[0]:`${r.length} fields`,color:"primary",variant:"outlined"})]})]}),s!==void 0&&e.jsxs(j,{sx:{mt:.5,display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.75rem"},children:[e.jsx(f,{variant:"caption",sx:{color:"text.secondary",fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:typeof s=="object"?JSON.stringify(s):String(s)}),a&&e.jsx(le,{label:a,size:"small",variant:"outlined",sx:{height:"16px",fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]}),l.length>0&&e.jsx(nn,{parsedFields:l.map(C=>({id:C.id,name:C.name,sourceColumn:C.sourceColumn,parsedCount:C.parsedCount,totalRows:C.totalRows,confidence:C.confidence})),onFieldDragStart:p||(()=>{}),onDeleteParsedField:u||(()=>{})})]})})},an=({sourceColumns:t,filter:n,setFilter:r,mappings:s,sampleData:a=[],onAddParsedFields:o})=>{const[l,p]=N.useState(!1),[u,d]=N.useState(""),[h,x]=N.useState({}),S=i=>{d(i),p(!0)},C=()=>{p(!1),d("")},$=(i,c)=>{console.log("üî• Parsing completed for column:",u),console.log("üìä Selected fields:",i),console.log("üìã Results:",c);const y=i.map(w=>{const P=A(w),T=[];let k=0,ie=0;c.forEach(L=>{L.parsedFields[w]?(T.push(L.parsedFields[w].value),k++,ie+=L.parsedFields[w].confidence):T.push(null)});const R=k>0?ie/k:0;return{id:`${u}_${w}`,name:P,sourceColumn:u,parsedCount:k,totalRows:c.length,confidence:R,data:T}});if(x(w=>({...w,[u]:y})),a&&a.length>0){const w=a.map((P,T)=>{const k={...P};return y.forEach(ie=>{if(ie.data[T]!==null){const R=ie.id.split("_").slice(1).join("_"),L=`${u}_parsed_${R}`;k[L]=ie.data[T],console.log(`ü§ñ INJECTED parsed data: ${L} = "${ie.data[T]}"`)}}),k});console.log("ü§ñ Updated sample data with parsed fields:",w)}o&&o(u,y)},A=i=>({incident_type:"üìä Parsed Incident Type",response_time:"‚è±Ô∏è Parsed Response Time",location:"üìç Parsed Location",date_time:"üìÖ Parsed Date/Time",units_resources:"üöí Parsed Units/Resources"})[i]||`ü§ñ Parsed ${i}`,Y=(i,c)=>{console.log("üî• Dragging parsed field:",c),i.dataTransfer.setData("text/plain",c),i.dataTransfer.effectAllowed="move"},_=i=>{console.log("üóëÔ∏è Deleting parsed field:",i);const c=Object.keys(h).find(y=>h[y].some(w=>w.id===i));c&&x(y=>({...y,[c]:y[c].filter(w=>w.id!==i)}))},q=i=>!a||a.length===0?[]:a.slice(0,10).map(c=>c[i]||"").filter(Boolean),V=N.useMemo(()=>{if(!n)return t;const i=n.toLowerCase();return t.filter(c=>c.toLowerCase().includes(i))},[t,n]),E=N.useMemo(()=>{const i={};return s.forEach(c=>{i[c.sourceField]||(i[c.sourceField]=[]),i[c.sourceField].push(c.targetField)}),i},[s]),H=N.useMemo(()=>Object.keys(E).length,[E]),X=N.useMemo(()=>{if(!a||a.length===0)return{};const i=a[0],c={};return t.forEach(y=>{c[y]=i[y]}),c},[a,t]),J=N.useMemo(()=>{const i={};return Object.entries(X).forEach(([c,y])=>{if(y==null){i[c]="Unknown";return}if(typeof y=="string"){if([/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/,/^\d{4}\/\d{2}\/\d{2}$/].some(T=>T.test(y))){i[c]="Date";return}if([/^\d{1,2}:\d{2}(:\d{2})?$/,/^\d{1,2}:\d{2}(:\d{2})?\s*(AM|PM)$/i].some(T=>T.test(y))){i[c]="Time";return}if(!isNaN(Number(y))){i[c]="Number";return}i[c]="Text";return}typeof y=="number"?i[c]="Number":typeof y=="boolean"?i[c]="Boolean":Array.isArray(y)?i[c]="Array":typeof y=="object"?i[c]="Object":i[c]=typeof y}),i},[X]);return e.jsxs(fe,{sx:{height:"100%",p:2,display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsx(be,{size:"small",placeholder:"Search source fields...",value:n,onChange:i=>r(i.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(rt,{fontSize:"small"})})}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(f,{variant:"body2",color:"text.secondary",children:[V.length," fields"]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:[H," mapped"]})]}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(f,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drag fields from here to the Target Fields panel"})}),e.jsx(ye,{sx:{mb:2}}),e.jsxs(j,{sx:{flexGrow:1,overflow:"auto",maxHeight:"calc(100% - 180px)",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:[V.map(i=>e.jsx(on,{id:i,isMapped:!!E[i],targetFields:E[i]||[],sampleValue:X[i],dataType:J[i],onParseColumn:S,parsedFields:h[i]||[],onParsedFieldDragStart:Y,onDeleteParsedField:_},i)),V.length===0&&e.jsx(j,{sx:{textAlign:"center",py:4},children:e.jsx(f,{variant:"body2",color:"text.secondary",children:"No fields match your search"})})]}),e.jsx(sn,{open:l,onClose:C,columnName:u,sampleData:q(u),onParse:$})]})},ln=({open:t,onClose:n,fieldName:r,mapping:s,sampleData:a,onSave:o})=>{const[l,p]=N.useState(0),[u,d]=N.useState([]),[h,x]=N.useState("auto"),[S,C]=N.useState(""),[$,A]=N.useState(","),[Y,_]=N.useState(0),[q,V]=N.useState("string"),[E,H]=N.useState("point"),[X,J]=N.useState("longitude");N.useEffect(()=>{if(s){if(s.sourceField&&a.length>0){const T=a.map(k=>k[s.sourceField]).filter(k=>k!=null).slice(0,5);d(T)}s.transformations&&s.transformations.length>0&&s.transformations.forEach(T=>{switch(T.type){case"format":const k=T.params.format||T.params.dateFormat;k&&(k==="custom"?(x("custom"),C(T.params.customFormat||"")):x(k));break;case"split":A(T.params.delimiter||","),_(T.params.index||0);break;case"convert":V(T.params.toType||"string");break;case"parseCoordinates":H(T.params.format||"point"),J(T.params.component||"longitude");break}})}},[s,a]);const i=(T,k)=>{p(k)},c=()=>{const T=[];l===0&&h!=="auto"&&T.push({type:"format",params:{type:"date",format:h,fieldName:r,...h==="custom"?{customFormat:S}:{}}}),l===1&&T.push({type:"split",params:{delimiter:$,index:Y}}),l===2&&T.push({type:"convert",params:{toType:q}}),l===3&&T.push({type:"parseCoordinates",params:{format:E,component:X}}),o(r,T)},y=u.length>0,P=(()=>{if(!y)return[];switch(l){case 0:return u.map(T=>{if(!T)return"N/A";try{const k=new Date(T);if(isNaN(k.getTime()))return"Invalid date";switch(h){case"auto":return k.toLocaleString();case"MM/DD/YYYY":return`${k.getMonth()+1}/${k.getDate()}/${k.getFullYear()}`;case"YYYY-MM-DD":return`${k.getFullYear()}-${(k.getMonth()+1).toString().padStart(2,"0")}-${k.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${k.getDate()}/${k.getMonth()+1}/${k.getFullYear()}`;case"date-only":return new Date(T).toLocaleDateString();case"custom":return S.replace("YYYY",k.getFullYear().toString()).replace("MM",(k.getMonth()+1).toString().padStart(2,"0")).replace("DD",k.getDate().toString().padStart(2,"0")).replace("HH",k.getHours().toString().padStart(2,"0")).replace("mm",k.getMinutes().toString().padStart(2,"0")).replace("ss",k.getSeconds().toString().padStart(2,"0"));default:return k.toLocaleString()}}catch{return"Error formatting date"}});case 1:return u.map(T=>{if(!T)return"N/A";try{return T.toString().split($)[Y]||`Index ${Y} not found`}catch{return"Error splitting value"}});case 2:return u.map(T=>{if(T==null)return"N/A";try{switch(q){case"string":return String(T);case"number":return Number(T);case"boolean":return(!!T).toString();default:return String(T)}}catch{return"Error converting value"}});case 3:return u.map(T=>{if(!T)return"N/A";try{const k=T.toString().trim();if(E==="point"){const ie=k.match(/POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)/i);if(ie){const R=parseFloat(ie[1]),L=parseFloat(ie[2]);return X==="longitude"?R.toString():X==="latitude"?L.toString():`${R}, ${L}`}else return"Invalid POINT format"}return"Unsupported coordinate format"}catch{return"Error parsing coordinates"}})}return[]})();return e.jsxs(Ke,{open:t,onClose:n,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Xe,{children:["Transform Field: ",r]}),e.jsx(Ze,{dividers:!0,children:e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:l,onChange:i,"aria-label":"transformation tabs",children:[e.jsx(De,{label:"Date/Time Format"}),e.jsx(De,{label:"Split/Extract"}),e.jsx(De,{label:"Type Conversion"}),e.jsx(De,{label:"Parse Coordinates"})]})}),e.jsxs(j,{role:"tabpanel",hidden:l!==0,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Date Format Settings"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Choose how date and time values should be formatted. Date-only formats automatically strip time components."}),e.jsxs(Ae,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"date-format-label",children:"Date Format"}),e.jsxs(Re,{labelId:"date-format-label",id:"date-format-select",value:h,label:"Date Format",onChange:T=>x(T.target.value),children:[e.jsx(ne,{value:"auto",children:"Auto-detect"}),e.jsx(ne,{value:"MM/DD/YYYY",children:"MM/DD/YYYY (date only)"}),e.jsx(ne,{value:"DD/MM/YYYY",children:"DD/MM/YYYY (date only)"}),e.jsx(ne,{value:"YYYY-MM-DD",children:"YYYY-MM-DD (date only)"}),e.jsx(ne,{value:"date-only",children:"Date Only (strip time)"}),e.jsx(ne,{value:"custom",children:"Custom Format"})]})]}),h==="custom"&&e.jsx(be,{fullWidth:!0,label:"Custom Format",value:S,onChange:T=>C(T.target.value),helperText:"Use YYYY for year, MM for month, DD for day, HH for hour, mm for minute, ss for second",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==1,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Split or Extract Value"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Split a field by a delimiter and extract a specific part."}),e.jsx(be,{fullWidth:!0,label:"Delimiter",value:$,onChange:T=>A(T.target.value),helperText:"Character or text that separates the parts",sx:{mb:2}}),e.jsx(be,{fullWidth:!0,label:"Index",type:"number",value:Y,onChange:T=>_(parseInt(T.target.value)||0),helperText:"Position of the part to extract (0 = first part)",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==2,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Type Conversion"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Convert the value to a different data type."}),e.jsxs(Ae,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"convert-type-label",children:"Convert To"}),e.jsxs(Re,{labelId:"convert-type-label",id:"convert-type-select",value:q,label:"Convert To",onChange:T=>V(T.target.value),children:[e.jsx(ne,{value:"string",children:"Text (String)"}),e.jsx(ne,{value:"number",children:"Number"}),e.jsx(ne,{value:"boolean",children:"True/False (Boolean)"})]})]})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==3,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Parse Geographic Coordinates"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Extract latitude and longitude values from geographic coordinate formats like POINT(-86.5540806822223 39.1620537333389)."}),e.jsxs(Ae,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"coordinate-format-label",children:"Coordinate Format"}),e.jsx(Re,{labelId:"coordinate-format-label",id:"coordinate-format-select",value:E,label:"Coordinate Format",onChange:T=>H(T.target.value),children:e.jsx(ne,{value:"point",children:"POINT(longitude latitude)"})})]}),e.jsxs(Ae,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"coordinate-component-label",children:"Extract Component"}),e.jsxs(Re,{labelId:"coordinate-component-label",id:"coordinate-component-select",value:X,label:"Extract Component",onChange:T=>J(T.target.value),children:[e.jsx(ne,{value:"longitude",children:"Longitude (X coordinate)"}),e.jsx(ne,{value:"latitude",children:"Latitude (Y coordinate)"}),e.jsx(ne,{value:"both",children:"Both (longitude, latitude)"})]})]})]}),e.jsx(ye,{sx:{my:2}}),e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Preview"}),y?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(j,{sx:{display:"flex",borderBottom:1,borderColor:"divider",pb:1},children:[e.jsx(f,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Original Value"}),e.jsx(f,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Transformed Value"})]}),u.map((T,k)=>e.jsxs(j,{sx:{display:"flex",py:1,borderBottom:"1px solid #eee"},children:[e.jsx(f,{variant:"body2",sx:{width:"50%"},children:T==null?"Null/Empty":String(T)}),e.jsx(f,{variant:"body2",sx:{width:"50%"},children:P[k]})]},k))]}):e.jsx(ce,{severity:"info",children:"No sample data available for preview."})]})}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:n,children:"Cancel"}),e.jsx(oe,{onClick:c,variant:"contained",children:"Apply Transformation"})]})]})},cn=t=>{switch(t.dataType){case"string":return`DEFAULT-${t.name}`;case"number":return"0";case"boolean":return"false";case"date":return new Date().toISOString().split("T")[0];case"location":return"0.0,0.0";default:return""}},dn=({open:t,onClose:n,unmappedRequiredFields:r,onAddDefaultMappings:s})=>{const[a,o]=N.useState(()=>{const d={};return r.forEach(h=>{d[h.name]=cn(h)}),d}),l=(d,h)=>{o(x=>({...x,[d]:h}))},p=()=>{console.log("Creating default mappings for fields:",r),console.log("Default values:",a);const d=r.map(h=>{const x={sourceField:"__default__",targetField:h.name,transformations:[{type:"convert",params:{defaultValue:a[h.name],targetType:h.dataType}}]};return console.log(`Created default mapping for ${h.name}:`,x),x});console.log("All default mappings:",d),s(d),n()},u=d=>{switch(d){case"number":return"number";case"date":return"date";default:return"text"}};return e.jsxs(Ke,{open:t,onClose:n,"aria-labelledby":"default-value-dialog-title",maxWidth:"md",fullWidth:!0,children:[e.jsx(Xe,{id:"default-value-dialog-title",children:"Set Default Values for Required Fields"}),e.jsxs(Ze,{children:[e.jsx(f,{variant:"body1",sx:{mb:3},children:"The following required fields don't have mappings. Please provide default values for them."}),e.jsx(pe,{container:!0,spacing:3,children:r.map(d=>e.jsxs(pe,{size:{xs:12,sm:6},children:[e.jsxs(j,{sx:{mb:1},children:[e.jsxs(f,{variant:"subtitle2",children:[d.name,e.jsx(le,{size:"small",label:d.dataType,color:"primary",variant:"outlined",sx:{ml:1}})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:d.description})]}),d.dataType==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:a[d.name]||"false",onChange:h=>l(d.name,h.target.value),variant:"outlined",size:"small",children:[e.jsx(ne,{value:"true",children:"True"}),e.jsx(ne,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:a[d.name]||"",onChange:h=>l(d.name,h.target.value),type:u(d.dataType),variant:"outlined",size:"small",placeholder:`Enter default value for ${d.name}`,InputLabelProps:{shrink:!0}}),e.jsx(Ps,{children:"Default value for all records"})]},d.name))})]}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:n,color:"primary",children:"Cancel"}),e.jsx(oe,{onClick:p,color:"primary",variant:"contained",children:"Apply Default Values"})]})]})},un=({mapping:t,sampleData:n,onClose:r})=>{const s=Mt(),a=N.useMemo(()=>!t||!n.length?[]:n.slice(0,5).map(l=>({sourceValue:l[t.sourceField],transformedValue:(t.transformations||[]).reduce((p,u)=>gs(p,u,t.targetField),l[t.sourceField])})),[t,n]);if(!t)return e.jsx(fe,{sx:{p:2,mt:2,backgroundColor:he(s.palette.info.light,.1),border:`1px dashed ${s.palette.info.main}`,borderRadius:1},children:e.jsx(f,{variant:"body2",color:"text.secondary",align:"center",children:"Select a field mapping to see transformation preview"})});if(!a.length||!t.sourceField)return e.jsx(fe,{sx:{p:2,mt:2,backgroundColor:he(s.palette.warning.light,.1),border:`1px dashed ${s.palette.warning.main}`,borderRadius:1},children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["No sample data available for ",t.sourceField||"this field"]})});const o=t.transformations||[];return e.jsxs(fe,{sx:{p:2,mt:2,borderRadius:1,border:`1px solid ${s.palette.divider}`,boxShadow:s.shadows[1],position:"relative"},children:[r&&e.jsx(Ce,{size:"small",onClick:r,sx:{position:"absolute",top:8,right:8,color:s.palette.grey[500],"&:hover":{backgroundColor:he(s.palette.grey[100],.9),color:s.palette.grey[800]}},"aria-label":"close preview",children:e.jsx(Ws,{fontSize:"small"})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,pr:4},children:[e.jsxs(f,{variant:"subtitle2",color:"primary",gutterBottom:!0,children:["Field Transformation Preview: ",t.targetField]}),e.jsx(le,{size:"small",label:`${o.length} transformation${o.length!==1?"s":""}`,color:o.length>0?"primary":"default",icon:o.length>0?e.jsx(ot,{}):void 0})]}),e.jsx(ye,{sx:{mb:2}}),e.jsx(j,{sx:{maxHeight:200,overflow:"auto"},children:a.map((l,p)=>{const u=l.sourceValue!==void 0&&l.sourceValue!==null,d=o.length>0,h=typeof l.sourceValue,x=typeof l.transformedValue,S=h!==x;return e.jsxs(j,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:p%2===0?he(s.palette.background.default,.5):"transparent",display:"flex",alignItems:"center"},children:[e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Source (",t.sourceField,")"]}),e.jsx(f,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:u?he(s.palette.success.light,.1):he(s.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:u?String(l.sourceValue):"(empty)"}),e.jsx(f,{variant:"caption",color:"text.secondary",children:h})]}),e.jsx(j,{sx:{flexBasis:"10%",textAlign:"center"},children:e.jsx(Gr,{color:d?"primary":"action"})}),e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Result (",t.targetField,")"]}),e.jsx(f,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:l.transformedValue!==void 0?he(s.palette.success.light,.1):he(s.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:l.transformedValue!==void 0?String(l.transformedValue):"(empty)"}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(f,{variant:"caption",color:"text.secondary",children:x}),S&&e.jsx(le,{size:"small",label:`Type: ${h} ‚Üí ${x}`,color:"warning",variant:"outlined",sx:{height:16,fontSize:"0.6rem"}})]})]})]},p)})}),o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(ye,{sx:{my:2}}),e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Transformation Steps Applied:"}),e.jsx(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:o.map((l,p)=>{var u,d,h,x,S,C,$,A,Y;return e.jsxs(j,{sx:{display:"flex",alignItems:"center",p:1,borderRadius:1,backgroundColor:he(s.palette.primary.light,.05),border:`1px solid ${he(s.palette.primary.light,.2)}`},children:[e.jsxs(j,{sx:{mr:1,color:s.palette.primary.main},children:[p+1,"."]}),e.jsxs(f,{variant:"body2",children:[e.jsxs("strong",{children:[l.type,":"]})," "," ",l.type==="convert"&&((u=l.params)==null?void 0:u.dataType)&&`Convert to ${l.params.dataType}`,l.type==="convert"&&((d=l.params)==null?void 0:d.defaultValue)!==void 0&&`Set default value to "${l.params.defaultValue}"`,l.type==="format"&&((h=l.params)==null?void 0:h.type)==="date"&&(((x=l.params)==null?void 0:x.format)||((S=l.params)==null?void 0:S.dateFormat))&&`Format date as "${l.params.format||l.params.dateFormat}"${l.params.customFormat?` (${l.params.customFormat})`:""}`,l.type==="format"&&((C=l.params)==null?void 0:C.pattern)&&`Format using pattern "${l.params.pattern}"`,l.type==="extract"&&(($=l.params)==null?void 0:$.pattern)&&`Extract using pattern "${l.params.pattern}"`,l.type==="replace"&&((A=l.params)==null?void 0:A.from)&&((Y=l.params)==null?void 0:Y.to)&&`Replace "${l.params.from}" with "${l.params.to}"`]})]},p)})})]}),t.targetField&&e.jsxs(j,{sx:{mt:2,p:1,borderRadius:1,display:"flex",alignItems:"center",backgroundColor:a.some(l=>l.transformedValue===void 0||l.transformedValue===null)?he(s.palette.warning.light,.1):he(s.palette.success.light,.1)},children:[a.some(l=>l.transformedValue===void 0||l.transformedValue===null)?e.jsx(ht,{color:"warning",sx:{mr:1}}):e.jsx(fs,{color:"success",sx:{mr:1}}),e.jsx(f,{variant:"body2",children:a.some(l=>l.transformedValue===void 0||l.transformedValue===null)?"Some values could not be transformed. Consider adding a default value.":"All sample values were successfully transformed."})]})]})},pn=ft(({className:t,...n})=>e.jsx(ze,{...n,classes:{popper:t}}))(()=>({"& .MuiTooltip-tooltip":{backgroundColor:"transparent",padding:0,maxWidth:320}})),mn=ft(fe)(({theme:t})=>({padding:t.spacing(2),backgroundColor:t.palette.background.paper,boxShadow:t.shadows[3],borderRadius:t.shape.borderRadius,border:`1px solid ${t.palette.divider}`,minWidth:200,maxWidth:320})),hn=ft(f)(({theme:t})=>({fontWeight:600,marginBottom:t.spacing(1),borderBottom:`1px solid ${t.palette.divider}`,paddingBottom:t.spacing(.5),color:t.palette.primary.main})),Ge=({title:t,children:n,content:r,icon:s=!1,placement:a="top",enterDelay:o=100,leaveDelay:l=100})=>{console.log(`EnhancedTooltip rendering: ${t} with icon=${s}`);const p=s?e.jsxs(j,{sx:{display:"inline-flex",alignItems:"center"},children:[n,e.jsx(Ys,{color:"action",fontSize:"small",sx:{ml:.5,opacity:.7}})]}):n;return e.jsx(pn,{title:e.jsxs(mn,{children:[e.jsx(hn,{variant:"subtitle2",children:t}),r]}),placement:a,arrow:!0,enterDelay:o,leaveDelay:l,children:p})},gn=({toolConfig:t,showAllFields:n,setShowAllFields:r,filter:s,setFilter:a,mappings:o,onMappingChange:l,onRemoveMapping:p,validationErrors:u,sampleData:d,sourceColumns:h=[]})=>{const x=Mt();console.log("TargetFieldsPanel received sourceColumns:",h),console.log("TargetFieldsPanel received toolConfig:",t),console.log("TargetFieldsPanel received mappings:",o);const[S,C]=N.useState(null),[$,A]=N.useState(null),[Y,_]=N.useState({Timing:!0,Location:!0,"Incident Details":!0}),q=N.useMemo(()=>{const g={};return u.forEach(U=>{g[U.field]={message:U.message,severity:U.severity}}),g},[u]),V=N.useMemo(()=>{const g={};return o.forEach(U=>{g[U.targetField]=U.sourceField}),g},[o]),E=N.useMemo(()=>{const g={};return[...t.requiredFields,...t.optionalFields].forEach(O=>{let B;O.dataType==="date"||O.name.toLowerCase().includes("time")||O.name.toLowerCase().includes("date")?B="Timing":O.dataType==="location"||O.name.toLowerCase().includes("lat")||O.name.toLowerCase().includes("lon")||O.name.toLowerCase().includes("address")?B="Location":B="Incident Details",g[B]||(g[B]=[]),g[B].push(O)}),g},[t]),H=N.useMemo(()=>{if(!s)return n?[...t.requiredFields,...t.optionalFields]:E;const g=s.toLowerCase(),O=[...t.requiredFields,...t.optionalFields].filter(D=>{var v;return D.name.toLowerCase().includes(g)||((v=D.description)==null?void 0:v.toLowerCase().includes(g))});if(n)return O;const B={};return O.forEach(D=>{let v;for(const[F,K]of Object.entries(E))if(K.some(G=>G.id===D.id)){v=F;break}v||(v="Other"),B[v]||(B[v]=[]),B[v].push(D)}),B},[t,s,n,E]),X=g=>{_({...Y,[g]:!Y[g]})},J=(g,U)=>{console.log("Dropdown selection - mapping",U,"to",g);try{if(!U){p(g);return}l({sourceField:U,targetField:g}),console.log("Mapping updated via dropdown successfully")}catch(O){console.error("Error updating mapping via dropdown:",O)}},i=g=>{C(g)},c=()=>{C(null)},y=g=>{A(U=>U===g?null:g)},w=(g,U)=>{const O=o.find(B=>B.targetField===g);O&&l({...O,transformations:U}),C(null)},P=g=>{switch(g){case"string":return{icon:e.jsx(Vt,{fontSize:"small"}),color:"info"};case"number":return{icon:e.jsx(Zr,{fontSize:"small"}),color:"secondary"};case"date":return{icon:e.jsx(Yr,{fontSize:"small"}),color:"warning"};case"boolean":return{icon:e.jsx(qr,{fontSize:"small"}),color:"success"};case"location":return{icon:e.jsx(Hs,{fontSize:"small"}),color:"error"};default:return{icon:e.jsx(Vt,{fontSize:"small"}),color:"default"}}},T=g=>{const U=V[g.id],O=q[g.id],B=$===g.id;console.log(`üîß FIELD RENDER: ${g.name} (ID: ${g.id}), mapped to: ${U||"none"}`);const D=M=>{M.preventDefault(),M.stopPropagation(),M.dataTransfer.dropEffect="move";const b=M.currentTarget;b.style.boxShadow="0 0 0 2px #1976d2",b.style.borderColor="#1976d2",b.style.backgroundColor="#f0f7ff",b.style.transform="scale(1.01)",b.style.transition="all 0.2s ease",console.log("DRAG OVER on target field:",g.name)},v=M=>{M.preventDefault(),M.stopPropagation();const b=M.currentTarget;b.style.boxShadow="",b.style.borderColor=O?O.severity==="error"?"#f44336":"#ff9800":U?"#4caf50":"#e0e0e0",b.style.backgroundColor=O?O.severity==="error"?"#fff5f5":"#fffbf0":U?"#f4fbf4":"#ffffff",b.style.transform="",console.log("DRAG LEAVE from field:",g.name)},F=M=>{M.preventDefault(),M.stopPropagation(),console.log("DROP EVENT TRIGGERED on field:",g.name);try{const b=M.dataTransfer.getData("text/plain");if(console.log("Dropped source field data:",b),!b){console.error("No source field data found in the drop event");return}const m=M.currentTarget;m.style.boxShadow="",m.style.borderColor="",m.style.backgroundColor="",m.style.transform="",l({sourceField:b,targetField:g.id}),A(g.id),m.style.boxShadow="0 0 0 2px #4caf50",m.style.borderColor="#4caf50",m.style.backgroundColor="#f4fbf4",m.style.transform="scale(1.02)";const z=b;setTimeout(()=>{try{z?(m.style.borderColor="#4caf50",m.style.backgroundColor="#f4fbf4"):(m.style.borderColor=O?O.severity==="error"?"#f44336":"#ff9800":"#e0e0e0",m.style.backgroundColor=O?O.severity==="error"?"#fff5f5":"#fffbf0":"#ffffff"),m.style.boxShadow="",m.style.transform=""}catch(W){console.error("Error in animation cleanup:",W)}},1e3),console.log(`Successfully dropped ${b} onto ${g.name}`)}catch(b){console.error("Error in drop handler:",b)}},K=()=>{U&&y(g.name)},G=()=>e.jsxs(j,{children:[e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Required Format:"})," ",g.format||"No specific format required"]}),g.examples&&e.jsxs(j,{sx:{mt:1},children:[e.jsx(f,{variant:"body2",children:e.jsx("strong",{children:"Examples:"})}),e.jsx(j,{component:"ul",sx:{mt:.5,pl:2},children:g.examples.map((M,b)=>e.jsx(j,{component:"li",children:e.jsx(f,{variant:"body2",fontFamily:"monospace",children:M})},b))})]}),g.validation&&e.jsxs(f,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Validation:"})," ",String(g.validation)]})]}),I=()=>{let M="";switch(g.dataType){case"string":M="Text value. Can contain any characters.";break;case"number":M="Numeric value. Can be integer or decimal.";break;case"date":M="Date value. Should be in a standard format.";break;case"boolean":M="True/False value.";break;case"location":M="Geographic coordinates or address.";break;default:M=`${g.dataType} data type.`}return e.jsxs(j,{children:[e.jsx(f,{variant:"body2",children:M}),g.dataType==="date"&&e.jsx(f,{variant:"body2",sx:{mt:1},children:"Common formats: YYYY-MM-DD, MM/DD/YYYY"})]})};return e.jsxs(j,{sx:{p:2,mb:2,border:"1px solid",borderColor:O?O.severity==="error"?"error.main":"warning.main":U?"success.light":"divider",borderRadius:1,bgcolor:O?O.severity==="error"?he(x.palette.error.light,.1):he(x.palette.warning.light,.1):U?he(x.palette.success.light,.1):"background.paper",position:"relative",transition:"all 0.3s ease",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",cursor:U?"pointer":"default",...B&&{boxShadow:"0 0 0 2px #1976d2",border:"1px solid #1976d2"},"&:hover":U?{boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transform:"translateY(-2px)"}:{}},draggable:!1,id:`target-field-${g.id}`,"data-target-field":g.id,onDragOver:D,onDragLeave:v,onDrop:F,onClick:K,children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(j,{children:[e.jsx(Ge,{title:`${g.name} Field`,content:G(),placement:"top-start",icon:!0,children:e.jsxs(f,{variant:"subtitle2",component:"div",sx:{display:"inline-flex",alignItems:"center",cursor:"help"},children:[g.name,g.isRequired&&e.jsx(le,{size:"small",label:"Required",color:"primary",sx:{ml:1,height:20}}),U&&e.jsx(le,{size:"small",label:"Click to preview",color:"info",variant:"outlined",sx:{ml:1,height:20,display:{xs:"none",sm:"flex"},animation:B?"none":"pulse 1.5s infinite","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0.4)"},"70%":{boxShadow:"0 0 0 6px rgba(33, 150, 243, 0)"},"100%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0)"}}}})]})}),g.dataType&&e.jsx(Ge,{title:`${g.dataType} Data Type`,content:I(),children:e.jsx(le,{size:"small",label:g.dataType,color:P(g.dataType).color,variant:"outlined",icon:P(g.dataType).icon,sx:{mt:1,mr:1,height:20}})}),e.jsx(f,{variant:"body2",color:"text.secondary",children:g.description})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"flex-start"},children:[O&&e.jsx(Ge,{title:"Validation Issue",content:e.jsx(f,{variant:"body2",children:O.message}),type:O.severity==="error"?"warning":"info",children:e.jsx(j,{sx:{display:"flex",alignItems:"center",mr:1},children:O.severity==="error"?e.jsx(ds,{color:"error",fontSize:"small"}):e.jsx(us,{color:"warning",fontSize:"small"})})}),U&&e.jsxs(e.Fragment,{children:[e.jsx(Ge,{title:"Edit Transformations",content:e.jsx(f,{variant:"body2",children:"Configure data transformations for this field mapping. Apply operations like splitting, joining, formatting and type conversion."}),children:e.jsx(Ce,{size:"small",onClick:M=>{M.stopPropagation(),i(g.id)},sx:{mr:1},children:e.jsx(cs,{fontSize:"small"})})}),e.jsx(Ge,{title:"Remove Mapping",content:e.jsx(f,{variant:"body2",children:"Remove the current mapping between source and target fields."}),type:"warning",children:e.jsx(Ce,{size:"small",onClick:M=>{M.stopPropagation(),p(g.id)},children:e.jsx(nt,{fontSize:"small"})})})]})]})]}),e.jsxs(Ae,{fullWidth:!0,size:"small",children:[e.jsx($e,{id:`${g.id}-source-label`,children:"Select source field"}),e.jsxs(Re,{labelId:`${g.id}-source-label`,id:`${g.id}-source-select`,value:U||"",label:"Select source field",onChange:M=>{try{J(g.id,M.target.value),M.target.value?A(g.name):$===g.name&&A(null)}catch(b){console.error("Error in dropdown change handler:",b)}},MenuProps:{anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},slotProps:{paper:{elevation:4,style:{maxHeight:300}}}},renderValue:M=>M||e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"}),endAdornment:U&&e.jsx(Oe,{position:"end",children:e.jsx(Ge,{title:"Field is Mapped",content:e.jsxs(f,{variant:"body2",children:['This field is mapped to source field "',U,'". Click the field to preview the mapping.']}),children:e.jsx(qe,{color:"success",fontSize:"small"})})}),onClick:M=>M.stopPropagation(),children:[e.jsx(ne,{value:"",children:e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"})}),Array.isArray(h)&&h.length>0?h.map(M=>{const b=d&&d.length>0?d[0][M]:void 0;let m="Unknown";b!=null&&(typeof b=="string"?[/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/].some(Z=>Z.test(b))?m="Date":/^\d{1,2}:\d{2}(:\d{2})?(\s*(AM|PM))?$/i.test(b)?m="Time":isNaN(Number(b))?m="Text":m="Number":m=typeof b);const z=W=>W==null?"":typeof W=="object"?JSON.stringify(W).substring(0,30):String(W).substring(0,30);return e.jsx(ne,{value:M,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsx(f,{variant:"body2",children:M}),b!==void 0&&e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(f,{variant:"caption",sx:{fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"text.secondary"},children:z(b)}),e.jsx(le,{label:m,size:"small",sx:{height:16,fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]})]})},M)}):e.jsx(ne,{disabled:!0,children:e.jsx("em",{children:"No source fields available"})})]})]})]},g.id)},k=()=>{if(n){const g=Array.isArray(H)?H:Object.values(H).flat();return e.jsx(j,{children:g.map(T)})}else return Object.entries(H).map(([g,U])=>e.jsxs(os,{expanded:Y[g]||!1,onChange:()=>X(g),sx:{mb:2},children:[e.jsxs(as,{expandIcon:e.jsx(xt,{}),children:[e.jsx(f,{variant:"subtitle1",children:g}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{ml:2},children:[U.length," fields"]})]}),e.jsx(is,{children:U.map(T)})]},g))},[ie,R]=N.useState(!1),L=N.useMemo(()=>t.requiredFields.filter(U=>!o.some(O=>O.targetField===U.name)),[t.requiredFields,o]),te=g=>{console.log("Received default mappings:",g),g.forEach(U=>{console.log("Adding default mapping for:",U.targetField,U),l(U)}),console.log("Current mappings after adding defaults:",o)};return e.jsxs(fe,{sx:{p:2,height:"100%",display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[L.length>0&&e.jsxs(oe,{variant:"outlined",size:"small",startIcon:e.jsx(Us,{}),onClick:()=>R(!0),color:"primary",children:["Set Default Values (",L.length,")"]}),e.jsx(We,{control:e.jsx(Ls,{checked:n,onChange:g=>r(g.target.checked),size:"small"}),label:"Show all fields A-Z"})]}),L.length>0&&e.jsxs(ce,{severity:"warning",sx:{mb:2},action:e.jsx(oe,{color:"inherit",size:"small",onClick:()=>R(!0),children:"Set Defaults"}),children:[L.length," required ",L.length===1?"field":"fields"," not mapped. Please map or set default values to continue."]}),e.jsx(be,{size:"small",placeholder:"Search target fields...",value:s,onChange:g=>a(g.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(rt,{fontSize:"small"})})}}),e.jsx(ye,{sx:{mb:2}}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(f,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drop source fields onto target fields or use the drop-down menus below"})}),$&&e.jsx(un,{mapping:o.find(g=>g.targetField===$)||null,sampleData:d,onClose:()=>A(null)}),e.jsx(j,{sx:{flexGrow:1,maxHeight:"calc(100% - 220px)",overflow:"auto",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:k()}),S&&e.jsx(ln,{open:!!S,onClose:c,fieldName:S,mapping:o.find(g=>g.targetField===S),sampleData:d,onSave:w}),e.jsx(dn,{open:ie,onClose:()=>R(!1),unmappedRequiredFields:L,onAddDefaultMappings:te})]})},fn=({validationErrors:t,jumpToField:n})=>{const[r,s]=Je.useState(!1),a=t.filter(p=>p.severity==="error").length,o=t.filter(p=>p.severity==="warning").length,l=()=>{s(!r)};return e.jsxs(fe,{sx:{p:2,position:"sticky",top:16},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer"},onClick:l,children:[e.jsxs(f,{variant:"h6",color:a>0?"error":"warning",children:["Validation Issues ",a>0?`(${a} errors, ${o} warnings)`:`(${o} warnings)`]}),e.jsx(oe,{size:"small",endIcon:r?e.jsx(ps,{}):e.jsx(xt,{}),children:r?"Collapse":"Expand"})]}),e.jsxs(ls,{in:r,children:[e.jsx(ye,{sx:{my:1}}),e.jsx(j,{sx:{maxHeight:"200px",overflow:"auto"},children:e.jsx(Ue,{dense:!0,children:t.map((p,u)=>e.jsxs(Ee,{sx:{bgcolor:p.severity==="error"?"error.lightest":"warning.lightest",mb:.5,borderRadius:1},children:[e.jsx(ke,{children:p.severity==="error"?e.jsx(ds,{color:"error"}):e.jsx(us,{color:"warning"})}),e.jsx(Fe,{primary:p.field,secondary:p.message}),e.jsx(oe,{size:"small",variant:"outlined",color:p.severity==="error"?"error":"warning",onClick:()=>n(p.field),children:"Go to Field"})]},u))})})]})]})},xn=({sampleData:t,mappings:n,toolConfig:r})=>{const s=N.useMemo(()=>t.length>0?t[0]:null,[t]),a=N.useMemo(()=>{if(!s||!n.length)return null;const u=hs([s],n);return u.length>0?u[0]:null},[s,n]);if(!s||!a)return e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(f,{variant:"body2",color:"text.secondary",children:"No data available for preview. Upload a file and map fields to see a live preview."})});const o=Object.keys(s),l=Object.keys(a);console.log("üîç LIVE PREVIEW DEBUG: Transformed row keys:",l),console.log("üîç LIVE PREVIEW DEBUG: Mappings count:",n.length),console.log("üîç LIVE PREVIEW DEBUG: Mappings:",n.map(u=>`${u.sourceField} ‚Üí ${u.targetField}`)),console.log("üîç LIVE PREVIEW DEBUG: Tool config available:",!!r),console.log("üîç LIVE PREVIEW DEBUG: Field ID ‚Üí Display Name conversions incoming...");const p=u=>{if(!r)return console.log(`üîç LIVE PREVIEW: No toolConfig for field ${u}`),u;const h=[...r.requiredFields||[],...r.optionalFields||[]].find(x=>x.id===u);return console.log(`üîç LIVE PREVIEW: Converting field ID "${u}" ‚Üí display name "${h?h.name:u}"`),h?h.name:u};return e.jsxs(j,{children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(f,{variant:"subtitle1",children:"Live Preview"}),e.jsx(f,{variant:"body2",color:"text.secondary",children:"Showing all mapped fields ‚Ä¢ Scroll horizontally to see more ‚Üí"})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,overflowX:"auto"},children:[e.jsx(wt,{component:fe,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(dt,{size:"small",stickyHeader:!0,children:[e.jsx(ut,{children:e.jsx(Pe,{children:o.map(u=>e.jsx(Se,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(f,{variant:"caption",fontWeight:"bold",children:u})},u))})}),e.jsx(pt,{children:e.jsx(Pe,{children:o.map(u=>e.jsx(Se,{sx:{minWidth:"120px"},children:e.jsx(f,{variant:"caption",sx:{wordBreak:"break-word"},children:s[u]!==null&&s[u]!==void 0?String(s[u]):"null"})},u))})})]})}),e.jsx(j,{sx:{display:"flex",justifyContent:"center",alignItems:"center",px:2,flexShrink:0},children:e.jsx(Hr,{color:"primary"})}),e.jsx(wt,{component:fe,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(dt,{size:"small",stickyHeader:!0,children:[e.jsx(ut,{children:e.jsx(Pe,{children:l.map(u=>e.jsx(Se,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(f,{variant:"caption",fontWeight:"bold",children:p(u)})},u))})}),e.jsx(pt,{children:e.jsx(Pe,{children:l.map(u=>e.jsx(Se,{sx:{minWidth:"120px"},children:e.jsx(f,{variant:"caption",sx:{wordBreak:"break-word"},children:a[u]!==null&&a[u]!==void 0?String(a[u]):"null"})},u))})})]})})]})]})},bs=(t,n)=>{N.useEffect(()=>{if(n)try{localStorage.setItem(`tmpl:${t.id}`,JSON.stringify(t)),console.log(`Template "${t.name}" saved to localStorage`)}catch(h){console.error("Failed to save template to localStorage:",h)}},[t,n]);const r=h=>{try{let C=Object.keys(localStorage).filter($=>$.startsWith("tmpl:")).map($=>{const A=localStorage.getItem($);return A?JSON.parse(A):null}).filter(Boolean);return h&&(C=C.filter($=>$.toolId===h)),C.sort(($,A)=>A.lastModified-$.lastModified)}catch(x){return console.error("Failed to load templates from localStorage:",x),[]}},s=h=>{try{return localStorage.removeItem(`tmpl:${h}`),!0}catch(x){return console.error("Failed to delete template:",x),!1}};return{loadTemplates:r,deleteTemplate:s,saveToServer:async()=>(console.log("Saving template to server:",t),new Promise(h=>{setTimeout(()=>{console.log("Template saved to server successfully"),h()},500)})),loadFromServer:async()=>r(),autoSaveTemplate:(h,x)=>{if(!h||h.length===0)return;const S={id:`auto-${x}-${Date.now()}`,name:`Auto-saved ${x} mapping`,description:"Automatically saved field mapping configuration",toolId:x,mappings:h,lastModified:Date.now()};try{localStorage.setItem(`tmpl:${S.id}`,JSON.stringify(S)),console.log("Template auto-saved:",S.name)}catch(C){console.error("Failed to auto-save template:",C)}},getTemplateStats:()=>{var S;const h=r(),x={total:h.length,byTool:{},mostRecent:((S=h[0])==null?void 0:S.lastModified)||0,totalMappings:h.reduce((C,$)=>{var A;return C+(((A=$.mappings)==null?void 0:A.length)||0)},0)};return h.forEach(C=>{const $=C.toolId||"unknown";x.byTool[$]=(x.byTool[$]||0)+1}),x},findSimilarTemplates:(h,x)=>{if(!h||h.length===0)return[];const S=r(x),C=new Set(h.map($=>$.sourceField.toLowerCase()));return S.map($=>{const A=new Set($.mappings.map(q=>q.sourceField.toLowerCase())),_=new Set([...C].filter(q=>A.has(q))).size/Math.max(C.size,A.size);return{template:$,similarity:_}}).filter(({similarity:$})=>$>.3).sort(($,A)=>A.similarity-$.similarity).map(({template:$})=>$)},cleanupAutoSaved:()=>{try{r().filter(S=>S.name.startsWith("Auto-saved")).sort((S,C)=>C.lastModified-S.lastModified).slice(5).forEach(S=>{s(S.id)})}catch(h){console.error("Failed to cleanup auto-saved templates:",h)}}}},Rt={id:"vendor_console_one_standard",name:"Console One CAD - Standard Template",description:"Professional template for Console One CAD systems with NFIRS code support. Includes incident times, unit information, and location data.",cadVendor:"Console One",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"INC_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_TIME",targetField:"dispatch_time"},{sourceField:"ENROUTE_TIME",targetField:"enroute_time"},{sourceField:"ARRIVAL_TIME",targetField:"arrival_time"},{sourceField:"CLEAR_TIME",targetField:"clear_time"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"UNIT_ID",targetField:"responding_unit"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["INC_DATE_TIME","INC_NUM","INC_DATE","DISPATCH_TIME","ENROUTE_TIME","ARRIVAL_TIME","CLEAR_TIME","PROBLEM_TYPE","UNIT_ID","LOCATION_ADDRESS","LATITUDE","LONGITUDE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Console One"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:95,successRate:100,dataTypes:{},sampleValues:{INC_DATE_TIME:["01/15/2024 14:23:45","01/15/2024 15:30:12"],PROBLEM_TYPE:["111","522","311","651"],UNIT_ID:["E01","T01","M01","BC01"]},tags:["console-one","nfirs","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},yn={id:"vendor_tyler_standard",name:"Tyler Technologies CAD - Standard Template",description:"Professional template for Tyler Technologies CAD systems. Handles mixed field naming conventions and date formats common in Tyler exports.",cadVendor:"Tyler",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"ALARM_TIME",targetField:"incident_time"},{sourceField:"INCIDENT_NUMBER",targetField:"incident_id"},{sourceField:"INCIDENT_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_DATE",targetField:"dispatch_time"},{sourceField:"ENROUTE_DATE",targetField:"enroute_time"},{sourceField:"ARRIVAL_DATE",targetField:"arrival_time"},{sourceField:"CLEAR_DATE",targetField:"clear_time"},{sourceField:"NATURE_CODE",targetField:"incident_type"},{sourceField:"PRIMARY_UNIT",targetField:"responding_unit"},{sourceField:"ADDRESS",targetField:"address"},{sourceField:"CITY",targetField:"city"},{sourceField:"STATE",targetField:"state"}],sourceFieldPattern:{fieldNames:["ALARM_TIME","INCIDENT_NUMBER","INCIDENT_DATE","DISPATCH_DATE","ENROUTE_DATE","ARRIVAL_DATE","CLEAR_DATE","NATURE_CODE","PRIMARY_UNIT","ADDRESS","CITY","STATE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Tyler"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:92,successRate:98,dataTypes:{},sampleValues:{ALARM_TIME:["2024-01-15 14:23:45","2024-01-15 15:30:12"],NATURE_CODE:["FIREA","EMSC","FIREB","HAZMAT"],PRIMARY_UNIT:["Engine 1","Truck 1","Medic 1","Chief 1"]},tags:["tyler","tyler-technologies","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},bn={id:"vendor_hexagon_standard",name:"Hexagon/Intergraph CAD - Standard Template",description:"Professional template for Hexagon/Intergraph CAD systems. Handles PascalCase field naming and mixed datetime formats with/without seconds.",cadVendor:"Hexagon",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"CallDateTime",targetField:"incident_time"},{sourceField:"IncidentNumber",targetField:"incident_id"},{sourceField:"CallDate",targetField:"incident_date"},{sourceField:"DispatchDateTime",targetField:"dispatch_time"},{sourceField:"EnRouteDateTime",targetField:"enroute_time"},{sourceField:"ArrivalDateTime",targetField:"arrival_time"},{sourceField:"ClearDateTime",targetField:"clear_time"},{sourceField:"IncidentType",targetField:"incident_type"},{sourceField:"UnitId",targetField:"responding_unit"},{sourceField:"LocationAddress",targetField:"address"},{sourceField:"Latitude",targetField:"latitude"},{sourceField:"Longitude",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["CallDateTime","IncidentNumber","CallDate","DispatchDateTime","EnRouteDateTime","ArrivalDateTime","ClearDateTime","IncidentType","UnitId","LocationAddress","Latitude","Longitude"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Hexagon"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:90,successRate:95,dataTypes:{},sampleValues:{CallDateTime:["01/20/2024 14:28","01/20/2024 15:35:22"],IncidentType:["Structure Fire","Medical Emergency","Vehicle Accident"],UnitId:["ENG001","TRK001","MED001","BC001"]},tags:["hexagon","intergraph","pascalcase","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},jn={id:"vendor_tritech_standard",name:"TriTech/CentralSquare CAD - Standard Template",description:"Professional template for TriTech/CentralSquare CAD systems. Handles underscore_case naming conventions and EventNum identifiers.",cadVendor:"TriTech",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"Call_Date_Time",targetField:"incident_time"},{sourceField:"EventNum",targetField:"incident_id"},{sourceField:"Call_Date",targetField:"incident_date"},{sourceField:"Dispatch_Time",targetField:"dispatch_time"},{sourceField:"Enroute_Time",targetField:"enroute_time"},{sourceField:"Arrival_Time",targetField:"arrival_time"},{sourceField:"Clear_Time",targetField:"clear_time"},{sourceField:"Call_Type",targetField:"incident_type"},{sourceField:"Unit_ID",targetField:"responding_unit"},{sourceField:"Address",targetField:"address"},{sourceField:"City",targetField:"city"},{sourceField:"State",targetField:"state"}],sourceFieldPattern:{fieldNames:["Call_Date_Time","EventNum","Call_Date","Dispatch_Time","Enroute_Time","Arrival_Time","Clear_Time","Call_Type","Unit_ID","Address","City","State"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"TriTech"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:88,successRate:93,dataTypes:{},sampleValues:{Call_Date_Time:["2024-01-15 14:23:45","2024-01-15 15:30:12"],Call_Type:["FIRE","EMS","RESCUE","HAZMAT"],Unit_ID:["E1","L1","M1","C1"]},tags:["tritech","centralsquare","underscore","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},vn={...Rt,id:"vendor_console_one_firemap",name:"Console One CAD - Fire Map Pro Template",description:"Geographic analysis template for Console One CAD data. Optimized for incident mapping and spatial analysis.",targetTool:"fire-map-pro",fieldMappings:[{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"UNIT_ID",targetField:"responding_unit"}],metadata:{...Rt.metadata,tags:["console-one","fire-map-pro","geographic","certified"]}},Ot=[Rt,yn,bn,jn,vn],Tn=()=>Ot.filter(t=>{var n;return((n=t.metadata.tags)==null?void 0:n.includes("certified"))&&t.isPublic}),gt=()=>{try{const t=JSON.parse(localStorage.getItem("fireems_field_mapping_templates")||"[]");if(t.some(r=>{var s;return(s=r.id)==null?void 0:s.startsWith("vendor_")}))console.log("üìö Vendor templates already exist, skipping seed");else{console.log("üå± Seeding vendor templates for first-time user...");const r=[...t,...Ot];localStorage.setItem("fireems_field_mapping_templates",JSON.stringify(r)),console.log(`‚úÖ Seeded ${Ot.length} vendor templates successfully`)}}catch(t){console.error("‚ùå Error seeding vendor templates:",t)}};class Ye{static async saveTemplate(n,r,s,a,o,l,p,u){const d={id:this.generateTemplateId(),name:n.trim(),description:r.trim(),departmentName:p,cadVendor:u,targetTool:l,fieldMappings:s,sourceFieldPattern:this.analyzeSourcePattern(a,o),metadata:this.generateMetadata(s,o),createdAt:new Date().toISOString(),useCount:0,isPublic:!1},h=this.getStoredTemplates();return h.push(d),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(h)),console.log(`‚úÖ Template saved: "${n}" (${d.id})`),d}static getTemplates(){try{gt();const n=this.getStoredTemplates();return console.log("üìö TemplateService.getTemplates() found:",n.length,"templates"),console.log("üèÖ Vendor templates:",n.filter(r=>{var s;return(s=r.id)==null?void 0:s.startsWith("vendor_")}).length),n}catch(n){return console.error("‚ùå Error in getTemplates:",n),[]}}static getTemplatesForTool(n){return gt(),this.getStoredTemplates().filter(r=>r.targetTool===n)}static getCertifiedTemplatesForTool(n){return Tn().filter(r=>r.targetTool===n)}static deleteTemplate(n){const r=this.getStoredTemplates(),s=r.findIndex(a=>a.id===n);return s!==-1?(r.splice(s,1),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)),console.log(`üóëÔ∏è Template deleted: ${n}`),!0):!1}static suggestTemplates(n,r,s){var l;const a=this.getTemplatesForTool(s),o=[];for(const p of a){const u=this.calculateSimilarity(n,p.sourceFieldPattern.fieldNames);if(u.score>=30){let d=u.score;(l=p.metadata.tags)!=null&&l.includes("certified")&&p.isPublic&&(d+=10,console.log(`üèÖ Certified template boost: "${p.name}" ${u.score}% ‚Üí ${d}%`)),o.push({template:p,similarityScore:d,matchingFields:u.matchingFields,missingFields:u.missingFields,suggestions:this.generateSuggestions(u,p)})}}return o.sort((p,u)=>{var x,S;const d=(x=p.template.metadata.tags)!=null&&x.includes("certified")?1:0,h=(S=u.template.metadata.tags)!=null&&S.includes("certified")?1:0;return d!==h?h-d:u.similarityScore-p.similarityScore}),console.log(`üîç Found ${o.length} template suggestions for tool: ${s}`),console.log(`üèÖ Certified templates: ${o.filter(p=>{var u;return(u=p.template.metadata.tags)==null?void 0:u.includes("certified")}).length}`),o.slice(0,8)}static applyTemplate(n,r){const s=[];this.incrementTemplateUsage(n.id);for(const a of n.fieldMappings){if(r.includes(a.sourceField)){s.push({...a});continue}const o=r.find(p=>p.toLowerCase()===a.sourceField.toLowerCase());if(o){s.push({...a,sourceField:o});continue}const l=this.findFuzzyMatch(a.sourceField,r);l&&s.push({...a,sourceField:l})}return console.log(`üîß Applied template "${n.name}": ${s.length} mappings applied`),s}static generateCADSignature(n){const r={"Console One":["INC_DATE_TIME","PROBLEM_TYPE","UNIT_ID"],Tyler:["ALARM_TIME","INCIDENT_DATE","DISPATCH_DATE"],Hexagon:["CallDateTime","DispatchDateTime","ArrivalDateTime"],TriTech:["EventNum","Call_Date_Time","Unit_ID"]};let s="Other",a=0;for(const[o,l]of Object.entries(r)){const p=l.filter(u=>n.some(d=>d.toLowerCase().includes(u.toLowerCase()))).length;p>a&&(a=p,s=o)}return s}static getStoredTemplates(){try{const n=localStorage.getItem(this.STORAGE_KEY);return n?JSON.parse(n):[]}catch(n){return console.warn("Failed to load templates from localStorage:",n),[]}}static generateTemplateId(){return`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static analyzeSourcePattern(n,r){return{fieldNames:[...n],fieldCount:n.length,hasHeaderRow:!0,commonPatterns:this.extractCommonPatterns(n),cadVendorSignature:this.generateCADSignature(n)}}static extractCommonPatterns(n){const r=[],s={datetime:["date","time","datetime"],location:["address","location","lat","lng","coord"],incident:["incident","call","event","alarm"],unit:["unit","apparatus","resource"],type:["type","category","classification"]};for(const[a,o]of Object.entries(s))o.some(l=>n.some(p=>p.toLowerCase().includes(l)))&&r.push(a);return r}static generateMetadata(n,r){const a=Math.min(100,n.length/10*100),o={};if(r.length>0)for(const l of n){const p=r.slice(0,3).map(u=>u[l.sourceField]).filter(u=>u!=null&&u!=="").map(u=>String(u));p.length>0&&(o[l.sourceField]=p)}return{version:this.VERSION,compatibility:["1.0.0"],qualityScore:Math.round(a),successRate:100,dataTypes:{},sampleValues:o,tags:[]}}static calculateSimilarity(n,r){const s=new Set(n.map(p=>p.toLowerCase()));new Set(r.map(p=>p.toLowerCase()));const a=[],o=[];for(const p of r)s.has(p.toLowerCase())?a.push(p):o.push(p);const l=a.length/r.length*100;return{score:Math.round(l),matchingFields:a,missingFields:o}}static generateSuggestions(n,r){const s=[];return n.score>=80?s.push("Excellent match! This template should work with minimal adjustments."):n.score>=60?s.push("Good match. May need minor field mapping adjustments."):n.score>=30&&s.push("Partial match. Review field mappings carefully."),n.missingFields.length>0&&s.push(`Missing fields: ${n.missingFields.slice(0,3).join(", ")}`),s}static findFuzzyMatch(n,r){const s=n.toLowerCase();for(const a of r){const o=a.toLowerCase();if(this.stringSimilarity(s,o)>=.7)return a}return null}static stringSimilarity(n,r){const s=n.length>r.length?n:r,a=n.length>r.length?r:n;if(s.length===0)return 1;const o=this.levenshteinDistance(s,a);return(s.length-o)/s.length}static levenshteinDistance(n,r){const s=[];for(let a=0;a<=r.length;a++)s[a]=[a];for(let a=0;a<=n.length;a++)s[0][a]=a;for(let a=1;a<=r.length;a++)for(let o=1;o<=n.length;o++)r.charAt(a-1)===n.charAt(o-1)?s[a][o]=s[a-1][o-1]:s[a][o]=Math.min(s[a-1][o-1]+1,s[a][o-1]+1,s[a-1][o]+1);return s[r.length][n.length]}static incrementTemplateUsage(n){const r=this.getStoredTemplates(),s=r.find(a=>a.id===n);s&&(s.useCount++,s.lastUsed=new Date().toISOString(),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)))}}it(Ye,"STORAGE_KEY","fireems_field_mapping_templates"),it(Ye,"VERSION","1.0.0");const Sn=({currentTemplate:t,setCurrentTemplate:n,setTemplateDirty:r,onTemplateApplied:s,disabled:a=!1,currentMappings:o=[],sourceFields:l=[],sampleData:p=[],targetTool:u="",onApplyFieldMappings:d})=>{const[h,x]=N.useState(null),[S,C]=N.useState(!1),[$,A]=N.useState(!1),[Y,_]=N.useState(t.name),[q,V]=N.useState(t.description||""),[E,H]=N.useState([]),[X,J]=N.useState([]),[i,c]=N.useState(""),[y,w]=N.useState(""),{loadTemplates:P,deleteTemplate:T,saveToServer:k}=bs(t,!1);N.useEffect(()=>{const b=P();H(b),l.length>0&&u&&p.length>0&&ie()},[l,u,p]);const ie=()=>{try{const b=Ye.suggestTemplates(l,p,u);J(b);const m=Ye.generateCADSignature(l);c(m)}catch(b){console.error("Error loading template suggestions:",b)}},R=b=>{x(b.currentTarget)},L=()=>{x(null)},te=()=>{const b=t.name==="Untitled Mapping"?M():t.name;_(b),V(t.description||""),C(!0),L()},g=()=>{const b=P();H(b),A(!0),L()},U=async()=>{try{if(o.length>0&&l.length>0&&u)await Ye.saveTemplate(Y,q,o,l,p,u,y||void 0,i||void 0);else{const m={...t,name:Y,description:q,lastModified:Date.now()};n(m),k()}r(!1);const b=P();H(b),C(!1)}catch(b){console.error("Error saving template:",b)}},O=b=>{n(b),r(!1),s&&s(b),A(!1)},B=b=>{try{const m=Ye.applyTemplate(b,l);d&&d(m),A(!1)}catch(m){console.error("Error applying template:",m)}},D=b=>{T(b);const m=P();H(m)},v=b=>{const m={...b,id:`template-${Date.now()}`,name:`${b.name} (Copy)`,lastModified:Date.now()};localStorage.setItem(`tmpl:${m.id}`,JSON.stringify(m));const z=P();H(z)},F=b=>{const m=new Date(b),W=(new Date().getTime()-m.getTime())/(1e3*60*60);return W<24?`${Math.floor(W)} hours ago`:W<24*7?`${Math.floor(W/24)} days ago`:m.toLocaleDateString()},K=b=>{const m=b.name.toLowerCase(),z=(b.description||"").toLowerCase(),W=`${m} ${z}`;return W.includes("tyler")||W.includes("cad")?"CAD System":W.includes("monthly")||W.includes("export")?"Monthly Report":W.includes("response")||W.includes("time")?"Response Time":W.includes("fire")||W.includes("map")?"Fire Map":W.includes("test")||W.includes("sample")?"Test Data":"General"},G=b=>{switch(b){case"CAD System":return"primary";case"Monthly Report":return"success";case"Response Time":return"info";case"Fire Map":return"warning";case"Test Data":return"secondary";default:return"secondary"}},I=E.reduce((b,m)=>{const z=m.toolId||"unknown";return b[z]||(b[z]=[]),b[z].push(m),b},{}),M=()=>{const b=t.toolId||"Tool",m=new Date,z=m.toLocaleDateString("en-US",{month:"long"});if(t.mappings.length>0){const W=t.mappings.map(Z=>Z.sourceField.toLowerCase());if(W.some(Z=>Z.includes("tyler")))return`Tyler CAD Export - ${z} ${m.getFullYear()}`;if(W.some(Z=>Z.includes("dispatch")||Z.includes("call")))return`${b} Monthly Export - ${z}`}return`${b} Mapping Template`};return e.jsxs(e.Fragment,{children:[e.jsx(ze,{title:a?"Complete field mapping to access templates":"Save and load field mapping templates",children:e.jsx("span",{children:e.jsx(oe,{variant:"outlined",size:"small",onClick:R,startIcon:e.jsx(Gt,{}),disabled:a,children:"Templates"})})}),e.jsxs(ks,{anchorEl:h,open:!!h,onClose:L,children:[e.jsxs(ne,{onClick:te,children:[e.jsx(rs,{fontSize:"small",sx:{mr:1}}),"Save Template As..."]}),e.jsxs(ne,{onClick:g,children:[e.jsx(Gt,{fontSize:"small",sx:{mr:1}}),"Load Template"]}),e.jsxs(ne,{onClick:()=>{gt();const b=P();H(b),console.log("üå± Vendor templates seeded manually")},children:[e.jsx(St,{fontSize:"small",sx:{mr:1}}),"Load Vendor Templates"]})]}),e.jsxs(Ke,{open:S,onClose:()=>C(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Xe,{children:"Save Mapping Template"}),e.jsxs(Ze,{children:[e.jsx(ce,{severity:"info",sx:{mb:3},children:e.jsx(f,{variant:"body2",children:"Save this field mapping configuration for future use. Templates help you quickly map data from the same source system."})}),e.jsx(be,{autoFocus:!0,margin:"dense",label:"Template Name",fullWidth:!0,value:Y,onChange:b=>_(b.target.value),sx:{mb:2},placeholder:"e.g., Tyler CAD Monthly Export, Fire Map Pro Standard"}),e.jsx(be,{margin:"dense",label:"Description (optional)",fullWidth:!0,multiline:!0,rows:2,value:q,onChange:b=>V(b.target.value),placeholder:"e.g., Standard monthly incident export from Tyler Technologies CAD system"}),o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(be,{margin:"dense",label:"Department Name (optional)",fullWidth:!0,value:y,onChange:b=>w(b.target.value),placeholder:"e.g., Houston Fire Department",sx:{mt:2}}),e.jsxs(be,{margin:"dense",label:"CAD Vendor",fullWidth:!0,select:!0,value:i,onChange:b=>c(b.target.value),sx:{mt:2},children:[e.jsx(ne,{value:"Console One",children:"Console One"}),e.jsx(ne,{value:"Tyler",children:"Tyler Technologies"}),e.jsx(ne,{value:"Hexagon",children:"Hexagon/Intergraph"}),e.jsx(ne,{value:"TriTech",children:"TriTech/CentralSquare"}),e.jsx(ne,{value:"Other",children:"Other"})]})]}),e.jsx(bt,{variant:"outlined",sx:{mt:2},children:e.jsxs(jt,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Template Preview"}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Tool: ",t.toolId||"Unknown"]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Mappings: ",t.mappings.length," field mappings"]}),t.mappings.length>0&&e.jsx(j,{sx:{mt:1},children:e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Sample mappings: ",t.mappings.slice(0,3).map(b=>`${b.sourceField} ‚Üí ${b.targetField}`).join(", "),t.mappings.length>3&&` +${t.mappings.length-3} more`]})})]})})]}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:()=>C(!1),children:"Cancel"}),e.jsx(oe,{onClick:U,variant:"contained",children:"Save Template"})]})]}),e.jsxs(Ke,{open:$,onClose:()=>A(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Xe,{children:"Load Mapping Template"}),e.jsxs(Ze,{children:[X.length>0&&e.jsxs(j,{sx:{mb:4},children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(Wr,{sx:{mr:1,fontSize:20}}),"Smart Template Suggestions",e.jsx(le,{label:X.length,size:"small",sx:{ml:1}})]}),e.jsx(ce,{severity:"success",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:["Found ",X.length," template",X.length!==1?"s":""," that match your data structure. These are pre-configured for your CAD system type."]})}),e.jsx(Ue,{children:X.map((b,m)=>{var z;return e.jsx(Ee,{component:"button",onClick:()=>B(b.template),sx:{py:2,borderRadius:1,mb:1,border:1,borderColor:b.similarityScore>=80?"success.main":"divider","&:hover":{backgroundColor:"action.hover"}},children:e.jsx(Fe,{primary:e.jsxs(st,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsxs(j,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(f,{variant:"subtitle1",children:b.template.name}),((z=b.template.metadata.tags)==null?void 0:z.includes("certified"))&&e.jsx(le,{icon:e.jsx(en,{}),label:"Certified",color:"primary",size:"small",variant:"filled"})]}),e.jsx(le,{label:`${b.similarityScore}% match`,color:b.similarityScore>=80?"success":b.similarityScore>=60?"warning":"default",size:"small"}),b.template.cadVendor&&e.jsx(le,{label:b.template.cadVendor,size:"small",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(f,{variant:"body2",sx:{mb:.5},children:b.template.description}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Matching fields: ",b.matchingFields.join(", ")]}),b.missingFields.length>0&&e.jsxs(f,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["Missing: ",b.missingFields.slice(0,3).join(", "),b.missingFields.length>3&&` +${b.missingFields.length-3} more`]})]})})},b.template.id)})})]}),E.length===0&&X.length===0?e.jsxs(j,{sx:{textAlign:"center",py:4},children:[e.jsx(St,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(f,{variant:"h6",gutterBottom:!0,children:"No saved templates found"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Templates save your field mapping configurations for reuse with similar data exports."}),e.jsx(ce,{severity:"info",children:e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Pro Tip:"})," After mapping fields for your CAD system, save it as a template. Next month's export will auto-map instantly!"]})})]}):E.length>0&&e.jsxs(j,{children:[X.length>0&&e.jsxs(f,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mt:2},children:[e.jsx($t,{sx:{mr:1,fontSize:20}}),"Your Saved Templates"]}),e.jsx(ce,{severity:"success",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:["Found ",E.length," saved template",E.length!==1?"s":"",". Click any template to apply its field mappings instantly."]})}),Object.entries(I).map(([b,m])=>e.jsxs(j,{sx:{mb:3},children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(St,{sx:{mr:1,fontSize:20}}),b==="unknown"?"General Templates":`${b} Templates`,e.jsx(le,{label:m.length,size:"small",sx:{ml:1}})]}),e.jsx(Ue,{children:m.map(z=>{var W;return e.jsx(Je.Fragment,{children:e.jsxs(Ee,{component:"button",onClick:()=>O(z),sx:{py:2,borderRadius:1,mb:1,"&:hover":{backgroundColor:"action.hover"}},children:[e.jsx(Fe,{primary:e.jsxs(st,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(f,{variant:"subtitle1",children:z.name}),e.jsx(le,{label:K(z),size:"small",color:G(K(z)),variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[z.description&&e.jsx(f,{variant:"body2",sx:{mb:.5},children:z.description}),e.jsxs(st,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(f,{variant:"caption",color:"text.secondary",sx:{display:"flex",alignItems:"center"},children:[e.jsx($t,{sx:{fontSize:12,mr:.5}}),F(z.lastModified)]}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:[((W=z.mappings)==null?void 0:W.length)||0," field mappings"]})]}),z.mappings&&z.mappings.length>0&&e.jsxs(f,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:["Fields: ",z.mappings.slice(0,2).map(Z=>Z.sourceField).join(", "),z.mappings.length>2&&` +${z.mappings.length-2} more`]})]})}),e.jsxs(At,{children:[e.jsx(ze,{title:"Duplicate template",children:e.jsx(Ce,{edge:"end",onClick:Z=>{Z.stopPropagation(),v(z)},sx:{mr:1},children:e.jsx(Kr,{fontSize:"small"})})}),e.jsx(ze,{title:"Delete template",children:e.jsx(Ce,{edge:"end",onClick:Z=>{Z.stopPropagation(),D(z.id)},children:e.jsx(nt,{fontSize:"small"})})})]})]})},z.id)})})]},b))]})]}),e.jsx(Qe,{children:e.jsx(oe,{onClick:()=>A(!1),children:"Cancel"})})]})]})},En=(t,n)=>{if(!n)return t;const r=[...n.requiredFields,...n.optionalFields];if(r.find(o=>o.id===t))return console.log(`‚úÖ Field ID already correct: "${t}"`),t;const a=r.find(o=>o.name===t);return a?(console.log(`üîÑ Converting display name "${t}" to field ID "${a.id}"`),a.id):(console.warn(`‚ö†Ô∏è Unknown target field: "${t}" - keeping as-is`),t)},Jt=(t,n)=>{if(!n||!t)return t;console.log("üîÑ Starting field mapping migration...");const r=t.map(s=>{const a=s.targetField,o=En(s.targetField,n);return a!==o&&console.log(`üìã Migrating: "${s.sourceField}" ‚Üí "${a}" becomes "${s.sourceField}" ‚Üí "${o}"`),{...s,targetField:o}});return console.log("‚úÖ Field mapping migration complete"),r},Kt=(t,n)=>{if(!n||!t)return{isConsistent:!0,issues:[]};const r=[...n.requiredFields,...n.optionalFields],s=[];return t.forEach(a=>{const o=r.some(p=>p.id===a.targetField),l=r.some(p=>p.name===a.targetField);l&&!o?s.push(`Mapping "${a.sourceField}" ‚Üí "${a.targetField}" uses display name instead of field ID`):!o&&!l&&s.push(`Mapping "${a.sourceField}" ‚Üí "${a.targetField}" targets unknown field`)}),{isConsistent:s.length===0,issues:s}},Fn=t=>{if(!t||typeof t!="string")return{longitude:null,latitude:null};const n=t.trim(),r=[/^POINT\s*\(\s*(-?\d+\.?\d*)\s+(-?\d+\.?\d*)\s*\)$/i,/^POINT\s*\(\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*\)$/i,/^POINT\s*\(\s*(-?\d+\.?\d*)\s+(-?\d+\.?\d*)\s*\)$/i];for(const s of r){const a=n.match(s);if(a){const o=parseFloat(a[1]),l=parseFloat(a[2]);if(o>=-180&&o<=180&&l>=-90&&l<=90)return console.log(`üåç POINT COORDINATE PARSING: "${t}" ‚Üí Longitude: ${o}, Latitude: ${l}`),{longitude:o,latitude:l};console.warn(`üåç POINT COORDINATE PARSING: Invalid coordinate ranges - Longitude: ${o}, Latitude: ${l}`)}}return console.log(`üåç POINT COORDINATE PARSING FAILED: Could not extract coordinates from "${t}"`),{longitude:null,latitude:null}},Cn=t=>{if(!t||typeof t!="string")return{city:null,state:null};const n=t.trim(),r=new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]),s=[/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s+\d{5}(?:-\d{4})?\s*$/,/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s*$/,/^.+,\s*([A-Za-z][A-Za-z\s]+?),?\s+([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/,/^.+\s{2,}([A-Za-z][A-Za-z\s]+?)\s{2,}([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/];for(const l of s){const p=n.match(l);if(p){let u=p[1].trim();const d=p[2].trim();if(r.has(d)&&u.length>=2&&u.length<=50){const h=/\b(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i;if(u=u.replace(h,"").trim(),u.length>=2)return console.log(`üè† ENHANCED ADDRESS PARSING: "${t}" ‚Üí City: "${u}", State: "${d}"`),{city:u,state:d}}}}const a=new RegExp("\\s+([A-Z]{2})(?:\\s+\\d{5}(?:-\\d{4})?)?\\s*$"),o=n.match(a);if(o){const l=o[1];if(r.has(l)){const d=n.substring(0,n.lastIndexOf(l)).trim().split(/\s+/).slice(-3).filter(h=>!/^\d+$/.test(h)&&!/^(north|south|east|west|n|s|e|w)$/i.test(h)&&!/^(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i.test(h));if(d.length>0){const h=d.join(" ");if(h.length>=2&&h.length<=50)return console.log(`üè† FALLBACK ADDRESS PARSING: "${t}" ‚Üí City: "${h}", State: "${l}"`),{city:h,state:l}}}}return console.log(`üè† ADDRESS PARSING FAILED: Could not extract city/state from "${t}"`),{city:null,state:null}},Dn=t=>({incident_id:["incident_number","incidentnumber","incident_num","inc_num","incnum","case_number","call_number","event_id","event_number","report_number","incidentnum","eventnum"],incident_time:["call_received_time","callreceivedtime","received_time","call_time","incident_datetime","receive_time","time_received","incident_date","inc_date_time","alarm_time","calldatetime","call_datetime"],arrival_time:["arrive_time","arrivetime","on_scene_time","onscenetime","scene_time","arrival_datetime","on_scene_datetime","arrivaldatetime","onscenetime"],dispatch_time:["dispatched_time","dispatchedtime","dispatch_datetime","notification_time","notified_time","dispatchdatetime"],enroute_time:["en_route_time","enroutetime","turnout_time","turnouttime","responding_time","travel_start_time","enroutedatetime"],clear_time:["cleared_time","clearedtime","clear_datetime","back_in_service_time","available_time","service_time","unit_clear_time","cleardatetime"],latitude:["lat","y_coord","y_coordinate","gps_lat","coord_y","ycoord"],longitude:["lng","lon","long","x_coord","x_coordinate","gps_lng","gps_lon","coord_x","xcoord"],address:["incident_address","location","street_address","full_address","addr","locationaddress"],responding_unit:["unit","primary_unit","first_unit","apparatus","resource","unit_id","responding_units","primaryunit"],incident_type:["inc_type_code","inctypecode","inc_type_desc","inctypedesc","call_type","emergency_type","event_type","nature_code","problem_type","incidenttype","incidentcategory","calltype"],zip_code:["zip","zipcode","postal_code","postcode","locationzip"],city:["incident_city","location_city","locationcity"],state:["incident_state","location_state","locationstate"],priority:["incident_priority","call_priority","priority_level"],disposition:["incident_disposition","final_disposition","outcome","incident_outcome"],district:["response_district","fire_district","service_district","districts"],cross_streets:["cross_street","nearest_intersection","intersection"]})[t]||[],wn=()=>{const t=at(),{sourceColumns:n,sampleData:r,selectedTool:s,mappings:a,processingStatus:o}=Be(v=>v.formatter),[l,p]=N.useState({id:`template-${Date.now()}`,name:"Untitled Mapping",toolId:(s==null?void 0:s.id)||"",mappings:a||[],lastModified:Date.now()}),[u,d]=N.useState(!1),[h,x]=N.useState([]),[S,C]=N.useState(!1),[$,A]=N.useState([]),[Y,_]=N.useState({message:"",severity:"info",open:!1}),[q,V]=N.useState(""),[E,H]=N.useState(""),[X,J]=N.useState(!1),i=s||void 0,{saveToServer:c,autoSaveTemplate:y,findSimilarTemplates:w,getTemplateStats:P,cleanupAutoSaved:T}=bs(l,u),k=P();N.useEffect(()=>{Object.keys(localStorage).filter(F=>F.startsWith("tmpl:")).forEach(F=>{var G;const K=localStorage.getItem(F);if(K)try{((G=JSON.parse(K).mappings)==null?void 0:G.some(b=>b.targetField&&b.targetField.includes(" ")))&&(console.log(`üîß CLEARING OUTDATED TEMPLATE: ${F} (uses display names instead of field IDs)`),localStorage.removeItem(F))}catch{console.log(`üîß CLEARING CORRUPTED TEMPLATE: ${F}`),localStorage.removeItem(F)}})},[]),N.useEffect(()=>{console.log("Redux mappings changed:",a),p(v=>{const F={...v,mappings:[...a],lastModified:Date.now()};return console.log("Updated template with Redux mappings:",F),F}),a.length>0&&d(!0)},[a]),N.useEffect(()=>{if(!i||!a||a.length===0)return;console.log("üîÑ Checking for legacy mappings that need migration...");const v=Kt(a,i);if(v.isConsistent)console.log("‚úÖ All mappings already use field IDs - no migration needed");else{console.log("üîÑ Legacy mappings detected - auto-migrating to field IDs"),console.log("Issues found:",v.issues);const F=Jt(a,i);JSON.stringify(a)!==JSON.stringify(F)&&(console.log("‚úÖ Auto-migration complete - updating mappings"),t(Ne(F)))}},[i,a==null?void 0:a.length]),N.useEffect(()=>{L()},[a,i]);const ie=v=>{console.log("handleMappingChange called with:",v);try{const F=[...a],K=F.findIndex(G=>G.targetField===v.targetField);K>=0?(console.log(`Updating existing mapping for ${v.targetField}`),F[K]=v):(console.log(`Adding new mapping for ${v.targetField}`),F.push(v)),t(Ne(F)),console.log("Mapping updated successfully:",v),_({message:`Mapped ${v.sourceField} to ${v.targetField}`,severity:"success",open:!0})}catch(F){console.error("Error updating mapping:",F)}},R=v=>{console.log("handleRemoveMapping called for:",v);try{const F=a.filter(K=>K.targetField!==v);t(Ne(F)),console.log(`Mapping for ${v} removed successfully`)}catch(F){console.error("Error removing mapping:",F)}},L=()=>{if(!i)return;console.log("üîç FIELD MAPPING AUDIT - Current State Analysis:"),console.log("=========================================="),console.log("üìã Tool Configuration:"),console.log("  Required Fields:",i.requiredFields.map(I=>({id:I.id,name:I.name}))),console.log("  Optional Fields:",i.optionalFields.map(I=>({id:I.id,name:I.name}))),console.log("üó∫Ô∏è Current Mappings:"),console.log("  Mappings Array:",a.map(I=>({source:I.sourceField,target:I.targetField})));const v=[...i.requiredFields,...i.optionalFields],F=a.map(I=>{const M=v.find(m=>m.id===I.targetField),b=v.find(m=>m.name===I.targetField);return{source:I.sourceField,target:I.targetField,isFieldId:!!M,isDisplayName:!!b,shouldBeFieldId:b?b.id:I.targetField}});console.log("üîç Mapping Analysis:"),F.forEach(I=>{console.log(`  "${I.source}" ‚Üí "${I.target}"`),console.log(`    - Is Field ID: ${I.isFieldId}`),console.log(`    - Is Display Name: ${I.isDisplayName}`),I.isDisplayName&&!I.isFieldId&&console.log(`    - ‚ö†Ô∏è PROBLEM: Should be "${I.shouldBeFieldId}" instead`)});const K=a.find(I=>I.targetField==="Call Received Date/Time");K&&(console.log("üö® SPECIFIC ISSUE DETECTED:"),console.log(`  Mapping: "${K.sourceField}" ‚Üí "${K.targetField}"`),console.log(`  Should be: "${K.sourceField}" ‚Üí "incident_time"`)),console.log("==========================================");const G=[];i.requiredFields.forEach(I=>{const M=a.find(m=>m.targetField===I.id),b=a.find(m=>m.targetField===I.name);if(console.log(`Checking required field ${I.id} (display: ${I.name})`),console.log(`  - Mapping by ID: ${M?`"${M.sourceField}" ‚Üí ${M.targetField}`:"none"}`),console.log(`  - Mapping by Name: ${b?`"${b.sourceField}" ‚Üí ${b.targetField}`:"none"}`),M)console.log(`  ‚úÖ Correct mapping found for ${I.id}`);else if(b){console.log(`  üîÑ Legacy mapping detected for ${I.id} - migrating from display name to field ID`);const m=a.findIndex(z=>z.targetField===I.name);if(m>=0){const z=[...a];z[m]={...z[m],targetField:I.id},console.log(`  üìã Auto-migrated: "${I.name}" ‚Üí "${I.id}"`),t(Ne(z))}}else console.log(`  ‚ùå No mapping found for required field ${I.id}`),G.push({field:I.id,message:`Required field ${I.name} is not mapped`,severity:"error"})}),A(G)},te=async()=>{if(!(!n||!i)){C(!0);try{console.log("üîß AUTO-MAPPING - Starting with systematic fix approach");const F=[...Jt(l.mappings,i)],K=m=>F.some(z=>z.targetField===m),G=m=>m.toLowerCase().replace(/[\s_-]/g,""),I=[...i.requiredFields,...i.optionalFields];console.log("üîß AUTO-MAPPING - Available target fields:",I.map(m=>({id:m.id,name:m.name}))),console.log("üîß AUTO-MAPPING - Source columns:",n),console.log("üîß AUTO-MAPPING - Tool config details:",{toolId:i.id,requiredCount:i.requiredFields.length,optionalCount:i.optionalFields.length,totalFields:I.length,optionalFieldsList:i.optionalFields.map(m=>m.id)}),console.log(`
üïê === SMART DATETIME DETECTION: Phase 1 Implementation ===`);const M=Nr(n,r||[]);console.log("üïê Detection result:",{type:M.pattern.type,confidence:M.pattern.confidence,description:M.pattern.description}),M.pattern.confidence>.5?(console.log("‚úÖ High confidence datetime pattern detected - applying smart mappings"),M.suggestedMappings.forEach(m=>{if(!I.some(Z=>Z.id===m.targetField)){console.log(`‚ö†Ô∏è Skipping suggestion for ${m.targetField} - not in tool config`);return}if(K(m.targetField)){console.log(`üîÑ Target ${m.targetField} already mapped - skipping automatic datetime mapping`);return}const W=m.sourceFields[0];m.transformationType==="combine"?(console.log(`üïê DATETIME COMBINE: Adding mapping "${W}" ‚Üí "${m.targetField}" (will combine with ${m.sourceFields.join(" + ")})`),F.push({sourceField:W,targetField:m.targetField,transformations:[{type:"datetime_combine",params:{sourceFields:m.sourceFields,description:m.description}}]})):m.transformationType==="extract"?(console.log(`üïê DATETIME EXTRACT: Adding mapping "${W}" ‚Üí "${m.targetField}" (will extract date/time component)`),F.push({sourceField:W,targetField:m.targetField,transformations:[{type:"datetime_extract",params:{extractType:m.targetField.includes("date")?"date":"time",description:m.description}}]})):(console.log(`üïê DATETIME DIRECT: Adding direct mapping "${W}" ‚Üí "${m.targetField}"`),F.push({sourceField:W,targetField:m.targetField}))}),console.log("üïê Smart datetime mappings applied:",F.filter(m=>{var z;return(z=m.transformations)==null?void 0:z.some(W=>W.type.startsWith("datetime_"))}).length)):console.log("‚ö†Ô∏è Low confidence datetime pattern - proceeding with standard auto-mapping"),console.log(`üïê === DATETIME DETECTION COMPLETE - Proceeding with standard field mapping ===
`),I.forEach(m=>{console.log(`
üéØ === DEBUGGING TARGET FIELD: ${m.id} (display: "${m.name}") ===`),K(m.id)&&console.log(`üîÑ Target field ${m.id} already mapped - checking for dual mapping opportunity`),console.log("üîç Available source columns for matching:",n),console.log(`üîç Attempting to map target field: ${m.id} (display: ${m.name})`),console.log(`üîç STEP 1: Trying exact match with display name "${m.name}"`);const z=n.find(se=>se.toLowerCase()===m.name.toLowerCase());if(console.log("üîç Exact match result:",z?`FOUND: "${z}"`:"NOT FOUND"),z){F.find(Q=>Q.sourceField===z&&Q.targetField===m.id)?console.log(`üîÑ Dual mapping already exists: "${z}" ‚Üí ${m.id}`):(console.log(`‚úÖ EXACT MATCH SUCCESS: "${z}" ‚Üí ${m.id}`),F.push({sourceField:z,targetField:m.id})),console.log(`üéØ === COMPLETED TARGET FIELD: ${m.id} (exact match) ===
`);return}console.log("üîç STEP 2: Trying normalized match with display name");const W=G(m.name);console.log(`üîç Normalized target name: "${m.name}" ‚Üí "${W}"`);const Z=n.find(se=>{const Q=G(se);return console.log(`üîç   Testing source "${se}" ‚Üí "${Q}" against "${W}"`),Q===W});if(console.log("üîç Normalized match result:",Z?`FOUND: "${Z}"`:"NOT FOUND"),Z){F.find(Q=>Q.sourceField===Z&&Q.targetField===m.id)?console.log(`üîÑ Dual mapping already exists: "${Z}" ‚Üí ${m.id}`):(console.log(`‚úÖ NORMALIZED MATCH SUCCESS: "${Z}" ‚Üí ${m.id}`),F.push({sourceField:Z,targetField:m.id})),console.log(`üéØ === COMPLETED TARGET FIELD: ${m.id} (normalized match) ===
`);return}console.log("üîç STEP 3: Trying normalized match with field ID");const ae=G(m.id);console.log(`üîç Normalized field ID: "${m.id}" ‚Üí "${ae}"`);const re=n.find(se=>{const Q=G(se);return console.log(`üîç   Testing source "${se}" ‚Üí "${Q}" against "${ae}"`),Q===ae});if(console.log("üîç Field ID match result:",re?`FOUND: "${re}"`:"NOT FOUND"),re){F.find(Q=>Q.sourceField===re&&Q.targetField===m.id)?console.log(`üîÑ Dual mapping already exists: "${re}" ‚Üí ${m.id}`):(console.log(`‚úÖ FIELD ID MATCH SUCCESS: "${re}" ‚Üí ${m.id}`),F.push({sourceField:re,targetField:m.id})),console.log(`üéØ === COMPLETED TARGET FIELD: ${m.id} (field ID match) ===
`);return}console.log("üîç STEP 4: Trying field variation matching");const je=Dn(m.id);console.log(`üîç Field variations for ${m.id}:`,je);let ee;for(const se of je)if(console.log(`üîç   Testing variation: "${se}"`),ee=n.find(Q=>{const me=G(Q),ge=G(se);return console.log(`üîç     Source "${Q}" ‚Üí "${me}" vs variation "${ge}"`),me===ge}),ee){console.log(`üîç   VARIATION MATCH FOUND: "${ee}" via variation "${se}"`),F.find(me=>me.sourceField===ee&&me.targetField===m.id)?console.log(`üîÑ Dual mapping already exists: "${ee}" ‚Üí ${m.id}`):(console.log(`‚úÖ FIELD VARIATION SUCCESS: "${ee}" ‚Üí ${m.id} (via variation "${se}")`),F.push({sourceField:ee,targetField:m.id})),console.log(`üéØ === COMPLETED TARGET FIELD: ${m.id} (variation match) ===
`);return}console.log(`üîç No variation matches found for ${m.id}`),console.log(`‚ùå NO MATCH FOUND for target field: ${m.id}`),console.log(`üéØ === COMPLETED TARGET FIELD: ${m.id} (no match) ===
`);const Te=n.map(G).findIndex(se=>se.includes(W)||W.includes(se));if(Te>=0){console.log(`‚úÖ Partial match found: "${n[Te]}" ‚Üí ${m.id}`),F.push({sourceField:n[Te],targetField:m.id});return}if((m.id==="city"||m.id==="state")&&!K(m.id)){const se=n.find(Q=>G(Q).includes("address")||G(Q).includes("location")||G(Q).includes("addr"));if(se&&r&&r.length>0){const Q=r[0][se];if(typeof Q=="string"&&Q.trim()){const me=Cn(Q);if(m.id==="city"&&me.city){console.log(`üè† Smart address parsing: Extracting city "${me.city}" from "${se}"`),F.push({sourceField:se,targetField:m.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Za-z\\s]+)\\s+[A-Z]{2}\\s*$",description:"Extract city from full address"}}]});return}if(m.id==="state"&&me.state){console.log(`üè† Smart address parsing: Extracting state "${me.state}" from "${se}"`),F.push({sourceField:se,targetField:m.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Z]{2})\\s*$",description:"Extract state from full address"}}]});return}}}}if(m.id==="longitude"||m.id==="latitude")if(console.log(`üåç COORDINATE PARSING DEBUG: Evaluating ${m.id} field`),console.log("üåç COORDINATE PARSING DEBUG: Field already mapped?",K(m.id)),console.log("üåç COORDINATE PARSING DEBUG: Current mappings:",F.filter(se=>se.targetField===m.id)),K(m.id))console.log(`üåç COORDINATE PARSING DEBUG: ${m.id} field already mapped - skipping coordinate parsing`);else{console.log(`üåç COORDINATE PARSING DEBUG: Checking ${m.id} field for coordinate opportunities`),console.log("üåç COORDINATE PARSING DEBUG: Available source columns:",n),console.log("üåç COORDINATE PARSING DEBUG: Sample data available:",!!r&&r.length>0);const se=n.find(Q=>G(Q).includes("geom")||G(Q).includes("geometry")||G(Q).includes("point")||G(Q).includes("coordinates")||G(Q).includes("coord")||G(Q).includes("location"));if(console.log("üåç COORDINATE PARSING DEBUG: Found coordinate field match:",se),se&&r&&r.length>0){const Q=r[0][se];if(console.log("üåç COORDINATE PARSING DEBUG: Sample coordinate value:",Q),console.log("üåç COORDINATE PARSING DEBUG: Sample coordinate type:",typeof Q),typeof Q=="string"&&Q.trim()){console.log("üåç COORDINATE PARSING DEBUG: Attempting to parse POINT coordinates from:",Q.trim());const me=Fn(Q);if(console.log("üåç COORDINATE PARSING DEBUG: Parsed result:",me),m.id==="longitude"&&me.longitude!==null){console.log(`üåç Smart coordinate parsing: Extracting longitude "${me.longitude}" from "${se}"`),F.push({sourceField:se,targetField:m.id,transformations:[{type:"parseCoordinates",params:{format:"point",component:"longitude",description:"Extract longitude from POINT coordinate data"}}]}),console.log(`üåç SUCCESS: Added longitude mapping for ${se} ‚Üí ${m.id}`);return}if(m.id==="latitude"&&me.latitude!==null){console.log(`üåç Smart coordinate parsing: Extracting latitude "${me.latitude}" from "${se}"`),F.push({sourceField:se,targetField:m.id,transformations:[{type:"parseCoordinates",params:{format:"point",component:"latitude",description:"Extract latitude from POINT coordinate data"}}]}),console.log(`üåç SUCCESS: Added latitude mapping for ${se} ‚Üí ${m.id}`);return}console.log(`üåç COORDINATE PARSING DEBUG: No valid coordinates extracted for ${m.id}`)}else console.log("üåç COORDINATE PARSING DEBUG: Sample coordinate is not a valid string:",Q)}else console.log("üåç COORDINATE PARSING DEBUG: No coordinate match or sample data unavailable")}console.log(`‚ùå No match found for target field: ${m.id}`)}),console.log("üîß AUTO-MAPPING - Final mappings:",F.map(m=>({source:m.sourceField,target:m.targetField})));const b=Kt(F,i);if(b.isConsistent||console.warn("‚ö†Ô∏è AUTO-MAPPING - Consistency issues detected:",b.issues),t(Ne(F)),F.length>=3&&(s!=null&&s.id)&&(console.log("üîß AUTO-SAVING TEMPLATE: Significant mappings detected"),y(F,s.id),T()),s!=null&&s.id){const m=w(F,s.id);x(m.slice(0,3)),console.log("üîß TEMPLATE SUGGESTIONS:",m.length,"similar templates found")}}finally{C(!1)}}},g=async()=>{try{await c(),d(!1)}catch(v){console.error("Failed to save template:",v)}},U=()=>{t(Le(0))},O=()=>{try{t(Me("transforming")),console.log("üîß TRANSFORMATION DEBUG: Using Redux mappings directly for transformation"),console.log("Redux mappings:",a),console.log("currentTemplate.mappings:",l.mappings),console.log("Sample data:",r),console.log("üîç PRE-TRANSFORMATION DEBUG:"),console.log("  Sample data keys:",r.length>0?Object.keys(r[0]):[]),console.log("  Sample data first row:",r[0]),console.log("  Mappings to apply:",a),console.log("  Mappings breakdown:"),a.forEach((F,K)=>{var I;const G=(I=r[0])==null?void 0:I[F.sourceField];console.log(`    ${K+1}. "${F.sourceField}" ‚Üí "${F.targetField}" | Sample: "${G}"`)});const v=hs(r,a);console.log("‚úÖ Transformed data with latest mappings:",v),console.log("üîç POST-TRANSFORMATION DEBUG:"),v.length>0&&(console.log("  Transformed data keys:",Object.keys(v[0])),console.log("  Transformed data first row:",v[0]),console.log("  Specific field checks:"),console.log(`    incident_time: "${v[0].incident_time}"`),console.log(`    incident_date: "${v[0].incident_date}"`),console.log(`    incident_id: "${v[0].incident_id}"`)),t($s(v)),t(Me("mapping")),t(Le(2))}catch(v){console.error("Error transforming data:",v),t(Me("error")),_({message:`Error transforming data: ${v instanceof Error?v.message:"Unknown error"}`,severity:"error",open:!0})}},B=N.useMemo(()=>{if(console.log("Checking if can proceed with validationErrors:",$),console.log("Current mappings:",a),i){const v=i.requiredFields.filter(F=>!a.some(K=>K.targetField===F.id));return console.log("Unmapped required fields:",v),v.length===0}return $.every(v=>v.severity!=="error")},[$,a,i]),D=v=>{var I;v.preventDefault();const F=v.dataTransfer.getData("text/plain");if(!F){_({message:"Drag and drop error: No source field data found",severity:"error",open:!0});return}const G=(I=v.target.closest("[data-target-field]"))==null?void 0:I.getAttribute("data-target-field");if(!G){_({message:"Drag and drop error: No target field found. Try dropping directly on a target field.",severity:"warning",open:!0});return}ie({sourceField:F,targetField:G}),_({message:`Mapped ${F} to ${G}`,severity:"success",open:!0})};return n.length?i?o==="uploading"?e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(Ve,{}),e.jsx(f,{sx:{mt:2},children:"Processing file data..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(f,{variant:"h5",children:["Map Fields for ",i.name]}),e.jsxs(st,{direction:"row",spacing:1,children:[e.jsx(oe,{variant:"outlined",size:"small",startIcon:e.jsx(rs,{}),onClick:g,disabled:!u,children:"Save Template"}),e.jsx(Sn,{currentTemplate:l,setCurrentTemplate:v=>{p(v),v.mappings&&v.mappings.length>0&&(t(Ne(v.mappings)),_({message:`Applied template "${v.name}" with ${v.mappings.length} field mappings`,severity:"success",open:!0}))},setTemplateDirty:d,disabled:!s||n.length===0,currentMappings:a,sourceFields:n,sampleData:r,targetTool:(s==null?void 0:s.id)||"",onApplyFieldMappings:v=>{t(Ne(v)),_({message:`Applied template with ${v.length} field mappings`,severity:"success",open:!0})}})]})]}),h.length>0&&e.jsxs(ce,{severity:"info",sx:{mb:2},children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"üí° Smart Template Suggestions"}),e.jsxs(f,{variant:"body2",sx:{mb:1},children:["Found ",h.length," template",h.length!==1?"s":""," with similar field patterns:"]}),e.jsx(j,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:h.map(v=>e.jsxs(oe,{variant:"outlined",size:"small",onClick:()=>{p(v),t(Ne(v.mappings)),d(!1),x([]),_({message:`Applied suggested template "${v.name}"`,severity:"success",open:!0})},sx:{textTransform:"none"},children:[v.name,e.jsxs(f,{component:"span",variant:"caption",sx:{ml:1,opacity:.7},children:["(",v.mappings.length," mappings)"]})]},v.id))})]}),k.total>0&&e.jsx(ce,{severity:"success",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:["üìÅ You have ",k.total," saved template",k.total!==1?"s":"","(",k.totalMappings," total field mappings).",k.byTool[(s==null?void 0:s.id)||""]&&e.jsxs("strong",{children:[k.byTool[(s==null?void 0:s.id)||""]," template",k.byTool[(s==null?void 0:s.id)||""]!==1?"s":""," for ",s==null?void 0:s.name]})]})}),e.jsxs(j,{sx:{display:"flex",gap:2,height:"700px",minHeight:"700px",border:"1px solid #eaeaea",borderRadius:"4px",padding:"4px"},children:[e.jsxs(j,{sx:{width:"35%",height:"100%",display:"flex",flexDirection:"column",position:"relative",borderRight:"1px solid #eaeaea",paddingRight:"8px"},children:[e.jsx(f,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Source Fields Panel ‚ÜïÔ∏è (Scrollable)"}),e.jsx(an,{sourceColumns:n,filter:q,setFilter:V,mappings:a,sampleData:r,onAddParsedFields:(v,F)=>{if(console.log("ü§ñ PARENT: Received parsed fields for column:",v,F),r&&r.length>0&&F.length>0){const K=r.map((G,I)=>{const M={...G};return F.forEach(b=>{if(b.data[I]!==null){const m=b.id.split("_").slice(1).join("_"),z=`${v}_parsed_${m}`;M[z]=b.data[I],console.log(`ü§ñ PARENT: Injecting parsed data: ${z} = "${b.data[I]}"`)}}),M});console.log("ü§ñ PARENT: Updating Redux sampleData with parsed fields"),t(ss(K)),_({message:`Added ${F.length} parsed fields for ${v}`,severity:"success",open:!0})}}})]}),e.jsxs(j,{sx:{width:"65%",height:"100%",display:"flex",flexDirection:"column",gap:2,overflow:"hidden",position:"relative"},onDragOver:v=>{v.target===v.currentTarget&&(v.preventDefault(),console.log("Parent container dragOver"))},onDrop:v=>{v.target===v.currentTarget&&(v.preventDefault(),D(v),console.log("Parent container drop"))},children:[e.jsx(f,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Target Fields Panel ‚ÜïÔ∏è (Scrollable)"}),e.jsx(gn,{toolConfig:i,showAllFields:X,setShowAllFields:J,filter:E,setFilter:H,mappings:a,onMappingChange:ie,onRemoveMapping:R,validationErrors:$,sampleData:r,sourceColumns:n}),$.length>0&&e.jsx(j,{sx:{flexShrink:0,marginTop:"auto",borderTop:"1px solid #eaeaea",paddingTop:"8px"},children:e.jsx(fn,{validationErrors:$,jumpToField:v=>{const F=document.getElementById(`target-field-${v}`);F&&(F.scrollIntoView({behavior:"smooth",block:"center"}),F.classList.add("highlight-field"),setTimeout(()=>{F.classList.remove("highlight-field")},2e3))}})})]})]}),e.jsx(fe,{sx:{p:2,mt:2},children:e.jsx(xn,{sampleData:r,mappings:a,toolConfig:i})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(oe,{variant:"outlined",startIcon:e.jsx(tt,{}),onClick:U,children:"Back"}),e.jsxs(j,{children:[e.jsx(oe,{variant:"outlined",onClick:te,disabled:S||!n.length,sx:{mr:1},children:S?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{size:20,sx:{mr:1}}),"Auto-mapping..."]}):"Auto-Map Fields"}),e.jsx(oe,{variant:"contained",endIcon:e.jsx(Nt,{}),onClick:O,disabled:!B,children:"Continue"})]})]}),e.jsx(ms,{open:Y.open,autoHideDuration:6e3,onClose:()=>_({...Y,open:!1}),children:e.jsx(ce,{onClose:()=>_({...Y,open:!1}),severity:Y.severity,children:Y.message})})]}):e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(ce,{severity:"error",children:"No tool selected. Please select a tool first."}),e.jsx(oe,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(tt,{}),onClick:U,children:"Go Back to Upload"})]}):e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(ce,{severity:"error",children:"No source columns available. Please upload a file first."}),e.jsx(oe,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(tt,{}),onClick:U,children:"Go Back to Upload"})]})},In=({data:t,validationErrors:n,highlightedCell:r})=>{const[s,a]=N.useState(0),[o,l]=N.useState(10),[p,u]=N.useState(""),[d,h]=N.useState("");N.useEffect(()=>{if(r){const E=Math.floor(r.rowIndex/o);E!==s&&a(E)}},[r,o,s]);const x=t.length>0?Object.keys(t[0]):[],S={};n.forEach(E=>{E.rowIndex!==void 0&&(S[E.rowIndex]||(S[E.rowIndex]={}),S[E.rowIndex][E.field]||(S[E.rowIndex][E.field]=[]),S[E.rowIndex][E.field].push(E))});const C=(E,H)=>{a(H)},$=E=>{l(parseInt(E.target.value,10)),a(0)},A=E=>{u(E.target.value),a(0)},Y=E=>{h(E.target.value),a(0)},_=()=>{h(""),a(0)},q=t.filter(E=>{if(!d)return!0;if(p){const H=E[p];return H!==void 0&&String(H).toLowerCase().includes(d.toLowerCase())}return Object.values(E).some(H=>H!==void 0&&String(H).toLowerCase().includes(d.toLowerCase()))}),V=q.slice(s*o,s*o+o);return t.length===0?e.jsx(j,{children:e.jsx(f,{variant:"h6",gutterBottom:!0,children:"No data available for preview"})}):e.jsxs(j,{children:[e.jsx(Rs,{styles:{"@keyframes pulse":{"0%":{opacity:.7},"100%":{opacity:1}}}}),e.jsxs(j,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(be,{label:"Search",value:d,onChange:Y,sx:{flexGrow:1},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(rt,{})}),endAdornment:d&&e.jsx(Oe,{position:"end",children:e.jsx(Ce,{onClick:_,edge:"end",size:"small",children:e.jsx(It,{})})})}}),e.jsxs(Ae,{sx:{minWidth:200},children:[e.jsx($e,{id:"filter-field-label",children:"Filter Field"}),e.jsxs(Re,{labelId:"filter-field-label",id:"filter-field",value:p,label:"Filter Field",onChange:A,children:[e.jsx(ne,{value:"",children:"All Fields"}),x.map(E=>e.jsx(ne,{value:E,children:E},E))]})]})]}),e.jsxs(fe,{sx:{width:"100%",mb:2},children:[e.jsx(wt,{sx:{maxHeight:500},children:e.jsxs(dt,{stickyHeader:!0,"aria-label":"data preview table",children:[e.jsx(ut,{children:e.jsxs(Pe,{children:[e.jsx(Se,{children:"#"}),x.map(E=>e.jsx(Se,{children:E},E))]})}),e.jsx(pt,{children:V.map((E,H)=>{const X=s*o+H,J=S[X];return e.jsxs(Pe,{hover:!0,sx:{"&:last-child td, &:last-child th":{border:0},backgroundColor:J?"#fff8f8":"inherit"},children:[e.jsx(Se,{children:X+1}),x.map(i=>{const c=(J==null?void 0:J[i])||[],y=c.length>0,w=r&&r.rowIndex===X&&r.field===i;return e.jsxs(Se,{sx:{backgroundColor:w?"#fff3e0":y?"#ffebee":"inherit",position:"relative",border:w?"2px solid #ff9800":"inherit",transition:"all 0.3s ease"},children:[E[i]!==void 0?String(E[i]):"",y&&e.jsx(j,{sx:{position:"absolute",top:0,right:0},children:e.jsx(le,{color:"error",size:"small",label:c.length,sx:{height:16,fontSize:"0.6rem"}})}),w&&e.jsx(j,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid #ff9800",borderRadius:"4px",pointerEvents:"none",animation:"pulse 1s ease-in-out infinite alternate"}})]},i)})]},H)})})]})}),e.jsx(Gs,{rowsPerPageOptions:[5,10,25,50,100],component:"div",count:q.length,rowsPerPage:o,page:s,onPageChange:C,onRowsPerPageChange:$})]})]})};class An{constructor(){it(this,"defaultFields",{})}registerField(n,r){console.log(`Registering default value for ${n}:`,r),this.defaultFields[n]=r}hasDefaultValue(n){return this.defaultFields[n]!==void 0}getDefaultValue(n){return this.defaultFields[n]}registerMappings(n){this.defaultFields={},n.forEach(r=>{if(r.sourceField==="__default__"&&r.transformations){const s=r.transformations.find(a=>a.type==="convert"&&a.params&&a.params.defaultValue!==void 0);s&&s.params.defaultValue!==void 0&&this.registerField(r.targetField,s.params.defaultValue)}}),console.log("Registered default values:",this.defaultFields)}clear(){this.defaultFields={}}}const Xt=new An,_n=(t,n)=>{const r=[];return t.forEach((s,a)=>{n.forEach(o=>{let l=s[o.name];const p=Xt.hasDefaultValue(o.name);if((l==null||l==="")&&p&&(l=Xt.getDefaultValue(o.name),console.log(`Using default value for validation of ${o.name}:`,l)),o.name==="Incident ID"){o.isRequired&&!p&&(l==null||l==="")&&r.push({rowIndex:a,field:o.name,message:`${o.name} is required`,type:"required"});return}if(o.name.includes("Time")&&typeof l=="string"){o.isRequired&&!p&&(l==null||l==="")&&r.push({rowIndex:a,field:o.name,message:`${o.name} is required`,type:"required"});return}if(o.isRequired&&!p&&(l==null||l==="")){r.push({rowIndex:a,field:o.name,message:`${o.name} is required`,type:"required"});return}if(l==null||l==="")return;const u=$n(l,o.dataType,o.name,a);if(u){r.push(u);return}o.validationRules&&o.validationRules.forEach(d=>{const h=Rn(l,d,o.name,a);h&&r.push(h)})})}),console.log("Validation completed with errors:",r),r},$n=(t,n,r,s)=>{switch(n){case"string":if(typeof t!="string")return{rowIndex:s,field:r,message:`${r} must be a string`,type:"custom"};break;case"number":if(typeof t!="number"&&(typeof t!="string"||isNaN(Number(t))))return{rowIndex:s,field:r,message:`${r} must be a number`,type:"custom"};break;case"date":if(!(typeof t=="string"||t instanceof Date))return{rowIndex:s,field:r,message:`${r} must be a date`,type:"custom"};const a=new Date(t);if(isNaN(a.getTime()))return{rowIndex:s,field:r,message:`${r} contains an invalid date format`,type:"custom"};break;case"boolean":if(typeof t!="boolean"&&t!=="true"&&t!=="false"&&t!=="0"&&t!=="1")return{rowIndex:s,field:r,message:`${r} must be a boolean value`,type:"custom"};break;case"location":if(typeof t=="string"){if(!/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(t))return{rowIndex:s,field:r,message:`${r} must be a valid location format (latitude,longitude)`,type:"custom"}}else if(!t.lat||!t.lng)return{rowIndex:s,field:r,message:`${r} must be a valid location object or string`,type:"custom"};break}return null},Rn=(t,n,r,s)=>{switch(n.type){case"required":break;case"min":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)<n.params.value)return{rowIndex:s,field:r,message:`${r} must be at least ${n.params.value}`,type:"min"}}else if(typeof t=="string"&&t.length<n.params.value)return{rowIndex:s,field:r,message:`${r} must be at least ${n.params.value} characters`,type:"min"};break;case"max":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)>n.params.value)return{rowIndex:s,field:r,message:`${r} must be at most ${n.params.value}`,type:"max"}}else if(typeof t=="string"&&t.length>n.params.value)return{rowIndex:s,field:r,message:`${r} must be at most ${n.params.value} characters`,type:"max"};break;case"pattern":if(typeof t=="string"&&!new RegExp(n.params.regex).test(t))return{rowIndex:s,field:r,message:n.params.message||`${r} does not match the required pattern`,type:"pattern"};break;case"oneOf":const a=n.params.values;if(!a.includes(t))return{rowIndex:s,field:r,message:`${r} must be one of: ${a.join(", ")}`,type:"oneOf"};break;case"custom":if(n.params.validateFn&&typeof n.params.validateFn=="function"&&!n.params.validateFn(t))return{rowIndex:s,field:r,message:n.params.message||`${r} is invalid`,type:"custom"};break}return null},On=t=>{const n={total:t.length,byType:{},byField:{}};return t.forEach(r=>{n.byType[r.type]||(n.byType[r.type]=0),n.byType[r.type]++,n.byField[r.field]||(n.byField[r.field]=0),n.byField[r.field]++}),n},Ct=t=>{const{children:n,value:r,index:s,...a}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==s,id:`validation-tabpanel-${s}`,"aria-labelledby":`validation-tab-${s}`,...a,children:r===s&&e.jsx(j,{sx:{p:2},children:n})})},Mn=({errors:t,onJumpToError:n})=>{const[r,s]=N.useState(0),[a,o]=N.useState(""),l=On(t),p=(x,S)=>{s(S)},u=t.filter(x=>x.field.toLowerCase().includes(a.toLowerCase())||x.message.toLowerCase().includes(a.toLowerCase())),d={};u.forEach(x=>{d[x.field]||(d[x.field]=[]),d[x.field].push(x)});const h=x=>{let S="default";switch(x){case"required":S="error";break;case"pattern":case"min":case"max":S="warning";break;case"oneOf":case"custom":S="info";break}return e.jsx(le,{size:"small",label:x,color:S})};return e.jsxs(fe,{sx:{p:0,mb:3},children:[e.jsx(j,{sx:{p:2,bgcolor:t.length>0?"#ffebee":"#e8f5e9",borderRadius:"4px 4px 0 0"},children:e.jsxs(f,{variant:"h6",component:"h3",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ht,{}),"Validation Results",e.jsx(le,{label:`${t.length} ${t.length===1?"error":"errors"}`,color:t.length>0?"error":"success",sx:{ml:2}})]})}),e.jsx(ye,{}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:r,onChange:p,"aria-label":"validation tabs",children:[e.jsx(De,{label:"Summary",id:"validation-tab-0","aria-controls":"validation-tabpanel-0"}),e.jsx(De,{label:"By Field",id:"validation-tab-1","aria-controls":"validation-tabpanel-1"}),e.jsx(De,{label:"All Errors",id:"validation-tab-2","aria-controls":"validation-tabpanel-2"})]})}),e.jsx(Ct,{value:r,index:0,children:t.length===0?e.jsx(ce,{severity:"success",children:"No validation errors found. Your data is ready for export!"}):e.jsxs(e.Fragment,{children:[e.jsxs(ce,{severity:"warning",children:["Found ",t.length," validation ",t.length===1?"error":"errors"," that need to be addressed before export."]}),e.jsxs(j,{sx:{mt:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Error Distribution by Field"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:Object.entries(l.byField).map(([x,S])=>e.jsx(le,{label:`${x}: ${S}`,color:"error",variant:"outlined",onClick:()=>s(1)},x))}),e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Error Types"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:Object.entries(l.byType).map(([x,S])=>e.jsx(le,{label:`${x}: ${S}`,color:"primary",variant:"outlined"},x))})]})]})}),e.jsxs(Ct,{value:r,index:1,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:a,onChange:x=>o(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(rt,{})}),endAdornment:a&&e.jsx(Oe,{position:"end",children:e.jsx(Ce,{onClick:()=>o(""),edge:"end",size:"small",children:e.jsx(It,{})})})}}),Object.keys(d).length===0?e.jsx(ce,{severity:"info",children:"No errors match your search criteria."}):Object.entries(d).map(([x,S])=>e.jsxs(os,{defaultExpanded:Object.keys(d).length===1,children:[e.jsx(as,{expandIcon:e.jsx(xt,{}),children:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[e.jsx(f,{children:x}),e.jsx(le,{size:"small",label:S.length,color:"error",sx:{ml:"auto"}})]})}),e.jsx(is,{children:e.jsx(Ue,{dense:!0,disablePadding:!0,children:S.map((C,$)=>e.jsxs(Je.Fragment,{children:[$>0&&e.jsx(ye,{component:"li"}),e.jsx(Ee,{secondaryAction:C.rowIndex!==void 0&&n&&e.jsx(oe,{size:"small",variant:"outlined",onClick:()=>C.rowIndex!==void 0&&n(C.rowIndex,C.field),children:"Jump to Row"}),children:e.jsx(Fe,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[C.message,h(C.type)]}),secondary:C.rowIndex!==void 0?`Row ${C.rowIndex+1}`:"Global error"})})]},$))})})]},x))]}),e.jsxs(Ct,{value:r,index:2,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:a,onChange:x=>o(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(rt,{})}),endAdornment:a&&e.jsx(Oe,{position:"end",children:e.jsx(Ce,{onClick:()=>o(""),edge:"end",size:"small",children:e.jsx(It,{})})})}}),e.jsx(Ue,{dense:!0,children:u.length===0?e.jsx(ce,{severity:"info",children:"No errors match your search criteria."}):u.map((x,S)=>e.jsxs(Je.Fragment,{children:[S>0&&e.jsx(ye,{component:"li"}),e.jsx(Ee,{secondaryAction:x.rowIndex!==void 0&&n&&e.jsx(oe,{size:"small",variant:"outlined",onClick:()=>x.rowIndex!==void 0&&n(x.rowIndex,x.field),children:"Jump to Row"}),children:e.jsx(Fe,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(f,{component:"span",sx:{fontWeight:500},children:[x.field,":"]}),x.message,h(x.type)]}),secondary:x.rowIndex!==void 0?`Row ${x.rowIndex+1}`:"Global error"})})]},S))})]})]})},Nn=t=>{switch(t){case"string":return"Default Value";case"number":return"0";case"date":return new Date().toISOString().split("T")[0];case"boolean":return"false";case"location":return"0.0,0.0";default:return""}},Pn=({errors:t,targetFields:n,mappings:r,onAddDefaultValue:s,onJumpToMapping:a})=>{const o=Mt(),[l,p]=N.useState(!1),[u,d]=N.useState(null),[h,x]=N.useState(""),S=N.useMemo(()=>{const _={};return t.forEach(q=>{_[q.field]||(_[q.field]={errors:[],count:0}),_[q.field].errors.push(q),_[q.field].count++}),_},[t]),C=N.useMemo(()=>Object.entries(S).sort((_,q)=>q[1].count-_[1].count).map(([_,q])=>{const V=n.find(i=>i.name===_);if(!V)return null;const E=r.some(i=>i.targetField===_),H=r.some(i=>i.targetField===_&&i.sourceField==="__default__"),X=q.errors.some(i=>i.type==="required");let J="unknown";return X&&!E?J="map_field":X&&!H?J="add_default":!X&&E&&(J="fix_transformation"),{fieldName:_,fieldDef:V,errorCount:q.count,errors:q.errors,hasMapping:E,hasDefaultMapping:H,actionType:J}}).filter(Boolean),[S,n,r]),$=N.useMemo(()=>C.filter(_=>(_==null?void 0:_.actionType)==="add_default").length,[C]),A=_=>{d(_),x(Nn(_.dataType)),p(!0)},Y=()=>{if(!u)return;const _={sourceField:"__default__",targetField:u.name,transformations:[{type:"convert",params:{defaultValue:h,targetType:u.dataType}}]};s(_),p(!1)};return t.length===0?e.jsx(ce,{severity:"success",sx:{my:2},children:"No validation errors detected. Your data is ready for export!"}):e.jsxs(fe,{sx:{p:0,my:2,borderRadius:1,border:`1px solid ${o.palette.divider}`,overflow:"hidden"},elevation:2,children:[e.jsxs(j,{sx:{p:2,bgcolor:o.palette.mode==="dark"?he(o.palette.error.dark,.2):he(o.palette.error.light,.1),borderBottom:`1px solid ${o.palette.divider}`},children:[e.jsxs(f,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ht,{color:"error"}),"Validation Solutions",e.jsx(le,{label:`${t.length} ${t.length===1?"issue":"issues"}`,color:"error",size:"small",sx:{ml:1}})]}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:$>0?`${$} ${$===1?"issue":"issues"} can be fixed with default values.`:"Review the suggested actions to resolve validation issues."})]}),e.jsxs(Ue,{sx:{py:0},children:[$>0&&e.jsxs(Ee,{sx:{bgcolor:he(o.palette.success.light,.1),borderBottom:`1px solid ${o.palette.divider}`,"&:hover":{bgcolor:he(o.palette.success.light,.2)}},children:[e.jsx(ke,{children:e.jsx(ot,{color:"success"})}),e.jsx(Fe,{primary:"Fix Required Fields with Default Values",secondary:`Add default values to ${$} unmapped required ${$===1?"field":"fields"}`}),e.jsx(At,{children:e.jsx(oe,{variant:"outlined",color:"success",size:"small",onClick:()=>{const _=C.find(q=>(q==null?void 0:q.actionType)==="add_default");_!=null&&_.fieldDef&&A(_.fieldDef)},children:"Set Default Values"})})]}),C.map((_,q)=>{var X;if(!_)return null;let V=e.jsx(ht,{color:"error"}),E="error",H="";switch(_.actionType){case"map_field":V=e.jsx(Xr,{color:"info"}),E="info",H="Field requires mapping to source data";break;case"add_default":V=e.jsx(Ht,{color:"success"}),E="success",H="Field requires a value, add a default";break;case"fix_transformation":V=e.jsx(cs,{color:"warning"}),E="warning",H="Field has validation issues with current mapping";break}return e.jsxs(Je.Fragment,{children:[q>0&&e.jsx(ye,{}),e.jsxs(Ee,{sx:{py:1.5,"&:hover":{bgcolor:he(o.palette.primary.light,.05)}},children:[e.jsx(ke,{children:V}),e.jsx(Fe,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(f,{variant:"subtitle2",children:_.fieldName}),e.jsx(le,{size:"small",label:`${_.errorCount} ${_.errorCount===1?"error":"errors"}`,color:"error",variant:"outlined"}),_.fieldDef&&e.jsx(le,{size:"small",label:_.fieldDef.dataType,color:"default",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:H}),e.jsxs(f,{variant:"caption",color:"error",sx:{display:"block",mt:.5},children:[(X=_.errors[0])==null?void 0:X.message,_.errors.length>1&&` (+ ${_.errors.length-1} more)`]})]})}),e.jsxs(At,{children:[_.actionType==="add_default"&&_.fieldDef&&e.jsx(oe,{variant:"outlined",color:E,size:"small",startIcon:e.jsx(Ht,{}),onClick:()=>A(_.fieldDef),children:"Add Default"}),(_.actionType==="map_field"||_.actionType==="fix_transformation")&&e.jsx(oe,{variant:"outlined",color:E,size:"small",startIcon:e.jsx(Bs,{}),onClick:()=>a(_.fieldName),children:_.actionType==="map_field"?"Map Field":"Fix Mapping"})]})]})]},_.fieldName)})]}),e.jsxs(Ke,{open:l,onClose:()=>p(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Xe,{children:["Set Default Value for ",u==null?void 0:u.name]}),e.jsx(Ze,{children:e.jsxs(j,{sx:{mt:1},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:u==null?void 0:u.description}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(f,{variant:"caption",children:"Data Type:"}),e.jsx(le,{size:"small",label:u==null?void 0:u.dataType,color:"primary",variant:"outlined"})]}),(u==null?void 0:u.dataType)==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:h,onChange:_=>x(_.target.value),label:"Default Value",variant:"outlined",margin:"normal",children:[e.jsx(ne,{value:"true",children:"True"}),e.jsx(ne,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:h,onChange:_=>x(_.target.value),label:"Default Value",variant:"outlined",margin:"normal",type:(u==null?void 0:u.dataType)==="number"?"number":"text",helperText:`This value will be used for all records where ${u==null?void 0:u.name} is not mapped or empty`})]})}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:()=>p(!1),children:"Cancel"}),e.jsx(oe,{onClick:Y,variant:"contained",color:"primary",startIcon:e.jsx(ot,{}),children:"Apply Default Value"})]})]})]})},Zt=t=>{const{children:n,value:r,index:s,...a}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==s,id:`preview-tabpanel-${s}`,"aria-labelledby":`preview-tab-${s}`,...a,children:r===s&&e.jsx(j,{sx:{p:2},children:n})})},kn=()=>{const t=at(),{sourceFile:n,transformedData:r,validationErrors:s,selectedTool:a,mappings:o}=Be(E=>E.formatter),[l,p]=N.useState(0),[u,d]=N.useState(!1),[h,x]=N.useState(null),S=N.useRef(null),C=(E,H)=>{p(H)},$=()=>{t(Le(1))},A=()=>{t(Le(3))},Y=()=>{if(!(!r||!a)){d(!0);try{const E=[...a.requiredFields,...a.optionalFields],H=Be(c=>c.formatter.mappings),X={};H&&H.forEach(c=>{if(c.sourceField==="__default__"&&c.transformations){const y=c.transformations.find(w=>w.type==="convert"&&w.params&&w.params.defaultValue!==void 0);y&&(X[c.targetField]=!0,console.log(`Field ${c.targetField} has default value: ${y.params.defaultValue}`))}});const J=r.map(c=>{const y={...c};return Object.keys(X).forEach(w=>{typeof window<"u"&&window.defaultValueRegistry&&window.defaultValueRegistry.register(w,!0)}),y}),i=_n(J,E);t(Os(i)),i.length===0?t(Me("complete")):t(Me("error"))}catch(E){console.error("Validation error:",E),t(Me("error"))}finally{d(!1)}}},_=(E,H)=>{p(0),x({rowIndex:E,field:H}),setTimeout(()=>{S.current&&S.current.scrollIntoView({behavior:"smooth"})},100),setTimeout(()=>{x(null)},3e3)},q=E=>{console.log("Adding default value mapping:",E),t(Ms(E)),setTimeout(()=>{Y()},100)},V=E=>{t(Le(1))};return N.useEffect(()=>{r&&r.length>0&&Y()},[r]),!r||r.length===0?e.jsxs(fe,{sx:{p:3,textAlign:"center"},children:[e.jsxs(ce,{severity:"warning",sx:{mb:2},children:[e.jsx(dr,{children:"No Data Available"}),"There is no transformed data to preview. Please go back to the field mapping step."]}),e.jsx(oe,{variant:"contained",startIcon:e.jsx(Wt,{}),onClick:$,children:"Back to Field Mapping"})]}):e.jsxs(j,{children:[e.jsx(f,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Preview & Validate Data"}),e.jsx(fe,{sx:{p:2,mb:3},children:e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(f,{variant:"body1",children:[(n==null?void 0:n.name)||"No file"," (",n==null?void 0:n.type,")"]})]})}),e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(f,{variant:"body1",children:[r.length," records processed"]})]})}),e.jsx(pe,{size:12,children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:u?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{size:20}),e.jsx(f,{children:"Validating data..."})]}):s.length===0?e.jsxs(e.Fragment,{children:[e.jsx(fs,{color:"success"}),e.jsx(f,{color:"success.main",children:"Data validation passed! Ready for export."})]}):e.jsxs(e.Fragment,{children:[e.jsx(tn,{color:"error"}),e.jsxs(f,{color:"error",children:[s.length," validation ",s.length===1?"error":"errors"," found"]})]})})]})})]})}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:l,onChange:C,"aria-label":"preview and validation tabs",children:[e.jsx(De,{label:"Data Preview",id:"preview-tab-0","aria-controls":"preview-tabpanel-0"}),e.jsx(De,{label:`Validation & Solutions ${s.length>0?`(${s.length})`:""}`,id:"preview-tab-1","aria-controls":"preview-tabpanel-1",sx:{color:s.length>0?"error.main":"inherit"}})]})}),e.jsx(Zt,{value:l,index:0,children:e.jsx(j,{ref:S,children:e.jsx(In,{data:r,validationErrors:s,highlightedCell:h})})}),e.jsxs(Zt,{value:l,index:1,children:[s.length>0&&a&&e.jsx(Pn,{errors:s,targetFields:[...a.requiredFields,...a.optionalFields],mappings:o,onAddDefaultValue:q,onJumpToMapping:V}),e.jsx(Mn,{errors:s,onJumpToError:_})]}),e.jsx(ye,{sx:{my:3}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(oe,{variant:"outlined",startIcon:e.jsx(Wt,{}),onClick:$,children:"Back to Field Mapping"}),e.jsx(oe,{variant:"contained",endIcon:e.jsx(Nt,{}),onClick:A,disabled:s.length>0,children:"Continue to Export"})]})]})},Ln=({selectedFormat:t,onFormatChange:n})=>{const r=s=>{n(s.target.value)};return e.jsx(bt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(jt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Select Export Format"}),e.jsx(Ae,{component:"fieldset",children:e.jsxs(Xs,{"aria-label":"export-format",name:"export-format",value:t,onChange:r,children:[e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="csv"?"primary.main":"divider",borderRadius:1,bgcolor:t==="csv"?"action.hover":"transparent"},children:[e.jsx(We,{value:"csv",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",flexWrap:"wrap",gap:1},children:[e.jsx(Ks,{color:"primary"}),e.jsx(f,{variant:"body1",children:"CSV"}),e.jsx(le,{size:"small",label:"Most Compatible",color:"success"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Comma-separated values format, widely supported by spreadsheet applications like Excel and Google Sheets."})]}),e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="json"?"primary.main":"divider",borderRadius:1,bgcolor:t==="json"?"action.hover":"transparent"},children:[e.jsx(We,{value:"json",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Jr,{color:"info"}),e.jsx(f,{variant:"body1",children:"JSON"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"JavaScript Object Notation, ideal for programmatic use or importing into other applications."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="excel"?"primary.main":"divider",borderRadius:1,bgcolor:t==="excel"?"action.hover":"transparent"},children:[e.jsx(We,{value:"excel",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(mt,{color:"success"}),e.jsx(f,{variant:"body1",children:"Excel"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Export directly to native Excel format (.xlsx) with proper formatting and column sizing."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="pdf"?"primary.main":"divider",borderRadius:1,bgcolor:t==="pdf"?"action.hover":"transparent"},children:[e.jsx(We,{value:"pdf",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ns,{color:"error"}),e.jsx(f,{variant:"body1",children:"PDF"}),e.jsx(le,{size:"small",label:"Professional",color:"secondary"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Create a professional PDF document with formatted data table, ideal for reports and presentations."})]})]})})]})})},Dt=[{id:"fire-map-pro",name:"Fire Map Pro",description:"Professional mapping and visualization for incident locations and analysis",icon:e.jsx(Zs,{fontSize:"large",sx:{color:"#dc2626"}}),requiredFields:["incidentId","latitude","longitude"],optionalFields:["incidentType","incidentDate","incidentTime","address","city","state","priority","respondingUnit","responseCategory"]},{id:"response-time-analyzer",name:"Response Time Analyzer",description:"Analyze incident response times and visualize performance metrics",icon:e.jsx(Qs,{fontSize:"large",sx:{color:"#2196f3"}}),requiredFields:["incidentId","incidentDate"],optionalFields:["dispatchTime","enRouteTime","arrivalTime","latitude","longitude"]},{id:"water-supply-coverage",name:"Water Supply Coverage Analysis",description:"Comprehensive water supply analysis including tanks, hydrants, and mixed infrastructure",icon:e.jsx(er,{fontSize:"large",sx:{color:"#ff5722"}}),requiredFields:["asset_id","latitude","longitude"],optionalFields:["asset_type","capacity","address","city","state","status"]},{id:"station-coverage-optimizer",name:"Station Coverage Optimizer",description:"Enterprise station placement and coverage analysis with NFPA compliance assessment",icon:e.jsx(tr,{fontSize:"large",sx:{color:"#9c27b0"}}),requiredFields:["station_id","latitude","longitude"],optionalFields:["station_name","station_type","apparatus_count","staffing_level","address","city","state"]}],zn=({selectedTool:t,onToolSelect:n,transformedData:r,onSendToTool:s,isSending:a,preTransformedData:o})=>{console.log("üì°üì°üì° SEND TO TOOL PANEL RENDER - FRESH BUILD JUN 13 2025 16:48 - selectedTool:",t),console.log("üì°üì°üì° SEND TO TOOL PANEL RENDER - onSendToTool function:",!!s),console.log("üì°üì°üì° SEND TO TOOL PANEL RENDER - transformedData length:",r==null?void 0:r.length),console.log("üì°üì°üì° SEND TO TOOL PANEL RENDER - preTransformedData exists:",!!o),console.log("üì°üì°üì° SEND TO TOOL PANEL RENDER - preTransformedData length:",o==null?void 0:o.length),o&&o.length>0&&console.log("üì°üì°üì° SEND TO TOOL PANEL RENDER - preTransformedData sample:",o[0]);const l=d=>{n(d.target.value)},u=t?(d=>{const h=Dt.find(A=>A.id===d);if(!h)return{compatible:!1,missingFields:[]};if(!r||r.length===0)return console.log("‚ùå No transformed data available for compatibility check"),{compatible:!1,missingFields:h.requiredFields,hasOptionalFields:[],missingOptionalFields:h.optionalFields||[]};if(d==="fire-map-pro")if(console.log("üîç FIRE MAP PRO COMPATIBILITY CHECK - ENHANCED FOR ADDRESS PARSING"),console.log("preTransformedData exists:",!!o),console.log("preTransformedData length:",o==null?void 0:o.length),console.log("transformedData sample:",r[0]),o&&o.length>0){const A=Object.keys(r[0]);console.log("üîç Available transformed data fields:",A);const Y=h.optionalFields?h.optionalFields.filter(q=>{const V=A.includes(q);return console.log(`üîç Fire Map Pro optional field ${q}: ${V?"AVAILABLE":"NOT AVAILABLE"}`),V}):[],_=h.optionalFields?h.optionalFields.filter(q=>!A.includes(q)):[];return console.log("‚úÖ Fire Map Pro data is compatible - features exist"),console.log("üìä Available optional fields:",Y),console.log("üìã Missing optional fields:",_),{compatible:!0,missingFields:[],hasOptionalFields:Y,missingOptionalFields:_}}else return console.log("‚ùå Fire Map Pro data not compatible - no features"),{compatible:!1,missingFields:["incidentId","latitude","longitude"],hasOptionalFields:[],missingOptionalFields:h.optionalFields||[]};if(d==="response-time-analyzer"){console.log("üîç RESPONSE TIME ANALYZER COMPATIBILITY CHECK - FLEXIBLE FIELD MATCHING");const A=Object.keys(r[0]||{});console.log("üîç Available data fields:",A),console.log("üîç Required fields (camelCase):",h.requiredFields);const Y=h.requiredFields.filter(V=>{if(A.includes(V))return console.log(`‚úÖ Found exact match for ${V}`),!1;const E=V.replace(/[A-Z]/g,H=>`_${H.toLowerCase()}`);return A.includes(E)?(console.log(`‚úÖ Found snake_case match for ${V} -> ${E}`),!1):(console.log(`‚ùå No match found for ${V} (tried ${V} and ${E})`),!0)});console.log("üîç CHECKING OPTIONAL FIELDS:"),console.log("üîç Tool optional fields:",h.optionalFields);const _=h.optionalFields?h.optionalFields.filter(V=>{let E=V.replace(/[A-Z]/g,J=>`_${J.toLowerCase()}`);V==="enRouteTime"&&(E="enroute_time");const H=A.includes(V),X=A.includes(E);return console.log(`üîç Optional field ${V}: camelCase=${H}, snake_case(${E})=${X}`),H||X}):[],q=h.optionalFields?h.optionalFields.filter(V=>{let E=V.replace(/[A-Z]/g,H=>`_${H.toLowerCase()}`);return V==="enRouteTime"&&(E="enroute_time"),!A.includes(V)&&!A.includes(E)}):[];return console.log("üîç OPTIONAL FIELDS RESULT:"),console.log("‚úÖ Has optional fields:",_),console.log("‚ùå Missing optional fields:",q),{compatible:Y.length===0,missingFields:Y,hasOptionalFields:_,missingOptionalFields:q}}const x=Object.keys(r[0]||{});console.log(`üîç ${d.toUpperCase()} COMPATIBILITY CHECK`),console.log("Available fields:",x),console.log("Required fields:",h.requiredFields);const S=h.requiredFields.filter(A=>!x.includes(A)),C=h.optionalFields?h.optionalFields.filter(A=>x.includes(A)):[],$=h.optionalFields?h.optionalFields.filter(A=>!x.includes(A)):[];return{compatible:S.length===0,missingFields:S,hasOptionalFields:C,missingOptionalFields:$}})(t):{compatible:!1,missingFields:[]};return e.jsxs(j,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Send to FireEMS Tool"}),e.jsx(ce,{severity:"info",sx:{mb:3},children:"Send your formatted data directly to another FireEMS tool for analysis and visualization."}),e.jsxs(Ae,{fullWidth:!0,sx:{mb:3},children:[e.jsx($e,{id:"tool-select-label",children:"Select Tool"}),e.jsxs(Re,{labelId:"tool-select-label",id:"tool-select",value:t||"",label:"Select Tool",onChange:l,children:[e.jsx(ne,{value:"",children:e.jsx("em",{children:"Select a tool..."})}),Dt.map(d=>e.jsx(ne,{value:d.id,children:d.name},d.id))]})]}),t&&e.jsx(pe,{container:!0,spacing:3,children:Dt.filter(d=>d.id===t).map(d=>e.jsx(pe,{size:12,children:e.jsxs(bt,{variant:"outlined",children:[e.jsxs(jt,{children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[d.icon,e.jsxs(j,{sx:{ml:2},children:[e.jsx(f,{variant:"h6",children:d.name}),e.jsx(f,{variant:"body2",color:"text.secondary",children:d.description})]})]}),e.jsx(ye,{sx:{mb:2}}),e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Required Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.requiredFields.map((h,x)=>e.jsx(f,{variant:"body2",sx:{backgroundColor:u.missingFields.includes(h)?"error.light":"success.light",color:u.missingFields.includes(h)?"error.contrastText":"success.contrastText",borderRadius:1,px:1,py:.5},children:h},x))}),d.optionalFields&&e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Optional Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.optionalFields.map((h,x)=>{var S,C;return e.jsx(f,{variant:"body2",sx:{backgroundColor:(S=u.hasOptionalFields)!=null&&S.includes(h)?"info.light":"action.disabledBackground",color:(C=u.hasOptionalFields)!=null&&C.includes(h)?"info.contrastText":"text.secondary",borderRadius:1,px:1,py:.5},children:h},x)})})]}),!u.compatible&&e.jsxs(ce,{severity:"warning",icon:e.jsx(Qr,{}),sx:{mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:"Your data is missing required fields for this tool:"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:u.missingFields.map((h,x)=>e.jsx("li",{children:h},x))})]}),u.compatible&&e.jsxs(ce,{severity:"success",sx:{mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:"Your data is compatible with this tool. All required fields are present."}),d.optionalFields&&u.hasOptionalFields&&u.hasOptionalFields.length>0&&e.jsxs(f,{variant:"body2",children:[u.hasOptionalFields.length," of ",d.optionalFields.length," optional fields are available for enhanced analysis."]})]})]}),e.jsx(sr,{children:e.jsx(oe,{type:"button",variant:"contained",color:"primary",fullWidth:!0,disabled:!u.compatible||a,startIcon:a?e.jsx(Ve,{size:20}):e.jsx(ys,{}),onClick:h=>{h.preventDefault(),h.stopPropagation(),console.log("üöÄüöÄüöÄ SEND TO TOOL BUTTON CLICKED - FRESH BUILD JUN 13 2025 16:49 - tool.id:",d.id),console.log("üöÄüöÄüöÄ SEND TO TOOL BUTTON - onSendToTool function:",s),s()},children:a?"Sending...":`Send to ${d.name}`})})]})},d.id))})]})},Vn=({dataCount:t,fields:n,format:r})=>{const s=()=>{let o=15;r==="json"?o=25:r==="excel"?o=30:r==="pdf"&&(o=40);const l=t*n.length*o;let p=0;r==="excel"?p=5120:r==="pdf"&&(p=15360);const u=l+p;return u<1048576?`${Math.round(u/1024)} KB`:`${(u/1048576).toFixed(2)} MB`},a=()=>{switch(r){case"csv":return e.jsx(_t,{color:"primary"});case"json":return e.jsx(xs,{color:"info"});case"excel":return e.jsx(mt,{color:"success"});case"pdf":return e.jsx(ns,{color:"error"});default:return e.jsx(_t,{})}};return e.jsx(bt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(jt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Export Summary"}),e.jsxs(Ue,{disablePadding:!0,children:[e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:a()}),e.jsx(Fe,{primary:"Format",secondary:r.toUpperCase()})]}),e.jsx(ye,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(Fe,{primary:"Records",secondary:`${t} records will be exported`})]}),e.jsx(ye,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(Fe,{primary:"Fields",secondary:`${n.length} fields per record`})]}),e.jsx(ye,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(Fe,{primary:"Estimated Size",secondary:s()})]})]}),e.jsx(f,{variant:"subtitle2",sx:{mt:2},children:"Fields included:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mt:1},children:n.map((o,l)=>e.jsx(le,{label:o,size:"small"},l))})]})})};console.log("üö®üö®üö® EXPORT CONTAINER LOADED - NEW VERSION WITH UPFRONT TRANSFORMATION AT",new Date().toISOString());const Un=t=>!t||t.length===0?t:JSON.parse(JSON.stringify(t)).map(r=>{const s={...r};return["Incident Date"].forEach(l=>{if(s[l]&&typeof s[l]=="string")try{const p=new Date(s[l]);if(isNaN(p.getTime()))s[l].includes(" ")&&(s[l]=s[l].split(" ")[0]);else{const u=(p.getMonth()+1).toString().padStart(2,"0"),d=p.getDate().toString().padStart(2,"0"),h=p.getFullYear();s[l]=`${u}/${d}/${h}`}}catch{s[l].includes(" ")&&(s[l]=s[l].split(" ")[0])}}),["Dispatch Time","En Route Time","Arrival Time","Incident Time"].forEach(l=>{if(s[l]&&typeof s[l]=="string")try{const p=new Date(s[l]);if(isNaN(p.getTime())){if(s[l].includes(" ")){const u=s[l].split(" ");u.length>1&&(s[l]=u[1])}}else{const u=p.getHours().toString().padStart(2,"0"),d=p.getMinutes().toString().padStart(2,"0"),h=p.getSeconds().toString().padStart(2,"0");s[l]=`${u}:${d}:${h}`}}catch{if(s[l].includes(" ")){const u=s[l].split(" ");u.length>1&&(s[l]=u[1])}}}),s}),Qt=t=>{const{children:n,value:r,index:s,...a}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==s,id:`export-tabpanel-${s}`,"aria-labelledby":`export-tab-${s}`,...a,children:r===s&&e.jsx(j,{sx:{p:2},children:n})})},Bn=()=>{const t=at(),{sourceFile:n,transformedData:r,validationErrors:s}=Be(R=>R.formatter),[a,o]=N.useState(0),[l,p]=N.useState("csv"),[u,d]=N.useState(null),[h,x]=N.useState(null),[S,C]=N.useState(!1),[$,A]=N.useState({success:!1,message:"",open:!1}),[Y,_]=N.useState([]),[q,V]=N.useState(!1);N.useEffect(()=>{try{const R=localStorage.getItem("fireEmsExportHistory");R&&_(JSON.parse(R))}catch(R){console.error("Error loading export history:",R)}},[]),N.useEffect(()=>{try{localStorage.setItem("fireEmsExportHistory",JSON.stringify(Y))}catch(R){console.error("Error saving export history:",R)}},[Y]);const E=(R,L)=>{o(L)},H=R=>{p(R)},X=R=>{var L,te;if(console.log("üö®üö®üö® CRITICAL DEBUG: handleToolChange CALLED AT",new Date().toISOString()),console.log("üîß TOOL SELECTION CHANGED - TRANSFORMING DATA UPFRONT:",R),console.log("üîß transformedData exists:",!!r),console.log("üîß transformedData length:",r==null?void 0:r.length),console.log('üîß toolId === "response-time-analyzer":',R==="response-time-analyzer"),d(R),R==="response-time-analyzer"&&r&&r.length>0){console.log("üîß APPLYING RESPONSE TIME ANALYZER TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",r[0]),console.log("Original field names:",Object.keys(r[0]));try{const g=Tt.transformToResponseTimeAnalyzer(r);if(!g.success){console.error("‚ùå Data transformation failed:",g.errors),x(null);return}const U=g.data||[];console.log("‚úÖ UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed data sample (first record):",U[0]),console.log("Transformed field names:",Object.keys(U[0])),console.log("incidentTime value:",(L=U[0])==null?void 0:L.incidentTime),x(U)}catch(g){console.error("‚ùå Error during upfront transformation:",g),x(null)}}else if(R==="fire-map-pro"&&r&&r.length>0){console.log("üîß APPLYING FIRE MAP PRO TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",r[0]),console.log("Original field names:",Object.keys(r[0]));try{const g=Tt.transformToFireMapPro(r);if(!g.success){console.error("‚ùå Fire Map Pro transformation failed:",g.errors),x(null);return}const U=((te=g.data)==null?void 0:te.features)||[];console.log("‚úÖ FIRE MAP PRO UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed features count:",U.length),console.log("Sample feature:",U[0]),x(U)}catch(g){console.error("‚ùå Error during Fire Map Pro upfront transformation:",g),x(null)}}else x(null)},J=(R,L,te,g,U)=>{const O={id:`export-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,timestamp:Date.now(),format:R,recordCount:L,success:te,destination:g,fileName:U};_(B=>[O,...B].slice(0,20))},i=()=>{_([])},c=()=>{const R=new Date;return R.toLocaleDateString()+" "+R.toLocaleTimeString()},y=async()=>{if(!r||r.length===0){A({success:!1,message:"No data to export",open:!0});return}C(!0);try{const R=Un(r);let L=`formatted_data_${Date.now()}`;if(l==="excel"){const D=await ts(()=>import("./xlsx-DkH2s96g.js"),[]),v=D.utils.json_to_sheet(R),F={},K=Object.keys(r[0]);K.forEach(I=>{F[I]=Math.max(10,I.length+2)}),r.forEach(I=>{K.forEach(M=>{const b=String(I[M]||"");F[M]=Math.min(50,Math.max(F[M],b.length+2))})}),v["!cols"]=K.map(I=>({wch:F[I]}));const G=D.utils.book_new();G.Props={Title:"FireEMS Formatted Data",Subject:"Incident Data",Author:"FireEMS Data Formatter",CreatedDate:new Date},D.utils.book_append_sheet(G,v,"Formatted Data"),L=`formatted_data_${Date.now()}.xlsx`,D.writeFile(G,L),J("Excel",R.length,!0,"File Download",L),A({success:!0,message:"Data exported successfully as EXCEL",open:!0}),C(!1);return}if(l==="pdf"){const D=new Js;D.setFontSize(18),D.text("FireEMS Formatted Data",14,22),D.setFontSize(11),D.text(`Export Date: ${c()}`,14,30),D.text(`Records: ${R.length}`,14,36);const v=Object.keys(R[0]);R.length>500&&D.text("Note: Export limited to 500 records for PDF format.",14,42);const F=R.length>500?48:42,K=30,G=10,I=10;D.setFontSize(10),D.setTextColor(0,0,0),D.setFillColor(220,220,220),v.forEach((b,m)=>{D.rect(I+m*K,F,K,G,"FD"),D.text(b,I+m*K+2,F+7)});const M=Math.min(R.length,20);for(let b=0;b<M;b++){const m=F+(b+1)*G;v.forEach((z,W)=>{D.rect(I+W*K,m,K,G,"S");const Z=R[b][z]||"";let ae=String(Z);ae.length>10&&(ae=ae.substring(0,8)+"..."),D.text(ae,I+W*K+2,m+7)})}D.setFontSize(8),D.text(`Generated by FireEMS Tools - ${new Date().toLocaleString()}`,D.internal.pageSize.width/2,D.internal.pageSize.height-10,{align:"center"}),L=`formatted_data_${Date.now()}.pdf`,D.save(L),J("PDF",R.length,!0,"File Download",L),A({success:!0,message:"Data exported successfully as PDF",open:!0}),C(!1);return}let te="",g="";if(l==="csv"){const D=Object.keys(R[0]);te=D.join(",")+`
`,R.forEach(v=>{const F=D.map(K=>{const G=v[K];return G==null?"":typeof G=="string"&&(G.includes(",")||G.includes('"')||G.includes(`
`))?`"${G.replace(/"/g,'""')}"`:G});te+=F.join(",")+`
`}),L=`formatted_data_${Date.now()}.csv`,g="text/csv"}else l==="json"&&(te=JSON.stringify(R,null,2),L=`formatted_data_${Date.now()}.json`,g="application/json");const U=new Blob([te],{type:g}),O=URL.createObjectURL(U),B=document.createElement("a");B.href=O,B.download=L,document.body.appendChild(B),B.click(),document.body.removeChild(B),URL.revokeObjectURL(O),J(l.toUpperCase(),R.length,!0,"File Download",L),A({success:!0,message:`Data exported successfully as ${l.toUpperCase()}`,open:!0})}catch(R){console.error("Export error:",R),A({success:!1,message:`Error exporting data: ${R instanceof Error?R.message:"Unknown error"}`,open:!0}),J(l.toUpperCase(),r.length,!1,"File Download")}finally{C(!1)}},w=R=>({"response-time-analyzer":"Response Time Analyzer","call-density-heatmap":"Call Density Heatmap","incident-dashboard":"Incident Dashboard","trend-analyzer":"Trend Analyzer"})[R]||R,P=async()=>{var L,te;if(console.log("üö®üö®üö® CRITICAL DEBUG: handleSendToTool FUNCTION CALLED AT",new Date().toISOString()),console.log("üöÄüöÄüöÄ selectedExportTool:",u),console.log("üöÄüöÄüöÄ transformedData length:",r==null?void 0:r.length),console.log("üöÄüöÄüöÄ preTransformedData length:",h==null?void 0:h.length),console.log("üöÄüöÄüöÄ transformedData sample:",r==null?void 0:r[0]),!r||r.length===0||!u){console.log("‚ùå SEND TO TOOL FAILED - Missing data or tool selection"),console.log("‚ùå transformedData:",!!r),console.log("‚ùå transformedData.length:",r==null?void 0:r.length),console.log("‚ùå selectedExportTool:",u),A({success:!1,message:"No data or tool selected",open:!0});return}C(!0);const R=w(u);console.log("üöÄ Tool name resolved:",R);try{let g;if(console.log('üîß CHECKING TOOL TYPE - selectedExportTool === "response-time-analyzer":',u==="response-time-analyzer"),console.log("üîß CHECKING PRE-TRANSFORMED DATA AVAILABILITY:",!!h),u==="response-time-analyzer"&&h&&h.length>0)console.log("‚úÖ USING PRE-TRANSFORMED DATA FROM TOOL SELECTION - NO REDUNDANT TRANSFORMATION"),console.log("Pre-transformed data sample (first record):",h[0]),console.log("Pre-transformed field names:",Object.keys(h[0])),console.log("incidentTime value:",(L=h[0])==null?void 0:L.incidentTime),g=h;else if(u==="fire-map-pro"){console.log("üîß APPLYING FIRE MAP PRO TRANSFORMATION");const O=Tt.transformToFireMapPro(r);if(!O.success)throw console.error("‚ùå Data transformation failed:",O.errors),new Error(`Data transformation failed: ${O.errors.join(", ")}`);g=((te=O.data)==null?void 0:te.features)||[]}else console.log("üîß USING STANDARD DATA FORMATTING"),console.log("DEBUG - USING ALREADY TRANSFORMED DATA: Sample data fields:",r.length>0?Object.keys(r[0]):"No data"),g=r.map(O=>{const B={...O};return console.log("DEBUG - USING MAPPED DATA: Record fields:",Object.keys(O)),Object.keys(B).forEach(D=>{if(B[D]&&typeof B[D]=="string"&&B[D].includes(" ")){const[v,F]=B[D].split(" ");console.log(`DATETIME SPLIT: Field "${D}" = "${B[D]}" -> Date: "${v}", Time: "${F}"`),D.toLowerCase().includes("date")?(console.log(`SETTING DATE FIELD "${D}" to "${v}"`),B[D]=v):D.toLowerCase().includes("time")&&(console.log(`SETTING TIME FIELD "${D}" to "${F}"`),B[D]=F)}}),B});const U={toolId:u,toolName:R,data:g,sourceFile:n==null?void 0:n.name,timestamp:Date.now(),fields:Object.keys(g[0]),recordCount:g.length,exportVersion:"2.0"};if(g.length>0){console.log("Sample record being sent (using user-mapped fields):",g[0]);const O=g[0],B=Object.keys(O);console.log("All field names (as mapped by user):",B),console.log("Field values:",O)}sessionStorage.removeItem("fireEmsExportedData"),console.log("VERIFY: Field names being stored in sessionStorage:",U.data&&U.data.length>0?Object.keys(U.data[0]):"No data"),sessionStorage.setItem("fireEmsExportedData",JSON.stringify(U)),console.log(`Data prepared for ${u}. Data size: ${g.length} records`),g.length>0&&(console.log("FIELD NAMES CHECK - Sample record being sent to session storage:"),console.log(JSON.stringify(g[0]))),J("Data Transfer",g.length,!0,R),A({success:!0,message:`Data sent to ${R} successfully!`,open:!0}),setTimeout(()=>{const D=`http://${window.location.hostname}:5006`;let v="";if(u==="fire-map-pro")v=`${window.location.origin}/app/fire-map-pro`;else if(u==="response-time-analyzer")v=`${window.location.origin}/app/response-time-analyzer`;else if(u==="call-density-heatmap")v=`${D}/call-density-heatmap`;else if(u==="incident-dashboard")v=`${D}/incident-dashboard`;else if(u==="trend-analyzer")v=`${D}/trend-analyzer`;else{console.log(`Tool ID not recognized: ${u}`);return}console.log(`Redirecting to: ${v}`),window.location.href=v},500)}catch(g){console.error("Send to tool error:",g),A({success:!1,message:`Error sending data to tool: ${g instanceof Error?g.message:"Unknown error"}`,open:!0}),J("Data Transfer",r.length,!1,R)}finally{C(!1)}},T=()=>{t(Le(2))};if(!r||r.length===0)return e.jsxs(j,{children:[e.jsx(ce,{severity:"warning",sx:{mb:2},children:"No data available to export. Please go back and ensure your data is processed correctly."}),e.jsx(oe,{variant:"outlined",startIcon:e.jsx(tt,{}),onClick:T,children:"Back to Validation"})]});const k=R=>new Date(R).toLocaleString(),ie=()=>Y.length===0?e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(f,{color:"text.secondary",children:"No export history available"})}):e.jsx(Ue,{sx:{width:"100%",bgcolor:"background.paper"},dense:!0,children:Y.map(R=>e.jsxs(Ee,{secondaryAction:e.jsx(Ce,{edge:"end","aria-label":"delete",onClick:()=>{_(L=>L.filter(te=>te.id!==R.id))},children:e.jsx(nt,{fontSize:"small"})}),sx:{borderLeft:"4px solid",borderColor:R.success?"success.main":"error.main",mb:1,bgcolor:"background.paper","&:hover":{bgcolor:"action.hover"}},children:[e.jsxs(ke,{children:[R.format==="Excel"&&e.jsx(mt,{color:"success"}),R.format==="CSV"&&e.jsx(_t,{color:"primary"}),R.format==="JSON"&&e.jsx(xs,{color:"info"}),R.format==="PDF"&&e.jsx(mt,{color:"error"}),R.format==="Data Transfer"&&e.jsx(ys,{color:"secondary"})]}),e.jsx(Fe,{primary:e.jsx(f,{variant:"body2",fontWeight:"medium",children:R.format==="Data Transfer"?`Sent to ${R.destination}`:`${R.format} Export${R.fileName?` - ${R.fileName}`:""}`}),secondary:e.jsxs(f,{variant:"caption",display:"block",children:[k(R.timestamp)," ‚Ä¢ ",R.recordCount," records",!R.success&&" ‚Ä¢ Failed"]})})]},R.id))});return console.log("üî•üî•üî• EXPORT CONTAINER RENDER - FRESH BUILD JUN 13 2025 16:47 - transformedData length:",r==null?void 0:r.length),console.log("üî•üî•üî• EXPORT CONTAINER RENDER - selectedExportTool:",u),console.log("üî•üî•üî• EXPORT CONTAINER RENDER - tabValue:",a),e.jsxs(j,{children:[e.jsx(f,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Export Formatted Data"}),e.jsxs(fe,{sx:{p:2,mb:3},children:[e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(f,{variant:"body1",children:[(n==null?void 0:n.name)||"No file"," (",n==null?void 0:n.type,")"]})]})}),e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(f,{variant:"body1",children:[r.length," records processed"]})]})}),e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:s.length===0?e.jsxs(e.Fragment,{children:[e.jsx(qe,{color:"success"}),e.jsx(f,{color:"success.main",children:"All data is valid"})]}):e.jsx(e.Fragment,{children:e.jsxs(ce,{severity:"warning",sx:{mt:1},children:[s.length," validation issues found. Consider reviewing before export."]})})})]})})]}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($t,{color:"action",fontSize:"small"}),e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Export History"}),Y.length>0&&e.jsx(rr,{badgeContent:Y.length,color:"primary",sx:{ml:1}})]}),e.jsxs(j,{children:[e.jsx(Ce,{size:"small",onClick:()=>V(!q),"aria-label":q?"Hide history":"Show history",children:q?e.jsx(ps,{}):e.jsx(xt,{})}),Y.length>0&&q&&e.jsx(oe,{size:"small",startIcon:e.jsx(nt,{}),onClick:i,sx:{ml:1},children:"Clear"})]})]}),e.jsx(ls,{in:q,children:e.jsx(j,{sx:{mt:2},children:ie()})})]}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:a,onChange:E,"aria-label":"export options tabs",children:[e.jsx(De,{label:"Download File",id:"export-tab-0","aria-controls":"export-tabpanel-0"}),e.jsx(De,{label:"Send to Tool",id:"export-tab-1","aria-controls":"export-tabpanel-1"})]})}),e.jsx(Qt,{value:a,index:0,children:e.jsxs(pe,{container:!0,spacing:3,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsx(Ln,{selectedFormat:l,onFormatChange:H})}),e.jsx(pe,{size:{xs:12,md:6},children:e.jsx(Vn,{dataCount:r.length,fields:Object.keys(r[0]),format:l})}),e.jsx(pe,{size:12,children:e.jsx(oe,{variant:"contained",color:"primary",fullWidth:!0,size:"large",onClick:y,disabled:S,startIcon:S?e.jsx(Ve,{size:20}):e.jsx(qs,{}),sx:{mt:2},children:S?"Exporting...":`Download as ${l.toUpperCase()}`})})]})}),e.jsx(Qt,{value:a,index:1,children:e.jsx(zn,{selectedTool:u,onToolSelect:X,transformedData:r,onSendToTool:P,isSending:S,preTransformedData:h})}),e.jsx(ye,{sx:{my:3}}),e.jsx(j,{sx:{display:"flex",justifyContent:"space-between"},children:e.jsx(oe,{variant:"outlined",startIcon:e.jsx(tt,{}),onClick:T,children:"Back to Validation"})}),e.jsx(ms,{open:$.open,autoHideDuration:6e3,onClose:()=>A({...$,open:!1}),children:e.jsx(ce,{onClose:()=>A({...$,open:!1}),severity:$.success?"success":"error",children:$.message})})]})},es={log:(...t)=>{},warn:(...t)=>{},error:(...t)=>{console.error(...t)},debug:(...t)=>{},info:(...t)=>{}},Hn=["Upload File","Map Fields","Preview & Validate","Export"],ko=()=>{const{currentStep:t}=Be(s=>s.formatter),n=()=>{const s=window.location.pathname;return s.includes("fire-map-pro")?"FireEMS Fire Map Pro":s.includes("response-time-analyzer")?"FireEMS Response Time Analyzer":"FireEMS Data Formatter"};Je.useEffect(()=>{const s=n();document.title=s;try{gt(),es.debug("[DEBUG] Vendor templates seeded successfully")}catch(a){es.error("[ERROR] Failed to seed vendor templates:",a)}},[]);const r=s=>{switch(s){case 0:return e.jsx(Sr,{});case 1:return e.jsx(wn,{});case 2:return e.jsx(kn,{});case 3:return e.jsx(Bn,{});default:return e.jsx(f,{children:"Unknown step"})}};return e.jsx(Ns,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(fe,{elevation:3,sx:{p:3},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:n()}),e.jsx(nr,{activeStep:t,sx:{mb:4},children:Hn.map(s=>e.jsx(or,{children:e.jsx(ar,{children:s})},s))}),e.jsx(j,{sx:{mt:2},children:r(t)})]})})};export{ko as default};
