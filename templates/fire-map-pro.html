<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireMapPro | FireEMS.ai</title>
    
    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fire-map-pro.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fix-ready-status.css') }}">
    
    <!-- Required scripts before content loads -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- Fix for Leaflet.Draw toolbar visibility -->
    <style>
        /* Comprehensive fix for all Leaflet.Draw elements */
        .leaflet-draw, 
        .leaflet-draw.leaflet-control,
        .leaflet-draw-toolbar, 
        .leaflet-draw-toolbar a, 
        .leaflet-draw-actions, 
        .leaflet-draw-actions a,
        [class*="leaflet-draw-"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 2000 !important;
            pointer-events: auto !important;
        }
        
        /* Ensure toolbar has proper background */
        .leaflet-draw-toolbar {
            background: white !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            border-radius: 4px !important;
        }
        
        /* Style buttons specifically */
        .leaflet-draw-toolbar a {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            text-align: center !important;
        }
        
        /* Make radio buttons more prominent */
        .radio-group input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-group label {
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }
        
        /* Add pointer cursor to all buttons */
        .tool-btn, button {
            cursor: pointer;
        }
    </style>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <a href="/">
                <i class="fas fa-fire"></i> FireEMS.ai
            </a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/fire-ems-dashboard">Response Time Analyzer</a>
            <a href="/isochrone-map">Isochrone Map Generator</a>
            <a href="/call-density-heatmap">Call Density Heatmap</a>
            <a href="/coverage-gap-finder">Coverage Gap Finder</a>
            <a href="/fire-map-pro" class="active">FireMapPro</a>
        </div>
    </div>

    <div class="container">
        <div class="panel-container">
            <div class="left-panel">
                <h2>FireMapPro</h2>
                <p>Advanced interactive map creator for fire department and EMS planning and analysis.</p>
                
                <div class="tools-section">
                    <h3><i class="fas fa-layer-group"></i> Map Layers</h3>
                    <div class="layer-controls">
                        <div class="base-layers">
                            <h4>Base Maps</h4>
                            <div class="radio-group">
                                <input type="radio" id="street-layer" name="base-layer" value="street" checked>
                                <label for="street-layer">Street</label>
                                
                                <input type="radio" id="satellite-layer" name="base-layer" value="satellite">
                                <label for="satellite-layer">Satellite</label>
                                
                                <input type="radio" id="terrain-layer" name="base-layer" value="terrain">
                                <label for="terrain-layer">Terrain</label>
                            </div>
                        </div>
                        
                        <div class="overlay-layers">
                            <h4>Data Overlays</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stations-layer" value="stations">
                                    <label for="stations-layer">Fire Stations</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="incidents-layer" value="incidents">
                                    <label for="incidents-layer">Incidents</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="response-layer" value="response">
                                    <label for="response-layer">Response Areas</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="population-layer" value="population">
                                    <label for="population-layer">Population Density</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hydrants-layer" value="hydrants">
                                    <label for="hydrants-layer">Hydrants</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-file-upload"></i> Custom Data</h3>
                    <div class="upload-section">
                        <h4>Import Data</h4>
                        <div class="file-upload">
                            <label for="geojson-upload" class="upload-btn">
                                <i class="fas fa-file-import"></i> GeoJSON / KML
                            </label>
                            <input type="file" id="geojson-upload" accept=".geojson,.json,.kml">
                        </div>
                        
                        <div class="file-upload">
                            <label for="csv-upload" class="upload-btn">
                                <i class="fas fa-table"></i> CSV with Coordinates
                            </label>
                            <input type="file" id="csv-upload" accept=".csv">
                        </div>
                        
                        <div class="file-upload">
                            <label for="image-upload" class="upload-btn">
                                <i class="fas fa-image"></i> Image Overlay
                            </label>
                            <input type="file" id="image-upload" accept="image/*">
                        </div>
                        <div id="upload-status"></div>
                        
                        <!-- CSV Configuration Options -->
                        <div class="csv-config-section">
                            <h4>CSV Import Settings</h4>
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-preview-enable" checked>
                                <label for="csv-preview-enable">Show preview before import</label>
                            </div>
                            
                            <div class="input-group">
                                <label for="csv-coord-format">Coordinate Format:</label>
                                <select id="csv-coord-format">
                                    <option value="lat_lng">Latitude, Longitude</option>
                                    <option value="lng_lat">Longitude, Latitude</option>
                                </select>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-header-detection" checked>
                                <label for="csv-header-detection">Auto-detect headers</label>
                            </div>
                            
                            <div class="info-text">
                                <i class="fas fa-info-circle"></i> Set coordinate format to "Longitude, Latitude" for Phoenix data
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-tools"></i> Map Tools</h3>
                    <div class="map-tools">
                        <button id="draw-tool" class="tool-btn">
                            <i class="fas fa-draw-polygon"></i> Draw & Measure
                        </button>
                        
                        <button id="search-tool" class="tool-btn">
                            <i class="fas fa-search-location"></i> Search Address
                        </button>
                        
                        <button id="filter-tool" class="tool-btn">
                            <i class="fas fa-filter"></i> Filter Data
                        </button>
                        
                        <button id="export-tool" class="tool-btn">
                            <i class="fas fa-file-export"></i> Export Map
                        </button>
                        
                        <button id="icon-tool" class="tool-btn">
                            <i class="fas fa-icons"></i> Add Icons
                        </button>
                        
                        <button id="clear-map" class="tool-btn danger">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div id="icon-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-icons"></i> Drag Icons To Map</h3>
                    <p class="hint-text"><i class="fas fa-info-circle"></i> Drag and drop icons onto the map</p>
                    <div class="icon-palette">
                        <div class="icon-category">
                            <h4>Emergency Services</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="fire-station">
                                    <i class="fas fa-fire-extinguisher"></i>
                                    <span>Fire Station</span>
                                </div>
                                <div class="draggable-icon" data-icon="hospital">
                                    <i class="fas fa-hospital"></i>
                                    <span>Hospital</span>
                                </div>
                                <div class="draggable-icon" data-icon="ambulance">
                                    <i class="fas fa-ambulance"></i>
                                    <span>Ambulance</span>
                                </div>
                                <div class="draggable-icon" data-icon="police">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Police</span>
                                </div>
                            </div>
                        </div>
                        <div class="icon-options">
                            <div class="color-selector">
                                <label for="icon-color">Icon Color:</label>
                                <select id="icon-color">
                                    <option value="#d32f2f" selected>Red</option>
                                    <option value="#1976d2">Blue</option>
                                    <option value="#388e3c">Green</option>
                                    <option value="#f57c00">Orange</option>
                                    <option value="#5e35b1">Purple</option>
                                    <option value="#000000">Black</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="search-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-search"></i> Search</h3>
                    <div class="search-box">
                        <input type="text" id="address-search" placeholder="Enter an address to search...">
                        <button id="search-btn" class="primary-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="search-results"></div>
                </div>
                
                <div id="filter-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-filter"></i> Filter Data</h3>
                    <div class="filter-options">
                        <div class="filter-group">
                            <label for="filter-type">Type:</label>
                            <select id="filter-type">
                                <option value="all">All</option>
                                <option value="fire">Fire</option>
                                <option value="ems">EMS</option>
                                <option value="hazmat">Hazmat</option>
                                <option value="rescue">Rescue</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button id="apply-filter" class="primary-btn">Apply Filter</button>
                            <button id="reset-filter" class="secondary-btn">Reset</button>
                        </div>
                    </div>
                </div>
                
                <div id="export-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-file-export"></i> Export Map</h3>
                    <div class="export-options">
                        <p>Choose export format:</p>
                        <div class="export-buttons">
                            <button id="export-pdf" class="export-btn">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button id="export-png" class="export-btn">
                                <i class="fas fa-file-image"></i> PNG Image
                            </button>
                            <button id="export-geojson" class="export-btn">
                                <i class="fas fa-file-code"></i> GeoJSON
                            </button>
                        </div>
                    </div>
                </div>
                
                <div id="measurement-info" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-ruler"></i> Measurement Info</h3>
                    <div id="measurement-display">
                        <p>Draw a shape on the map to measure:</p>
                        <ul>
                            <li>Line: Distance</li>
                            <li>Polygon/Rectangle: Area</li>
                            <li>Circle: Radius and Area</li>
                        </ul>
                    </div>
                    <div id="measurement-results">
                        <p>No measurements yet</p>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div id="map"></div>
                <div class="map-status-bar">
                    <div class="status-item">
                        <span>Zoom: </span>
                        <span id="zoom-level">-</span>
                    </div>
                    <div class="status-item">
                        <span>Center: </span>
                        <span id="map-center">-</span>
                    </div>
                    <div class="status-item">
                        <span>Mouse: </span>
                        <span id="mouse-position">-</span>
                    </div>
                    <div class="status-item">
                        <span>Scale: </span>
                        <span id="map-scale">-</span>
                    </div>
                </div>
                <div id="legend" class="map-legend">
                    <h4>Legend</h4>
                    <div id="legend-content">
                        <!-- Legend items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="footer-content">
            <div class="copyright">
                &copy; 2025 FireEMS.ai | Advanced Fire &amp; EMS Planning Tools
            </div>
        </div>
    </footer>
    
    <!-- Direct inline script to handle layer switching and drawing tools -->
    <script>
        // Add Leaflet.GeometryUtil for area calculations
        (function(){function t(t,n){if(t.x&&t.y)return n([t.x,t.y]);if(t.lat&&t.lng)return n([t.lng,t.lat]);if(t[0]&&t[1])return n(t);throw"Invalid LatLng object: "+t}L.GeometryUtil={},L.GeometryUtil.distancePointLine=function(n,e){var r=L.point(n),i=L.point(e[0]),a=L.point(e[1]),u=a.x-i.x,s=a.y-i.y,o=u*u+s*s,l=void 0;return o>0&&(l=((r.x-i.x)*u+(r.y-i.y)*s)/o),l<0?r.distanceTo(i):l>1?r.distanceTo(a):r.distanceTo(L.point(i.x+l*u,i.y+l*s))},L.GeometryUtil.closest=function(n,e,r){if(!r||!r.length)return null;for(var i=1/0,a=null,u=L.GeometryUtil.distanceSegment,s=0,o=r.length;s<o-1;s++){var l=r[s],c=r[s+1],h=u(n,l,c);h<i&&(i=h,a=L.GeometryUtil.closestOnSegment(n,l,c))}return a},L.GeometryUtil.closestOnSegment=function(n,e,r){var i=n.distanceTo(e),a=n.distanceTo(r);return i<a?e:r},L.GeometryUtil.distanceSegment=function(n,e,r){return L.GeometryUtil.distancePointLine(n,[e,r])},L.GeometryUtil.length=function(n){for(var e=0,r=n.length,i=r-1;i>=1;i--)e+=n[i].distanceTo(n[i-1]);return e},L.Polyline.include({getDistance:function(){return L.GeometryUtil.length(this.getLatLngs())}}),L.GeometryUtil.readableDistance=function(n,e){var r,i="m";return n>1e3&&(n/=1e3,i="km"),n=n.toFixed(0),e&&(n=t(n,e)),n+" "+i},L.GeometryUtil.readableArea=function(n,e){var r="";return n>=1e6?(n/=1e6,r="km²"):n>=1e4&&(n/=1e4,r="ha"),n=n.toFixed(2),e&&(n=t(n,e)),n+" "+r},L.GeometryUtil.geodesicArea=function(t){for(var n=0,e=t.length,r=e-1,i=0;i<e;r=i++){var a=t[r].lat*Math.PI/180,u=t[i].lat*Math.PI/180,s=(t[i].lng-t[r].lng)*Math.PI/180,o=Math.sin(a),l=Math.sin(u),c=Math.cos(a),h=Math.cos(u);n+=Math.atan2(Math.sin(s)*c*h,l*o-Math.cos(s)*c*l)}return Math.abs(n*6378137*6378137/2)},L.Polygon.include({getArea:function(){return L.GeometryUtil.geodesicArea(this.getLatLngs()[0])}}),L.GeometryUtil.bearing=function(n,e){var r=Math.PI/180,i=n.lat*r,a=e.lat*r,u=n.lng*r,s=e.lng*r,o=Math.sin(s-u)*Math.cos(a),l=Math.cos(i)*Math.sin(a)-Math.sin(i)*Math.cos(a)*Math.cos(s-u),c=Math.atan2(o,l)/r;return(c+360)%360},L.GeometryUtil.destination=function(n,e,r){var i=L.latLng(n);e=0===e?e:360-e;var a=r/6371e3,u=e*Math.PI/180,s=n.lat*Math.PI/180,o=n.lng*Math.PI/180,l=Math.asin(Math.sin(s)*Math.cos(a)+Math.cos(s)*Math.sin(a)*Math.cos(u)),c=o+Math.atan2(Math.sin(u)*Math.sin(a)*Math.cos(s),Math.cos(a)-Math.sin(s)*Math.sin(l));return c=parseFloat(c.toPrecision(10)),c=(c+3*Math.PI)%(2*Math.PI)-Math.PI,i.setLatLng([l*180/Math.PI,c*180/Math.PI]),i},L.GeometryUtil.lineIntersection=function(t,n){var e,r,i,a,u=t[0][0],s=t[0][1],o=t[1][0],l=t[1][1],c=n[0][0],h=n[0][1],d=n[1][0],f=n[1][1],g=o-u,L=l-s,p=d-c,m=f-h;if(a=(-L)*(c-u)+g*(h-s),i=(p)*(h-s)-(-m)*(c-u),g*(-m)-(-L)*(p)){if(e=a/(g*(-m)-(-L)*(p)),r=i/(g*(-m)-(-L)*(p)),e>=0&&e<=1&&r>=0&&r<=1)return{x:u+e*g,y:s+e*L}}return null},L.GeometryUtil.reverse=function(t){var n=t.length,e=n-1,r=t.slice(0);for(var i in t)r[i]=t[e-i];return r}}());
        
        // Wait for page load
        window.addEventListener('load', function() {
            console.log('*** DIRECT INITIALIZATION STARTING ***');
            
            // Create map and base layers
            var map = L.map('map', {
                center: [33.4484, -112.0740],  // Phoenix
                zoom: 11
            });
            
            // Create the base layers with specific names and CORS headers
            var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                crossOrigin: "anonymous"
            });
            
            var satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Imagery &copy; Google',
                maxZoom: 20,
                crossOrigin: "anonymous"
            });
            
            var terrainLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
                attribution: 'Terrain &copy; Google',
                maxZoom: 20,
                crossOrigin: "anonymous"
            });
            
            // Add the street layer by default
            streetLayer.addTo(map);
            
            // Set up layer storage for the main script
            window.map = map;
            window.streetLayer = streetLayer;
            window.satelliteLayer = satelliteLayer;
            window.terrainLayer = terrainLayer;
            
            // Set up direct layer switching
            function switchBaseLayer(layerName) {
                console.log('Switching to layer:', layerName);
                
                // Remove all current base layers
                if (map.hasLayer(streetLayer)) map.removeLayer(streetLayer);
                if (map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer);
                if (map.hasLayer(terrainLayer)) map.removeLayer(terrainLayer);
                
                // Add the selected layer
                if (layerName === 'street') {
                    map.addLayer(streetLayer);
                    document.getElementById('street-layer').checked = true;
                } 
                else if (layerName === 'satellite') {
                    map.addLayer(satelliteLayer);
                    document.getElementById('satellite-layer').checked = true;
                }
                else if (layerName === 'terrain') {
                    map.addLayer(terrainLayer);
                    document.getElementById('terrain-layer').checked = true;
                }
            }
            
            // Add direct event listeners for radio buttons
            document.getElementById('street-layer').addEventListener('click', function() {
                switchBaseLayer('street');
            });
            
            document.getElementById('satellite-layer').addEventListener('click', function() {
                switchBaseLayer('satellite');
            });
            
            document.getElementById('terrain-layer').addEventListener('click', function() {
                switchBaseLayer('terrain');
            });
            
            // Set up drawing tools
            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            var drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polyline: { shapeOptions: { color: '#1976d2', weight: 3 } },
                    polygon: { allowIntersection: false, shapeOptions: { color: '#1976d2', weight: 3 } },
                    rectangle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                    circle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                    marker: true
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            // Storage for toggles
            window.drawControlActive = false;
            
            // Initialize the controls with empty objects to prevent null errors
            var searchControl, mapStatusUpdater;
            
            // Add search control to find addresses
            searchControl = new L.Control.Search({
                position: 'topright',
                layer: L.layerGroup(),
                initial: false,
                propertyName: 'addr',
                zoom: 16,
                marker: false,
                textErr: 'Address not found',
                textCancel: 'Cancel',
                textPlaceholder: 'Search...',
                collapsed: false,
                autoCollapse: false,
                autoType: false,
                minLength: 2
            });
            
            // Add OSM geocoding provider (doesn't require API key)
            searchControl.on('search:locationfound', function(e) {
                var latlng = e.latlng;
                var marker = L.marker(latlng).addTo(map);
                var msg = 'Address found: ' + e.text;
                document.getElementById('search-results').innerHTML = '<p>' + msg + '</p>';
            });
            
            // Handle draw button
            document.getElementById('draw-tool').addEventListener('click', function() {
                console.log('Draw tool clicked');
                
                var drawButton = this;
                window.drawControlActive = !window.drawControlActive;
                document.getElementById('measurement-info').style.display = window.drawControlActive ? 'block' : 'none';
                
                if (!window.drawControlActive) {
                    // Remove draw control
                    try {
                        map.removeControl(drawControl);
                        drawButton.classList.remove('active');
                        console.log('Draw control removed');
                    } catch (e) {
                        console.error('Error removing draw control:', e);
                    }
                } else {
                    // Add draw control
                    try {
                        // Create a new draw control each time for reliability
                        drawControl = new L.Control.Draw({
                            position: 'topright',
                            draw: {
                                polyline: { 
                                    shapeOptions: { color: '#1976d2', weight: 3 },
                                    metric: true,
                                    showLength: true,
                                    feet: false
                                },
                                polygon: { 
                                    allowIntersection: false,
                                    showArea: true,
                                    metric: true,
                                    shapeOptions: { color: '#1976d2', weight: 3 }
                                },
                                rectangle: { 
                                    showArea: true,
                                    metric: true,
                                    shapeOptions: { color: '#1976d2', weight: 2 }
                                },
                                circle: { 
                                    showRadius: true,
                                    metric: true,
                                    shapeOptions: { color: '#1976d2', weight: 2 }
                                },
                                marker: true
                            },
                            edit: {
                                featureGroup: drawnItems,
                                remove: true
                            }
                        });
                        
                        map.addControl(drawControl);
                        drawButton.classList.add('active');
                        
                        // Add style to ensure visibility
                        var style = document.createElement('style');
                        style.innerHTML = `
                            .leaflet-draw, 
                            .leaflet-draw.leaflet-control,
                            .leaflet-draw-toolbar, 
                            .leaflet-draw-toolbar a, 
                            .leaflet-draw-actions, 
                            .leaflet-draw-actions a,
                            [class*="leaflet-draw-"] {
                                display: block !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                z-index: 2000 !important;
                                pointer-events: auto !important;
                            }
                        `;
                        document.head.appendChild(style);
                        
                        console.log('Draw control added and visibility enforced');
                        
                        // Ask about measurement mode
                        var measurementMode = confirm('Do you want to activate measurement mode?\n\nClick OK to measure distances and areas.\nClick Cancel to draw features on the map.');
                        console.log('Measurement mode:', measurementMode);
                        
                        // Set measurement mode flag for reference
                        window.measurementActive = measurementMode;
                    } catch (e) {
                        console.error('Error adding draw control:', e);
                        alert('Error setting up drawing tools. Please refresh the page and try again.');
                    }
                }
            });
            
            // Create draw objects to handle created shapes
            map.on(L.Draw.Event.CREATED, function(event) {
                var layer = event.layer;
                drawnItems.addLayer(layer);
                console.log('Shape created:', event.layerType);
                
                // Calculate measurements for the created shape
                var measurementDiv = document.getElementById('measurement-results');
                if (measurementDiv) {
                    var measurementText = '';
                    
                    // Handle different shape types
                    if (event.layerType === 'polyline') {
                        // Get total distance of the line
                        var latlngs = layer.getLatLngs();
                        var totalDistance = 0;
                        
                        for (var i = 0; i < latlngs.length - 1; i++) {
                            totalDistance += latlngs[i].distanceTo(latlngs[i + 1]);
                        }
                        
                        // Format distance (meters to kilometers if applicable)
                        if (totalDistance >= 1000) {
                            measurementText = 'Distance: ' + (totalDistance / 1000).toFixed(2) + ' km';
                        } else {
                            measurementText = 'Distance: ' + Math.round(totalDistance) + ' m';
                        }
                    } 
                    else if (event.layerType === 'polygon' || event.layerType === 'rectangle') {
                        // Calculate area in square meters
                        var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                        
                        // Format area (m² to km² or hectares if applicable)
                        if (area >= 1000000) {
                            measurementText = 'Area: ' + (area / 1000000).toFixed(2) + ' km²';
                        } else if (area >= 10000) {
                            measurementText = 'Area: ' + (area / 10000).toFixed(2) + ' hectares';
                        } else {
                            measurementText = 'Area: ' + Math.round(area) + ' m²';
                        }
                    }
                    else if (event.layerType === 'circle') {
                        // Get radius in meters
                        var radius = layer.getRadius();
                        var area = Math.PI * radius * radius;
                        
                        // Format radius and area
                        if (radius >= 1000) {
                            measurementText = 'Radius: ' + (radius / 1000).toFixed(2) + ' km<br>';
                        } else {
                            measurementText = 'Radius: ' + Math.round(radius) + ' m<br>';
                        }
                        
                        if (area >= 1000000) {
                            measurementText += 'Area: ' + (area / 1000000).toFixed(2) + ' km²';
                        } else if (area >= 10000) {
                            measurementText += 'Area: ' + (area / 10000).toFixed(2) + ' hectares';
                        } else {
                            measurementText += 'Area: ' + Math.round(area) + ' m²';
                        }
                    }
                    else if (event.layerType === 'marker') {
                        var latlng = layer.getLatLng();
                        measurementText = 'Coordinates: ' + 
                            latlng.lat.toFixed(6) + ', ' + 
                            latlng.lng.toFixed(6);
                    }
                    
                    // Display the measurement
                    if (measurementText) {
                        measurementDiv.innerHTML = '<p>' + measurementText + '</p>';
                        
                        // Show the measurement panel if not already visible
                        document.getElementById('measurement-info').style.display = 'block';
                    }
                }
            });
            
            // Update map status bar
            function updateMapStatus() {
                var center = map.getCenter();
                var zoom = map.getZoom();
                
                document.getElementById('zoom-level').textContent = zoom;
                document.getElementById('map-center').textContent = center.lat.toFixed(4) + ', ' + center.lng.toFixed(4);
                
                // Calculate scale in meters/km at current zoom
                var bounds = map.getBounds();
                var centerLat = center.lat;
                var distance = bounds.getNorthEast().distanceTo(bounds.getSouthWest());
                var scale = distance / Math.sqrt(2);
                
                var scaleText = scale >= 1000 ? (scale / 1000).toFixed(1) + ' km' : Math.round(scale) + ' m';
                document.getElementById('map-scale').textContent = scaleText;
            }
            
            // Update mouse position on mousemove
            map.on('mousemove', function(e) {
                document.getElementById('mouse-position').textContent = 
                    e.latlng.lat.toFixed(4) + ', ' + e.latlng.lng.toFixed(4);
            });
            
            // Update map status on zoom/move
            map.on('zoomend moveend', updateMapStatus);
            updateMapStatus();
            
            // Set up search button functionality
            document.getElementById('search-btn').addEventListener('click', function() {
                var searchInput = document.getElementById('address-search').value;
                if (searchInput) {
                    // Use Nominatim for geocoding (no API key required)
                    var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(searchInput);
                    
                    // Show searching status
                    document.getElementById('search-results').innerHTML = '<p>Searching...</p>';
                    
                    // Make the request
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                var location = data[0];
                                var lat = parseFloat(location.lat);
                                var lon = parseFloat(location.lon);
                                
                                // Center map on result
                                map.setView([lat, lon], 15);
                                
                                // Add marker
                                var marker = L.marker([lat, lon]).addTo(map);
                                marker.bindPopup(location.display_name).openPopup();
                                
                                // Show result
                                document.getElementById('search-results').innerHTML = 
                                    '<p>Found: ' + location.display_name + '</p>';
                            } else {
                                document.getElementById('search-results').innerHTML = 
                                    '<p>No results found. Try a different search term.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error searching:', error);
                            document.getElementById('search-results').innerHTML = 
                                '<p>Error searching. Please try again.</p>';
                        });
                }
            });
            
            // Search on Enter key
            document.getElementById('address-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
            
            // Implement drag and drop functionality for icons
            function setupIconDragAndDrop() {
                console.log('Setting up icon drag functionality');
                
                // Get all draggable icons
                var draggableIcons = document.querySelectorAll('.draggable-icon');
                
                draggableIcons.forEach(function(icon) {
                    // Make them draggable
                    icon.setAttribute('draggable', 'true');
                    
                    // Set up drag start event
                    icon.addEventListener('dragstart', function(e) {
                        console.log('Drag started for icon:', this.dataset.icon);
                        // Store the icon type and color
                        var iconType = this.dataset.icon;
                        var iconColor = document.getElementById('icon-color').value;
                        
                        e.dataTransfer.setData('text/plain', JSON.stringify({
                            type: iconType,
                            color: iconColor
                        }));
                        
                        // Set drag image
                        var dragIcon = document.createElement('img');
                        dragIcon.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // 1px transparent
                        dragIcon.style.visibility = 'hidden';
                        document.body.appendChild(dragIcon);
                        e.dataTransfer.setDragImage(dragIcon, 0, 0);
                    });
                });
                
                // Set up the map as a drop target
                map.getContainer().addEventListener('dragover', function(e) {
                    e.preventDefault(); // Allow drop
                });
                
                map.getContainer().addEventListener('drop', function(e) {
                    e.preventDefault();
                    
                    try {
                        // Get drop coordinates
                        var rect = map.getContainer().getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        var y = e.clientY - rect.top;
                        var latlng = map.containerPointToLatLng([x, y]);
                        
                        // Get icon data
                        var iconData = JSON.parse(e.dataTransfer.getData('text/plain'));
                        var iconType = iconData.type;
                        var iconColor = iconData.color;
                        
                        console.log('Dropped icon:', iconType, 'at', latlng.toString());
                        
                        // Create an appropriate icon based on the type
                        var iconHtml = '';
                        switch(iconType) {
                            case 'fire-station':
                                iconHtml = '<i class="fas fa-fire-extinguisher"></i>';
                                break;
                            case 'hospital':
                                iconHtml = '<i class="fas fa-hospital"></i>';
                                break;
                            case 'ambulance':
                                iconHtml = '<i class="fas fa-ambulance"></i>';
                                break;
                            case 'police':
                                iconHtml = '<i class="fas fa-shield-alt"></i>';
                                break;
                            case 'hydrant':
                                iconHtml = '<i class="fas fa-tint"></i>';
                                break;
                            case 'school':
                                iconHtml = '<i class="fas fa-school"></i>';
                                break;
                            case 'building':
                                iconHtml = '<i class="fas fa-building"></i>';
                                break;
                            case 'landmark':
                                iconHtml = '<i class="fas fa-landmark"></i>';
                                break;
                            case 'warning':
                                iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
                                break;
                            case 'biohazard':
                                iconHtml = '<i class="fas fa-biohazard"></i>';
                                break;
                            case 'marker':
                                iconHtml = '<i class="fas fa-map-marker-alt"></i>';
                                break;
                            case 'target':
                                iconHtml = '<i class="fas fa-crosshairs"></i>';
                                break;
                            default:
                                iconHtml = '<i class="fas fa-map-marker-alt"></i>';
                        }
                        
                        // Create a divIcon with the font awesome icon
                        var customIcon = L.divIcon({
                            html: iconHtml,
                            className: 'custom-div-icon',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        
                        // Create marker with the icon
                        var marker = L.marker(latlng, {
                            icon: customIcon,
                            draggable: true
                        }).addTo(map);
                        
                        // Add popup with delete option
                        marker.bindPopup('<div style="text-align:center;">' + 
                                        '<b>' + iconType.replace('-', ' ').toUpperCase() + '</b><br>' +
                                        '<button class="delete-marker">Delete</button>' +
                                        '</div>');
                        
                        // Style the icon with selected color
                        marker.getElement().querySelector('i').style.color = iconColor;
                        
                        // Add delete functionality
                        marker.on('popupopen', function() {
                            setTimeout(function() {
                                document.querySelector('.delete-marker').addEventListener('click', function() {
                                    map.removeLayer(marker);
                                });
                            }, 10);
                        });
                        
                        // Flash confirmation
                        var flashDiv = document.createElement('div');
                        flashDiv.innerHTML = 'Icon added!';
                        flashDiv.style.position = 'fixed';
                        flashDiv.style.left = (e.clientX + 10) + 'px';
                        flashDiv.style.top = (e.clientY - 20) + 'px';
                        flashDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';
                        flashDiv.style.color = 'white';
                        flashDiv.style.padding = '5px 10px';
                        flashDiv.style.borderRadius = '3px';
                        flashDiv.style.zIndex = '10000';
                        document.body.appendChild(flashDiv);
                        
                        setTimeout(function() {
                            document.body.removeChild(flashDiv);
                        }, 1000);
                    } catch (error) {
                        console.error('Error dropping icon:', error);
                    }
                });
                
                console.log('Icon drag and drop set up complete');
            }
            
            // Call this function to set up icon drag and drop
            setupIconDragAndDrop();
            
            // Fix for common measurement issues
            function improveDrawMeasurements() {
                // Create measurement styles
                var measureStyle = document.createElement('style');
                measureStyle.textContent = `
                    .leaflet-popup-content {
                        min-width: 150px;
                    }
                    .measurement-popup {
                        padding: 5px;
                        text-align: center;
                    }
                    .measurement-value {
                        font-weight: bold;
                        font-size: 1.1em;
                    }
                `;
                document.head.appendChild(measureStyle);
                
                // Helper function for measuring polylines
                function measurePolyline(latlngs) {
                    var totalLength = 0;
                    for (var i = 0; i < latlngs.length - 1; i++) {
                        totalLength += latlngs[i].distanceTo(latlngs[i + 1]);
                    }
                    return totalLength;
                }
                
                // Helper function for formatting distances
                function formatDistance(meters) {
                    if (meters >= 1000) {
                        return (meters / 1000).toFixed(2) + ' km';
                    } else {
                        return Math.round(meters) + ' m';
                    }
                }
                
                // Helper function for formatting areas
                function formatArea(sqMeters) {
                    if (sqMeters >= 1000000) {
                        return (sqMeters / 1000000).toFixed(2) + ' km²';
                    } else if (sqMeters >= 10000) {
                        return (sqMeters / 10000).toFixed(2) + ' ha';
                    } else {
                        return Math.round(sqMeters) + ' m²';
                    }
                }
                
                // Make sure the L.Draw.Event listeners add measurements
                map.on(L.Draw.Event.CREATED, function(e) {
                    var layer = e.layer;
                    drawnItems.addLayer(layer);
                    
                    var popup = document.createElement('div');
                    popup.className = 'measurement-popup';
                    var heading = document.createElement('div');
                    heading.style.fontWeight = 'bold';
                    
                    var measurementValue = document.createElement('div');
                    measurementValue.className = 'measurement-value';
                    
                    switch (e.layerType) {
                        case 'polyline':
                            var distance = measurePolyline(layer.getLatLngs());
                            heading.textContent = 'Distance:';
                            measurementValue.textContent = formatDistance(distance);
                            break;
                            
                        case 'polygon':
                        case 'rectangle':
                            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                            heading.textContent = 'Area:';
                            measurementValue.textContent = formatArea(area);
                            break;
                            
                        case 'circle':
                            var radius = layer.getRadius();
                            var area = Math.PI * radius * radius;
                            heading.textContent = 'Circle:';
                            measurementValue.innerHTML = 'Radius: ' + formatDistance(radius) + '<br>Area: ' + formatArea(area);
                            break;
                            
                        case 'marker':
                            var latlng = layer.getLatLng();
                            heading.textContent = 'Coordinates:';
                            measurementValue.textContent = latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6);
                            break;
                    }
                    
                    popup.appendChild(heading);
                    popup.appendChild(measurementValue);
                    
                    // Bind popup to shape
                    layer.bindPopup(popup).openPopup();
                    
                    // Update measurement display panel
                    var measurementDiv = document.getElementById('measurement-results');
                    if (measurementDiv) {
                        measurementDiv.innerHTML = popup.outerHTML;
                    }
                });
            }
            
            // Initialize measurement improvements
            improveDrawMeasurements();
            
            // Set up other tool buttons
            document.getElementById('search-tool').addEventListener('click', function() {
                var panel = document.getElementById('search-container');
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    this.classList.toggle('active');
                }
            });
            
            document.getElementById('filter-tool').addEventListener('click', function() {
                var panel = document.getElementById('filter-container');
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    this.classList.toggle('active');
                }
            });
            
            document.getElementById('export-tool').addEventListener('click', function() {
                var panel = document.getElementById('export-container');
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    this.classList.toggle('active');
                }
            });
            
            document.getElementById('icon-tool').addEventListener('click', function() {
                var panel = document.getElementById('icon-container');
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    this.classList.toggle('active');
                }
            });
            
            document.getElementById('clear-map').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all items from the map?')) {
                    drawnItems.clearLayers();
                    console.log('Map cleared');
                }
            });
            
            console.log('*** DIRECT INITIALIZATION COMPLETED ***');
        });
    </script>
    
    <!-- Other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <!-- Disable the main JS to use our inline solution instead -->
    <!-- <script src="{{ url_for('static', filename='fire-map-pro.js') }}"></script> -->
</body>
</html>