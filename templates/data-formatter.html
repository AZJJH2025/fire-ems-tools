<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Formatter - FireEMS.ai</title>
  
  <!-- Global variables and script registry initialization -->
  <script>
    // Initialize global script registry to prevent duplicate script loading
    window._loadedScripts = window._loadedScripts || {};
    window._componentScripts = window._componentScripts || {};
    
    // Set core flags to manage script loading state
    window.dataFormatterLoaded = false;
    window.dataFormatterInitialized = false;
    
    // Pre-initialize basic formatter state 
    window.formatterState = {
      initialized: false,
      sourceColumns: [],
      sampleData: [],
      isLargeFile: function(filename) {
        if (!filename) return false;
        return filename.toLowerCase().includes('data1g') || (this.fileSize > 1000000);
      },
      getProcessingLimit: function() {
        const filename = this.originalFileName || '';
        return this.isLargeFile(filename) ? 1000 : 100;
      },
      getPreviewSize: function() {
        const filename = this.originalFileName || '';
        return this.isLargeFile(filename) ? 100 : 25;
      }
    };
    
    // Capture URL parameters early for mode detection
    const urlParams = new URLSearchParams(window.location.search);
    const forceNormal = urlParams.get('force_normal') === 'true';
    const forceEmergency = urlParams.get('force_emergency') === 'true';
    
    // Set mode based on URL parameters
    if (forceEmergency) {
      console.log("FORCED EMERGENCY MODE via URL parameter");
      window.emergencyModeForced = true;
    } else if (forceNormal) {
      console.log("FORCED NORMAL MODE via URL parameter");
      window.normalModeForced = true;
    }
    
    // Robust script loader with registry support
    function loadScript(url, options = {}) {
      // Default options
      const opts = Object.assign({
        async: true,
        fallbackUrls: [],
        onSuccess: null,
        onError: null,
        timeout: 5000, // 5 second timeout
        critical: false,
        componentName: null
      }, options);
      
      return new Promise((resolve, reject) => {
        // Check if script is already loaded
        const normalizedUrl = url.split('?')[0]; // Remove query parameters
        
        if (window._loadedScripts[normalizedUrl]) {
          console.log(`Script already loaded (skipping): ${url}`);
          if (opts.onSuccess) opts.onSuccess();
          resolve(normalizedUrl);
          return;
        }
        
        // Also check if any fallback URLs have been loaded
        for (const fallbackUrl of opts.fallbackUrls) {
          const normalizedFallback = fallbackUrl.split('?')[0];
          if (window._loadedScripts[normalizedFallback]) {
            console.log(`Script already loaded via fallback (skipping): ${url} -> ${fallbackUrl}`);
            if (opts.onSuccess) opts.onSuccess();
            resolve(normalizedFallback);
            return;
          }
        }
        
        // Register component name if provided
        if (opts.componentName) {
          if (!window._componentScripts[opts.componentName]) {
            window._componentScripts[opts.componentName] = [];
          }
          if (!window._componentScripts[opts.componentName].includes(normalizedUrl)) {
            window._componentScripts[opts.componentName].push(normalizedUrl);
          }
        }
        
        console.log(`Loading script: ${url}`);
        
        const script = document.createElement('script');
        script.src = url;
        script.async = opts.async;
        
        // Set timeout for script loading
        const timeoutId = setTimeout(() => {
          console.warn(`Script load timeout for ${url}`);
          tryNextFallback(0);
        }, opts.timeout);
        
        script.onload = () => {
          clearTimeout(timeoutId);
          console.log(`Successfully loaded: ${url}`);
          
          // Mark as loaded to prevent duplicates
          window._loadedScripts[normalizedUrl] = true;
          
          if (opts.onSuccess) opts.onSuccess();
          resolve(url);
        };
        
        script.onerror = () => {
          clearTimeout(timeoutId);
          console.warn(`Failed to load: ${url}`);
          tryNextFallback(0);
        };
        
        document.head.appendChild(script);
        
        // Function to try fallback URLs
        function tryNextFallback(index) {
          if (index >= opts.fallbackUrls.length) {
            if (opts.critical && !window.emergencyModeForced) {
              console.error(`Critical script ${url} failed to load, activating emergency mode`);
              loadEmergencyScripts();
            }
            if (opts.onError) opts.onError();
            reject(new Error(`Failed to load script: ${url}`));
            return;
          }
          
          const fallbackUrl = opts.fallbackUrls[index];
          const normalizedFallback = fallbackUrl.split('?')[0];
          
          // Skip if this fallback is already loaded
          if (window._loadedScripts[normalizedFallback]) {
            console.log(`Fallback already loaded (skipping): ${fallbackUrl}`);
            if (opts.onSuccess) opts.onSuccess();
            resolve(fallbackUrl);
            return;
          }
          
          console.log(`Trying fallback ${index + 1}/${opts.fallbackUrls.length}: ${fallbackUrl}`);
          
          const fallbackScript = document.createElement('script');
          fallbackScript.src = fallbackUrl;
          fallbackScript.async = opts.async;
          
          // Register component name with this URL if provided
          if (opts.componentName) {
            if (!window._componentScripts[opts.componentName]) {
              window._componentScripts[opts.componentName] = [];
            }
            if (!window._componentScripts[opts.componentName].includes(normalizedFallback)) {
              window._componentScripts[opts.componentName].push(normalizedFallback);
            }
          }
          
          fallbackScript.onload = () => {
            console.log(`Successfully loaded fallback: ${fallbackUrl}`);
            
            // Mark as loaded to prevent duplicates
            window._loadedScripts[normalizedFallback] = true;
            
            if (opts.onSuccess) opts.onSuccess();
            resolve(fallbackUrl);
          };
          
          fallbackScript.onerror = () => {
            console.warn(`Fallback ${index + 1} failed: ${fallbackUrl}`);
            tryNextFallback(index + 1);
          };
          
          document.head.appendChild(fallbackScript);
        }
      });
    }
    
    // Load emergency mode scripts when needed
    function loadEmergencyScripts() {
      if (window.emergencyScriptsLoading || window.emergencyScriptsLoaded) {
        console.log("Emergency scripts already loading or loaded, skipping duplicate load");
        return;
      }
      
      window.emergencyScriptsLoading = true;
      console.log("Loading emergency scripts");
      
      // Emergency mode active - never attempt to load bundle.js, integration.js, or fix.js directly
      // Instead use only the componentized emergency system
      const emergencyScripts = [
        {
          url: '/app-static/js/data-formatter-core.js',
          fallbackUrls: ['/static/js/data-formatter-core.js', '/direct-static/js/data-formatter-core.js'],
          componentName: 'coreScript',
          critical: true
        },
        {
          url: '/app-static/data-formatter-direct.js',
          fallbackUrls: ['/static/data-formatter-direct.js', '/direct-static/data-formatter-direct.js'],
          componentName: 'formatterDirect',
          critical: true
        },
        {
          url: '/app-static/js/emergency-mode.js',
          fallbackUrls: ['/static/js/emergency-mode.js', '/direct-static/js/emergency-mode.js'],
          componentName: 'emergencyMode',
          critical: true
        }
      ];
      
      // Load all scripts in parallel with proper fallbacks
      Promise.all(
        emergencyScripts.map(script => 
          loadScript(script.url, {
            fallbackUrls: script.fallbackUrls,
            critical: script.critical,
            componentName: script.componentName,
            timeout: 5000
          })
        )
      ).then(() => {
        console.log("All emergency scripts loaded successfully");
        window.emergencyScriptsLoaded = true;
        window.emergencyScriptsLoading = false;
      }).catch(error => {
        console.error("Failed to load some emergency scripts:", error);
        window.emergencyScriptsLoading = false;
      });
    }
    
    // Initialize immediately with component loader
    (function initialize() {
      console.log("Core initialization started");
      
      // Check if we've already initialized
      if (window.dataFormatterInitialized) {
        console.log("Data Formatter already initialized, skipping duplicate initialization");
        return;
      }
      
      window.dataFormatterInitialized = true;
      
      // Check for emergency mode triggers
      const currentFileName = sessionStorage.getItem('currentFileName') || localStorage.getItem('currentFileName');
      const fileSize = parseInt(sessionStorage.getItem('lastFileSize') || '0', 10);
      
      // Store file metadata in formatterState
      if (currentFileName) {
        window.formatterState.originalFileName = currentFileName;
        window.formatterState.fileName = currentFileName;
      }
      
      if (fileSize) {
        window.formatterState.fileSize = fileSize;
      }
      
      // Check for emergency triggers
      const isKnownLargeFile = currentFileName && (
        currentFileName.toLowerCase().includes('data1g') || 
        currentFileName.toLowerCase().includes('large') || 
        currentFileName.toLowerCase().includes('big')
      );
      const isVeryLargeFile = fileSize > 10000000; // 10MB threshold
      
      // Detect emergency conditions
      if (window.emergencyModeForced || isKnownLargeFile || isVeryLargeFile) {
        if (isKnownLargeFile || isVeryLargeFile) {
          console.log(`%c[DataFormatter] Large file detected: "${currentFileName}" (${Math.round(fileSize/1024)}KB)`, 
                     'color: orange; font-weight: bold');
          
          // For known problem files or extremely large ones, force emergency mode
          if (isKnownLargeFile || fileSize > 50000000) { // 50MB threshold for emergency mode
            console.log('%c[DataFormatter] File is extremely large, forcing emergency mode', 
                     'color: red; font-weight: bold');
            window.emergencyModeForced = true;
            window.isEmergencyMode = true;
          }
        }
        
        // Load emergency scripts immediately
        loadEmergencyScripts();
        return;
      }
      
      // Normal initialization - load core script first using registry
      const coreLoaded = 
        window._loadedScripts['/static/js/data-formatter-core.js'] || 
        window._loadedScripts['/app-static/js/data-formatter-core.js'] || 
        window._loadedScripts['/direct-static/js/data-formatter-core.js'];
        
      if (coreLoaded) {
        console.log("Core script already loaded, skipping duplicate load");
        return;
      }
      
      // Load only the core script - it will handle loading all other components
      loadScript('/static/js/data-formatter-core.js', {
        componentName: 'coreScript',
        critical: true,
        fallbackUrls: [
          '/app-static/js/data-formatter-core.js',
          '/direct-static/js/data-formatter-core.js'
        ],
        timeout: 3000,
        onSuccess: () => {
          console.log("Core script loaded successfully");
        },
        onError: () => {
          console.error("Failed to load core script, falling back to emergency mode");
          loadEmergencyScripts();
        }
      });
    })();
    
    // Set up emergency mode check timer
    setTimeout(() => {
      if (!window.dataFormatterLoaded && !window.emergencyScriptsLoaded) {
        console.warn("Script loading timed out, activating emergency mode");
        loadEmergencyScripts();
      }
    }, 5000);
  </script>
  
  <!-- CSS and fallback handling -->
  <link rel="stylesheet" href="{{ url_for('static_handler.serve_static', filename=asset_url('styles.css', 'css')) }}">
  <link rel="stylesheet" href="{{ url_for('static_handler.serve_static', filename=asset_url('data-formatter.css', 'css')) }}">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  
  <!-- Fallback static file loading script -->
  <script>
    function loadCSS(url, fallbackUrl) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = url;
      
      link.onerror = function() {
        console.warn(`Failed to load CSS from ${url}, trying fallback...`);
        // Try first fallback path
        const fallbackLink = document.createElement('link');
        fallbackLink.rel = 'stylesheet';
        fallbackLink.href = fallbackUrl;
        
        fallbackLink.onerror = function() {
          console.error(`Failed to load CSS from fallback path ${fallbackUrl}`);
        };
        
        document.head.appendChild(fallbackLink);
      };
      
      document.head.appendChild(link);
    }
    
    // Apply CSS fallbacks if needed
    setTimeout(function() {
      // Check if styles.css loaded, otherwise try fallback paths
      if (!document.querySelector('link[href*="styles.css"]')) {
        console.warn('styles.css not found, trying fallback path');
        loadCSS('/static/styles.css', '/app-static/styles.css');
      }
      
      // Check if data-formatter.css loaded, otherwise try fallback paths
      if (!document.querySelector('link[href*="data-formatter.css"]')) {
        console.warn('data-formatter.css not found, trying fallback path');
        loadCSS('/static/data-formatter.css', '/app-static/data-formatter.css');
      }
    }, 2000);
  </script>
  
  <!-- Critical inline CSS for basic functionality -->
  <style>
    body {
      font-family: Arial, sans-serif;
      line-height: 1.6;
      color: #333;
      margin: 0;
      padding: 0;
      background-color: #f8f9fa;
    }
    
    .container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
    }
    
    header {
      background-color: #2196f3;
      color: white;
      padding: 20px 0;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    
    header h1 {
      margin: 0;
      font-size: 28px;
    }
    
    header .container {
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    nav ul {
      list-style-type: none;
      padding: 0;
      margin: 0;
      display: flex;
    }
    
    nav li {
      margin-left: 20px;
    }
    
    nav a {
      color: white;
      text-decoration: none;
      font-weight: 500;
      opacity: 0.9;
      transition: opacity 0.2s;
    }
    
    nav a:hover {
      opacity: 1;
    }
    
    .formatter-container {
      background: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-radius: 5px;
      margin-top: 20px;
      padding: 20px;
    }
    
    .formatter-panel {
      margin-bottom: 20px;
    }
    
    .upload-section {
      border: 2px dashed #ccc;
      padding: 20px;
      text-align: center;
      border-radius: 5px;
      margin-bottom: 20px;
      transition: all 0.3s;
    }
    
    .upload-section:hover {
      border-color: #2196f3;
    }
    
    .btn {
      background-color: #2196f3;
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 14px;
      transition: background-color 0.2s;
    }
    
    .btn:hover {
      background-color: #0d8bf2;
    }
    
    .btn:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }
    
    .preview-container {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 10px;
    }
    
    .preview-table {
      width: 100%;
      border-collapse: collapse;
    }
    
    .preview-table th, .preview-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #eee;
    }
    
    .preview-table th {
      background-color: #f8f9fa;
      position: sticky;
      top: 0;
    }
    
    .error-message {
      color: #d32f2f;
      padding: 10px;
      background-color: #ffebee;
      border-radius: 4px;
      display: flex;
      align-items: center;
      margin-bottom: 10px;
    }
    
    .error-message i {
      margin-right: 10px;
      color: #d32f2f;
    }
    
    .loading-container {
      text-align: center;
      padding: 40px;
      color: #666;
    }
    
    .loading-spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #2196f3;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }
    
    .column-mapping-container {
      padding: 20px;
      background: #fff;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      border-radius: 5px;
    }
    
    .transformation-log {
      background-color: #f8f9fa;
      border: 1px solid #eee;
      border-radius: 4px;
      padding: 10px;
      max-height: 200px;
      overflow-y: auto;
      margin-top: 20px;
    }
    
    .log-entry {
      margin-bottom: 5px;
      padding: 4px 8px;
      border-left: 3px solid #2196f3;
      background: white;
      border-radius: 2px;
    }
    
    .log-error {
      border-left-color: #d32f2f;
    }
    
    .log-time {
      color: #666;
      font-size: 0.8em;
      margin-right: 8px;
    }
    
    .log-placeholder {
      color: #999;
      font-style: italic;
    }
    
    .placeholder-message {
      text-align: center;
      padding: 40px;
      color: #999;
    }
    
    .placeholder-message i {
      font-size: 48px;
      margin-bottom: 20px;
      opacity: 0.5;
    }
  </style>
</head>
<body>
  <header>
    <div class="container">
      <h1>Data Formatter</h1>
      <nav>
        <ul>
          <li><a href="/">Home</a></li>
          <li><a href="/tools">Tools</a></li>
          <li><a href="/help">Help</a></li>
        </ul>
      </div>
    </div>
  </header>
  
  <div class="container">
    <div class="formatter-container">
      <div class="tool-selection">
        <label for="target-tool">Format data for:</label>
        <select id="target-tool">
          <option value="response-time">Response Time Analyzer</option>
          <option value="call-density">Call Density Heatmap</option>
          <option value="isochrone">Isochrone Map</option>
          <option value="incident-logger">Incident Logger</option>
        </select>
      </div>
      
      <div class="formatter-panel data-panel">
        <h2>Input Data</h2>
        
        <div class="upload-section">
          <input type="file" id="data-file" accept=".csv,.xls,.xlsx,.json,.xml,.kml,.kmz" class="visually-hidden">
          <button id="upload-btn" class="btn">Select File</button>
          <span id="file-name"></span>
          
          <script>
            document.addEventListener('DOMContentLoaded', function() {
              const uploadBtn = document.getElementById('upload-btn');
              const fileInput = document.getElementById('data-file');
              
              if (uploadBtn && fileInput) {
                uploadBtn.addEventListener('click', function() {
                  fileInput.click();
                });
              } else {
                console.error('Upload button or file input not found');
              }
            });
          </script>
        </div>
        
        <div class="format-selector">
          <label for="input-format">Input Format:</label>
          <select id="input-format">
            <option value="auto">Auto-detect</option>
            <option value="csv">CSV</option>
            <option value="excel">Excel</option>
            <option value="json">JSON</option>
            <option value="xml">XML</option>
            <option value="kml">KML/KMZ</option>
          </select>
        </div>
        
        <!-- Excel Sheet Selection (Hidden by default) -->
        <div id="excel-options" style="display: none; margin-top: 10px;">
          <label for="excel-sheet">Excel Sheet:</label>
          <select id="excel-sheet" style="min-width: 150px;">
            <option value="">Loading sheets...</option>
          </select>
        </div>
      </div>
      
      <div class="preview-container">
        <h3>Input Preview</h3>
        <div id="input-preview" class="data-preview">
          <div class="placeholder-message">
            <i class="fas fa-arrow-up"></i>
            <p>Upload a file to preview</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Column Mapping Container -->
    <div id="column-mapping-container" class="column-mapping-container" style="display: none;">
      <!-- React Column Mapping UI will be rendered here -->
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Loading field mapping interface...</p>
      </div>
    </div>
    
    <!-- Preview Container for transformed data -->
    <div id="preview-container" class="formatter-panel preview-panel" style="display: none;">
      <h2>Transformed Data Preview</h2>
      <div class="loading-container">
        <div class="loading-spinner"></div>
        <p>Processing data...</p>
      </div>
      
      <div id="output-preview"></div>
      
      <div class="buttons-container" style="margin-top: 20px; display: flex; justify-content: space-between;">
        <button id="back-btn" class="btn secondary-btn">Back to Mapping</button>
        
        <div>
          <button id="download-btn" class="btn" disabled>Download Data</button>
          <button id="send-to-tool-btn" class="btn" disabled>Send to Tool</button>
        </div>
      </div>
    </div>
    
    <!-- Transformation Log -->
    <div class="transformation-log">
      <h3>Processing Log</h3>
      <div id="log-container">
        <div class="log-placeholder">No processing activity yet.</div>
      </div>
    </div>
    
    <!-- Main action buttons -->
    <div style="margin-top: 20px; text-align: right;">
      <button id="map-fields-btn" class="btn" disabled>Map Fields</button>
    </div>
  </div>
  
  <!-- Mode switch for testing -->
  <div style="position: fixed; bottom: 10px; right: 10px; background: #f8f9fa; padding: 5px; border-radius: 4px; font-size: 12px; opacity: 0.7;">
    <a href="?force_normal=true" style="margin-right: 10px; color: #333;">Normal Mode</a>
    <a href="?force_emergency=true" style="color: #333;">Emergency Mode</a>
  </div>

  <!-- Load React/Field Mapping UI via component loader -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Map fields button click handler
      const mapFieldsBtn = document.getElementById('map-fields-btn');
      if (mapFieldsBtn) {
        mapFieldsBtn.addEventListener('click', function() {
          // Show mapping panel, hide data panel
          const dataPanel = document.querySelector('.data-panel');
          const mappingContainer = document.getElementById('column-mapping-container');
          
          if (dataPanel) dataPanel.style.display = 'none';
          if (mappingContainer) mappingContainer.style.display = 'block';
          
          // Use FireEMS.DataFormatter to load the React component if available
          if (window.FireEMS && window.FireEMS.DataFormatter) {
            // Load React UI via the component loader
            window.FireEMS.DataFormatter.loadScript(
              "{{ url_for('static_handler.serve_static', filename=asset_url('data-formatter.js', 'react-data-formatter')) }}", 
              {
                componentName: 'reactFieldMapping',
                fallbackUrls: [
                  "/static/js/react-data-formatter/dist/data-formatter.js",
                  "/app-static/data-formatter.js"
                ],
                callback: function() {
                  console.log("React Field Mapping component loaded successfully");
                }
              }
            );
          } else {
            // Fallback to basic mapping if component loader not available
            console.warn("FireEMS.DataFormatter not available, using emergency mapping");
            
            // Try to load emergency scripts
            if (typeof loadEmergencyScripts === 'function') {
              loadEmergencyScripts();
            }
            
            // Wait a bit for emergency scripts to load
            setTimeout(function() {
              if (window.createEmergencyMappingInterface) {
                window.createEmergencyMappingInterface();
              } else {
                console.error("Emergency mapping interface not available");
                // Show error message
                if (mappingContainer) {
                  mappingContainer.innerHTML = `
                    <div class="error-message">
                      <i class="fas fa-exclamation-triangle"></i>
                      <p>Failed to load mapping interface. Please reload the page and try again.</p>
                    </div>
                  `;
                }
              }
            }, 1000);
          }
        });
      }
      
      // Back button click handler 
      const backBtn = document.getElementById('back-btn');
      if (backBtn) {
        backBtn.addEventListener('click', function() {
          // Show mapping panel, hide preview panel
          const previewPanel = document.getElementById('preview-container');
          const mappingContainer = document.getElementById('column-mapping-container');
          
          if (previewPanel) previewPanel.style.display = 'none';
          if (mappingContainer) mappingContainer.style.display = 'block';
        });
      }
      
      // Global utility for showing formatter panels
      window.showFormatterPanels = function(mode = 'preview') {
        const dataPanel = document.querySelector('.data-panel');
        const mappingContainer = document.getElementById('column-mapping-container');
        const previewPanel = document.getElementById('preview-container');
        
        if (mode === 'data') {
          if (dataPanel) dataPanel.style.display = 'block';
          if (mappingContainer) mappingContainer.style.display = 'none';
          if (previewPanel) previewPanel.style.display = 'none';
        } else if (mode === 'mapping') {
          if (dataPanel) dataPanel.style.display = 'none';
          if (mappingContainer) mappingContainer.style.display = 'block';
          if (previewPanel) previewPanel.style.display = 'none';
        } else { // preview
          if (dataPanel) dataPanel.style.display = 'block';
          if (mappingContainer) mappingContainer.style.display = 'none';
          if (previewPanel) previewPanel.style.display = 'block';
        }
      };
      
      // Emergency mode CSV processor
      if (document.getElementById('data-file')) {
        document.getElementById('data-file').addEventListener('change', function(event) {
          if (event.target.files && event.target.files.length > 0) {
            const file = event.target.files[0];
            
            // Update UI with filename
            const fileNameDisplay = document.getElementById('file-name');
            if (fileNameDisplay) {
              fileNameDisplay.textContent = file.name;
            }
            
            // Enable mapping button
            const mapFieldsBtn = document.getElementById('map-fields-btn');
            if (mapFieldsBtn) {
              mapFieldsBtn.disabled = false;
            }
            
            // Initialize file preview if FireEMS.DataFormatter is not available
            if (!(window.FireEMS && window.FireEMS.DataFormatter)) {
              processCSVFile(file);
            }
          }
        });
      }
      
      // Simple CSV processor for emergencies
      function processCSVFile(file) {
        if (!file) return;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          const text = e.target.result;
          
          try {
            // Simple CSV parsing
            const lines = text.split('\n');
            const headers = lines[0].split(',').map(h => h.trim());
            
            if (headers.length === 0) {
              showErrorMessage("No columns detected in CSV file");
              return;
            }
            
            // Store column names in global state
            if (window.formatterState) {
              window.formatterState.sourceColumns = headers;
              window.formatterState.originalData = true;
              
              // Parse rows for sample data
              const sampleData = [];
              
              // Determine if this is a large file
              const filename = file.name || '';
              const isLargeFile = 
                filename.toLowerCase().includes('data1g') || 
                filename.toLowerCase().includes('large') ||
                file.size > 1000000; // 1MB
              
              // CRITICAL FIX: Store the filename in formatterState for consistent detection
              window.formatterState.originalFileName = filename;
              
              // Process a substantial number of records
              const maxRowsToProcess = isLargeFile ? 1000 : 100;
              
              console.log(`Emergency CSV parser processing ${maxRowsToProcess} rows (large file: ${isLargeFile})`);
              
              for (let i = 1; i < Math.min(lines.length, maxRowsToProcess + 1); i++) {
                if (lines[i].trim()) {
                  const values = lines[i].split(',');
                  const row = {};
                  
                  headers.forEach((header, index) => {
                    row[header] = values[index] ? values[index].trim() : '';
                  });
                  
                  sampleData.push(row);
                }
              }
              
              window.formatterState.sampleData = sampleData;
              
              // Store file size for future reference
              window.formatterState.fileSize = file.size;
              
              // Update UI
              updatePreview(headers, sampleData);
              
              // Log success message
              const logContainer = document.getElementById('log-container');
              if (logContainer) {
                const timestamp = new Date().toLocaleTimeString();
                logContainer.innerHTML = `<div class="log-entry log-info">
                  <span class="log-time">${timestamp}</span> 
                  File processed in emergency mode. ${headers.length} columns detected.
                </div>`;
              }
            }
          } catch (error) {
            console.error("CSV processing error:", error);
            showErrorMessage("Error processing CSV: " + error.message);
          }
        };
        
        reader.onerror = function() {
          showErrorMessage("Error reading file");
        };
        
        reader.readAsText(file);
      }
      
      function updatePreview(headers, rows) {
        const previewContainer = document.getElementById('input-preview');
        if (!previewContainer) return;
        
        let html = '<table class="preview-table"><thead><tr>';
        
        // Add headers
        headers.forEach(header => {
          html += `<th>${header}</th>`;
        });
        
        html += '</tr></thead><tbody>';
        
        // Add rows (limit for large datasets)
        const maxRows = rows.length > 100 ? 100 : rows.length;
        for (let i = 0; i < maxRows; i++) {
          html += '<tr>';
          headers.forEach(header => {
            html += `<td>${rows[i][header] || ''}</td>`;
          });
          html += '</tr>';
        }
        
        html += '</tbody></table>';
        
        // Add message if not showing all rows
        if (maxRows < rows.length) {
          html += `<div style="margin-top: 10px; font-style: italic;">
            Showing ${maxRows} of ${rows.length} total records.
          </div>`;
        }
        
        previewContainer.innerHTML = html;
      }
      
      function showErrorMessage(message) {
        const previewContainer = document.getElementById('input-preview');
        if (previewContainer) {
          previewContainer.innerHTML = `
            <div class="error-message">
              <i class="fas fa-exclamation-triangle"></i>
              <p>${message}</p>
            </div>
          `;
        }
      }
    });
  </script>
</body>
</html>