var zr=Object.defineProperty;var Vr=(t,s,n)=>s in t?zr(t,s,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[s]=n;var ut=(t,s,n)=>Vr(t,typeof s!="symbol"?s+"":s,n);import{r as A,g as vt,a as jt,u as Wt,j as e,s as $e,c as at,b as Tt,m as St,d as ve,e as kt,f as fr,h as me,i as Br,_ as xr,k as dt,l as He,B as v,t as Kt,n as Ur,C as Ve,o as Me,p as Hr,q as Wr,v as yr,w as Le,R as Ze,x as Oe,y as Yr,G as Gr,z as qr,A as Jr,D as Kr}from"./index-Bt3dcriC.js";import{U as Xt,T as ze,A as Xr,a as Zt,E as br,D as Zr,b as It}from"./dataTransformer-Dp9G3TRj.js";import{T as y,c as ce,P as ge,u as Yt}from"./Typography-BU-oQiA3.js";import{u as Qt,a as Qr,c as es,b as ts,S as rs,d as ss,G as pe,A as de,D as Qe,e as et,f as tt,F as Je,C as le,g as rt,I as De,L as Be,h as Ee,i as ke,j as Fe,k as Nt,l as vr}from"./Toolbar-Dr4G8sz0.js";import{F as Ue,I as We,S as Ye,M as oe,D as xe,T as be,a as Re,b as Et,c as _e,d as ns,e as jr,f as os,E as as}from"./jspdf.es.min-Bih6lPMF.js";import{u as is,a as ls,B as re}from"./Button-CZFs-enp.js";import{S as cs,a as Tr}from"./Save-DSVZ3eu7.js";import{C as ds,S as it,F as _t}from"./Business-CqcaLv51.js";import{F as Sr,T as ht,a as gt,b as Ne,c as Ce,d as ft,S as nt,L as us,e as Lt,C as zt,f as ps,R as xt,P as Er,A as ms,B as hs}from"./PictureAsPdf-CQaMdbcr.js";import{C as Xe}from"./CheckCircle-cJ2-ig3U.js";import{D as lt}from"./Delete-vF7idAtH.js";import{A as Fr,a as Cr,E as Ft,b as Dr,W as wr,C as Ir}from"./Warning-D_t0tvjP.js";import{E as _r}from"./Error-CrJprbIT.js";import{C as gs}from"./Close-DpWa5ofH.js";import{C as Ct,a as Dt}from"./CardContent-BYWpM5qJ.js";import{C as fs,D as xs,S as ys,a as bs,b as vs}from"./Download-BYf7oZq0.js";import{T as js}from"./TableChart-C0Pne_c_.js";import{M as er}from"./Map-Cjbn29dR.js";import{T as Ts}from"./Timeline-CbrYfqA2.js";const $r=t=>{const s=A.useRef({});return A.useEffect(()=>{s.current=t}),s.current};function Ss(t){return vt("MuiAlertTitle",t)}jt("MuiAlertTitle",["root"]);const Es=t=>{const{classes:s}=t;return Tt({root:["root"]},Ss,s)},Fs=$e(y,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(t,s)=>s.root})(St(({theme:t})=>({fontWeight:t.typography.fontWeightMedium,marginTop:-2}))),Cs=A.forwardRef(function(s,n){const r=Wt({props:s,name:"MuiAlertTitle"}),{className:o,...a}=r,l=r,p=Es(l);return e.jsx(Fs,{gutterBottom:!0,component:"div",ownerState:l,ref:n,className:at(p.root,o),...a})});function Ds(t){const{badgeContent:s,invisible:n=!1,max:r=99,showZero:o=!1}=t,a=$r({badgeContent:s,max:r});let l=n;n===!1&&s===0&&!o&&(l=!0);const{badgeContent:p,max:u=r}=l?a:t,d=p&&Number(p)>u?`${u}+`:p;return{badgeContent:p,invisible:l,max:u,displayValue:d}}function ws(t){return vt("MuiBadge",t)}const Pe=jt("MuiBadge",["root","badge","dot","standard","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft","invisible","colorError","colorInfo","colorPrimary","colorSecondary","colorSuccess","colorWarning","overlapRectangular","overlapCircular","anchorOriginTopLeftCircular","anchorOriginTopLeftRectangular","anchorOriginTopRightCircular","anchorOriginTopRightRectangular","anchorOriginBottomLeftCircular","anchorOriginBottomLeftRectangular","anchorOriginBottomRightCircular","anchorOriginBottomRightRectangular"]),$t=10,At=4,Is=t=>{const{color:s,anchorOrigin:n,invisible:r,overlap:o,variant:a,classes:l={}}=t,p={root:["root"],badge:["badge",a,r&&"invisible",`anchorOrigin${ve(n.vertical)}${ve(n.horizontal)}`,`anchorOrigin${ve(n.vertical)}${ve(n.horizontal)}${ve(o)}`,`overlap${ve(o)}`,s!=="default"&&`color${ve(s)}`]};return Tt(p,ws,l)},_s=$e("span",{name:"MuiBadge",slot:"Root",overridesResolver:(t,s)=>s.root})({position:"relative",display:"inline-flex",verticalAlign:"middle",flexShrink:0}),$s=$e("span",{name:"MuiBadge",slot:"Badge",overridesResolver:(t,s)=>{const{ownerState:n}=t;return[s.badge,s[n.variant],s[`anchorOrigin${ve(n.anchorOrigin.vertical)}${ve(n.anchorOrigin.horizontal)}${ve(n.overlap)}`],n.color!=="default"&&s[`color${ve(n.color)}`],n.invisible&&s.invisible]}})(St(({theme:t})=>({display:"flex",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",alignContent:"center",alignItems:"center",position:"absolute",boxSizing:"border-box",fontFamily:t.typography.fontFamily,fontWeight:t.typography.fontWeightMedium,fontSize:t.typography.pxToRem(12),minWidth:$t*2,lineHeight:1,padding:"0 6px",height:$t*2,borderRadius:$t,zIndex:1,transition:t.transitions.create("transform",{easing:t.transitions.easing.easeInOut,duration:t.transitions.duration.enteringScreen}),variants:[...Object.entries(t.palette).filter(kt(["contrastText"])).map(([s])=>({props:{color:s},style:{backgroundColor:(t.vars||t).palette[s].main,color:(t.vars||t).palette[s].contrastText}})),{props:{variant:"dot"},style:{borderRadius:At,height:At*2,minWidth:At*2,padding:0}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="top"&&s.anchorOrigin.horizontal==="right"&&s.overlap==="rectangular",style:{top:0,right:0,transform:"scale(1) translate(50%, -50%)",transformOrigin:"100% 0%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(50%, -50%)"}}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="bottom"&&s.anchorOrigin.horizontal==="right"&&s.overlap==="rectangular",style:{bottom:0,right:0,transform:"scale(1) translate(50%, 50%)",transformOrigin:"100% 100%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(50%, 50%)"}}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="top"&&s.anchorOrigin.horizontal==="left"&&s.overlap==="rectangular",style:{top:0,left:0,transform:"scale(1) translate(-50%, -50%)",transformOrigin:"0% 0%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(-50%, -50%)"}}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="bottom"&&s.anchorOrigin.horizontal==="left"&&s.overlap==="rectangular",style:{bottom:0,left:0,transform:"scale(1) translate(-50%, 50%)",transformOrigin:"0% 100%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(-50%, 50%)"}}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="top"&&s.anchorOrigin.horizontal==="right"&&s.overlap==="circular",style:{top:"14%",right:"14%",transform:"scale(1) translate(50%, -50%)",transformOrigin:"100% 0%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(50%, -50%)"}}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="bottom"&&s.anchorOrigin.horizontal==="right"&&s.overlap==="circular",style:{bottom:"14%",right:"14%",transform:"scale(1) translate(50%, 50%)",transformOrigin:"100% 100%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(50%, 50%)"}}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="top"&&s.anchorOrigin.horizontal==="left"&&s.overlap==="circular",style:{top:"14%",left:"14%",transform:"scale(1) translate(-50%, -50%)",transformOrigin:"0% 0%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(-50%, -50%)"}}},{props:({ownerState:s})=>s.anchorOrigin.vertical==="bottom"&&s.anchorOrigin.horizontal==="left"&&s.overlap==="circular",style:{bottom:"14%",left:"14%",transform:"scale(1) translate(-50%, 50%)",transformOrigin:"0% 100%",[`&.${Pe.invisible}`]:{transform:"scale(0) translate(-50%, 50%)"}}},{props:{invisible:!0},style:{transition:t.transitions.create("transform",{easing:t.transitions.easing.easeInOut,duration:t.transitions.duration.leavingScreen})}}]})));function tr(t){return{vertical:(t==null?void 0:t.vertical)??"top",horizontal:(t==null?void 0:t.horizontal)??"right"}}const As=A.forwardRef(function(s,n){const r=Wt({props:s,name:"MuiBadge"}),{anchorOrigin:o,className:a,classes:l,component:p,components:u={},componentsProps:d={},children:m,overlap:x="rectangular",color:T="default",invisible:E=!1,max:_=99,badgeContent:C,slots:B,slotProps:F,showZero:U=!1,variant:P="standard",...S}=r,{badgeContent:H,invisible:Y,max:G,displayValue:i}=Ds({max:_,invisible:E,badgeContent:C,showZero:U}),c=$r({anchorOrigin:tr(o),color:T,overlap:x,variant:P,badgeContent:C}),h=Y||H==null&&P!=="dot",{color:D=T,overlap:k=x,anchorOrigin:W,variant:X=P}=h?c:r,ae=tr(W),M=X!=="dot"?i:void 0,N={...r,badgeContent:H,invisible:h,max:G,displayValue:M,showZero:U,anchorOrigin:ae,color:D,overlap:k,variant:X},ee=Is(N),f=(B==null?void 0:B.root)??u.Root??_s,L=(B==null?void 0:B.badge)??u.Badge??$s,R=(F==null?void 0:F.root)??d.root,V=(F==null?void 0:F.badge)??d.badge,w=Qt({elementType:f,externalSlotProps:R,externalForwardedProps:S,additionalProps:{ref:n,as:p},ownerState:N,className:at(R==null?void 0:R.className,ee.root,a)}),j=Qt({elementType:L,externalSlotProps:V,ownerState:N,className:at(ee.badge,V==null?void 0:V.className)});return e.jsxs(f,{...w,children:[m,e.jsx(L,{...j,children:M})]})}),Rs=ce(e.jsx("path",{d:"M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8z"})),Ms=ce(e.jsx("path",{d:"M8.465 8.465C9.37 7.56 10.62 7 12 7C14.76 7 17 9.24 17 12C17 13.38 16.44 14.63 15.535 15.535C14.63 16.44 13.38 17 12 17C9.24 17 7 14.76 7 12C7 10.62 7.56 9.37 8.465 8.465Z"})),Os=$e("span",{shouldForwardProp:fr})({position:"relative",display:"flex"}),Ps=$e(Rs)({transform:"scale(1)"}),ks=$e(Ms)(St(({theme:t})=>({left:0,position:"absolute",transform:"scale(0)",transition:t.transitions.create("transform",{easing:t.transitions.easing.easeIn,duration:t.transitions.duration.shortest}),variants:[{props:{checked:!0},style:{transform:"scale(1)",transition:t.transitions.create("transform",{easing:t.transitions.easing.easeOut,duration:t.transitions.duration.shortest})}}]})));function Ar(t){const{checked:s=!1,classes:n={},fontSize:r}=t,o={...t,checked:s};return e.jsxs(Os,{className:n.root,ownerState:o,children:[e.jsx(Ps,{fontSize:r,className:n.background,ownerState:o}),e.jsx(ks,{fontSize:r,className:n.dot,ownerState:o})]})}const Rr=A.createContext(void 0);function Ns(){return A.useContext(Rr)}function Ls(t){return vt("MuiRadio",t)}const rr=jt("MuiRadio",["root","checked","disabled","colorPrimary","colorSecondary","sizeSmall"]),zs=t=>{const{classes:s,color:n,size:r}=t,o={root:["root",`color${ve(n)}`,r!=="medium"&&`size${ve(r)}`]};return{...s,...Tt(o,Ls,s)}},Vs=$e(rs,{shouldForwardProp:t=>fr(t)||t==="classes",name:"MuiRadio",slot:"Root",overridesResolver:(t,s)=>{const{ownerState:n}=t;return[s.root,n.size!=="medium"&&s[`size${ve(n.size)}`],s[`color${ve(n.color)}`]]}})(St(({theme:t})=>({color:(t.vars||t).palette.text.secondary,[`&.${rr.disabled}`]:{color:(t.vars||t).palette.action.disabled},variants:[{props:{color:"default",disabled:!1,disableRipple:!1},style:{"&:hover":{backgroundColor:t.vars?`rgba(${t.vars.palette.action.activeChannel} / ${t.vars.palette.action.hoverOpacity})`:me(t.palette.action.active,t.palette.action.hoverOpacity)}}},...Object.entries(t.palette).filter(kt()).map(([s])=>({props:{color:s,disabled:!1,disableRipple:!1},style:{"&:hover":{backgroundColor:t.vars?`rgba(${t.vars.palette[s].mainChannel} / ${t.vars.palette.action.hoverOpacity})`:me(t.palette[s].main,t.palette.action.hoverOpacity)}}})),...Object.entries(t.palette).filter(kt()).map(([s])=>({props:{color:s,disabled:!1},style:{[`&.${rr.checked}`]:{color:(t.vars||t).palette[s].main}}})),{props:{disableRipple:!1},style:{"&:hover":{"@media (hover: none)":{backgroundColor:"transparent"}}}}]})));function Bs(t,s){return typeof s=="object"&&s!==null?t===s:String(t)===String(s)}const Us=e.jsx(Ar,{checked:!0}),Hs=e.jsx(Ar,{}),pt=A.forwardRef(function(s,n){const r=Wt({props:s,name:"MuiRadio"}),{checked:o,checkedIcon:a=Us,color:l="primary",icon:p=Hs,name:u,onChange:d,size:m="medium",className:x,disabled:T,disableRipple:E=!1,slots:_={},slotProps:C={},inputProps:B,...F}=r,U=Qr();let P=T;U&&typeof P>"u"&&(P=U.disabled),P??(P=!1);const S={...r,disabled:P,disableRipple:E,color:l,size:m},H=zs(S),Y=Ns();let G=o;const i=es(d,Y&&Y.onChange);let c=u;Y&&(typeof G>"u"&&(G=Bs(Y.value,r.value)),typeof c>"u"&&(c=Y.name));const h=C.input??B,[D,k]=ts("root",{ref:n,elementType:Vs,className:at(H.root,x),shouldForwardComponentProp:!0,externalForwardedProps:{slots:_,slotProps:C,...F},getSlotProps:W=>({...W,onChange:(X,...ae)=>{var M;(M=W.onChange)==null||M.call(W,X,...ae),i(X,...ae)}}),ownerState:S,additionalProps:{type:"radio",icon:A.cloneElement(p,{fontSize:p.props.fontSize??m}),checkedIcon:A.cloneElement(a,{fontSize:a.props.fontSize??m}),disabled:P,name:c,checked:G,slots:_,slotProps:{input:typeof h=="function"?h(S):h}}});return e.jsx(D,{...k,classes:H})});function Ws(t){return vt("MuiRadioGroup",t)}jt("MuiRadioGroup",["root","row","error"]);const Ys=t=>{const{classes:s,row:n,error:r}=t;return Tt({root:["root",n&&"row",r&&"error"]},Ws,s)},Gs=A.forwardRef(function(s,n){const{actions:r,children:o,className:a,defaultValue:l,name:p,onChange:u,value:d,...m}=s,x=A.useRef(null),T=Ys(s),[E,_]=ss({controlled:d,default:l,name:"RadioGroup"});A.useImperativeHandle(r,()=>({focus:()=>{let U=x.current.querySelector("input:not(:disabled):checked");U||(U=x.current.querySelector("input:not(:disabled)")),U&&U.focus()}}),[]);const C=is(n,x),B=ls(p),F=A.useMemo(()=>({name:B,onChange(U){_(U.target.value),u&&u(U,U.target.value)},value:E}),[B,u,_,E]);return e.jsx(Rr.Provider,{value:F,children:e.jsx(Sr,{role:"radiogroup",ref:C,className:at(T.root,a),...m,children:o})})}),Gt=ce(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}));var mt={exports:{}};/* @license
Papa Parse
v5.5.2
https://github.com/mholt/PapaParse
License: MIT
*/var qs=mt.exports,sr;function Js(){return sr||(sr=1,function(t,s){((n,r)=>{t.exports=r()})(qs,function n(){var r=typeof self<"u"?self:typeof window<"u"?window:r!==void 0?r:{},o,a=!r.document&&!!r.postMessage,l=r.IS_PAPA_WORKER||!1,p={},u=0,d={};function m(i){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(c){var h=H(c);h.chunkSize=parseInt(h.chunkSize),c.step||c.chunk||(h.chunkSize=null),this._handle=new C(h),(this._handle.streamer=this)._config=h}).call(this,i),this.parseChunk=function(c,h){var D=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<D){let W=this._config.newline;W||(k=this._config.quoteChar||'"',W=this._handle.guessLineEndings(c,k)),c=[...c.split(W).slice(D)].join(W)}this.isFirstChunk&&G(this._config.beforeFirstChunk)&&(k=this._config.beforeFirstChunk(c))!==void 0&&(c=k),this.isFirstChunk=!1,this._halted=!1;var D=this._partialLine+c,k=(this._partialLine="",this._handle.parse(D,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(c=k.meta.cursor,D=(this._finished||(this._partialLine=D.substring(c-this._baseIndex),this._baseIndex=c),k&&k.data&&(this._rowCount+=k.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),l)r.postMessage({results:k,workerId:d.WORKER_ID,finished:D});else if(G(this._config.chunk)&&!h){if(this._config.chunk(k,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=k=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(k.data),this._completeResults.errors=this._completeResults.errors.concat(k.errors),this._completeResults.meta=k.meta),this._completed||!D||!G(this._config.complete)||k&&k.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),D||k&&k.meta.paused||this._nextChunk(),k}this._halted=!0},this._sendError=function(c){G(this._config.error)?this._config.error(c):l&&this._config.error&&r.postMessage({workerId:d.WORKER_ID,error:c,finished:!1})}}function x(i){var c;(i=i||{}).chunkSize||(i.chunkSize=d.RemoteChunkSize),m.call(this,i),this._nextChunk=a?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(h){this._input=h,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(c=new XMLHttpRequest,this._config.withCredentials&&(c.withCredentials=this._config.withCredentials),a||(c.onload=Y(this._chunkLoaded,this),c.onerror=Y(this._chunkError,this)),c.open(this._config.downloadRequestBody?"POST":"GET",this._input,!a),this._config.downloadRequestHeaders){var h,D=this._config.downloadRequestHeaders;for(h in D)c.setRequestHeader(h,D[h])}var k;this._config.chunkSize&&(k=this._start+this._config.chunkSize-1,c.setRequestHeader("Range","bytes="+this._start+"-"+k));try{c.send(this._config.downloadRequestBody)}catch(W){this._chunkError(W.message)}a&&c.status===0&&this._chunkError()}},this._chunkLoaded=function(){c.readyState===4&&(c.status<200||400<=c.status?this._chunkError():(this._start+=this._config.chunkSize||c.responseText.length,this._finished=!this._config.chunkSize||this._start>=(h=>(h=h.getResponseHeader("Content-Range"))!==null?parseInt(h.substring(h.lastIndexOf("/")+1)):-1)(c),this.parseChunk(c.responseText)))},this._chunkError=function(h){h=c.statusText||h,this._sendError(new Error(h))}}function T(i){(i=i||{}).chunkSize||(i.chunkSize=d.LocalChunkSize),m.call(this,i);var c,h,D=typeof FileReader<"u";this.stream=function(k){this._input=k,h=k.slice||k.webkitSlice||k.mozSlice,D?((c=new FileReader).onload=Y(this._chunkLoaded,this),c.onerror=Y(this._chunkError,this)):c=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var k=this._input,W=(this._config.chunkSize&&(W=Math.min(this._start+this._config.chunkSize,this._input.size),k=h.call(k,this._start,W)),c.readAsText(k,this._config.encoding));D||this._chunkLoaded({target:{result:W}})},this._chunkLoaded=function(k){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(k.target.result)},this._chunkError=function(){this._sendError(c.error)}}function E(i){var c;m.call(this,i=i||{}),this.stream=function(h){return c=h,this._nextChunk()},this._nextChunk=function(){var h,D;if(!this._finished)return h=this._config.chunkSize,c=h?(D=c.substring(0,h),c.substring(h)):(D=c,""),this._finished=!c,this.parseChunk(D)}}function _(i){m.call(this,i=i||{});var c=[],h=!0,D=!1;this.pause=function(){m.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){m.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(k){this._input=k,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){D&&c.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),c.length?this.parseChunk(c.shift()):h=!0},this._streamData=Y(function(k){try{c.push(typeof k=="string"?k:k.toString(this._config.encoding)),h&&(h=!1,this._checkIsFinished(),this.parseChunk(c.shift()))}catch(W){this._streamError(W)}},this),this._streamError=Y(function(k){this._streamCleanUp(),this._sendError(k)},this),this._streamEnd=Y(function(){this._streamCleanUp(),D=!0,this._streamData("")},this),this._streamCleanUp=Y(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function C(i){var c,h,D,k,W=Math.pow(2,53),X=-W,ae=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,M=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,N=this,ee=0,f=0,L=!1,R=!1,V=[],w={data:[],errors:[],meta:{}};function j($){return i.skipEmptyLines==="greedy"?$.join("").trim()==="":$.length===1&&$[0].length===0}function I(){if(w&&D&&(K("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),D=!1),i.skipEmptyLines&&(w.data=w.data.filter(function(g){return!j(g)})),J()){let g=function(z,q){G(i.transformHeader)&&(z=i.transformHeader(z,q)),V.push(z)};if(w)if(Array.isArray(w.data[0])){for(var $=0;J()&&$<w.data.length;$++)w.data[$].forEach(g);w.data.splice(0,1)}else w.data.forEach(g)}function O(g,z){for(var q=i.header?{}:[],Z=0;Z<g.length;Z++){var ne=Z,te=g[Z],te=((je,Q)=>(ue=>(i.dynamicTypingFunction&&i.dynamicTyping[ue]===void 0&&(i.dynamicTyping[ue]=i.dynamicTypingFunction(ue)),(i.dynamicTyping[ue]||i.dynamicTyping)===!0))(je)?Q==="true"||Q==="TRUE"||Q!=="false"&&Q!=="FALSE"&&((ue=>{if(ae.test(ue)&&(ue=parseFloat(ue),X<ue&&ue<W))return 1})(Q)?parseFloat(Q):M.test(Q)?new Date(Q):Q===""?null:Q):Q)(ne=i.header?Z>=V.length?"__parsed_extra":V[Z]:ne,te=i.transform?i.transform(te,ne):te);ne==="__parsed_extra"?(q[ne]=q[ne]||[],q[ne].push(te)):q[ne]=te}return i.header&&(Z>V.length?K("FieldMismatch","TooManyFields","Too many fields: expected "+V.length+" fields but parsed "+Z,f+z):Z<V.length&&K("FieldMismatch","TooFewFields","Too few fields: expected "+V.length+" fields but parsed "+Z,f+z)),q}var b;w&&(i.header||i.dynamicTyping||i.transform)&&(b=1,!w.data.length||Array.isArray(w.data[0])?(w.data=w.data.map(O),b=w.data.length):w.data=O(w.data,0),i.header&&w.meta&&(w.meta.fields=V),f+=b)}function J(){return i.header&&V.length===0}function K($,O,b,g){$={type:$,code:O,message:b},g!==void 0&&($.row=g),w.errors.push($)}G(i.step)&&(k=i.step,i.step=function($){w=$,J()?I():(I(),w.data.length!==0&&(ee+=$.data.length,i.preview&&ee>i.preview?h.abort():(w.data=w.data[0],k(w,N))))}),this.parse=function($,O,b){var g=i.quoteChar||'"',g=(i.newline||(i.newline=this.guessLineEndings($,g)),D=!1,i.delimiter?G(i.delimiter)&&(i.delimiter=i.delimiter($),w.meta.delimiter=i.delimiter):((g=((z,q,Z,ne,te)=>{var je,Q,ue,Se;te=te||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var ie=0;ie<te.length;ie++){for(var se,ye=te[ie],he=0,we=0,fe=0,Te=(ue=void 0,new F({comments:ne,delimiter:ye,newline:q,preview:10}).parse(z)),Ae=0;Ae<Te.data.length;Ae++)Z&&j(Te.data[Ae])?fe++:(se=Te.data[Ae].length,we+=se,ue===void 0?ue=se:0<se&&(he+=Math.abs(se-ue),ue=se));0<Te.data.length&&(we/=Te.data.length-fe),(Q===void 0||he<=Q)&&(Se===void 0||Se<we)&&1.99<we&&(Q=he,je=ye,Se=we)}return{successful:!!(i.delimiter=je),bestDelimiter:je}})($,i.newline,i.skipEmptyLines,i.comments,i.delimitersToGuess)).successful?i.delimiter=g.bestDelimiter:(D=!0,i.delimiter=d.DefaultDelimiter),w.meta.delimiter=i.delimiter),H(i));return i.preview&&i.header&&g.preview++,c=$,h=new F(g),w=h.parse(c,O,b),I(),L?{meta:{paused:!0}}:w||{meta:{paused:!1}}},this.paused=function(){return L},this.pause=function(){L=!0,h.abort(),c=G(i.chunk)?"":c.substring(h.getCharIndex())},this.resume=function(){N.streamer._halted?(L=!1,N.streamer.parseChunk(c,!0)):setTimeout(N.resume,3)},this.aborted=function(){return R},this.abort=function(){R=!0,h.abort(),w.meta.aborted=!0,G(i.complete)&&i.complete(w),c=""},this.guessLineEndings=function(z,g){z=z.substring(0,1048576);var g=new RegExp(B(g)+"([^]*?)"+B(g),"gm"),b=(z=z.replace(g,"")).split("\r"),g=z.split(`
`),z=1<g.length&&g[0].length<b[0].length;if(b.length===1||z)return`
`;for(var q=0,Z=0;Z<b.length;Z++)b[Z][0]===`
`&&q++;return q>=b.length/2?`\r
`:"\r"}}function B(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function F(i){var c=(i=i||{}).delimiter,h=i.newline,D=i.comments,k=i.step,W=i.preview,X=i.fastMode,ae=null,M=!1,N=i.quoteChar==null?'"':i.quoteChar,ee=N;if(i.escapeChar!==void 0&&(ee=i.escapeChar),(typeof c!="string"||-1<d.BAD_DELIMITERS.indexOf(c))&&(c=","),D===c)throw new Error("Comment character same as delimiter");D===!0?D="#":(typeof D!="string"||-1<d.BAD_DELIMITERS.indexOf(D))&&(D=!1),h!==`
`&&h!=="\r"&&h!==`\r
`&&(h=`
`);var f=0,L=!1;this.parse=function(R,V,w){if(typeof R!="string")throw new Error("Input must be a string");var j=R.length,I=c.length,J=h.length,K=D.length,$=G(k),O=[],b=[],g=[],z=f=0;if(!R)return he();if(X||X!==!1&&R.indexOf(N)===-1){for(var q=R.split(h),Z=0;Z<q.length;Z++){if(g=q[Z],f+=g.length,Z!==q.length-1)f+=h.length;else if(w)return he();if(!D||g.substring(0,K)!==D){if($){if(O=[],Se(g.split(c)),we(),L)return he()}else Se(g.split(c));if(W&&W<=Z)return O=O.slice(0,W),he(!0)}}return he()}for(var ne=R.indexOf(c,f),te=R.indexOf(h,f),je=new RegExp(B(ee)+B(N),"g"),Q=R.indexOf(N,f);;)if(R[f]===N)for(Q=f,f++;;){if((Q=R.indexOf(N,Q+1))===-1)return w||b.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:O.length,index:f}),se();if(Q===j-1)return se(R.substring(f,Q).replace(je,N));if(N===ee&&R[Q+1]===ee)Q++;else if(N===ee||Q===0||R[Q-1]!==ee){ne!==-1&&ne<Q+1&&(ne=R.indexOf(c,Q+1));var ue=ie((te=te!==-1&&te<Q+1?R.indexOf(h,Q+1):te)===-1?ne:Math.min(ne,te));if(R.substr(Q+1+ue,I)===c){g.push(R.substring(f,Q).replace(je,N)),R[f=Q+1+ue+I]!==N&&(Q=R.indexOf(N,f)),ne=R.indexOf(c,f),te=R.indexOf(h,f);break}if(ue=ie(te),R.substring(Q+1+ue,Q+1+ue+J)===h){if(g.push(R.substring(f,Q).replace(je,N)),ye(Q+1+ue+J),ne=R.indexOf(c,f),Q=R.indexOf(N,f),$&&(we(),L))return he();if(W&&O.length>=W)return he(!0);break}b.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:O.length,index:f}),Q++}}else if(D&&g.length===0&&R.substring(f,f+K)===D){if(te===-1)return he();f=te+J,te=R.indexOf(h,f),ne=R.indexOf(c,f)}else if(ne!==-1&&(ne<te||te===-1))g.push(R.substring(f,ne)),f=ne+I,ne=R.indexOf(c,f);else{if(te===-1)break;if(g.push(R.substring(f,te)),ye(te+J),$&&(we(),L))return he();if(W&&O.length>=W)return he(!0)}return se();function Se(fe){O.push(fe),z=f}function ie(fe){var Te=0;return Te=fe!==-1&&(fe=R.substring(Q+1,fe))&&fe.trim()===""?fe.length:Te}function se(fe){return w||(fe===void 0&&(fe=R.substring(f)),g.push(fe),f=j,Se(g),$&&we()),he()}function ye(fe){f=fe,Se(g),g=[],te=R.indexOf(h,f)}function he(fe){if(i.header&&!V&&O.length&&!M){var Te=O[0],Ae={},wt=new Set(Te);let qt=!1;for(let Ge=0;Ge<Te.length;Ge++){let Ie=Te[Ge];if(Ae[Ie=G(i.transformHeader)?i.transformHeader(Ie,Ge):Ie]){let st,Jt=Ae[Ie];for(;st=Ie+"_"+Jt,Jt++,wt.has(st););wt.add(st),Te[Ge]=st,Ae[Ie]++,qt=!0,(ae=ae===null?{}:ae)[st]=Ie}else Ae[Ie]=1,Te[Ge]=Ie;wt.add(Ie)}qt&&console.warn("Duplicate headers found and renamed."),M=!0}return{data:O,errors:b,meta:{delimiter:c,linebreak:h,aborted:L,truncated:!!fe,cursor:z+(V||0),renamedHeaders:ae}}}function we(){k(he()),O=[],b=[]}},this.abort=function(){L=!0},this.getCharIndex=function(){return f}}function U(i){var c=i.data,h=p[c.workerId],D=!1;if(c.error)h.userError(c.error,c.file);else if(c.results&&c.results.data){var k={abort:function(){D=!0,P(c.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:S,resume:S};if(G(h.userStep)){for(var W=0;W<c.results.data.length&&(h.userStep({data:c.results.data[W],errors:c.results.errors,meta:c.results.meta},k),!D);W++);delete c.results}else G(h.userChunk)&&(h.userChunk(c.results,k,c.file),delete c.results)}c.finished&&!D&&P(c.workerId,c.results)}function P(i,c){var h=p[i];G(h.userComplete)&&h.userComplete(c),h.terminate(),delete p[i]}function S(){throw new Error("Not implemented.")}function H(i){if(typeof i!="object"||i===null)return i;var c,h=Array.isArray(i)?[]:{};for(c in i)h[c]=H(i[c]);return h}function Y(i,c){return function(){i.apply(c,arguments)}}function G(i){return typeof i=="function"}return d.parse=function(i,c){var h=(c=c||{}).dynamicTyping||!1;if(G(h)&&(c.dynamicTypingFunction=h,h={}),c.dynamicTyping=h,c.transform=!!G(c.transform)&&c.transform,!c.worker||!d.WORKERS_SUPPORTED)return h=null,d.NODE_STREAM_INPUT,typeof i=="string"?(i=(D=>D.charCodeAt(0)!==65279?D:D.slice(1))(i),h=new(c.download?x:E)(c)):i.readable===!0&&G(i.read)&&G(i.on)?h=new _(c):(r.File&&i instanceof File||i instanceof Object)&&(h=new T(c)),h.stream(i);(h=(()=>{var D;return!!d.WORKERS_SUPPORTED&&(D=(()=>{var k=r.URL||r.webkitURL||null,W=n.toString();return d.BLOB_URL||(d.BLOB_URL=k.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",W,")();"],{type:"text/javascript"})))})(),(D=new r.Worker(D)).onmessage=U,D.id=u++,p[D.id]=D)})()).userStep=c.step,h.userChunk=c.chunk,h.userComplete=c.complete,h.userError=c.error,c.step=G(c.step),c.chunk=G(c.chunk),c.complete=G(c.complete),c.error=G(c.error),delete c.worker,h.postMessage({input:i,config:c,workerId:h.id})},d.unparse=function(i,c){var h=!1,D=!0,k=",",W=`\r
`,X='"',ae=X+X,M=!1,N=null,ee=!1,f=((()=>{if(typeof c=="object"){if(typeof c.delimiter!="string"||d.BAD_DELIMITERS.filter(function(V){return c.delimiter.indexOf(V)!==-1}).length||(k=c.delimiter),typeof c.quotes!="boolean"&&typeof c.quotes!="function"&&!Array.isArray(c.quotes)||(h=c.quotes),typeof c.skipEmptyLines!="boolean"&&typeof c.skipEmptyLines!="string"||(M=c.skipEmptyLines),typeof c.newline=="string"&&(W=c.newline),typeof c.quoteChar=="string"&&(X=c.quoteChar),typeof c.header=="boolean"&&(D=c.header),Array.isArray(c.columns)){if(c.columns.length===0)throw new Error("Option columns is empty");N=c.columns}c.escapeChar!==void 0&&(ae=c.escapeChar+X),c.escapeFormulae instanceof RegExp?ee=c.escapeFormulae:typeof c.escapeFormulae=="boolean"&&c.escapeFormulae&&(ee=/^[=+\-@\t\r].*$/)}})(),new RegExp(B(X),"g"));if(typeof i=="string"&&(i=JSON.parse(i)),Array.isArray(i)){if(!i.length||Array.isArray(i[0]))return L(null,i,M);if(typeof i[0]=="object")return L(N||Object.keys(i[0]),i,M)}else if(typeof i=="object")return typeof i.data=="string"&&(i.data=JSON.parse(i.data)),Array.isArray(i.data)&&(i.fields||(i.fields=i.meta&&i.meta.fields||N),i.fields||(i.fields=Array.isArray(i.data[0])?i.fields:typeof i.data[0]=="object"?Object.keys(i.data[0]):[]),Array.isArray(i.data[0])||typeof i.data[0]=="object"||(i.data=[i.data])),L(i.fields||[],i.data||[],M);throw new Error("Unable to serialize unrecognized input");function L(V,w,j){var I="",J=(typeof V=="string"&&(V=JSON.parse(V)),typeof w=="string"&&(w=JSON.parse(w)),Array.isArray(V)&&0<V.length),K=!Array.isArray(w[0]);if(J&&D){for(var $=0;$<V.length;$++)0<$&&(I+=k),I+=R(V[$],$);0<w.length&&(I+=W)}for(var O=0;O<w.length;O++){var b=(J?V:w[O]).length,g=!1,z=J?Object.keys(w[O]).length===0:w[O].length===0;if(j&&!J&&(g=j==="greedy"?w[O].join("").trim()==="":w[O].length===1&&w[O][0].length===0),j==="greedy"&&J){for(var q=[],Z=0;Z<b;Z++){var ne=K?V[Z]:Z;q.push(w[O][ne])}g=q.join("").trim()===""}if(!g){for(var te=0;te<b;te++){0<te&&!z&&(I+=k);var je=J&&K?V[te]:te;I+=R(w[O][je],te)}O<w.length-1&&(!j||0<b&&!z)&&(I+=W)}}return I}function R(V,w){var j,I;return V==null?"":V.constructor===Date?JSON.stringify(V).slice(1,25):(I=!1,ee&&typeof V=="string"&&ee.test(V)&&(V="'"+V,I=!0),j=V.toString().replace(f,ae),(I=I||h===!0||typeof h=="function"&&h(V,w)||Array.isArray(h)&&h[w]||((J,K)=>{for(var $=0;$<K.length;$++)if(-1<J.indexOf(K[$]))return!0;return!1})(j,d.BAD_DELIMITERS)||-1<j.indexOf(k)||j.charAt(0)===" "||j.charAt(j.length-1)===" ")?X+j+X:j)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!a&&!!r.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=F,d.ParserHandle=C,d.NetworkStreamer=x,d.FileStreamer=T,d.StringStreamer=E,d.ReadableStreamStreamer=_,r.jQuery&&((o=r.jQuery).fn.parse=function(i){var c=i.config||{},h=[];return this.each(function(W){if(!(o(this).prop("tagName").toUpperCase()==="INPUT"&&o(this).attr("type").toLowerCase()==="file"&&r.FileReader)||!this.files||this.files.length===0)return!0;for(var X=0;X<this.files.length;X++)h.push({file:this.files[X],inputElem:this,instanceConfig:o.extend({},c)})}),D(),this;function D(){if(h.length===0)G(i.complete)&&i.complete();else{var W,X,ae,M,N=h[0];if(G(i.before)){var ee=i.before(N.file,N.inputElem);if(typeof ee=="object"){if(ee.action==="abort")return W="AbortError",X=N.file,ae=N.inputElem,M=ee.reason,void(G(i.error)&&i.error({name:W},X,ae,M));if(ee.action==="skip")return void k();typeof ee.config=="object"&&(N.instanceConfig=o.extend(N.instanceConfig,ee.config))}else if(ee==="skip")return void k()}var f=N.instanceConfig.complete;N.instanceConfig.complete=function(L){G(f)&&f(L,N.file,N.inputElem),k()},d.parse(N.file,N.instanceConfig)}}function k(){h.splice(0,1),D()}}),l&&(r.onmessage=function(i){i=i.data,d.WORKER_ID===void 0&&i&&(d.WORKER_ID=i.workerId),typeof i.input=="string"?r.postMessage({workerId:d.WORKER_ID,results:d.parse(i.input,i.config),finished:!0}):(r.File&&i.input instanceof File||i.input instanceof Object)&&(i=d.parse(i.input,i.config))&&r.postMessage({workerId:d.WORKER_ID,results:i,finished:!0})}),(x.prototype=Object.create(m.prototype)).constructor=x,(T.prototype=Object.create(m.prototype)).constructor=T,(E.prototype=Object.create(E.prototype)).constructor=E,(_.prototype=Object.create(m.prototype)).constructor=_,d})}(mt)),mt.exports}var Ks=Js();const Xs=Br(Ks),Zs=async(t,s)=>{switch(s){case"csv":return Qs(t);case"excel":return en(t);case"json":return tn(t);case"xml":return rn(t);case"pdf":return sn(t);case"txt":return nn(t);default:throw new Error(`Unsupported file type: ${s}`)}},Qs=t=>new Promise((s,n)=>{Xs.parse(t,{header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:r=>{const o=r.meta.fields||[],a=r.data;s({columns:o,data:a.slice(0,100)})},error:r=>{n(new Error(`Error parsing CSV: ${r.message}`))}})}),en=t=>new Promise((s,n)=>{const r=new FileReader;r.onload=async o=>{var a;try{const l=(a=o.target)==null?void 0:a.result;if(!l){n(new Error("Failed to read Excel file"));return}const p=await xr(()=>import("./xlsx-DkH2s96g.js"),[]),u=p.read(l,{type:"array"}),d=u.SheetNames[0],m=u.Sheets[d],x=p.utils.sheet_to_json(m,{header:1});if(x.length===0){n(new Error("Excel file is empty"));return}const T=x[0].map(String),E=x.slice(1).map(_=>{const C={};return _.forEach((B,F)=>{F<T.length&&(C[T[F]]=B)}),C});s({columns:T,data:E.slice(0,100)})}catch(l){n(new Error(`Error parsing Excel file: ${l instanceof Error?l.message:"Unknown error"}`))}},r.onerror=()=>{n(new Error("Error reading Excel file"))},r.readAsArrayBuffer(t)}),tn=t=>new Promise((s,n)=>{const r=new FileReader;r.onload=o=>{var a;try{const l=(a=o.target)==null?void 0:a.result,p=JSON.parse(l);if(Array.isArray(p)){if(p.length===0){n(new Error("JSON file contains an empty array"));return}const u=Array.from(new Set(p.flatMap(d=>Object.keys(d))));s({columns:u,data:p.slice(0,100)})}else if(p&&typeof p=="object"){const u=Object.keys(p).find(d=>Array.isArray(p[d]));if(u&&p[u].length>0){const d=p[u],m=Array.from(new Set(d.flatMap(x=>Object.keys(x))));s({columns:m,data:d.slice(0,100)})}else{const d=Object.keys(p);s({columns:d,data:[p]})}}else n(new Error("JSON file format not recognized"))}catch(l){n(new Error(`Error parsing JSON file: ${l instanceof Error?l.message:"Invalid JSON"}`))}},r.onerror=()=>{n(new Error("Error reading JSON file"))},r.readAsText(t)}),rn=t=>new Promise((s,n)=>{const r=new FileReader;r.onload=o=>{var a,l;try{const p=(a=o.target)==null?void 0:a.result,d=new DOMParser().parseFromString(p,"text/xml"),m=d.getElementsByTagName("*"),x=new Map;for(let P=0;P<m.length;P++){const S=m[P].tagName;x.set(S,(x.get(S)||0)+1)}const T=Array.from(x.entries()).filter(([P,S])=>S>1).map(([P])=>P).sort((P,S)=>(x.get(S)||0)-(x.get(P)||0));if(T.length===0){n(new Error("Could not identify repeating elements in XML"));return}const E=T[0],_=d.getElementsByTagName(E);if(_.length===0){n(new Error(`No elements found with tag ${E}`));return}const C=_[0],F=Array.from(C.children).map(P=>P.tagName),U=[];for(let P=0;P<Math.min(_.length,100);P++){const S=_[P],H={};for(const Y of F){const G=((l=S.getElementsByTagName(Y)[0])==null?void 0:l.textContent)||"";H[Y]=G}U.push(H)}s({columns:F,data:U})}catch(p){n(new Error(`Error parsing XML file: ${p instanceof Error?p.message:"Invalid XML"}`))}},r.onerror=()=>{n(new Error("Error reading XML file"))},r.readAsText(t)}),sn=t=>new Promise((s,n)=>{const r=new FileReader;r.onload=async o=>{var a;try{if(!((a=o.target)==null?void 0:a.result)){n(new Error("Failed to read PDF file"));return}s({columns:["Information"],data:[{Information:"PDF files are not currently supported for direct parsing in the browser."},{Information:"Please convert your PDF to CSV, Excel, or JSON format for processing."},{Information:"Alternatively, copy and paste the data from your PDF into a text file."},{Information:`File name: ${t.name}`},{Information:`File size: ${(t.size/1024).toFixed(2)} KB`},{Information:"Supported formats: CSV, Excel (.xlsx, .xls), JSON, XML, TXT"}]})}catch(l){n(new Error(`Error processing PDF: ${l instanceof Error?l.message:"Unknown error"}`))}},r.onerror=()=>{n(new Error("Error reading PDF file"))},r.readAsArrayBuffer(t)}),nn=t=>new Promise((s,n)=>{const r=new FileReader;r.onload=o=>{var a;try{const l=(a=o.target)==null?void 0:a.result;if(!l){n(new Error("Failed to read text file"));return}const p=l.split(`
`).map(x=>x.trim()).filter(x=>x.length>0);if(p.length===0){n(new Error("Text file is empty"));return}const u=[",","	","|",";"];let d="",m=0;for(const x of u){const T=p.slice(0,10).map(C=>C.split(x).length),E=T.reduce((C,B)=>C+B,0)/T.length;T.every(C=>Math.abs(C-E)<=1&&C>1)&&E>m&&(m=E,d=x)}if(d&&m>1){const x=p[0].split(d).map(E=>E.trim()),T=[];for(let E=1;E<Math.min(p.length,100);E++){const _=p[E].split(d).map(B=>B.trim()),C={};for(let B=0;B<x.length;B++)C[x[B]]=_[B]||"";T.push(C)}s({columns:x,data:T})}else{const x=p.slice(0,100).map((T,E)=>({LineNumber:E+1,Text:T}));s({columns:["LineNumber","Text"],data:x})}}catch(l){n(new Error(`Error parsing text file: ${l instanceof Error?l.message:"Unknown error"}`))}},r.onerror=()=>{n(new Error("Error reading text file"))},r.readAsText(t)}),on=()=>{const t=dt(),s=He(r=>r.formatter.selectedTool),n=r=>{const o=r.target.value,a=Kt.find(l=>l.id===o);a&&t(Ur(a))};return e.jsxs(v,{sx:{my:3},children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Select Target Tool"}),e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(Ue,{fullWidth:!0,children:[e.jsx(We,{id:"tool-select-label",children:"Tool"}),e.jsx(Ye,{labelId:"tool-select-label",id:"tool-select",value:(s==null?void 0:s.id)||"",label:"Tool",onChange:n,children:Kt.map(r=>e.jsx(oe,{value:r.id,children:r.name},r.id))})]})}),e.jsx(pe,{size:12,children:s&&e.jsxs(ge,{variant:"outlined",sx:{p:2,mt:2,borderColor:"primary.light"},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:s.name}),e.jsx(y,{variant:"body2",paragraph:!0,children:s.description}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Required fields: ",s.requiredFields.map(r=>r.name).join(", ")]})]})})]})]})},an=()=>{const t=dt(),s=A.useRef(null),{sourceColumns:n,selectedTool:r}=He(P=>P.formatter),[o,a]=A.useState("csv"),[l,p]=A.useState(!1),[u,d]=A.useState(null),[m,x]=A.useState(null),T=P=>{a(P.target.value)},E=async P=>{var H;const S=(H=P.target.files)==null?void 0:H[0];if(S){x(S.name),p(!0),d(null);try{t(Me("uploading"));const Y={id:`file-${Date.now()}`,name:S.name,type:o,size:S.size,lastModified:S.lastModified},{columns:G,data:i}=await Zs(S,o);t(Hr(Y)),t(Wr(G)),t(yr(i)),t(Me("idle")),setTimeout(()=>{t(Le(1))},500)}catch(Y){d(Y instanceof Error?Y.message:"Failed to parse file"),t(Me("error"))}finally{p(!1)}}},_=()=>{var P;(P=s.current)==null||P.click()},C=P=>{var H;P.preventDefault(),P.stopPropagation();const S=(H=P.dataTransfer.files)==null?void 0:H[0];if(S&&s.current){const Y=new DataTransfer;Y.items.add(S),s.current.files=Y.files,E({target:{files:Y.files}})}},B=P=>{P.preventDefault(),P.stopPropagation()},F=()=>{t(Le(1))},U=n.length>0&&r!==null;return e.jsxs(v,{sx:{width:"100%"},children:[e.jsx(y,{variant:"h5",gutterBottom:!0,children:"Upload Data File"}),e.jsx(y,{variant:"body1",paragraph:!0,children:"Select a file to upload. The formatter supports CSV, Excel (.xlsx, .xls, .xlsm), PDF, JSON, XML, and plain text files."}),e.jsxs(pe,{container:!0,spacing:3,children:[e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(Ue,{fullWidth:!0,children:[e.jsx(We,{id:"file-type-select-label",children:"File Type"}),e.jsxs(Ye,{labelId:"file-type-select-label",id:"file-type-select",value:o,label:"File Type",onChange:T,children:[e.jsx(oe,{value:"csv",children:"CSV"}),e.jsx(oe,{value:"excel",children:"Excel (.xlsx/.xls/.xlsm)"}),e.jsx(oe,{value:"json",children:"JSON"}),e.jsx(oe,{value:"xml",children:"XML"}),e.jsx(oe,{value:"pdf",children:"PDF"}),e.jsx(oe,{value:"txt",children:"Text File"})]})]})}),e.jsxs(pe,{size:12,children:[e.jsx("input",{type:"file",ref:s,onChange:E,style:{display:"none"},accept:o==="csv"?".csv":o==="excel"?".xlsx,.xls,.xlsm":o==="json"?".json":o==="xml"?".xml":o==="pdf"?".pdf":o==="txt"?".txt":void 0}),e.jsx(ge,{elevation:0,onDrop:C,onDragOver:B,sx:{border:"2px dashed #ccc",borderRadius:2,p:3,textAlign:"center",cursor:"pointer",bgcolor:"#f8f9fa","&:hover":{borderColor:"primary.main"}},onClick:_,children:l?e.jsxs(v,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(Ve,{}),e.jsx(y,{variant:"body1",sx:{mt:2},children:"Processing file..."})]}):e.jsxs(v,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(Xt,{fontSize:"large",color:"primary"}),e.jsx(y,{variant:"h6",sx:{mt:2},children:m?`Selected: ${m}`:"Drag & drop file here or click to browse"}),e.jsxs(y,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Supports ",o==="csv"?"CSV":o==="excel"?"Excel (.xlsx, .xls, .xlsm)":o==="json"?"JSON":o==="xml"?"XML":o==="pdf"?"PDF":"Text"," files"]})]})}),u&&e.jsx(de,{severity:"error",sx:{mt:2},children:u}),m&&!l&&!u&&e.jsxs(de,{severity:"success",sx:{mt:2},children:["File selected: ",m]})]}),e.jsx(pe,{size:12,sx:{mt:2,display:"flex",justifyContent:"center"},children:e.jsx(re,{variant:"contained",size:"large",onClick:_,startIcon:e.jsx(Xt,{}),disabled:l,children:"Browse Files"})})]}),e.jsx(xe,{sx:{my:4}}),e.jsx(on,{}),e.jsx(v,{sx:{display:"flex",justifyContent:"flex-end",mt:4},children:e.jsx(re,{variant:"contained",size:"large",endIcon:e.jsx(Gt,{}),onClick:F,disabled:!U,children:"Continue to Field Mapping"})}),!U&&e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mt:2,textAlign:"right"},children:n.length?"Select a target tool to continue":"Upload a file to continue"})]})},ot=ce(e.jsx("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),nr=t=>["dispatch_time","enroute_time","arrival_time","clear_time"].includes(t),Rt=t=>["incident_date"].includes(t),ln=t=>{if(!t||typeof t!="string")return t;const s=[/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2})$/,/^.+\s+(\d{1,2}:\d{2}(?::\d{2})?)$/];for(const r of s){const o=t.match(r);if(o&&o[1])return o[1]}return/^\d{1,2}:\d{2}(?::\d{2})?$/.test(t.trim())?t.trim():t},cn=t=>{if(console.log(`🔍 DATE EXTRACTION: Input "${t}" (type: ${typeof t})`),!t||typeof t!="string")return console.log("🔍 DATE EXTRACTION: Invalid input, returning original"),t;const s=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^(\d{4}-\d{2}-\d{2})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^([^\\s]+)\s+\d{1,2}:\d{2}(?::\d{2})?$/];for(let r=0;r<s.length;r++){const o=s[r],a=t.match(o);if(console.log(`🔍 Pattern ${r+1} test: "${t}" → ${a?`MATCH: "${a[1]}"`:"NO MATCH"}`),a&&a[1])return console.log(`🔍 DATE EXTRACTION SUCCESS: "${t}" → "${a[1]}"`),a[1]}const n=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const r of n)if(r.test(t.trim()))return t.trim();return t},Mr=(t,s)=>!t||!t.length||!s||!s.length?[]:t.map(n=>{const r={},o=new Set;return s.forEach(a=>{const{sourceField:l,targetField:p,transformations:u}=a;let d;if(l==="__default__"&&u&&u.length>0){const m=u.find(x=>x.type==="convert"&&x.params.defaultValue);m?(console.log(`Using default value for ${p}:`,m.params.defaultValue),d=m.params.defaultValue):(console.log(`No default value found for ${p}, using null`),d=null)}else if(l.includes("_")&&l.split("_").length>=2){const[m,...x]=l.split("_"),T=x.join("_"),E=[`${m}_parsed_${T}`,`${m}_parsed_${p}`,l];console.log(`🤖 DEBUG: Looking for parsed data with sourceField: "${l}"`),console.log("🤖 DEBUG: Trying keys:",E),console.log("🤖 DEBUG: Available row keys:",Object.keys(n));let _=!1;for(const C of E)if(n[C]!==void 0&&n[C]!==null){d=n[C],console.log(`🤖 ✅ Using PARSED value for ${p} from key "${C}": "${d}"`),_=!0;break}else console.log(`🤖 ❌ No data found at key: "${C}"`);_||(d=n[l],console.log(`🤖 ⚠️ No parsed data found, using source value for ${p} from ${l}:`,d))}else d=n[l],console.log(`Using source value for ${p} from ${l}:`,d);if(u&&u.length>0){console.log(`Applying ${u.length} transformations to ${p}:`,u);const m=d;d=dn(d,u,p,n),console.log(`Transformation result for ${p}:`,m,"→",d)}if(p==="incident_type"&&d!==null&&d!==void 0&&(typeof d=="number"?(console.log(`🔢 Converting numeric incident_type to string: ${d} → "${String(d)}"`),d=String(d)):typeof d!="string"&&(console.log(`🔄 Converting incident_type to string: ${d} (${typeof d}) → "${String(d)}"`),d=String(d))),console.log(`🔧 CHECKING FIELD: ${p}, isTimeOnly: ${nr(p)}, isDateOnly: ${Rt(p)}, value type: ${typeof d}`),d&&typeof d=="string")if(nr(p)){const m=ln(d);m!==d?(console.log(`🕒 Auto-extracted time for ${p}: "${d}" → "${m}"`),d=m):console.log(`🕒 No time extraction needed for ${p}: "${d}"`)}else if(Rt(p)){console.log(`📅 ATTEMPTING DATE EXTRACTION for ${p}: Input value "${d}"`);const m=cn(d);console.log(`📅 DATE EXTRACTION RESULT: "${d}" → "${m}" (changed: ${m!==d})`),m!==d?(console.log(`📅 ✅ Auto-extracted date for ${p}: "${d}" → "${m}"`),d=m):console.log(`📅 ❌ No date extraction needed for ${p}: "${d}"`)}else p==="incident_time"&&console.log(`🕒 Keeping full datetime for ${p}: "${d}"`);if(r[p]=d,l!==p&&l!=="__default__"&&!o.has(l)&&!l.includes("_parsed_")){if(s.some(x=>x.targetField===l))console.log(`🚫 SKIPPING PRESERVATION: "${l}" is also a target field - keeping transformed value`);else{let x=d;Rt(p)&&n[l]&&typeof n[l]=="string"&&n[l].includes(" ")&&(x=n[l],console.log(`📅 PRESERVING FULL DATETIME for original field "${l}": "${x}" (target "${p}" gets date-only: "${d}")`)),r[l]=x,console.log(`🔄 PRESERVED ORIGINAL FIELD NAME: "${l}" → "${x}" (also mapped to ${p})`)}o.add(l)}else l.includes("_parsed_")&&console.log(`🤖 SKIPPING PARSED FIELD PRESERVATION: "${l}" (parsed field injection key)`)}),Object.keys(r).forEach(a=>{a.includes("_parsed_")&&(console.log(`🧹 CLEANUP: Removing parsed field injection key "${a}" from transformed data`),delete r[a])}),r}),dn=(t,s,n,r)=>s.reduce((o,a)=>Or(o,a,n,r),t),Or=(t,s,n,r)=>{const{type:o,params:a}=s,l={...a,...n&&{fieldName:n},...r&&{rowData:r}};switch(o){case"split":return mn(t,l);case"join":return hn(t,l);case"format":return gn(t,l);case"convert":return fn(t,l);case"extract":return un(t,l);case"replace":return pn(t,l);case"datetime_combine":return xn(t,l);case"datetime_extract":return yn(t,l);default:return t}},un=(t,s)=>{if(typeof t!="string")return t;const{pattern:n}=s;try{const r=new RegExp(n),o=t.match(r);if(o&&o.length>0)return o[1]||o[0]}catch{console.error("Invalid regex pattern:",n)}return t},pn=(t,s)=>{if(typeof t!="string")return t;const{from:n,to:r="",useRegex:o=!1}=s;if(!n)return t;try{if(o){const a=new RegExp(n,"g");return t.replace(a,r)}else return t.replace(new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),r)}catch(a){return console.error("Error in replace transformation:",a),t}},mn=(t,s)=>{if(typeof t!="string")return t;const{delimiter:n,index:r}=s,o=t.split(n);return r!==void 0?o[r]||"":o},hn=(t,s)=>{if(!Array.isArray(t))return t;const{delimiter:n=", "}=s;return t.join(n)},gn=(t,s)=>{const{format:n,type:r,fieldName:o}=s;if(console.log("applyFormatTransformation called with:",{value:t,format:n,type:r,fieldName:o}),r==="date"&&t)try{const a=new Date(t);if(isNaN(a.getTime()))return t;switch(n){case"MM/DD/YYYY":return`${a.getMonth()+1}/${a.getDate()}/${a.getFullYear()}`;case"YYYY-MM-DD":return`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${a.getDate()}/${a.getMonth()+1}/${a.getFullYear()}`;case"date-only":return a.toLocaleDateString();case"custom":return(s.customFormat||"YYYY-MM-DD").replace("YYYY",a.getFullYear().toString()).replace("MM",(a.getMonth()+1).toString().padStart(2,"0")).replace("DD",a.getDate().toString().padStart(2,"0")).replace("HH",a.getHours().toString().padStart(2,"0")).replace("mm",a.getMinutes().toString().padStart(2,"0")).replace("ss",a.getSeconds().toString().padStart(2,"0"));case"ISO":return a.toISOString();default:return t}}catch{return t}if(r==="number"&&t!==void 0&&t!==null)try{const a=Number(t);if(isNaN(a))return t;switch(n){case"integer":return Math.round(a);case"fixed2":return a.toFixed(2);case"currency":return`$${a.toFixed(2)}`;case"percent":return`${(a*100).toFixed(1)}%`;default:return t}}catch{return t}return t},fn=(t,s)=>{const{targetType:n}=s;switch(n){case"string":return t!=null?String(t):"";case"number":if(t==null||t==="")return null;const r=Number(t);return isNaN(r)?t:r;case"boolean":return typeof t=="string"?["true","yes","1","y"].includes(t.toLowerCase()):!!t;case"date":if(!t)return null;try{const o=new Date(t);return isNaN(o.getTime())?t:o}catch{return t}default:return t}},xn=(t,s)=>{const{sourceFields:n,description:r,rowData:o}=s;if(console.log("🕐 DATETIME COMBINE: Starting transformation"),console.log("🕐 Source fields:",n),console.log("🕐 Primary value:",t),console.log("🕐 Description:",r),!n||n.length<2)return console.log("⚠️ DATETIME COMBINE: Need at least 2 source fields"),t;if(!o)return console.log("⚠️ DATETIME COMBINE: No row data provided for field combination"),t;const[a,l]=n,p=String(o[a]||"").trim(),u=String(o[l]||"").trim();if(console.log(`🕐 Date field "${a}":`,p),console.log(`🕐 Time field "${l}":`,u),!p||!u)return console.log("⚠️ DATETIME COMBINE: Missing date or time component"),t;const d=`${p} ${u}`;return console.log("✅ DATETIME COMBINE: Result:",d),d},yn=(t,s)=>{const{extractType:n,description:r}=s;if(console.log("🕐 DATETIME EXTRACT: Starting transformation"),console.log("🕐 Extract type:",n),console.log("🕐 Input value:",t),console.log("🕐 Description:",r),!t||typeof t!="string")return console.log("⚠️ DATETIME EXTRACT: Invalid input value"),t;const o=t.trim();if(n==="date"){const a=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+/,/^(\d{4}-\d{2}-\d{2})\s+/];for(const p of a){const u=o.match(p);if(u){const d=u[1];return console.log("✅ DATETIME EXTRACT (date):",d),d}}const l=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const p of l)if(p.test(o))return console.log("✅ DATETIME EXTRACT (date): Already date-only format"),o}else if(n==="time"){const a=[/\s+(\d{1,2}:\d{2}:\d{2})$/,/\s+(\d{1,2}:\d{2})$/];for(const p of a){const u=o.match(p);if(u){const d=u[1];return console.log("✅ DATETIME EXTRACT (time):",d),d}}const l=[/^\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}:\d{2}$/];for(const p of l)if(p.test(o))return console.log("✅ DATETIME EXTRACT (time): Already time-only format"),o}return console.log("⚠️ DATETIME EXTRACT: No matching pattern found, returning original value"),t},bn=(t,s)=>{console.log("🕐 SMART DATETIME DETECTION: Starting analysis..."),console.log("🕐 Column names:",t);const n=s.find(l=>Object.keys(l).length>0)||{};console.log("🕐 Sample data keys:",Object.keys(n));const r=vn(t,n);if(r.confidence>.7)return console.log("✅ DETECTED: Tyler CAD split datetime pattern"),{pattern:r,suggestedMappings:Sn(r)};const o=jn(t,n);if(o.confidence>.7)return console.log("✅ DETECTED: Hexagon/CentralSquare combined datetime pattern"),{pattern:o,suggestedMappings:En(o)};const a=Tn(t,n);return a.confidence>.5?(console.log("✅ DETECTED: Volunteer department simple pattern"),{pattern:a,suggestedMappings:Fn(a)}):(console.log("⚠️ NO CLEAR DATETIME PATTERN DETECTED"),{pattern:{type:"unknown",confidence:0,description:"No clear datetime pattern detected - manual mapping required"},suggestedMappings:[]})},vn=(t,s)=>{console.log("🔍 Testing split datetime pattern (Tyler CAD style)...");const n=[/^inc_date$/i,/^incident_date$/i,/^date$/i,/^call_date$/i,/^event_date$/i],r=[/^alarm_time$/i,/^call_time$/i,/^time$/i,/^incident_time$/i,/^receive_time$/i,/^dispatch_time$/i];let o,a,l=0;for(const p of t){for(const u of n)if(u.test(p)){o=p,l+=.3,console.log(`📅 Found potential date field: "${p}"`);break}if(o)break}for(const p of t){for(const u of r)if(u.test(p)){a=p,l+=.3,console.log(`⏰ Found potential time field: "${p}"`);break}if(a)break}if(o&&a&&s[o]&&s[a]){const p=String(s[o]),u=String(s[a]);console.log("🧪 Sample data validation:"),console.log(`  Date field "${o}": "${p}"`),console.log(`  Time field "${a}": "${u}"`);const m=/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(p.trim()),T=/^\d{1,2}:\d{2}(:\d{2})?$/.test(u.trim());m&&T?(l+=.4,console.log("✅ Data validation passed - date-only + time-only pattern confirmed")):(console.log("⚠️ Data validation failed - not clean date-only + time-only pattern"),console.log(`  Date-only check: ${m}, Time-only check: ${T}`))}return{type:"split",confidence:l,dateField:o,timeField:a,description:l>.7?`Split datetime pattern detected: "${o}" + "${a}" should be combined`:"Potential split pattern found but low confidence"}},jn=(t,s)=>{console.log("🔍 Testing combined datetime pattern (Hexagon/CentralSquare style)...");const n=[/^calldatetime$/i,/^call_datetime$/i,/^incident_datetime$/i,/^event_datetime$/i,/^call_received_date\/time$/i,/^call.*time$/i,/^received.*time$/i];let r,o=0;for(const a of t){for(const l of n)if(l.test(a)){r=a,o+=.4,console.log(`📅⏰ Found potential combined datetime field: "${a}"`);break}if(r)break}if(!r)for(const a of t){const l=s[a];if(l&&typeof l=="string"&&/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/.test(l.trim())){r=a,o+=.3,console.log(`📅⏰ Found combined datetime by content analysis: "${a}" = "${l}"`);break}}if(r&&s[r]){const a=String(s[r]);console.log(`🧪 Sample data validation for combined field "${r}": "${a}"`),[/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}$/,/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/].some(u=>u.test(a.trim()))?(o+=.4,console.log("✅ Data validation passed - full datetime pattern confirmed")):console.log("⚠️ Data validation failed - not a full datetime pattern")}return{type:"combined",confidence:o,combinedField:r,description:o>.7?`Combined datetime pattern detected: "${r}" contains full date and time`:"Potential combined pattern found but low confidence"}},Tn=(t,s)=>{console.log("🔍 Testing simple datetime pattern (volunteer department style)...");const n=/^date$/i,r=/^time$/i,o=t.find(p=>n.test(p)),a=t.find(p=>r.test(p));let l=0;return o&&a&&(l+=.4,console.log(`📅 Found simple date field: "${o}"`),console.log(`⏰ Found simple time field: "${a}"`),s[o]&&s[a]&&(l+=.3,console.log("🧪 Sample data available for validation"))),{type:"simple",confidence:l,dateField:o,timeField:a,description:l>.5?`Simple datetime pattern detected: basic "${o}" + "${a}" fields`:"Simple pattern check completed - low confidence"}},Sn=t=>{const s=[];return t.dateField&&t.timeField&&(s.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine "${t.dateField}" + "${t.timeField}" into full datetime for incident time`}),s.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"extract",description:`Extract date from "${t.dateField}" for incident date`})),s},En=t=>{const s=[];return t.combinedField&&(s.push({sourceFields:[t.combinedField],targetField:"incident_time",transformationType:"direct",description:`Use "${t.combinedField}" directly for incident time`}),s.push({sourceFields:[t.combinedField],targetField:"incident_date",transformationType:"extract",description:`Extract date portion from "${t.combinedField}" for incident date`})),s},Fn=t=>{const s=[];return t.dateField&&t.timeField&&(s.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine simple "${t.dateField}" + "${t.timeField}" for incident time`}),s.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"direct",description:`Use "${t.dateField}" for incident date`})),s},Cn=ce(e.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"})),or=ce(e.jsx("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"})),Dn=ce(e.jsx("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"})),wn=ce(e.jsx("path",{d:"M16.01 11H4v2h12.01v3L20 12l-3.99-4z"})),In=ce(e.jsx("path",{d:"m19 9 1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25z"})),ct=ce(e.jsx("path",{d:"M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.996.996 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"})),_n=ce(e.jsx("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"})),$n=ce(e.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2m-9 14-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),Pr=ce(e.jsx("path",{d:"M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),An=ce(e.jsx("path",{d:"M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6z"})),Rn=ce(e.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),Vt=ce(e.jsx("path",{d:"M15 4v2h3v12h-3v2h5V4zM4 20h5v-2H6V6h3V4H4z"})),kr=ce(e.jsx("path",{d:"M4 7v2c0 .55-.45 1-1 1H2v4h1c.55 0 1 .45 1 1v2c0 1.65 1.35 3 3 3h3v-2H7c-.55 0-1-.45-1-1v-2c0-1.3-.84-2.42-2-2.83v-.34C5.16 11.42 6 10.3 6 9V7c0-.55.45-1 1-1h3V4H7C5.35 4 4 5.35 4 7m17 3c-.55 0-1-.45-1-1V7c0-1.65-1.35-3-3-3h-3v2h3c.55 0 1 .45 1 1v2c0 1.3.84 2.42 2 2.83v.34c-1.16.41-2 1.52-2 2.83v2c0 .55-.45 1-1 1h-3v2h3c1.65 0 3-1.35 3-3v-2c0-.55.45-1 1-1h1v-4z"})),yt=ce(e.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),ar=ce(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2m0 12H4V8h16z"})),Mn=ce(e.jsx("path",{d:"M2 17h2v.5H3v1h1v.5H2v1h3v-4H2zm1-9h1V4H2v1h1zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2zm5-6v2h14V5zm0 14h14v-2H7zm0-6h14v-2H7z"})),On=ce(e.jsx("path",{d:"M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4"})),Bt=ce(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"})),ir=ce(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),Pn=ce(e.jsx("path",{d:"m20.5 10 .5-2h-4l1-4h-2l-1 4h-4l1-4h-2L9 8H5l-.5 2h4l-1 4h-4L3 16h4l-1 4h2l1-4h4l-1 4h2l1-4h4l.5-2h-4l1-4zm-7 4h-4l1-4h4z"})),lr=ce([e.jsx("path",{d:"M13 8.57c-.79 0-1.43.64-1.43 1.43s.64 1.43 1.43 1.43 1.43-.64 1.43-1.43-.64-1.43-1.43-1.43"},"0"),e.jsx("path",{d:"M13 3C9.25 3 6.2 5.94 6.02 9.64L4.1 12.2c-.25.33-.01.8.4.8H6v3c0 1.1.9 2 2 2h1v3h7v-4.68c2.36-1.12 4-3.53 4-6.32 0-3.87-3.13-7-7-7m3 7c0 .13-.01.26-.02.39l.83.66c.08.06.1.16.05.25l-.8 1.39c-.05.09-.16.12-.24.09l-.99-.4c-.21.16-.43.29-.67.39L14 13.83c-.01.1-.1.17-.2.17h-1.6c-.1 0-.18-.07-.2-.17l-.15-1.06c-.25-.1-.47-.23-.68-.39l-.99.4c-.09.03-.2 0-.25-.09l-.8-1.39c-.05-.08-.03-.19.05-.25l.84-.66c-.01-.13-.02-.26-.02-.39s.02-.27.04-.39l-.85-.66c-.08-.06-.1-.16-.05-.26l.8-1.38c.05-.09.15-.12.24-.09l1 .4c.2-.15.43-.29.67-.39L12 6.17c.02-.1.1-.17.2-.17h1.6c.1 0 .18.07.2.17l.15 1.06c.24.1.46.23.67.39l1-.4c.09-.03.2 0 .24.09l.8 1.38c.05.09.03.2-.05.26l-.85.66c.03.12.04.25.04.39"},"1")]),kn=ce(e.jsx("path",{d:"M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3m1-4.3h-2V7h2z"})),Nr=ce(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),cr=ce(e.jsx("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3M7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5M16 17H8v-2h8zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13"})),Nn=ce(e.jsx("path",{d:"m23 12-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69zm-12.91 4.72-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48z"})),Ln=ce([e.jsx("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),e.jsx("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")]),Mt=[{id:"incident_type",name:"🔥 Incident Type",description:"Fire, medical, accident, alarm, etc.",pattern:/(fire|medical|ems|accident|mva|alarm|rescue|hazmat)/gi,enabled:!0},{id:"response_time",name:"⏱️ Response Time",description:'Time values like "30 min", "1:20", "half hour"',pattern:/(\d+)\s*(min|minutes|hour|hours|hr|hrs)|(\d{1,2}):(\d{2})|half.hour|quarter.hour/gi,enabled:!0},{id:"location",name:"📍 Location",description:"Addresses, street names, landmarks",pattern:/\d+\s+[\w\s]+(street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd)/gi,enabled:!1},{id:"date_time",name:"📅 Date/Time",description:'Dates like "12/04/25", "April 12", times',pattern:/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})|(\w+\s+\d{1,2})|(\d{1,2}:\d{2})/gi,enabled:!1},{id:"units_resources",name:"🚒 Units/Resources",description:"Fire trucks, ambulances, personnel count",pattern:/(engine|truck|ambulance|rescue|ladder|chief|\d+\s*(firefighter|personnel|crew))/gi,enabled:!1}],zn=({open:t,onClose:s,columnName:n,sampleData:r,onParse:o})=>{const[a,l]=A.useState(["incident_type","response_time"]),[p,u]=A.useState(!1),[d,m]=A.useState([]),[x,T]=A.useState(!1);A.useEffect(()=>{a.length>0&&r.length>0&&_()},[a,r]);const E=i=>{l(c=>c.includes(i)?c.filter(h=>h!==i):[...c,i])},_=async()=>{u(!0);try{await new Promise(c=>setTimeout(c,500));const i=r.slice(0,5).map((c,h)=>({rowIndex:h,originalText:c,parsedFields:C(c,a)}));m(i)}catch(i){console.error("Error generating preview:",i)}finally{u(!1)}},C=(i,c)=>{const h={};return c.forEach(D=>{const k=Mt.find(X=>X.id===D);if(!k)return;const W=i.match(k.pattern);if(W&&W.length>0){const X=W[0];console.log(`🔍 PARSING DEBUG - Field: ${D}, Pattern: ${k.pattern}, Text: "${i}", Match: "${X}"`),h[D]={value:B(D,X),confidence:S(D,X),original:X}}}),h},B=(i,c)=>{switch(i){case"incident_type":return F(c);case"response_time":return U(c);case"location":return P(c);default:return c}},F=i=>{const c=i.toLowerCase();return c.includes("fire")?"Structure Fire":c.includes("medical")||c.includes("ems")?"Medical Emergency":c.includes("accident")||c.includes("mva")?"Motor Vehicle Accident":c.includes("alarm")?"Alarm Response":i},U=i=>{const c=i.match(/(\d+)\s*(min|minutes|hour|hours|hr|hrs)/i);if(c){const D=parseInt(c[1]);return c[2].toLowerCase().startsWith("h")?`${D} hour${D!==1?"s":""}`:`${D} minute${D!==1?"s":""}`}const h=i.match(/(\d{1,2}):(\d{2})/);if(h){const D=parseInt(h[1]),k=parseInt(h[2]);return`${D}:${k.toString().padStart(2,"0")}`}return i},P=i=>i.replace(/\b\w/g,c=>c.toUpperCase()),S=(i,c,h)=>i==="response_time"&&c.match(/\d+\s*(min|minutes)/i)?.95:i==="incident_type"&&["fire","medical","accident"].includes(c.toLowerCase())?.9:.7,H=async()=>{if(a.length!==0){T(!0);try{await new Promise(c=>setTimeout(c,1e3));const i=r.map((c,h)=>({rowIndex:h,originalText:c,parsedFields:C(c,a)}));o(a,i),s()}catch(i){console.error("Error parsing narrative data:",i)}finally{T(!1)}}},Y=()=>a.length,G=()=>d.filter(i=>Object.keys(i.parsedFields).length>0).length;return e.jsxs(Qe,{open:t,onClose:s,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"70vh"}},children:[e.jsxs(et,{sx:{display:"flex",alignItems:"center",pb:1},children:[e.jsx(cr,{sx:{mr:1,color:"primary.main"}}),'Parse Narrative: "',n,'"']}),e.jsxs(tt,{sx:{pb:1},children:[e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Extract structured data from narrative text using pattern matching and NLP. Select the fields you want to extract and preview the results."}),e.jsx(y,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"1. Select Fields to Extract"}),e.jsx(Sr,{sx:{mb:3},children:Mt.map(i=>e.jsx(Je,{control:e.jsx(ds,{checked:a.includes(i.id),onChange:()=>E(i.id)}),label:e.jsxs(v,{children:[e.jsx(y,{variant:"body2",sx:{fontWeight:"medium"},children:i.name}),e.jsx(y,{variant:"caption",color:"text.secondary",children:i.description})]})},i.id))}),e.jsx(xe,{sx:{my:2}}),e.jsxs(v,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(y,{variant:"h6",sx:{flexGrow:1},children:"2. Preview Results"}),p&&e.jsx(Ve,{size:20,sx:{ml:2}})]}),a.length===0?e.jsx(de,{severity:"info",sx:{mb:2},children:"Select at least one field to see preview results."}):e.jsxs(e.Fragment,{children:[e.jsxs(v,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(le,{label:`${Y()} fields selected`,size:"small",color:"primary"}),e.jsx(le,{label:`${G()}/${d.length} rows with data`,size:"small",color:"success"})]}),e.jsxs(ht,{size:"small",sx:{mb:2},children:[e.jsx(gt,{children:e.jsxs(Ne,{children:[e.jsx(Ce,{children:"Original Text"}),a.map(i=>{const c=Mt.find(h=>h.id===i);return e.jsx(Ce,{children:c==null?void 0:c.name},i)})]})}),e.jsx(ft,{children:d.map((i,c)=>e.jsxs(Ne,{children:[e.jsx(Ce,{sx:{maxWidth:200},children:e.jsx(y,{variant:"body2",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i.originalText})}),a.map(h=>e.jsx(Ce,{children:i.parsedFields[h]?e.jsxs(v,{children:[e.jsx(y,{variant:"body2",children:i.parsedFields[h].value}),e.jsxs(y,{variant:"caption",color:"success.main",children:[Math.round(i.parsedFields[h].confidence*100),"% confident"]})]}):e.jsx(y,{variant:"caption",color:"text.secondary",children:"No match"})},h))]},c))})]}),e.jsx(de,{severity:"info",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:[e.jsx("strong",{children:"Preview shows first 5 rows."})," Parsing accuracy is typically 70-85%. You can edit any incorrect values after parsing."]})})]})]}),e.jsxs(rt,{sx:{p:3,pt:1},children:[e.jsx(re,{onClick:s,children:"Cancel"}),e.jsx(re,{variant:"contained",onClick:H,disabled:a.length===0||x,startIcon:x?e.jsx(Ve,{size:20}):e.jsx(cr,{}),children:x?"Parsing...":`Parse ${n}`})]})]})},Vn=({columnName:t,onClick:s,variant:n="icon",size:r="small",disabled:o=!1})=>{const a=()=>{s(t)};return n==="button"?e.jsx(re,{size:r,startIcon:e.jsx(ct,{}),onClick:a,disabled:o,sx:{minWidth:"auto",textTransform:"none",color:"primary.main","&:hover":{backgroundColor:"primary.50"}},children:"Parse"}):e.jsx(ze,{title:`Parse narrative text in "${t}" column`,children:e.jsx("span",{children:e.jsx(De,{size:r,onClick:a,disabled:o,sx:{color:"primary.main","&:hover":{backgroundColor:"primary.50",transform:"scale(1.1)"},transition:"all 0.2s ease-in-out"},children:e.jsx(ct,{fontSize:r})})})})},Bn=({parsedFields:t,onFieldDragStart:s,onDeleteParsedField:n})=>{if(t.length===0)return null;const r=a=>a>=.9?"success":a>=.7?"warning":"error",o=a=>a>=.9?"High confidence":a>=.7?"Medium confidence":"Low confidence";return e.jsxs(v,{sx:{mt:1,ml:2},children:[e.jsxs(v,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(lr,{sx:{fontSize:16,color:"primary.main",mr:.5}}),e.jsx(y,{variant:"caption",color:"primary.main",sx:{fontWeight:"medium"},children:"Parsed Fields"})]}),e.jsx(nt,{spacing:.5,children:t.map(a=>e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(le,{label:a.name,size:"small",color:"secondary",variant:"outlined",draggable:!0,onDragStart:l=>{l.stopPropagation(),s(l,a.id)},sx:{cursor:"grab","&:active":{cursor:"grabbing"},"&:hover":{backgroundColor:"secondary.50"}},icon:e.jsx(lr,{})}),e.jsx(ze,{title:`${a.parsedCount}/${a.totalRows} rows parsed`,children:e.jsxs(y,{variant:"caption",color:"text.secondary",children:[Math.round(a.parsedCount/a.totalRows*100),"%"]})}),e.jsx(ze,{title:o(a.confidence),children:e.jsx(Xe,{sx:{fontSize:14,color:`${r(a.confidence)}.main`}})}),e.jsx(ze,{title:"Delete parsed field",children:e.jsx(De,{size:"small",onClick:()=>n(a.id),sx:{ml:.5,"&:hover":{color:"error.main"}},children:e.jsx(lt,{sx:{fontSize:14}})})})]},a.id))}),e.jsx(y,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"Drag parsed fields to target fields →"})]})},Un=({id:t,isMapped:s,targetFields:n,sampleValue:r,dataType:o,onParseColumn:a,parsedFields:l=[],onParsedFieldDragStart:p,onDeleteParsedField:u})=>{const d=(o==="Text"||!o&&typeof r=="string")&&typeof r=="string"&&r.length>20;t==="Notes"&&console.log("🔍 NARRATIVE PARSER DEBUG for Notes column:",{fieldId:t,dataType:o,sampleValue:r,sampleValueType:typeof r,sampleValueLength:typeof r=="string"?r.length:"N/A",isTextColumn:d,onParseColumn:!!a});const m={backgroundColor:s?"#f0f7ff":void 0,border:s?"1px solid #90caf9":"1px solid #e0e0e0",cursor:"grab",padding:"8px 12px",borderRadius:"4px",marginBottom:"8px",position:"relative"},x=E=>{console.log("DRAG START on source field:",t),E.dataTransfer.setData("text/plain",t),E.dataTransfer.effectAllowed="move",console.log("Verifying dataTransfer was set:",E.dataTransfer.types);const _=document.createElement("div");_.className="drag-ghost",_.innerHTML=`<div style="padding: 10px; background: #1976d2; color: white; border-radius: 4px;">Dragging: ${t}</div>`,document.body.appendChild(_),E.dataTransfer.setDragImage(_,20,20);const C=E.currentTarget;C.style.opacity="0.6",C.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.2)",setTimeout(()=>{document.body.removeChild(_)},0),console.log("Drag started with field:",t)},T=E=>{const _=E.currentTarget;_.style.opacity="",_.style.boxShadow="",console.log("Drag ended for field:",t)};return e.jsx("div",{style:m,"data-field-id":t,className:"draggable-source-field",draggable:!0,onDragStart:x,onDragEnd:T,children:e.jsxs(v,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsxs(v,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(y,{variant:"body2",fontWeight:"medium",children:t}),e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[d&&a&&e.jsx(Vn,{columnName:t,onClick:a,variant:"icon",size:"small"}),s&&e.jsx(le,{size:"small",icon:e.jsx(Cn,{fontSize:"small"}),label:n.length===1?n[0]:`${n.length} fields`,color:"primary",variant:"outlined"})]})]}),r!==void 0&&e.jsxs(v,{sx:{mt:.5,display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.75rem"},children:[e.jsx(y,{variant:"caption",sx:{color:"text.secondary",fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:typeof r=="object"?JSON.stringify(r):String(r)}),o&&e.jsx(le,{label:o,size:"small",variant:"outlined",sx:{height:"16px",fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]}),l.length>0&&e.jsx(Bn,{parsedFields:l.map(E=>({id:E.id,name:E.name,sourceColumn:E.sourceColumn,parsedCount:E.parsedCount,totalRows:E.totalRows,confidence:E.confidence})),onFieldDragStart:p||(()=>{}),onDeleteParsedField:u||(()=>{})})]})})},Hn=({sourceColumns:t,filter:s,setFilter:n,mappings:r,sampleData:o=[],onAddParsedFields:a})=>{const[l,p]=A.useState(!1),[u,d]=A.useState(""),[m,x]=A.useState({}),T=i=>{d(i),p(!0)},E=()=>{p(!1),d("")},_=(i,c)=>{console.log("🔥 Parsing completed for column:",u),console.log("📊 Selected fields:",i),console.log("📋 Results:",c);const h=i.map(D=>{const k=C(D),W=[];let X=0,ae=0;c.forEach(N=>{N.parsedFields[D]?(W.push(N.parsedFields[D].value),X++,ae+=N.parsedFields[D].confidence):W.push(null)});const M=X>0?ae/X:0;return{id:`${u}_${D}`,name:k,sourceColumn:u,parsedCount:X,totalRows:c.length,confidence:M,data:W}});if(x(D=>({...D,[u]:h})),o&&o.length>0){const D=o.map((k,W)=>{const X={...k};return h.forEach(ae=>{if(ae.data[W]!==null){const M=ae.id.split("_").slice(1).join("_"),N=`${u}_parsed_${M}`;X[N]=ae.data[W],console.log(`🤖 INJECTED parsed data: ${N} = "${ae.data[W]}"`)}}),X});console.log("🤖 Updated sample data with parsed fields:",D)}a&&a(u,h)},C=i=>({incident_type:"📊 Parsed Incident Type",response_time:"⏱️ Parsed Response Time",location:"📍 Parsed Location",date_time:"📅 Parsed Date/Time",units_resources:"🚒 Parsed Units/Resources"})[i]||`🤖 Parsed ${i}`,B=(i,c)=>{console.log("🔥 Dragging parsed field:",c),i.dataTransfer.setData("text/plain",c),i.dataTransfer.effectAllowed="move"},F=i=>{console.log("🗑️ Deleting parsed field:",i);const c=Object.keys(m).find(h=>m[h].some(D=>D.id===i));c&&x(h=>({...h,[c]:h[c].filter(D=>D.id!==i)}))},U=i=>!o||o.length===0?[]:o.slice(0,10).map(c=>c[i]||"").filter(Boolean),P=A.useMemo(()=>{if(!s)return t;const i=s.toLowerCase();return t.filter(c=>c.toLowerCase().includes(i))},[t,s]),S=A.useMemo(()=>{const i={};return r.forEach(c=>{i[c.sourceField]||(i[c.sourceField]=[]),i[c.sourceField].push(c.targetField)}),i},[r]),H=A.useMemo(()=>Object.keys(S).length,[S]),Y=A.useMemo(()=>{if(!o||o.length===0)return{};const i=o[0],c={};return t.forEach(h=>{c[h]=i[h]}),c},[o,t]),G=A.useMemo(()=>{const i={};return Object.entries(Y).forEach(([c,h])=>{if(h==null){i[c]="Unknown";return}if(typeof h=="string"){if([/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/,/^\d{4}\/\d{2}\/\d{2}$/].some(W=>W.test(h))){i[c]="Date";return}if([/^\d{1,2}:\d{2}(:\d{2})?$/,/^\d{1,2}:\d{2}(:\d{2})?\s*(AM|PM)$/i].some(W=>W.test(h))){i[c]="Time";return}if(!isNaN(Number(h))){i[c]="Number";return}i[c]="Text";return}typeof h=="number"?i[c]="Number":typeof h=="boolean"?i[c]="Boolean":Array.isArray(h)?i[c]="Array":typeof h=="object"?i[c]="Object":i[c]=typeof h}),i},[Y]);return e.jsxs(ge,{sx:{height:"100%",p:2,display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsx(be,{size:"small",placeholder:"Search source fields...",value:s,onChange:i=>n(i.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Re,{position:"start",children:e.jsx(it,{fontSize:"small"})})}}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(y,{variant:"body2",color:"text.secondary",children:[P.length," fields"]}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:[H," mapped"]})]}),e.jsx(v,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(y,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drag fields from here to the Target Fields panel"})}),e.jsx(xe,{sx:{mb:2}}),e.jsxs(v,{sx:{flexGrow:1,overflow:"auto",maxHeight:"calc(100% - 180px)",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:[P.map(i=>e.jsx(Un,{id:i,isMapped:!!S[i],targetFields:S[i]||[],sampleValue:Y[i],dataType:G[i],onParseColumn:T,parsedFields:m[i]||[],onParsedFieldDragStart:B,onDeleteParsedField:F},i)),P.length===0&&e.jsx(v,{sx:{textAlign:"center",py:4},children:e.jsx(y,{variant:"body2",color:"text.secondary",children:"No fields match your search"})})]}),e.jsx(zn,{open:l,onClose:E,columnName:u,sampleData:U(u),onParse:_})]})},Wn=({open:t,onClose:s,fieldName:n,mapping:r,sampleData:o,onSave:a})=>{const[l,p]=A.useState(0),[u,d]=A.useState([]),[m,x]=A.useState("auto"),[T,E]=A.useState(""),[_,C]=A.useState(","),[B,F]=A.useState(0),[U,P]=A.useState("string");A.useEffect(()=>{if(r){if(r.sourceField&&o.length>0){const c=o.map(h=>h[r.sourceField]).filter(h=>h!=null).slice(0,5);d(c)}r.transformations&&r.transformations.length>0&&r.transformations.forEach(c=>{switch(c.type){case"format":const h=c.params.format||c.params.dateFormat;h&&(h==="custom"?(x("custom"),E(c.params.customFormat||"")):x(h));break;case"split":C(c.params.delimiter||","),F(c.params.index||0);break;case"convert":P(c.params.toType||"string");break}})}},[r,o]);const S=(c,h)=>{p(h)},H=()=>{const c=[];l===0&&m!=="auto"&&c.push({type:"format",params:{type:"date",format:m,fieldName:n,...m==="custom"?{customFormat:T}:{}}}),l===1&&c.push({type:"split",params:{delimiter:_,index:B}}),l===2&&c.push({type:"convert",params:{toType:U}}),a(n,c)},Y=u.length>0,i=(()=>{if(!Y)return[];switch(l){case 0:return u.map(c=>{if(!c)return"N/A";try{const h=new Date(c);if(isNaN(h.getTime()))return"Invalid date";switch(m){case"auto":return h.toLocaleString();case"MM/DD/YYYY":return`${h.getMonth()+1}/${h.getDate()}/${h.getFullYear()}`;case"YYYY-MM-DD":return`${h.getFullYear()}-${(h.getMonth()+1).toString().padStart(2,"0")}-${h.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${h.getDate()}/${h.getMonth()+1}/${h.getFullYear()}`;case"date-only":return new Date(c).toLocaleDateString();case"custom":return T.replace("YYYY",h.getFullYear().toString()).replace("MM",(h.getMonth()+1).toString().padStart(2,"0")).replace("DD",h.getDate().toString().padStart(2,"0")).replace("HH",h.getHours().toString().padStart(2,"0")).replace("mm",h.getMinutes().toString().padStart(2,"0")).replace("ss",h.getSeconds().toString().padStart(2,"0"));default:return h.toLocaleString()}}catch{return"Error formatting date"}});case 1:return u.map(c=>{if(!c)return"N/A";try{return c.toString().split(_)[B]||`Index ${B} not found`}catch{return"Error splitting value"}});case 2:return u.map(c=>{if(c==null)return"N/A";try{switch(U){case"string":return String(c);case"number":return Number(c);case"boolean":return(!!c).toString();default:return String(c)}}catch{return"Error converting value"}})}return[]})();return e.jsxs(Qe,{open:t,onClose:s,maxWidth:"md",fullWidth:!0,children:[e.jsxs(et,{children:["Transform Field: ",n]}),e.jsx(tt,{dividers:!0,children:e.jsxs(v,{sx:{width:"100%"},children:[e.jsx(v,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Et,{value:l,onChange:S,"aria-label":"transformation tabs",children:[e.jsx(_e,{label:"Date/Time Format"}),e.jsx(_e,{label:"Split/Extract"}),e.jsx(_e,{label:"Type Conversion"})]})}),e.jsxs(v,{role:"tabpanel",hidden:l!==0,sx:{p:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Date Format Settings"}),e.jsx(y,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Choose how date and time values should be formatted. Date-only formats automatically strip time components."}),e.jsxs(Ue,{fullWidth:!0,sx:{mb:2},children:[e.jsx(We,{id:"date-format-label",children:"Date Format"}),e.jsxs(Ye,{labelId:"date-format-label",id:"date-format-select",value:m,label:"Date Format",onChange:c=>x(c.target.value),children:[e.jsx(oe,{value:"auto",children:"Auto-detect"}),e.jsx(oe,{value:"MM/DD/YYYY",children:"MM/DD/YYYY (date only)"}),e.jsx(oe,{value:"DD/MM/YYYY",children:"DD/MM/YYYY (date only)"}),e.jsx(oe,{value:"YYYY-MM-DD",children:"YYYY-MM-DD (date only)"}),e.jsx(oe,{value:"date-only",children:"Date Only (strip time)"}),e.jsx(oe,{value:"custom",children:"Custom Format"})]})]}),m==="custom"&&e.jsx(be,{fullWidth:!0,label:"Custom Format",value:T,onChange:c=>E(c.target.value),helperText:"Use YYYY for year, MM for month, DD for day, HH for hour, mm for minute, ss for second",sx:{mb:2}})]}),e.jsxs(v,{role:"tabpanel",hidden:l!==1,sx:{p:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Split or Extract Value"}),e.jsx(y,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Split a field by a delimiter and extract a specific part."}),e.jsx(be,{fullWidth:!0,label:"Delimiter",value:_,onChange:c=>C(c.target.value),helperText:"Character or text that separates the parts",sx:{mb:2}}),e.jsx(be,{fullWidth:!0,label:"Index",type:"number",value:B,onChange:c=>F(parseInt(c.target.value)||0),helperText:"Position of the part to extract (0 = first part)",sx:{mb:2}})]}),e.jsxs(v,{role:"tabpanel",hidden:l!==2,sx:{p:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Type Conversion"}),e.jsx(y,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Convert the value to a different data type."}),e.jsxs(Ue,{fullWidth:!0,sx:{mb:2},children:[e.jsx(We,{id:"convert-type-label",children:"Convert To"}),e.jsxs(Ye,{labelId:"convert-type-label",id:"convert-type-select",value:U,label:"Convert To",onChange:c=>P(c.target.value),children:[e.jsx(oe,{value:"string",children:"Text (String)"}),e.jsx(oe,{value:"number",children:"Number"}),e.jsx(oe,{value:"boolean",children:"True/False (Boolean)"})]})]})]}),e.jsx(xe,{sx:{my:2}}),e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Preview"}),Y?e.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(v,{sx:{display:"flex",borderBottom:1,borderColor:"divider",pb:1},children:[e.jsx(y,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Original Value"}),e.jsx(y,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Transformed Value"})]}),u.map((c,h)=>e.jsxs(v,{sx:{display:"flex",py:1,borderBottom:"1px solid #eee"},children:[e.jsx(y,{variant:"body2",sx:{width:"50%"},children:c==null?"Null/Empty":String(c)}),e.jsx(y,{variant:"body2",sx:{width:"50%"},children:i[h]})]},h))]}):e.jsx(de,{severity:"info",children:"No sample data available for preview."})]})}),e.jsxs(rt,{children:[e.jsx(re,{onClick:s,children:"Cancel"}),e.jsx(re,{onClick:H,variant:"contained",children:"Apply Transformation"})]})]})},Yn=t=>{switch(t.dataType){case"string":return`DEFAULT-${t.name}`;case"number":return"0";case"boolean":return"false";case"date":return new Date().toISOString().split("T")[0];case"location":return"0.0,0.0";default:return""}},Gn=({open:t,onClose:s,unmappedRequiredFields:n,onAddDefaultMappings:r})=>{const[o,a]=A.useState(()=>{const d={};return n.forEach(m=>{d[m.name]=Yn(m)}),d}),l=(d,m)=>{a(x=>({...x,[d]:m}))},p=()=>{console.log("Creating default mappings for fields:",n),console.log("Default values:",o);const d=n.map(m=>{const x={sourceField:"__default__",targetField:m.name,transformations:[{type:"convert",params:{defaultValue:o[m.name],targetType:m.dataType}}]};return console.log(`Created default mapping for ${m.name}:`,x),x});console.log("All default mappings:",d),r(d),s()},u=d=>{switch(d){case"number":return"number";case"date":return"date";default:return"text"}};return e.jsxs(Qe,{open:t,onClose:s,"aria-labelledby":"default-value-dialog-title",maxWidth:"md",fullWidth:!0,children:[e.jsx(et,{id:"default-value-dialog-title",children:"Set Default Values for Required Fields"}),e.jsxs(tt,{children:[e.jsx(y,{variant:"body1",sx:{mb:3},children:"The following required fields don't have mappings. Please provide default values for them."}),e.jsx(pe,{container:!0,spacing:3,children:n.map(d=>e.jsxs(pe,{size:{xs:12,sm:6},children:[e.jsxs(v,{sx:{mb:1},children:[e.jsxs(y,{variant:"subtitle2",children:[d.name,e.jsx(le,{size:"small",label:d.dataType,color:"primary",variant:"outlined",sx:{ml:1}})]}),e.jsx(y,{variant:"caption",color:"text.secondary",children:d.description})]}),d.dataType==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:o[d.name]||"false",onChange:m=>l(d.name,m.target.value),variant:"outlined",size:"small",children:[e.jsx(oe,{value:"true",children:"True"}),e.jsx(oe,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:o[d.name]||"",onChange:m=>l(d.name,m.target.value),type:u(d.dataType),variant:"outlined",size:"small",placeholder:`Enter default value for ${d.name}`,InputLabelProps:{shrink:!0}}),e.jsx(ns,{children:"Default value for all records"})]},d.name))})]}),e.jsxs(rt,{children:[e.jsx(re,{onClick:s,color:"primary",children:"Cancel"}),e.jsx(re,{onClick:p,color:"primary",variant:"contained",children:"Apply Default Values"})]})]})},qn=({mapping:t,sampleData:s,onClose:n})=>{const r=Yt(),o=A.useMemo(()=>!t||!s.length?[]:s.slice(0,5).map(l=>({sourceValue:l[t.sourceField],transformedValue:(t.transformations||[]).reduce((p,u)=>Or(p,u,t.targetField),l[t.sourceField])})),[t,s]);if(!t)return e.jsx(ge,{sx:{p:2,mt:2,backgroundColor:me(r.palette.info.light,.1),border:`1px dashed ${r.palette.info.main}`,borderRadius:1},children:e.jsx(y,{variant:"body2",color:"text.secondary",align:"center",children:"Select a field mapping to see transformation preview"})});if(!o.length||!t.sourceField)return e.jsx(ge,{sx:{p:2,mt:2,backgroundColor:me(r.palette.warning.light,.1),border:`1px dashed ${r.palette.warning.main}`,borderRadius:1},children:e.jsxs(y,{variant:"body2",color:"text.secondary",children:["No sample data available for ",t.sourceField||"this field"]})});const a=t.transformations||[];return e.jsxs(ge,{sx:{p:2,mt:2,borderRadius:1,border:`1px solid ${r.palette.divider}`,boxShadow:r.shadows[1],position:"relative"},children:[n&&e.jsx(De,{size:"small",onClick:n,sx:{position:"absolute",top:8,right:8,color:r.palette.grey[500],"&:hover":{backgroundColor:me(r.palette.grey[100],.9),color:r.palette.grey[800]}},"aria-label":"close preview",children:e.jsx(gs,{fontSize:"small"})}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,pr:4},children:[e.jsxs(y,{variant:"subtitle2",color:"primary",gutterBottom:!0,children:["Field Transformation Preview: ",t.targetField]}),e.jsx(le,{size:"small",label:`${a.length} transformation${a.length!==1?"s":""}`,color:a.length>0?"primary":"default",icon:a.length>0?e.jsx(ct,{}):void 0})]}),e.jsx(xe,{sx:{mb:2}}),e.jsx(v,{sx:{maxHeight:200,overflow:"auto"},children:o.map((l,p)=>{const u=l.sourceValue!==void 0&&l.sourceValue!==null,d=a.length>0,m=typeof l.sourceValue,x=typeof l.transformedValue,T=m!==x;return e.jsxs(v,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:p%2===0?me(r.palette.background.default,.5):"transparent",display:"flex",alignItems:"center"},children:[e.jsxs(v,{sx:{flexBasis:"45%"},children:[e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Source (",t.sourceField,")"]}),e.jsx(y,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:u?me(r.palette.success.light,.1):me(r.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:u?String(l.sourceValue):"(empty)"}),e.jsx(y,{variant:"caption",color:"text.secondary",children:m})]}),e.jsx(v,{sx:{flexBasis:"10%",textAlign:"center"},children:e.jsx(wn,{color:d?"primary":"action"})}),e.jsxs(v,{sx:{flexBasis:"45%"},children:[e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Result (",t.targetField,")"]}),e.jsx(y,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:l.transformedValue!==void 0?me(r.palette.success.light,.1):me(r.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:l.transformedValue!==void 0?String(l.transformedValue):"(empty)"}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(y,{variant:"caption",color:"text.secondary",children:x}),T&&e.jsx(le,{size:"small",label:`Type: ${m} → ${x}`,color:"warning",variant:"outlined",sx:{height:16,fontSize:"0.6rem"}})]})]})]},p)})}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{my:2}}),e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Transformation Steps Applied:"}),e.jsx(v,{sx:{display:"flex",flexDirection:"column",gap:1},children:a.map((l,p)=>{var u,d,m,x,T,E,_,C,B;return e.jsxs(v,{sx:{display:"flex",alignItems:"center",p:1,borderRadius:1,backgroundColor:me(r.palette.primary.light,.05),border:`1px solid ${me(r.palette.primary.light,.2)}`},children:[e.jsxs(v,{sx:{mr:1,color:r.palette.primary.main},children:[p+1,"."]}),e.jsxs(y,{variant:"body2",children:[e.jsxs("strong",{children:[l.type,":"]})," "," ",l.type==="convert"&&((u=l.params)==null?void 0:u.dataType)&&`Convert to ${l.params.dataType}`,l.type==="convert"&&((d=l.params)==null?void 0:d.defaultValue)!==void 0&&`Set default value to "${l.params.defaultValue}"`,l.type==="format"&&((m=l.params)==null?void 0:m.type)==="date"&&(((x=l.params)==null?void 0:x.format)||((T=l.params)==null?void 0:T.dateFormat))&&`Format date as "${l.params.format||l.params.dateFormat}"${l.params.customFormat?` (${l.params.customFormat})`:""}`,l.type==="format"&&((E=l.params)==null?void 0:E.pattern)&&`Format using pattern "${l.params.pattern}"`,l.type==="extract"&&((_=l.params)==null?void 0:_.pattern)&&`Extract using pattern "${l.params.pattern}"`,l.type==="replace"&&((C=l.params)==null?void 0:C.from)&&((B=l.params)==null?void 0:B.to)&&`Replace "${l.params.from}" with "${l.params.to}"`]})]},p)})})]}),t.targetField&&e.jsxs(v,{sx:{mt:2,p:1,borderRadius:1,display:"flex",alignItems:"center",backgroundColor:o.some(l=>l.transformedValue===void 0||l.transformedValue===null)?me(r.palette.warning.light,.1):me(r.palette.success.light,.1)},children:[o.some(l=>l.transformedValue===void 0||l.transformedValue===null)?e.jsx(yt,{color:"warning",sx:{mr:1}}):e.jsx(Pr,{color:"success",sx:{mr:1}}),e.jsx(y,{variant:"body2",children:o.some(l=>l.transformedValue===void 0||l.transformedValue===null)?"Some values could not be transformed. Consider adding a default value.":"All sample values were successfully transformed."})]})]})},Jn=$e(({className:t,...s})=>e.jsx(ze,{...s,classes:{popper:t}}))(()=>({"& .MuiTooltip-tooltip":{backgroundColor:"transparent",padding:0,maxWidth:320}})),Kn=$e(ge)(({theme:t})=>({padding:t.spacing(2),backgroundColor:t.palette.background.paper,boxShadow:t.shadows[3],borderRadius:t.shape.borderRadius,border:`1px solid ${t.palette.divider}`,minWidth:200,maxWidth:320})),Xn=$e(y)(({theme:t})=>({fontWeight:600,marginBottom:t.spacing(1),borderBottom:`1px solid ${t.palette.divider}`,paddingBottom:t.spacing(.5),color:t.palette.primary.main})),qe=({title:t,children:s,content:n,icon:r=!1,placement:o="top",enterDelay:a=100,leaveDelay:l=100})=>{console.log(`EnhancedTooltip rendering: ${t} with icon=${r}`);const p=r?e.jsxs(v,{sx:{display:"inline-flex",alignItems:"center"},children:[s,e.jsx(On,{color:"action",fontSize:"small",sx:{ml:.5,opacity:.7}})]}):s;return e.jsx(Jn,{title:e.jsxs(Kn,{children:[e.jsx(Xn,{variant:"subtitle2",children:t}),n]}),placement:o,arrow:!0,enterDelay:a,leaveDelay:l,children:p})},Zn=({toolConfig:t,showAllFields:s,setShowAllFields:n,filter:r,setFilter:o,mappings:a,onMappingChange:l,onRemoveMapping:p,validationErrors:u,sampleData:d,sourceColumns:m=[]})=>{const x=Yt();console.log("TargetFieldsPanel received sourceColumns:",m),console.log("TargetFieldsPanel received toolConfig:",t),console.log("TargetFieldsPanel received mappings:",a);const[T,E]=A.useState(null),[_,C]=A.useState(null),[B,F]=A.useState({Timing:!0,Location:!0,"Incident Details":!0}),U=A.useMemo(()=>{const f={};return u.forEach(L=>{f[L.field]={message:L.message,severity:L.severity}}),f},[u]),P=A.useMemo(()=>{const f={};return a.forEach(L=>{f[L.targetField]=L.sourceField}),f},[a]),S=A.useMemo(()=>{const f={};return[...t.requiredFields,...t.optionalFields].forEach(R=>{let V;R.dataType==="date"||R.name.toLowerCase().includes("time")||R.name.toLowerCase().includes("date")?V="Timing":R.dataType==="location"||R.name.toLowerCase().includes("lat")||R.name.toLowerCase().includes("lon")||R.name.toLowerCase().includes("address")?V="Location":V="Incident Details",f[V]||(f[V]=[]),f[V].push(R)}),f},[t]),H=A.useMemo(()=>{if(!r)return s?[...t.requiredFields,...t.optionalFields]:S;const f=r.toLowerCase(),R=[...t.requiredFields,...t.optionalFields].filter(w=>{var j;return w.name.toLowerCase().includes(f)||((j=w.description)==null?void 0:j.toLowerCase().includes(f))});if(s)return R;const V={};return R.forEach(w=>{let j;for(const[I,J]of Object.entries(S))if(J.some(K=>K.id===w.id)){j=I;break}j||(j="Other"),V[j]||(V[j]=[]),V[j].push(w)}),V},[t,r,s,S]),Y=f=>{F({...B,[f]:!B[f]})},G=(f,L)=>{console.log("Dropdown selection - mapping",L,"to",f);try{if(!L){p(f);return}l({sourceField:L,targetField:f}),console.log("Mapping updated via dropdown successfully")}catch(R){console.error("Error updating mapping via dropdown:",R)}},i=f=>{E(f)},c=()=>{E(null)},h=f=>{C(L=>L===f?null:f)},D=(f,L)=>{const R=a.find(V=>V.targetField===f);R&&l({...R,transformations:L}),E(null)},k=f=>{switch(f){case"string":return{icon:e.jsx(Zt,{fontSize:"small"}),color:"info"};case"number":return{icon:e.jsx(Pn,{fontSize:"small"}),color:"secondary"};case"date":return{icon:e.jsx(_n,{fontSize:"small"}),color:"warning"};case"boolean":return{icon:e.jsx($n,{fontSize:"small"}),color:"success"};case"location":return{icon:e.jsx(us,{fontSize:"small"}),color:"error"};default:return{icon:e.jsx(Zt,{fontSize:"small"}),color:"default"}}},W=f=>{const L=P[f.id],R=U[f.id],V=_===f.id;console.log(`🔧 FIELD RENDER: ${f.name} (ID: ${f.id}), mapped to: ${L||"none"}`);const w=O=>{O.preventDefault(),O.stopPropagation(),O.dataTransfer.dropEffect="move";const b=O.currentTarget;b.style.boxShadow="0 0 0 2px #1976d2",b.style.borderColor="#1976d2",b.style.backgroundColor="#f0f7ff",b.style.transform="scale(1.01)",b.style.transition="all 0.2s ease",console.log("DRAG OVER on target field:",f.name)},j=O=>{O.preventDefault(),O.stopPropagation();const b=O.currentTarget;b.style.boxShadow="",b.style.borderColor=R?R.severity==="error"?"#f44336":"#ff9800":L?"#4caf50":"#e0e0e0",b.style.backgroundColor=R?R.severity==="error"?"#fff5f5":"#fffbf0":L?"#f4fbf4":"#ffffff",b.style.transform="",console.log("DRAG LEAVE from field:",f.name)},I=O=>{O.preventDefault(),O.stopPropagation(),console.log("DROP EVENT TRIGGERED on field:",f.name);try{const b=O.dataTransfer.getData("text/plain");if(console.log("Dropped source field data:",b),!b){console.error("No source field data found in the drop event");return}const g=O.currentTarget;g.style.boxShadow="",g.style.borderColor="",g.style.backgroundColor="",g.style.transform="",l({sourceField:b,targetField:f.id}),C(f.id),g.style.boxShadow="0 0 0 2px #4caf50",g.style.borderColor="#4caf50",g.style.backgroundColor="#f4fbf4",g.style.transform="scale(1.02)";const z=b;setTimeout(()=>{try{z?(g.style.borderColor="#4caf50",g.style.backgroundColor="#f4fbf4"):(g.style.borderColor=R?R.severity==="error"?"#f44336":"#ff9800":"#e0e0e0",g.style.backgroundColor=R?R.severity==="error"?"#fff5f5":"#fffbf0":"#ffffff"),g.style.boxShadow="",g.style.transform=""}catch(q){console.error("Error in animation cleanup:",q)}},1e3),console.log(`Successfully dropped ${b} onto ${f.name}`)}catch(b){console.error("Error in drop handler:",b)}},J=()=>{L&&h(f.name)},K=()=>e.jsxs(v,{children:[e.jsxs(y,{variant:"body2",children:[e.jsx("strong",{children:"Required Format:"})," ",f.format||"No specific format required"]}),f.examples&&e.jsxs(v,{sx:{mt:1},children:[e.jsx(y,{variant:"body2",children:e.jsx("strong",{children:"Examples:"})}),e.jsx(v,{component:"ul",sx:{mt:.5,pl:2},children:f.examples.map((O,b)=>e.jsx(v,{component:"li",children:e.jsx(y,{variant:"body2",fontFamily:"monospace",children:O})},b))})]}),f.validation&&e.jsxs(y,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Validation:"})," ",String(f.validation)]})]}),$=()=>{let O="";switch(f.dataType){case"string":O="Text value. Can contain any characters.";break;case"number":O="Numeric value. Can be integer or decimal.";break;case"date":O="Date value. Should be in a standard format.";break;case"boolean":O="True/False value.";break;case"location":O="Geographic coordinates or address.";break;default:O=`${f.dataType} data type.`}return e.jsxs(v,{children:[e.jsx(y,{variant:"body2",children:O}),f.dataType==="date"&&e.jsx(y,{variant:"body2",sx:{mt:1},children:"Common formats: YYYY-MM-DD, MM/DD/YYYY"})]})};return e.jsxs(v,{sx:{p:2,mb:2,border:"1px solid",borderColor:R?R.severity==="error"?"error.main":"warning.main":L?"success.light":"divider",borderRadius:1,bgcolor:R?R.severity==="error"?me(x.palette.error.light,.1):me(x.palette.warning.light,.1):L?me(x.palette.success.light,.1):"background.paper",position:"relative",transition:"all 0.3s ease",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",cursor:L?"pointer":"default",...V&&{boxShadow:"0 0 0 2px #1976d2",border:"1px solid #1976d2"},"&:hover":L?{boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transform:"translateY(-2px)"}:{}},draggable:!1,id:`target-field-${f.id}`,"data-target-field":f.id,onDragOver:w,onDragLeave:j,onDrop:I,onClick:J,children:[e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(v,{children:[e.jsx(qe,{title:`${f.name} Field`,content:K(),placement:"top-start",icon:!0,children:e.jsxs(y,{variant:"subtitle2",component:"div",sx:{display:"inline-flex",alignItems:"center",cursor:"help"},children:[f.name,f.isRequired&&e.jsx(le,{size:"small",label:"Required",color:"primary",sx:{ml:1,height:20}}),L&&e.jsx(le,{size:"small",label:"Click to preview",color:"info",variant:"outlined",sx:{ml:1,height:20,display:{xs:"none",sm:"flex"},animation:V?"none":"pulse 1.5s infinite","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0.4)"},"70%":{boxShadow:"0 0 0 6px rgba(33, 150, 243, 0)"},"100%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0)"}}}})]})}),f.dataType&&e.jsx(qe,{title:`${f.dataType} Data Type`,content:$(),children:e.jsx(le,{size:"small",label:f.dataType,color:k(f.dataType).color,variant:"outlined",icon:k(f.dataType).icon,sx:{mt:1,mr:1,height:20}})}),e.jsx(y,{variant:"body2",color:"text.secondary",children:f.description})]}),e.jsxs(v,{sx:{display:"flex",alignItems:"flex-start"},children:[R&&e.jsx(qe,{title:"Validation Issue",content:e.jsx(y,{variant:"body2",children:R.message}),type:R.severity==="error"?"warning":"info",children:e.jsx(v,{sx:{display:"flex",alignItems:"center",mr:1},children:R.severity==="error"?e.jsx(_r,{color:"error",fontSize:"small"}):e.jsx(wr,{color:"warning",fontSize:"small"})})}),L&&e.jsxs(e.Fragment,{children:[e.jsx(qe,{title:"Edit Transformations",content:e.jsx(y,{variant:"body2",children:"Configure data transformations for this field mapping. Apply operations like splitting, joining, formatting and type conversion."}),children:e.jsx(De,{size:"small",onClick:O=>{O.stopPropagation(),i(f.id)},sx:{mr:1},children:e.jsx(jr,{fontSize:"small"})})}),e.jsx(qe,{title:"Remove Mapping",content:e.jsx(y,{variant:"body2",children:"Remove the current mapping between source and target fields."}),type:"warning",children:e.jsx(De,{size:"small",onClick:O=>{O.stopPropagation(),p(f.id)},children:e.jsx(lt,{fontSize:"small"})})})]})]})]}),e.jsxs(Ue,{fullWidth:!0,size:"small",children:[e.jsx(We,{id:`${f.id}-source-label`,children:"Select source field"}),e.jsxs(Ye,{labelId:`${f.id}-source-label`,id:`${f.id}-source-select`,value:L||"",label:"Select source field",onChange:O=>{try{G(f.id,O.target.value),O.target.value?C(f.name):_===f.name&&C(null)}catch(b){console.error("Error in dropdown change handler:",b)}},MenuProps:{anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},slotProps:{paper:{elevation:4,style:{maxHeight:300}}}},renderValue:O=>O||e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"}),endAdornment:L&&e.jsx(Re,{position:"end",children:e.jsx(qe,{title:"Field is Mapped",content:e.jsxs(y,{variant:"body2",children:['This field is mapped to source field "',L,'". Click the field to preview the mapping.']}),children:e.jsx(Xe,{color:"success",fontSize:"small"})})}),onClick:O=>O.stopPropagation(),children:[e.jsx(oe,{value:"",children:e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"})}),Array.isArray(m)&&m.length>0?m.map(O=>{const b=d&&d.length>0?d[0][O]:void 0;let g="Unknown";b!=null&&(typeof b=="string"?[/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/].some(Z=>Z.test(b))?g="Date":/^\d{1,2}:\d{2}(:\d{2})?(\s*(AM|PM))?$/i.test(b)?g="Time":isNaN(Number(b))?g="Text":g="Number":g=typeof b);const z=q=>q==null?"":typeof q=="object"?JSON.stringify(q).substring(0,30):String(q).substring(0,30);return e.jsx(oe,{value:O,children:e.jsxs(v,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsx(y,{variant:"body2",children:O}),b!==void 0&&e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(y,{variant:"caption",sx:{fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"text.secondary"},children:z(b)}),e.jsx(le,{label:g,size:"small",sx:{height:16,fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]})]})},O)}):e.jsx(oe,{disabled:!0,children:e.jsx("em",{children:"No source fields available"})})]})]})]},f.id)},X=()=>{if(s){const f=Array.isArray(H)?H:Object.values(H).flat();return e.jsx(v,{children:f.map(W)})}else return Object.entries(H).map(([f,L])=>e.jsxs(Fr,{expanded:B[f]||!1,onChange:()=>Y(f),sx:{mb:2},children:[e.jsxs(Cr,{expandIcon:e.jsx(Ft,{}),children:[e.jsx(y,{variant:"subtitle1",children:f}),e.jsxs(y,{variant:"body2",color:"text.secondary",sx:{ml:2},children:[L.length," fields"]})]}),e.jsx(Dr,{children:L.map(W)})]},f))},[ae,M]=A.useState(!1),N=A.useMemo(()=>t.requiredFields.filter(L=>!a.some(R=>R.targetField===L.name)),[t.requiredFields,a]),ee=f=>{console.log("Received default mappings:",f),f.forEach(L=>{console.log("Adding default mapping for:",L.targetField,L),l(L)}),console.log("Current mappings after adding defaults:",a)};return e.jsxs(ge,{sx:{p:2,height:"100%",display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[N.length>0&&e.jsxs(re,{variant:"outlined",size:"small",startIcon:e.jsx(Xr,{}),onClick:()=>M(!0),color:"primary",children:["Set Default Values (",N.length,")"]}),e.jsx(Je,{control:e.jsx(cs,{checked:s,onChange:f=>n(f.target.checked),size:"small"}),label:"Show all fields A-Z"})]}),N.length>0&&e.jsxs(de,{severity:"warning",sx:{mb:2},action:e.jsx(re,{color:"inherit",size:"small",onClick:()=>M(!0),children:"Set Defaults"}),children:[N.length," required ",N.length===1?"field":"fields"," not mapped. Please map or set default values to continue."]}),e.jsx(be,{size:"small",placeholder:"Search target fields...",value:r,onChange:f=>o(f.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Re,{position:"start",children:e.jsx(it,{fontSize:"small"})})}}),e.jsx(xe,{sx:{mb:2}}),e.jsx(v,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(y,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drop source fields onto target fields or use the drop-down menus below"})}),_&&e.jsx(qn,{mapping:a.find(f=>f.targetField===_)||null,sampleData:d,onClose:()=>C(null)}),e.jsx(v,{sx:{flexGrow:1,maxHeight:"calc(100% - 220px)",overflow:"auto",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:X()}),T&&e.jsx(Wn,{open:!!T,onClose:c,fieldName:T,mapping:a.find(f=>f.targetField===T),sampleData:d,onSave:D}),e.jsx(Gn,{open:ae,onClose:()=>M(!1),unmappedRequiredFields:N,onAddDefaultMappings:ee})]})},Qn=({validationErrors:t,jumpToField:s})=>{const[n,r]=Ze.useState(!1),o=t.filter(p=>p.severity==="error").length,a=t.filter(p=>p.severity==="warning").length,l=()=>{r(!n)};return e.jsxs(ge,{sx:{p:2,position:"sticky",top:16},children:[e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer"},onClick:l,children:[e.jsxs(y,{variant:"h6",color:o>0?"error":"warning",children:["Validation Issues ",o>0?`(${o} errors, ${a} warnings)`:`(${a} warnings)`]}),e.jsx(re,{size:"small",endIcon:n?e.jsx(br,{}):e.jsx(Ft,{}),children:n?"Collapse":"Expand"})]}),e.jsxs(Ir,{in:n,children:[e.jsx(xe,{sx:{my:1}}),e.jsx(v,{sx:{maxHeight:"200px",overflow:"auto"},children:e.jsx(Be,{dense:!0,children:t.map((p,u)=>e.jsxs(Ee,{sx:{bgcolor:p.severity==="error"?"error.lightest":"warning.lightest",mb:.5,borderRadius:1},children:[e.jsx(ke,{children:p.severity==="error"?e.jsx(_r,{color:"error"}):e.jsx(wr,{color:"warning"})}),e.jsx(Fe,{primary:p.field,secondary:p.message}),e.jsx(re,{size:"small",variant:"outlined",color:p.severity==="error"?"error":"warning",onClick:()=>s(p.field),children:"Go to Field"})]},u))})})]})]})},eo=({sampleData:t,mappings:s,toolConfig:n})=>{const r=A.useMemo(()=>t.length>0?t[0]:null,[t]),o=A.useMemo(()=>{if(!r||!s.length)return null;const u=Mr([r],s);return u.length>0?u[0]:null},[r,s]);if(!r||!o)return e.jsx(v,{sx:{p:2,textAlign:"center"},children:e.jsx(y,{variant:"body2",color:"text.secondary",children:"No data available for preview. Upload a file and map fields to see a live preview."})});const a=Object.keys(r),l=Object.keys(o);console.log("🔍 LIVE PREVIEW DEBUG: Transformed row keys:",l),console.log("🔍 LIVE PREVIEW DEBUG: Mappings count:",s.length),console.log("🔍 LIVE PREVIEW DEBUG: Mappings:",s.map(u=>`${u.sourceField} → ${u.targetField}`)),console.log("🔍 LIVE PREVIEW DEBUG: Tool config available:",!!n),console.log("🔍 LIVE PREVIEW DEBUG: Field ID → Display Name conversions incoming...");const p=u=>{if(!n)return console.log(`🔍 LIVE PREVIEW: No toolConfig for field ${u}`),u;const m=[...n.requiredFields||[],...n.optionalFields||[]].find(x=>x.id===u);return console.log(`🔍 LIVE PREVIEW: Converting field ID "${u}" → display name "${m?m.name:u}"`),m?m.name:u};return e.jsxs(v,{children:[e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(y,{variant:"subtitle1",children:"Live Preview"}),e.jsx(y,{variant:"body2",color:"text.secondary",children:"Showing all mapped fields • Scroll horizontally to see more →"})]}),e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:2,overflowX:"auto"},children:[e.jsx(Lt,{component:ge,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(ht,{size:"small",stickyHeader:!0,children:[e.jsx(gt,{children:e.jsx(Ne,{children:a.map(u=>e.jsx(Ce,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(y,{variant:"caption",fontWeight:"bold",children:u})},u))})}),e.jsx(ft,{children:e.jsx(Ne,{children:a.map(u=>e.jsx(Ce,{sx:{minWidth:"120px"},children:e.jsx(y,{variant:"caption",sx:{wordBreak:"break-word"},children:r[u]!==null&&r[u]!==void 0?String(r[u]):"null"})},u))})})]})}),e.jsx(v,{sx:{display:"flex",justifyContent:"center",alignItems:"center",px:2,flexShrink:0},children:e.jsx(Dn,{color:"primary"})}),e.jsx(Lt,{component:ge,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(ht,{size:"small",stickyHeader:!0,children:[e.jsx(gt,{children:e.jsx(Ne,{children:l.map(u=>e.jsx(Ce,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(y,{variant:"caption",fontWeight:"bold",children:p(u)})},u))})}),e.jsx(ft,{children:e.jsx(Ne,{children:l.map(u=>e.jsx(Ce,{sx:{minWidth:"120px"},children:e.jsx(y,{variant:"caption",sx:{wordBreak:"break-word"},children:o[u]!==null&&o[u]!==void 0?String(o[u]):"null"})},u))})})]})})]})]})},Lr=(t,s)=>{A.useEffect(()=>{if(s)try{localStorage.setItem(`tmpl:${t.id}`,JSON.stringify(t)),console.log(`Template "${t.name}" saved to localStorage`)}catch(m){console.error("Failed to save template to localStorage:",m)}},[t,s]);const n=m=>{try{let E=Object.keys(localStorage).filter(_=>_.startsWith("tmpl:")).map(_=>{const C=localStorage.getItem(_);return C?JSON.parse(C):null}).filter(Boolean);return m&&(E=E.filter(_=>_.toolId===m)),E.sort((_,C)=>C.lastModified-_.lastModified)}catch(x){return console.error("Failed to load templates from localStorage:",x),[]}},r=m=>{try{return localStorage.removeItem(`tmpl:${m}`),!0}catch(x){return console.error("Failed to delete template:",x),!1}};return{loadTemplates:n,deleteTemplate:r,saveToServer:async()=>(console.log("Saving template to server:",t),new Promise(m=>{setTimeout(()=>{console.log("Template saved to server successfully"),m()},500)})),loadFromServer:async()=>n(),autoSaveTemplate:(m,x)=>{if(!m||m.length===0)return;const T={id:`auto-${x}-${Date.now()}`,name:`Auto-saved ${x} mapping`,description:"Automatically saved field mapping configuration",toolId:x,mappings:m,lastModified:Date.now()};try{localStorage.setItem(`tmpl:${T.id}`,JSON.stringify(T)),console.log("Template auto-saved:",T.name)}catch(E){console.error("Failed to auto-save template:",E)}},getTemplateStats:()=>{var T;const m=n(),x={total:m.length,byTool:{},mostRecent:((T=m[0])==null?void 0:T.lastModified)||0,totalMappings:m.reduce((E,_)=>{var C;return E+(((C=_.mappings)==null?void 0:C.length)||0)},0)};return m.forEach(E=>{const _=E.toolId||"unknown";x.byTool[_]=(x.byTool[_]||0)+1}),x},findSimilarTemplates:(m,x)=>{if(!m||m.length===0)return[];const T=n(x),E=new Set(m.map(_=>_.sourceField.toLowerCase()));return T.map(_=>{const C=new Set(_.mappings.map(U=>U.sourceField.toLowerCase())),F=new Set([...E].filter(U=>C.has(U))).size/Math.max(E.size,C.size);return{template:_,similarity:F}}).filter(({similarity:_})=>_>.3).sort((_,C)=>C.similarity-_.similarity).map(({template:_})=>_)},cleanupAutoSaved:()=>{try{n().filter(T=>T.name.startsWith("Auto-saved")).sort((T,E)=>E.lastModified-T.lastModified).slice(5).forEach(T=>{r(T.id)})}catch(m){console.error("Failed to cleanup auto-saved templates:",m)}}}},Ut={id:"vendor_console_one_standard",name:"Console One CAD - Standard Template",description:"Professional template for Console One CAD systems with NFIRS code support. Includes incident times, unit information, and location data.",cadVendor:"Console One",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"INC_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_TIME",targetField:"dispatch_time"},{sourceField:"ENROUTE_TIME",targetField:"enroute_time"},{sourceField:"ARRIVAL_TIME",targetField:"arrival_time"},{sourceField:"CLEAR_TIME",targetField:"clear_time"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"UNIT_ID",targetField:"responding_unit"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["INC_DATE_TIME","INC_NUM","INC_DATE","DISPATCH_TIME","ENROUTE_TIME","ARRIVAL_TIME","CLEAR_TIME","PROBLEM_TYPE","UNIT_ID","LOCATION_ADDRESS","LATITUDE","LONGITUDE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Console One"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:95,successRate:100,dataTypes:{},sampleValues:{INC_DATE_TIME:["01/15/2024 14:23:45","01/15/2024 15:30:12"],PROBLEM_TYPE:["111","522","311","651"],UNIT_ID:["E01","T01","M01","BC01"]},tags:["console-one","nfirs","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},to={id:"vendor_tyler_standard",name:"Tyler Technologies CAD - Standard Template",description:"Professional template for Tyler Technologies CAD systems. Handles mixed field naming conventions and date formats common in Tyler exports.",cadVendor:"Tyler",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"ALARM_TIME",targetField:"incident_time"},{sourceField:"INCIDENT_NUMBER",targetField:"incident_id"},{sourceField:"INCIDENT_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_DATE",targetField:"dispatch_time"},{sourceField:"ENROUTE_DATE",targetField:"enroute_time"},{sourceField:"ARRIVAL_DATE",targetField:"arrival_time"},{sourceField:"CLEAR_DATE",targetField:"clear_time"},{sourceField:"NATURE_CODE",targetField:"incident_type"},{sourceField:"PRIMARY_UNIT",targetField:"responding_unit"},{sourceField:"ADDRESS",targetField:"address"},{sourceField:"CITY",targetField:"city"},{sourceField:"STATE",targetField:"state"}],sourceFieldPattern:{fieldNames:["ALARM_TIME","INCIDENT_NUMBER","INCIDENT_DATE","DISPATCH_DATE","ENROUTE_DATE","ARRIVAL_DATE","CLEAR_DATE","NATURE_CODE","PRIMARY_UNIT","ADDRESS","CITY","STATE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Tyler"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:92,successRate:98,dataTypes:{},sampleValues:{ALARM_TIME:["2024-01-15 14:23:45","2024-01-15 15:30:12"],NATURE_CODE:["FIREA","EMSC","FIREB","HAZMAT"],PRIMARY_UNIT:["Engine 1","Truck 1","Medic 1","Chief 1"]},tags:["tyler","tyler-technologies","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},ro={id:"vendor_hexagon_standard",name:"Hexagon/Intergraph CAD - Standard Template",description:"Professional template for Hexagon/Intergraph CAD systems. Handles PascalCase field naming and mixed datetime formats with/without seconds.",cadVendor:"Hexagon",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"CallDateTime",targetField:"incident_time"},{sourceField:"IncidentNumber",targetField:"incident_id"},{sourceField:"CallDate",targetField:"incident_date"},{sourceField:"DispatchDateTime",targetField:"dispatch_time"},{sourceField:"EnRouteDateTime",targetField:"enroute_time"},{sourceField:"ArrivalDateTime",targetField:"arrival_time"},{sourceField:"ClearDateTime",targetField:"clear_time"},{sourceField:"IncidentType",targetField:"incident_type"},{sourceField:"UnitId",targetField:"responding_unit"},{sourceField:"LocationAddress",targetField:"address"},{sourceField:"Latitude",targetField:"latitude"},{sourceField:"Longitude",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["CallDateTime","IncidentNumber","CallDate","DispatchDateTime","EnRouteDateTime","ArrivalDateTime","ClearDateTime","IncidentType","UnitId","LocationAddress","Latitude","Longitude"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Hexagon"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:90,successRate:95,dataTypes:{},sampleValues:{CallDateTime:["01/20/2024 14:28","01/20/2024 15:35:22"],IncidentType:["Structure Fire","Medical Emergency","Vehicle Accident"],UnitId:["ENG001","TRK001","MED001","BC001"]},tags:["hexagon","intergraph","pascalcase","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},so={id:"vendor_tritech_standard",name:"TriTech/CentralSquare CAD - Standard Template",description:"Professional template for TriTech/CentralSquare CAD systems. Handles underscore_case naming conventions and EventNum identifiers.",cadVendor:"TriTech",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"Call_Date_Time",targetField:"incident_time"},{sourceField:"EventNum",targetField:"incident_id"},{sourceField:"Call_Date",targetField:"incident_date"},{sourceField:"Dispatch_Time",targetField:"dispatch_time"},{sourceField:"Enroute_Time",targetField:"enroute_time"},{sourceField:"Arrival_Time",targetField:"arrival_time"},{sourceField:"Clear_Time",targetField:"clear_time"},{sourceField:"Call_Type",targetField:"incident_type"},{sourceField:"Unit_ID",targetField:"responding_unit"},{sourceField:"Address",targetField:"address"},{sourceField:"City",targetField:"city"},{sourceField:"State",targetField:"state"}],sourceFieldPattern:{fieldNames:["Call_Date_Time","EventNum","Call_Date","Dispatch_Time","Enroute_Time","Arrival_Time","Clear_Time","Call_Type","Unit_ID","Address","City","State"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"TriTech"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:88,successRate:93,dataTypes:{},sampleValues:{Call_Date_Time:["2024-01-15 14:23:45","2024-01-15 15:30:12"],Call_Type:["FIRE","EMS","RESCUE","HAZMAT"],Unit_ID:["E1","L1","M1","C1"]},tags:["tritech","centralsquare","underscore","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},no={...Ut,id:"vendor_console_one_firemap",name:"Console One CAD - Fire Map Pro Template",description:"Geographic analysis template for Console One CAD data. Optimized for incident mapping and spatial analysis.",targetTool:"fire-map-pro",fieldMappings:[{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"UNIT_ID",targetField:"responding_unit"}],metadata:{...Ut.metadata,tags:["console-one","fire-map-pro","geographic","certified"]}},Ht=[Ut,to,ro,so,no],oo=()=>Ht.filter(t=>{var s;return((s=t.metadata.tags)==null?void 0:s.includes("certified"))&&t.isPublic}),bt=()=>{try{const t=JSON.parse(localStorage.getItem("fireems_field_mapping_templates")||"[]");if(t.some(n=>{var r;return(r=n.id)==null?void 0:r.startsWith("vendor_")}))console.log("📚 Vendor templates already exist, skipping seed");else{console.log("🌱 Seeding vendor templates for first-time user...");const n=[...t,...Ht];localStorage.setItem("fireems_field_mapping_templates",JSON.stringify(n)),console.log(`✅ Seeded ${Ht.length} vendor templates successfully`)}}catch(t){console.error("❌ Error seeding vendor templates:",t)}};class Ke{static async saveTemplate(s,n,r,o,a,l,p,u){const d={id:this.generateTemplateId(),name:s.trim(),description:n.trim(),departmentName:p,cadVendor:u,targetTool:l,fieldMappings:r,sourceFieldPattern:this.analyzeSourcePattern(o,a),metadata:this.generateMetadata(r,a),createdAt:new Date().toISOString(),useCount:0,isPublic:!1},m=this.getStoredTemplates();return m.push(d),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(m)),console.log(`✅ Template saved: "${s}" (${d.id})`),d}static getTemplates(){try{bt();const s=this.getStoredTemplates();return console.log("📚 TemplateService.getTemplates() found:",s.length,"templates"),console.log("🏅 Vendor templates:",s.filter(n=>{var r;return(r=n.id)==null?void 0:r.startsWith("vendor_")}).length),s}catch(s){return console.error("❌ Error in getTemplates:",s),[]}}static getTemplatesForTool(s){return bt(),this.getStoredTemplates().filter(n=>n.targetTool===s)}static getCertifiedTemplatesForTool(s){return oo().filter(n=>n.targetTool===s)}static deleteTemplate(s){const n=this.getStoredTemplates(),r=n.findIndex(o=>o.id===s);return r!==-1?(n.splice(r,1),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)),console.log(`🗑️ Template deleted: ${s}`),!0):!1}static suggestTemplates(s,n,r){var l;const o=this.getTemplatesForTool(r),a=[];for(const p of o){const u=this.calculateSimilarity(s,p.sourceFieldPattern.fieldNames);if(u.score>=30){let d=u.score;(l=p.metadata.tags)!=null&&l.includes("certified")&&p.isPublic&&(d+=10,console.log(`🏅 Certified template boost: "${p.name}" ${u.score}% → ${d}%`)),a.push({template:p,similarityScore:d,matchingFields:u.matchingFields,missingFields:u.missingFields,suggestions:this.generateSuggestions(u,p)})}}return a.sort((p,u)=>{var x,T;const d=(x=p.template.metadata.tags)!=null&&x.includes("certified")?1:0,m=(T=u.template.metadata.tags)!=null&&T.includes("certified")?1:0;return d!==m?m-d:u.similarityScore-p.similarityScore}),console.log(`🔍 Found ${a.length} template suggestions for tool: ${r}`),console.log(`🏅 Certified templates: ${a.filter(p=>{var u;return(u=p.template.metadata.tags)==null?void 0:u.includes("certified")}).length}`),a.slice(0,8)}static applyTemplate(s,n){const r=[];this.incrementTemplateUsage(s.id);for(const o of s.fieldMappings){if(n.includes(o.sourceField)){r.push({...o});continue}const a=n.find(p=>p.toLowerCase()===o.sourceField.toLowerCase());if(a){r.push({...o,sourceField:a});continue}const l=this.findFuzzyMatch(o.sourceField,n);l&&r.push({...o,sourceField:l})}return console.log(`🔧 Applied template "${s.name}": ${r.length} mappings applied`),r}static generateCADSignature(s){const n={"Console One":["INC_DATE_TIME","PROBLEM_TYPE","UNIT_ID"],Tyler:["ALARM_TIME","INCIDENT_DATE","DISPATCH_DATE"],Hexagon:["CallDateTime","DispatchDateTime","ArrivalDateTime"],TriTech:["EventNum","Call_Date_Time","Unit_ID"]};let r="Other",o=0;for(const[a,l]of Object.entries(n)){const p=l.filter(u=>s.some(d=>d.toLowerCase().includes(u.toLowerCase()))).length;p>o&&(o=p,r=a)}return r}static getStoredTemplates(){try{const s=localStorage.getItem(this.STORAGE_KEY);return s?JSON.parse(s):[]}catch(s){return console.warn("Failed to load templates from localStorage:",s),[]}}static generateTemplateId(){return`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static analyzeSourcePattern(s,n){return{fieldNames:[...s],fieldCount:s.length,hasHeaderRow:!0,commonPatterns:this.extractCommonPatterns(s),cadVendorSignature:this.generateCADSignature(s)}}static extractCommonPatterns(s){const n=[],r={datetime:["date","time","datetime"],location:["address","location","lat","lng","coord"],incident:["incident","call","event","alarm"],unit:["unit","apparatus","resource"],type:["type","category","classification"]};for(const[o,a]of Object.entries(r))a.some(l=>s.some(p=>p.toLowerCase().includes(l)))&&n.push(o);return n}static generateMetadata(s,n){const o=Math.min(100,s.length/10*100),a={};if(n.length>0)for(const l of s){const p=n.slice(0,3).map(u=>u[l.sourceField]).filter(u=>u!=null&&u!=="").map(u=>String(u));p.length>0&&(a[l.sourceField]=p)}return{version:this.VERSION,compatibility:["1.0.0"],qualityScore:Math.round(o),successRate:100,dataTypes:{},sampleValues:a,tags:[]}}static calculateSimilarity(s,n){const r=new Set(s.map(p=>p.toLowerCase()));new Set(n.map(p=>p.toLowerCase()));const o=[],a=[];for(const p of n)r.has(p.toLowerCase())?o.push(p):a.push(p);const l=o.length/n.length*100;return{score:Math.round(l),matchingFields:o,missingFields:a}}static generateSuggestions(s,n){const r=[];return s.score>=80?r.push("Excellent match! This template should work with minimal adjustments."):s.score>=60?r.push("Good match. May need minor field mapping adjustments."):s.score>=30&&r.push("Partial match. Review field mappings carefully."),s.missingFields.length>0&&r.push(`Missing fields: ${s.missingFields.slice(0,3).join(", ")}`),r}static findFuzzyMatch(s,n){const r=s.toLowerCase();for(const o of n){const a=o.toLowerCase();if(this.stringSimilarity(r,a)>=.7)return o}return null}static stringSimilarity(s,n){const r=s.length>n.length?s:n,o=s.length>n.length?n:s;if(r.length===0)return 1;const a=this.levenshteinDistance(r,o);return(r.length-a)/r.length}static levenshteinDistance(s,n){const r=[];for(let o=0;o<=n.length;o++)r[o]=[o];for(let o=0;o<=s.length;o++)r[0][o]=o;for(let o=1;o<=n.length;o++)for(let a=1;a<=s.length;a++)n.charAt(o-1)===s.charAt(a-1)?r[o][a]=r[o-1][a-1]:r[o][a]=Math.min(r[o-1][a-1]+1,r[o][a-1]+1,r[o-1][a]+1);return r[n.length][s.length]}static incrementTemplateUsage(s){const n=this.getStoredTemplates(),r=n.find(o=>o.id===s);r&&(r.useCount++,r.lastUsed=new Date().toISOString(),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)))}}ut(Ke,"STORAGE_KEY","fireems_field_mapping_templates"),ut(Ke,"VERSION","1.0.0");const ao=({currentTemplate:t,setCurrentTemplate:s,setTemplateDirty:n,onTemplateApplied:r,disabled:o=!1,currentMappings:a=[],sourceFields:l=[],sampleData:p=[],targetTool:u="",onApplyFieldMappings:d})=>{const[m,x]=A.useState(null),[T,E]=A.useState(!1),[_,C]=A.useState(!1),[B,F]=A.useState(t.name),[U,P]=A.useState(t.description||""),[S,H]=A.useState([]),[Y,G]=A.useState([]),[i,c]=A.useState(""),[h,D]=A.useState(""),{loadTemplates:k,deleteTemplate:W,saveToServer:X}=Lr(t,!1);A.useEffect(()=>{const b=k();H(b),l.length>0&&u&&p.length>0&&ae()},[l,u,p]);const ae=()=>{try{const b=Ke.suggestTemplates(l,p,u);G(b);const g=Ke.generateCADSignature(l);c(g)}catch(b){console.error("Error loading template suggestions:",b)}},M=b=>{x(b.currentTarget)},N=()=>{x(null)},ee=()=>{const b=t.name==="Untitled Mapping"?O():t.name;F(b),P(t.description||""),E(!0),N()},f=()=>{const b=k();H(b),C(!0),N()},L=async()=>{try{if(a.length>0&&l.length>0&&u)await Ke.saveTemplate(B,U,a,l,p,u,h||void 0,i||void 0);else{const g={...t,name:B,description:U,lastModified:Date.now()};s(g),X()}n(!1);const b=k();H(b),E(!1)}catch(b){console.error("Error saving template:",b)}},R=b=>{s(b),n(!1),r&&r(b),C(!1)},V=b=>{try{const g=Ke.applyTemplate(b,l);d&&d(g),C(!1)}catch(g){console.error("Error applying template:",g)}},w=b=>{W(b);const g=k();H(g)},j=b=>{const g={...b,id:`template-${Date.now()}`,name:`${b.name} (Copy)`,lastModified:Date.now()};localStorage.setItem(`tmpl:${g.id}`,JSON.stringify(g));const z=k();H(z)},I=b=>{const g=new Date(b),q=(new Date().getTime()-g.getTime())/(1e3*60*60);return q<24?`${Math.floor(q)} hours ago`:q<24*7?`${Math.floor(q/24)} days ago`:g.toLocaleDateString()},J=b=>{const g=b.name.toLowerCase(),z=(b.description||"").toLowerCase(),q=`${g} ${z}`;return q.includes("tyler")||q.includes("cad")?"CAD System":q.includes("monthly")||q.includes("export")?"Monthly Report":q.includes("response")||q.includes("time")?"Response Time":q.includes("fire")||q.includes("map")?"Fire Map":q.includes("test")||q.includes("sample")?"Test Data":"General"},K=b=>{switch(b){case"CAD System":return"primary";case"Monthly Report":return"success";case"Response Time":return"info";case"Fire Map":return"warning";case"Test Data":return"secondary";default:return"secondary"}},$=S.reduce((b,g)=>{const z=g.toolId||"unknown";return b[z]||(b[z]=[]),b[z].push(g),b},{}),O=()=>{const b=t.toolId||"Tool",g=new Date,z=g.toLocaleDateString("en-US",{month:"long"});if(t.mappings.length>0){const q=t.mappings.map(Z=>Z.sourceField.toLowerCase());if(q.some(Z=>Z.includes("tyler")))return`Tyler CAD Export - ${z} ${g.getFullYear()}`;if(q.some(Z=>Z.includes("dispatch")||Z.includes("call")))return`${b} Monthly Export - ${z}`}return`${b} Mapping Template`};return e.jsxs(e.Fragment,{children:[e.jsx(ze,{title:o?"Complete field mapping to access templates":"Save and load field mapping templates",children:e.jsx("span",{children:e.jsx(re,{variant:"outlined",size:"small",onClick:M,startIcon:e.jsx(ar,{}),disabled:o,children:"Templates"})})}),e.jsxs(os,{anchorEl:m,open:!!m,onClose:N,children:[e.jsxs(oe,{onClick:ee,children:[e.jsx(Tr,{fontSize:"small",sx:{mr:1}}),"Save Template As..."]}),e.jsxs(oe,{onClick:f,children:[e.jsx(ar,{fontSize:"small",sx:{mr:1}}),"Load Template"]}),e.jsxs(oe,{onClick:()=>{bt();const b=k();H(b),console.log("🌱 Vendor templates seeded manually")},children:[e.jsx(_t,{fontSize:"small",sx:{mr:1}}),"Load Vendor Templates"]})]}),e.jsxs(Qe,{open:T,onClose:()=>E(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(et,{children:"Save Mapping Template"}),e.jsxs(tt,{children:[e.jsx(de,{severity:"info",sx:{mb:3},children:e.jsx(y,{variant:"body2",children:"Save this field mapping configuration for future use. Templates help you quickly map data from the same source system."})}),e.jsx(be,{autoFocus:!0,margin:"dense",label:"Template Name",fullWidth:!0,value:B,onChange:b=>F(b.target.value),sx:{mb:2},placeholder:"e.g., Tyler CAD Monthly Export, Fire Map Pro Standard"}),e.jsx(be,{margin:"dense",label:"Description (optional)",fullWidth:!0,multiline:!0,rows:2,value:U,onChange:b=>P(b.target.value),placeholder:"e.g., Standard monthly incident export from Tyler Technologies CAD system"}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(be,{margin:"dense",label:"Department Name (optional)",fullWidth:!0,value:h,onChange:b=>D(b.target.value),placeholder:"e.g., Houston Fire Department",sx:{mt:2}}),e.jsxs(be,{margin:"dense",label:"CAD Vendor",fullWidth:!0,select:!0,value:i,onChange:b=>c(b.target.value),sx:{mt:2},children:[e.jsx(oe,{value:"Console One",children:"Console One"}),e.jsx(oe,{value:"Tyler",children:"Tyler Technologies"}),e.jsx(oe,{value:"Hexagon",children:"Hexagon/Intergraph"}),e.jsx(oe,{value:"TriTech",children:"TriTech/CentralSquare"}),e.jsx(oe,{value:"Other",children:"Other"})]})]}),e.jsx(Ct,{variant:"outlined",sx:{mt:2},children:e.jsxs(Dt,{children:[e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Template Preview"}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Tool: ",t.toolId||"Unknown"]}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Mappings: ",t.mappings.length," field mappings"]}),t.mappings.length>0&&e.jsx(v,{sx:{mt:1},children:e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Sample mappings: ",t.mappings.slice(0,3).map(b=>`${b.sourceField} → ${b.targetField}`).join(", "),t.mappings.length>3&&` +${t.mappings.length-3} more`]})})]})})]}),e.jsxs(rt,{children:[e.jsx(re,{onClick:()=>E(!1),children:"Cancel"}),e.jsx(re,{onClick:L,variant:"contained",children:"Save Template"})]})]}),e.jsxs(Qe,{open:_,onClose:()=>C(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(et,{children:"Load Mapping Template"}),e.jsxs(tt,{children:[Y.length>0&&e.jsxs(v,{sx:{mb:4},children:[e.jsxs(y,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(In,{sx:{mr:1,fontSize:20}}),"Smart Template Suggestions",e.jsx(le,{label:Y.length,size:"small",sx:{ml:1}})]}),e.jsx(de,{severity:"success",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:["Found ",Y.length," template",Y.length!==1?"s":""," that match your data structure. These are pre-configured for your CAD system type."]})}),e.jsx(Be,{children:Y.map((b,g)=>{var z;return e.jsx(Ee,{component:"button",onClick:()=>V(b.template),sx:{py:2,borderRadius:1,mb:1,border:1,borderColor:b.similarityScore>=80?"success.main":"divider","&:hover":{backgroundColor:"action.hover"}},children:e.jsx(Fe,{primary:e.jsxs(nt,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsxs(v,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(y,{variant:"subtitle1",children:b.template.name}),((z=b.template.metadata.tags)==null?void 0:z.includes("certified"))&&e.jsx(le,{icon:e.jsx(Nn,{}),label:"Certified",color:"primary",size:"small",variant:"filled"})]}),e.jsx(le,{label:`${b.similarityScore}% match`,color:b.similarityScore>=80?"success":b.similarityScore>=60?"warning":"default",size:"small"}),b.template.cadVendor&&e.jsx(le,{label:b.template.cadVendor,size:"small",variant:"outlined"})]}),secondary:e.jsxs(v,{sx:{mt:.5},children:[e.jsx(y,{variant:"body2",sx:{mb:.5},children:b.template.description}),e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Matching fields: ",b.matchingFields.join(", ")]}),b.missingFields.length>0&&e.jsxs(y,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["Missing: ",b.missingFields.slice(0,3).join(", "),b.missingFields.length>3&&` +${b.missingFields.length-3} more`]})]})})},b.template.id)})})]}),S.length===0&&Y.length===0?e.jsxs(v,{sx:{textAlign:"center",py:4},children:[e.jsx(_t,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(y,{variant:"h6",gutterBottom:!0,children:"No saved templates found"}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Templates save your field mapping configurations for reuse with similar data exports."}),e.jsx(de,{severity:"info",children:e.jsxs(y,{variant:"body2",children:[e.jsx("strong",{children:"Pro Tip:"})," After mapping fields for your CAD system, save it as a template. Next month's export will auto-map instantly!"]})})]}):S.length>0&&e.jsxs(v,{children:[Y.length>0&&e.jsxs(y,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mt:2},children:[e.jsx(Bt,{sx:{mr:1,fontSize:20}}),"Your Saved Templates"]}),e.jsx(de,{severity:"success",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:["Found ",S.length," saved template",S.length!==1?"s":"",". Click any template to apply its field mappings instantly."]})}),Object.entries($).map(([b,g])=>e.jsxs(v,{sx:{mb:3},children:[e.jsxs(y,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(_t,{sx:{mr:1,fontSize:20}}),b==="unknown"?"General Templates":`${b} Templates`,e.jsx(le,{label:g.length,size:"small",sx:{ml:1}})]}),e.jsx(Be,{children:g.map(z=>{var q;return e.jsx(Ze.Fragment,{children:e.jsxs(Ee,{component:"button",onClick:()=>R(z),sx:{py:2,borderRadius:1,mb:1,"&:hover":{backgroundColor:"action.hover"}},children:[e.jsx(Fe,{primary:e.jsxs(nt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(y,{variant:"subtitle1",children:z.name}),e.jsx(le,{label:J(z),size:"small",color:K(J(z)),variant:"outlined"})]}),secondary:e.jsxs(v,{sx:{mt:.5},children:[z.description&&e.jsx(y,{variant:"body2",sx:{mb:.5},children:z.description}),e.jsxs(nt,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(y,{variant:"caption",color:"text.secondary",sx:{display:"flex",alignItems:"center"},children:[e.jsx(Bt,{sx:{fontSize:12,mr:.5}}),I(z.lastModified)]}),e.jsxs(y,{variant:"caption",color:"text.secondary",children:[((q=z.mappings)==null?void 0:q.length)||0," field mappings"]})]}),z.mappings&&z.mappings.length>0&&e.jsxs(y,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:["Fields: ",z.mappings.slice(0,2).map(Z=>Z.sourceField).join(", "),z.mappings.length>2&&` +${z.mappings.length-2} more`]})]})}),e.jsxs(Nt,{children:[e.jsx(ze,{title:"Duplicate template",children:e.jsx(De,{edge:"end",onClick:Z=>{Z.stopPropagation(),j(z)},sx:{mr:1},children:e.jsx(Rn,{fontSize:"small"})})}),e.jsx(ze,{title:"Delete template",children:e.jsx(De,{edge:"end",onClick:Z=>{Z.stopPropagation(),w(z.id)},children:e.jsx(lt,{fontSize:"small"})})})]})]})},z.id)})})]},b))]})]}),e.jsx(rt,{children:e.jsx(re,{onClick:()=>C(!1),children:"Cancel"})})]})]})},io=(t,s)=>{if(!s)return t;const n=[...s.requiredFields,...s.optionalFields];if(n.find(a=>a.id===t))return console.log(`✅ Field ID already correct: "${t}"`),t;const o=n.find(a=>a.name===t);return o?(console.log(`🔄 Converting display name "${t}" to field ID "${o.id}"`),o.id):(console.warn(`⚠️ Unknown target field: "${t}" - keeping as-is`),t)},dr=(t,s)=>{if(!s||!t)return t;console.log("🔄 Starting field mapping migration...");const n=t.map(r=>{const o=r.targetField,a=io(r.targetField,s);return o!==a&&console.log(`📋 Migrating: "${r.sourceField}" → "${o}" becomes "${r.sourceField}" → "${a}"`),{...r,targetField:a}});return console.log("✅ Field mapping migration complete"),n},ur=(t,s)=>{if(!s||!t)return{isConsistent:!0,issues:[]};const n=[...s.requiredFields,...s.optionalFields],r=[];return t.forEach(o=>{const a=n.some(p=>p.id===o.targetField),l=n.some(p=>p.name===o.targetField);l&&!a?r.push(`Mapping "${o.sourceField}" → "${o.targetField}" uses display name instead of field ID`):!a&&!l&&r.push(`Mapping "${o.sourceField}" → "${o.targetField}" targets unknown field`)}),{isConsistent:r.length===0,issues:r}},lo=t=>{if(!t||typeof t!="string")return{city:null,state:null};const s=t.trim(),n=new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]),r=[/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s+\d{5}(?:-\d{4})?\s*$/,/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s*$/,/^.+,\s*([A-Za-z][A-Za-z\s]+?),?\s+([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/,/^.+\s{2,}([A-Za-z][A-Za-z\s]+?)\s{2,}([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/];for(const l of r){const p=s.match(l);if(p){let u=p[1].trim();const d=p[2].trim();if(n.has(d)&&u.length>=2&&u.length<=50){const m=/\b(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i;if(u=u.replace(m,"").trim(),u.length>=2)return console.log(`🏠 ENHANCED ADDRESS PARSING: "${t}" → City: "${u}", State: "${d}"`),{city:u,state:d}}}}const o=new RegExp("\\s+([A-Z]{2})(?:\\s+\\d{5}(?:-\\d{4})?)?\\s*$"),a=s.match(o);if(a){const l=a[1];if(n.has(l)){const d=s.substring(0,s.lastIndexOf(l)).trim().split(/\s+/).slice(-3).filter(m=>!/^\d+$/.test(m)&&!/^(north|south|east|west|n|s|e|w)$/i.test(m)&&!/^(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i.test(m));if(d.length>0){const m=d.join(" ");if(m.length>=2&&m.length<=50)return console.log(`🏠 FALLBACK ADDRESS PARSING: "${t}" → City: "${m}", State: "${l}"`),{city:m,state:l}}}}return console.log(`🏠 ADDRESS PARSING FAILED: Could not extract city/state from "${t}"`),{city:null,state:null}},co=t=>({incident_id:["incident_number","incidentnumber","incident_num","inc_num","incnum","case_number","call_number","event_id","event_number","report_number","incidentnum","eventnum"],incident_time:["call_received_time","callreceivedtime","received_time","call_time","incident_datetime","receive_time","time_received","incident_date","inc_date_time","alarm_time","calldatetime","call_datetime"],arrival_time:["arrive_time","arrivetime","on_scene_time","onscenetime","scene_time","arrival_datetime","on_scene_datetime","arrivaldatetime","onscenetime"],dispatch_time:["dispatched_time","dispatchedtime","dispatch_datetime","notification_time","notified_time","dispatchdatetime"],enroute_time:["en_route_time","enroutetime","turnout_time","turnouttime","responding_time","travel_start_time","enroutedatetime"],clear_time:["cleared_time","clearedtime","clear_datetime","back_in_service_time","available_time","service_time","unit_clear_time","cleardatetime"],latitude:["lat","y_coord","y_coordinate","gps_lat","coord_y","ycoord"],longitude:["lng","lon","long","x_coord","x_coordinate","gps_lng","gps_lon","coord_x","xcoord"],address:["incident_address","location","street_address","full_address","addr","locationaddress"],responding_unit:["unit","primary_unit","first_unit","apparatus","resource","unit_id","responding_units","primaryunit"],incident_type:["inc_type_code","inctypecode","inc_type_desc","inctypedesc","call_type","emergency_type","event_type","nature_code","problem_type","incidenttype","incidentcategory","calltype"],zip_code:["zip","zipcode","postal_code","postcode","locationzip"],city:["incident_city","location_city","locationcity"],state:["incident_state","location_state","locationstate"],priority:["incident_priority","call_priority","priority_level"],disposition:["incident_disposition","final_disposition","outcome","incident_outcome"],district:["response_district","fire_district","service_district","districts"],cross_streets:["cross_street","nearest_intersection","intersection"]})[t]||[],uo=()=>{const t=dt(),{sourceColumns:s,sampleData:n,selectedTool:r,mappings:o,processingStatus:a}=He(j=>j.formatter),[l,p]=A.useState({id:`template-${Date.now()}`,name:"Untitled Mapping",toolId:(r==null?void 0:r.id)||"",mappings:o||[],lastModified:Date.now()}),[u,d]=A.useState(!1),[m,x]=A.useState([]),[T,E]=A.useState(!1),[_,C]=A.useState([]),[B,F]=A.useState({message:"",severity:"info",open:!1}),[U,P]=A.useState(""),[S,H]=A.useState(""),[Y,G]=A.useState(!1),i=r||void 0,{saveToServer:c,autoSaveTemplate:h,findSimilarTemplates:D,getTemplateStats:k,cleanupAutoSaved:W}=Lr(l,u),X=k();A.useEffect(()=>{Object.keys(localStorage).filter(I=>I.startsWith("tmpl:")).forEach(I=>{var K;const J=localStorage.getItem(I);if(J)try{((K=JSON.parse(J).mappings)==null?void 0:K.some(b=>b.targetField&&b.targetField.includes(" ")))&&(console.log(`🔧 CLEARING OUTDATED TEMPLATE: ${I} (uses display names instead of field IDs)`),localStorage.removeItem(I))}catch{console.log(`🔧 CLEARING CORRUPTED TEMPLATE: ${I}`),localStorage.removeItem(I)}})},[]),A.useEffect(()=>{console.log("Redux mappings changed:",o),p(j=>{const I={...j,mappings:[...o],lastModified:Date.now()};return console.log("Updated template with Redux mappings:",I),I}),o.length>0&&d(!0)},[o]),A.useEffect(()=>{if(!i||!o||o.length===0)return;console.log("🔄 Checking for legacy mappings that need migration...");const j=ur(o,i);if(j.isConsistent)console.log("✅ All mappings already use field IDs - no migration needed");else{console.log("🔄 Legacy mappings detected - auto-migrating to field IDs"),console.log("Issues found:",j.issues);const I=dr(o,i);JSON.stringify(o)!==JSON.stringify(I)&&(console.log("✅ Auto-migration complete - updating mappings"),t(Oe(I)))}},[i,o==null?void 0:o.length]),A.useEffect(()=>{N()},[o,i]);const ae=j=>{console.log("handleMappingChange called with:",j);try{const I=[...o],J=I.findIndex(K=>K.targetField===j.targetField);J>=0?(console.log(`Updating existing mapping for ${j.targetField}`),I[J]=j):(console.log(`Adding new mapping for ${j.targetField}`),I.push(j)),t(Oe(I)),console.log("Mapping updated successfully:",j),F({message:`Mapped ${j.sourceField} to ${j.targetField}`,severity:"success",open:!0})}catch(I){console.error("Error updating mapping:",I)}},M=j=>{console.log("handleRemoveMapping called for:",j);try{const I=o.filter(J=>J.targetField!==j);t(Oe(I)),console.log(`Mapping for ${j} removed successfully`)}catch(I){console.error("Error removing mapping:",I)}},N=()=>{if(!i)return;console.log("🔍 FIELD MAPPING AUDIT - Current State Analysis:"),console.log("=========================================="),console.log("📋 Tool Configuration:"),console.log("  Required Fields:",i.requiredFields.map($=>({id:$.id,name:$.name}))),console.log("  Optional Fields:",i.optionalFields.map($=>({id:$.id,name:$.name}))),console.log("🗺️ Current Mappings:"),console.log("  Mappings Array:",o.map($=>({source:$.sourceField,target:$.targetField})));const j=[...i.requiredFields,...i.optionalFields],I=o.map($=>{const O=j.find(g=>g.id===$.targetField),b=j.find(g=>g.name===$.targetField);return{source:$.sourceField,target:$.targetField,isFieldId:!!O,isDisplayName:!!b,shouldBeFieldId:b?b.id:$.targetField}});console.log("🔍 Mapping Analysis:"),I.forEach($=>{console.log(`  "${$.source}" → "${$.target}"`),console.log(`    - Is Field ID: ${$.isFieldId}`),console.log(`    - Is Display Name: ${$.isDisplayName}`),$.isDisplayName&&!$.isFieldId&&console.log(`    - ⚠️ PROBLEM: Should be "${$.shouldBeFieldId}" instead`)});const J=o.find($=>$.targetField==="Call Received Date/Time");J&&(console.log("🚨 SPECIFIC ISSUE DETECTED:"),console.log(`  Mapping: "${J.sourceField}" → "${J.targetField}"`),console.log(`  Should be: "${J.sourceField}" → "incident_time"`)),console.log("==========================================");const K=[];i.requiredFields.forEach($=>{const O=o.find(g=>g.targetField===$.id),b=o.find(g=>g.targetField===$.name);if(console.log(`Checking required field ${$.id} (display: ${$.name})`),console.log(`  - Mapping by ID: ${O?`"${O.sourceField}" → ${O.targetField}`:"none"}`),console.log(`  - Mapping by Name: ${b?`"${b.sourceField}" → ${b.targetField}`:"none"}`),O)console.log(`  ✅ Correct mapping found for ${$.id}`);else if(b){console.log(`  🔄 Legacy mapping detected for ${$.id} - migrating from display name to field ID`);const g=o.findIndex(z=>z.targetField===$.name);if(g>=0){const z=[...o];z[g]={...z[g],targetField:$.id},console.log(`  📋 Auto-migrated: "${$.name}" → "${$.id}"`),t(Oe(z))}}else console.log(`  ❌ No mapping found for required field ${$.id}`),K.push({field:$.id,message:`Required field ${$.name} is not mapped`,severity:"error"})}),C(K)},ee=async()=>{if(!(!s||!i)){E(!0);try{console.log("🔧 AUTO-MAPPING - Starting with systematic fix approach");const I=[...dr(l.mappings,i)],J=g=>I.some(z=>z.targetField===g),K=g=>g.toLowerCase().replace(/[\s_-]/g,""),$=[...i.requiredFields,...i.optionalFields];console.log("🔧 AUTO-MAPPING - Available target fields:",$.map(g=>({id:g.id,name:g.name}))),console.log("🔧 AUTO-MAPPING - Source columns:",s),console.log("🔧 AUTO-MAPPING - Tool config details:",{toolId:i.id,requiredCount:i.requiredFields.length,optionalCount:i.optionalFields.length,totalFields:$.length,optionalFieldsList:i.optionalFields.map(g=>g.id)}),console.log(`
🕐 === SMART DATETIME DETECTION: Phase 1 Implementation ===`);const O=bn(s,n||[]);console.log("🕐 Detection result:",{type:O.pattern.type,confidence:O.pattern.confidence,description:O.pattern.description}),O.pattern.confidence>.5?(console.log("✅ High confidence datetime pattern detected - applying smart mappings"),O.suggestedMappings.forEach(g=>{if(!$.some(Z=>Z.id===g.targetField)){console.log(`⚠️ Skipping suggestion for ${g.targetField} - not in tool config`);return}if(J(g.targetField)){console.log(`🔄 Target ${g.targetField} already mapped - skipping automatic datetime mapping`);return}const q=g.sourceFields[0];g.transformationType==="combine"?(console.log(`🕐 DATETIME COMBINE: Adding mapping "${q}" → "${g.targetField}" (will combine with ${g.sourceFields.join(" + ")})`),I.push({sourceField:q,targetField:g.targetField,transformations:[{type:"datetime_combine",params:{sourceFields:g.sourceFields,description:g.description}}]})):g.transformationType==="extract"?(console.log(`🕐 DATETIME EXTRACT: Adding mapping "${q}" → "${g.targetField}" (will extract date/time component)`),I.push({sourceField:q,targetField:g.targetField,transformations:[{type:"datetime_extract",params:{extractType:g.targetField.includes("date")?"date":"time",description:g.description}}]})):(console.log(`🕐 DATETIME DIRECT: Adding direct mapping "${q}" → "${g.targetField}"`),I.push({sourceField:q,targetField:g.targetField}))}),console.log("🕐 Smart datetime mappings applied:",I.filter(g=>{var z;return(z=g.transformations)==null?void 0:z.some(q=>q.type.startsWith("datetime_"))}).length)):console.log("⚠️ Low confidence datetime pattern - proceeding with standard auto-mapping"),console.log(`🕐 === DATETIME DETECTION COMPLETE - Proceeding with standard field mapping ===
`),$.forEach(g=>{console.log(`
🎯 === DEBUGGING TARGET FIELD: ${g.id} (display: "${g.name}") ===`),J(g.id)&&console.log(`🔄 Target field ${g.id} already mapped - checking for dual mapping opportunity`),console.log("🔍 Available source columns for matching:",s),console.log(`🔍 Attempting to map target field: ${g.id} (display: ${g.name})`),console.log(`🔍 STEP 1: Trying exact match with display name "${g.name}"`);const z=s.find(ie=>ie.toLowerCase()===g.name.toLowerCase());if(console.log("🔍 Exact match result:",z?`FOUND: "${z}"`:"NOT FOUND"),z){I.find(se=>se.sourceField===z&&se.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${z}" → ${g.id}`):(console.log(`✅ EXACT MATCH SUCCESS: "${z}" → ${g.id}`),I.push({sourceField:z,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (exact match) ===
`);return}console.log("🔍 STEP 2: Trying normalized match with display name");const q=K(g.name);console.log(`🔍 Normalized target name: "${g.name}" → "${q}"`);const Z=s.find(ie=>{const se=K(ie);return console.log(`🔍   Testing source "${ie}" → "${se}" against "${q}"`),se===q});if(console.log("🔍 Normalized match result:",Z?`FOUND: "${Z}"`:"NOT FOUND"),Z){I.find(se=>se.sourceField===Z&&se.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${Z}" → ${g.id}`):(console.log(`✅ NORMALIZED MATCH SUCCESS: "${Z}" → ${g.id}`),I.push({sourceField:Z,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (normalized match) ===
`);return}console.log("🔍 STEP 3: Trying normalized match with field ID");const ne=K(g.id);console.log(`🔍 Normalized field ID: "${g.id}" → "${ne}"`);const te=s.find(ie=>{const se=K(ie);return console.log(`🔍   Testing source "${ie}" → "${se}" against "${ne}"`),se===ne});if(console.log("🔍 Field ID match result:",te?`FOUND: "${te}"`:"NOT FOUND"),te){I.find(se=>se.sourceField===te&&se.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${te}" → ${g.id}`):(console.log(`✅ FIELD ID MATCH SUCCESS: "${te}" → ${g.id}`),I.push({sourceField:te,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (field ID match) ===
`);return}console.log("🔍 STEP 4: Trying field variation matching");const je=co(g.id);console.log(`🔍 Field variations for ${g.id}:`,je);let Q;for(const ie of je)if(console.log(`🔍   Testing variation: "${ie}"`),Q=s.find(se=>{const ye=K(se),he=K(ie);return console.log(`🔍     Source "${se}" → "${ye}" vs variation "${he}"`),ye===he}),Q){console.log(`🔍   VARIATION MATCH FOUND: "${Q}" via variation "${ie}"`),I.find(ye=>ye.sourceField===Q&&ye.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${Q}" → ${g.id}`):(console.log(`✅ FIELD VARIATION SUCCESS: "${Q}" → ${g.id} (via variation "${ie}")`),I.push({sourceField:Q,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (variation match) ===
`);return}console.log(`🔍 No variation matches found for ${g.id}`),console.log(`❌ NO MATCH FOUND for target field: ${g.id}`),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (no match) ===
`);const Se=s.map(K).findIndex(ie=>ie.includes(q)||q.includes(ie));if(Se>=0){console.log(`✅ Partial match found: "${s[Se]}" → ${g.id}`),I.push({sourceField:s[Se],targetField:g.id});return}if((g.id==="city"||g.id==="state")&&!J(g.id)){const ie=s.find(se=>K(se).includes("address")||K(se).includes("location")||K(se).includes("addr"));if(ie&&n&&n.length>0){const se=n[0][ie];if(typeof se=="string"&&se.trim()){const ye=lo(se);if(g.id==="city"&&ye.city){console.log(`🏠 Smart address parsing: Extracting city "${ye.city}" from "${ie}"`),I.push({sourceField:ie,targetField:g.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Za-z\\s]+)\\s+[A-Z]{2}\\s*$",description:"Extract city from full address"}}]});return}if(g.id==="state"&&ye.state){console.log(`🏠 Smart address parsing: Extracting state "${ye.state}" from "${ie}"`),I.push({sourceField:ie,targetField:g.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Z]{2})\\s*$",description:"Extract state from full address"}}]});return}}}}console.log(`❌ No match found for target field: ${g.id}`)}),console.log("🔧 AUTO-MAPPING - Final mappings:",I.map(g=>({source:g.sourceField,target:g.targetField})));const b=ur(I,i);if(b.isConsistent||console.warn("⚠️ AUTO-MAPPING - Consistency issues detected:",b.issues),t(Oe(I)),I.length>=3&&(r!=null&&r.id)&&(console.log("🔧 AUTO-SAVING TEMPLATE: Significant mappings detected"),h(I,r.id),W()),r!=null&&r.id){const g=D(I,r.id);x(g.slice(0,3)),console.log("🔧 TEMPLATE SUGGESTIONS:",g.length,"similar templates found")}}finally{E(!1)}}},f=async()=>{try{await c(),d(!1)}catch(j){console.error("Failed to save template:",j)}},L=()=>{t(Le(0))},R=()=>{try{t(Me("transforming")),console.log("🔧 TRANSFORMATION DEBUG: Using Redux mappings directly for transformation"),console.log("Redux mappings:",o),console.log("currentTemplate.mappings:",l.mappings),console.log("Sample data:",n),console.log("🔍 PRE-TRANSFORMATION DEBUG:"),console.log("  Sample data keys:",n.length>0?Object.keys(n[0]):[]),console.log("  Sample data first row:",n[0]),console.log("  Mappings to apply:",o),console.log("  Mappings breakdown:"),o.forEach((I,J)=>{var $;const K=($=n[0])==null?void 0:$[I.sourceField];console.log(`    ${J+1}. "${I.sourceField}" → "${I.targetField}" | Sample: "${K}"`)});const j=Mr(n,o);console.log("✅ Transformed data with latest mappings:",j),console.log("🔍 POST-TRANSFORMATION DEBUG:"),j.length>0&&(console.log("  Transformed data keys:",Object.keys(j[0])),console.log("  Transformed data first row:",j[0]),console.log("  Specific field checks:"),console.log(`    incident_time: "${j[0].incident_time}"`),console.log(`    incident_date: "${j[0].incident_date}"`),console.log(`    incident_id: "${j[0].incident_id}"`)),t(Yr(j)),t(Me("mapping")),t(Le(2))}catch(j){console.error("Error transforming data:",j),t(Me("error")),F({message:`Error transforming data: ${j instanceof Error?j.message:"Unknown error"}`,severity:"error",open:!0})}},V=A.useMemo(()=>{if(console.log("Checking if can proceed with validationErrors:",_),console.log("Current mappings:",o),i){const j=i.requiredFields.filter(I=>!o.some(J=>J.targetField===I.id));return console.log("Unmapped required fields:",j),j.length===0}return _.every(j=>j.severity!=="error")},[_,o,i]),w=j=>{var $;j.preventDefault();const I=j.dataTransfer.getData("text/plain");if(!I){F({message:"Drag and drop error: No source field data found",severity:"error",open:!0});return}const K=($=j.target.closest("[data-target-field]"))==null?void 0:$.getAttribute("data-target-field");if(!K){F({message:"Drag and drop error: No target field found. Try dropping directly on a target field.",severity:"warning",open:!0});return}ae({sourceField:I,targetField:K}),F({message:`Mapped ${I} to ${K}`,severity:"success",open:!0})};return s.length?i?a==="uploading"?e.jsxs(v,{sx:{p:3,textAlign:"center"},children:[e.jsx(Ve,{}),e.jsx(y,{sx:{mt:2},children:"Processing file data..."})]}):e.jsxs(v,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(y,{variant:"h5",children:["Map Fields for ",i.name]}),e.jsxs(nt,{direction:"row",spacing:1,children:[e.jsx(re,{variant:"outlined",size:"small",startIcon:e.jsx(Tr,{}),onClick:f,disabled:!u,children:"Save Template"}),e.jsx(ao,{currentTemplate:l,setCurrentTemplate:j=>{p(j),j.mappings&&j.mappings.length>0&&(t(Oe(j.mappings)),F({message:`Applied template "${j.name}" with ${j.mappings.length} field mappings`,severity:"success",open:!0}))},setTemplateDirty:d,disabled:!r||s.length===0,currentMappings:o,sourceFields:s,sampleData:n,targetTool:(r==null?void 0:r.id)||"",onApplyFieldMappings:j=>{t(Oe(j)),F({message:`Applied template with ${j.length} field mappings`,severity:"success",open:!0})}})]})]}),m.length>0&&e.jsxs(de,{severity:"info",sx:{mb:2},children:[e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"💡 Smart Template Suggestions"}),e.jsxs(y,{variant:"body2",sx:{mb:1},children:["Found ",m.length," template",m.length!==1?"s":""," with similar field patterns:"]}),e.jsx(v,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:m.map(j=>e.jsxs(re,{variant:"outlined",size:"small",onClick:()=>{p(j),t(Oe(j.mappings)),d(!1),x([]),F({message:`Applied suggested template "${j.name}"`,severity:"success",open:!0})},sx:{textTransform:"none"},children:[j.name,e.jsxs(y,{component:"span",variant:"caption",sx:{ml:1,opacity:.7},children:["(",j.mappings.length," mappings)"]})]},j.id))})]}),X.total>0&&e.jsx(de,{severity:"success",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:["📁 You have ",X.total," saved template",X.total!==1?"s":"","(",X.totalMappings," total field mappings).",X.byTool[(r==null?void 0:r.id)||""]&&e.jsxs("strong",{children:[X.byTool[(r==null?void 0:r.id)||""]," template",X.byTool[(r==null?void 0:r.id)||""]!==1?"s":""," for ",r==null?void 0:r.name]})]})}),e.jsxs(v,{sx:{display:"flex",gap:2,height:"700px",minHeight:"700px",border:"1px solid #eaeaea",borderRadius:"4px",padding:"4px"},children:[e.jsxs(v,{sx:{width:"35%",height:"100%",display:"flex",flexDirection:"column",position:"relative",borderRight:"1px solid #eaeaea",paddingRight:"8px"},children:[e.jsx(y,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Source Fields Panel ↕️ (Scrollable)"}),e.jsx(Hn,{sourceColumns:s,filter:U,setFilter:P,mappings:o,sampleData:n,onAddParsedFields:(j,I)=>{if(console.log("🤖 PARENT: Received parsed fields for column:",j,I),n&&n.length>0&&I.length>0){const J=n.map((K,$)=>{const O={...K};return I.forEach(b=>{if(b.data[$]!==null){const g=b.id.split("_").slice(1).join("_"),z=`${j}_parsed_${g}`;O[z]=b.data[$],console.log(`🤖 PARENT: Injecting parsed data: ${z} = "${b.data[$]}"`)}}),O});console.log("🤖 PARENT: Updating Redux sampleData with parsed fields"),t(yr(J)),F({message:`Added ${I.length} parsed fields for ${j}`,severity:"success",open:!0})}}})]}),e.jsxs(v,{sx:{width:"65%",height:"100%",display:"flex",flexDirection:"column",gap:2,overflow:"hidden",position:"relative"},onDragOver:j=>{j.target===j.currentTarget&&(j.preventDefault(),console.log("Parent container dragOver"))},onDrop:j=>{j.target===j.currentTarget&&(j.preventDefault(),w(j),console.log("Parent container drop"))},children:[e.jsx(y,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Target Fields Panel ↕️ (Scrollable)"}),e.jsx(Zn,{toolConfig:i,showAllFields:Y,setShowAllFields:G,filter:S,setFilter:H,mappings:o,onMappingChange:ae,onRemoveMapping:M,validationErrors:_,sampleData:n,sourceColumns:s}),_.length>0&&e.jsx(v,{sx:{flexShrink:0,marginTop:"auto",borderTop:"1px solid #eaeaea",paddingTop:"8px"},children:e.jsx(Qn,{validationErrors:_,jumpToField:j=>{const I=document.getElementById(`target-field-${j}`);I&&(I.scrollIntoView({behavior:"smooth",block:"center"}),I.classList.add("highlight-field"),setTimeout(()=>{I.classList.remove("highlight-field")},2e3))}})})]})]}),e.jsx(ge,{sx:{p:2,mt:2},children:e.jsx(eo,{sampleData:n,mappings:o,toolConfig:i})}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(re,{variant:"outlined",startIcon:e.jsx(ot,{}),onClick:L,children:"Back"}),e.jsxs(v,{children:[e.jsx(re,{variant:"outlined",onClick:ee,disabled:T||!s.length,sx:{mr:1},children:T?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{size:20,sx:{mr:1}}),"Auto-mapping..."]}):"Auto-Map Fields"}),e.jsx(re,{variant:"contained",endIcon:e.jsx(Gt,{}),onClick:R,disabled:!V,children:"Continue"})]})]}),e.jsx(vr,{open:B.open,autoHideDuration:6e3,onClose:()=>F({...B,open:!1}),children:e.jsx(de,{onClose:()=>F({...B,open:!1}),severity:B.severity,children:B.message})})]}):e.jsxs(v,{sx:{p:3,textAlign:"center"},children:[e.jsx(de,{severity:"error",children:"No tool selected. Please select a tool first."}),e.jsx(re,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(ot,{}),onClick:L,children:"Go Back to Upload"})]}):e.jsxs(v,{sx:{p:3,textAlign:"center"},children:[e.jsx(de,{severity:"error",children:"No source columns available. Please upload a file first."}),e.jsx(re,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(ot,{}),onClick:L,children:"Go Back to Upload"})]})},po=({data:t,validationErrors:s,highlightedCell:n})=>{const[r,o]=A.useState(0),[a,l]=A.useState(10),[p,u]=A.useState(""),[d,m]=A.useState("");A.useEffect(()=>{if(n){const S=Math.floor(n.rowIndex/a);S!==r&&o(S)}},[n,a,r]);const x=t.length>0?Object.keys(t[0]):[],T={};s.forEach(S=>{S.rowIndex!==void 0&&(T[S.rowIndex]||(T[S.rowIndex]={}),T[S.rowIndex][S.field]||(T[S.rowIndex][S.field]=[]),T[S.rowIndex][S.field].push(S))});const E=(S,H)=>{o(H)},_=S=>{l(parseInt(S.target.value,10)),o(0)},C=S=>{u(S.target.value),o(0)},B=S=>{m(S.target.value),o(0)},F=()=>{m(""),o(0)},U=t.filter(S=>{if(!d)return!0;if(p){const H=S[p];return H!==void 0&&String(H).toLowerCase().includes(d.toLowerCase())}return Object.values(S).some(H=>H!==void 0&&String(H).toLowerCase().includes(d.toLowerCase()))}),P=U.slice(r*a,r*a+a);return t.length===0?e.jsx(v,{children:e.jsx(y,{variant:"h6",gutterBottom:!0,children:"No data available for preview"})}):e.jsxs(v,{children:[e.jsx(Gr,{styles:{"@keyframes pulse":{"0%":{opacity:.7},"100%":{opacity:1}}}}),e.jsxs(v,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(be,{label:"Search",value:d,onChange:B,sx:{flexGrow:1},InputProps:{startAdornment:e.jsx(Re,{position:"start",children:e.jsx(it,{})}),endAdornment:d&&e.jsx(Re,{position:"end",children:e.jsx(De,{onClick:F,edge:"end",size:"small",children:e.jsx(zt,{})})})}}),e.jsxs(Ue,{sx:{minWidth:200},children:[e.jsx(We,{id:"filter-field-label",children:"Filter Field"}),e.jsxs(Ye,{labelId:"filter-field-label",id:"filter-field",value:p,label:"Filter Field",onChange:C,children:[e.jsx(oe,{value:"",children:"All Fields"}),x.map(S=>e.jsx(oe,{value:S,children:S},S))]})]})]}),e.jsxs(ge,{sx:{width:"100%",mb:2},children:[e.jsx(Lt,{sx:{maxHeight:500},children:e.jsxs(ht,{stickyHeader:!0,"aria-label":"data preview table",children:[e.jsx(gt,{children:e.jsxs(Ne,{children:[e.jsx(Ce,{children:"#"}),x.map(S=>e.jsx(Ce,{children:S},S))]})}),e.jsx(ft,{children:P.map((S,H)=>{const Y=r*a+H,G=T[Y];return e.jsxs(Ne,{hover:!0,sx:{"&:last-child td, &:last-child th":{border:0},backgroundColor:G?"#fff8f8":"inherit"},children:[e.jsx(Ce,{children:Y+1}),x.map(i=>{const c=(G==null?void 0:G[i])||[],h=c.length>0,D=n&&n.rowIndex===Y&&n.field===i;return e.jsxs(Ce,{sx:{backgroundColor:D?"#fff3e0":h?"#ffebee":"inherit",position:"relative",border:D?"2px solid #ff9800":"inherit",transition:"all 0.3s ease"},children:[S[i]!==void 0?String(S[i]):"",h&&e.jsx(v,{sx:{position:"absolute",top:0,right:0},children:e.jsx(le,{color:"error",size:"small",label:c.length,sx:{height:16,fontSize:"0.6rem"}})}),D&&e.jsx(v,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid #ff9800",borderRadius:"4px",pointerEvents:"none",animation:"pulse 1s ease-in-out infinite alternate"}})]},i)})]},H)})})]})}),e.jsx(ps,{rowsPerPageOptions:[5,10,25,50,100],component:"div",count:U.length,rowsPerPage:a,page:r,onPageChange:E,onRowsPerPageChange:_})]})]})};class mo{constructor(){ut(this,"defaultFields",{})}registerField(s,n){console.log(`Registering default value for ${s}:`,n),this.defaultFields[s]=n}hasDefaultValue(s){return this.defaultFields[s]!==void 0}getDefaultValue(s){return this.defaultFields[s]}registerMappings(s){this.defaultFields={},s.forEach(n=>{if(n.sourceField==="__default__"&&n.transformations){const r=n.transformations.find(o=>o.type==="convert"&&o.params&&o.params.defaultValue!==void 0);r&&r.params.defaultValue!==void 0&&this.registerField(n.targetField,r.params.defaultValue)}}),console.log("Registered default values:",this.defaultFields)}clear(){this.defaultFields={}}}const pr=new mo,ho=(t,s)=>{const n=[];return t.forEach((r,o)=>{s.forEach(a=>{let l=r[a.name];const p=pr.hasDefaultValue(a.name);if((l==null||l==="")&&p&&(l=pr.getDefaultValue(a.name),console.log(`Using default value for validation of ${a.name}:`,l)),a.name==="Incident ID"){a.isRequired&&!p&&(l==null||l==="")&&n.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(a.name.includes("Time")&&typeof l=="string"){a.isRequired&&!p&&(l==null||l==="")&&n.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(a.isRequired&&!p&&(l==null||l==="")){n.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(l==null||l==="")return;const u=go(l,a.dataType,a.name,o);if(u){n.push(u);return}a.validationRules&&a.validationRules.forEach(d=>{const m=fo(l,d,a.name,o);m&&n.push(m)})})}),console.log("Validation completed with errors:",n),n},go=(t,s,n,r)=>{switch(s){case"string":if(typeof t!="string")return{rowIndex:r,field:n,message:`${n} must be a string`,type:"custom"};break;case"number":if(typeof t!="number"&&(typeof t!="string"||isNaN(Number(t))))return{rowIndex:r,field:n,message:`${n} must be a number`,type:"custom"};break;case"date":if(!(typeof t=="string"||t instanceof Date))return{rowIndex:r,field:n,message:`${n} must be a date`,type:"custom"};const o=new Date(t);if(isNaN(o.getTime()))return{rowIndex:r,field:n,message:`${n} contains an invalid date format`,type:"custom"};break;case"boolean":if(typeof t!="boolean"&&t!=="true"&&t!=="false"&&t!=="0"&&t!=="1")return{rowIndex:r,field:n,message:`${n} must be a boolean value`,type:"custom"};break;case"location":if(typeof t=="string"){if(!/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(t))return{rowIndex:r,field:n,message:`${n} must be a valid location format (latitude,longitude)`,type:"custom"}}else if(!t.lat||!t.lng)return{rowIndex:r,field:n,message:`${n} must be a valid location object or string`,type:"custom"};break}return null},fo=(t,s,n,r)=>{switch(s.type){case"required":break;case"min":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)<s.params.value)return{rowIndex:r,field:n,message:`${n} must be at least ${s.params.value}`,type:"min"}}else if(typeof t=="string"&&t.length<s.params.value)return{rowIndex:r,field:n,message:`${n} must be at least ${s.params.value} characters`,type:"min"};break;case"max":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)>s.params.value)return{rowIndex:r,field:n,message:`${n} must be at most ${s.params.value}`,type:"max"}}else if(typeof t=="string"&&t.length>s.params.value)return{rowIndex:r,field:n,message:`${n} must be at most ${s.params.value} characters`,type:"max"};break;case"pattern":if(typeof t=="string"&&!new RegExp(s.params.regex).test(t))return{rowIndex:r,field:n,message:s.params.message||`${n} does not match the required pattern`,type:"pattern"};break;case"oneOf":const o=s.params.values;if(!o.includes(t))return{rowIndex:r,field:n,message:`${n} must be one of: ${o.join(", ")}`,type:"oneOf"};break;case"custom":if(s.params.validateFn&&typeof s.params.validateFn=="function"&&!s.params.validateFn(t))return{rowIndex:r,field:n,message:s.params.message||`${n} is invalid`,type:"custom"};break}return null},xo=t=>{const s={total:t.length,byType:{},byField:{}};return t.forEach(n=>{s.byType[n.type]||(s.byType[n.type]=0),s.byType[n.type]++,s.byField[n.field]||(s.byField[n.field]=0),s.byField[n.field]++}),s},Ot=t=>{const{children:s,value:n,index:r,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==r,id:`validation-tabpanel-${r}`,"aria-labelledby":`validation-tab-${r}`,...o,children:n===r&&e.jsx(v,{sx:{p:2},children:s})})},yo=({errors:t,onJumpToError:s})=>{const[n,r]=A.useState(0),[o,a]=A.useState(""),l=xo(t),p=(x,T)=>{r(T)},u=t.filter(x=>x.field.toLowerCase().includes(o.toLowerCase())||x.message.toLowerCase().includes(o.toLowerCase())),d={};u.forEach(x=>{d[x.field]||(d[x.field]=[]),d[x.field].push(x)});const m=x=>{let T="default";switch(x){case"required":T="error";break;case"pattern":case"min":case"max":T="warning";break;case"oneOf":case"custom":T="info";break}return e.jsx(le,{size:"small",label:x,color:T})};return e.jsxs(ge,{sx:{p:0,mb:3},children:[e.jsx(v,{sx:{p:2,bgcolor:t.length>0?"#ffebee":"#e8f5e9",borderRadius:"4px 4px 0 0"},children:e.jsxs(y,{variant:"h6",component:"h3",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(yt,{}),"Validation Results",e.jsx(le,{label:`${t.length} ${t.length===1?"error":"errors"}`,color:t.length>0?"error":"success",sx:{ml:2}})]})}),e.jsx(xe,{}),e.jsx(v,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Et,{value:n,onChange:p,"aria-label":"validation tabs",children:[e.jsx(_e,{label:"Summary",id:"validation-tab-0","aria-controls":"validation-tabpanel-0"}),e.jsx(_e,{label:"By Field",id:"validation-tab-1","aria-controls":"validation-tabpanel-1"}),e.jsx(_e,{label:"All Errors",id:"validation-tab-2","aria-controls":"validation-tabpanel-2"})]})}),e.jsx(Ot,{value:n,index:0,children:t.length===0?e.jsx(de,{severity:"success",children:"No validation errors found. Your data is ready for export!"}):e.jsxs(e.Fragment,{children:[e.jsxs(de,{severity:"warning",children:["Found ",t.length," validation ",t.length===1?"error":"errors"," that need to be addressed before export."]}),e.jsxs(v,{sx:{mt:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Error Distribution by Field"}),e.jsx(v,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:Object.entries(l.byField).map(([x,T])=>e.jsx(le,{label:`${x}: ${T}`,color:"error",variant:"outlined",onClick:()=>r(1)},x))}),e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Error Types"}),e.jsx(v,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:Object.entries(l.byType).map(([x,T])=>e.jsx(le,{label:`${x}: ${T}`,color:"primary",variant:"outlined"},x))})]})]})}),e.jsxs(Ot,{value:n,index:1,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:o,onChange:x=>a(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Re,{position:"start",children:e.jsx(it,{})}),endAdornment:o&&e.jsx(Re,{position:"end",children:e.jsx(De,{onClick:()=>a(""),edge:"end",size:"small",children:e.jsx(zt,{})})})}}),Object.keys(d).length===0?e.jsx(de,{severity:"info",children:"No errors match your search criteria."}):Object.entries(d).map(([x,T])=>e.jsxs(Fr,{defaultExpanded:Object.keys(d).length===1,children:[e.jsx(Cr,{expandIcon:e.jsx(Ft,{}),children:e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[e.jsx(y,{children:x}),e.jsx(le,{size:"small",label:T.length,color:"error",sx:{ml:"auto"}})]})}),e.jsx(Dr,{children:e.jsx(Be,{dense:!0,disablePadding:!0,children:T.map((E,_)=>e.jsxs(Ze.Fragment,{children:[_>0&&e.jsx(xe,{component:"li"}),e.jsx(Ee,{secondaryAction:E.rowIndex!==void 0&&s&&e.jsx(re,{size:"small",variant:"outlined",onClick:()=>E.rowIndex!==void 0&&s(E.rowIndex,E.field),children:"Jump to Row"}),children:e.jsx(Fe,{primary:e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[E.message,m(E.type)]}),secondary:E.rowIndex!==void 0?`Row ${E.rowIndex+1}`:"Global error"})})]},_))})})]},x))]}),e.jsxs(Ot,{value:n,index:2,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:o,onChange:x=>a(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Re,{position:"start",children:e.jsx(it,{})}),endAdornment:o&&e.jsx(Re,{position:"end",children:e.jsx(De,{onClick:()=>a(""),edge:"end",size:"small",children:e.jsx(zt,{})})})}}),e.jsx(Be,{dense:!0,children:u.length===0?e.jsx(de,{severity:"info",children:"No errors match your search criteria."}):u.map((x,T)=>e.jsxs(Ze.Fragment,{children:[T>0&&e.jsx(xe,{component:"li"}),e.jsx(Ee,{secondaryAction:x.rowIndex!==void 0&&s&&e.jsx(re,{size:"small",variant:"outlined",onClick:()=>x.rowIndex!==void 0&&s(x.rowIndex,x.field),children:"Jump to Row"}),children:e.jsx(Fe,{primary:e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(y,{component:"span",sx:{fontWeight:500},children:[x.field,":"]}),x.message,m(x.type)]}),secondary:x.rowIndex!==void 0?`Row ${x.rowIndex+1}`:"Global error"})})]},T))})]})]})},bo=t=>{switch(t){case"string":return"Default Value";case"number":return"0";case"date":return new Date().toISOString().split("T")[0];case"boolean":return"false";case"location":return"0.0,0.0";default:return""}},vo=({errors:t,targetFields:s,mappings:n,onAddDefaultValue:r,onJumpToMapping:o})=>{const a=Yt(),[l,p]=A.useState(!1),[u,d]=A.useState(null),[m,x]=A.useState(""),T=A.useMemo(()=>{const F={};return t.forEach(U=>{F[U.field]||(F[U.field]={errors:[],count:0}),F[U.field].errors.push(U),F[U.field].count++}),F},[t]),E=A.useMemo(()=>Object.entries(T).sort((F,U)=>U[1].count-F[1].count).map(([F,U])=>{const P=s.find(i=>i.name===F);if(!P)return null;const S=n.some(i=>i.targetField===F),H=n.some(i=>i.targetField===F&&i.sourceField==="__default__"),Y=U.errors.some(i=>i.type==="required");let G="unknown";return Y&&!S?G="map_field":Y&&!H?G="add_default":!Y&&S&&(G="fix_transformation"),{fieldName:F,fieldDef:P,errorCount:U.count,errors:U.errors,hasMapping:S,hasDefaultMapping:H,actionType:G}}).filter(Boolean),[T,s,n]),_=A.useMemo(()=>E.filter(F=>(F==null?void 0:F.actionType)==="add_default").length,[E]),C=F=>{d(F),x(bo(F.dataType)),p(!0)},B=()=>{if(!u)return;const F={sourceField:"__default__",targetField:u.name,transformations:[{type:"convert",params:{defaultValue:m,targetType:u.dataType}}]};r(F),p(!1)};return t.length===0?e.jsx(de,{severity:"success",sx:{my:2},children:"No validation errors detected. Your data is ready for export!"}):e.jsxs(ge,{sx:{p:0,my:2,borderRadius:1,border:`1px solid ${a.palette.divider}`,overflow:"hidden"},elevation:2,children:[e.jsxs(v,{sx:{p:2,bgcolor:a.palette.mode==="dark"?me(a.palette.error.dark,.2):me(a.palette.error.light,.1),borderBottom:`1px solid ${a.palette.divider}`},children:[e.jsxs(y,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(yt,{color:"error"}),"Validation Solutions",e.jsx(le,{label:`${t.length} ${t.length===1?"issue":"issues"}`,color:"error",size:"small",sx:{ml:1}})]}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:_>0?`${_} ${_===1?"issue":"issues"} can be fixed with default values.`:"Review the suggested actions to resolve validation issues."})]}),e.jsxs(Be,{sx:{py:0},children:[_>0&&e.jsxs(Ee,{sx:{bgcolor:me(a.palette.success.light,.1),borderBottom:`1px solid ${a.palette.divider}`,"&:hover":{bgcolor:me(a.palette.success.light,.2)}},children:[e.jsx(ke,{children:e.jsx(ct,{color:"success"})}),e.jsx(Fe,{primary:"Fix Required Fields with Default Values",secondary:`Add default values to ${_} unmapped required ${_===1?"field":"fields"}`}),e.jsx(Nt,{children:e.jsx(re,{variant:"outlined",color:"success",size:"small",onClick:()=>{const F=E.find(U=>(U==null?void 0:U.actionType)==="add_default");F!=null&&F.fieldDef&&C(F.fieldDef)},children:"Set Default Values"})})]}),E.map((F,U)=>{var Y;if(!F)return null;let P=e.jsx(yt,{color:"error"}),S="error",H="";switch(F.actionType){case"map_field":P=e.jsx(Mn,{color:"info"}),S="info",H="Field requires mapping to source data";break;case"add_default":P=e.jsx(or,{color:"success"}),S="success",H="Field requires a value, add a default";break;case"fix_transformation":P=e.jsx(jr,{color:"warning"}),S="warning",H="Field has validation issues with current mapping";break}return e.jsxs(Ze.Fragment,{children:[U>0&&e.jsx(xe,{}),e.jsxs(Ee,{sx:{py:1.5,"&:hover":{bgcolor:me(a.palette.primary.light,.05)}},children:[e.jsx(ke,{children:P}),e.jsx(Fe,{primary:e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{variant:"subtitle2",children:F.fieldName}),e.jsx(le,{size:"small",label:`${F.errorCount} ${F.errorCount===1?"error":"errors"}`,color:"error",variant:"outlined"}),F.fieldDef&&e.jsx(le,{size:"small",label:F.fieldDef.dataType,color:"default",variant:"outlined"})]}),secondary:e.jsxs(v,{sx:{mt:.5},children:[e.jsx(y,{variant:"body2",color:"text.secondary",children:H}),e.jsxs(y,{variant:"caption",color:"error",sx:{display:"block",mt:.5},children:[(Y=F.errors[0])==null?void 0:Y.message,F.errors.length>1&&` (+ ${F.errors.length-1} more)`]})]})}),e.jsxs(Nt,{children:[F.actionType==="add_default"&&F.fieldDef&&e.jsx(re,{variant:"outlined",color:S,size:"small",startIcon:e.jsx(or,{}),onClick:()=>C(F.fieldDef),children:"Add Default"}),(F.actionType==="map_field"||F.actionType==="fix_transformation")&&e.jsx(re,{variant:"outlined",color:S,size:"small",startIcon:e.jsx(Zr,{}),onClick:()=>o(F.fieldName),children:F.actionType==="map_field"?"Map Field":"Fix Mapping"})]})]})]},F.fieldName)})]}),e.jsxs(Qe,{open:l,onClose:()=>p(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(et,{children:["Set Default Value for ",u==null?void 0:u.name]}),e.jsx(tt,{children:e.jsxs(v,{sx:{mt:1},children:[e.jsx(y,{variant:"body2",gutterBottom:!0,children:u==null?void 0:u.description}),e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(y,{variant:"caption",children:"Data Type:"}),e.jsx(le,{size:"small",label:u==null?void 0:u.dataType,color:"primary",variant:"outlined"})]}),(u==null?void 0:u.dataType)==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:m,onChange:F=>x(F.target.value),label:"Default Value",variant:"outlined",margin:"normal",children:[e.jsx(oe,{value:"true",children:"True"}),e.jsx(oe,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:m,onChange:F=>x(F.target.value),label:"Default Value",variant:"outlined",margin:"normal",type:(u==null?void 0:u.dataType)==="number"?"number":"text",helperText:`This value will be used for all records where ${u==null?void 0:u.name} is not mapped or empty`})]})}),e.jsxs(rt,{children:[e.jsx(re,{onClick:()=>p(!1),children:"Cancel"}),e.jsx(re,{onClick:B,variant:"contained",color:"primary",startIcon:e.jsx(ct,{}),children:"Apply Default Value"})]})]})]})},mr=t=>{const{children:s,value:n,index:r,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==r,id:`preview-tabpanel-${r}`,"aria-labelledby":`preview-tab-${r}`,...o,children:n===r&&e.jsx(v,{sx:{p:2},children:s})})},jo=()=>{const t=dt(),{sourceFile:s,transformedData:n,validationErrors:r,selectedTool:o,mappings:a}=He(S=>S.formatter),[l,p]=A.useState(0),[u,d]=A.useState(!1),[m,x]=A.useState(null),T=A.useRef(null),E=(S,H)=>{p(H)},_=()=>{t(Le(1))},C=()=>{t(Le(3))},B=()=>{if(!(!n||!o)){d(!0);try{const S=[...o.requiredFields,...o.optionalFields],H=He(c=>c.formatter.mappings),Y={};H&&H.forEach(c=>{if(c.sourceField==="__default__"&&c.transformations){const h=c.transformations.find(D=>D.type==="convert"&&D.params&&D.params.defaultValue!==void 0);h&&(Y[c.targetField]=!0,console.log(`Field ${c.targetField} has default value: ${h.params.defaultValue}`))}});const G=n.map(c=>{const h={...c};return Object.keys(Y).forEach(D=>{typeof window<"u"&&window.defaultValueRegistry&&window.defaultValueRegistry.register(D,!0)}),h}),i=ho(G,S);t(qr(i)),i.length===0?t(Me("complete")):t(Me("error"))}catch(S){console.error("Validation error:",S),t(Me("error"))}finally{d(!1)}}},F=(S,H)=>{p(0),x({rowIndex:S,field:H}),setTimeout(()=>{T.current&&T.current.scrollIntoView({behavior:"smooth"})},100),setTimeout(()=>{x(null)},3e3)},U=S=>{console.log("Adding default value mapping:",S),t(Jr(S)),setTimeout(()=>{B()},100)},P=S=>{t(Le(1))};return A.useEffect(()=>{n&&n.length>0&&B()},[n]),!n||n.length===0?e.jsxs(ge,{sx:{p:3,textAlign:"center"},children:[e.jsxs(de,{severity:"warning",sx:{mb:2},children:[e.jsx(Cs,{children:"No Data Available"}),"There is no transformed data to preview. Please go back to the field mapping step."]}),e.jsx(re,{variant:"contained",startIcon:e.jsx(ir,{}),onClick:_,children:"Back to Field Mapping"})]}):e.jsxs(v,{children:[e.jsx(y,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Preview & Validate Data"}),e.jsx(ge,{sx:{p:2,mb:3},children:e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(v,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(y,{variant:"body1",children:[(s==null?void 0:s.name)||"No file"," (",s==null?void 0:s.type,")"]})]})}),e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(v,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(y,{variant:"body1",children:[n.length," records processed"]})]})}),e.jsx(pe,{size:12,children:e.jsxs(v,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(v,{sx:{display:"flex",alignItems:"center",gap:1},children:u?e.jsxs(e.Fragment,{children:[e.jsx(Ve,{size:20}),e.jsx(y,{children:"Validating data..."})]}):r.length===0?e.jsxs(e.Fragment,{children:[e.jsx(Pr,{color:"success"}),e.jsx(y,{color:"success.main",children:"Data validation passed! Ready for export."})]}):e.jsxs(e.Fragment,{children:[e.jsx(Ln,{color:"error"}),e.jsxs(y,{color:"error",children:[r.length," validation ",r.length===1?"error":"errors"," found"]})]})})]})})]})}),e.jsx(v,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Et,{value:l,onChange:E,"aria-label":"preview and validation tabs",children:[e.jsx(_e,{label:"Data Preview",id:"preview-tab-0","aria-controls":"preview-tabpanel-0"}),e.jsx(_e,{label:`Validation & Solutions ${r.length>0?`(${r.length})`:""}`,id:"preview-tab-1","aria-controls":"preview-tabpanel-1",sx:{color:r.length>0?"error.main":"inherit"}})]})}),e.jsx(mr,{value:l,index:0,children:e.jsx(v,{ref:T,children:e.jsx(po,{data:n,validationErrors:r,highlightedCell:m})})}),e.jsxs(mr,{value:l,index:1,children:[r.length>0&&o&&e.jsx(vo,{errors:r,targetFields:[...o.requiredFields,...o.optionalFields],mappings:a,onAddDefaultValue:U,onJumpToMapping:P}),e.jsx(yo,{errors:r,onJumpToError:F})]}),e.jsx(xe,{sx:{my:3}}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(re,{variant:"outlined",startIcon:e.jsx(ir,{}),onClick:_,children:"Back to Field Mapping"}),e.jsx(re,{variant:"contained",endIcon:e.jsx(Gt,{}),onClick:C,disabled:r.length>0,children:"Continue to Export"})]})]})},To=({selectedFormat:t,onFormatChange:s})=>{const n=r=>{s(r.target.value)};return e.jsx(Ct,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(Dt,{children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Select Export Format"}),e.jsx(Ue,{component:"fieldset",children:e.jsxs(Gs,{"aria-label":"export-format",name:"export-format",value:t,onChange:n,children:[e.jsxs(v,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="csv"?"primary.main":"divider",borderRadius:1,bgcolor:t==="csv"?"action.hover":"transparent"},children:[e.jsx(Je,{value:"csv",control:e.jsx(pt,{}),label:e.jsxs(v,{sx:{display:"flex",alignItems:"center",flexWrap:"wrap",gap:1},children:[e.jsx(js,{color:"primary"}),e.jsx(y,{variant:"body1",children:"CSV"}),e.jsx(le,{size:"small",label:"Most Compatible",color:"success"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Comma-separated values format, widely supported by spreadsheet applications like Excel and Google Sheets."})]}),e.jsxs(v,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="json"?"primary.main":"divider",borderRadius:1,bgcolor:t==="json"?"action.hover":"transparent"},children:[e.jsx(Je,{value:"json",control:e.jsx(pt,{}),label:e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(An,{color:"info"}),e.jsx(y,{variant:"body1",children:"JSON"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"JavaScript Object Notation, ideal for programmatic use or importing into other applications."})]}),e.jsxs(v,{sx:{p:1,border:"1px solid",borderColor:t==="excel"?"primary.main":"divider",borderRadius:1,bgcolor:t==="excel"?"action.hover":"transparent"},children:[e.jsx(Je,{value:"excel",control:e.jsx(pt,{}),label:e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(xt,{color:"success"}),e.jsx(y,{variant:"body1",children:"Excel"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Export directly to native Excel format (.xlsx) with proper formatting and column sizing."})]}),e.jsxs(v,{sx:{p:1,border:"1px solid",borderColor:t==="pdf"?"primary.main":"divider",borderRadius:1,bgcolor:t==="pdf"?"action.hover":"transparent"},children:[e.jsx(Je,{value:"pdf",control:e.jsx(pt,{}),label:e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Er,{color:"error"}),e.jsx(y,{variant:"body1",children:"PDF"}),e.jsx(le,{size:"small",label:"Professional",color:"secondary"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Create a professional PDF document with formatted data table, ideal for reports and presentations."})]})]})})]})})},Pt=[{id:"fire-map-pro",name:"Fire Map Pro",description:"Professional mapping and visualization for incident locations and analysis",icon:e.jsx(er,{fontSize:"large",sx:{color:"#dc2626"}}),requiredFields:["incidentId","latitude","longitude"],optionalFields:["incidentType","incidentDate","incidentTime","address","city","state","priority","respondingUnit","responseCategory"]},{id:"response-time-analyzer",name:"Response Time Analyzer",description:"Analyze incident response times and visualize performance metrics",icon:e.jsx(ms,{fontSize:"large",sx:{color:"#2196f3"}}),requiredFields:["incidentId","incidentDate"],optionalFields:["dispatchTime","enRouteTime","arrivalTime","latitude","longitude"]},{id:"call-density-heatmap",name:"Call Density Heatmap",description:"Visualize incident density across geographic areas",icon:e.jsx(er,{fontSize:"large",sx:{color:"#ff9800"}}),requiredFields:["incidentId","latitude","longitude"]},{id:"incident-dashboard",name:"Incident Dashboard",description:"Interactive dashboard for incident analysis and reporting",icon:e.jsx(hs,{fontSize:"large",sx:{color:"#4caf50"}}),requiredFields:["incidentId","incidentType","incidentDate"]},{id:"trend-analyzer",name:"Trend Analyzer",description:"Identify incident trends and patterns over time",icon:e.jsx(Ts,{fontSize:"large",sx:{color:"#9c27b0"}}),requiredFields:["incidentId","incidentDate","incidentType"]}],So=({selectedTool:t,onToolSelect:s,transformedData:n,onSendToTool:r,isSending:o,preTransformedData:a})=>{console.log("📡📡📡 SEND TO TOOL PANEL RENDER - FRESH BUILD JUN 13 2025 16:48 - selectedTool:",t),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - onSendToTool function:",!!r),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - transformedData length:",n==null?void 0:n.length),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData exists:",!!a),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData length:",a==null?void 0:a.length),a&&a.length>0&&console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData sample:",a[0]);const l=d=>{s(d.target.value)},u=t?(d=>{const m=Pt.find(C=>C.id===d);if(!m)return{compatible:!1,missingFields:[]};if(d==="fire-map-pro")if(console.log("🔍 FIRE MAP PRO COMPATIBILITY CHECK - ENHANCED FOR ADDRESS PARSING"),console.log("preTransformedData exists:",!!a),console.log("preTransformedData length:",a==null?void 0:a.length),console.log("transformedData sample:",n[0]),a&&a.length>0){const C=Object.keys(n[0]);console.log("🔍 Available transformed data fields:",C);const B=m.optionalFields?m.optionalFields.filter(U=>{const P=C.includes(U);return console.log(`🔍 Fire Map Pro optional field ${U}: ${P?"AVAILABLE":"NOT AVAILABLE"}`),P}):[],F=m.optionalFields?m.optionalFields.filter(U=>!C.includes(U)):[];return console.log("✅ Fire Map Pro data is compatible - features exist"),console.log("📊 Available optional fields:",B),console.log("📋 Missing optional fields:",F),{compatible:!0,missingFields:[],hasOptionalFields:B,missingOptionalFields:F}}else return console.log("❌ Fire Map Pro data not compatible - no features"),{compatible:!1,missingFields:["incidentId","latitude","longitude"],hasOptionalFields:[],missingOptionalFields:m.optionalFields||[]};if(d==="response-time-analyzer"){console.log("🔍 RESPONSE TIME ANALYZER COMPATIBILITY CHECK - FLEXIBLE FIELD MATCHING");const C=Object.keys(n[0]);console.log("🔍 Available data fields:",C),console.log("🔍 Required fields (camelCase):",m.requiredFields);const B=m.requiredFields.filter(P=>{if(C.includes(P))return console.log(`✅ Found exact match for ${P}`),!1;const S=P.replace(/[A-Z]/g,H=>`_${H.toLowerCase()}`);return C.includes(S)?(console.log(`✅ Found snake_case match for ${P} -> ${S}`),!1):(console.log(`❌ No match found for ${P} (tried ${P} and ${S})`),!0)});console.log("🔍 CHECKING OPTIONAL FIELDS:"),console.log("🔍 Tool optional fields:",m.optionalFields);const F=m.optionalFields?m.optionalFields.filter(P=>{let S=P.replace(/[A-Z]/g,G=>`_${G.toLowerCase()}`);P==="enRouteTime"&&(S="enroute_time");const H=C.includes(P),Y=C.includes(S);return console.log(`🔍 Optional field ${P}: camelCase=${H}, snake_case(${S})=${Y}`),H||Y}):[],U=m.optionalFields?m.optionalFields.filter(P=>{let S=P.replace(/[A-Z]/g,H=>`_${H.toLowerCase()}`);return P==="enRouteTime"&&(S="enroute_time"),!C.includes(P)&&!C.includes(S)}):[];return console.log("🔍 OPTIONAL FIELDS RESULT:"),console.log("✅ Has optional fields:",F),console.log("❌ Missing optional fields:",U),{compatible:B.length===0,missingFields:B,hasOptionalFields:F,missingOptionalFields:U}}const x=Object.keys(n[0]);console.log(`🔍 ${d.toUpperCase()} COMPATIBILITY CHECK`),console.log("Available fields:",x),console.log("Required fields:",m.requiredFields);const T=m.requiredFields.filter(C=>!x.includes(C)),E=m.optionalFields?m.optionalFields.filter(C=>x.includes(C)):[],_=m.optionalFields?m.optionalFields.filter(C=>!x.includes(C)):[];return{compatible:T.length===0,missingFields:T,hasOptionalFields:E,missingOptionalFields:_}})(t):{compatible:!1,missingFields:[]};return e.jsxs(v,{children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Send to FireEMS Tool"}),e.jsx(de,{severity:"info",sx:{mb:3},children:"Send your formatted data directly to another FireEMS tool for analysis and visualization."}),e.jsxs(Ue,{fullWidth:!0,sx:{mb:3},children:[e.jsx(We,{id:"tool-select-label",children:"Select Tool"}),e.jsxs(Ye,{labelId:"tool-select-label",id:"tool-select",value:t||"",label:"Select Tool",onChange:l,children:[e.jsx(oe,{value:"",children:e.jsx("em",{children:"Select a tool..."})}),Pt.map(d=>e.jsx(oe,{value:d.id,children:d.name},d.id))]})]}),t&&e.jsx(pe,{container:!0,spacing:3,children:Pt.filter(d=>d.id===t).map(d=>e.jsx(pe,{size:12,children:e.jsxs(Ct,{variant:"outlined",children:[e.jsxs(Dt,{children:[e.jsxs(v,{sx:{display:"flex",alignItems:"center",mb:2},children:[d.icon,e.jsxs(v,{sx:{ml:2},children:[e.jsx(y,{variant:"h6",children:d.name}),e.jsx(y,{variant:"body2",color:"text.secondary",children:d.description})]})]}),e.jsx(xe,{sx:{mb:2}}),e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Required Fields:"}),e.jsx(v,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.requiredFields.map((m,x)=>e.jsx(y,{variant:"body2",sx:{backgroundColor:u.missingFields.includes(m)?"error.light":"success.light",color:u.missingFields.includes(m)?"error.contrastText":"success.contrastText",borderRadius:1,px:1,py:.5},children:m},x))}),d.optionalFields&&e.jsxs(e.Fragment,{children:[e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Optional Fields:"}),e.jsx(v,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.optionalFields.map((m,x)=>{var T,E;return e.jsx(y,{variant:"body2",sx:{backgroundColor:(T=u.hasOptionalFields)!=null&&T.includes(m)?"info.light":"action.disabledBackground",color:(E=u.hasOptionalFields)!=null&&E.includes(m)?"info.contrastText":"text.secondary",borderRadius:1,px:1,py:.5},children:m},x)})})]}),!u.compatible&&e.jsxs(de,{severity:"warning",icon:e.jsx(kn,{}),sx:{mb:2},children:[e.jsx(y,{variant:"body2",gutterBottom:!0,children:"Your data is missing required fields for this tool:"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:u.missingFields.map((m,x)=>e.jsx("li",{children:m},x))})]}),u.compatible&&e.jsxs(de,{severity:"success",sx:{mb:2},children:[e.jsx(y,{variant:"body2",gutterBottom:!0,children:"Your data is compatible with this tool. All required fields are present."}),d.optionalFields&&u.hasOptionalFields&&u.hasOptionalFields.length>0&&e.jsxs(y,{variant:"body2",children:[u.hasOptionalFields.length," of ",d.optionalFields.length," optional fields are available for enhanced analysis."]})]})]}),e.jsx(fs,{children:e.jsx(re,{type:"button",variant:"contained",color:"primary",fullWidth:!0,disabled:!u.compatible||o,startIcon:o?e.jsx(Ve,{size:20}):e.jsx(Nr,{}),onClick:m=>{m.preventDefault(),m.stopPropagation(),console.log("🚀🚀🚀 SEND TO TOOL BUTTON CLICKED - FRESH BUILD JUN 13 2025 16:49 - tool.id:",d.id),console.log("🚀🚀🚀 SEND TO TOOL BUTTON - onSendToTool function:",r),r()},children:o?"Sending...":`Send to ${d.name}`})})]})},d.id))})]})},Eo=({dataCount:t,fields:s,format:n})=>{const r=()=>{let a=15;n==="json"?a=25:n==="excel"?a=30:n==="pdf"&&(a=40);const l=t*s.length*a;let p=0;n==="excel"?p=5120:n==="pdf"&&(p=15360);const u=l+p;return u<1048576?`${Math.round(u/1024)} KB`:`${(u/1048576).toFixed(2)} MB`},o=()=>{switch(n){case"csv":return e.jsx(Vt,{color:"primary"});case"json":return e.jsx(kr,{color:"info"});case"excel":return e.jsx(xt,{color:"success"});case"pdf":return e.jsx(Er,{color:"error"});default:return e.jsx(Vt,{})}};return e.jsx(Ct,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(Dt,{children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Export Summary"}),e.jsxs(Be,{disablePadding:!0,children:[e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:o()}),e.jsx(Fe,{primary:"Format",secondary:n.toUpperCase()})]}),e.jsx(xe,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(Xe,{color:"success"})}),e.jsx(Fe,{primary:"Records",secondary:`${t} records will be exported`})]}),e.jsx(xe,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(Xe,{color:"success"})}),e.jsx(Fe,{primary:"Fields",secondary:`${s.length} fields per record`})]}),e.jsx(xe,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(Xe,{color:"success"})}),e.jsx(Fe,{primary:"Estimated Size",secondary:r()})]})]}),e.jsx(y,{variant:"subtitle2",sx:{mt:2},children:"Fields included:"}),e.jsx(v,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mt:1},children:s.map((a,l)=>e.jsx(le,{label:a,size:"small"},l))})]})})};console.log("🚨🚨🚨 EXPORT CONTAINER LOADED - NEW VERSION WITH UPFRONT TRANSFORMATION AT",new Date().toISOString());const Fo=t=>!t||t.length===0?t:JSON.parse(JSON.stringify(t)).map(n=>{const r={...n};return["Incident Date"].forEach(l=>{if(r[l]&&typeof r[l]=="string")try{const p=new Date(r[l]);if(isNaN(p.getTime()))r[l].includes(" ")&&(r[l]=r[l].split(" ")[0]);else{const u=(p.getMonth()+1).toString().padStart(2,"0"),d=p.getDate().toString().padStart(2,"0"),m=p.getFullYear();r[l]=`${u}/${d}/${m}`}}catch{r[l].includes(" ")&&(r[l]=r[l].split(" ")[0])}}),["Dispatch Time","En Route Time","Arrival Time","Incident Time"].forEach(l=>{if(r[l]&&typeof r[l]=="string")try{const p=new Date(r[l]);if(isNaN(p.getTime())){if(r[l].includes(" ")){const u=r[l].split(" ");u.length>1&&(r[l]=u[1])}}else{const u=p.getHours().toString().padStart(2,"0"),d=p.getMinutes().toString().padStart(2,"0"),m=p.getSeconds().toString().padStart(2,"0");r[l]=`${u}:${d}:${m}`}}catch{if(r[l].includes(" ")){const u=r[l].split(" ");u.length>1&&(r[l]=u[1])}}}),r}),hr=t=>{const{children:s,value:n,index:r,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==r,id:`export-tabpanel-${r}`,"aria-labelledby":`export-tab-${r}`,...o,children:n===r&&e.jsx(v,{sx:{p:2},children:s})})},Co=()=>{const t=dt(),{sourceFile:s,transformedData:n,validationErrors:r}=He(M=>M.formatter),[o,a]=A.useState(0),[l,p]=A.useState("csv"),[u,d]=A.useState(null),[m,x]=A.useState(null),[T,E]=A.useState(!1),[_,C]=A.useState({success:!1,message:"",open:!1}),[B,F]=A.useState([]),[U,P]=A.useState(!1);A.useEffect(()=>{try{const M=localStorage.getItem("fireEmsExportHistory");M&&F(JSON.parse(M))}catch(M){console.error("Error loading export history:",M)}},[]),A.useEffect(()=>{try{localStorage.setItem("fireEmsExportHistory",JSON.stringify(B))}catch(M){console.error("Error saving export history:",M)}},[B]);const S=(M,N)=>{a(N)},H=M=>{p(M)},Y=M=>{var N,ee;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleToolChange CALLED AT",new Date().toISOString()),console.log("🔧 TOOL SELECTION CHANGED - TRANSFORMING DATA UPFRONT:",M),console.log("🔧 transformedData exists:",!!n),console.log("🔧 transformedData length:",n==null?void 0:n.length),console.log('🔧 toolId === "response-time-analyzer":',M==="response-time-analyzer"),d(M),M==="response-time-analyzer"&&n&&n.length>0){console.log("🔧 APPLYING RESPONSE TIME ANALYZER TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",n[0]),console.log("Original field names:",Object.keys(n[0]));try{const f=It.transformToResponseTimeAnalyzer(n);if(!f.success){console.error("❌ Data transformation failed:",f.errors),x(null);return}const L=f.data||[];console.log("✅ UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed data sample (first record):",L[0]),console.log("Transformed field names:",Object.keys(L[0])),console.log("incidentTime value:",(N=L[0])==null?void 0:N.incidentTime),x(L)}catch(f){console.error("❌ Error during upfront transformation:",f),x(null)}}else if(M==="fire-map-pro"&&n&&n.length>0){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",n[0]),console.log("Original field names:",Object.keys(n[0]));try{const f=It.transformToFireMapPro(n);if(!f.success){console.error("❌ Fire Map Pro transformation failed:",f.errors),x(null);return}const L=((ee=f.data)==null?void 0:ee.features)||[];console.log("✅ FIRE MAP PRO UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed features count:",L.length),console.log("Sample feature:",L[0]),x(L)}catch(f){console.error("❌ Error during Fire Map Pro upfront transformation:",f),x(null)}}else x(null)},G=(M,N,ee,f,L)=>{const R={id:`export-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,timestamp:Date.now(),format:M,recordCount:N,success:ee,destination:f,fileName:L};F(V=>[R,...V].slice(0,20))},i=()=>{F([])},c=()=>{const M=new Date;return M.toLocaleDateString()+" "+M.toLocaleTimeString()},h=async()=>{if(!n||n.length===0){C({success:!1,message:"No data to export",open:!0});return}E(!0);try{const M=Fo(n);let N=`formatted_data_${Date.now()}`;if(l==="excel"){const w=await xr(()=>import("./xlsx-DkH2s96g.js"),[]),j=w.utils.json_to_sheet(M),I={},J=Object.keys(n[0]);J.forEach($=>{I[$]=Math.max(10,$.length+2)}),n.forEach($=>{J.forEach(O=>{const b=String($[O]||"");I[O]=Math.min(50,Math.max(I[O],b.length+2))})}),j["!cols"]=J.map($=>({wch:I[$]}));const K=w.utils.book_new();K.Props={Title:"FireEMS Formatted Data",Subject:"Incident Data",Author:"FireEMS Data Formatter",CreatedDate:new Date},w.utils.book_append_sheet(K,j,"Formatted Data"),N=`formatted_data_${Date.now()}.xlsx`,w.writeFile(K,N),G("Excel",M.length,!0,"File Download",N),C({success:!0,message:"Data exported successfully as EXCEL",open:!0}),E(!1);return}if(l==="pdf"){const w=new as;w.setFontSize(18),w.text("FireEMS Formatted Data",14,22),w.setFontSize(11),w.text(`Export Date: ${c()}`,14,30),w.text(`Records: ${M.length}`,14,36);const j=Object.keys(M[0]);M.length>500&&w.text("Note: Export limited to 500 records for PDF format.",14,42);const I=M.length>500?48:42,J=30,K=10,$=10;w.setFontSize(10),w.setTextColor(0,0,0),w.setFillColor(220,220,220),j.forEach((b,g)=>{w.rect($+g*J,I,J,K,"FD"),w.text(b,$+g*J+2,I+7)});const O=Math.min(M.length,20);for(let b=0;b<O;b++){const g=I+(b+1)*K;j.forEach((z,q)=>{w.rect($+q*J,g,J,K,"S");const Z=M[b][z]||"";let ne=String(Z);ne.length>10&&(ne=ne.substring(0,8)+"..."),w.text(ne,$+q*J+2,g+7)})}w.setFontSize(8),w.text(`Generated by FireEMS Tools - ${new Date().toLocaleString()}`,w.internal.pageSize.width/2,w.internal.pageSize.height-10,{align:"center"}),N=`formatted_data_${Date.now()}.pdf`,w.save(N),G("PDF",M.length,!0,"File Download",N),C({success:!0,message:"Data exported successfully as PDF",open:!0}),E(!1);return}let ee="",f="";if(l==="csv"){const w=Object.keys(M[0]);ee=w.join(",")+`
`,M.forEach(j=>{const I=w.map(J=>{const K=j[J];return K==null?"":typeof K=="string"&&(K.includes(",")||K.includes('"')||K.includes(`
`))?`"${K.replace(/"/g,'""')}"`:K});ee+=I.join(",")+`
`}),N=`formatted_data_${Date.now()}.csv`,f="text/csv"}else l==="json"&&(ee=JSON.stringify(M,null,2),N=`formatted_data_${Date.now()}.json`,f="application/json");const L=new Blob([ee],{type:f}),R=URL.createObjectURL(L),V=document.createElement("a");V.href=R,V.download=N,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(R),G(l.toUpperCase(),M.length,!0,"File Download",N),C({success:!0,message:`Data exported successfully as ${l.toUpperCase()}`,open:!0})}catch(M){console.error("Export error:",M),C({success:!1,message:`Error exporting data: ${M instanceof Error?M.message:"Unknown error"}`,open:!0}),G(l.toUpperCase(),n.length,!1,"File Download")}finally{E(!1)}},D=M=>({"response-time-analyzer":"Response Time Analyzer","call-density-heatmap":"Call Density Heatmap","incident-dashboard":"Incident Dashboard","trend-analyzer":"Trend Analyzer"})[M]||M,k=async()=>{var N,ee;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleSendToTool FUNCTION CALLED AT",new Date().toISOString()),console.log("🚀🚀🚀 selectedExportTool:",u),console.log("🚀🚀🚀 transformedData length:",n==null?void 0:n.length),console.log("🚀🚀🚀 preTransformedData length:",m==null?void 0:m.length),console.log("🚀🚀🚀 transformedData sample:",n==null?void 0:n[0]),!n||n.length===0||!u){console.log("❌ SEND TO TOOL FAILED - Missing data or tool selection"),console.log("❌ transformedData:",!!n),console.log("❌ transformedData.length:",n==null?void 0:n.length),console.log("❌ selectedExportTool:",u),C({success:!1,message:"No data or tool selected",open:!0});return}E(!0);const M=D(u);console.log("🚀 Tool name resolved:",M);try{let f;if(console.log('🔧 CHECKING TOOL TYPE - selectedExportTool === "response-time-analyzer":',u==="response-time-analyzer"),console.log("🔧 CHECKING PRE-TRANSFORMED DATA AVAILABILITY:",!!m),u==="response-time-analyzer"&&m&&m.length>0)console.log("✅ USING PRE-TRANSFORMED DATA FROM TOOL SELECTION - NO REDUNDANT TRANSFORMATION"),console.log("Pre-transformed data sample (first record):",m[0]),console.log("Pre-transformed field names:",Object.keys(m[0])),console.log("incidentTime value:",(N=m[0])==null?void 0:N.incidentTime),f=m;else if(u==="fire-map-pro"){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION");const R=It.transformToFireMapPro(n);if(!R.success)throw console.error("❌ Data transformation failed:",R.errors),new Error(`Data transformation failed: ${R.errors.join(", ")}`);f=((ee=R.data)==null?void 0:ee.features)||[]}else console.log("🔧 USING STANDARD DATA FORMATTING"),console.log("DEBUG - USING ALREADY TRANSFORMED DATA: Sample data fields:",n.length>0?Object.keys(n[0]):"No data"),f=n.map(R=>{const V={...R};return console.log("DEBUG - USING MAPPED DATA: Record fields:",Object.keys(R)),Object.keys(V).forEach(w=>{if(V[w]&&typeof V[w]=="string"&&V[w].includes(" ")){const[j,I]=V[w].split(" ");console.log(`DATETIME SPLIT: Field "${w}" = "${V[w]}" -> Date: "${j}", Time: "${I}"`),w.toLowerCase().includes("date")?(console.log(`SETTING DATE FIELD "${w}" to "${j}"`),V[w]=j):w.toLowerCase().includes("time")&&(console.log(`SETTING TIME FIELD "${w}" to "${I}"`),V[w]=I)}}),V});const L={toolId:u,toolName:M,data:f,sourceFile:s==null?void 0:s.name,timestamp:Date.now(),fields:Object.keys(f[0]),recordCount:f.length,exportVersion:"2.0"};if(f.length>0){console.log("Sample record being sent (using user-mapped fields):",f[0]);const R=f[0],V=Object.keys(R);console.log("All field names (as mapped by user):",V),console.log("Field values:",R)}sessionStorage.removeItem("fireEmsExportedData"),console.log("VERIFY: Field names being stored in sessionStorage:",L.data&&L.data.length>0?Object.keys(L.data[0]):"No data"),sessionStorage.setItem("fireEmsExportedData",JSON.stringify(L)),console.log(`Data prepared for ${u}. Data size: ${f.length} records`),f.length>0&&(console.log("FIELD NAMES CHECK - Sample record being sent to session storage:"),console.log(JSON.stringify(f[0]))),G("Data Transfer",f.length,!0,M),C({success:!0,message:`Data sent to ${M} successfully!`,open:!0}),setTimeout(()=>{const w=`http://${window.location.hostname}:5006`;let j="";if(u==="fire-map-pro")j=`${window.location.origin}/app/fire-map-pro`;else if(u==="response-time-analyzer")j=`${window.location.origin}/app/response-time-analyzer`;else if(u==="call-density-heatmap")j=`${w}/call-density-heatmap`;else if(u==="incident-dashboard")j=`${w}/incident-dashboard`;else if(u==="trend-analyzer")j=`${w}/trend-analyzer`;else{console.log(`Tool ID not recognized: ${u}`);return}console.log(`Redirecting to: ${j}`),window.location.href=j},500)}catch(f){console.error("Send to tool error:",f),C({success:!1,message:`Error sending data to tool: ${f instanceof Error?f.message:"Unknown error"}`,open:!0}),G("Data Transfer",n.length,!1,M)}finally{E(!1)}},W=()=>{t(Le(2))};if(!n||n.length===0)return e.jsxs(v,{children:[e.jsx(de,{severity:"warning",sx:{mb:2},children:"No data available to export. Please go back and ensure your data is processed correctly."}),e.jsx(re,{variant:"outlined",startIcon:e.jsx(ot,{}),onClick:W,children:"Back to Validation"})]});const X=M=>new Date(M).toLocaleString(),ae=()=>B.length===0?e.jsx(v,{sx:{p:2,textAlign:"center"},children:e.jsx(y,{color:"text.secondary",children:"No export history available"})}):e.jsx(Be,{sx:{width:"100%",bgcolor:"background.paper"},dense:!0,children:B.map(M=>e.jsxs(Ee,{secondaryAction:e.jsx(De,{edge:"end","aria-label":"delete",onClick:()=>{F(N=>N.filter(ee=>ee.id!==M.id))},children:e.jsx(lt,{fontSize:"small"})}),sx:{borderLeft:"4px solid",borderColor:M.success?"success.main":"error.main",mb:1,bgcolor:"background.paper","&:hover":{bgcolor:"action.hover"}},children:[e.jsxs(ke,{children:[M.format==="Excel"&&e.jsx(xt,{color:"success"}),M.format==="CSV"&&e.jsx(Vt,{color:"primary"}),M.format==="JSON"&&e.jsx(kr,{color:"info"}),M.format==="PDF"&&e.jsx(xt,{color:"error"}),M.format==="Data Transfer"&&e.jsx(Nr,{color:"secondary"})]}),e.jsx(Fe,{primary:e.jsx(y,{variant:"body2",fontWeight:"medium",children:M.format==="Data Transfer"?`Sent to ${M.destination}`:`${M.format} Export${M.fileName?` - ${M.fileName}`:""}`}),secondary:e.jsxs(y,{variant:"caption",display:"block",children:[X(M.timestamp)," • ",M.recordCount," records",!M.success&&" • Failed"]})})]},M.id))});return console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - FRESH BUILD JUN 13 2025 16:47 - transformedData length:",n==null?void 0:n.length),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - selectedExportTool:",u),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - tabValue:",o),e.jsxs(v,{children:[e.jsx(y,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Export Formatted Data"}),e.jsxs(ge,{sx:{p:2,mb:3},children:[e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(v,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(y,{variant:"body1",children:[(s==null?void 0:s.name)||"No file"," (",s==null?void 0:s.type,")"]})]})}),e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(v,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(y,{variant:"body1",children:[n.length," records processed"]})]})}),e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(v,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(v,{sx:{display:"flex",alignItems:"center",gap:1},children:r.length===0?e.jsxs(e.Fragment,{children:[e.jsx(Xe,{color:"success"}),e.jsx(y,{color:"success.main",children:"All data is valid"})]}):e.jsx(e.Fragment,{children:e.jsxs(de,{severity:"warning",sx:{mt:1},children:[r.length," validation issues found. Consider reviewing before export."]})})})]})})]}),e.jsxs(v,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(v,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Bt,{color:"action",fontSize:"small"}),e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Export History"}),B.length>0&&e.jsx(As,{badgeContent:B.length,color:"primary",sx:{ml:1}})]}),e.jsxs(v,{children:[e.jsx(De,{size:"small",onClick:()=>P(!U),"aria-label":U?"Hide history":"Show history",children:U?e.jsx(br,{}):e.jsx(Ft,{})}),B.length>0&&U&&e.jsx(re,{size:"small",startIcon:e.jsx(lt,{}),onClick:i,sx:{ml:1},children:"Clear"})]})]}),e.jsx(Ir,{in:U,children:e.jsx(v,{sx:{mt:2},children:ae()})})]}),e.jsx(v,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(Et,{value:o,onChange:S,"aria-label":"export options tabs",children:[e.jsx(_e,{label:"Download File",id:"export-tab-0","aria-controls":"export-tabpanel-0"}),e.jsx(_e,{label:"Send to Tool",id:"export-tab-1","aria-controls":"export-tabpanel-1"})]})}),e.jsx(hr,{value:o,index:0,children:e.jsxs(pe,{container:!0,spacing:3,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsx(To,{selectedFormat:l,onFormatChange:H})}),e.jsx(pe,{size:{xs:12,md:6},children:e.jsx(Eo,{dataCount:n.length,fields:Object.keys(n[0]),format:l})}),e.jsx(pe,{size:12,children:e.jsx(re,{variant:"contained",color:"primary",fullWidth:!0,size:"large",onClick:h,disabled:T,startIcon:T?e.jsx(Ve,{size:20}):e.jsx(xs,{}),sx:{mt:2},children:T?"Exporting...":`Download as ${l.toUpperCase()}`})})]})}),e.jsx(hr,{value:o,index:1,children:e.jsx(So,{selectedTool:u,onToolSelect:Y,transformedData:n,onSendToTool:k,isSending:T,preTransformedData:m})}),e.jsx(xe,{sx:{my:3}}),e.jsx(v,{sx:{display:"flex",justifyContent:"space-between"},children:e.jsx(re,{variant:"outlined",startIcon:e.jsx(ot,{}),onClick:W,children:"Back to Validation"})}),e.jsx(vr,{open:_.open,autoHideDuration:6e3,onClose:()=>C({..._,open:!1}),children:e.jsx(de,{onClose:()=>C({..._,open:!1}),severity:_.success?"success":"error",children:_.message})})]})},gr={log:(...t)=>{},warn:(...t)=>{},error:(...t)=>{console.error(...t)},debug:(...t)=>{},info:(...t)=>{}},Do=["Upload File","Map Fields","Preview & Validate","Export"],qo=()=>{const{currentStep:t}=He(r=>r.formatter),s=()=>{const r=window.location.pathname;return r.includes("fire-map-pro")?"FireEMS Fire Map Pro":r.includes("response-time-analyzer")?"FireEMS Response Time Analyzer":"FireEMS Data Formatter"};Ze.useEffect(()=>{const r=s();document.title=r;try{bt(),gr.debug("[DEBUG] Vendor templates seeded successfully")}catch(o){gr.error("[ERROR] Failed to seed vendor templates:",o)}},[]);const n=r=>{switch(r){case 0:return e.jsx(an,{});case 1:return e.jsx(uo,{});case 2:return e.jsx(jo,{});case 3:return e.jsx(Co,{});default:return e.jsx(y,{children:"Unknown step"})}};return e.jsx(Kr,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(ge,{elevation:3,sx:{p:3},children:[e.jsx(y,{variant:"h4",component:"h1",gutterBottom:!0,children:s()}),e.jsx(ys,{activeStep:t,sx:{mb:4},children:Do.map(r=>e.jsx(bs,{children:e.jsx(vs,{children:r})},r))}),e.jsx(v,{sx:{mt:2},children:n(t)})]})})};export{qo as default};
