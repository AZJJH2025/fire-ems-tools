<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireMapPro | FireEMS.ai</title>
    
    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fire-map-pro.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fix-ready-status.css') }}">
    
    <!-- Fix for Leaflet.Draw z-index issue -->
    <style>
        /* Comprehensive fix for all Leaflet.Draw elements */
        .leaflet-draw, 
        .leaflet-draw.leaflet-control,
        .leaflet-draw-toolbar, 
        .leaflet-draw-toolbar a, 
        .leaflet-draw-actions, 
        .leaflet-draw-actions a,
        [class*="leaflet-draw-"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 2000 !important;
            pointer-events: auto !important;
        }
        
        /* Ensure toolbar has proper background */
        .leaflet-draw-toolbar {
            background: white !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            border-radius: 4px !important;
        }
        
        /* Style buttons specifically */
        .leaflet-draw-toolbar a {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            text-align: center !important;
        }
    </style>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Preload critical libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- Force draw controls for extra reliability -->
    <script>
        // Add global initialization for Draw controls
        window.addEventListener('load', function() {
            setTimeout(function() {
                // Check if draw controls exist, if not force them
                if (!document.querySelector('.leaflet-draw')) {
                    console.log('No Leaflet Draw controls found after load, forcing visibility...');
                    const styleTag = document.createElement('style');
                    styleTag.textContent = `
                        .leaflet-draw, .leaflet-draw-toolbar, .leaflet-draw-toolbar a,
                        .leaflet-draw.leaflet-control, .leaflet-draw-actions, .leaflet-draw-actions a,
                        [class*="leaflet-draw"] {
                            display: block !important;
                            visibility: visible !important;
                            opacity: 1 !important;
                            z-index: 2000 !important;
                            pointer-events: auto !important;
                        }
                    `;
                    document.head.appendChild(styleTag);
                }
            }, 2000); // Check 2 seconds after load
        });
    </script>
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <a href="/">
                <i class="fas fa-fire"></i> FireEMS.ai
            </a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/fire-ems-dashboard">Response Time Analyzer</a>
            <a href="/isochrone-map">Isochrone Map Generator</a>
            <a href="/call-density-heatmap">Call Density Heatmap</a>
            <a href="/coverage-gap-finder">Coverage Gap Finder</a>
            <a href="/fire-map-pro" class="active">FireMapPro</a>
        </div>
    </div>

    <div class="container">
        <div class="panel-container">
            <div class="left-panel">
                <h2>FireMapPro</h2>
                <p>Advanced interactive map creator for fire department and EMS planning and analysis.</p>
                
                <div class="tools-section">
                    <h3><i class="fas fa-layer-group"></i> Map Layers</h3>
                    <div class="layer-controls">
                        <div class="base-layers">
                            <h4>Base Maps</h4>
                            <div class="radio-group">
                                <input type="radio" id="street-layer" name="base-layer" value="street" checked>
                                <label for="street-layer">Street</label>
                                
                                <input type="radio" id="satellite-layer" name="base-layer" value="satellite">
                                <label for="satellite-layer">Satellite</label>
                                
                                <input type="radio" id="terrain-layer" name="base-layer" value="terrain">
                                <label for="terrain-layer">Terrain</label>
                            </div>
                        </div>
                        
                        <div class="overlay-layers">
                            <h4>Data Overlays</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stations-layer" value="stations">
                                    <label for="stations-layer">Fire Stations</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="incidents-layer" value="incidents">
                                    <label for="incidents-layer">Incidents</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="response-layer" value="response">
                                    <label for="response-layer">Response Areas</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="population-layer" value="population">
                                    <label for="population-layer">Population Density</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hydrants-layer" value="hydrants">
                                    <label for="hydrants-layer">Hydrants</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-file-upload"></i> Custom Data</h3>
                    <div class="upload-section">
                        <h4>Import Data</h4>
                        <div class="file-upload">
                            <label for="geojson-upload" class="upload-btn">
                                <i class="fas fa-file-import"></i> GeoJSON / KML
                            </label>
                            <input type="file" id="geojson-upload" accept=".geojson,.json,.kml">
                        </div>
                        
                        <div class="file-upload">
                            <label for="csv-upload" class="upload-btn">
                                <i class="fas fa-table"></i> CSV with Coordinates
                            </label>
                            <input type="file" id="csv-upload" accept=".csv">
                        </div>
                        
                        <div class="file-upload">
                            <label for="image-upload" class="upload-btn">
                                <i class="fas fa-image"></i> Image Overlay
                            </label>
                            <input type="file" id="image-upload" accept="image/*">
                        </div>
                        <div id="upload-status"></div>
                        
                        <!-- CSV Configuration Options -->
                        <div class="csv-config-section">
                            <h4>CSV Import Settings</h4>
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-preview-enable" checked>
                                <label for="csv-preview-enable">Show preview before import</label>
                            </div>
                            
                            <div class="input-group">
                                <label for="csv-coord-format">Coordinate Format:</label>
                                <select id="csv-coord-format">
                                    <option value="lat_lng">Latitude, Longitude</option>
                                    <option value="lng_lat">Longitude, Latitude</option>
                                </select>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-header-detection" checked>
                                <label for="csv-header-detection">Auto-detect headers</label>
                            </div>
                            
                            <div class="info-text">
                                <i class="fas fa-info-circle"></i> Set coordinate format to "Longitude, Latitude" for Phoenix data
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-tools"></i> Map Tools</h3>
                    <div class="map-tools">
                        <button id="draw-tool" class="tool-btn">
                            <i class="fas fa-draw-polygon"></i> Draw & Measure
                        </button>
                        
                        <button id="search-tool" class="tool-btn">
                            <i class="fas fa-search-location"></i> Search Address
                        </button>
                        
                        <button id="filter-tool" class="tool-btn">
                            <i class="fas fa-filter"></i> Filter Data
                        </button>
                        
                        <button id="export-tool" class="tool-btn">
                            <i class="fas fa-file-export"></i> Export Map
                        </button>
                        
                        <button id="icon-tool" class="tool-btn">
                            <i class="fas fa-icons"></i> Add Icons
                        </button>
                        
                        <button id="clear-map" class="tool-btn danger">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div id="icon-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-icons"></i> Drag Icons To Map</h3>
                    <p class="hint-text"><i class="fas fa-info-circle"></i> Drag and drop icons onto the map</p>
                    <div class="icon-palette">
                        <div class="icon-category">
                            <h4>Emergency Services</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="fire-station">
                                    <i class="fas fa-fire-extinguisher"></i>
                                    <span>Fire Station</span>
                                </div>
                                <div class="draggable-icon" data-icon="hospital">
                                    <i class="fas fa-hospital"></i>
                                    <span>Hospital</span>
                                </div>
                                <div class="draggable-icon" data-icon="ambulance">
                                    <i class="fas fa-ambulance"></i>
                                    <span>Ambulance</span>
                                </div>
                                <div class="draggable-icon" data-icon="police">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Police</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-category">
                            <h4>Infrastructure</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="hydrant">
                                    <i class="fas fa-tint"></i>
                                    <span>Hydrant</span>
                                </div>
                                <div class="draggable-icon" data-icon="school">
                                    <i class="fas fa-school"></i>
                                    <span>School</span>
                                </div>
                                <div class="draggable-icon" data-icon="building">
                                    <i class="fas fa-building"></i>
                                    <span>Building</span>
                                </div>
                                <div class="draggable-icon" data-icon="landmark">
                                    <i class="fas fa-landmark"></i>
                                    <span>Facility</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-category">
                            <h4>Warnings & Markers</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="warning">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Warning</span>
                                </div>
                                <div class="draggable-icon" data-icon="biohazard">
                                    <i class="fas fa-biohazard"></i>
                                    <span>Hazard</span>
                                </div>
                                <div class="draggable-icon" data-icon="marker">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Marker</span>
                                </div>
                                <div class="draggable-icon" data-icon="target">
                                    <i class="fas fa-crosshairs"></i>
                                    <span>Target</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-options">
                            <div class="color-selector">
                                <label for="icon-color">Icon Color:</label>
                                <select id="icon-color">
                                    <option value="#d32f2f" selected>Red</option>
                                    <option value="#1976d2">Blue</option>
                                    <option value="#388e3c">Green</option>
                                    <option value="#f57c00">Orange</option>
                                    <option value="#5e35b1">Purple</option>
                                    <option value="#000000">Black</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="search-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-search"></i> Search</h3>
                    <div class="search-box">
                        <input type="text" id="address-search" placeholder="Enter an address to search...">
                        <button id="search-btn" class="primary-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="search-results"></div>
                </div>
                
                <div id="filter-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-filter"></i> Filter Data</h3>
                    <div class="filter-options">
                        <div class="filter-group">
                            <label for="filter-type">Type:</label>
                            <select id="filter-type">
                                <option value="all">All</option>
                                <option value="fire">Fire</option>
                                <option value="ems">EMS</option>
                                <option value="hazmat">Hazmat</option>
                                <option value="rescue">Rescue</option>
                            </select>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-date-range">Date Range:</label>
                            <div class="date-range">
                                <input type="date" id="filter-date-start">
                                <span>to</span>
                                <input type="date" id="filter-date-end">
                            </div>
                        </div>
                        
                        <div class="filter-group">
                            <label for="filter-priority">Priority:</label>
                            <select id="filter-priority">
                                <option value="all">All</option>
                                <option value="high">High</option>
                                <option value="medium">Medium</option>
                                <option value="low">Low</option>
                            </select>
                        </div>
                        
                        <button id="apply-filter" class="primary-btn">
                            <i class="fas fa-check"></i> Apply Filter
                        </button>
                        <button id="reset-filter" class="secondary-btn">
                            <i class="fas fa-undo"></i> Reset
                        </button>
                    </div>
                </div>
                
                <div id="export-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-file-export"></i> Export Map</h3>
                    <div class="export-options">
                        <button id="export-pdf" class="export-btn">
                            <i class="fas fa-file-pdf"></i> Export as PDF
                        </button>
                        
                        <button id="export-png" class="export-btn">
                            <i class="fas fa-file-image"></i> Export as PNG
                        </button>
                        
                        <button id="export-geojson" class="export-btn">
                            <i class="fas fa-file-code"></i> Export as GeoJSON
                        </button>
                        
                        <div class="export-settings">
                            <div class="checkbox-item">
                                <input type="checkbox" id="include-legend" checked>
                                <label for="include-legend">Include Legend</label>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="checkbox" id="include-scale" checked>
                                <label for="include-scale">Include Scale</label>
                            </div>
                            
                            <div class="input-group">
                                <label for="export-title">Title:</label>
                                <input type="text" id="export-title" placeholder="Map Title">
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <!-- Map structure rebuilt to match Station Overview implementation -->
                <div class="map-card">
                    <h3>FireMapPro Interactive Map</h3>
                    <div id="map-container" class="map-container">
                        <div id="map" style="height: 600px; width: 100%;"></div>
                        
                        <!-- Map overlays -->
                        <div id="measurement-info" class="map-overlay-panel" style="display: none;">
                            <h4>Measurement</h4>
                            <div id="distance-measurement">
                                <strong>Distance:</strong> <span id="distance-value">0</span> miles
                            </div>
                            <div id="area-measurement">
                                <strong>Area:</strong> <span id="area-value">0</span> sq miles
                            </div>
                        </div>
                        
                        <div id="coordinates-display" class="map-overlay-panel">
                            <span id="coordinate-values">Lat: 0.00000, Lng: 0.00000</span>
                        </div>
                    </div>
                </div>
                
                <div id="data-panel" style="display: none;">
                    <h3>Selected Feature Details</h3>
                    <div id="feature-info"></div>
                </div>
            </div>
        </div>
    </div>

    <footer>
        <div class="footer-content">
            <p>&copy; 2025 FireEMS.ai - Advanced Analytics Tools for Fire & EMS Agencies</p>
        </div>
    </footer>

    <!-- External JS Libraries -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- App JS -->
    <script src="/static/fire-map-pro.js"></script>
    
    <!-- Additional Map Initialization Helper -->
    <script>
        // Force map initialization after page loads
        window.addEventListener('load', function() {
            console.log('Window fully loaded - checking map initialization');
            
            // First check if we have a valid Leaflet map object
            setTimeout(function() {
                if (typeof L !== 'undefined') {
                    console.log('Leaflet is available');
                    
                    if (window.map && typeof window.map.invalidateSize === 'function') {
                        console.log('Map is properly initialized, forcing refresh');
                        window.map.invalidateSize(true);
                    } else {
                        console.log('Map not properly initialized, attempting emergency initialization');
                        
                        try {
                            // The proper way to remove a Leaflet map is to call .remove()
                            // First check if there's already a map instance on window.map
                            if (window.map && typeof window.map.remove === 'function') {
                                console.log('Removing existing map instance');
                                window.map.remove(); // Properly removes the map
                                window.map = null;
                            }
                            
                            // Additionally, for extra safety, let's replace the map container
                            const rightPanel = document.querySelector('.right-panel');
                            if (rightPanel) {
                                console.log('Rebuilding map container');
                                // Get the map-card element
                                const mapCard = rightPanel.querySelector('.map-card');
                                if (mapCard) {
                                    const oldMapContainer = mapCard.querySelector('.map-container');
                                    if (oldMapContainer) {
                                        // Remove old container
                                        oldMapContainer.remove();
                                        
                                        // Create new container
                                        const newMapContainer = document.createElement('div');
                                        newMapContainer.id = 'map-container';
                                        newMapContainer.className = 'map-container';
                                        
                                        // Create new map div
                                        const newMapDiv = document.createElement('div');
                                        newMapDiv.id = 'map';
                                        newMapDiv.style.height = '600px';
                                        newMapDiv.style.width = '100%';
                                        
                                        // Add to DOM
                                        newMapContainer.appendChild(newMapDiv);
                                        mapCard.appendChild(newMapContainer);
                                        
                                        // Add coordinate display
                                        const coordDisplay = document.createElement('div');
                                        coordDisplay.id = 'coordinates-display';
                                        coordDisplay.className = 'map-overlay-panel';
                                        coordDisplay.innerHTML = '<span id="coordinate-values">Lat: 0.00000, Lng: 0.00000</span>';
                                        newMapContainer.appendChild(coordDisplay);
                                        
                                        console.log('Map container rebuilt successfully');
                                    }
                                }
                            }
                            
                            // Try to get the new map container
                            const mapContainer = document.getElementById('map');
                            if (!mapContainer) {
                                console.error('Map container not found in DOM after rebuild');
                                return;
                            }
                            
                            // Small delay to ensure DOM is updated
                            setTimeout(function() {
                                try {
                                    // Create fresh map instance on newly created container
                                    window.map = L.map('map', {
                                        center: [39.8283, -98.5795],
                                        zoom: 4,
                                        zoomControl: true,
                                        scrollWheelZoom: true,
                                        doubleClickZoom: true,
                                        dragging: true
                                    });
                                    
                                    // Add the base tile layer
                                    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                                        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                                        maxZoom: 19
                                    }).addTo(window.map);
                                    
                                    // Add zoom controls explicitly
                                    L.control.zoom({
                                        position: 'topright'
                                    }).addTo(window.map);
                                    
                                    // Add a scale control
                                    L.control.scale().addTo(window.map);
                                    
                                    console.log('New map instance created successfully with all controls');
                                } catch (err) {
                                    console.error('Failed to create map:', err);
                                }
                            }, 200);
                            
                            // Tile layer will be added in the timeout function above
                            
                            // Force resize after creation with a longer timeout
                            setTimeout(function() {
                                if (window.map && typeof window.map.invalidateSize === 'function') {
                                    window.map.invalidateSize(true);
                                    console.log('Map size invalidated after emergency initialization');
                                    
                                    try {
                                        // Make sure important map layers are set up if they don't exist yet
                                        if (!window.drawnItems) {
                                            window.drawnItems = new L.FeatureGroup();
                                            window.map.addLayer(window.drawnItems);
                                            console.log('Created drawnItems layer');
                                        }
                                        
                                        if (!window.measurementLayer) {
                                            window.measurementLayer = new L.FeatureGroup();
                                            window.map.addLayer(window.measurementLayer);
                                            console.log('Created measurementLayer');
                                        }
                                        
                                        if (!window.iconLayer) {
                                            window.iconLayer = new L.FeatureGroup();
                                            window.map.addLayer(window.iconLayer);
                                            console.log('Created iconLayer');
                                        }
                                        
                                        if (!window.customDataLayers) {
                                            window.customDataLayers = {};
                                            console.log('Initialized customDataLayers');
                                        }
                                        
                                        if (!window.baseLayers) {
                                            window.baseLayers = {
                                                "Street": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png')
                                            };
                                            console.log('Initialized baseLayers');
                                        }
                                        
                                        console.log('Emergency map initialization fully completed');
                                    } catch (err) {
                                        console.error('Error setting up map layers:', err);
                                    }
                                }
                            }, 500);
                        } catch (error) {
                            console.error('Error in emergency map initialization:', error);
                        }
                    }
                } else {
                    console.error('Leaflet library not loaded');
                }
            }, 500);
        });
    </script>
</body>
</html>