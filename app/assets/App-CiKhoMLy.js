var Ts=Object.defineProperty;var vs=(t,r,n)=>r in t?Ts(t,r,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[r]=n;var it=(t,r,n)=>vs(t,typeof r!="symbol"?r+"":r,n);import{g as Es,a as Ss,r as M,u as Cs,j as e,s as ft,c as Fs,b as Ds,m as As,d as Is,_ as ss,e as at,f as Be,B as j,t as Lt,h as ws,C as Ue,i as Ne,k as _s,l as $s,n as ns,o as Le,p as xe,R as Je,q as Me,v as Rs,G as Os,w as Ns,x as Ms,y as Ps}from"./index-DIxm5UxC.js";import{U as zt}from"./CloudUpload-BX50vhnj.js";import{T as f,c as pe,P as ye,u as Nt}from"./Typography-B0YDethp.js";import{G as he,C as le}from"./listItemTextClasses-18_WKAeo.js";import{F as _e,I as $e,S as Re,A as ue,a as Ae,T as Te,b as ks,M as Ls}from"./TextField-DHEDdkew.js";import{M as re}from"./MenuItem-BW5OhP-4.js";import{B as oe,L as Ve}from"./List-CeknlX3j.js";import{D as be,a as Ke,b as Xe,c as Ze,d as Qe}from"./Divider-B6WexYtJ.js";import{A as tt}from"./ArrowBack-DQBmugn_.js";import{S as zs,a as rs}from"./Save-v1A3NVS_.js";import{C as Us,S as nt}from"./Search-9dsbXfsD.js";import{F as Vs}from"./FormGroup-CPrcnb0g.js";import{F as We}from"./FormControlLabel-BYKRMVJr.js";import{T as dt,a as ut,b as Pe,c as Ce,d as pt,e as At}from"./TableRow-BWA6SPB_.js";import{T as ze,A as Bs,E as Gs}from"./Edit-CIj1EzjA.js";import{S as st,L as Hs,C as It,T as Ws,P as os}from"./PictureAsPdf-CDqepNRD.js";import{C as qe}from"./CheckCircle-DedHYT75.js";import{D as rt}from"./Delete-BmddXmNx.js";import{I as Oe}from"./InputAdornment-p-QF2FIA.js";import{A as as,a as is,E as xt,b as ls,C as cs}from"./ExpandMore-DRLq8uQR.js";import{S as ds}from"./Settings-CS1pEDb_.js";import{E as us}from"./Error-BVW3IPRn.js";import{W as ps}from"./Warning-BmJhT6-0.js";import{T as Ut,E as ms,D as vt}from"./dataTransformer-Yao04d_n.js";import{T as yt,a as Ie}from"./Tabs-DM2bRPov.js";import{C as Ys}from"./Close-f3zwya9T.js";import{H as qs}from"./HelpOutline-CIGHRsLa.js";import{L as Fe,a as ke,b as De,c as wt}from"./ListItemText-Dvzo73CH.js";import{B as Et}from"./Business-jo3r6M-R.js";import{C as bt,a as jt}from"./CardContent-DxMlcgUw.js";import{S as hs}from"./Snackbar-DCjUjOAq.js";import{D as Js}from"./Download-B_-BrVjz.js";import{D as mt}from"./Description-BFiF4tCq.js";import{E as Ks}from"./jspdf.es.min-C1nyZBgt.js";import{T as Xs}from"./TableChart-D45bq3z_.js";import{R as Zs,a as lt}from"./RadioGroup-CCDX_KZC.js";import{M as Qs}from"./Map-BEAgR921.js";import{T as en}from"./AccessTime-DthaaYGB.js";import{L as tn}from"./LocalFireDepartment-BGQpmkVF.js";import{S as sn}from"./Security-CPdCwCGC.js";import{C as nn}from"./CardActions-Dmj8qFNg.js";import{B as rn}from"./Badge-CF68QlvM.js";import{S as on,a as an,b as ln}from"./Stepper-BK4thnXd.js";import"./dividerClasses-BOzpvkur.js";import"./Popper-gu2nCNXY.js";function cn(t){return Es("MuiAlertTitle",t)}Ss("MuiAlertTitle",["root"]);const dn=t=>{const{classes:r}=t;return Ds({root:["root"]},cn,r)},un=ft(f,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(t,r)=>r.root})(As(({theme:t})=>({fontWeight:t.typography.fontWeightMedium,marginTop:-2}))),pn=M.forwardRef(function(r,n){const s=Cs({props:r,name:"MuiAlertTitle"}),{className:a,...o}=s,l=s,p=dn(l);return e.jsx(un,{gutterBottom:!0,component:"div",ownerState:l,ref:n,className:Fs(p.root,a),...o})}),Mt=pe(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}));var ct={exports:{}};/* @license
Papa Parse
v5.5.3
https://github.com/mholt/PapaParse
License: MIT
*/var mn=ct.exports,Vt;function hn(){return Vt||(Vt=1,function(t,r){((n,s)=>{t.exports=s()})(mn,function n(){var s=typeof self<"u"?self:typeof window<"u"?window:s!==void 0?s:{},a,o=!s.document&&!!s.postMessage,l=s.IS_PAPA_WORKER||!1,p={},u=0,d={};function h(i){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(c){var y=G(c);y.chunkSize=parseInt(y.chunkSize),c.step||c.chunk||(y.chunkSize=null),this._handle=new w(y),(this._handle.streamer=this)._config=y}).call(this,i),this.parseChunk=function(c,y){var A=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<A){let E=this._config.newline;E||(P=this._config.quoteChar||'"',E=this._handle.guessLineEndings(c,P)),c=[...c.split(E).slice(A)].join(E)}this.isFirstChunk&&J(this._config.beforeFirstChunk)&&(P=this._config.beforeFirstChunk(c))!==void 0&&(c=P),this.isFirstChunk=!1,this._halted=!1;var A=this._partialLine+c,P=(this._partialLine="",this._handle.parse(A,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(c=P.meta.cursor,A=(this._finished||(this._partialLine=A.substring(c-this._baseIndex),this._baseIndex=c),P&&P.data&&(this._rowCount+=P.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),l)s.postMessage({results:P,workerId:d.WORKER_ID,finished:A});else if(J(this._config.chunk)&&!y){if(this._config.chunk(P,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=P=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(P.data),this._completeResults.errors=this._completeResults.errors.concat(P.errors),this._completeResults.meta=P.meta),this._completed||!A||!J(this._config.complete)||P&&P.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),A||P&&P.meta.paused||this._nextChunk(),P}this._halted=!0},this._sendError=function(c){J(this._config.error)?this._config.error(c):l&&this._config.error&&s.postMessage({workerId:d.WORKER_ID,error:c,finished:!1})}}function x(i){var c;(i=i||{}).chunkSize||(i.chunkSize=d.RemoteChunkSize),h.call(this,i),this._nextChunk=o?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(y){this._input=y,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(c=new XMLHttpRequest,this._config.withCredentials&&(c.withCredentials=this._config.withCredentials),o||(c.onload=X(this._chunkLoaded,this),c.onerror=X(this._chunkError,this)),c.open(this._config.downloadRequestBody?"POST":"GET",this._input,!o),this._config.downloadRequestHeaders){var y,A=this._config.downloadRequestHeaders;for(y in A)c.setRequestHeader(y,A[y])}var P;this._config.chunkSize&&(P=this._start+this._config.chunkSize-1,c.setRequestHeader("Range","bytes="+this._start+"-"+P));try{c.send(this._config.downloadRequestBody)}catch(E){this._chunkError(E.message)}o&&c.status===0&&this._chunkError()}},this._chunkLoaded=function(){c.readyState===4&&(c.status<200||400<=c.status?this._chunkError():(this._start+=this._config.chunkSize||c.responseText.length,this._finished=!this._config.chunkSize||this._start>=(y=>(y=y.getResponseHeader("Content-Range"))!==null?parseInt(y.substring(y.lastIndexOf("/")+1)):-1)(c),this.parseChunk(c.responseText)))},this._chunkError=function(y){y=c.statusText||y,this._sendError(new Error(y))}}function v(i){(i=i||{}).chunkSize||(i.chunkSize=d.LocalChunkSize),h.call(this,i);var c,y,A=typeof FileReader<"u";this.stream=function(P){this._input=P,y=P.slice||P.webkitSlice||P.mozSlice,A?((c=new FileReader).onload=X(this._chunkLoaded,this),c.onerror=X(this._chunkError,this)):c=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var P=this._input,E=(this._config.chunkSize&&(E=Math.min(this._start+this._config.chunkSize,this._input.size),P=y.call(P,this._start,E)),c.readAsText(P,this._config.encoding));A||this._chunkLoaded({target:{result:E}})},this._chunkLoaded=function(P){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(P.target.result)},this._chunkError=function(){this._sendError(c.error)}}function F(i){var c;h.call(this,i=i||{}),this.stream=function(y){return c=y,this._nextChunk()},this._nextChunk=function(){var y,A;if(!this._finished)return y=this._config.chunkSize,c=y?(A=c.substring(0,y),c.substring(y)):(A=c,""),this._finished=!c,this.parseChunk(A)}}function $(i){h.call(this,i=i||{});var c=[],y=!0,A=!1;this.pause=function(){h.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){h.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(P){this._input=P,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){A&&c.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),c.length?this.parseChunk(c.shift()):y=!0},this._streamData=X(function(P){try{c.push(typeof P=="string"?P:P.toString(this._config.encoding)),y&&(y=!1,this._checkIsFinished(),this.parseChunk(c.shift()))}catch(E){this._streamError(E)}},this),this._streamError=X(function(P){this._streamCleanUp(),this._sendError(P)},this),this._streamEnd=X(function(){this._streamCleanUp(),A=!0,this._streamData("")},this),this._streamCleanUp=X(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function w(i){var c,y,A,P,E=Math.pow(2,53),k=-E,ie=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,R=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,L=this,se=0,g=0,V=!1,O=!1,B=[],D={data:[],errors:[],meta:{}};function T(I){return i.skipEmptyLines==="greedy"?I.join("").trim()==="":I.length===1&&I[0].length===0}function S(){if(D&&A&&(H("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),A=!1),i.skipEmptyLines&&(D.data=D.data.filter(function(m){return!T(m)})),K()){let m=function(z,W){J(i.transformHeader)&&(z=i.transformHeader(z,W)),B.push(z)};if(D)if(Array.isArray(D.data[0])){for(var I=0;K()&&I<D.data.length;I++)D.data[I].forEach(m);D.data.splice(0,1)}else D.data.forEach(m)}function N(m,z){for(var W=i.header?{}:[],Z=0;Z<m.length;Z++){var ae=Z,ne=m[Z],ne=((Ee,ee)=>(me=>(i.dynamicTypingFunction&&i.dynamicTyping[me]===void 0&&(i.dynamicTyping[me]=i.dynamicTypingFunction(me)),(i.dynamicTyping[me]||i.dynamicTyping)===!0))(Ee)?ee==="true"||ee==="TRUE"||ee!=="false"&&ee!=="FALSE"&&((me=>{if(ie.test(me)&&(me=parseFloat(me),k<me&&me<E))return 1})(ee)?parseFloat(ee):R.test(ee)?new Date(ee):ee===""?null:ee):ee)(ae=i.header?Z>=B.length?"__parsed_extra":B[Z]:ae,ne=i.transform?i.transform(ne,ae):ne);ae==="__parsed_extra"?(W[ae]=W[ae]||[],W[ae].push(ne)):W[ae]=ne}return i.header&&(Z>B.length?H("FieldMismatch","TooManyFields","Too many fields: expected "+B.length+" fields but parsed "+Z,g+z):Z<B.length&&H("FieldMismatch","TooFewFields","Too few fields: expected "+B.length+" fields but parsed "+Z,g+z)),W}var b;D&&(i.header||i.dynamicTyping||i.transform)&&(b=1,!D.data.length||Array.isArray(D.data[0])?(D.data=D.data.map(N),b=D.data.length):D.data=N(D.data,0),i.header&&D.meta&&(D.meta.fields=B),g+=b)}function K(){return i.header&&B.length===0}function H(I,N,b,m){I={type:I,code:N,message:b},m!==void 0&&(I.row=m),D.errors.push(I)}J(i.step)&&(P=i.step,i.step=function(I){D=I,K()?S():(S(),D.data.length!==0&&(se+=I.data.length,i.preview&&se>i.preview?y.abort():(D.data=D.data[0],P(D,L))))}),this.parse=function(I,N,b){var m=i.quoteChar||'"',m=(i.newline||(i.newline=this.guessLineEndings(I,m)),A=!1,i.delimiter?J(i.delimiter)&&(i.delimiter=i.delimiter(I),D.meta.delimiter=i.delimiter):((m=((z,W,Z,ae,ne)=>{var Ee,ee,me,Se;ne=ne||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var te=0;te<ne.length;te++){for(var Q,ce=ne[te],ge=0,je=0,de=0,fe=(me=void 0,new _({comments:ae,delimiter:ce,newline:W,preview:10}).parse(z)),ve=0;ve<fe.data.length;ve++)Z&&T(fe.data[ve])?de++:(Q=fe.data[ve].length,je+=Q,me===void 0?me=Q:0<Q&&(ge+=Math.abs(Q-me),me=Q));0<fe.data.length&&(je/=fe.data.length-de),(ee===void 0||ge<=ee)&&(Se===void 0||Se<je)&&1.99<je&&(ee=ge,Ee=ce,Se=je)}return{successful:!!(i.delimiter=Ee),bestDelimiter:Ee}})(I,i.newline,i.skipEmptyLines,i.comments,i.delimitersToGuess)).successful?i.delimiter=m.bestDelimiter:(A=!0,i.delimiter=d.DefaultDelimiter),D.meta.delimiter=i.delimiter),G(i));return i.preview&&i.header&&m.preview++,c=I,y=new _(m),D=y.parse(c,N,b),S(),V?{meta:{paused:!0}}:D||{meta:{paused:!1}}},this.paused=function(){return V},this.pause=function(){V=!0,y.abort(),c=J(i.chunk)?"":c.substring(y.getCharIndex())},this.resume=function(){L.streamer._halted?(V=!1,L.streamer.parseChunk(c,!0)):setTimeout(L.resume,3)},this.aborted=function(){return O},this.abort=function(){O=!0,y.abort(),D.meta.aborted=!0,J(i.complete)&&i.complete(D),c=""},this.guessLineEndings=function(z,m){z=z.substring(0,1048576);var m=new RegExp(Y(m)+"([^]*?)"+Y(m),"gm"),b=(z=z.replace(m,"")).split("\r"),m=z.split(`
`),z=1<m.length&&m[0].length<b[0].length;if(b.length===1||z)return`
`;for(var W=0,Z=0;Z<b.length;Z++)b[Z][0]===`
`&&W++;return W>=b.length/2?`\r
`:"\r"}}function Y(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function _(i){var c=(i=i||{}).delimiter,y=i.newline,A=i.comments,P=i.step,E=i.preview,k=i.fastMode,ie=null,R=!1,L=i.quoteChar==null?'"':i.quoteChar,se=L;if(i.escapeChar!==void 0&&(se=i.escapeChar),(typeof c!="string"||-1<d.BAD_DELIMITERS.indexOf(c))&&(c=","),A===c)throw new Error("Comment character same as delimiter");A===!0?A="#":(typeof A!="string"||-1<d.BAD_DELIMITERS.indexOf(A))&&(A=!1),y!==`
`&&y!=="\r"&&y!==`\r
`&&(y=`
`);var g=0,V=!1;this.parse=function(O,B,D){if(typeof O!="string")throw new Error("Input must be a string");var T=O.length,S=c.length,K=y.length,H=A.length,I=J(P),N=[],b=[],m=[],z=g=0;if(!O)return ge();if(k||k!==!1&&O.indexOf(L)===-1){for(var W=O.split(y),Z=0;Z<W.length;Z++){if(m=W[Z],g+=m.length,Z!==W.length-1)g+=y.length;else if(D)return ge();if(!A||m.substring(0,H)!==A){if(I){if(N=[],Se(m.split(c)),je(),V)return ge()}else Se(m.split(c));if(E&&E<=Z)return N=N.slice(0,E),ge(!0)}}return ge()}for(var ae=O.indexOf(c,g),ne=O.indexOf(y,g),Ee=new RegExp(Y(se)+Y(L),"g"),ee=O.indexOf(L,g);;)if(O[g]===L)for(ee=g,g++;;){if((ee=O.indexOf(L,ee+1))===-1)return D||b.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:N.length,index:g}),Q();if(ee===T-1)return Q(O.substring(g,ee).replace(Ee,L));if(L===se&&O[ee+1]===se)ee++;else if(L===se||ee===0||O[ee-1]!==se){ae!==-1&&ae<ee+1&&(ae=O.indexOf(c,ee+1));var me=te((ne=ne!==-1&&ne<ee+1?O.indexOf(y,ee+1):ne)===-1?ae:Math.min(ae,ne));if(O.substr(ee+1+me,S)===c){m.push(O.substring(g,ee).replace(Ee,L)),O[g=ee+1+me+S]!==L&&(ee=O.indexOf(L,g)),ae=O.indexOf(c,g),ne=O.indexOf(y,g);break}if(me=te(ne),O.substring(ee+1+me,ee+1+me+K)===y){if(m.push(O.substring(g,ee).replace(Ee,L)),ce(ee+1+me+K),ae=O.indexOf(c,g),ee=O.indexOf(L,g),I&&(je(),V))return ge();if(E&&N.length>=E)return ge(!0);break}b.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:N.length,index:g}),ee++}}else if(A&&m.length===0&&O.substring(g,g+H)===A){if(ne===-1)return ge();g=ne+K,ne=O.indexOf(y,g),ae=O.indexOf(c,g)}else if(ae!==-1&&(ae<ne||ne===-1))m.push(O.substring(g,ae)),g=ae+S,ae=O.indexOf(c,g);else{if(ne===-1)break;if(m.push(O.substring(g,ne)),ce(ne+K),I&&(je(),V))return ge();if(E&&N.length>=E)return ge(!0)}return Q();function Se(de){N.push(de),z=g}function te(de){var fe=0;return fe=de!==-1&&(de=O.substring(ee+1,de))&&de.trim()===""?de.length:fe}function Q(de){return D||(de===void 0&&(de=O.substring(g)),m.push(de),g=T,Se(m),I&&je()),ge()}function ce(de){g=de,Se(m),m=[],ne=O.indexOf(y,g)}function ge(de){if(i.header&&!B&&N.length&&!R){var fe=N[0],ve=Object.create(null),Tt=new Set(fe);let Pt=!1;for(let Ge=0;Ge<fe.length;Ge++){let we=fe[Ge];if(ve[we=J(i.transformHeader)?i.transformHeader(we,Ge):we]){let et,kt=ve[we];for(;et=we+"_"+kt,kt++,Tt.has(et););Tt.add(et),fe[Ge]=et,ve[we]++,Pt=!0,(ie=ie===null?{}:ie)[et]=we}else ve[we]=1,fe[Ge]=we;Tt.add(we)}Pt&&console.warn("Duplicate headers found and renamed."),R=!0}return{data:N,errors:b,meta:{delimiter:c,linebreak:y,aborted:V,truncated:!!de,cursor:z+(B||0),renamedHeaders:ie}}}function je(){P(ge()),N=[],b=[]}},this.abort=function(){V=!0},this.getCharIndex=function(){return g}}function q(i){var c=i.data,y=p[c.workerId],A=!1;if(c.error)y.userError(c.error,c.file);else if(c.results&&c.results.data){var P={abort:function(){A=!0,U(c.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:C,resume:C};if(J(y.userStep)){for(var E=0;E<c.results.data.length&&(y.userStep({data:c.results.data[E],errors:c.results.errors,meta:c.results.meta},P),!A);E++);delete c.results}else J(y.userChunk)&&(y.userChunk(c.results,P,c.file),delete c.results)}c.finished&&!A&&U(c.workerId,c.results)}function U(i,c){var y=p[i];J(y.userComplete)&&y.userComplete(c),y.terminate(),delete p[i]}function C(){throw new Error("Not implemented.")}function G(i){if(typeof i!="object"||i===null)return i;var c,y=Array.isArray(i)?[]:{};for(c in i)y[c]=G(i[c]);return y}function X(i,c){return function(){i.apply(c,arguments)}}function J(i){return typeof i=="function"}return d.parse=function(i,c){var y=(c=c||{}).dynamicTyping||!1;if(J(y)&&(c.dynamicTypingFunction=y,y={}),c.dynamicTyping=y,c.transform=!!J(c.transform)&&c.transform,!c.worker||!d.WORKERS_SUPPORTED)return y=null,d.NODE_STREAM_INPUT,typeof i=="string"?(i=(A=>A.charCodeAt(0)!==65279?A:A.slice(1))(i),y=new(c.download?x:F)(c)):i.readable===!0&&J(i.read)&&J(i.on)?y=new $(c):(s.File&&i instanceof File||i instanceof Object)&&(y=new v(c)),y.stream(i);(y=(()=>{var A;return!!d.WORKERS_SUPPORTED&&(A=(()=>{var P=s.URL||s.webkitURL||null,E=n.toString();return d.BLOB_URL||(d.BLOB_URL=P.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",E,")();"],{type:"text/javascript"})))})(),(A=new s.Worker(A)).onmessage=q,A.id=u++,p[A.id]=A)})()).userStep=c.step,y.userChunk=c.chunk,y.userComplete=c.complete,y.userError=c.error,c.step=J(c.step),c.chunk=J(c.chunk),c.complete=J(c.complete),c.error=J(c.error),delete c.worker,y.postMessage({input:i,config:c,workerId:y.id})},d.unparse=function(i,c){var y=!1,A=!0,P=",",E=`\r
`,k='"',ie=k+k,R=!1,L=null,se=!1,g=((()=>{if(typeof c=="object"){if(typeof c.delimiter!="string"||d.BAD_DELIMITERS.filter(function(B){return c.delimiter.indexOf(B)!==-1}).length||(P=c.delimiter),typeof c.quotes!="boolean"&&typeof c.quotes!="function"&&!Array.isArray(c.quotes)||(y=c.quotes),typeof c.skipEmptyLines!="boolean"&&typeof c.skipEmptyLines!="string"||(R=c.skipEmptyLines),typeof c.newline=="string"&&(E=c.newline),typeof c.quoteChar=="string"&&(k=c.quoteChar),typeof c.header=="boolean"&&(A=c.header),Array.isArray(c.columns)){if(c.columns.length===0)throw new Error("Option columns is empty");L=c.columns}c.escapeChar!==void 0&&(ie=c.escapeChar+k),c.escapeFormulae instanceof RegExp?se=c.escapeFormulae:typeof c.escapeFormulae=="boolean"&&c.escapeFormulae&&(se=/^[=+\-@\t\r].*$/)}})(),new RegExp(Y(k),"g"));if(typeof i=="string"&&(i=JSON.parse(i)),Array.isArray(i)){if(!i.length||Array.isArray(i[0]))return V(null,i,R);if(typeof i[0]=="object")return V(L||Object.keys(i[0]),i,R)}else if(typeof i=="object")return typeof i.data=="string"&&(i.data=JSON.parse(i.data)),Array.isArray(i.data)&&(i.fields||(i.fields=i.meta&&i.meta.fields||L),i.fields||(i.fields=Array.isArray(i.data[0])?i.fields:typeof i.data[0]=="object"?Object.keys(i.data[0]):[]),Array.isArray(i.data[0])||typeof i.data[0]=="object"||(i.data=[i.data])),V(i.fields||[],i.data||[],R);throw new Error("Unable to serialize unrecognized input");function V(B,D,T){var S="",K=(typeof B=="string"&&(B=JSON.parse(B)),typeof D=="string"&&(D=JSON.parse(D)),Array.isArray(B)&&0<B.length),H=!Array.isArray(D[0]);if(K&&A){for(var I=0;I<B.length;I++)0<I&&(S+=P),S+=O(B[I],I);0<D.length&&(S+=E)}for(var N=0;N<D.length;N++){var b=(K?B:D[N]).length,m=!1,z=K?Object.keys(D[N]).length===0:D[N].length===0;if(T&&!K&&(m=T==="greedy"?D[N].join("").trim()==="":D[N].length===1&&D[N][0].length===0),T==="greedy"&&K){for(var W=[],Z=0;Z<b;Z++){var ae=H?B[Z]:Z;W.push(D[N][ae])}m=W.join("").trim()===""}if(!m){for(var ne=0;ne<b;ne++){0<ne&&!z&&(S+=P);var Ee=K&&H?B[ne]:ne;S+=O(D[N][Ee],ne)}N<D.length-1&&(!T||0<b&&!z)&&(S+=E)}}return S}function O(B,D){var T,S;return B==null?"":B.constructor===Date?JSON.stringify(B).slice(1,25):(S=!1,se&&typeof B=="string"&&se.test(B)&&(B="'"+B,S=!0),T=B.toString().replace(g,ie),(S=S||y===!0||typeof y=="function"&&y(B,D)||Array.isArray(y)&&y[D]||((K,H)=>{for(var I=0;I<H.length;I++)if(-1<K.indexOf(H[I]))return!0;return!1})(T,d.BAD_DELIMITERS)||-1<T.indexOf(P)||T.charAt(0)===" "||T.charAt(T.length-1)===" ")?k+T+k:T)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!o&&!!s.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=_,d.ParserHandle=w,d.NetworkStreamer=x,d.FileStreamer=v,d.StringStreamer=F,d.ReadableStreamStreamer=$,s.jQuery&&((a=s.jQuery).fn.parse=function(i){var c=i.config||{},y=[];return this.each(function(E){if(!(a(this).prop("tagName").toUpperCase()==="INPUT"&&a(this).attr("type").toLowerCase()==="file"&&s.FileReader)||!this.files||this.files.length===0)return!0;for(var k=0;k<this.files.length;k++)y.push({file:this.files[k],inputElem:this,instanceConfig:a.extend({},c)})}),A(),this;function A(){if(y.length===0)J(i.complete)&&i.complete();else{var E,k,ie,R,L=y[0];if(J(i.before)){var se=i.before(L.file,L.inputElem);if(typeof se=="object"){if(se.action==="abort")return E="AbortError",k=L.file,ie=L.inputElem,R=se.reason,void(J(i.error)&&i.error({name:E},k,ie,R));if(se.action==="skip")return void P();typeof se.config=="object"&&(L.instanceConfig=a.extend(L.instanceConfig,se.config))}else if(se==="skip")return void P()}var g=L.instanceConfig.complete;L.instanceConfig.complete=function(V){J(g)&&g(V,L.file,L.inputElem),P()},d.parse(L.file,L.instanceConfig)}}function P(){y.splice(0,1),A()}}),l&&(s.onmessage=function(i){i=i.data,d.WORKER_ID===void 0&&i&&(d.WORKER_ID=i.workerId),typeof i.input=="string"?s.postMessage({workerId:d.WORKER_ID,results:d.parse(i.input,i.config),finished:!0}):(s.File&&i.input instanceof File||i.input instanceof Object)&&(i=d.parse(i.input,i.config))&&s.postMessage({workerId:d.WORKER_ID,results:i,finished:!0})}),(x.prototype=Object.create(h.prototype)).constructor=x,(v.prototype=Object.create(h.prototype)).constructor=v,(F.prototype=Object.create(F.prototype)).constructor=F,($.prototype=Object.create(h.prototype)).constructor=$,d})}(ct)),ct.exports}var gn=hn();const fn=Is(gn),xn=async(t,r)=>{switch(r){case"csv":return yn(t);case"excel":return bn(t);case"json":return jn(t);case"xml":return Tn(t);case"pdf":return vn(t);case"txt":return En(t);default:throw new Error(`Unsupported file type: ${r}`)}},yn=t=>new Promise((r,n)=>{fn.parse(t,{header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:s=>{const a=s.meta.fields||[],o=s.data;r({columns:a,data:o.slice(0,100)})},error:s=>{n(new Error(`Error parsing CSV: ${s.message}`))}})}),bn=t=>new Promise((r,n)=>{const s=new FileReader;s.onload=async a=>{var o;try{const l=(o=a.target)==null?void 0:o.result;if(!l){n(new Error("Failed to read Excel file"));return}const p=await ss(()=>import("./xlsx-DkH2s96g.js"),[]),u=p.read(l,{type:"array"}),d=u.SheetNames[0],h=u.Sheets[d],x=p.utils.sheet_to_json(h,{header:1});if(x.length===0){n(new Error("Excel file is empty"));return}const v=x[0].map(String),F=x.slice(1).map($=>{const w={};return $.forEach((Y,_)=>{_<v.length&&(w[v[_]]=Y)}),w});r({columns:v,data:F.slice(0,100)})}catch(l){n(new Error(`Error parsing Excel file: ${l instanceof Error?l.message:"Unknown error"}`))}},s.onerror=()=>{n(new Error("Error reading Excel file"))},s.readAsArrayBuffer(t)}),jn=t=>new Promise((r,n)=>{const s=new FileReader;s.onload=a=>{var o;try{const l=(o=a.target)==null?void 0:o.result,p=JSON.parse(l);if(Array.isArray(p)){if(p.length===0){n(new Error("JSON file contains an empty array"));return}const u=Array.from(new Set(p.flatMap(d=>Object.keys(d))));r({columns:u,data:p.slice(0,100)})}else if(p&&typeof p=="object"){const u=Object.keys(p).find(d=>Array.isArray(p[d]));if(u&&p[u].length>0){const d=p[u],h=Array.from(new Set(d.flatMap(x=>Object.keys(x))));r({columns:h,data:d.slice(0,100)})}else{const d=Object.keys(p);r({columns:d,data:[p]})}}else n(new Error("JSON file format not recognized"))}catch(l){n(new Error(`Error parsing JSON file: ${l instanceof Error?l.message:"Invalid JSON"}`))}},s.onerror=()=>{n(new Error("Error reading JSON file"))},s.readAsText(t)}),Tn=t=>new Promise((r,n)=>{const s=new FileReader;s.onload=a=>{var o,l;try{const p=(o=a.target)==null?void 0:o.result,d=new DOMParser().parseFromString(p,"text/xml"),h=d.getElementsByTagName("*"),x=new Map;for(let U=0;U<h.length;U++){const C=h[U].tagName;x.set(C,(x.get(C)||0)+1)}const v=Array.from(x.entries()).filter(([U,C])=>C>1).map(([U])=>U).sort((U,C)=>(x.get(C)||0)-(x.get(U)||0));if(v.length===0){n(new Error("Could not identify repeating elements in XML"));return}const F=v[0],$=d.getElementsByTagName(F);if($.length===0){n(new Error(`No elements found with tag ${F}`));return}const w=$[0],_=Array.from(w.children).map(U=>U.tagName),q=[];for(let U=0;U<Math.min($.length,100);U++){const C=$[U],G={};for(const X of _){const J=((l=C.getElementsByTagName(X)[0])==null?void 0:l.textContent)||"";G[X]=J}q.push(G)}r({columns:_,data:q})}catch(p){n(new Error(`Error parsing XML file: ${p instanceof Error?p.message:"Invalid XML"}`))}},s.onerror=()=>{n(new Error("Error reading XML file"))},s.readAsText(t)}),vn=t=>new Promise((r,n)=>{const s=new FileReader;s.onload=async a=>{var o;try{if(!((o=a.target)==null?void 0:o.result)){n(new Error("Failed to read PDF file"));return}r({columns:["Information"],data:[{Information:"PDF files are not currently supported for direct parsing in the browser."},{Information:"Please convert your PDF to CSV, Excel, or JSON format for processing."},{Information:"Alternatively, copy and paste the data from your PDF into a text file."},{Information:`File name: ${t.name}`},{Information:`File size: ${(t.size/1024).toFixed(2)} KB`},{Information:"Supported formats: CSV, Excel (.xlsx, .xls), JSON, XML, TXT"}]})}catch(l){n(new Error(`Error processing PDF: ${l instanceof Error?l.message:"Unknown error"}`))}},s.onerror=()=>{n(new Error("Error reading PDF file"))},s.readAsArrayBuffer(t)}),En=t=>new Promise((r,n)=>{const s=new FileReader;s.onload=a=>{var o;try{const l=(o=a.target)==null?void 0:o.result;if(!l){n(new Error("Failed to read text file"));return}const p=l.split(`
`).map(x=>x.trim()).filter(x=>x.length>0);if(p.length===0){n(new Error("Text file is empty"));return}const u=[",","	","|",";"];let d="",h=0;for(const x of u){const v=p.slice(0,10).map(w=>w.split(x).length),F=v.reduce((w,Y)=>w+Y,0)/v.length;v.every(w=>Math.abs(w-F)<=1&&w>1)&&F>h&&(h=F,d=x)}if(d&&h>1){const x=p[0].split(d).map(F=>F.trim()),v=[];for(let F=1;F<Math.min(p.length,100);F++){const $=p[F].split(d).map(Y=>Y.trim()),w={};for(let Y=0;Y<x.length;Y++)w[x[Y]]=$[Y]||"";v.push(w)}r({columns:x,data:v})}else{const x=p.slice(0,100).map((v,F)=>({LineNumber:F+1,Text:v}));r({columns:["LineNumber","Text"],data:x})}}catch(l){n(new Error(`Error parsing text file: ${l instanceof Error?l.message:"Unknown error"}`))}},s.onerror=()=>{n(new Error("Error reading text file"))},s.readAsText(t)}),Sn=()=>{const t=at(),r=Be(s=>s.formatter.selectedTool),n=s=>{const a=s.target.value,o=Lt.find(l=>l.id===a);o&&t(ws(o))};return e.jsxs(j,{sx:{my:3},children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Select Target Tool"}),e.jsxs(he,{container:!0,spacing:2,children:[e.jsx(he,{size:{xs:12,md:6},children:e.jsxs(_e,{fullWidth:!0,children:[e.jsx($e,{id:"tool-select-label",children:"Tool"}),e.jsx(Re,{labelId:"tool-select-label",id:"tool-select",value:(r==null?void 0:r.id)||"",label:"Tool",onChange:n,children:Lt.map(s=>e.jsx(re,{value:s.id,children:s.name},s.id))})]})}),e.jsx(he,{size:12,children:r&&e.jsxs(ye,{variant:"outlined",sx:{p:2,mt:2,borderColor:"primary.light"},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:r.name}),e.jsx(f,{variant:"body2",paragraph:!0,children:r.description}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Required fields: ",r.requiredFields.map(s=>s.name).join(", ")]})]})})]})]})},Cn=()=>{const t=at(),r=M.useRef(null),{sourceColumns:n,selectedTool:s}=Be(U=>U.formatter),[a,o]=M.useState("csv"),[l,p]=M.useState(!1),[u,d]=M.useState(null),[h,x]=M.useState(null),v=U=>{o(U.target.value)},F=async U=>{var G;const C=(G=U.target.files)==null?void 0:G[0];if(C){x(C.name),p(!0),d(null);try{t(Ne("uploading"));const X={id:`file-${Date.now()}`,name:C.name,type:a,size:C.size,lastModified:C.lastModified},{columns:J,data:i}=await xn(C,a);t(_s(X)),t($s(J)),t(ns(i)),t(Ne("idle")),setTimeout(()=>{t(Le(1))},500)}catch(X){d(X instanceof Error?X.message:"Failed to parse file"),t(Ne("error"))}finally{p(!1)}}},$=()=>{var U;(U=r.current)==null||U.click()},w=U=>{var G;U.preventDefault(),U.stopPropagation();const C=(G=U.dataTransfer.files)==null?void 0:G[0];if(C&&r.current){const X=new DataTransfer;X.items.add(C),r.current.files=X.files,F({target:{files:X.files}})}},Y=U=>{U.preventDefault(),U.stopPropagation()},_=()=>{t(Le(1))},q=n.length>0&&s!==null;return e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(f,{variant:"h5",gutterBottom:!0,children:"Upload Data File"}),e.jsx(f,{variant:"body1",paragraph:!0,children:"Select a file to upload. The formatter supports CSV, Excel (.xlsx, .xls, .xlsm), PDF, JSON, XML, and plain text files."}),e.jsxs(he,{container:!0,spacing:3,children:[e.jsx(he,{size:{xs:12,md:4},children:e.jsxs(_e,{fullWidth:!0,children:[e.jsx($e,{id:"file-type-select-label",children:"File Type"}),e.jsxs(Re,{labelId:"file-type-select-label",id:"file-type-select",value:a,label:"File Type",onChange:v,children:[e.jsx(re,{value:"csv",children:"CSV"}),e.jsx(re,{value:"excel",children:"Excel (.xlsx/.xls/.xlsm)"}),e.jsx(re,{value:"json",children:"JSON"}),e.jsx(re,{value:"xml",children:"XML"}),e.jsx(re,{value:"pdf",children:"PDF"}),e.jsx(re,{value:"txt",children:"Text File"})]})]})}),e.jsxs(he,{size:12,children:[e.jsx("input",{type:"file",ref:r,onChange:F,style:{display:"none"},accept:a==="csv"?".csv":a==="excel"?".xlsx,.xls,.xlsm":a==="json"?".json":a==="xml"?".xml":a==="pdf"?".pdf":a==="txt"?".txt":void 0}),e.jsx(ye,{elevation:0,onDrop:w,onDragOver:Y,sx:{border:"2px dashed #ccc",borderRadius:2,p:3,textAlign:"center",cursor:"pointer",bgcolor:"#f8f9fa","&:hover":{borderColor:"primary.main"}},onClick:$,children:l?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(Ue,{}),e.jsx(f,{variant:"body1",sx:{mt:2},children:"Processing file..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(zt,{fontSize:"large",color:"primary"}),e.jsx(f,{variant:"h6",sx:{mt:2},children:h?`Selected: ${h}`:"Drag & drop file here or click to browse"}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Supports ",a==="csv"?"CSV":a==="excel"?"Excel (.xlsx, .xls, .xlsm)":a==="json"?"JSON":a==="xml"?"XML":a==="pdf"?"PDF":"Text"," files"]})]})}),u&&e.jsx(ue,{severity:"error",sx:{mt:2},children:u}),h&&!l&&!u&&e.jsxs(ue,{severity:"success",sx:{mt:2},children:["File selected: ",h]})]}),e.jsx(he,{size:12,sx:{mt:2,display:"flex",justifyContent:"center"},children:e.jsx(oe,{variant:"contained",size:"large",onClick:$,startIcon:e.jsx(zt,{}),disabled:l,children:"Browse Files"})})]}),e.jsx(be,{sx:{my:4}}),e.jsx(Sn,{}),e.jsx(j,{sx:{display:"flex",justifyContent:"flex-end",mt:4},children:e.jsx(oe,{variant:"contained",size:"large",endIcon:e.jsx(Mt,{}),onClick:_,disabled:!q,children:"Continue to Field Mapping"})}),!q&&e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mt:2,textAlign:"right"},children:n.length?"Select a target tool to continue":"Upload a file to continue"})]})},Bt=t=>["dispatch_time","enroute_time","arrival_time","clear_time"].includes(t),St=t=>["incident_date"].includes(t),Fn=t=>{if(!t||typeof t!="string")return t;const r=[/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2})$/,/^.+\s+(\d{1,2}:\d{2}(?::\d{2})?)$/];for(const s of r){const a=t.match(s);if(a&&a[1])return a[1]}return/^\d{1,2}:\d{2}(?::\d{2})?$/.test(t.trim())?t.trim():t},Dn=t=>{if(console.log(`🔍 DATE EXTRACTION: Input "${t}" (type: ${typeof t})`),!t||typeof t!="string")return console.log("🔍 DATE EXTRACTION: Invalid input, returning original"),t;const r=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^(\d{4}-\d{2}-\d{2})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^([^\\s]+)\s+\d{1,2}:\d{2}(?::\d{2})?$/];for(let s=0;s<r.length;s++){const a=r[s],o=t.match(a);if(console.log(`🔍 Pattern ${s+1} test: "${t}" → ${o?`MATCH: "${o[1]}"`:"NO MATCH"}`),o&&o[1])return console.log(`🔍 DATE EXTRACTION SUCCESS: "${t}" → "${o[1]}"`),o[1]}const n=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const s of n)if(s.test(t.trim()))return t.trim();return t},gs=(t,r)=>!t||!t.length||!r||!r.length?[]:t.map(n=>{const s={},a=new Set;return r.forEach(o=>{const{sourceField:l,targetField:p,transformations:u}=o;let d;if(l==="__default__"&&u&&u.length>0){const h=u.find(x=>x.type==="convert"&&x.params.defaultValue);h?(console.log(`Using default value for ${p}:`,h.params.defaultValue),d=h.params.defaultValue):(console.log(`No default value found for ${p}, using null`),d=null)}else if(l.includes("_")&&l.split("_").length>=2){const[h,...x]=l.split("_"),v=x.join("_"),F=[`${h}_parsed_${v}`,`${h}_parsed_${p}`,l];console.log(`🤖 DEBUG: Looking for parsed data with sourceField: "${l}"`),console.log("🤖 DEBUG: Trying keys:",F),console.log("🤖 DEBUG: Available row keys:",Object.keys(n));let $=!1;for(const w of F)if(n[w]!==void 0&&n[w]!==null){d=n[w],console.log(`🤖 ✅ Using PARSED value for ${p} from key "${w}": "${d}"`),$=!0;break}else console.log(`🤖 ❌ No data found at key: "${w}"`);$||(d=n[l],console.log(`🤖 ⚠️ No parsed data found, using source value for ${p} from ${l}:`,d))}else d=n[l],console.log(`Using source value for ${p} from ${l}:`,d);if(u&&u.length>0){console.log(`Applying ${u.length} transformations to ${p}:`,u);const h=d;d=An(d,u,p,n),console.log(`Transformation result for ${p}:`,h,"→",d)}if(p==="incident_type"&&d!==null&&d!==void 0&&(typeof d=="number"?(console.log(`🔢 Converting numeric incident_type to string: ${d} → "${String(d)}"`),d=String(d)):typeof d!="string"&&(console.log(`🔄 Converting incident_type to string: ${d} (${typeof d}) → "${String(d)}"`),d=String(d))),console.log(`🔧 CHECKING FIELD: ${p}, isTimeOnly: ${Bt(p)}, isDateOnly: ${St(p)}, value type: ${typeof d}`),d&&typeof d=="string")if(Bt(p)){const h=Fn(d);h!==d?(console.log(`🕒 Auto-extracted time for ${p}: "${d}" → "${h}"`),d=h):console.log(`🕒 No time extraction needed for ${p}: "${d}"`)}else if(St(p)){console.log(`📅 ATTEMPTING DATE EXTRACTION for ${p}: Input value "${d}"`);const h=Dn(d);console.log(`📅 DATE EXTRACTION RESULT: "${d}" → "${h}" (changed: ${h!==d})`),h!==d?(console.log(`📅 ✅ Auto-extracted date for ${p}: "${d}" → "${h}"`),d=h):console.log(`📅 ❌ No date extraction needed for ${p}: "${d}"`)}else p==="incident_time"&&console.log(`🕒 Keeping full datetime for ${p}: "${d}"`);if(s[p]=d,l!==p&&l!=="__default__"&&!a.has(l)&&!l.includes("_parsed_")){if(r.some(x=>x.targetField===l))console.log(`🚫 SKIPPING PRESERVATION: "${l}" is also a target field - keeping transformed value`);else{let x=d;St(p)&&n[l]&&typeof n[l]=="string"&&n[l].includes(" ")&&(x=n[l],console.log(`📅 PRESERVING FULL DATETIME for original field "${l}": "${x}" (target "${p}" gets date-only: "${d}")`)),s[l]=x,console.log(`🔄 PRESERVED ORIGINAL FIELD NAME: "${l}" → "${x}" (also mapped to ${p})`)}a.add(l)}else l.includes("_parsed_")&&console.log(`🤖 SKIPPING PARSED FIELD PRESERVATION: "${l}" (parsed field injection key)`)}),Object.keys(s).forEach(o=>{o.includes("_parsed_")&&(console.log(`🧹 CLEANUP: Removing parsed field injection key "${o}" from transformed data`),delete s[o])}),s}),An=(t,r,n,s)=>r.reduce((a,o)=>fs(a,o,n,s),t),fs=(t,r,n,s)=>{const{type:a,params:o}=r,l={...o,...n&&{fieldName:n},...s&&{rowData:s}};switch(a){case"split":return _n(t,l);case"join":return $n(t,l);case"format":return Rn(t,l);case"convert":return On(t,l);case"extract":return In(t,l);case"replace":return wn(t,l);case"datetime_combine":return Nn(t,l);case"datetime_extract":return Mn(t,l);case"parseCoordinates":return Pn(t,l);default:return t}},In=(t,r)=>{if(typeof t!="string")return t;const{pattern:n}=r;try{const s=new RegExp(n),a=t.match(s);if(a&&a.length>0)return a[1]||a[0]}catch{console.error("Invalid regex pattern:",n)}return t},wn=(t,r)=>{if(typeof t!="string")return t;const{from:n,to:s="",useRegex:a=!1}=r;if(!n)return t;try{if(a){const o=new RegExp(n,"g");return t.replace(o,s)}else return t.replace(new RegExp(n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),s)}catch(o){return console.error("Error in replace transformation:",o),t}},_n=(t,r)=>{if(typeof t!="string")return t;const{delimiter:n,index:s}=r,a=t.split(n);return s!==void 0?a[s]||"":a},$n=(t,r)=>{if(!Array.isArray(t))return t;const{delimiter:n=", "}=r;return t.join(n)},Rn=(t,r)=>{const{format:n,type:s,fieldName:a}=r;if(console.log("applyFormatTransformation called with:",{value:t,format:n,type:s,fieldName:a}),s==="date"&&t)try{const o=new Date(t);if(isNaN(o.getTime()))return t;switch(n){case"MM/DD/YYYY":return`${o.getMonth()+1}/${o.getDate()}/${o.getFullYear()}`;case"YYYY-MM-DD":return`${o.getFullYear()}-${(o.getMonth()+1).toString().padStart(2,"0")}-${o.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${o.getDate()}/${o.getMonth()+1}/${o.getFullYear()}`;case"date-only":return o.toLocaleDateString();case"custom":return(r.customFormat||"YYYY-MM-DD").replace("YYYY",o.getFullYear().toString()).replace("MM",(o.getMonth()+1).toString().padStart(2,"0")).replace("DD",o.getDate().toString().padStart(2,"0")).replace("HH",o.getHours().toString().padStart(2,"0")).replace("mm",o.getMinutes().toString().padStart(2,"0")).replace("ss",o.getSeconds().toString().padStart(2,"0"));case"ISO":return o.toISOString();default:return t}}catch{return t}if(s==="number"&&t!==void 0&&t!==null)try{const o=Number(t);if(isNaN(o))return t;switch(n){case"integer":return Math.round(o);case"fixed2":return o.toFixed(2);case"currency":return`$${o.toFixed(2)}`;case"percent":return`${(o*100).toFixed(1)}%`;default:return t}}catch{return t}return t},On=(t,r)=>{const{targetType:n}=r;switch(n){case"string":return t!=null?String(t):"";case"number":if(t==null||t==="")return null;const s=Number(t);return isNaN(s)?t:s;case"boolean":return typeof t=="string"?["true","yes","1","y"].includes(t.toLowerCase()):!!t;case"date":if(!t)return null;try{const a=new Date(t);return isNaN(a.getTime())?t:a}catch{return t}default:return t}},Nn=(t,r)=>{const{sourceFields:n,description:s,rowData:a}=r;if(console.log("🕐 DATETIME COMBINE: Starting transformation"),console.log("🕐 Source fields:",n),console.log("🕐 Primary value:",t),console.log("🕐 Description:",s),!n||n.length<2)return console.log("⚠️ DATETIME COMBINE: Need at least 2 source fields"),t;if(!a)return console.log("⚠️ DATETIME COMBINE: No row data provided for field combination"),t;const[o,l]=n,p=String(a[o]||"").trim(),u=String(a[l]||"").trim();if(console.log(`🕐 Date field "${o}":`,p),console.log(`🕐 Time field "${l}":`,u),!p||!u)return console.log("⚠️ DATETIME COMBINE: Missing date or time component"),t;const d=`${p} ${u}`;return console.log("✅ DATETIME COMBINE: Result:",d),d},Mn=(t,r)=>{const{extractType:n,description:s}=r;if(console.log("🕐 DATETIME EXTRACT: Starting transformation"),console.log("🕐 Extract type:",n),console.log("🕐 Input value:",t),console.log("🕐 Description:",s),!t||typeof t!="string")return console.log("⚠️ DATETIME EXTRACT: Invalid input value"),t;const a=t.trim();if(n==="date"){const o=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+/,/^(\d{4}-\d{2}-\d{2})\s+/];for(const p of o){const u=a.match(p);if(u){const d=u[1];return console.log("✅ DATETIME EXTRACT (date):",d),d}}const l=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const p of l)if(p.test(a))return console.log("✅ DATETIME EXTRACT (date): Already date-only format"),a}else if(n==="time"){const o=[/\s+(\d{1,2}:\d{2}:\d{2})$/,/\s+(\d{1,2}:\d{2})$/];for(const p of o){const u=a.match(p);if(u){const d=u[1];return console.log("✅ DATETIME EXTRACT (time):",d),d}}const l=[/^\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}:\d{2}$/];for(const p of l)if(p.test(a))return console.log("✅ DATETIME EXTRACT (time): Already time-only format"),a}return console.log("⚠️ DATETIME EXTRACT: No matching pattern found, returning original value"),t},Pn=(t,r)=>{if(!t||typeof t!="string")return console.log("🗺️ COORDINATE PARSE: Invalid input value:",t),t;const{format:n="point",component:s="longitude"}=r,a=t.toString().trim();console.log(`🗺️ COORDINATE PARSE: Parsing "${a}" with format "${n}", extracting "${s}"`);try{if(n==="point"){const o=a.match(/POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)/i);if(o){const l=parseFloat(o[1]),p=parseFloat(o[2]);switch(console.log(`🗺️ COORDINATE PARSE: Extracted longitude=${l}, latitude=${p}`),s){case"longitude":return l;case"latitude":return p;case"both":return`${l}, ${p}`;default:return console.log(`🗺️ COORDINATE PARSE: Unknown component "${s}", returning longitude`),l}}else return console.log("🗺️ COORDINATE PARSE: Invalid POINT format"),t}return console.log(`🗺️ COORDINATE PARSE: Unsupported format "${n}"`),t}catch(o){return console.error("🗺️ COORDINATE PARSE ERROR:",o),t}},kn=(t,r)=>{console.log("🕐 SMART DATETIME DETECTION: Starting analysis..."),console.log("🕐 Column names:",t);const n=r.find(l=>Object.keys(l).length>0)||{};console.log("🕐 Sample data keys:",Object.keys(n));const s=Ln(t,n);if(s.confidence>.7)return console.log("✅ DETECTED: Tyler CAD split datetime pattern"),{pattern:s,suggestedMappings:Vn(s)};const a=zn(t,n);if(a.confidence>.7)return console.log("✅ DETECTED: Hexagon/CentralSquare combined datetime pattern"),{pattern:a,suggestedMappings:Bn(a)};const o=Un(t,n);return o.confidence>.5?(console.log("✅ DETECTED: Volunteer department simple pattern"),{pattern:o,suggestedMappings:Gn(o)}):(console.log("⚠️ NO CLEAR DATETIME PATTERN DETECTED"),{pattern:{type:"unknown",confidence:0,description:"No clear datetime pattern detected - manual mapping required"},suggestedMappings:[]})},Ln=(t,r)=>{console.log("🔍 Testing split datetime pattern (Tyler CAD style)...");const n=[/^inc_date$/i,/^incident_date$/i,/^date$/i,/^call_date$/i,/^event_date$/i],s=[/^alarm_time$/i,/^call_time$/i,/^time$/i,/^incident_time$/i,/^receive_time$/i,/^dispatch_time$/i];let a,o,l=0;for(const p of t){for(const u of n)if(u.test(p)){a=p,l+=.3,console.log(`📅 Found potential date field: "${p}"`);break}if(a)break}for(const p of t){for(const u of s)if(u.test(p)){o=p,l+=.3,console.log(`⏰ Found potential time field: "${p}"`);break}if(o)break}if(a&&o&&r[a]&&r[o]){const p=String(r[a]),u=String(r[o]);console.log("🧪 Sample data validation:"),console.log(`  Date field "${a}": "${p}"`),console.log(`  Time field "${o}": "${u}"`);const h=/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(p.trim()),v=/^\d{1,2}:\d{2}(:\d{2})?$/.test(u.trim());h&&v?(l+=.4,console.log("✅ Data validation passed - date-only + time-only pattern confirmed")):(console.log("⚠️ Data validation failed - not clean date-only + time-only pattern"),console.log(`  Date-only check: ${h}, Time-only check: ${v}`))}return{type:"split",confidence:l,dateField:a,timeField:o,description:l>.7?`Split datetime pattern detected: "${a}" + "${o}" should be combined`:"Potential split pattern found but low confidence"}},zn=(t,r)=>{console.log("🔍 Testing combined datetime pattern (Hexagon/CentralSquare style)...");const n=[/^calldatetime$/i,/^call_datetime$/i,/^incident_datetime$/i,/^event_datetime$/i,/^call_received_date\/time$/i,/^call.*time$/i,/^received.*time$/i];let s,a=0;for(const o of t){for(const l of n)if(l.test(o)){s=o,a+=.4,console.log(`📅⏰ Found potential combined datetime field: "${o}"`);break}if(s)break}if(!s)for(const o of t){const l=r[o];if(l&&typeof l=="string"&&/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/.test(l.trim())){s=o,a+=.3,console.log(`📅⏰ Found combined datetime by content analysis: "${o}" = "${l}"`);break}}if(s&&r[s]){const o=String(r[s]);console.log(`🧪 Sample data validation for combined field "${s}": "${o}"`),[/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}$/,/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/].some(u=>u.test(o.trim()))?(a+=.4,console.log("✅ Data validation passed - full datetime pattern confirmed")):console.log("⚠️ Data validation failed - not a full datetime pattern")}return{type:"combined",confidence:a,combinedField:s,description:a>.7?`Combined datetime pattern detected: "${s}" contains full date and time`:"Potential combined pattern found but low confidence"}},Un=(t,r)=>{console.log("🔍 Testing simple datetime pattern (volunteer department style)...");const n=/^date$/i,s=/^time$/i,a=t.find(p=>n.test(p)),o=t.find(p=>s.test(p));let l=0;return a&&o&&(l+=.4,console.log(`📅 Found simple date field: "${a}"`),console.log(`⏰ Found simple time field: "${o}"`),r[a]&&r[o]&&(l+=.3,console.log("🧪 Sample data available for validation"))),{type:"simple",confidence:l,dateField:a,timeField:o,description:l>.5?`Simple datetime pattern detected: basic "${a}" + "${o}" fields`:"Simple pattern check completed - low confidence"}},Vn=t=>{const r=[];return t.dateField&&t.timeField&&(r.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine "${t.dateField}" + "${t.timeField}" into full datetime for incident time`}),r.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"extract",description:`Extract date from "${t.dateField}" for incident date`})),r},Bn=t=>{const r=[];return t.combinedField&&(r.push({sourceFields:[t.combinedField],targetField:"incident_time",transformationType:"direct",description:`Use "${t.combinedField}" directly for incident time`}),r.push({sourceFields:[t.combinedField],targetField:"incident_date",transformationType:"extract",description:`Extract date portion from "${t.combinedField}" for incident date`})),r},Gn=t=>{const r=[];return t.dateField&&t.timeField&&(r.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine simple "${t.dateField}" + "${t.timeField}" for incident time`}),r.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"direct",description:`Use "${t.dateField}" for incident date`})),r},Hn=pe(e.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"})),Gt=pe(e.jsx("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"})),Wn=pe(e.jsx("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"})),Yn=pe(e.jsx("path",{d:"M16.01 11H4v2h12.01v3L20 12l-3.99-4z"})),qn=pe(e.jsx("path",{d:"m19 9 1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25z"})),ot=pe(e.jsx("path",{d:"M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.996.996 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"})),Jn=pe(e.jsx("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"})),Kn=pe(e.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2m-9 14-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),xs=pe(e.jsx("path",{d:"M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),Xn=pe(e.jsx("path",{d:"M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6z"})),Zn=pe(e.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),_t=pe(e.jsx("path",{d:"M15 4v2h3v12h-3v2h5V4zM4 20h5v-2H6V6h3V4H4z"})),ys=pe(e.jsx("path",{d:"M4 7v2c0 .55-.45 1-1 1H2v4h1c.55 0 1 .45 1 1v2c0 1.65 1.35 3 3 3h3v-2H7c-.55 0-1-.45-1-1v-2c0-1.3-.84-2.42-2-2.83v-.34C5.16 11.42 6 10.3 6 9V7c0-.55.45-1 1-1h3V4H7C5.35 4 4 5.35 4 7m17 3c-.55 0-1-.45-1-1V7c0-1.65-1.35-3-3-3h-3v2h3c.55 0 1 .45 1 1v2c0 1.3.84 2.42 2 2.83v.34c-1.16.41-2 1.52-2 2.83v2c0 .55-.45 1-1 1h-3v2h3c1.65 0 3-1.35 3-3v-2c0-.55.45-1 1-1h1v-4z"})),ht=pe(e.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),Ht=pe(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2m0 12H4V8h16z"})),Qn=pe(e.jsx("path",{d:"M2 17h2v.5H3v1h1v.5H2v1h3v-4H2zm1-9h1V4H2v1h1zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2zm5-6v2h14V5zm0 14h14v-2H7zm0-6h14v-2H7z"})),$t=pe(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"})),Wt=pe(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),er=pe(e.jsx("path",{d:"m20.5 10 .5-2h-4l1-4h-2l-1 4h-4l1-4h-2L9 8H5l-.5 2h4l-1 4h-4L3 16h4l-1 4h2l1-4h4l-1 4h2l1-4h4l.5-2h-4l1-4zm-7 4h-4l1-4h4z"})),Yt=pe([e.jsx("path",{d:"M13 8.57c-.79 0-1.43.64-1.43 1.43s.64 1.43 1.43 1.43 1.43-.64 1.43-1.43-.64-1.43-1.43-1.43"},"0"),e.jsx("path",{d:"M13 3C9.25 3 6.2 5.94 6.02 9.64L4.1 12.2c-.25.33-.01.8.4.8H6v3c0 1.1.9 2 2 2h1v3h7v-4.68c2.36-1.12 4-3.53 4-6.32 0-3.87-3.13-7-7-7m3 7c0 .13-.01.26-.02.39l.83.66c.08.06.1.16.05.25l-.8 1.39c-.05.09-.16.12-.24.09l-.99-.4c-.21.16-.43.29-.67.39L14 13.83c-.01.1-.1.17-.2.17h-1.6c-.1 0-.18-.07-.2-.17l-.15-1.06c-.25-.1-.47-.23-.68-.39l-.99.4c-.09.03-.2 0-.25-.09l-.8-1.39c-.05-.08-.03-.19.05-.25l.84-.66c-.01-.13-.02-.26-.02-.39s.02-.27.04-.39l-.85-.66c-.08-.06-.1-.16-.05-.26l.8-1.38c.05-.09.15-.12.24-.09l1 .4c.2-.15.43-.29.67-.39L12 6.17c.02-.1.1-.17.2-.17h1.6c.1 0 .18.07.2.17l.15 1.06c.24.1.46.23.67.39l1-.4c.09-.03.2 0 .24.09l.8 1.38c.05.09.03.2-.05.26l-.85.66c.03.12.04.25.04.39"},"1")]),tr=pe(e.jsx("path",{d:"M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3m1-4.3h-2V7h2z"})),bs=pe(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),qt=pe(e.jsx("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3M7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5M16 17H8v-2h8zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13"})),sr=pe(e.jsx("path",{d:"m23 12-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69zm-12.91 4.72-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48z"})),nr=pe([e.jsx("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),e.jsx("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")]),Ct=[{id:"incident_type",name:"🔥 Incident Type",description:"Fire, medical, accident, alarm, etc.",pattern:/(fire|medical|ems|accident|mva|alarm|rescue|hazmat)/gi,enabled:!0},{id:"response_time",name:"⏱️ Response Time",description:'Time values like "30 min", "1:20", "half hour"',pattern:/(\d+)\s*(min|minutes|hour|hours|hr|hrs)|(\d{1,2}):(\d{2})|half.hour|quarter.hour/gi,enabled:!0},{id:"location",name:"📍 Location",description:"Addresses, street names, landmarks",pattern:/\d+\s+[\w\s]+(street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd)/gi,enabled:!1},{id:"date_time",name:"📅 Date/Time",description:'Dates like "12/04/25", "April 12", times',pattern:/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})|(\w+\s+\d{1,2})|(\d{1,2}:\d{2})/gi,enabled:!1},{id:"units_resources",name:"🚒 Units/Resources",description:"Fire trucks, ambulances, personnel count",pattern:/(engine|truck|ambulance|rescue|ladder|chief|\d+\s*(firefighter|personnel|crew))/gi,enabled:!1}],rr=({open:t,onClose:r,columnName:n,sampleData:s,onParse:a})=>{const[o,l]=M.useState(["incident_type","response_time"]),[p,u]=M.useState(!1),[d,h]=M.useState([]),[x,v]=M.useState(!1);M.useEffect(()=>{o.length>0&&s.length>0&&$()},[o,s]);const F=i=>{l(c=>c.includes(i)?c.filter(y=>y!==i):[...c,i])},$=async()=>{u(!0);try{await new Promise(c=>setTimeout(c,500));const i=s.slice(0,5).map((c,y)=>({rowIndex:y,originalText:c,parsedFields:w(c,o)}));h(i)}catch(i){console.error("Error generating preview:",i)}finally{u(!1)}},w=(i,c)=>{const y={};return c.forEach(A=>{const P=Ct.find(k=>k.id===A);if(!P)return;const E=i.match(P.pattern);if(E&&E.length>0){const k=E[0];console.log(`🔍 PARSING DEBUG - Field: ${A}, Pattern: ${P.pattern}, Text: "${i}", Match: "${k}"`),y[A]={value:Y(A,k),confidence:C(A,k),original:k}}}),y},Y=(i,c)=>{switch(i){case"incident_type":return _(c);case"response_time":return q(c);case"location":return U(c);default:return c}},_=i=>{const c=i.toLowerCase();return c.includes("fire")?"Structure Fire":c.includes("medical")||c.includes("ems")?"Medical Emergency":c.includes("accident")||c.includes("mva")?"Motor Vehicle Accident":c.includes("alarm")?"Alarm Response":i},q=i=>{const c=i.match(/(\d+)\s*(min|minutes|hour|hours|hr|hrs)/i);if(c){const A=parseInt(c[1]);return c[2].toLowerCase().startsWith("h")?`${A} hour${A!==1?"s":""}`:`${A} minute${A!==1?"s":""}`}const y=i.match(/(\d{1,2}):(\d{2})/);if(y){const A=parseInt(y[1]),P=parseInt(y[2]);return`${A}:${P.toString().padStart(2,"0")}`}return i},U=i=>i.replace(/\b\w/g,c=>c.toUpperCase()),C=(i,c,y)=>i==="response_time"&&c.match(/\d+\s*(min|minutes)/i)?.95:i==="incident_type"&&["fire","medical","accident"].includes(c.toLowerCase())?.9:.7,G=async()=>{if(o.length!==0){v(!0);try{await new Promise(c=>setTimeout(c,1e3));const i=s.map((c,y)=>({rowIndex:y,originalText:c,parsedFields:w(c,o)}));a(o,i),r()}catch(i){console.error("Error parsing narrative data:",i)}finally{v(!1)}}},X=()=>o.length,J=()=>d.filter(i=>Object.keys(i.parsedFields).length>0).length;return e.jsxs(Ke,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"70vh"}},children:[e.jsxs(Xe,{sx:{display:"flex",alignItems:"center",pb:1},children:[e.jsx(qt,{sx:{mr:1,color:"primary.main"}}),'Parse Narrative: "',n,'"']}),e.jsxs(Ze,{sx:{pb:1},children:[e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Extract structured data from narrative text using pattern matching and NLP. Select the fields you want to extract and preview the results."}),e.jsx(f,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"1. Select Fields to Extract"}),e.jsx(Vs,{sx:{mb:3},children:Ct.map(i=>e.jsx(We,{control:e.jsx(Us,{checked:o.includes(i.id),onChange:()=>F(i.id)}),label:e.jsxs(j,{children:[e.jsx(f,{variant:"body2",sx:{fontWeight:"medium"},children:i.name}),e.jsx(f,{variant:"caption",color:"text.secondary",children:i.description})]})},i.id))}),e.jsx(be,{sx:{my:2}}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(f,{variant:"h6",sx:{flexGrow:1},children:"2. Preview Results"}),p&&e.jsx(Ue,{size:20,sx:{ml:2}})]}),o.length===0?e.jsx(ue,{severity:"info",sx:{mb:2},children:"Select at least one field to see preview results."}):e.jsxs(e.Fragment,{children:[e.jsxs(j,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(le,{label:`${X()} fields selected`,size:"small",color:"primary"}),e.jsx(le,{label:`${J()}/${d.length} rows with data`,size:"small",color:"success"})]}),e.jsxs(dt,{size:"small",sx:{mb:2},children:[e.jsx(ut,{children:e.jsxs(Pe,{children:[e.jsx(Ce,{children:"Original Text"}),o.map(i=>{const c=Ct.find(y=>y.id===i);return e.jsx(Ce,{children:c==null?void 0:c.name},i)})]})}),e.jsx(pt,{children:d.map((i,c)=>e.jsxs(Pe,{children:[e.jsx(Ce,{sx:{maxWidth:200},children:e.jsx(f,{variant:"body2",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i.originalText})}),o.map(y=>e.jsx(Ce,{children:i.parsedFields[y]?e.jsxs(j,{children:[e.jsx(f,{variant:"body2",children:i.parsedFields[y].value}),e.jsxs(f,{variant:"caption",color:"success.main",children:[Math.round(i.parsedFields[y].confidence*100),"% confident"]})]}):e.jsx(f,{variant:"caption",color:"text.secondary",children:"No match"})},y))]},c))})]}),e.jsx(ue,{severity:"info",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Preview shows first 5 rows."})," Parsing accuracy is typically 70-85%. You can edit any incorrect values after parsing."]})})]})]}),e.jsxs(Qe,{sx:{p:3,pt:1},children:[e.jsx(oe,{onClick:r,children:"Cancel"}),e.jsx(oe,{variant:"contained",onClick:G,disabled:o.length===0||x,startIcon:x?e.jsx(Ue,{size:20}):e.jsx(qt,{}),children:x?"Parsing...":`Parse ${n}`})]})]})},or=({columnName:t,onClick:r,variant:n="icon",size:s="small",disabled:a=!1})=>{const o=()=>{r(t)};return n==="button"?e.jsx(oe,{size:s,startIcon:e.jsx(ot,{}),onClick:o,disabled:a,sx:{minWidth:"auto",textTransform:"none",color:"primary.main","&:hover":{backgroundColor:"primary.50"}},children:"Parse"}):e.jsx(ze,{title:`Parse narrative text in "${t}" column`,children:e.jsx("span",{children:e.jsx(Ae,{size:s,onClick:o,disabled:a,sx:{color:"primary.main","&:hover":{backgroundColor:"primary.50",transform:"scale(1.1)"},transition:"all 0.2s ease-in-out"},children:e.jsx(ot,{fontSize:s})})})})},ar=({parsedFields:t,onFieldDragStart:r,onDeleteParsedField:n})=>{if(t.length===0)return null;const s=o=>o>=.9?"success":o>=.7?"warning":"error",a=o=>o>=.9?"High confidence":o>=.7?"Medium confidence":"Low confidence";return e.jsxs(j,{sx:{mt:1,ml:2},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(Yt,{sx:{fontSize:16,color:"primary.main",mr:.5}}),e.jsx(f,{variant:"caption",color:"primary.main",sx:{fontWeight:"medium"},children:"Parsed Fields"})]}),e.jsx(st,{spacing:.5,children:t.map(o=>e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(le,{label:o.name,size:"small",color:"secondary",variant:"outlined",draggable:!0,onDragStart:l=>{l.stopPropagation(),r(l,o.id)},sx:{cursor:"grab","&:active":{cursor:"grabbing"},"&:hover":{backgroundColor:"secondary.50"}},icon:e.jsx(Yt,{})}),e.jsx(ze,{title:`${o.parsedCount}/${o.totalRows} rows parsed`,children:e.jsxs(f,{variant:"caption",color:"text.secondary",children:[Math.round(o.parsedCount/o.totalRows*100),"%"]})}),e.jsx(ze,{title:a(o.confidence),children:e.jsx(qe,{sx:{fontSize:14,color:`${s(o.confidence)}.main`}})}),e.jsx(ze,{title:"Delete parsed field",children:e.jsx(Ae,{size:"small",onClick:()=>n(o.id),sx:{ml:.5,"&:hover":{color:"error.main"}},children:e.jsx(rt,{sx:{fontSize:14}})})})]},o.id))}),e.jsx(f,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"Drag parsed fields to target fields →"})]})},ir=({id:t,isMapped:r,targetFields:n,sampleValue:s,dataType:a,onParseColumn:o,parsedFields:l=[],onParsedFieldDragStart:p,onDeleteParsedField:u})=>{const d=(a==="Text"||!a&&typeof s=="string")&&typeof s=="string"&&s.length>20;t==="Notes"&&console.log("🔍 NARRATIVE PARSER DEBUG for Notes column:",{fieldId:t,dataType:a,sampleValue:s,sampleValueType:typeof s,sampleValueLength:typeof s=="string"?s.length:"N/A",isTextColumn:d,onParseColumn:!!o});const h={backgroundColor:r?"#f0f7ff":void 0,border:r?"1px solid #90caf9":"1px solid #e0e0e0",cursor:"grab",padding:"8px 12px",borderRadius:"4px",marginBottom:"8px",position:"relative"},x=F=>{console.log("DRAG START on source field:",t),F.dataTransfer.setData("text/plain",t),F.dataTransfer.effectAllowed="move",console.log("Verifying dataTransfer was set:",F.dataTransfer.types);const $=document.createElement("div");$.className="drag-ghost",$.innerHTML=`<div style="padding: 10px; background: #1976d2; color: white; border-radius: 4px;">Dragging: ${t}</div>`,document.body.appendChild($),F.dataTransfer.setDragImage($,20,20);const w=F.currentTarget;w.style.opacity="0.6",w.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.2)",setTimeout(()=>{document.body.removeChild($)},0),console.log("Drag started with field:",t)},v=F=>{const $=F.currentTarget;$.style.opacity="",$.style.boxShadow="",console.log("Drag ended for field:",t)};return e.jsx("div",{style:h,"data-field-id":t,className:"draggable-source-field",draggable:!0,onDragStart:x,onDragEnd:v,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsxs(j,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(f,{variant:"body2",fontWeight:"medium",children:t}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[d&&o&&e.jsx(or,{columnName:t,onClick:o,variant:"icon",size:"small"}),r&&e.jsx(le,{size:"small",icon:e.jsx(Hn,{fontSize:"small"}),label:n.length===1?n[0]:`${n.length} fields`,color:"primary",variant:"outlined"})]})]}),s!==void 0&&e.jsxs(j,{sx:{mt:.5,display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.75rem"},children:[e.jsx(f,{variant:"caption",sx:{color:"text.secondary",fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:typeof s=="object"?JSON.stringify(s):String(s)}),a&&e.jsx(le,{label:a,size:"small",variant:"outlined",sx:{height:"16px",fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]}),l.length>0&&e.jsx(ar,{parsedFields:l.map(F=>({id:F.id,name:F.name,sourceColumn:F.sourceColumn,parsedCount:F.parsedCount,totalRows:F.totalRows,confidence:F.confidence})),onFieldDragStart:p||(()=>{}),onDeleteParsedField:u||(()=>{})})]})})},lr=({sourceColumns:t,filter:r,setFilter:n,mappings:s,sampleData:a=[],onAddParsedFields:o})=>{const[l,p]=M.useState(!1),[u,d]=M.useState(""),[h,x]=M.useState({}),v=i=>{d(i),p(!0)},F=()=>{p(!1),d("")},$=(i,c)=>{console.log("🔥 Parsing completed for column:",u),console.log("📊 Selected fields:",i),console.log("📋 Results:",c);const y=i.map(A=>{const P=w(A),E=[];let k=0,ie=0;c.forEach(L=>{L.parsedFields[A]?(E.push(L.parsedFields[A].value),k++,ie+=L.parsedFields[A].confidence):E.push(null)});const R=k>0?ie/k:0;return{id:`${u}_${A}`,name:P,sourceColumn:u,parsedCount:k,totalRows:c.length,confidence:R,data:E}});if(x(A=>({...A,[u]:y})),a&&a.length>0){const A=a.map((P,E)=>{const k={...P};return y.forEach(ie=>{if(ie.data[E]!==null){const R=ie.id.split("_").slice(1).join("_"),L=`${u}_parsed_${R}`;k[L]=ie.data[E],console.log(`🤖 INJECTED parsed data: ${L} = "${ie.data[E]}"`)}}),k});console.log("🤖 Updated sample data with parsed fields:",A)}o&&o(u,y)},w=i=>({incident_type:"📊 Parsed Incident Type",response_time:"⏱️ Parsed Response Time",location:"📍 Parsed Location",date_time:"📅 Parsed Date/Time",units_resources:"🚒 Parsed Units/Resources"})[i]||`🤖 Parsed ${i}`,Y=(i,c)=>{console.log("🔥 Dragging parsed field:",c),i.dataTransfer.setData("text/plain",c),i.dataTransfer.effectAllowed="move"},_=i=>{console.log("🗑️ Deleting parsed field:",i);const c=Object.keys(h).find(y=>h[y].some(A=>A.id===i));c&&x(y=>({...y,[c]:y[c].filter(A=>A.id!==i)}))},q=i=>!a||a.length===0?[]:a.slice(0,10).map(c=>c[i]||"").filter(Boolean),U=M.useMemo(()=>{if(!r)return t;const i=r.toLowerCase();return t.filter(c=>c.toLowerCase().includes(i))},[t,r]),C=M.useMemo(()=>{const i={};return s.forEach(c=>{i[c.sourceField]||(i[c.sourceField]=[]),i[c.sourceField].push(c.targetField)}),i},[s]),G=M.useMemo(()=>Object.keys(C).length,[C]),X=M.useMemo(()=>{if(!a||a.length===0)return{};const i=a[0],c={};return t.forEach(y=>{c[y]=i[y]}),c},[a,t]),J=M.useMemo(()=>{const i={};return Object.entries(X).forEach(([c,y])=>{if(y==null){i[c]="Unknown";return}if(typeof y=="string"){if([/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/,/^\d{4}\/\d{2}\/\d{2}$/].some(E=>E.test(y))){i[c]="Date";return}if([/^\d{1,2}:\d{2}(:\d{2})?$/,/^\d{1,2}:\d{2}(:\d{2})?\s*(AM|PM)$/i].some(E=>E.test(y))){i[c]="Time";return}if(!isNaN(Number(y))){i[c]="Number";return}i[c]="Text";return}typeof y=="number"?i[c]="Number":typeof y=="boolean"?i[c]="Boolean":Array.isArray(y)?i[c]="Array":typeof y=="object"?i[c]="Object":i[c]=typeof y}),i},[X]);return e.jsxs(ye,{sx:{height:"100%",p:2,display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsx(Te,{size:"small",placeholder:"Search source fields...",value:r,onChange:i=>n(i.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(nt,{fontSize:"small"})})}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(f,{variant:"body2",color:"text.secondary",children:[U.length," fields"]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:[G," mapped"]})]}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(f,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drag fields from here to the Target Fields panel"})}),e.jsx(be,{sx:{mb:2}}),e.jsxs(j,{sx:{flexGrow:1,overflow:"auto",maxHeight:"calc(100% - 180px)",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:[U.map(i=>e.jsx(ir,{id:i,isMapped:!!C[i],targetFields:C[i]||[],sampleValue:X[i],dataType:J[i],onParseColumn:v,parsedFields:h[i]||[],onParsedFieldDragStart:Y,onDeleteParsedField:_},i)),U.length===0&&e.jsx(j,{sx:{textAlign:"center",py:4},children:e.jsx(f,{variant:"body2",color:"text.secondary",children:"No fields match your search"})})]}),e.jsx(rr,{open:l,onClose:F,columnName:u,sampleData:q(u),onParse:$})]})},cr=({open:t,onClose:r,fieldName:n,mapping:s,sampleData:a,onSave:o})=>{const[l,p]=M.useState(0),[u,d]=M.useState([]),[h,x]=M.useState("auto"),[v,F]=M.useState(""),[$,w]=M.useState(","),[Y,_]=M.useState(0),[q,U]=M.useState("string"),[C,G]=M.useState("point"),[X,J]=M.useState("longitude");M.useEffect(()=>{if(s){if(s.sourceField&&a.length>0){const E=a.map(k=>k[s.sourceField]).filter(k=>k!=null).slice(0,5);d(E)}s.transformations&&s.transformations.length>0&&s.transformations.forEach(E=>{switch(E.type){case"format":const k=E.params.format||E.params.dateFormat;k&&(k==="custom"?(x("custom"),F(E.params.customFormat||"")):x(k));break;case"split":w(E.params.delimiter||","),_(E.params.index||0);break;case"convert":U(E.params.toType||"string");break;case"parseCoordinates":G(E.params.format||"point"),J(E.params.component||"longitude");break}})}},[s,a]);const i=(E,k)=>{p(k)},c=()=>{const E=[];l===0&&h!=="auto"&&E.push({type:"format",params:{type:"date",format:h,fieldName:n,...h==="custom"?{customFormat:v}:{}}}),l===1&&E.push({type:"split",params:{delimiter:$,index:Y}}),l===2&&E.push({type:"convert",params:{toType:q}}),l===3&&E.push({type:"parseCoordinates",params:{format:C,component:X}}),o(n,E)},y=u.length>0,P=(()=>{if(!y)return[];switch(l){case 0:return u.map(E=>{if(!E)return"N/A";try{const k=new Date(E);if(isNaN(k.getTime()))return"Invalid date";switch(h){case"auto":return k.toLocaleString();case"MM/DD/YYYY":return`${k.getMonth()+1}/${k.getDate()}/${k.getFullYear()}`;case"YYYY-MM-DD":return`${k.getFullYear()}-${(k.getMonth()+1).toString().padStart(2,"0")}-${k.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${k.getDate()}/${k.getMonth()+1}/${k.getFullYear()}`;case"date-only":return new Date(E).toLocaleDateString();case"custom":return v.replace("YYYY",k.getFullYear().toString()).replace("MM",(k.getMonth()+1).toString().padStart(2,"0")).replace("DD",k.getDate().toString().padStart(2,"0")).replace("HH",k.getHours().toString().padStart(2,"0")).replace("mm",k.getMinutes().toString().padStart(2,"0")).replace("ss",k.getSeconds().toString().padStart(2,"0"));default:return k.toLocaleString()}}catch{return"Error formatting date"}});case 1:return u.map(E=>{if(!E)return"N/A";try{return E.toString().split($)[Y]||`Index ${Y} not found`}catch{return"Error splitting value"}});case 2:return u.map(E=>{if(E==null)return"N/A";try{switch(q){case"string":return String(E);case"number":return Number(E);case"boolean":return(!!E).toString();default:return String(E)}}catch{return"Error converting value"}});case 3:return u.map(E=>{if(!E)return"N/A";try{const k=E.toString().trim();if(C==="point"){const ie=k.match(/POINT\s*\(\s*([-\d.]+)\s+([-\d.]+)\s*\)/i);if(ie){const R=parseFloat(ie[1]),L=parseFloat(ie[2]);return X==="longitude"?R.toString():X==="latitude"?L.toString():`${R}, ${L}`}else return"Invalid POINT format"}return"Unsupported coordinate format"}catch{return"Error parsing coordinates"}})}return[]})();return e.jsxs(Ke,{open:t,onClose:r,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Xe,{children:["Transform Field: ",n]}),e.jsx(Ze,{dividers:!0,children:e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:l,onChange:i,"aria-label":"transformation tabs",children:[e.jsx(Ie,{label:"Date/Time Format"}),e.jsx(Ie,{label:"Split/Extract"}),e.jsx(Ie,{label:"Type Conversion"}),e.jsx(Ie,{label:"Parse Coordinates"})]})}),e.jsxs(j,{role:"tabpanel",hidden:l!==0,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Date Format Settings"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Choose how date and time values should be formatted. Date-only formats automatically strip time components."}),e.jsxs(_e,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"date-format-label",children:"Date Format"}),e.jsxs(Re,{labelId:"date-format-label",id:"date-format-select",value:h,label:"Date Format",onChange:E=>x(E.target.value),children:[e.jsx(re,{value:"auto",children:"Auto-detect"}),e.jsx(re,{value:"MM/DD/YYYY",children:"MM/DD/YYYY (date only)"}),e.jsx(re,{value:"DD/MM/YYYY",children:"DD/MM/YYYY (date only)"}),e.jsx(re,{value:"YYYY-MM-DD",children:"YYYY-MM-DD (date only)"}),e.jsx(re,{value:"date-only",children:"Date Only (strip time)"}),e.jsx(re,{value:"custom",children:"Custom Format"})]})]}),h==="custom"&&e.jsx(Te,{fullWidth:!0,label:"Custom Format",value:v,onChange:E=>F(E.target.value),helperText:"Use YYYY for year, MM for month, DD for day, HH for hour, mm for minute, ss for second",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==1,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Split or Extract Value"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Split a field by a delimiter and extract a specific part."}),e.jsx(Te,{fullWidth:!0,label:"Delimiter",value:$,onChange:E=>w(E.target.value),helperText:"Character or text that separates the parts",sx:{mb:2}}),e.jsx(Te,{fullWidth:!0,label:"Index",type:"number",value:Y,onChange:E=>_(parseInt(E.target.value)||0),helperText:"Position of the part to extract (0 = first part)",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==2,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Type Conversion"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Convert the value to a different data type."}),e.jsxs(_e,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"convert-type-label",children:"Convert To"}),e.jsxs(Re,{labelId:"convert-type-label",id:"convert-type-select",value:q,label:"Convert To",onChange:E=>U(E.target.value),children:[e.jsx(re,{value:"string",children:"Text (String)"}),e.jsx(re,{value:"number",children:"Number"}),e.jsx(re,{value:"boolean",children:"True/False (Boolean)"})]})]})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==3,sx:{p:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Parse Geographic Coordinates"}),e.jsx(f,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Extract latitude and longitude values from geographic coordinate formats like POINT(-86.5540806822223 39.1620537333389)."}),e.jsxs(_e,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"coordinate-format-label",children:"Coordinate Format"}),e.jsx(Re,{labelId:"coordinate-format-label",id:"coordinate-format-select",value:C,label:"Coordinate Format",onChange:E=>G(E.target.value),children:e.jsx(re,{value:"point",children:"POINT(longitude latitude)"})})]}),e.jsxs(_e,{fullWidth:!0,sx:{mb:2},children:[e.jsx($e,{id:"coordinate-component-label",children:"Extract Component"}),e.jsxs(Re,{labelId:"coordinate-component-label",id:"coordinate-component-select",value:X,label:"Extract Component",onChange:E=>J(E.target.value),children:[e.jsx(re,{value:"longitude",children:"Longitude (X coordinate)"}),e.jsx(re,{value:"latitude",children:"Latitude (Y coordinate)"}),e.jsx(re,{value:"both",children:"Both (longitude, latitude)"})]})]})]}),e.jsx(be,{sx:{my:2}}),e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Preview"}),y?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(j,{sx:{display:"flex",borderBottom:1,borderColor:"divider",pb:1},children:[e.jsx(f,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Original Value"}),e.jsx(f,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Transformed Value"})]}),u.map((E,k)=>e.jsxs(j,{sx:{display:"flex",py:1,borderBottom:"1px solid #eee"},children:[e.jsx(f,{variant:"body2",sx:{width:"50%"},children:E==null?"Null/Empty":String(E)}),e.jsx(f,{variant:"body2",sx:{width:"50%"},children:P[k]})]},k))]}):e.jsx(ue,{severity:"info",children:"No sample data available for preview."})]})}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:r,children:"Cancel"}),e.jsx(oe,{onClick:c,variant:"contained",children:"Apply Transformation"})]})]})},dr=t=>{switch(t.dataType){case"string":return`DEFAULT-${t.name}`;case"number":return"0";case"boolean":return"false";case"date":return new Date().toISOString().split("T")[0];case"location":return"0.0,0.0";default:return""}},ur=({open:t,onClose:r,unmappedRequiredFields:n,onAddDefaultMappings:s})=>{const[a,o]=M.useState(()=>{const d={};return n.forEach(h=>{d[h.name]=dr(h)}),d}),l=(d,h)=>{o(x=>({...x,[d]:h}))},p=()=>{console.log("Creating default mappings for fields:",n),console.log("Default values:",a);const d=n.map(h=>{const x={sourceField:"__default__",targetField:h.name,transformations:[{type:"convert",params:{defaultValue:a[h.name],targetType:h.dataType}}]};return console.log(`Created default mapping for ${h.name}:`,x),x});console.log("All default mappings:",d),s(d),r()},u=d=>{switch(d){case"number":return"number";case"date":return"date";default:return"text"}};return e.jsxs(Ke,{open:t,onClose:r,"aria-labelledby":"default-value-dialog-title",maxWidth:"md",fullWidth:!0,children:[e.jsx(Xe,{id:"default-value-dialog-title",children:"Set Default Values for Required Fields"}),e.jsxs(Ze,{children:[e.jsx(f,{variant:"body1",sx:{mb:3},children:"The following required fields don't have mappings. Please provide default values for them."}),e.jsx(he,{container:!0,spacing:3,children:n.map(d=>e.jsxs(he,{size:{xs:12,sm:6},children:[e.jsxs(j,{sx:{mb:1},children:[e.jsxs(f,{variant:"subtitle2",children:[d.name,e.jsx(le,{size:"small",label:d.dataType,color:"primary",variant:"outlined",sx:{ml:1}})]}),e.jsx(f,{variant:"caption",color:"text.secondary",children:d.description})]}),d.dataType==="boolean"?e.jsxs(Te,{select:!0,fullWidth:!0,value:a[d.name]||"false",onChange:h=>l(d.name,h.target.value),variant:"outlined",size:"small",children:[e.jsx(re,{value:"true",children:"True"}),e.jsx(re,{value:"false",children:"False"})]}):e.jsx(Te,{fullWidth:!0,value:a[d.name]||"",onChange:h=>l(d.name,h.target.value),type:u(d.dataType),variant:"outlined",size:"small",placeholder:`Enter default value for ${d.name}`,InputLabelProps:{shrink:!0}}),e.jsx(ks,{children:"Default value for all records"})]},d.name))})]}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:r,color:"primary",children:"Cancel"}),e.jsx(oe,{onClick:p,color:"primary",variant:"contained",children:"Apply Default Values"})]})]})},pr=({mapping:t,sampleData:r,onClose:n})=>{const s=Nt(),a=M.useMemo(()=>!t||!r.length?[]:r.slice(0,5).map(l=>({sourceValue:l[t.sourceField],transformedValue:(t.transformations||[]).reduce((p,u)=>fs(p,u,t.targetField),l[t.sourceField])})),[t,r]);if(!t)return e.jsx(ye,{sx:{p:2,mt:2,backgroundColor:xe(s.palette.info.light,.1),border:`1px dashed ${s.palette.info.main}`,borderRadius:1},children:e.jsx(f,{variant:"body2",color:"text.secondary",align:"center",children:"Select a field mapping to see transformation preview"})});if(!a.length||!t.sourceField)return e.jsx(ye,{sx:{p:2,mt:2,backgroundColor:xe(s.palette.warning.light,.1),border:`1px dashed ${s.palette.warning.main}`,borderRadius:1},children:e.jsxs(f,{variant:"body2",color:"text.secondary",children:["No sample data available for ",t.sourceField||"this field"]})});const o=t.transformations||[];return e.jsxs(ye,{sx:{p:2,mt:2,borderRadius:1,border:`1px solid ${s.palette.divider}`,boxShadow:s.shadows[1],position:"relative"},children:[n&&e.jsx(Ae,{size:"small",onClick:n,sx:{position:"absolute",top:8,right:8,color:s.palette.grey[500],"&:hover":{backgroundColor:xe(s.palette.grey[100],.9),color:s.palette.grey[800]}},"aria-label":"close preview",children:e.jsx(Ys,{fontSize:"small"})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,pr:4},children:[e.jsxs(f,{variant:"subtitle2",color:"primary",gutterBottom:!0,children:["Field Transformation Preview: ",t.targetField]}),e.jsx(le,{size:"small",label:`${o.length} transformation${o.length!==1?"s":""}`,color:o.length>0?"primary":"default",icon:o.length>0?e.jsx(ot,{}):void 0})]}),e.jsx(be,{sx:{mb:2}}),e.jsx(j,{sx:{maxHeight:200,overflow:"auto"},children:a.map((l,p)=>{const u=l.sourceValue!==void 0&&l.sourceValue!==null,d=o.length>0,h=typeof l.sourceValue,x=typeof l.transformedValue,v=h!==x;return e.jsxs(j,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:p%2===0?xe(s.palette.background.default,.5):"transparent",display:"flex",alignItems:"center"},children:[e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Source (",t.sourceField,")"]}),e.jsx(f,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:u?xe(s.palette.success.light,.1):xe(s.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:u?String(l.sourceValue):"(empty)"}),e.jsx(f,{variant:"caption",color:"text.secondary",children:h})]}),e.jsx(j,{sx:{flexBasis:"10%",textAlign:"center"},children:e.jsx(Yn,{color:d?"primary":"action"})}),e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Result (",t.targetField,")"]}),e.jsx(f,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:l.transformedValue!==void 0?xe(s.palette.success.light,.1):xe(s.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:l.transformedValue!==void 0?String(l.transformedValue):"(empty)"}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(f,{variant:"caption",color:"text.secondary",children:x}),v&&e.jsx(le,{size:"small",label:`Type: ${h} → ${x}`,color:"warning",variant:"outlined",sx:{height:16,fontSize:"0.6rem"}})]})]})]},p)})}),o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(be,{sx:{my:2}}),e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Transformation Steps Applied:"}),e.jsx(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:o.map((l,p)=>{var u,d,h,x,v,F,$,w,Y;return e.jsxs(j,{sx:{display:"flex",alignItems:"center",p:1,borderRadius:1,backgroundColor:xe(s.palette.primary.light,.05),border:`1px solid ${xe(s.palette.primary.light,.2)}`},children:[e.jsxs(j,{sx:{mr:1,color:s.palette.primary.main},children:[p+1,"."]}),e.jsxs(f,{variant:"body2",children:[e.jsxs("strong",{children:[l.type,":"]})," "," ",l.type==="convert"&&((u=l.params)==null?void 0:u.dataType)&&`Convert to ${l.params.dataType}`,l.type==="convert"&&((d=l.params)==null?void 0:d.defaultValue)!==void 0&&`Set default value to "${l.params.defaultValue}"`,l.type==="format"&&((h=l.params)==null?void 0:h.type)==="date"&&(((x=l.params)==null?void 0:x.format)||((v=l.params)==null?void 0:v.dateFormat))&&`Format date as "${l.params.format||l.params.dateFormat}"${l.params.customFormat?` (${l.params.customFormat})`:""}`,l.type==="format"&&((F=l.params)==null?void 0:F.pattern)&&`Format using pattern "${l.params.pattern}"`,l.type==="extract"&&(($=l.params)==null?void 0:$.pattern)&&`Extract using pattern "${l.params.pattern}"`,l.type==="replace"&&((w=l.params)==null?void 0:w.from)&&((Y=l.params)==null?void 0:Y.to)&&`Replace "${l.params.from}" with "${l.params.to}"`]})]},p)})})]}),t.targetField&&e.jsxs(j,{sx:{mt:2,p:1,borderRadius:1,display:"flex",alignItems:"center",backgroundColor:a.some(l=>l.transformedValue===void 0||l.transformedValue===null)?xe(s.palette.warning.light,.1):xe(s.palette.success.light,.1)},children:[a.some(l=>l.transformedValue===void 0||l.transformedValue===null)?e.jsx(ht,{color:"warning",sx:{mr:1}}):e.jsx(xs,{color:"success",sx:{mr:1}}),e.jsx(f,{variant:"body2",children:a.some(l=>l.transformedValue===void 0||l.transformedValue===null)?"Some values could not be transformed. Consider adding a default value.":"All sample values were successfully transformed."})]})]})},mr=ft(({className:t,...r})=>e.jsx(ze,{...r,classes:{popper:t}}))(()=>({"& .MuiTooltip-tooltip":{backgroundColor:"transparent",padding:0,maxWidth:320}})),hr=ft(ye)(({theme:t})=>({padding:t.spacing(2),backgroundColor:t.palette.background.paper,boxShadow:t.shadows[3],borderRadius:t.shape.borderRadius,border:`1px solid ${t.palette.divider}`,minWidth:200,maxWidth:320})),gr=ft(f)(({theme:t})=>({fontWeight:600,marginBottom:t.spacing(1),borderBottom:`1px solid ${t.palette.divider}`,paddingBottom:t.spacing(.5),color:t.palette.primary.main})),He=({title:t,children:r,content:n,icon:s=!1,placement:a="top",enterDelay:o=100,leaveDelay:l=100})=>{console.log(`EnhancedTooltip rendering: ${t} with icon=${s}`);const p=s?e.jsxs(j,{sx:{display:"inline-flex",alignItems:"center"},children:[r,e.jsx(qs,{color:"action",fontSize:"small",sx:{ml:.5,opacity:.7}})]}):r;return e.jsx(mr,{title:e.jsxs(hr,{children:[e.jsx(gr,{variant:"subtitle2",children:t}),n]}),placement:a,arrow:!0,enterDelay:o,leaveDelay:l,children:p})},fr=({toolConfig:t,showAllFields:r,setShowAllFields:n,filter:s,setFilter:a,mappings:o,onMappingChange:l,onRemoveMapping:p,validationErrors:u,sampleData:d,sourceColumns:h=[]})=>{const x=Nt();console.log("TargetFieldsPanel received sourceColumns:",h),console.log("TargetFieldsPanel received toolConfig:",t),console.log("TargetFieldsPanel received mappings:",o),console.log("🚨🚨🚨 IMPORTANT: TargetFieldsPanel does NOT contain Auto Map button! Auto Map is in FieldMappingContainer which is NOT rendering!");const[v,F]=M.useState(null),[$,w]=M.useState(null),[Y,_]=M.useState({Timing:!0,Location:!0,"Incident Details":!0}),q=M.useMemo(()=>{const g={};return u.forEach(V=>{g[V.field]={message:V.message,severity:V.severity}}),g},[u]),U=M.useMemo(()=>{const g={};return o.forEach(V=>{g[V.targetField]=V.sourceField}),g},[o]),C=M.useMemo(()=>{const g={};return[...t.requiredFields,...t.optionalFields].forEach(O=>{let B;O.dataType==="date"||O.name.toLowerCase().includes("time")||O.name.toLowerCase().includes("date")?B="Timing":O.dataType==="location"||O.name.toLowerCase().includes("lat")||O.name.toLowerCase().includes("lon")||O.name.toLowerCase().includes("address")?B="Location":B="Incident Details",g[B]||(g[B]=[]),g[B].push(O)}),g},[t]),G=M.useMemo(()=>{if(!s)return r?[...t.requiredFields,...t.optionalFields]:C;const g=s.toLowerCase(),O=[...t.requiredFields,...t.optionalFields].filter(D=>{var T;return D.name.toLowerCase().includes(g)||((T=D.description)==null?void 0:T.toLowerCase().includes(g))});if(r)return O;const B={};return O.forEach(D=>{let T;for(const[S,K]of Object.entries(C))if(K.some(H=>H.id===D.id)){T=S;break}T||(T="Other"),B[T]||(B[T]=[]),B[T].push(D)}),B},[t,s,r,C]),X=g=>{_({...Y,[g]:!Y[g]})},J=(g,V)=>{console.log("Dropdown selection - mapping",V,"to",g);try{if(!V){p(g);return}l({sourceField:V,targetField:g}),console.log("Mapping updated via dropdown successfully")}catch(O){console.error("Error updating mapping via dropdown:",O)}},i=g=>{F(g)},c=()=>{F(null)},y=g=>{w(V=>V===g?null:g)},A=(g,V)=>{const O=o.find(B=>B.targetField===g);O&&l({...O,transformations:V}),F(null)},P=g=>{switch(g){case"string":return{icon:e.jsx(Ut,{fontSize:"small"}),color:"info"};case"number":return{icon:e.jsx(er,{fontSize:"small"}),color:"secondary"};case"date":return{icon:e.jsx(Jn,{fontSize:"small"}),color:"warning"};case"boolean":return{icon:e.jsx(Kn,{fontSize:"small"}),color:"success"};case"location":return{icon:e.jsx(Hs,{fontSize:"small"}),color:"error"};default:return{icon:e.jsx(Ut,{fontSize:"small"}),color:"default"}}},E=g=>{const V=U[g.id],O=q[g.id],B=$===g.id;console.log(`🔧 FIELD RENDER: ${g.name} (ID: ${g.id}), mapped to: ${V||"none"}`);const D=N=>{N.preventDefault(),N.stopPropagation(),N.dataTransfer.dropEffect="move";const b=N.currentTarget;b.style.boxShadow="0 0 0 2px #1976d2",b.style.borderColor="#1976d2",b.style.backgroundColor="#f0f7ff",b.style.transform="scale(1.01)",b.style.transition="all 0.2s ease",console.log("DRAG OVER on target field:",g.name)},T=N=>{N.preventDefault(),N.stopPropagation();const b=N.currentTarget;b.style.boxShadow="",b.style.borderColor=O?O.severity==="error"?"#f44336":"#ff9800":V?"#4caf50":"#e0e0e0",b.style.backgroundColor=O?O.severity==="error"?"#fff5f5":"#fffbf0":V?"#f4fbf4":"#ffffff",b.style.transform="",console.log("DRAG LEAVE from field:",g.name)},S=N=>{N.preventDefault(),N.stopPropagation(),console.log("DROP EVENT TRIGGERED on field:",g.name);try{const b=N.dataTransfer.getData("text/plain");if(console.log("Dropped source field data:",b),!b){console.error("No source field data found in the drop event");return}const m=N.currentTarget;m.style.boxShadow="",m.style.borderColor="",m.style.backgroundColor="",m.style.transform="",l({sourceField:b,targetField:g.id}),w(g.id),m.style.boxShadow="0 0 0 2px #4caf50",m.style.borderColor="#4caf50",m.style.backgroundColor="#f4fbf4",m.style.transform="scale(1.02)";const z=b;setTimeout(()=>{try{z?(m.style.borderColor="#4caf50",m.style.backgroundColor="#f4fbf4"):(m.style.borderColor=O?O.severity==="error"?"#f44336":"#ff9800":"#e0e0e0",m.style.backgroundColor=O?O.severity==="error"?"#fff5f5":"#fffbf0":"#ffffff"),m.style.boxShadow="",m.style.transform=""}catch(W){console.error("Error in animation cleanup:",W)}},1e3),console.log(`Successfully dropped ${b} onto ${g.name}`)}catch(b){console.error("Error in drop handler:",b)}},K=()=>{V&&y(g.name)},H=()=>e.jsxs(j,{children:[e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Required Format:"})," ",g.format||"No specific format required"]}),g.examples&&e.jsxs(j,{sx:{mt:1},children:[e.jsx(f,{variant:"body2",children:e.jsx("strong",{children:"Examples:"})}),e.jsx(j,{component:"ul",sx:{mt:.5,pl:2},children:g.examples.map((N,b)=>e.jsx(j,{component:"li",children:e.jsx(f,{variant:"body2",fontFamily:"monospace",children:N})},b))})]}),g.validation&&e.jsxs(f,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Validation:"})," ",String(g.validation)]})]}),I=()=>{let N="";switch(g.dataType){case"string":N="Text value. Can contain any characters.";break;case"number":N="Numeric value. Can be integer or decimal.";break;case"date":N="Date value. Should be in a standard format.";break;case"boolean":N="True/False value.";break;case"location":N="Geographic coordinates or address.";break;default:N=`${g.dataType} data type.`}return e.jsxs(j,{children:[e.jsx(f,{variant:"body2",children:N}),g.dataType==="date"&&e.jsx(f,{variant:"body2",sx:{mt:1},children:"Common formats: YYYY-MM-DD, MM/DD/YYYY"})]})};return e.jsxs(j,{sx:{p:2,mb:2,border:"1px solid",borderColor:O?O.severity==="error"?"error.main":"warning.main":V?"success.light":"divider",borderRadius:1,bgcolor:O?O.severity==="error"?xe(x.palette.error.light,.1):xe(x.palette.warning.light,.1):V?xe(x.palette.success.light,.1):"background.paper",position:"relative",transition:"all 0.3s ease",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",cursor:V?"pointer":"default",...B&&{boxShadow:"0 0 0 2px #1976d2",border:"1px solid #1976d2"},"&:hover":V?{boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transform:"translateY(-2px)"}:{}},draggable:!1,id:`target-field-${g.id}`,"data-target-field":g.id,onDragOver:D,onDragLeave:T,onDrop:S,onClick:K,children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(j,{children:[e.jsx(He,{title:`${g.name} Field`,content:H(),placement:"top-start",icon:!0,children:e.jsxs(f,{variant:"subtitle2",component:"div",sx:{display:"inline-flex",alignItems:"center",cursor:"help"},children:[g.name,g.isRequired&&e.jsx(le,{size:"small",label:"Required",color:"primary",sx:{ml:1,height:20}}),V&&e.jsx(le,{size:"small",label:"Click to preview",color:"info",variant:"outlined",sx:{ml:1,height:20,display:{xs:"none",sm:"flex"},animation:B?"none":"pulse 1.5s infinite","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0.4)"},"70%":{boxShadow:"0 0 0 6px rgba(33, 150, 243, 0)"},"100%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0)"}}}})]})}),g.dataType&&e.jsx(He,{title:`${g.dataType} Data Type`,content:I(),children:e.jsx(le,{size:"small",label:g.dataType,color:P(g.dataType).color,variant:"outlined",icon:P(g.dataType).icon,sx:{mt:1,mr:1,height:20}})}),e.jsx(f,{variant:"body2",color:"text.secondary",children:g.description})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"flex-start"},children:[O&&e.jsx(He,{title:"Validation Issue",content:e.jsx(f,{variant:"body2",children:O.message}),type:O.severity==="error"?"warning":"info",children:e.jsx(j,{sx:{display:"flex",alignItems:"center",mr:1},children:O.severity==="error"?e.jsx(us,{color:"error",fontSize:"small"}):e.jsx(ps,{color:"warning",fontSize:"small"})})}),V&&e.jsxs(e.Fragment,{children:[e.jsx(He,{title:"Edit Transformations",content:e.jsx(f,{variant:"body2",children:"Configure data transformations for this field mapping. Apply operations like splitting, joining, formatting and type conversion."}),children:e.jsx(Ae,{size:"small",onClick:N=>{N.stopPropagation(),i(g.id)},sx:{mr:1},children:e.jsx(ds,{fontSize:"small"})})}),e.jsx(He,{title:"Remove Mapping",content:e.jsx(f,{variant:"body2",children:"Remove the current mapping between source and target fields."}),type:"warning",children:e.jsx(Ae,{size:"small",onClick:N=>{N.stopPropagation(),p(g.id)},children:e.jsx(rt,{fontSize:"small"})})})]})]})]}),e.jsxs(_e,{fullWidth:!0,size:"small",children:[e.jsx($e,{id:`${g.id}-source-label`,children:"Select source field"}),e.jsxs(Re,{labelId:`${g.id}-source-label`,id:`${g.id}-source-select`,value:V||"",label:"Select source field",onChange:N=>{try{J(g.id,N.target.value),N.target.value?w(g.name):$===g.name&&w(null)}catch(b){console.error("Error in dropdown change handler:",b)}},MenuProps:{anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},slotProps:{paper:{elevation:4,style:{maxHeight:300}}}},renderValue:N=>N||e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"}),endAdornment:V&&e.jsx(Oe,{position:"end",children:e.jsx(He,{title:"Field is Mapped",content:e.jsxs(f,{variant:"body2",children:['This field is mapped to source field "',V,'". Click the field to preview the mapping.']}),children:e.jsx(qe,{color:"success",fontSize:"small"})})}),onClick:N=>N.stopPropagation(),children:[e.jsx(re,{value:"",children:e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"})}),Array.isArray(h)&&h.length>0?h.map(N=>{const b=d&&d.length>0?d[0][N]:void 0;let m="Unknown";b!=null&&(typeof b=="string"?[/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/].some(Z=>Z.test(b))?m="Date":/^\d{1,2}:\d{2}(:\d{2})?(\s*(AM|PM))?$/i.test(b)?m="Time":isNaN(Number(b))?m="Text":m="Number":m=typeof b);const z=W=>W==null?"":typeof W=="object"?JSON.stringify(W).substring(0,30):String(W).substring(0,30);return e.jsx(re,{value:N,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsx(f,{variant:"body2",children:N}),b!==void 0&&e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(f,{variant:"caption",sx:{fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"text.secondary"},children:z(b)}),e.jsx(le,{label:m,size:"small",sx:{height:16,fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]})]})},N)}):e.jsx(re,{disabled:!0,children:e.jsx("em",{children:"No source fields available"})})]})]})]},g.id)},k=()=>{if(r){const g=Array.isArray(G)?G:Object.values(G).flat();return e.jsx(j,{children:g.map(E)})}else return Object.entries(G).map(([g,V])=>e.jsxs(as,{expanded:Y[g]||!1,onChange:()=>X(g),sx:{mb:2},children:[e.jsxs(is,{expandIcon:e.jsx(xt,{}),children:[e.jsx(f,{variant:"subtitle1",children:g}),e.jsxs(f,{variant:"body2",color:"text.secondary",sx:{ml:2},children:[V.length," fields"]})]}),e.jsx(ls,{children:V.map(E)})]},g))},[ie,R]=M.useState(!1),L=M.useMemo(()=>t.requiredFields.filter(V=>!o.some(O=>O.targetField===V.name)),[t.requiredFields,o]),se=g=>{console.log("Received default mappings:",g),g.forEach(V=>{console.log("Adding default mapping for:",V.targetField,V),l(V)}),console.log("Current mappings after adding defaults:",o)};return e.jsxs(ye,{sx:{p:2,height:"100%",display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[L.length>0&&e.jsxs(oe,{variant:"outlined",size:"small",startIcon:e.jsx(Bs,{}),onClick:()=>R(!0),color:"primary",children:["Set Default Values (",L.length,")"]}),e.jsx(We,{control:e.jsx(zs,{checked:r,onChange:g=>n(g.target.checked),size:"small"}),label:"Show all fields A-Z"})]}),L.length>0&&e.jsxs(ue,{severity:"warning",sx:{mb:2},action:e.jsx(oe,{color:"inherit",size:"small",onClick:()=>R(!0),children:"Set Defaults"}),children:[L.length," required ",L.length===1?"field":"fields"," not mapped. Please map or set default values to continue."]}),e.jsx(Te,{size:"small",placeholder:"Search target fields...",value:s,onChange:g=>a(g.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(nt,{fontSize:"small"})})}}),e.jsx(be,{sx:{mb:2}}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(f,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drop source fields onto target fields or use the drop-down menus below"})}),$&&e.jsx(pr,{mapping:o.find(g=>g.targetField===$)||null,sampleData:d,onClose:()=>w(null)}),e.jsx(j,{sx:{flexGrow:1,maxHeight:"calc(100% - 220px)",overflow:"auto",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:k()}),v&&e.jsx(cr,{open:!!v,onClose:c,fieldName:v,mapping:o.find(g=>g.targetField===v),sampleData:d,onSave:A}),e.jsx(ur,{open:ie,onClose:()=>R(!1),unmappedRequiredFields:L,onAddDefaultMappings:se})]})},xr=({validationErrors:t,jumpToField:r})=>{const[n,s]=Je.useState(!1),a=t.filter(p=>p.severity==="error").length,o=t.filter(p=>p.severity==="warning").length,l=()=>{s(!n)};return e.jsxs(ye,{sx:{p:2,position:"sticky",top:16},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer"},onClick:l,children:[e.jsxs(f,{variant:"h6",color:a>0?"error":"warning",children:["Validation Issues ",a>0?`(${a} errors, ${o} warnings)`:`(${o} warnings)`]}),e.jsx(oe,{size:"small",endIcon:n?e.jsx(ms,{}):e.jsx(xt,{}),children:n?"Collapse":"Expand"})]}),e.jsxs(cs,{in:n,children:[e.jsx(be,{sx:{my:1}}),e.jsx(j,{sx:{maxHeight:"200px",overflow:"auto"},children:e.jsx(Ve,{dense:!0,children:t.map((p,u)=>e.jsxs(Fe,{sx:{bgcolor:p.severity==="error"?"error.lightest":"warning.lightest",mb:.5,borderRadius:1},children:[e.jsx(ke,{children:p.severity==="error"?e.jsx(us,{color:"error"}):e.jsx(ps,{color:"warning"})}),e.jsx(De,{primary:p.field,secondary:p.message}),e.jsx(oe,{size:"small",variant:"outlined",color:p.severity==="error"?"error":"warning",onClick:()=>r(p.field),children:"Go to Field"})]},u))})})]})]})},yr=({sampleData:t,mappings:r,toolConfig:n})=>{const s=M.useMemo(()=>t.length>0?t[0]:null,[t]),a=M.useMemo(()=>{if(!s||!r.length)return null;const u=gs([s],r);return u.length>0?u[0]:null},[s,r]);if(!s||!a)return e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(f,{variant:"body2",color:"text.secondary",children:"No data available for preview. Upload a file and map fields to see a live preview."})});const o=Object.keys(s),l=Object.keys(a);console.log("🔍 LIVE PREVIEW DEBUG: Transformed row keys:",l),console.log("🔍 LIVE PREVIEW DEBUG: Mappings count:",r.length),console.log("🔍 LIVE PREVIEW DEBUG: Mappings:",r.map(u=>`${u.sourceField} → ${u.targetField}`)),console.log("🔍 LIVE PREVIEW DEBUG: Tool config available:",!!n),console.log("🔍 LIVE PREVIEW DEBUG: Field ID → Display Name conversions incoming...");const p=u=>{if(!n)return console.log(`🔍 LIVE PREVIEW: No toolConfig for field ${u}`),u;const h=[...n.requiredFields||[],...n.optionalFields||[]].find(x=>x.id===u);return console.log(`🔍 LIVE PREVIEW: Converting field ID "${u}" → display name "${h?h.name:u}"`),h?h.name:u};return e.jsxs(j,{children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(f,{variant:"subtitle1",children:"Live Preview"}),e.jsx(f,{variant:"body2",color:"text.secondary",children:"Showing all mapped fields • Scroll horizontally to see more →"})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,overflowX:"auto"},children:[e.jsx(At,{component:ye,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(dt,{size:"small",stickyHeader:!0,children:[e.jsx(ut,{children:e.jsx(Pe,{children:o.map(u=>e.jsx(Ce,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(f,{variant:"caption",fontWeight:"bold",children:u})},u))})}),e.jsx(pt,{children:e.jsx(Pe,{children:o.map(u=>e.jsx(Ce,{sx:{minWidth:"120px"},children:e.jsx(f,{variant:"caption",sx:{wordBreak:"break-word"},children:s[u]!==null&&s[u]!==void 0?String(s[u]):"null"})},u))})})]})}),e.jsx(j,{sx:{display:"flex",justifyContent:"center",alignItems:"center",px:2,flexShrink:0},children:e.jsx(Wn,{color:"primary"})}),e.jsx(At,{component:ye,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(dt,{size:"small",stickyHeader:!0,children:[e.jsx(ut,{children:e.jsx(Pe,{children:l.map(u=>e.jsx(Ce,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(f,{variant:"caption",fontWeight:"bold",children:p(u)})},u))})}),e.jsx(pt,{children:e.jsx(Pe,{children:l.map(u=>e.jsx(Ce,{sx:{minWidth:"120px"},children:e.jsx(f,{variant:"caption",sx:{wordBreak:"break-word"},children:a[u]!==null&&a[u]!==void 0?String(a[u]):"null"})},u))})})]})})]})]})},js=(t,r)=>{M.useEffect(()=>{if(r)try{localStorage.setItem(`tmpl:${t.id}`,JSON.stringify(t)),console.log(`Template "${t.name}" saved to localStorage`)}catch(h){console.error("Failed to save template to localStorage:",h)}},[t,r]);const n=h=>{try{let F=Object.keys(localStorage).filter($=>$.startsWith("tmpl:")).map($=>{const w=localStorage.getItem($);return w?JSON.parse(w):null}).filter(Boolean);return h&&(F=F.filter($=>$.toolId===h)),F.sort(($,w)=>w.lastModified-$.lastModified)}catch(x){return console.error("Failed to load templates from localStorage:",x),[]}},s=h=>{try{return localStorage.removeItem(`tmpl:${h}`),!0}catch(x){return console.error("Failed to delete template:",x),!1}};return{loadTemplates:n,deleteTemplate:s,saveToServer:async()=>(console.log("Saving template to server:",t),new Promise(h=>{setTimeout(()=>{console.log("Template saved to server successfully"),h()},500)})),loadFromServer:async()=>n(),autoSaveTemplate:(h,x)=>{if(!h||h.length===0)return;const v={id:`auto-${x}-${Date.now()}`,name:`Auto-saved ${x} mapping`,description:"Automatically saved field mapping configuration",toolId:x,mappings:h,lastModified:Date.now()};try{localStorage.setItem(`tmpl:${v.id}`,JSON.stringify(v)),console.log("Template auto-saved:",v.name)}catch(F){console.error("Failed to auto-save template:",F)}},getTemplateStats:()=>{var v;const h=n(),x={total:h.length,byTool:{},mostRecent:((v=h[0])==null?void 0:v.lastModified)||0,totalMappings:h.reduce((F,$)=>{var w;return F+(((w=$.mappings)==null?void 0:w.length)||0)},0)};return h.forEach(F=>{const $=F.toolId||"unknown";x.byTool[$]=(x.byTool[$]||0)+1}),x},findSimilarTemplates:(h,x)=>{if(!h||h.length===0)return[];const v=n(x),F=new Set(h.map($=>$.sourceField.toLowerCase()));return v.map($=>{const w=new Set($.mappings.map(q=>q.sourceField.toLowerCase())),_=new Set([...F].filter(q=>w.has(q))).size/Math.max(F.size,w.size);return{template:$,similarity:_}}).filter(({similarity:$})=>$>.3).sort(($,w)=>w.similarity-$.similarity).map(({template:$})=>$)},cleanupAutoSaved:()=>{try{n().filter(v=>v.name.startsWith("Auto-saved")).sort((v,F)=>F.lastModified-v.lastModified).slice(5).forEach(v=>{s(v.id)})}catch(h){console.error("Failed to cleanup auto-saved templates:",h)}}}},Rt={id:"vendor_console_one_standard",name:"Console One CAD - Standard Template",description:"Professional template for Console One CAD systems with NFIRS code support. Includes incident times, unit information, and location data.",cadVendor:"Console One",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"INC_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_TIME",targetField:"dispatch_time"},{sourceField:"ENROUTE_TIME",targetField:"enroute_time"},{sourceField:"ARRIVAL_TIME",targetField:"arrival_time"},{sourceField:"CLEAR_TIME",targetField:"clear_time"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"UNIT_ID",targetField:"responding_unit"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["INC_DATE_TIME","INC_NUM","INC_DATE","DISPATCH_TIME","ENROUTE_TIME","ARRIVAL_TIME","CLEAR_TIME","PROBLEM_TYPE","UNIT_ID","LOCATION_ADDRESS","LATITUDE","LONGITUDE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Console One"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:95,successRate:100,dataTypes:{},sampleValues:{INC_DATE_TIME:["01/15/2024 14:23:45","01/15/2024 15:30:12"],PROBLEM_TYPE:["111","522","311","651"],UNIT_ID:["E01","T01","M01","BC01"]},tags:["console-one","nfirs","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},br={id:"vendor_tyler_standard",name:"Tyler Technologies CAD - Standard Template",description:"Professional template for Tyler Technologies CAD systems. Handles mixed field naming conventions and date formats common in Tyler exports.",cadVendor:"Tyler",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"ALARM_TIME",targetField:"incident_time"},{sourceField:"INCIDENT_NUMBER",targetField:"incident_id"},{sourceField:"INCIDENT_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_DATE",targetField:"dispatch_time"},{sourceField:"ENROUTE_DATE",targetField:"enroute_time"},{sourceField:"ARRIVAL_DATE",targetField:"arrival_time"},{sourceField:"CLEAR_DATE",targetField:"clear_time"},{sourceField:"NATURE_CODE",targetField:"incident_type"},{sourceField:"PRIMARY_UNIT",targetField:"responding_unit"},{sourceField:"ADDRESS",targetField:"address"},{sourceField:"CITY",targetField:"city"},{sourceField:"STATE",targetField:"state"}],sourceFieldPattern:{fieldNames:["ALARM_TIME","INCIDENT_NUMBER","INCIDENT_DATE","DISPATCH_DATE","ENROUTE_DATE","ARRIVAL_DATE","CLEAR_DATE","NATURE_CODE","PRIMARY_UNIT","ADDRESS","CITY","STATE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Tyler"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:92,successRate:98,dataTypes:{},sampleValues:{ALARM_TIME:["2024-01-15 14:23:45","2024-01-15 15:30:12"],NATURE_CODE:["FIREA","EMSC","FIREB","HAZMAT"],PRIMARY_UNIT:["Engine 1","Truck 1","Medic 1","Chief 1"]},tags:["tyler","tyler-technologies","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},jr={id:"vendor_hexagon_standard",name:"Hexagon/Intergraph CAD - Standard Template",description:"Professional template for Hexagon/Intergraph CAD systems. Handles PascalCase field naming and mixed datetime formats with/without seconds.",cadVendor:"Hexagon",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"CallDateTime",targetField:"incident_time"},{sourceField:"IncidentNumber",targetField:"incident_id"},{sourceField:"CallDate",targetField:"incident_date"},{sourceField:"DispatchDateTime",targetField:"dispatch_time"},{sourceField:"EnRouteDateTime",targetField:"enroute_time"},{sourceField:"ArrivalDateTime",targetField:"arrival_time"},{sourceField:"ClearDateTime",targetField:"clear_time"},{sourceField:"IncidentType",targetField:"incident_type"},{sourceField:"UnitId",targetField:"responding_unit"},{sourceField:"LocationAddress",targetField:"address"},{sourceField:"Latitude",targetField:"latitude"},{sourceField:"Longitude",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["CallDateTime","IncidentNumber","CallDate","DispatchDateTime","EnRouteDateTime","ArrivalDateTime","ClearDateTime","IncidentType","UnitId","LocationAddress","Latitude","Longitude"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Hexagon"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:90,successRate:95,dataTypes:{},sampleValues:{CallDateTime:["01/20/2024 14:28","01/20/2024 15:35:22"],IncidentType:["Structure Fire","Medical Emergency","Vehicle Accident"],UnitId:["ENG001","TRK001","MED001","BC001"]},tags:["hexagon","intergraph","pascalcase","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},Tr={id:"vendor_tritech_standard",name:"TriTech/CentralSquare CAD - Standard Template",description:"Professional template for TriTech/CentralSquare CAD systems. Handles underscore_case naming conventions and EventNum identifiers.",cadVendor:"TriTech",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"Call_Date_Time",targetField:"incident_time"},{sourceField:"EventNum",targetField:"incident_id"},{sourceField:"Call_Date",targetField:"incident_date"},{sourceField:"Dispatch_Time",targetField:"dispatch_time"},{sourceField:"Enroute_Time",targetField:"enroute_time"},{sourceField:"Arrival_Time",targetField:"arrival_time"},{sourceField:"Clear_Time",targetField:"clear_time"},{sourceField:"Call_Type",targetField:"incident_type"},{sourceField:"Unit_ID",targetField:"responding_unit"},{sourceField:"Address",targetField:"address"},{sourceField:"City",targetField:"city"},{sourceField:"State",targetField:"state"}],sourceFieldPattern:{fieldNames:["Call_Date_Time","EventNum","Call_Date","Dispatch_Time","Enroute_Time","Arrival_Time","Clear_Time","Call_Type","Unit_ID","Address","City","State"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"TriTech"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:88,successRate:93,dataTypes:{},sampleValues:{Call_Date_Time:["2024-01-15 14:23:45","2024-01-15 15:30:12"],Call_Type:["FIRE","EMS","RESCUE","HAZMAT"],Unit_ID:["E1","L1","M1","C1"]},tags:["tritech","centralsquare","underscore","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},vr={...Rt,id:"vendor_console_one_firemap",name:"Console One CAD - Fire Map Pro Template",description:"Geographic analysis template for Console One CAD data. Optimized for incident mapping and spatial analysis.",targetTool:"fire-map-pro",fieldMappings:[{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"UNIT_ID",targetField:"responding_unit"}],metadata:{...Rt.metadata,tags:["console-one","fire-map-pro","geographic","certified"]}},Ot=[Rt,br,jr,Tr,vr],Er=()=>Ot.filter(t=>{var r;return((r=t.metadata.tags)==null?void 0:r.includes("certified"))&&t.isPublic}),gt=()=>{try{const t=JSON.parse(localStorage.getItem("fireems_field_mapping_templates")||"[]");if(t.some(n=>{var s;return(s=n.id)==null?void 0:s.startsWith("vendor_")}))console.log("📚 Vendor templates already exist, skipping seed");else{console.log("🌱 Seeding vendor templates for first-time user...");const n=[...t,...Ot];localStorage.setItem("fireems_field_mapping_templates",JSON.stringify(n)),console.log(`✅ Seeded ${Ot.length} vendor templates successfully`)}}catch(t){console.error("❌ Error seeding vendor templates:",t)}};class Ye{static async saveTemplate(r,n,s,a,o,l,p,u){const d={id:this.generateTemplateId(),name:r.trim(),description:n.trim(),departmentName:p,cadVendor:u,targetTool:l,fieldMappings:s,sourceFieldPattern:this.analyzeSourcePattern(a,o),metadata:this.generateMetadata(s,o),createdAt:new Date().toISOString(),useCount:0,isPublic:!1},h=this.getStoredTemplates();return h.push(d),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(h)),console.log(`✅ Template saved: "${r}" (${d.id})`),d}static getTemplates(){try{gt();const r=this.getStoredTemplates();return console.log("📚 TemplateService.getTemplates() found:",r.length,"templates"),console.log("🏅 Vendor templates:",r.filter(n=>{var s;return(s=n.id)==null?void 0:s.startsWith("vendor_")}).length),r}catch(r){return console.error("❌ Error in getTemplates:",r),[]}}static getTemplatesForTool(r){return gt(),this.getStoredTemplates().filter(n=>n.targetTool===r)}static getCertifiedTemplatesForTool(r){return Er().filter(n=>n.targetTool===r)}static deleteTemplate(r){const n=this.getStoredTemplates(),s=n.findIndex(a=>a.id===r);return s!==-1?(n.splice(s,1),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)),console.log(`🗑️ Template deleted: ${r}`),!0):!1}static suggestTemplates(r,n,s){var l;const a=this.getTemplatesForTool(s),o=[];for(const p of a){const u=this.calculateSimilarity(r,p.sourceFieldPattern.fieldNames);if(u.score>=30){let d=u.score;(l=p.metadata.tags)!=null&&l.includes("certified")&&p.isPublic&&(d+=10,console.log(`🏅 Certified template boost: "${p.name}" ${u.score}% → ${d}%`)),o.push({template:p,similarityScore:d,matchingFields:u.matchingFields,missingFields:u.missingFields,suggestions:this.generateSuggestions(u,p)})}}return o.sort((p,u)=>{var x,v;const d=(x=p.template.metadata.tags)!=null&&x.includes("certified")?1:0,h=(v=u.template.metadata.tags)!=null&&v.includes("certified")?1:0;return d!==h?h-d:u.similarityScore-p.similarityScore}),console.log(`🔍 Found ${o.length} template suggestions for tool: ${s}`),console.log(`🏅 Certified templates: ${o.filter(p=>{var u;return(u=p.template.metadata.tags)==null?void 0:u.includes("certified")}).length}`),o.slice(0,8)}static applyTemplate(r,n){const s=[];this.incrementTemplateUsage(r.id);for(const a of r.fieldMappings){if(n.includes(a.sourceField)){s.push({...a});continue}const o=n.find(p=>p.toLowerCase()===a.sourceField.toLowerCase());if(o){s.push({...a,sourceField:o});continue}const l=this.findFuzzyMatch(a.sourceField,n);l&&s.push({...a,sourceField:l})}return console.log(`🔧 Applied template "${r.name}": ${s.length} mappings applied`),s}static generateCADSignature(r){const n={"Console One":["INC_DATE_TIME","PROBLEM_TYPE","UNIT_ID"],Tyler:["ALARM_TIME","INCIDENT_DATE","DISPATCH_DATE"],Hexagon:["CallDateTime","DispatchDateTime","ArrivalDateTime"],TriTech:["EventNum","Call_Date_Time","Unit_ID"]};let s="Other",a=0;for(const[o,l]of Object.entries(n)){const p=l.filter(u=>r.some(d=>d.toLowerCase().includes(u.toLowerCase()))).length;p>a&&(a=p,s=o)}return s}static getStoredTemplates(){try{const r=localStorage.getItem(this.STORAGE_KEY);return r?JSON.parse(r):[]}catch(r){return console.warn("Failed to load templates from localStorage:",r),[]}}static generateTemplateId(){return`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static analyzeSourcePattern(r,n){return{fieldNames:[...r],fieldCount:r.length,hasHeaderRow:!0,commonPatterns:this.extractCommonPatterns(r),cadVendorSignature:this.generateCADSignature(r)}}static extractCommonPatterns(r){const n=[],s={datetime:["date","time","datetime"],location:["address","location","lat","lng","coord"],incident:["incident","call","event","alarm"],unit:["unit","apparatus","resource"],type:["type","category","classification"]};for(const[a,o]of Object.entries(s))o.some(l=>r.some(p=>p.toLowerCase().includes(l)))&&n.push(a);return n}static generateMetadata(r,n){const a=Math.min(100,r.length/10*100),o={};if(n.length>0)for(const l of r){const p=n.slice(0,3).map(u=>u[l.sourceField]).filter(u=>u!=null&&u!=="").map(u=>String(u));p.length>0&&(o[l.sourceField]=p)}return{version:this.VERSION,compatibility:["1.0.0"],qualityScore:Math.round(a),successRate:100,dataTypes:{},sampleValues:o,tags:[]}}static calculateSimilarity(r,n){const s=new Set(r.map(p=>p.toLowerCase()));new Set(n.map(p=>p.toLowerCase()));const a=[],o=[];for(const p of n)s.has(p.toLowerCase())?a.push(p):o.push(p);const l=a.length/n.length*100;return{score:Math.round(l),matchingFields:a,missingFields:o}}static generateSuggestions(r,n){const s=[];return r.score>=80?s.push("Excellent match! This template should work with minimal adjustments."):r.score>=60?s.push("Good match. May need minor field mapping adjustments."):r.score>=30&&s.push("Partial match. Review field mappings carefully."),r.missingFields.length>0&&s.push(`Missing fields: ${r.missingFields.slice(0,3).join(", ")}`),s}static findFuzzyMatch(r,n){const s=r.toLowerCase();for(const a of n){const o=a.toLowerCase();if(this.stringSimilarity(s,o)>=.7)return a}return null}static stringSimilarity(r,n){const s=r.length>n.length?r:n,a=r.length>n.length?n:r;if(s.length===0)return 1;const o=this.levenshteinDistance(s,a);return(s.length-o)/s.length}static levenshteinDistance(r,n){const s=[];for(let a=0;a<=n.length;a++)s[a]=[a];for(let a=0;a<=r.length;a++)s[0][a]=a;for(let a=1;a<=n.length;a++)for(let o=1;o<=r.length;o++)n.charAt(a-1)===r.charAt(o-1)?s[a][o]=s[a-1][o-1]:s[a][o]=Math.min(s[a-1][o-1]+1,s[a][o-1]+1,s[a-1][o]+1);return s[n.length][r.length]}static incrementTemplateUsage(r){const n=this.getStoredTemplates(),s=n.find(a=>a.id===r);s&&(s.useCount++,s.lastUsed=new Date().toISOString(),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(n)))}}it(Ye,"STORAGE_KEY","fireems_field_mapping_templates"),it(Ye,"VERSION","1.0.0");const Sr=({currentTemplate:t,setCurrentTemplate:r,setTemplateDirty:n,onTemplateApplied:s,disabled:a=!1,currentMappings:o=[],sourceFields:l=[],sampleData:p=[],targetTool:u="",onApplyFieldMappings:d})=>{const[h,x]=M.useState(null),[v,F]=M.useState(!1),[$,w]=M.useState(!1),[Y,_]=M.useState(t.name),[q,U]=M.useState(t.description||""),[C,G]=M.useState([]),[X,J]=M.useState([]),[i,c]=M.useState(""),[y,A]=M.useState(""),{loadTemplates:P,deleteTemplate:E,saveToServer:k}=js(t,!1);M.useEffect(()=>{const b=P();G(b),l.length>0&&u&&p.length>0&&ie()},[l,u,p]);const ie=()=>{try{const b=Ye.suggestTemplates(l,p,u);J(b);const m=Ye.generateCADSignature(l);c(m)}catch(b){console.error("Error loading template suggestions:",b)}},R=b=>{x(b.currentTarget)},L=()=>{x(null)},se=()=>{const b=t.name==="Untitled Mapping"?N():t.name;_(b),U(t.description||""),F(!0),L()},g=()=>{const b=P();G(b),w(!0),L()},V=async()=>{try{if(o.length>0&&l.length>0&&u)await Ye.saveTemplate(Y,q,o,l,p,u,y||void 0,i||void 0);else{const m={...t,name:Y,description:q,lastModified:Date.now()};r(m),k()}n(!1);const b=P();G(b),F(!1)}catch(b){console.error("Error saving template:",b)}},O=b=>{r(b),n(!1),s&&s(b),w(!1)},B=b=>{try{const m=Ye.applyTemplate(b,l);d&&d(m),w(!1)}catch(m){console.error("Error applying template:",m)}},D=b=>{E(b);const m=P();G(m)},T=b=>{const m={...b,id:`template-${Date.now()}`,name:`${b.name} (Copy)`,lastModified:Date.now()};localStorage.setItem(`tmpl:${m.id}`,JSON.stringify(m));const z=P();G(z)},S=b=>{const m=new Date(b),W=(new Date().getTime()-m.getTime())/(1e3*60*60);return W<24?`${Math.floor(W)} hours ago`:W<24*7?`${Math.floor(W/24)} days ago`:m.toLocaleDateString()},K=b=>{const m=b.name.toLowerCase(),z=(b.description||"").toLowerCase(),W=`${m} ${z}`;return W.includes("tyler")||W.includes("cad")?"CAD System":W.includes("monthly")||W.includes("export")?"Monthly Report":W.includes("response")||W.includes("time")?"Response Time":W.includes("fire")||W.includes("map")?"Fire Map":W.includes("test")||W.includes("sample")?"Test Data":"General"},H=b=>{switch(b){case"CAD System":return"primary";case"Monthly Report":return"success";case"Response Time":return"info";case"Fire Map":return"warning";case"Test Data":return"secondary";default:return"secondary"}},I=C.reduce((b,m)=>{const z=m.toolId||"unknown";return b[z]||(b[z]=[]),b[z].push(m),b},{}),N=()=>{const b=t.toolId||"Tool",m=new Date,z=m.toLocaleDateString("en-US",{month:"long"});if(t.mappings.length>0){const W=t.mappings.map(Z=>Z.sourceField.toLowerCase());if(W.some(Z=>Z.includes("tyler")))return`Tyler CAD Export - ${z} ${m.getFullYear()}`;if(W.some(Z=>Z.includes("dispatch")||Z.includes("call")))return`${b} Monthly Export - ${z}`}return`${b} Mapping Template`};return e.jsxs(e.Fragment,{children:[e.jsx(ze,{title:a?"Complete field mapping to access templates":"Save and load field mapping templates",children:e.jsx("span",{children:e.jsx(oe,{variant:"outlined",size:"small",onClick:R,startIcon:e.jsx(Ht,{}),disabled:a,children:"Templates"})})}),e.jsxs(Ls,{anchorEl:h,open:!!h,onClose:L,children:[e.jsxs(re,{onClick:se,children:[e.jsx(rs,{fontSize:"small",sx:{mr:1}}),"Save Template As..."]}),e.jsxs(re,{onClick:g,children:[e.jsx(Ht,{fontSize:"small",sx:{mr:1}}),"Load Template"]}),e.jsxs(re,{onClick:()=>{gt();const b=P();G(b),console.log("🌱 Vendor templates seeded manually")},children:[e.jsx(Et,{fontSize:"small",sx:{mr:1}}),"Load Vendor Templates"]})]}),e.jsxs(Ke,{open:v,onClose:()=>F(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Xe,{children:"Save Mapping Template"}),e.jsxs(Ze,{children:[e.jsx(ue,{severity:"info",sx:{mb:3},children:e.jsx(f,{variant:"body2",children:"Save this field mapping configuration for future use. Templates help you quickly map data from the same source system."})}),e.jsx(Te,{autoFocus:!0,margin:"dense",label:"Template Name",fullWidth:!0,value:Y,onChange:b=>_(b.target.value),sx:{mb:2},placeholder:"e.g., Tyler CAD Monthly Export, Fire Map Pro Standard"}),e.jsx(Te,{margin:"dense",label:"Description (optional)",fullWidth:!0,multiline:!0,rows:2,value:q,onChange:b=>U(b.target.value),placeholder:"e.g., Standard monthly incident export from Tyler Technologies CAD system"}),o.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(Te,{margin:"dense",label:"Department Name (optional)",fullWidth:!0,value:y,onChange:b=>A(b.target.value),placeholder:"e.g., Houston Fire Department",sx:{mt:2}}),e.jsxs(Te,{margin:"dense",label:"CAD Vendor",fullWidth:!0,select:!0,value:i,onChange:b=>c(b.target.value),sx:{mt:2},children:[e.jsx(re,{value:"Console One",children:"Console One"}),e.jsx(re,{value:"Tyler",children:"Tyler Technologies"}),e.jsx(re,{value:"Hexagon",children:"Hexagon/Intergraph"}),e.jsx(re,{value:"TriTech",children:"TriTech/CentralSquare"}),e.jsx(re,{value:"Other",children:"Other"})]})]}),e.jsx(bt,{variant:"outlined",sx:{mt:2},children:e.jsxs(jt,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Template Preview"}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Tool: ",t.toolId||"Unknown"]}),e.jsxs(f,{variant:"body2",color:"text.secondary",children:["Mappings: ",t.mappings.length," field mappings"]}),t.mappings.length>0&&e.jsx(j,{sx:{mt:1},children:e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Sample mappings: ",t.mappings.slice(0,3).map(b=>`${b.sourceField} → ${b.targetField}`).join(", "),t.mappings.length>3&&` +${t.mappings.length-3} more`]})})]})})]}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:()=>F(!1),children:"Cancel"}),e.jsx(oe,{onClick:V,variant:"contained",children:"Save Template"})]})]}),e.jsxs(Ke,{open:$,onClose:()=>w(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Xe,{children:"Load Mapping Template"}),e.jsxs(Ze,{children:[X.length>0&&e.jsxs(j,{sx:{mb:4},children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(qn,{sx:{mr:1,fontSize:20}}),"Smart Template Suggestions",e.jsx(le,{label:X.length,size:"small",sx:{ml:1}})]}),e.jsx(ue,{severity:"success",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:["Found ",X.length," template",X.length!==1?"s":""," that match your data structure. These are pre-configured for your CAD system type."]})}),e.jsx(Ve,{children:X.map((b,m)=>{var z;return e.jsx(Fe,{component:"button",onClick:()=>B(b.template),sx:{py:2,borderRadius:1,mb:1,border:1,borderColor:b.similarityScore>=80?"success.main":"divider","&:hover":{backgroundColor:"action.hover"}},children:e.jsx(De,{primary:e.jsxs(st,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsxs(j,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(f,{variant:"subtitle1",children:b.template.name}),((z=b.template.metadata.tags)==null?void 0:z.includes("certified"))&&e.jsx(le,{icon:e.jsx(sr,{}),label:"Certified",color:"primary",size:"small",variant:"filled"})]}),e.jsx(le,{label:`${b.similarityScore}% match`,color:b.similarityScore>=80?"success":b.similarityScore>=60?"warning":"default",size:"small"}),b.template.cadVendor&&e.jsx(le,{label:b.template.cadVendor,size:"small",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(f,{variant:"body2",sx:{mb:.5},children:b.template.description}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:["Matching fields: ",b.matchingFields.join(", ")]}),b.missingFields.length>0&&e.jsxs(f,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["Missing: ",b.missingFields.slice(0,3).join(", "),b.missingFields.length>3&&` +${b.missingFields.length-3} more`]})]})})},b.template.id)})})]}),C.length===0&&X.length===0?e.jsxs(j,{sx:{textAlign:"center",py:4},children:[e.jsx(Et,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(f,{variant:"h6",gutterBottom:!0,children:"No saved templates found"}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Templates save your field mapping configurations for reuse with similar data exports."}),e.jsx(ue,{severity:"info",children:e.jsxs(f,{variant:"body2",children:[e.jsx("strong",{children:"Pro Tip:"})," After mapping fields for your CAD system, save it as a template. Next month's export will auto-map instantly!"]})})]}):C.length>0&&e.jsxs(j,{children:[X.length>0&&e.jsxs(f,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mt:2},children:[e.jsx($t,{sx:{mr:1,fontSize:20}}),"Your Saved Templates"]}),e.jsx(ue,{severity:"success",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:["Found ",C.length," saved template",C.length!==1?"s":"",". Click any template to apply its field mappings instantly."]})}),Object.entries(I).map(([b,m])=>e.jsxs(j,{sx:{mb:3},children:[e.jsxs(f,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(Et,{sx:{mr:1,fontSize:20}}),b==="unknown"?"General Templates":`${b} Templates`,e.jsx(le,{label:m.length,size:"small",sx:{ml:1}})]}),e.jsx(Ve,{children:m.map(z=>{var W;return e.jsx(Je.Fragment,{children:e.jsxs(Fe,{component:"button",onClick:()=>O(z),sx:{py:2,borderRadius:1,mb:1,"&:hover":{backgroundColor:"action.hover"}},children:[e.jsx(De,{primary:e.jsxs(st,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(f,{variant:"subtitle1",children:z.name}),e.jsx(le,{label:K(z),size:"small",color:H(K(z)),variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[z.description&&e.jsx(f,{variant:"body2",sx:{mb:.5},children:z.description}),e.jsxs(st,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(f,{variant:"caption",color:"text.secondary",sx:{display:"flex",alignItems:"center"},children:[e.jsx($t,{sx:{fontSize:12,mr:.5}}),S(z.lastModified)]}),e.jsxs(f,{variant:"caption",color:"text.secondary",children:[((W=z.mappings)==null?void 0:W.length)||0," field mappings"]})]}),z.mappings&&z.mappings.length>0&&e.jsxs(f,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:["Fields: ",z.mappings.slice(0,2).map(Z=>Z.sourceField).join(", "),z.mappings.length>2&&` +${z.mappings.length-2} more`]})]})}),e.jsxs(wt,{children:[e.jsx(ze,{title:"Duplicate template",children:e.jsx(Ae,{edge:"end",onClick:Z=>{Z.stopPropagation(),T(z)},sx:{mr:1},children:e.jsx(Zn,{fontSize:"small"})})}),e.jsx(ze,{title:"Delete template",children:e.jsx(Ae,{edge:"end",onClick:Z=>{Z.stopPropagation(),D(z.id)},children:e.jsx(rt,{fontSize:"small"})})})]})]})},z.id)})})]},b))]})]}),e.jsx(Qe,{children:e.jsx(oe,{onClick:()=>w(!1),children:"Cancel"})})]})]})},Cr=(t,r)=>{if(!r)return t;const n=[...r.requiredFields,...r.optionalFields];if(n.find(o=>o.id===t))return console.log(`✅ Field ID already correct: "${t}"`),t;const a=n.find(o=>o.name===t);return a?(console.log(`🔄 Converting display name "${t}" to field ID "${a.id}"`),a.id):(console.warn(`⚠️ Unknown target field: "${t}" - keeping as-is`),t)},Jt=(t,r)=>{if(!r||!t)return t;console.log("🔄 Starting field mapping migration...");const n=t.map(s=>{const a=s.targetField,o=Cr(s.targetField,r);return a!==o&&console.log(`📋 Migrating: "${s.sourceField}" → "${a}" becomes "${s.sourceField}" → "${o}"`),{...s,targetField:o}});return console.log("✅ Field mapping migration complete"),n},Kt=(t,r)=>{if(!r||!t)return{isConsistent:!0,issues:[]};const n=[...r.requiredFields,...r.optionalFields],s=[];return t.forEach(a=>{const o=n.some(p=>p.id===a.targetField),l=n.some(p=>p.name===a.targetField);l&&!o?s.push(`Mapping "${a.sourceField}" → "${a.targetField}" uses display name instead of field ID`):!o&&!l&&s.push(`Mapping "${a.sourceField}" → "${a.targetField}" targets unknown field`)}),{isConsistent:s.length===0,issues:s}},Xt=t=>{if(!t||typeof t!="string")return{longitude:null,latitude:null};const r=t.trim(),n=[/^POINT\s*\(\s*(-?\d+\.?\d*)\s+(-?\d+\.?\d*)\s*\)$/i,/^POINT\s*\(\s*(-?\d+\.?\d*)\s*,\s*(-?\d+\.?\d*)\s*\)$/i,/^POINT\s*\(\s*(-?\d+\.?\d*)\s+(-?\d+\.?\d*)\s*\)$/i];for(const s of n){const a=r.match(s);if(a){const o=parseFloat(a[1]),l=parseFloat(a[2]);if(o>=-180&&o<=180&&l>=-90&&l<=90)return console.log(`🌍 POINT COORDINATE PARSING: "${t}" → Longitude: ${o}, Latitude: ${l}`),{longitude:o,latitude:l};console.warn(`🌍 POINT COORDINATE PARSING: Invalid coordinate ranges - Longitude: ${o}, Latitude: ${l}`)}}return console.log(`🌍 POINT COORDINATE PARSING FAILED: Could not extract coordinates from "${t}"`),{longitude:null,latitude:null}},Fr=t=>{if(!t||typeof t!="string")return{city:null,state:null};const r=t.trim(),n=new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]),s=[/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s+\d{5}(?:-\d{4})?\s*$/,/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s*$/,/^.+,\s*([A-Za-z][A-Za-z\s]+?),?\s+([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/,/^.+\s{2,}([A-Za-z][A-Za-z\s]+?)\s{2,}([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/];for(const l of s){const p=r.match(l);if(p){let u=p[1].trim();const d=p[2].trim();if(n.has(d)&&u.length>=2&&u.length<=50){const h=/\b(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i;if(u=u.replace(h,"").trim(),u.length>=2)return console.log(`🏠 ENHANCED ADDRESS PARSING: "${t}" → City: "${u}", State: "${d}"`),{city:u,state:d}}}}const a=new RegExp("\\s+([A-Z]{2})(?:\\s+\\d{5}(?:-\\d{4})?)?\\s*$"),o=r.match(a);if(o){const l=o[1];if(n.has(l)){const d=r.substring(0,r.lastIndexOf(l)).trim().split(/\s+/).slice(-3).filter(h=>!/^\d+$/.test(h)&&!/^(north|south|east|west|n|s|e|w)$/i.test(h)&&!/^(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i.test(h));if(d.length>0){const h=d.join(" ");if(h.length>=2&&h.length<=50)return console.log(`🏠 FALLBACK ADDRESS PARSING: "${t}" → City: "${h}", State: "${l}"`),{city:h,state:l}}}}return console.log(`🏠 ADDRESS PARSING FAILED: Could not extract city/state from "${t}"`),{city:null,state:null}},Dr=t=>({incident_id:["incident_number","incidentnumber","incident_num","inc_num","incnum","case_number","call_number","event_id","event_number","report_number","incidentnum","eventnum"],incident_time:["call_received_time","callreceivedtime","received_time","call_time","incident_datetime","receive_time","time_received","incident_date","inc_date_time","alarm_time","calldatetime","call_datetime"],arrival_time:["arrive_time","arrivetime","on_scene_time","onscenetime","scene_time","arrival_datetime","on_scene_datetime","arrivaldatetime","onscenetime"],dispatch_time:["dispatched_time","dispatchedtime","dispatch_datetime","notification_time","notified_time","dispatchdatetime"],enroute_time:["en_route_time","enroutetime","turnout_time","turnouttime","responding_time","travel_start_time","enroutedatetime"],clear_time:["cleared_time","clearedtime","clear_datetime","back_in_service_time","available_time","service_time","unit_clear_time","cleardatetime"],latitude:["lat","y_coord","y_coordinate","gps_lat","coord_y","ycoord"],longitude:["lng","lon","long","x_coord","x_coordinate","gps_lng","gps_lon","coord_x","xcoord"],address:["incident_address","location","street_address","full_address","addr","locationaddress"],responding_unit:["unit","primary_unit","first_unit","apparatus","resource","unit_id","responding_units","primaryunit"],incident_type:["inc_type_code","inctypecode","inc_type_desc","inctypedesc","call_type","emergency_type","event_type","nature_code","problem_type","incidenttype","incidentcategory","calltype"],zip_code:["zip","zipcode","postal_code","postcode","locationzip"],city:["incident_city","location_city","locationcity"],state:["incident_state","location_state","locationstate"],priority:["incident_priority","call_priority","priority_level"],disposition:["incident_disposition","final_disposition","outcome","incident_outcome"],district:["response_district","fire_district","service_district","districts"],cross_streets:["cross_street","nearest_intersection","intersection"]})[t]||[],Ar=()=>{const t=at(),{sourceColumns:r,sampleData:n,selectedTool:s,mappings:a,processingStatus:o}=Be(T=>T.formatter),[l,p]=M.useState({id:`template-${Date.now()}`,name:"Untitled Mapping",toolId:(s==null?void 0:s.id)||"",mappings:a||[],lastModified:Date.now()}),[u,d]=M.useState(!1),[h,x]=M.useState([]),[v,F]=M.useState(!1),[$,w]=M.useState([]),[Y,_]=M.useState({message:"",severity:"info",open:!1}),[q,U]=M.useState(""),[C,G]=M.useState(""),[X,J]=M.useState(!1),i=s||void 0,{saveToServer:c,autoSaveTemplate:y,findSimilarTemplates:A,getTemplateStats:P,cleanupAutoSaved:E}=js(l,u),k=P();M.useEffect(()=>{Object.keys(localStorage).filter(S=>S.startsWith("tmpl:")).forEach(S=>{var H;const K=localStorage.getItem(S);if(K)try{((H=JSON.parse(K).mappings)==null?void 0:H.some(b=>b.targetField&&b.targetField.includes(" ")))&&(console.log(`🔧 CLEARING OUTDATED TEMPLATE: ${S} (uses display names instead of field IDs)`),localStorage.removeItem(S))}catch{console.log(`🔧 CLEARING CORRUPTED TEMPLATE: ${S}`),localStorage.removeItem(S)}})},[]),M.useEffect(()=>{console.log("Redux mappings changed:",a),p(T=>{const S={...T,mappings:[...a],lastModified:Date.now()};return console.log("Updated template with Redux mappings:",S),S}),a.length>0&&d(!0)},[a]),M.useEffect(()=>{if(!i||!a||a.length===0)return;console.log("🔄 Checking for legacy mappings that need migration...");const T=Kt(a,i);if(T.isConsistent)console.log("✅ All mappings already use field IDs - no migration needed");else{console.log("🔄 Legacy mappings detected - auto-migrating to field IDs"),console.log("Issues found:",T.issues);const S=Jt(a,i);JSON.stringify(a)!==JSON.stringify(S)&&(console.log("✅ Auto-migration complete - updating mappings"),t(Me(S)))}},[i,a==null?void 0:a.length]),M.useEffect(()=>{L()},[a,i]);const ie=T=>{console.log("handleMappingChange called with:",T);try{const S=[...a],K=S.findIndex(H=>H.targetField===T.targetField);K>=0?(console.log(`Updating existing mapping for ${T.targetField}`),S[K]=T):(console.log(`Adding new mapping for ${T.targetField}`),S.push(T)),t(Me(S)),console.log("Mapping updated successfully:",T),_({message:`Mapped ${T.sourceField} to ${T.targetField}`,severity:"success",open:!0})}catch(S){console.error("Error updating mapping:",S)}},R=T=>{console.log("handleRemoveMapping called for:",T);try{const S=a.filter(K=>K.targetField!==T);t(Me(S)),console.log(`Mapping for ${T} removed successfully`)}catch(S){console.error("Error removing mapping:",S)}},L=()=>{if(!i)return;console.log("🔍 FIELD MAPPING AUDIT - Current State Analysis:"),console.log("=========================================="),console.log("📋 Tool Configuration:"),console.log("  Required Fields:",i.requiredFields.map(I=>({id:I.id,name:I.name}))),console.log("  Optional Fields:",i.optionalFields.map(I=>({id:I.id,name:I.name}))),console.log("🗺️ Current Mappings:"),console.log("  Mappings Array:",a.map(I=>({source:I.sourceField,target:I.targetField})));const T=[...i.requiredFields,...i.optionalFields],S=a.map(I=>{const N=T.find(m=>m.id===I.targetField),b=T.find(m=>m.name===I.targetField);return{source:I.sourceField,target:I.targetField,isFieldId:!!N,isDisplayName:!!b,shouldBeFieldId:b?b.id:I.targetField}});console.log("🔍 Mapping Analysis:"),S.forEach(I=>{console.log(`  "${I.source}" → "${I.target}"`),console.log(`    - Is Field ID: ${I.isFieldId}`),console.log(`    - Is Display Name: ${I.isDisplayName}`),I.isDisplayName&&!I.isFieldId&&console.log(`    - ⚠️ PROBLEM: Should be "${I.shouldBeFieldId}" instead`)});const K=a.find(I=>I.targetField==="Call Received Date/Time");K&&(console.log("🚨 SPECIFIC ISSUE DETECTED:"),console.log(`  Mapping: "${K.sourceField}" → "${K.targetField}"`),console.log(`  Should be: "${K.sourceField}" → "incident_time"`)),console.log("==========================================");const H=[];i.requiredFields.forEach(I=>{const N=a.find(m=>m.targetField===I.id),b=a.find(m=>m.targetField===I.name);if(console.log(`Checking required field ${I.id} (display: ${I.name})`),console.log(`  - Mapping by ID: ${N?`"${N.sourceField}" → ${N.targetField}`:"none"}`),console.log(`  - Mapping by Name: ${b?`"${b.sourceField}" → ${b.targetField}`:"none"}`),N)console.log(`  ✅ Correct mapping found for ${I.id}`);else if(b){console.log(`  🔄 Legacy mapping detected for ${I.id} - migrating from display name to field ID`);const m=a.findIndex(z=>z.targetField===I.name);if(m>=0){const z=[...a];z[m]={...z[m],targetField:I.id},console.log(`  📋 Auto-migrated: "${I.name}" → "${I.id}"`),t(Me(z))}}else console.log(`  ❌ No mapping found for required field ${I.id}`),H.push({field:I.id,message:`Required field ${I.name} is not mapped`,severity:"error"})}),w(H)},se=async()=>{if(console.log("🔥🔥🔥 AUTO MAP BUTTON CLICKED - DEBUG START"),console.log("🔥 sourceColumns available:",!!r,"length:",r==null?void 0:r.length),console.log("🔥 toolConfig available:",!!i,"id:",i==null?void 0:i.id),!r||!i){console.log("🚨 AUTO MAP BLOCKED: Missing sourceColumns or toolConfig"),console.log("  - sourceColumns:",r),console.log("  - toolConfig:",i);return}console.log("✅ AUTO MAP PROCEEDING: All conditions met"),F(!0);try{console.log("🔧 AUTO-MAPPING - Starting with systematic fix approach");const S=[...Jt(l.mappings,i)],K=m=>S.some(z=>z.targetField===m),H=m=>m.toLowerCase().replace(/[\s_-]/g,""),I=[...i.requiredFields,...i.optionalFields];console.log("🔧 AUTO-MAPPING - Available target fields:",I.map(m=>({id:m.id,name:m.name}))),console.log("🔧 AUTO-MAPPING - Source columns:",r),console.log("🔧 AUTO-MAPPING - Tool config details:",{toolId:i.id,requiredCount:i.requiredFields.length,optionalCount:i.optionalFields.length,totalFields:I.length,optionalFieldsList:i.optionalFields.map(m=>m.id)}),console.log(`
🕐 === SMART DATETIME DETECTION: Phase 1 Implementation ===`);const N=kn(r,n||[]);console.log("🕐 Detection result:",{type:N.pattern.type,confidence:N.pattern.confidence,description:N.pattern.description}),N.pattern.confidence>.5?(console.log("✅ High confidence datetime pattern detected - applying smart mappings"),N.suggestedMappings.forEach(m=>{if(!I.some(Z=>Z.id===m.targetField)){console.log(`⚠️ Skipping suggestion for ${m.targetField} - not in tool config`);return}if(K(m.targetField)){console.log(`🔄 Target ${m.targetField} already mapped - skipping automatic datetime mapping`);return}const W=m.sourceFields[0];m.transformationType==="combine"?(console.log(`🕐 DATETIME COMBINE: Adding mapping "${W}" → "${m.targetField}" (will combine with ${m.sourceFields.join(" + ")})`),S.push({sourceField:W,targetField:m.targetField,transformations:[{type:"datetime_combine",params:{sourceFields:m.sourceFields,description:m.description}}]})):m.transformationType==="extract"?(console.log(`🕐 DATETIME EXTRACT: Adding mapping "${W}" → "${m.targetField}" (will extract date/time component)`),S.push({sourceField:W,targetField:m.targetField,transformations:[{type:"datetime_extract",params:{extractType:m.targetField.includes("date")?"date":"time",description:m.description}}]})):(console.log(`🕐 DATETIME DIRECT: Adding direct mapping "${W}" → "${m.targetField}"`),S.push({sourceField:W,targetField:m.targetField}))}),console.log("🕐 Smart datetime mappings applied:",S.filter(m=>{var z;return(z=m.transformations)==null?void 0:z.some(W=>W.type.startsWith("datetime_"))}).length)):console.log("⚠️ Low confidence datetime pattern - proceeding with standard auto-mapping"),console.log(`🕐 === DATETIME DETECTION COMPLETE - Proceeding with standard field mapping ===
`),I.forEach(m=>{console.log(`
🎯 === DEBUGGING TARGET FIELD: ${m.id} (display: "${m.name}") ===`),console.log("🎯 Target field info:",{id:m.id,name:m.name,dataType:m.dataType}),K(m.id)&&console.log(`🔄 Target field ${m.id} already mapped - checking for dual mapping opportunity`),console.log("🔍 Available source columns for matching:",r),console.log(`🔍 Attempting to map target field: ${m.id} (display: ${m.name})`),console.log(`🔍 STEP 1: Trying exact match with display name "${m.name}"`);const z=r.find(te=>te.toLowerCase()===m.name.toLowerCase());if(console.log("🔍 Exact match result:",z?`FOUND: "${z}"`:"NOT FOUND"),z){S.find(Q=>Q.sourceField===z&&Q.targetField===m.id)?console.log(`🔄 Dual mapping already exists: "${z}" → ${m.id}`):(console.log(`✅ EXACT MATCH SUCCESS: "${z}" → ${m.id}`),S.push({sourceField:z,targetField:m.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${m.id} (exact match) ===
`);return}console.log("🔍 STEP 2: Trying normalized match with display name");const W=H(m.name);console.log(`🔍 Normalized target name: "${m.name}" → "${W}"`);const Z=r.find(te=>{const Q=H(te);return console.log(`🔍   Testing source "${te}" → "${Q}" against "${W}"`),Q===W});if(console.log("🔍 Normalized match result:",Z?`FOUND: "${Z}"`:"NOT FOUND"),Z){S.find(Q=>Q.sourceField===Z&&Q.targetField===m.id)?console.log(`🔄 Dual mapping already exists: "${Z}" → ${m.id}`):(console.log(`✅ NORMALIZED MATCH SUCCESS: "${Z}" → ${m.id}`),S.push({sourceField:Z,targetField:m.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${m.id} (normalized match) ===
`);return}console.log("🔍 STEP 3: Trying normalized match with field ID");const ae=H(m.id);console.log(`🔍 Normalized field ID: "${m.id}" → "${ae}"`);const ne=r.find(te=>{const Q=H(te);return console.log(`🔍   Testing source "${te}" → "${Q}" against "${ae}"`),Q===ae});if(console.log("🔍 Field ID match result:",ne?`FOUND: "${ne}"`:"NOT FOUND"),ne){S.find(Q=>Q.sourceField===ne&&Q.targetField===m.id)?console.log(`🔄 Dual mapping already exists: "${ne}" → ${m.id}`):(console.log(`✅ FIELD ID MATCH SUCCESS: "${ne}" → ${m.id}`),S.push({sourceField:ne,targetField:m.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${m.id} (field ID match) ===
`);return}console.log("🔍 STEP 4: Trying field variation matching");const Ee=Dr(m.id);console.log(`🔍 Field variations for ${m.id}:`,Ee);let ee;for(const te of Ee)if(console.log(`🔍   Testing variation: "${te}"`),ee=r.find(Q=>{const ce=H(Q),ge=H(te);return console.log(`🔍     Source "${Q}" → "${ce}" vs variation "${ge}"`),ce===ge}),ee){console.log(`🔍   VARIATION MATCH FOUND: "${ee}" via variation "${te}"`),S.find(ce=>ce.sourceField===ee&&ce.targetField===m.id)?console.log(`🔄 Dual mapping already exists: "${ee}" → ${m.id}`):(console.log(`✅ FIELD VARIATION SUCCESS: "${ee}" → ${m.id} (via variation "${te}")`),S.push({sourceField:ee,targetField:m.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${m.id} (variation match) ===
`);return}console.log(`🔍 No variation matches found for ${m.id}`),console.log(`❌ NO MATCH FOUND for target field: ${m.id}`),console.log(`🎯 === COMPLETED TARGET FIELD: ${m.id} (no match) ===
`);const Se=r.map(H).findIndex(te=>te.includes(W)||W.includes(te));if(Se>=0){console.log(`✅ Partial match found: "${r[Se]}" → ${m.id}`),S.push({sourceField:r[Se],targetField:m.id});return}if((m.id==="city"||m.id==="state")&&!K(m.id)){const te=r.find(Q=>H(Q).includes("address")||H(Q).includes("location")||H(Q).includes("addr"));if(te&&n&&n.length>0){const Q=n[0][te];if(typeof Q=="string"&&Q.trim()){const ce=Fr(Q);if(m.id==="city"&&ce.city){console.log(`🏠 Smart address parsing: Extracting city "${ce.city}" from "${te}"`),S.push({sourceField:te,targetField:m.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Za-z\\s]+)\\s+[A-Z]{2}\\s*$",description:"Extract city from full address"}}]});return}if(m.id==="state"&&ce.state){console.log(`🏠 Smart address parsing: Extracting state "${ce.state}" from "${te}"`),S.push({sourceField:te,targetField:m.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Z]{2})\\s*$",description:"Extract state from full address"}}]});return}}}}if(console.log(`🌍 COORDINATE PARSING ENTRY: Checking if ${m.id} is longitude/latitude`,m.id==="longitude"||m.id==="latitude"),m.id==="longitude"||m.id==="latitude")if(console.log(`🌍 COORDINATE PARSING DEBUG: Evaluating ${m.id} field`),console.log("🌍 COORDINATE PARSING DEBUG: Field already mapped?",K(m.id)),console.log("🌍 COORDINATE PARSING DEBUG: Current mappings:",S.filter(te=>te.targetField===m.id)),K(m.id))console.log(`🌍 COORDINATE PARSING DEBUG: ${m.id} field already mapped - skipping coordinate parsing`);else{console.log(`🌍 COORDINATE PARSING DEBUG: Checking ${m.id} field for coordinate opportunities`),console.log("🌍 COORDINATE PARSING DEBUG: Available source columns:",r),console.log("🌍 COORDINATE PARSING DEBUG: Sample data available:",!!n&&n.length>0);const te=r.find(Q=>H(Q).includes("geom")||H(Q).includes("geometry")||H(Q).includes("point")||H(Q).includes("coordinates")||H(Q).includes("coord"))||r.find(Q=>H(Q).includes("location"));if(console.log("🌍 COORDINATE PARSING DEBUG: Found coordinate field match:",te),te&&n&&n.length>0){const Q=n[0][te];if(console.log("🌍 COORDINATE PARSING DEBUG: Sample coordinate value:",Q),console.log("🌍 COORDINATE PARSING DEBUG: Sample coordinate type:",typeof Q),typeof Q=="string"&&Q.trim()){const ce=Q.trim();console.log(`🌍 COORDINATE PARSING DEBUG: Checking for address text patterns in: "${ce}"`),console.log(`🌍 COORDINATE PARSING DEBUG: Starts with POINT(? ${ce.toUpperCase().startsWith("POINT(")}`);const ge=!ce.toUpperCase().startsWith("POINT(")&&(ce.includes("Dr,")||ce.includes("St,")||ce.includes("Ave,")||ce.includes("Road")||ce.includes("Street")||ce.includes("NE of")||ce.includes("SW of")||ce.includes("SE of")||ce.includes("NW of"));if(console.log(`🌍 COORDINATE PARSING DEBUG: Is address text? ${ge}`),ge){console.log(`🌍 COORDINATE PARSING DEBUG: Skipping "${te}" - contains address text, not POINT coordinates`),console.log("🌍 COORDINATE PARSING DEBUG: Looking for actual geometry field...");const de=r.find(fe=>fe.toLowerCase()==="the_geom");if(de&&n[0][de]){const fe=n[0][de];if(console.log("🌍 COORDINATE PARSING DEBUG: Found the_geom field with value:",fe),typeof fe=="string"&&fe.trim().toUpperCase().startsWith("POINT(")){console.log(`🌍 COORDINATE PARSING DEBUG: Using the_geom instead of ${te}`);const ve=Xt(fe);if(console.log("🌍 COORDINATE PARSING DEBUG: Parsed result from the_geom:",ve),m.id==="longitude"&&ve.longitude!==null){console.log(`🌍 Smart coordinate parsing: Extracting longitude "${ve.longitude}" from "${de}"`),S.push({sourceField:de,targetField:m.id,transformations:[{type:"parseCoordinates",params:{format:"point",component:"longitude",description:"Extract longitude from POINT coordinate data"}}]}),console.log(`🌍 SUCCESS: Added longitude mapping for ${de} → ${m.id}`);return}if(m.id==="latitude"&&ve.latitude!==null){console.log(`🌍 Smart coordinate parsing: Extracting latitude "${ve.latitude}" from "${de}"`),S.push({sourceField:de,targetField:m.id,transformations:[{type:"parseCoordinates",params:{format:"point",component:"latitude",description:"Extract latitude from POINT coordinate data"}}]}),console.log(`🌍 SUCCESS: Added latitude mapping for ${de} → ${m.id}`);return}}}console.log("🌍 COORDINATE PARSING DEBUG: No valid POINT geometry field found");return}console.log("🌍 COORDINATE PARSING DEBUG: Attempting to parse POINT coordinates from:",Q.trim());const je=Xt(Q);if(console.log("🌍 COORDINATE PARSING DEBUG: Parsed result:",je),m.id==="longitude"&&je.longitude!==null){console.log(`🌍 Smart coordinate parsing: Extracting longitude "${je.longitude}" from "${te}"`),S.push({sourceField:te,targetField:m.id,transformations:[{type:"parseCoordinates",params:{format:"point",component:"longitude",description:"Extract longitude from POINT coordinate data"}}]}),console.log(`🌍 SUCCESS: Added longitude mapping for ${te} → ${m.id}`);return}if(m.id==="latitude"&&je.latitude!==null){console.log(`🌍 Smart coordinate parsing: Extracting latitude "${je.latitude}" from "${te}"`),S.push({sourceField:te,targetField:m.id,transformations:[{type:"parseCoordinates",params:{format:"point",component:"latitude",description:"Extract latitude from POINT coordinate data"}}]}),console.log(`🌍 SUCCESS: Added latitude mapping for ${te} → ${m.id}`);return}console.log(`🌍 COORDINATE PARSING DEBUG: No valid coordinates extracted for ${m.id}`)}else console.log("🌍 COORDINATE PARSING DEBUG: Sample coordinate is not a valid string:",Q)}else console.log("🌍 COORDINATE PARSING DEBUG: No coordinate match or sample data unavailable")}console.log(`❌ No match found for target field: ${m.id}`)}),console.log("🔧 AUTO-MAPPING - Final mappings:",S.map(m=>({source:m.sourceField,target:m.targetField})));const b=Kt(S,i);if(b.isConsistent||console.warn("⚠️ AUTO-MAPPING - Consistency issues detected:",b.issues),t(Me(S)),S.length>=3&&(s!=null&&s.id)&&(console.log("🔧 AUTO-SAVING TEMPLATE: Significant mappings detected"),y(S,s.id),E()),s!=null&&s.id){const m=A(S,s.id);x(m.slice(0,3)),console.log("🔧 TEMPLATE SUGGESTIONS:",m.length,"similar templates found")}}finally{F(!1)}},g=async()=>{try{await c(),d(!1)}catch(T){console.error("Failed to save template:",T)}},V=()=>{t(Le(0))},O=()=>{try{t(Ne("transforming")),console.log("🔧 TRANSFORMATION DEBUG: Using Redux mappings directly for transformation"),console.log("Redux mappings:",a),console.log("currentTemplate.mappings:",l.mappings),console.log("Sample data:",n),console.log("🔍 PRE-TRANSFORMATION DEBUG:"),console.log("  Sample data keys:",n.length>0?Object.keys(n[0]):[]),console.log("  Sample data first row:",n[0]),console.log("  Mappings to apply:",a),console.log("  Mappings breakdown:"),a.forEach((S,K)=>{var I;const H=(I=n[0])==null?void 0:I[S.sourceField];console.log(`    ${K+1}. "${S.sourceField}" → "${S.targetField}" | Sample: "${H}"`)});const T=gs(n,a);console.log("✅ Transformed data with latest mappings:",T),console.log("🔍 POST-TRANSFORMATION DEBUG:"),T.length>0&&(console.log("  Transformed data keys:",Object.keys(T[0])),console.log("  Transformed data first row:",T[0]),console.log("  Specific field checks:"),console.log(`    incident_time: "${T[0].incident_time}"`),console.log(`    incident_date: "${T[0].incident_date}"`),console.log(`    incident_id: "${T[0].incident_id}"`)),t(Rs(T)),t(Ne("mapping")),t(Le(2))}catch(T){console.error("Error transforming data:",T),t(Ne("error")),_({message:`Error transforming data: ${T instanceof Error?T.message:"Unknown error"}`,severity:"error",open:!0})}},B=M.useMemo(()=>{if(console.log("Checking if can proceed with validationErrors:",$),console.log("Current mappings:",a),i){const T=i.requiredFields.filter(S=>!a.some(K=>K.targetField===S.id));return console.log("Unmapped required fields:",T),T.length===0}return $.every(T=>T.severity!=="error")},[$,a,i]),D=T=>{var I;T.preventDefault();const S=T.dataTransfer.getData("text/plain");if(!S){_({message:"Drag and drop error: No source field data found",severity:"error",open:!0});return}const H=(I=T.target.closest("[data-target-field]"))==null?void 0:I.getAttribute("data-target-field");if(!H){_({message:"Drag and drop error: No target field found. Try dropping directly on a target field.",severity:"warning",open:!0});return}ie({sourceField:S,targetField:H}),_({message:`Mapped ${S} to ${H}`,severity:"success",open:!0})};return console.log("🏗️ FIELD MAPPING CONTAINER RENDER DEBUG:",{sourceColumns:r,sourceColumnsLength:r==null?void 0:r.length,toolConfig:!!i,processingStatus:o}),r.length?i?o==="uploading"?e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(Ue,{}),e.jsx(f,{sx:{mt:2},children:"Processing file data..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(f,{variant:"h5",children:["Map Fields for ",i.name]}),e.jsxs(st,{direction:"row",spacing:1,children:[e.jsx(oe,{variant:"outlined",size:"small",startIcon:e.jsx(rs,{}),onClick:g,disabled:!u,children:"Save Template"}),e.jsx(Sr,{currentTemplate:l,setCurrentTemplate:T=>{p(T),T.mappings&&T.mappings.length>0&&(t(Me(T.mappings)),_({message:`Applied template "${T.name}" with ${T.mappings.length} field mappings`,severity:"success",open:!0}))},setTemplateDirty:d,disabled:!s||r.length===0,currentMappings:a,sourceFields:r,sampleData:n,targetTool:(s==null?void 0:s.id)||"",onApplyFieldMappings:T=>{t(Me(T)),_({message:`Applied template with ${T.length} field mappings`,severity:"success",open:!0})}})]})]}),h.length>0&&e.jsxs(ue,{severity:"info",sx:{mb:2},children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"💡 Smart Template Suggestions"}),e.jsxs(f,{variant:"body2",sx:{mb:1},children:["Found ",h.length," template",h.length!==1?"s":""," with similar field patterns:"]}),e.jsx(j,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:h.map(T=>e.jsxs(oe,{variant:"outlined",size:"small",onClick:()=>{p(T),t(Me(T.mappings)),d(!1),x([]),_({message:`Applied suggested template "${T.name}"`,severity:"success",open:!0})},sx:{textTransform:"none"},children:[T.name,e.jsxs(f,{component:"span",variant:"caption",sx:{ml:1,opacity:.7},children:["(",T.mappings.length," mappings)"]})]},T.id))})]}),k.total>0&&e.jsx(ue,{severity:"success",sx:{mb:2},children:e.jsxs(f,{variant:"body2",children:["📁 You have ",k.total," saved template",k.total!==1?"s":"","(",k.totalMappings," total field mappings).",k.byTool[(s==null?void 0:s.id)||""]&&e.jsxs("strong",{children:[k.byTool[(s==null?void 0:s.id)||""]," template",k.byTool[(s==null?void 0:s.id)||""]!==1?"s":""," for ",s==null?void 0:s.name]})]})}),e.jsxs(j,{sx:{display:"flex",gap:2,height:"700px",minHeight:"700px",border:"1px solid #eaeaea",borderRadius:"4px",padding:"4px"},children:[e.jsxs(j,{sx:{width:"35%",height:"100%",display:"flex",flexDirection:"column",position:"relative",borderRight:"1px solid #eaeaea",paddingRight:"8px"},children:[e.jsx(f,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Source Fields Panel ↕️ (Scrollable)"}),e.jsx(lr,{sourceColumns:r,filter:q,setFilter:U,mappings:a,sampleData:n,onAddParsedFields:(T,S)=>{if(console.log("🤖 PARENT: Received parsed fields for column:",T,S),n&&n.length>0&&S.length>0){const K=n.map((H,I)=>{const N={...H};return S.forEach(b=>{if(b.data[I]!==null){const m=b.id.split("_").slice(1).join("_"),z=`${T}_parsed_${m}`;N[z]=b.data[I],console.log(`🤖 PARENT: Injecting parsed data: ${z} = "${b.data[I]}"`)}}),N});console.log("🤖 PARENT: Updating Redux sampleData with parsed fields"),t(ns(K)),_({message:`Added ${S.length} parsed fields for ${T}`,severity:"success",open:!0})}}})]}),e.jsxs(j,{sx:{width:"65%",height:"100%",display:"flex",flexDirection:"column",gap:2,overflow:"hidden",position:"relative"},onDragOver:T=>{T.target===T.currentTarget&&(T.preventDefault(),console.log("Parent container dragOver"))},onDrop:T=>{T.target===T.currentTarget&&(T.preventDefault(),D(T),console.log("Parent container drop"))},children:[e.jsx(f,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Target Fields Panel ↕️ (Scrollable)"}),e.jsx(fr,{toolConfig:i,showAllFields:X,setShowAllFields:J,filter:C,setFilter:G,mappings:a,onMappingChange:ie,onRemoveMapping:R,validationErrors:$,sampleData:n,sourceColumns:r}),$.length>0&&e.jsx(j,{sx:{flexShrink:0,marginTop:"auto",borderTop:"1px solid #eaeaea",paddingTop:"8px"},children:e.jsx(xr,{validationErrors:$,jumpToField:T=>{const S=document.getElementById(`target-field-${T}`);S&&(S.scrollIntoView({behavior:"smooth",block:"center"}),S.classList.add("highlight-field"),setTimeout(()=>{S.classList.remove("highlight-field")},2e3))}})})]})]}),e.jsx(ye,{sx:{p:2,mt:2},children:e.jsx(yr,{sampleData:n,mappings:a,toolConfig:i})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(oe,{variant:"outlined",startIcon:e.jsx(tt,{}),onClick:V,children:"Back"}),e.jsxs(j,{children:[console.log("🎯 AUTO MAP BUTTON RENDER STATE:",{autoMappingInProgress:v,sourceColumnsLength:r==null?void 0:r.length,buttonDisabled:v||!r.length,sourceColumns:r}),e.jsx(oe,{variant:"outlined",onClick:T=>{console.log("🚨🚨🚨 AUTO MAP BUTTON CLICKED!!! 🚨🚨🚨"),console.log("🔥 BUTTON CLICK DETECTED - Raw event:",T),console.log("🔥 Button disabled state:",v||!r.length),console.log("🔥 autoMappingInProgress:",v),console.log("🔥 sourceColumns.length:",r.length),console.log("🚨 ABOUT TO CALL handleAutoMap() - DEBUG MARKER"),se(),console.log("🚨 CALLED handleAutoMap() - DEBUG MARKER")},disabled:v||!r.length,sx:{mr:1},children:v?e.jsxs(e.Fragment,{children:[e.jsx(Ue,{size:20,sx:{mr:1}}),"Auto-mapping..."]}):"Auto-Map Fields"}),e.jsx(oe,{variant:"contained",endIcon:e.jsx(Mt,{}),onClick:O,disabled:!B,children:"Continue"})]})]}),e.jsx(hs,{open:Y.open,autoHideDuration:6e3,onClose:()=>_({...Y,open:!1}),children:e.jsx(ue,{onClose:()=>_({...Y,open:!1}),severity:Y.severity,children:Y.message})})]}):e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(ue,{severity:"error",children:"No tool selected. Please select a tool first."}),e.jsx(oe,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(tt,{}),onClick:V,children:"Go Back to Upload"})]}):(console.log("🚨 EARLY RETURN: No source columns available!",r),e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(ue,{severity:"error",children:"No source columns available. Please upload a file first."}),e.jsx(oe,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(tt,{}),onClick:V,children:"Go Back to Upload"})]}))},Ir=({data:t,validationErrors:r,highlightedCell:n})=>{const[s,a]=M.useState(0),[o,l]=M.useState(10),[p,u]=M.useState(""),[d,h]=M.useState("");M.useEffect(()=>{if(n){const C=Math.floor(n.rowIndex/o);C!==s&&a(C)}},[n,o,s]);const x=t.length>0?Object.keys(t[0]):[],v={};r.forEach(C=>{C.rowIndex!==void 0&&(v[C.rowIndex]||(v[C.rowIndex]={}),v[C.rowIndex][C.field]||(v[C.rowIndex][C.field]=[]),v[C.rowIndex][C.field].push(C))});const F=(C,G)=>{a(G)},$=C=>{l(parseInt(C.target.value,10)),a(0)},w=C=>{u(C.target.value),a(0)},Y=C=>{h(C.target.value),a(0)},_=()=>{h(""),a(0)},q=t.filter(C=>{if(!d)return!0;if(p){const G=C[p];return G!==void 0&&String(G).toLowerCase().includes(d.toLowerCase())}return Object.values(C).some(G=>G!==void 0&&String(G).toLowerCase().includes(d.toLowerCase()))}),U=q.slice(s*o,s*o+o);return t.length===0?e.jsx(j,{children:e.jsx(f,{variant:"h6",gutterBottom:!0,children:"No data available for preview"})}):e.jsxs(j,{children:[e.jsx(Os,{styles:{"@keyframes pulse":{"0%":{opacity:.7},"100%":{opacity:1}}}}),e.jsxs(j,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(Te,{label:"Search",value:d,onChange:Y,sx:{flexGrow:1},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(nt,{})}),endAdornment:d&&e.jsx(Oe,{position:"end",children:e.jsx(Ae,{onClick:_,edge:"end",size:"small",children:e.jsx(It,{})})})}}),e.jsxs(_e,{sx:{minWidth:200},children:[e.jsx($e,{id:"filter-field-label",children:"Filter Field"}),e.jsxs(Re,{labelId:"filter-field-label",id:"filter-field",value:p,label:"Filter Field",onChange:w,children:[e.jsx(re,{value:"",children:"All Fields"}),x.map(C=>e.jsx(re,{value:C,children:C},C))]})]})]}),e.jsxs(ye,{sx:{width:"100%",mb:2},children:[e.jsx(At,{sx:{maxHeight:500},children:e.jsxs(dt,{stickyHeader:!0,"aria-label":"data preview table",children:[e.jsx(ut,{children:e.jsxs(Pe,{children:[e.jsx(Ce,{children:"#"}),x.map(C=>e.jsx(Ce,{children:C},C))]})}),e.jsx(pt,{children:U.map((C,G)=>{const X=s*o+G,J=v[X];return e.jsxs(Pe,{hover:!0,sx:{"&:last-child td, &:last-child th":{border:0},backgroundColor:J?"#fff8f8":"inherit"},children:[e.jsx(Ce,{children:X+1}),x.map(i=>{const c=(J==null?void 0:J[i])||[],y=c.length>0,A=n&&n.rowIndex===X&&n.field===i;return e.jsxs(Ce,{sx:{backgroundColor:A?"#fff3e0":y?"#ffebee":"inherit",position:"relative",border:A?"2px solid #ff9800":"inherit",transition:"all 0.3s ease"},children:[C[i]!==void 0?String(C[i]):"",y&&e.jsx(j,{sx:{position:"absolute",top:0,right:0},children:e.jsx(le,{color:"error",size:"small",label:c.length,sx:{height:16,fontSize:"0.6rem"}})}),A&&e.jsx(j,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid #ff9800",borderRadius:"4px",pointerEvents:"none",animation:"pulse 1s ease-in-out infinite alternate"}})]},i)})]},G)})})]})}),e.jsx(Ws,{rowsPerPageOptions:[5,10,25,50,100],component:"div",count:q.length,rowsPerPage:o,page:s,onPageChange:F,onRowsPerPageChange:$})]})]})};class wr{constructor(){it(this,"defaultFields",{})}registerField(r,n){console.log(`Registering default value for ${r}:`,n),this.defaultFields[r]=n}hasDefaultValue(r){return this.defaultFields[r]!==void 0}getDefaultValue(r){return this.defaultFields[r]}registerMappings(r){this.defaultFields={},r.forEach(n=>{if(n.sourceField==="__default__"&&n.transformations){const s=n.transformations.find(a=>a.type==="convert"&&a.params&&a.params.defaultValue!==void 0);s&&s.params.defaultValue!==void 0&&this.registerField(n.targetField,s.params.defaultValue)}}),console.log("Registered default values:",this.defaultFields)}clear(){this.defaultFields={}}}const Zt=new wr,_r=(t,r)=>{const n=[];return t.forEach((s,a)=>{r.forEach(o=>{let l=s[o.name];const p=Zt.hasDefaultValue(o.name);if((l==null||l==="")&&p&&(l=Zt.getDefaultValue(o.name),console.log(`Using default value for validation of ${o.name}:`,l)),o.name==="Incident ID"){o.isRequired&&!p&&(l==null||l==="")&&n.push({rowIndex:a,field:o.name,message:`${o.name} is required`,type:"required"});return}if(o.name.includes("Time")&&typeof l=="string"){o.isRequired&&!p&&(l==null||l==="")&&n.push({rowIndex:a,field:o.name,message:`${o.name} is required`,type:"required"});return}if(o.isRequired&&!p&&(l==null||l==="")){n.push({rowIndex:a,field:o.name,message:`${o.name} is required`,type:"required"});return}if(l==null||l==="")return;const u=$r(l,o.dataType,o.name,a);if(u){n.push(u);return}o.validationRules&&o.validationRules.forEach(d=>{const h=Rr(l,d,o.name,a);h&&n.push(h)})})}),console.log("Validation completed with errors:",n),n},$r=(t,r,n,s)=>{switch(r){case"string":if(typeof t!="string")return{rowIndex:s,field:n,message:`${n} must be a string`,type:"custom"};break;case"number":if(typeof t!="number"&&(typeof t!="string"||isNaN(Number(t))))return{rowIndex:s,field:n,message:`${n} must be a number`,type:"custom"};break;case"date":if(!(typeof t=="string"||t instanceof Date))return{rowIndex:s,field:n,message:`${n} must be a date`,type:"custom"};const a=new Date(t);if(isNaN(a.getTime()))return{rowIndex:s,field:n,message:`${n} contains an invalid date format`,type:"custom"};break;case"boolean":if(typeof t!="boolean"&&t!=="true"&&t!=="false"&&t!=="0"&&t!=="1")return{rowIndex:s,field:n,message:`${n} must be a boolean value`,type:"custom"};break;case"location":if(typeof t=="string"){if(!/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(t))return{rowIndex:s,field:n,message:`${n} must be a valid location format (latitude,longitude)`,type:"custom"}}else if(!t.lat||!t.lng)return{rowIndex:s,field:n,message:`${n} must be a valid location object or string`,type:"custom"};break}return null},Rr=(t,r,n,s)=>{switch(r.type){case"required":break;case"min":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)<r.params.value)return{rowIndex:s,field:n,message:`${n} must be at least ${r.params.value}`,type:"min"}}else if(typeof t=="string"&&t.length<r.params.value)return{rowIndex:s,field:n,message:`${n} must be at least ${r.params.value} characters`,type:"min"};break;case"max":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)>r.params.value)return{rowIndex:s,field:n,message:`${n} must be at most ${r.params.value}`,type:"max"}}else if(typeof t=="string"&&t.length>r.params.value)return{rowIndex:s,field:n,message:`${n} must be at most ${r.params.value} characters`,type:"max"};break;case"pattern":if(typeof t=="string"&&!new RegExp(r.params.regex).test(t))return{rowIndex:s,field:n,message:r.params.message||`${n} does not match the required pattern`,type:"pattern"};break;case"oneOf":const a=r.params.values;if(!a.includes(t))return{rowIndex:s,field:n,message:`${n} must be one of: ${a.join(", ")}`,type:"oneOf"};break;case"custom":if(r.params.validateFn&&typeof r.params.validateFn=="function"&&!r.params.validateFn(t))return{rowIndex:s,field:n,message:r.params.message||`${n} is invalid`,type:"custom"};break}return null},Or=t=>{const r={total:t.length,byType:{},byField:{}};return t.forEach(n=>{r.byType[n.type]||(r.byType[n.type]=0),r.byType[n.type]++,r.byField[n.field]||(r.byField[n.field]=0),r.byField[n.field]++}),r},Ft=t=>{const{children:r,value:n,index:s,...a}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==s,id:`validation-tabpanel-${s}`,"aria-labelledby":`validation-tab-${s}`,...a,children:n===s&&e.jsx(j,{sx:{p:2},children:r})})},Nr=({errors:t,onJumpToError:r})=>{const[n,s]=M.useState(0),[a,o]=M.useState(""),l=Or(t),p=(x,v)=>{s(v)},u=t.filter(x=>x.field.toLowerCase().includes(a.toLowerCase())||x.message.toLowerCase().includes(a.toLowerCase())),d={};u.forEach(x=>{d[x.field]||(d[x.field]=[]),d[x.field].push(x)});const h=x=>{let v="default";switch(x){case"required":v="error";break;case"pattern":case"min":case"max":v="warning";break;case"oneOf":case"custom":v="info";break}return e.jsx(le,{size:"small",label:x,color:v})};return e.jsxs(ye,{sx:{p:0,mb:3},children:[e.jsx(j,{sx:{p:2,bgcolor:t.length>0?"#ffebee":"#e8f5e9",borderRadius:"4px 4px 0 0"},children:e.jsxs(f,{variant:"h6",component:"h3",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ht,{}),"Validation Results",e.jsx(le,{label:`${t.length} ${t.length===1?"error":"errors"}`,color:t.length>0?"error":"success",sx:{ml:2}})]})}),e.jsx(be,{}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:n,onChange:p,"aria-label":"validation tabs",children:[e.jsx(Ie,{label:"Summary",id:"validation-tab-0","aria-controls":"validation-tabpanel-0"}),e.jsx(Ie,{label:"By Field",id:"validation-tab-1","aria-controls":"validation-tabpanel-1"}),e.jsx(Ie,{label:"All Errors",id:"validation-tab-2","aria-controls":"validation-tabpanel-2"})]})}),e.jsx(Ft,{value:n,index:0,children:t.length===0?e.jsx(ue,{severity:"success",children:"No validation errors found. Your data is ready for export!"}):e.jsxs(e.Fragment,{children:[e.jsxs(ue,{severity:"warning",children:["Found ",t.length," validation ",t.length===1?"error":"errors"," that need to be addressed before export."]}),e.jsxs(j,{sx:{mt:2},children:[e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Error Distribution by Field"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:Object.entries(l.byField).map(([x,v])=>e.jsx(le,{label:`${x}: ${v}`,color:"error",variant:"outlined",onClick:()=>s(1)},x))}),e.jsx(f,{variant:"subtitle1",gutterBottom:!0,children:"Error Types"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:Object.entries(l.byType).map(([x,v])=>e.jsx(le,{label:`${x}: ${v}`,color:"primary",variant:"outlined"},x))})]})]})}),e.jsxs(Ft,{value:n,index:1,children:[e.jsx(Te,{fullWidth:!0,placeholder:"Search errors by field or message",value:a,onChange:x=>o(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(nt,{})}),endAdornment:a&&e.jsx(Oe,{position:"end",children:e.jsx(Ae,{onClick:()=>o(""),edge:"end",size:"small",children:e.jsx(It,{})})})}}),Object.keys(d).length===0?e.jsx(ue,{severity:"info",children:"No errors match your search criteria."}):Object.entries(d).map(([x,v])=>e.jsxs(as,{defaultExpanded:Object.keys(d).length===1,children:[e.jsx(is,{expandIcon:e.jsx(xt,{}),children:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[e.jsx(f,{children:x}),e.jsx(le,{size:"small",label:v.length,color:"error",sx:{ml:"auto"}})]})}),e.jsx(ls,{children:e.jsx(Ve,{dense:!0,disablePadding:!0,children:v.map((F,$)=>e.jsxs(Je.Fragment,{children:[$>0&&e.jsx(be,{component:"li"}),e.jsx(Fe,{secondaryAction:F.rowIndex!==void 0&&r&&e.jsx(oe,{size:"small",variant:"outlined",onClick:()=>F.rowIndex!==void 0&&r(F.rowIndex,F.field),children:"Jump to Row"}),children:e.jsx(De,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[F.message,h(F.type)]}),secondary:F.rowIndex!==void 0?`Row ${F.rowIndex+1}`:"Global error"})})]},$))})})]},x))]}),e.jsxs(Ft,{value:n,index:2,children:[e.jsx(Te,{fullWidth:!0,placeholder:"Search errors by field or message",value:a,onChange:x=>o(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Oe,{position:"start",children:e.jsx(nt,{})}),endAdornment:a&&e.jsx(Oe,{position:"end",children:e.jsx(Ae,{onClick:()=>o(""),edge:"end",size:"small",children:e.jsx(It,{})})})}}),e.jsx(Ve,{dense:!0,children:u.length===0?e.jsx(ue,{severity:"info",children:"No errors match your search criteria."}):u.map((x,v)=>e.jsxs(Je.Fragment,{children:[v>0&&e.jsx(be,{component:"li"}),e.jsx(Fe,{secondaryAction:x.rowIndex!==void 0&&r&&e.jsx(oe,{size:"small",variant:"outlined",onClick:()=>x.rowIndex!==void 0&&r(x.rowIndex,x.field),children:"Jump to Row"}),children:e.jsx(De,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(f,{component:"span",sx:{fontWeight:500},children:[x.field,":"]}),x.message,h(x.type)]}),secondary:x.rowIndex!==void 0?`Row ${x.rowIndex+1}`:"Global error"})})]},v))})]})]})},Mr=t=>{switch(t){case"string":return"Default Value";case"number":return"0";case"date":return new Date().toISOString().split("T")[0];case"boolean":return"false";case"location":return"0.0,0.0";default:return""}},Pr=({errors:t,targetFields:r,mappings:n,onAddDefaultValue:s,onJumpToMapping:a})=>{const o=Nt(),[l,p]=M.useState(!1),[u,d]=M.useState(null),[h,x]=M.useState(""),v=M.useMemo(()=>{const _={};return t.forEach(q=>{_[q.field]||(_[q.field]={errors:[],count:0}),_[q.field].errors.push(q),_[q.field].count++}),_},[t]),F=M.useMemo(()=>Object.entries(v).sort((_,q)=>q[1].count-_[1].count).map(([_,q])=>{const U=r.find(i=>i.name===_);if(!U)return null;const C=n.some(i=>i.targetField===_),G=n.some(i=>i.targetField===_&&i.sourceField==="__default__"),X=q.errors.some(i=>i.type==="required");let J="unknown";return X&&!C?J="map_field":X&&!G?J="add_default":!X&&C&&(J="fix_transformation"),{fieldName:_,fieldDef:U,errorCount:q.count,errors:q.errors,hasMapping:C,hasDefaultMapping:G,actionType:J}}).filter(Boolean),[v,r,n]),$=M.useMemo(()=>F.filter(_=>(_==null?void 0:_.actionType)==="add_default").length,[F]),w=_=>{d(_),x(Mr(_.dataType)),p(!0)},Y=()=>{if(!u)return;const _={sourceField:"__default__",targetField:u.name,transformations:[{type:"convert",params:{defaultValue:h,targetType:u.dataType}}]};s(_),p(!1)};return t.length===0?e.jsx(ue,{severity:"success",sx:{my:2},children:"No validation errors detected. Your data is ready for export!"}):e.jsxs(ye,{sx:{p:0,my:2,borderRadius:1,border:`1px solid ${o.palette.divider}`,overflow:"hidden"},elevation:2,children:[e.jsxs(j,{sx:{p:2,bgcolor:o.palette.mode==="dark"?xe(o.palette.error.dark,.2):xe(o.palette.error.light,.1),borderBottom:`1px solid ${o.palette.divider}`},children:[e.jsxs(f,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ht,{color:"error"}),"Validation Solutions",e.jsx(le,{label:`${t.length} ${t.length===1?"issue":"issues"}`,color:"error",size:"small",sx:{ml:1}})]}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:$>0?`${$} ${$===1?"issue":"issues"} can be fixed with default values.`:"Review the suggested actions to resolve validation issues."})]}),e.jsxs(Ve,{sx:{py:0},children:[$>0&&e.jsxs(Fe,{sx:{bgcolor:xe(o.palette.success.light,.1),borderBottom:`1px solid ${o.palette.divider}`,"&:hover":{bgcolor:xe(o.palette.success.light,.2)}},children:[e.jsx(ke,{children:e.jsx(ot,{color:"success"})}),e.jsx(De,{primary:"Fix Required Fields with Default Values",secondary:`Add default values to ${$} unmapped required ${$===1?"field":"fields"}`}),e.jsx(wt,{children:e.jsx(oe,{variant:"outlined",color:"success",size:"small",onClick:()=>{const _=F.find(q=>(q==null?void 0:q.actionType)==="add_default");_!=null&&_.fieldDef&&w(_.fieldDef)},children:"Set Default Values"})})]}),F.map((_,q)=>{var X;if(!_)return null;let U=e.jsx(ht,{color:"error"}),C="error",G="";switch(_.actionType){case"map_field":U=e.jsx(Qn,{color:"info"}),C="info",G="Field requires mapping to source data";break;case"add_default":U=e.jsx(Gt,{color:"success"}),C="success",G="Field requires a value, add a default";break;case"fix_transformation":U=e.jsx(ds,{color:"warning"}),C="warning",G="Field has validation issues with current mapping";break}return e.jsxs(Je.Fragment,{children:[q>0&&e.jsx(be,{}),e.jsxs(Fe,{sx:{py:1.5,"&:hover":{bgcolor:xe(o.palette.primary.light,.05)}},children:[e.jsx(ke,{children:U}),e.jsx(De,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(f,{variant:"subtitle2",children:_.fieldName}),e.jsx(le,{size:"small",label:`${_.errorCount} ${_.errorCount===1?"error":"errors"}`,color:"error",variant:"outlined"}),_.fieldDef&&e.jsx(le,{size:"small",label:_.fieldDef.dataType,color:"default",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(f,{variant:"body2",color:"text.secondary",children:G}),e.jsxs(f,{variant:"caption",color:"error",sx:{display:"block",mt:.5},children:[(X=_.errors[0])==null?void 0:X.message,_.errors.length>1&&` (+ ${_.errors.length-1} more)`]})]})}),e.jsxs(wt,{children:[_.actionType==="add_default"&&_.fieldDef&&e.jsx(oe,{variant:"outlined",color:C,size:"small",startIcon:e.jsx(Gt,{}),onClick:()=>w(_.fieldDef),children:"Add Default"}),(_.actionType==="map_field"||_.actionType==="fix_transformation")&&e.jsx(oe,{variant:"outlined",color:C,size:"small",startIcon:e.jsx(Gs,{}),onClick:()=>a(_.fieldName),children:_.actionType==="map_field"?"Map Field":"Fix Mapping"})]})]})]},_.fieldName)})]}),e.jsxs(Ke,{open:l,onClose:()=>p(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Xe,{children:["Set Default Value for ",u==null?void 0:u.name]}),e.jsx(Ze,{children:e.jsxs(j,{sx:{mt:1},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:u==null?void 0:u.description}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(f,{variant:"caption",children:"Data Type:"}),e.jsx(le,{size:"small",label:u==null?void 0:u.dataType,color:"primary",variant:"outlined"})]}),(u==null?void 0:u.dataType)==="boolean"?e.jsxs(Te,{select:!0,fullWidth:!0,value:h,onChange:_=>x(_.target.value),label:"Default Value",variant:"outlined",margin:"normal",children:[e.jsx(re,{value:"true",children:"True"}),e.jsx(re,{value:"false",children:"False"})]}):e.jsx(Te,{fullWidth:!0,value:h,onChange:_=>x(_.target.value),label:"Default Value",variant:"outlined",margin:"normal",type:(u==null?void 0:u.dataType)==="number"?"number":"text",helperText:`This value will be used for all records where ${u==null?void 0:u.name} is not mapped or empty`})]})}),e.jsxs(Qe,{children:[e.jsx(oe,{onClick:()=>p(!1),children:"Cancel"}),e.jsx(oe,{onClick:Y,variant:"contained",color:"primary",startIcon:e.jsx(ot,{}),children:"Apply Default Value"})]})]})]})},Qt=t=>{const{children:r,value:n,index:s,...a}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==s,id:`preview-tabpanel-${s}`,"aria-labelledby":`preview-tab-${s}`,...a,children:n===s&&e.jsx(j,{sx:{p:2},children:r})})},kr=()=>{const t=at(),{sourceFile:r,transformedData:n,validationErrors:s,selectedTool:a,mappings:o}=Be(C=>C.formatter),[l,p]=M.useState(0),[u,d]=M.useState(!1),[h,x]=M.useState(null),v=M.useRef(null),F=(C,G)=>{p(G)},$=()=>{t(Le(1))},w=()=>{t(Le(3))},Y=()=>{if(!(!n||!a)){d(!0);try{const C=[...a.requiredFields,...a.optionalFields],G=Be(c=>c.formatter.mappings),X={};G&&G.forEach(c=>{if(c.sourceField==="__default__"&&c.transformations){const y=c.transformations.find(A=>A.type==="convert"&&A.params&&A.params.defaultValue!==void 0);y&&(X[c.targetField]=!0,console.log(`Field ${c.targetField} has default value: ${y.params.defaultValue}`))}});const J=n.map(c=>{const y={...c};return Object.keys(X).forEach(A=>{typeof window<"u"&&window.defaultValueRegistry&&window.defaultValueRegistry.register(A,!0)}),y}),i=_r(J,C);t(Ns(i)),i.length===0?t(Ne("complete")):t(Ne("error"))}catch(C){console.error("Validation error:",C),t(Ne("error"))}finally{d(!1)}}},_=(C,G)=>{p(0),x({rowIndex:C,field:G}),setTimeout(()=>{v.current&&v.current.scrollIntoView({behavior:"smooth"})},100),setTimeout(()=>{x(null)},3e3)},q=C=>{console.log("Adding default value mapping:",C),t(Ms(C)),setTimeout(()=>{Y()},100)},U=C=>{t(Le(1))};return M.useEffect(()=>{n&&n.length>0&&Y()},[n]),!n||n.length===0?e.jsxs(ye,{sx:{p:3,textAlign:"center"},children:[e.jsxs(ue,{severity:"warning",sx:{mb:2},children:[e.jsx(pn,{children:"No Data Available"}),"There is no transformed data to preview. Please go back to the field mapping step."]}),e.jsx(oe,{variant:"contained",startIcon:e.jsx(Wt,{}),onClick:$,children:"Back to Field Mapping"})]}):e.jsxs(j,{children:[e.jsx(f,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Preview & Validate Data"}),e.jsx(ye,{sx:{p:2,mb:3},children:e.jsxs(he,{container:!0,spacing:2,children:[e.jsx(he,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(f,{variant:"body1",children:[(r==null?void 0:r.name)||"No file"," (",r==null?void 0:r.type,")"]})]})}),e.jsx(he,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(f,{variant:"body1",children:[n.length," records processed"]})]})}),e.jsx(he,{size:12,children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:u?e.jsxs(e.Fragment,{children:[e.jsx(Ue,{size:20}),e.jsx(f,{children:"Validating data..."})]}):s.length===0?e.jsxs(e.Fragment,{children:[e.jsx(xs,{color:"success"}),e.jsx(f,{color:"success.main",children:"Data validation passed! Ready for export."})]}):e.jsxs(e.Fragment,{children:[e.jsx(nr,{color:"error"}),e.jsxs(f,{color:"error",children:[s.length," validation ",s.length===1?"error":"errors"," found"]})]})})]})})]})}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:l,onChange:F,"aria-label":"preview and validation tabs",children:[e.jsx(Ie,{label:"Data Preview",id:"preview-tab-0","aria-controls":"preview-tabpanel-0"}),e.jsx(Ie,{label:`Validation & Solutions ${s.length>0?`(${s.length})`:""}`,id:"preview-tab-1","aria-controls":"preview-tabpanel-1",sx:{color:s.length>0?"error.main":"inherit"}})]})}),e.jsx(Qt,{value:l,index:0,children:e.jsx(j,{ref:v,children:e.jsx(Ir,{data:n,validationErrors:s,highlightedCell:h})})}),e.jsxs(Qt,{value:l,index:1,children:[s.length>0&&a&&e.jsx(Pr,{errors:s,targetFields:[...a.requiredFields,...a.optionalFields],mappings:o,onAddDefaultValue:q,onJumpToMapping:U}),e.jsx(Nr,{errors:s,onJumpToError:_})]}),e.jsx(be,{sx:{my:3}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(oe,{variant:"outlined",startIcon:e.jsx(Wt,{}),onClick:$,children:"Back to Field Mapping"}),e.jsx(oe,{variant:"contained",endIcon:e.jsx(Mt,{}),onClick:w,disabled:s.length>0,children:"Continue to Export"})]})]})},Lr=({selectedFormat:t,onFormatChange:r})=>{const n=s=>{r(s.target.value)};return e.jsx(bt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(jt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Select Export Format"}),e.jsx(_e,{component:"fieldset",children:e.jsxs(Zs,{"aria-label":"export-format",name:"export-format",value:t,onChange:n,children:[e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="csv"?"primary.main":"divider",borderRadius:1,bgcolor:t==="csv"?"action.hover":"transparent"},children:[e.jsx(We,{value:"csv",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",flexWrap:"wrap",gap:1},children:[e.jsx(Xs,{color:"primary"}),e.jsx(f,{variant:"body1",children:"CSV"}),e.jsx(le,{size:"small",label:"Most Compatible",color:"success"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Comma-separated values format, widely supported by spreadsheet applications like Excel and Google Sheets."})]}),e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="json"?"primary.main":"divider",borderRadius:1,bgcolor:t==="json"?"action.hover":"transparent"},children:[e.jsx(We,{value:"json",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(Xn,{color:"info"}),e.jsx(f,{variant:"body1",children:"JSON"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"JavaScript Object Notation, ideal for programmatic use or importing into other applications."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="excel"?"primary.main":"divider",borderRadius:1,bgcolor:t==="excel"?"action.hover":"transparent"},children:[e.jsx(We,{value:"excel",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(mt,{color:"success"}),e.jsx(f,{variant:"body1",children:"Excel"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Export directly to native Excel format (.xlsx) with proper formatting and column sizing."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="pdf"?"primary.main":"divider",borderRadius:1,bgcolor:t==="pdf"?"action.hover":"transparent"},children:[e.jsx(We,{value:"pdf",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(os,{color:"error"}),e.jsx(f,{variant:"body1",children:"PDF"}),e.jsx(le,{size:"small",label:"Professional",color:"secondary"})]})}),e.jsx(f,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Create a professional PDF document with formatted data table, ideal for reports and presentations."})]})]})})]})})},Dt=[{id:"fire-map-pro",name:"Fire Map Pro",description:"Professional mapping and visualization for incident locations and analysis",icon:e.jsx(Qs,{fontSize:"large",sx:{color:"#dc2626"}}),requiredFields:["incidentId","latitude","longitude"],optionalFields:["incidentType","incidentDate","incidentTime","address","city","state","priority","respondingUnit","responseCategory"]},{id:"response-time-analyzer",name:"Response Time Analyzer",description:"Analyze incident response times and visualize performance metrics",icon:e.jsx(en,{fontSize:"large",sx:{color:"#2196f3"}}),requiredFields:["incidentId","incidentDate"],optionalFields:["dispatchTime","enRouteTime","arrivalTime","latitude","longitude"]},{id:"water-supply-coverage",name:"Water Supply Coverage Analysis",description:"Comprehensive water supply analysis including tanks, hydrants, and mixed infrastructure",icon:e.jsx(tn,{fontSize:"large",sx:{color:"#ff5722"}}),requiredFields:["asset_id","latitude","longitude"],optionalFields:["asset_type","capacity","address","city","state","status"]},{id:"station-coverage-optimizer",name:"Station Coverage Optimizer",description:"Enterprise station placement and coverage analysis with NFPA compliance assessment",icon:e.jsx(sn,{fontSize:"large",sx:{color:"#9c27b0"}}),requiredFields:["station_id","latitude","longitude"],optionalFields:["station_name","station_type","apparatus_count","staffing_level","address","city","state"]}],zr=({selectedTool:t,onToolSelect:r,transformedData:n,onSendToTool:s,isSending:a,preTransformedData:o})=>{console.log("📡📡📡 SEND TO TOOL PANEL RENDER - FRESH BUILD JUN 13 2025 16:48 - selectedTool:",t),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - onSendToTool function:",!!s),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - transformedData length:",n==null?void 0:n.length),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData exists:",!!o),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData length:",o==null?void 0:o.length),o&&o.length>0&&console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData sample:",o[0]);const l=d=>{r(d.target.value)},u=t?(d=>{const h=Dt.find(w=>w.id===d);if(!h)return{compatible:!1,missingFields:[]};if(!n||n.length===0)return console.log("❌ No transformed data available for compatibility check"),{compatible:!1,missingFields:h.requiredFields,hasOptionalFields:[],missingOptionalFields:h.optionalFields||[]};if(d==="fire-map-pro")if(console.log("🔍 FIRE MAP PRO COMPATIBILITY CHECK - ENHANCED FOR ADDRESS PARSING"),console.log("preTransformedData exists:",!!o),console.log("preTransformedData length:",o==null?void 0:o.length),console.log("transformedData sample:",n[0]),o&&o.length>0){const w=Object.keys(n[0]);console.log("🔍 Available transformed data fields:",w);const Y=h.optionalFields?h.optionalFields.filter(q=>{const U=w.includes(q);return console.log(`🔍 Fire Map Pro optional field ${q}: ${U?"AVAILABLE":"NOT AVAILABLE"}`),U}):[],_=h.optionalFields?h.optionalFields.filter(q=>!w.includes(q)):[];return console.log("✅ Fire Map Pro data is compatible - features exist"),console.log("📊 Available optional fields:",Y),console.log("📋 Missing optional fields:",_),{compatible:!0,missingFields:[],hasOptionalFields:Y,missingOptionalFields:_}}else return console.log("❌ Fire Map Pro data not compatible - no features"),{compatible:!1,missingFields:["incidentId","latitude","longitude"],hasOptionalFields:[],missingOptionalFields:h.optionalFields||[]};if(d==="response-time-analyzer"){console.log("🔍 RESPONSE TIME ANALYZER COMPATIBILITY CHECK - FLEXIBLE FIELD MATCHING");const w=Object.keys(n[0]||{});console.log("🔍 Available data fields:",w),console.log("🔍 Required fields (camelCase):",h.requiredFields);const Y=h.requiredFields.filter(U=>{if(w.includes(U))return console.log(`✅ Found exact match for ${U}`),!1;const C=U.replace(/[A-Z]/g,G=>`_${G.toLowerCase()}`);return w.includes(C)?(console.log(`✅ Found snake_case match for ${U} -> ${C}`),!1):(console.log(`❌ No match found for ${U} (tried ${U} and ${C})`),!0)});console.log("🔍 CHECKING OPTIONAL FIELDS:"),console.log("🔍 Tool optional fields:",h.optionalFields);const _=h.optionalFields?h.optionalFields.filter(U=>{let C=U.replace(/[A-Z]/g,J=>`_${J.toLowerCase()}`);U==="enRouteTime"&&(C="enroute_time");const G=w.includes(U),X=w.includes(C);return console.log(`🔍 Optional field ${U}: camelCase=${G}, snake_case(${C})=${X}`),G||X}):[],q=h.optionalFields?h.optionalFields.filter(U=>{let C=U.replace(/[A-Z]/g,G=>`_${G.toLowerCase()}`);return U==="enRouteTime"&&(C="enroute_time"),!w.includes(U)&&!w.includes(C)}):[];return console.log("🔍 OPTIONAL FIELDS RESULT:"),console.log("✅ Has optional fields:",_),console.log("❌ Missing optional fields:",q),{compatible:Y.length===0,missingFields:Y,hasOptionalFields:_,missingOptionalFields:q}}const x=Object.keys(n[0]||{});console.log(`🔍 ${d.toUpperCase()} COMPATIBILITY CHECK`),console.log("Available fields:",x),console.log("Required fields:",h.requiredFields);const v=h.requiredFields.filter(w=>!x.includes(w)),F=h.optionalFields?h.optionalFields.filter(w=>x.includes(w)):[],$=h.optionalFields?h.optionalFields.filter(w=>!x.includes(w)):[];return{compatible:v.length===0,missingFields:v,hasOptionalFields:F,missingOptionalFields:$}})(t):{compatible:!1,missingFields:[]};return e.jsxs(j,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Send to FireEMS Tool"}),e.jsx(ue,{severity:"info",sx:{mb:3},children:"Send your formatted data directly to another FireEMS tool for analysis and visualization."}),e.jsxs(_e,{fullWidth:!0,sx:{mb:3},children:[e.jsx($e,{id:"tool-select-label",children:"Select Tool"}),e.jsxs(Re,{labelId:"tool-select-label",id:"tool-select",value:t||"",label:"Select Tool",onChange:l,children:[e.jsx(re,{value:"",children:e.jsx("em",{children:"Select a tool..."})}),Dt.map(d=>e.jsx(re,{value:d.id,children:d.name},d.id))]})]}),t&&e.jsx(he,{container:!0,spacing:3,children:Dt.filter(d=>d.id===t).map(d=>e.jsx(he,{size:12,children:e.jsxs(bt,{variant:"outlined",children:[e.jsxs(jt,{children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[d.icon,e.jsxs(j,{sx:{ml:2},children:[e.jsx(f,{variant:"h6",children:d.name}),e.jsx(f,{variant:"body2",color:"text.secondary",children:d.description})]})]}),e.jsx(be,{sx:{mb:2}}),e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Required Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.requiredFields.map((h,x)=>e.jsx(f,{variant:"body2",sx:{backgroundColor:u.missingFields.includes(h)?"error.light":"success.light",color:u.missingFields.includes(h)?"error.contrastText":"success.contrastText",borderRadius:1,px:1,py:.5},children:h},x))}),d.optionalFields&&e.jsxs(e.Fragment,{children:[e.jsx(f,{variant:"subtitle2",gutterBottom:!0,children:"Optional Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.optionalFields.map((h,x)=>{var v,F;return e.jsx(f,{variant:"body2",sx:{backgroundColor:(v=u.hasOptionalFields)!=null&&v.includes(h)?"info.light":"action.disabledBackground",color:(F=u.hasOptionalFields)!=null&&F.includes(h)?"info.contrastText":"text.secondary",borderRadius:1,px:1,py:.5},children:h},x)})})]}),!u.compatible&&e.jsxs(ue,{severity:"warning",icon:e.jsx(tr,{}),sx:{mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:"Your data is missing required fields for this tool:"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:u.missingFields.map((h,x)=>e.jsx("li",{children:h},x))})]}),u.compatible&&e.jsxs(ue,{severity:"success",sx:{mb:2},children:[e.jsx(f,{variant:"body2",gutterBottom:!0,children:"Your data is compatible with this tool. All required fields are present."}),d.optionalFields&&u.hasOptionalFields&&u.hasOptionalFields.length>0&&e.jsxs(f,{variant:"body2",children:[u.hasOptionalFields.length," of ",d.optionalFields.length," optional fields are available for enhanced analysis."]})]})]}),e.jsx(nn,{children:e.jsx(oe,{type:"button",variant:"contained",color:"primary",fullWidth:!0,disabled:!u.compatible||a,startIcon:a?e.jsx(Ue,{size:20}):e.jsx(bs,{}),onClick:h=>{h.preventDefault(),h.stopPropagation(),console.log("🚀🚀🚀 SEND TO TOOL BUTTON CLICKED - FRESH BUILD JUN 13 2025 16:49 - tool.id:",d.id),console.log("🚀🚀🚀 SEND TO TOOL BUTTON - onSendToTool function:",s),s()},children:a?"Sending...":`Send to ${d.name}`})})]})},d.id))})]})},Ur=({dataCount:t,fields:r,format:n})=>{const s=()=>{let o=15;n==="json"?o=25:n==="excel"?o=30:n==="pdf"&&(o=40);const l=t*r.length*o;let p=0;n==="excel"?p=5120:n==="pdf"&&(p=15360);const u=l+p;return u<1048576?`${Math.round(u/1024)} KB`:`${(u/1048576).toFixed(2)} MB`},a=()=>{switch(n){case"csv":return e.jsx(_t,{color:"primary"});case"json":return e.jsx(ys,{color:"info"});case"excel":return e.jsx(mt,{color:"success"});case"pdf":return e.jsx(os,{color:"error"});default:return e.jsx(_t,{})}};return e.jsx(bt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(jt,{children:[e.jsx(f,{variant:"h6",gutterBottom:!0,children:"Export Summary"}),e.jsxs(Ve,{disablePadding:!0,children:[e.jsxs(Fe,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:a()}),e.jsx(De,{primary:"Format",secondary:n.toUpperCase()})]}),e.jsx(be,{component:"li"}),e.jsxs(Fe,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(De,{primary:"Records",secondary:`${t} records will be exported`})]}),e.jsx(be,{component:"li"}),e.jsxs(Fe,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(De,{primary:"Fields",secondary:`${r.length} fields per record`})]}),e.jsx(be,{component:"li"}),e.jsxs(Fe,{children:[e.jsx(ke,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(De,{primary:"Estimated Size",secondary:s()})]})]}),e.jsx(f,{variant:"subtitle2",sx:{mt:2},children:"Fields included:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mt:1},children:r.map((o,l)=>e.jsx(le,{label:o,size:"small"},l))})]})})};console.log("🚨🚨🚨 EXPORT CONTAINER LOADED - NEW VERSION WITH UPFRONT TRANSFORMATION AT",new Date().toISOString());const Vr=t=>!t||t.length===0?t:JSON.parse(JSON.stringify(t)).map(n=>{const s={...n};return["Incident Date"].forEach(l=>{if(s[l]&&typeof s[l]=="string")try{const p=new Date(s[l]);if(isNaN(p.getTime()))s[l].includes(" ")&&(s[l]=s[l].split(" ")[0]);else{const u=(p.getMonth()+1).toString().padStart(2,"0"),d=p.getDate().toString().padStart(2,"0"),h=p.getFullYear();s[l]=`${u}/${d}/${h}`}}catch{s[l].includes(" ")&&(s[l]=s[l].split(" ")[0])}}),["Dispatch Time","En Route Time","Arrival Time","Incident Time"].forEach(l=>{if(s[l]&&typeof s[l]=="string")try{const p=new Date(s[l]);if(isNaN(p.getTime())){if(s[l].includes(" ")){const u=s[l].split(" ");u.length>1&&(s[l]=u[1])}}else{const u=p.getHours().toString().padStart(2,"0"),d=p.getMinutes().toString().padStart(2,"0"),h=p.getSeconds().toString().padStart(2,"0");s[l]=`${u}:${d}:${h}`}}catch{if(s[l].includes(" ")){const u=s[l].split(" ");u.length>1&&(s[l]=u[1])}}}),s}),es=t=>{const{children:r,value:n,index:s,...a}=t;return e.jsx("div",{role:"tabpanel",hidden:n!==s,id:`export-tabpanel-${s}`,"aria-labelledby":`export-tab-${s}`,...a,children:n===s&&e.jsx(j,{sx:{p:2},children:r})})},Br=()=>{const t=at(),{sourceFile:r,transformedData:n,validationErrors:s}=Be(R=>R.formatter),[a,o]=M.useState(0),[l,p]=M.useState("csv"),[u,d]=M.useState(null),[h,x]=M.useState(null),[v,F]=M.useState(!1),[$,w]=M.useState({success:!1,message:"",open:!1}),[Y,_]=M.useState([]),[q,U]=M.useState(!1);M.useEffect(()=>{try{const R=localStorage.getItem("fireEmsExportHistory");R&&_(JSON.parse(R))}catch(R){console.error("Error loading export history:",R)}},[]),M.useEffect(()=>{try{localStorage.setItem("fireEmsExportHistory",JSON.stringify(Y))}catch(R){console.error("Error saving export history:",R)}},[Y]);const C=(R,L)=>{o(L)},G=R=>{p(R)},X=R=>{var L,se;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleToolChange CALLED AT",new Date().toISOString()),console.log("🔧 TOOL SELECTION CHANGED - TRANSFORMING DATA UPFRONT:",R),console.log("🔧 transformedData exists:",!!n),console.log("🔧 transformedData length:",n==null?void 0:n.length),console.log('🔧 toolId === "response-time-analyzer":',R==="response-time-analyzer"),d(R),R==="response-time-analyzer"&&n&&n.length>0){console.log("🔧 APPLYING RESPONSE TIME ANALYZER TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",n[0]),console.log("Original field names:",Object.keys(n[0]));try{const g=vt.transformToResponseTimeAnalyzer(n);if(!g.success){console.error("❌ Data transformation failed:",g.errors),x(null);return}const V=g.data||[];console.log("✅ UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed data sample (first record):",V[0]),console.log("Transformed field names:",Object.keys(V[0])),console.log("incidentTime value:",(L=V[0])==null?void 0:L.incidentTime),x(V)}catch(g){console.error("❌ Error during upfront transformation:",g),x(null)}}else if(R==="fire-map-pro"&&n&&n.length>0){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",n[0]),console.log("Original field names:",Object.keys(n[0]));try{const g=vt.transformToFireMapPro(n);if(!g.success){console.error("❌ Fire Map Pro transformation failed:",g.errors),x(null);return}const V=((se=g.data)==null?void 0:se.features)||[];console.log("✅ FIRE MAP PRO UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed features count:",V.length),console.log("Sample feature:",V[0]),x(V)}catch(g){console.error("❌ Error during Fire Map Pro upfront transformation:",g),x(null)}}else x(null)},J=(R,L,se,g,V)=>{const O={id:`export-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,timestamp:Date.now(),format:R,recordCount:L,success:se,destination:g,fileName:V};_(B=>[O,...B].slice(0,20))},i=()=>{_([])},c=()=>{const R=new Date;return R.toLocaleDateString()+" "+R.toLocaleTimeString()},y=async()=>{if(!n||n.length===0){w({success:!1,message:"No data to export",open:!0});return}F(!0);try{const R=Vr(n);let L=`formatted_data_${Date.now()}`;if(l==="excel"){const D=await ss(()=>import("./xlsx-DkH2s96g.js"),[]),T=D.utils.json_to_sheet(R),S={},K=Object.keys(n[0]);K.forEach(I=>{S[I]=Math.max(10,I.length+2)}),n.forEach(I=>{K.forEach(N=>{const b=String(I[N]||"");S[N]=Math.min(50,Math.max(S[N],b.length+2))})}),T["!cols"]=K.map(I=>({wch:S[I]}));const H=D.utils.book_new();H.Props={Title:"FireEMS Formatted Data",Subject:"Incident Data",Author:"FireEMS Data Formatter",CreatedDate:new Date},D.utils.book_append_sheet(H,T,"Formatted Data"),L=`formatted_data_${Date.now()}.xlsx`,D.writeFile(H,L),J("Excel",R.length,!0,"File Download",L),w({success:!0,message:"Data exported successfully as EXCEL",open:!0}),F(!1);return}if(l==="pdf"){const D=new Ks;D.setFontSize(18),D.text("FireEMS Formatted Data",14,22),D.setFontSize(11),D.text(`Export Date: ${c()}`,14,30),D.text(`Records: ${R.length}`,14,36);const T=Object.keys(R[0]);R.length>500&&D.text("Note: Export limited to 500 records for PDF format.",14,42);const S=R.length>500?48:42,K=30,H=10,I=10;D.setFontSize(10),D.setTextColor(0,0,0),D.setFillColor(220,220,220),T.forEach((b,m)=>{D.rect(I+m*K,S,K,H,"FD"),D.text(b,I+m*K+2,S+7)});const N=Math.min(R.length,20);for(let b=0;b<N;b++){const m=S+(b+1)*H;T.forEach((z,W)=>{D.rect(I+W*K,m,K,H,"S");const Z=R[b][z]||"";let ae=String(Z);ae.length>10&&(ae=ae.substring(0,8)+"..."),D.text(ae,I+W*K+2,m+7)})}D.setFontSize(8),D.text(`Generated by FireEMS Tools - ${new Date().toLocaleString()}`,D.internal.pageSize.width/2,D.internal.pageSize.height-10,{align:"center"}),L=`formatted_data_${Date.now()}.pdf`,D.save(L),J("PDF",R.length,!0,"File Download",L),w({success:!0,message:"Data exported successfully as PDF",open:!0}),F(!1);return}let se="",g="";if(l==="csv"){const D=Object.keys(R[0]);se=D.join(",")+`
`,R.forEach(T=>{const S=D.map(K=>{const H=T[K];return H==null?"":typeof H=="string"&&(H.includes(",")||H.includes('"')||H.includes(`
`))?`"${H.replace(/"/g,'""')}"`:H});se+=S.join(",")+`
`}),L=`formatted_data_${Date.now()}.csv`,g="text/csv"}else l==="json"&&(se=JSON.stringify(R,null,2),L=`formatted_data_${Date.now()}.json`,g="application/json");const V=new Blob([se],{type:g}),O=URL.createObjectURL(V),B=document.createElement("a");B.href=O,B.download=L,document.body.appendChild(B),B.click(),document.body.removeChild(B),URL.revokeObjectURL(O),J(l.toUpperCase(),R.length,!0,"File Download",L),w({success:!0,message:`Data exported successfully as ${l.toUpperCase()}`,open:!0})}catch(R){console.error("Export error:",R),w({success:!1,message:`Error exporting data: ${R instanceof Error?R.message:"Unknown error"}`,open:!0}),J(l.toUpperCase(),n.length,!1,"File Download")}finally{F(!1)}},A=R=>({"response-time-analyzer":"Response Time Analyzer","call-density-heatmap":"Call Density Heatmap","incident-dashboard":"Incident Dashboard","trend-analyzer":"Trend Analyzer"})[R]||R,P=async()=>{var L,se;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleSendToTool FUNCTION CALLED AT",new Date().toISOString()),console.log("🚀🚀🚀 selectedExportTool:",u),console.log("🚀🚀🚀 transformedData length:",n==null?void 0:n.length),console.log("🚀🚀🚀 preTransformedData length:",h==null?void 0:h.length),console.log("🚀🚀🚀 transformedData sample:",n==null?void 0:n[0]),!n||n.length===0||!u){console.log("❌ SEND TO TOOL FAILED - Missing data or tool selection"),console.log("❌ transformedData:",!!n),console.log("❌ transformedData.length:",n==null?void 0:n.length),console.log("❌ selectedExportTool:",u),w({success:!1,message:"No data or tool selected",open:!0});return}F(!0);const R=A(u);console.log("🚀 Tool name resolved:",R);try{let g;if(console.log('🔧 CHECKING TOOL TYPE - selectedExportTool === "response-time-analyzer":',u==="response-time-analyzer"),console.log("🔧 CHECKING PRE-TRANSFORMED DATA AVAILABILITY:",!!h),u==="response-time-analyzer"&&h&&h.length>0)console.log("✅ USING PRE-TRANSFORMED DATA FROM TOOL SELECTION - NO REDUNDANT TRANSFORMATION"),console.log("Pre-transformed data sample (first record):",h[0]),console.log("Pre-transformed field names:",Object.keys(h[0])),console.log("incidentTime value:",(L=h[0])==null?void 0:L.incidentTime),g=h;else if(u==="fire-map-pro"){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION");const O=vt.transformToFireMapPro(n);if(!O.success)throw console.error("❌ Data transformation failed:",O.errors),new Error(`Data transformation failed: ${O.errors.join(", ")}`);g=((se=O.data)==null?void 0:se.features)||[]}else console.log("🔧 USING STANDARD DATA FORMATTING"),console.log("DEBUG - USING ALREADY TRANSFORMED DATA: Sample data fields:",n.length>0?Object.keys(n[0]):"No data"),g=n.map(O=>{const B={...O};return console.log("DEBUG - USING MAPPED DATA: Record fields:",Object.keys(O)),Object.keys(B).forEach(D=>{if(B[D]&&typeof B[D]=="string"&&B[D].includes(" ")){const[T,S]=B[D].split(" ");console.log(`DATETIME SPLIT: Field "${D}" = "${B[D]}" -> Date: "${T}", Time: "${S}"`),D.toLowerCase().includes("date")?(console.log(`SETTING DATE FIELD "${D}" to "${T}"`),B[D]=T):D.toLowerCase().includes("time")&&(console.log(`SETTING TIME FIELD "${D}" to "${S}"`),B[D]=S)}}),B});const V={toolId:u,toolName:R,data:g,sourceFile:r==null?void 0:r.name,timestamp:Date.now(),fields:Object.keys(g[0]),recordCount:g.length,exportVersion:"2.0"};if(g.length>0){console.log("Sample record being sent (using user-mapped fields):",g[0]);const O=g[0],B=Object.keys(O);console.log("All field names (as mapped by user):",B),console.log("Field values:",O)}sessionStorage.removeItem("fireEmsExportedData"),console.log("VERIFY: Field names being stored in sessionStorage:",V.data&&V.data.length>0?Object.keys(V.data[0]):"No data"),sessionStorage.setItem("fireEmsExportedData",JSON.stringify(V)),console.log(`Data prepared for ${u}. Data size: ${g.length} records`),g.length>0&&(console.log("FIELD NAMES CHECK - Sample record being sent to session storage:"),console.log(JSON.stringify(g[0]))),J("Data Transfer",g.length,!0,R),w({success:!0,message:`Data sent to ${R} successfully!`,open:!0}),setTimeout(()=>{const D=`http://${window.location.hostname}:5006`;let T="";if(u==="fire-map-pro")T=`${window.location.origin}/app/fire-map-pro`;else if(u==="response-time-analyzer")T=`${window.location.origin}/app/response-time-analyzer`;else if(u==="call-density-heatmap")T=`${D}/call-density-heatmap`;else if(u==="incident-dashboard")T=`${D}/incident-dashboard`;else if(u==="trend-analyzer")T=`${D}/trend-analyzer`;else{console.log(`Tool ID not recognized: ${u}`);return}console.log(`Redirecting to: ${T}`),window.location.href=T},500)}catch(g){console.error("Send to tool error:",g),w({success:!1,message:`Error sending data to tool: ${g instanceof Error?g.message:"Unknown error"}`,open:!0}),J("Data Transfer",n.length,!1,R)}finally{F(!1)}},E=()=>{t(Le(2))};if(!n||n.length===0)return e.jsxs(j,{children:[e.jsx(ue,{severity:"warning",sx:{mb:2},children:"No data available to export. Please go back and ensure your data is processed correctly."}),e.jsx(oe,{variant:"outlined",startIcon:e.jsx(tt,{}),onClick:E,children:"Back to Validation"})]});const k=R=>new Date(R).toLocaleString(),ie=()=>Y.length===0?e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(f,{color:"text.secondary",children:"No export history available"})}):e.jsx(Ve,{sx:{width:"100%",bgcolor:"background.paper"},dense:!0,children:Y.map(R=>e.jsxs(Fe,{secondaryAction:e.jsx(Ae,{edge:"end","aria-label":"delete",onClick:()=>{_(L=>L.filter(se=>se.id!==R.id))},children:e.jsx(rt,{fontSize:"small"})}),sx:{borderLeft:"4px solid",borderColor:R.success?"success.main":"error.main",mb:1,bgcolor:"background.paper","&:hover":{bgcolor:"action.hover"}},children:[e.jsxs(ke,{children:[R.format==="Excel"&&e.jsx(mt,{color:"success"}),R.format==="CSV"&&e.jsx(_t,{color:"primary"}),R.format==="JSON"&&e.jsx(ys,{color:"info"}),R.format==="PDF"&&e.jsx(mt,{color:"error"}),R.format==="Data Transfer"&&e.jsx(bs,{color:"secondary"})]}),e.jsx(De,{primary:e.jsx(f,{variant:"body2",fontWeight:"medium",children:R.format==="Data Transfer"?`Sent to ${R.destination}`:`${R.format} Export${R.fileName?` - ${R.fileName}`:""}`}),secondary:e.jsxs(f,{variant:"caption",display:"block",children:[k(R.timestamp)," • ",R.recordCount," records",!R.success&&" • Failed"]})})]},R.id))});return console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - FRESH BUILD JUN 13 2025 16:47 - transformedData length:",n==null?void 0:n.length),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - selectedExportTool:",u),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - tabValue:",a),e.jsxs(j,{children:[e.jsx(f,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Export Formatted Data"}),e.jsxs(ye,{sx:{p:2,mb:3},children:[e.jsxs(he,{container:!0,spacing:2,children:[e.jsx(he,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(f,{variant:"body1",children:[(r==null?void 0:r.name)||"No file"," (",r==null?void 0:r.type,")"]})]})}),e.jsx(he,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(f,{variant:"body1",children:[n.length," records processed"]})]})}),e.jsx(he,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:s.length===0?e.jsxs(e.Fragment,{children:[e.jsx(qe,{color:"success"}),e.jsx(f,{color:"success.main",children:"All data is valid"})]}):e.jsx(e.Fragment,{children:e.jsxs(ue,{severity:"warning",sx:{mt:1},children:[s.length," validation issues found. Consider reviewing before export."]})})})]})})]}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($t,{color:"action",fontSize:"small"}),e.jsx(f,{variant:"subtitle2",color:"text.secondary",children:"Export History"}),Y.length>0&&e.jsx(rn,{badgeContent:Y.length,color:"primary",sx:{ml:1}})]}),e.jsxs(j,{children:[e.jsx(Ae,{size:"small",onClick:()=>U(!q),"aria-label":q?"Hide history":"Show history",children:q?e.jsx(ms,{}):e.jsx(xt,{})}),Y.length>0&&q&&e.jsx(oe,{size:"small",startIcon:e.jsx(rt,{}),onClick:i,sx:{ml:1},children:"Clear"})]})]}),e.jsx(cs,{in:q,children:e.jsx(j,{sx:{mt:2},children:ie()})})]}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:a,onChange:C,"aria-label":"export options tabs",children:[e.jsx(Ie,{label:"Download File",id:"export-tab-0","aria-controls":"export-tabpanel-0"}),e.jsx(Ie,{label:"Send to Tool",id:"export-tab-1","aria-controls":"export-tabpanel-1"})]})}),e.jsx(es,{value:a,index:0,children:e.jsxs(he,{container:!0,spacing:3,children:[e.jsx(he,{size:{xs:12,md:6},children:e.jsx(Lr,{selectedFormat:l,onFormatChange:G})}),e.jsx(he,{size:{xs:12,md:6},children:e.jsx(Ur,{dataCount:n.length,fields:Object.keys(n[0]),format:l})}),e.jsx(he,{size:12,children:e.jsx(oe,{variant:"contained",color:"primary",fullWidth:!0,size:"large",onClick:y,disabled:v,startIcon:v?e.jsx(Ue,{size:20}):e.jsx(Js,{}),sx:{mt:2},children:v?"Exporting...":`Download as ${l.toUpperCase()}`})})]})}),e.jsx(es,{value:a,index:1,children:e.jsx(zr,{selectedTool:u,onToolSelect:X,transformedData:n,onSendToTool:P,isSending:v,preTransformedData:h})}),e.jsx(be,{sx:{my:3}}),e.jsx(j,{sx:{display:"flex",justifyContent:"space-between"},children:e.jsx(oe,{variant:"outlined",startIcon:e.jsx(tt,{}),onClick:E,children:"Back to Validation"})}),e.jsx(hs,{open:$.open,autoHideDuration:6e3,onClose:()=>w({...$,open:!1}),children:e.jsx(ue,{onClose:()=>w({...$,open:!1}),severity:$.success?"success":"error",children:$.message})})]})},ts={log:(...t)=>{},warn:(...t)=>{},error:(...t)=>{console.error(...t)},debug:(...t)=>{},info:(...t)=>{}},Gr=["Upload File","Map Fields","Preview & Validate","Export"],ko=()=>{const{currentStep:t}=Be(s=>s.formatter),r=()=>{const s=window.location.pathname;return s.includes("fire-map-pro")?"FireEMS Fire Map Pro":s.includes("response-time-analyzer")?"FireEMS Response Time Analyzer":"FireEMS Data Formatter"};Je.useEffect(()=>{const s=r();document.title=s;try{gt(),ts.debug("[DEBUG] Vendor templates seeded successfully")}catch(a){ts.error("[ERROR] Failed to seed vendor templates:",a)}},[]);const n=s=>{switch(s){case 0:return e.jsx(Cn,{});case 1:return e.jsx(Ar,{});case 2:return e.jsx(kr,{});case 3:return e.jsx(Br,{});default:return e.jsx(f,{children:"Unknown step"})}};return e.jsx(Ps,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(ye,{elevation:3,sx:{p:3},children:[e.jsx(f,{variant:"h4",component:"h1",gutterBottom:!0,children:r()}),e.jsx(on,{activeStep:t,sx:{mb:4},children:Gr.map(s=>e.jsx(an,{children:e.jsx(ln,{children:s})},s))}),e.jsx(j,{sx:{mt:2},children:n(t)})]})})};export{ko as default};
