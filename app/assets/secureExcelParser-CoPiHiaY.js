var x=Object.defineProperty;var w=(t,e,r)=>e in t?x(t,e,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[e]=r;var m=(t,e,r)=>w(t,typeof e!="symbol"?e+"":e,r);import{aY as f}from"./index-1yn4_2NV.js";import"./purify.es-CQJ0hv7W.js";const a={maxStringLength:1e4,maxArrayLength:1e3,maxObjectDepth:10,allowedMimeTypes:["text/csv","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet","application/json","text/xml","application/xml","text/plain","application/pdf"],maxFileSize:50*1024*1024,timeoutMs:3e4},p=t=>{if(t==null)return"";const e=String(t);if(e.length>a.maxStringLength)throw new Error(`String too long (${e.length} > ${a.maxStringLength})`);return e.replace(/[<>]/g,"").replace(/javascript:/gi,"").replace(/data:/gi,"").replace(/vbscript:/gi,"").replace(/on\w+=/gi,"").trim()},u=(t,e=0)=>{if(e>a.maxObjectDepth)throw new Error(`Object too deeply nested (${e} > ${a.maxObjectDepth})`);if(t==null)return t;if(typeof t=="object"&&t.constructor!==Object&&t.constructor!==Array)return{};if(Array.isArray(t)){if(t.length>a.maxArrayLength)throw new Error(`Array too long (${t.length} > ${a.maxArrayLength})`);return t.map(r=>u(r,e+1))}if(typeof t=="object"){const r={};for(const s in t){if(!t.hasOwnProperty(s)||s==="__proto__"||s==="constructor"||s==="prototype")continue;const n=p(s);n.length!==0&&(r[n]=u(t[s],e+1))}return r}return typeof t=="string"?p(t):typeof t=="number"?isFinite(t)?t:0:typeof t=="boolean"?t:""},y=t=>{if(t.size>a.maxFileSize)throw new Error(`File too large (${t.size} > ${a.maxFileSize})`);if(!a.allowedMimeTypes.includes(t.type))throw new Error(`Invalid file type: ${t.type}`);const e=p(t.name);if(e.length===0)throw new Error("Invalid filename");if(/\.(exe|bat|cmd|com|pif|scr|vbs|js|jar|zip|rar)$/i.test(e))throw new Error(`Suspicious file extension: ${e}`)},g=(t,e=a.timeoutMs)=>{const r=new Promise((s,n)=>{setTimeout(()=>{n(new Error(`Operation timed out after ${e}ms`))},e)});return Promise.race([t,r])},E=t=>{if(!t||typeof t!="object")throw new Error("Invalid workbook data");const e={SheetNames:Array.isArray(t.SheetNames)?t.SheetNames.slice(0,10).map(p):[],Sheets:{}};if(t.Sheets&&typeof t.Sheets=="object")for(const r of e.SheetNames)t.Sheets[r]&&(e.Sheets[r]=u(t.Sheets[r],0));return e},S=t=>{const e=t.columns.map(s=>p(s)).filter(s=>s.length>0).slice(0,100),r=t.data.slice(0,1e4).map(s=>u(s)).filter(s=>s&&typeof s=="object");return{columns:e,data:r}};class v{constructor(e=100,r=6e4){m(this,"operations",new Map);m(this,"maxOperations");m(this,"windowMs");this.maxOperations=e,this.windowMs=r}canProceed(e){const r=Date.now(),n=(this.operations.get(e)||[]).filter(c=>r-c<this.windowMs);return n.length>=this.maxOperations?!1:(n.push(r),this.operations.set(e,n),!0)}}const z=new v,_={maxRows:1e4,maxColumns:100,maxFileSize:50*1024*1024,timeoutMs:3e4,sheetIndex:0,sheetName:""};class F{constructor(e={}){m(this,"options");this.options={..._,...e}}async parseExcelFile(e){const r=`excel_parse_${e.name}_${e.size}`;if(!z.canProceed(r))throw new Error("Rate limit exceeded for file parsing");if(y(e),e.size>this.options.maxFileSize)throw new Error(`Excel file too large: ${e.size} bytes`);return g(this.parseExcelFileInternal(e),this.options.timeoutMs)}async parseExcelFileInternal(e){return new Promise((r,s)=>{const n=new FileReader;n.onload=async c=>{var o;try{const i=(o=c.target)==null?void 0:o.result;if(!i){s(new Error("Failed to read Excel file"));return}const l=await this.parseExcelData(i),h=S(l),d=this.applyLimits(h);r(d)}catch(i){s(new Error(`Error parsing Excel file: ${i instanceof Error?i.message:"Unknown error"}`))}},n.onerror=()=>{s(new Error("Error reading Excel file"))},n.readAsArrayBuffer(e)})}async parseExcelData(e){const r=await f(()=>import("./xlsx-DkH2s96g.js"),[]);let s;try{s=r.read(e,{type:"array",cellDates:!0,cellNF:!1,cellText:!1,sheetStubs:!1,bookVBA:!1,bookSheets:!1,bookProps:!1,bookSST:!1,bookType:"xlsx",WTF:!1,raw:!1})}catch{throw new Error("Failed to parse Excel file: Invalid or corrupted file")}const n=E(s),c=this.getTargetSheet(n),o=this.convertSheetToJson(c);if(o.length===0)throw new Error("Excel file is empty or contains no data");const i=this.extractColumns(o),l=this.extractData(o,i);return{columns:i,data:l}}getTargetSheet(e){if(!e.SheetNames||e.SheetNames.length===0)throw new Error("Excel file contains no sheets");let r;if(this.options.sheetName){if(!e.SheetNames.includes(this.options.sheetName))throw new Error(`Sheet "${this.options.sheetName}" not found`);r=this.options.sheetName}else{if(this.options.sheetIndex>=e.SheetNames.length)throw new Error(`Sheet index ${this.options.sheetIndex} out of range`);r=e.SheetNames[this.options.sheetIndex]}const s=e.Sheets[r];if(!s)throw new Error(`Sheet "${r}" is empty or corrupted`);return s}convertSheetToJson(e){return f(()=>import("./xlsx-DkH2s96g.js"),[]).then(r=>{try{return r.utils.sheet_to_json(e,{header:1,raw:!1,dateNF:"yyyy-mm-dd",cellDates:!0,defval:""}).slice(0,this.options.maxRows)}catch{throw new Error("Failed to convert sheet to JSON")}})}extractColumns(e){if(e.length===0)return[];const r=e[0];if(!Array.isArray(r))throw new Error("Invalid data format");return r.map(n=>String(n||"")).filter(n=>n.trim().length>0).slice(0,this.options.maxColumns)}extractData(e,r){const s=[];for(let n=1;n<e.length&&s.length<this.options.maxRows;n++){const c=e[n];if(!Array.isArray(c))continue;const o={};for(let i=0;i<r.length;i++){const l=c[i],h=r[i];l!=null?o[h]=String(l):o[h]=""}s.push(o)}return s}applyLimits(e){return{columns:e.columns.slice(0,this.options.maxColumns),data:e.data.slice(0,this.options.maxRows)}}}const $=async(t,e={})=>new F(e).parseExcelFile(t);export{F as SecureExcelParser,$ as parseExcelFileSecurely};
