<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Data Formatter - FireEMS.ai</title>
  
  <!-- FireEMS Resilience Framework -->
  <script>
    // Load the framework initialization script
    (function() {
      function loadFramework() {
        console.log("Loading FireEMS Framework");
        const script = document.createElement('script');
        script.src = '/static/js/fireems-framework.js';
        
        script.onerror = function() {
          console.warn("Failed to load framework from primary path, trying fallback...");
          const fallbackScript = document.createElement('script');
          fallbackScript.src = '/app-static/js/fireems-framework.js';
          
          fallbackScript.onerror = function() {
            console.error("Failed to load framework from all paths");
          };
          
          document.head.appendChild(fallbackScript);
        };
        
        document.head.appendChild(script);
      }
      
      // Load the framework when the document is ready
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', loadFramework);
      } else {
        loadFramework();
      }
    })();
  </script>
  
  <!-- Fallback static file loading script -->
  <script>
    function loadCSS(url, fallbackUrl) {
      const link = document.createElement('link');
      link.rel = 'stylesheet';
      link.href = url;
      
      link.onerror = function() {
        console.warn(`Failed to load CSS from ${url}, trying fallback...`);
        // Try first fallback path
        const fallbackLink = document.createElement('link');
        fallbackLink.rel = 'stylesheet';
        fallbackLink.href = fallbackUrl;
        
        fallbackLink.onerror = function() {
          console.error(`Fallback CSS load failed for ${fallbackUrl}`);
          // If that fails, try the app-static path
          const emergencyLink = document.createElement('link');
          emergencyLink.rel = 'stylesheet';
          emergencyLink.href = url.replace('/static/', '/app-static/');
          document.head.appendChild(emergencyLink);
        };
        
        document.head.appendChild(fallbackLink);
      };
      
      document.head.appendChild(link);
    }
    
    // Load critical CSS files with fallbacks
    loadCSS('/static/styles.css', '/direct-static/styles.css');
    loadCSS('/static/data-formatter.css', '/direct-static/data-formatter.css');
  </script>
  
  <!-- Framework CSS -->
  <link rel="stylesheet" href="/static/fireems-framework.css" />
  
  <!-- Inline critical CSS to ensure basic styling works even if files fail to load -->
  <style>
    /* Critical styles for basic layout and usability */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; line-height: 1.6; }
    .navbar { background-color: #202830; color: #fff; padding: 10px 20px; display: flex; justify-content: space-between; }
    .container { max-width: 1200px; margin: 0 auto; padding: 0 20px; }
    .tool-header { background: linear-gradient(135deg, #202830 0%, #3498db 100%); color: white; padding: 20px 0; margin-bottom: 20px; }
    button { background-color: #2196f3; color: white; border: none; padding: 10px 20px; border-radius: 4px; cursor: pointer; }
    .formatter-panel { background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); padding: 20px; margin-bottom: 20px; }
  </style>
  
  <!-- Font Awesome for icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <!-- XLSX.js for Excel file processing -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <!-- Favicon -->
  <link rel="icon" href="/static/favicon.ico" type="image/x-icon">
</head>
<body>
  <div class="navbar">
    <div class="logo">
      <a href="/">
        <i class="fas fa-fire"></i> FireEMS.ai
      </a>
    </div>
    <div class="nav-links">
      <a href="/">Home</a>
      <a href="/fire-ems-dashboard">Response Time Analyzer</a>
      <a href="/isochrone-map">Isochrone Map</a>
      <a href="/call-density-heatmap">Call Density</a>
      <a href="/station-overview">Station Overview</a>
      <a href="/incident-logger">Incident Logger</a>
      <a href="/coverage-gap-finder">Coverage Gap Finder</a>
      <a href="/fire-map-pro">FireMapPro</a>
      <a href="/data-formatter" class="active">Data Formatter</a>
    </div>
  </div>
  
  <header class="tool-header">
    <div class="container">
      <h1><i class="fas fa-exchange-alt"></i> Data Formatter</h1>
      <p>Convert, standardize, and prepare your data for use with FireEMS.ai tools</p>
    </div>
  </header>

  <main class="container">
      
      <div class="instructions-toggle">
        <button id="show-instructions" class="secondary-btn">
          <i class="fas fa-question-circle"></i> How to Use This Tool
        </button>
      </div>
    </section>
    
    <section id="instructions-panel" class="instructions-panel" style="display: none;">
      <div class="instructions-header">
        <h2><i class="fas fa-book"></i> Data Formatter Instructions</h2>
        <button id="close-instructions" class="close-btn"><i class="fas fa-times"></i></button>
      </div>
      
      <div class="instructions-content">
        <div class="instruction-block">
          <h3>Overview</h3>
          <p>The Data Formatter tool helps you transform your raw data files into formats that work perfectly with any FireEMS.ai tool. It automatically maps fields, standardizes formats, and prepares your data for analysis.</p>
        </div>
        
        <div class="instruction-block">
          <h3>Step-by-Step Guide</h3>
          <ol>
            <li><strong>Upload your data file</strong> - Select a CSV, Excel, JSON, XML, or KML/KMZ file to upload.</li>
            <li><strong>Select your target tool</strong> - Choose which FireEMS.ai tool you want to prepare data for.</li>
            <li><strong>Review the required fields</strong> - The tool shows which fields are required for your selected tool.</li>
            <li><strong>Map your fields</strong> - Use the drag-and-drop interface to map your source columns to target fields.</li>
            <li><strong>Configure transformations</strong> - Customize how your data is transformed (dates, coordinates, etc.).</li>
            <li><strong>Transform the data</strong> - Apply your mappings to generate the transformed data.</li>
            <li><strong>Review the results</strong> - Check the preview and transformation log.</li>
            <li><strong>Download or send to tool</strong> - Save the transformed data or send it directly to your chosen tool.</li>
          </ol>
        </div>
        
        <div class="instruction-block">
          <h3>Examples</h3>
          
          <div class="example-box">
            <h4>Example 1: Prepare Incident Data for Response Time Analyzer</h4>
            <p><strong>Input file:</strong> incident_log.csv (contains incident dates, times, coordinates)</p>
            <p><strong>Target tool:</strong> Response Time Analyzer</p>
            <p><strong>What the formatter does:</strong></p>
            <ul>
              <li>Maps your incident fields to required fields (Incident ID, Date, Times, Coordinates)</li>
              <li>Standardizes date formats to YYYY-MM-DD</li>
              <li>Converts time fields to HH:MM:SS format</li>
              <li>Ensures coordinate format is consistent</li>
            </ul>
          </div>
          
          <div class="example-box">
            <h4>Example 2: Convert Station Data for Isochrone Map</h4>
            <p><strong>Input file:</strong> stations.xlsx (contains station locations and details)</p>
            <p><strong>Target tool:</strong> Isochrone Map Generator</p>
            <p><strong>What the formatter does:</strong></p>
            <ul>
              <li>Extracts station IDs, names, and addresses</li>
              <li>Geocodes addresses if coordinates are missing</li>
              <li>Formats unit types for proper display</li>
              <li>Removes unnecessary columns to reduce file size</li>
            </ul>
          </div>
          
          <div class="example-box">
            <h4>Example 3: Prepare Call Data for Density Heatmap</h4>
            <p><strong>Input file:</strong> calls_2024.json (contains call locations and times)</p>
            <p><strong>Target tool:</strong> Call Density Heatmap</p>
            <p><strong>What the formatter does:</strong></p>
            <ul>
              <li>Extracts latitude and longitude from location data</li>
              <li>Breaks down timestamps into hour, day, month components</li>
              <li>Categorizes incident types for filtering</li>
              <li>Normalizes coordinates to standard decimal degrees</li>
            </ul>
          </div>
        </div>
        
        <div class="instruction-block">
          <h3>Tips for Best Results</h3>
          <ul>
            <li><strong>Use headers in your files</strong> - Column names help the tool correctly map your data.</li>
            <li><strong>Check the transformation log</strong> - It shows what changes were made to your data.</li>
            <li><strong>Review field mappings</strong> - The tool will highlight matched and missing fields.</li>
            <li><strong>Use compression for large files</strong> - Reduce size while keeping essential information.</li>
            <li><strong>Save your formatted data</strong> - You can reuse it with any FireEMS.ai tool.</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="formatter-container">
      <div class="formatter-panel left-panel">
        <h2>Input Data</h2>
        
        <div class="upload-section">
          <div class="file-upload">
            <label for="data-file" class="file-upload-btn">
              <i class="fas fa-file-upload"></i> Choose File
            </label>
            <input type="file" id="data-file" accept=".csv,.xlsx,.json,.xml,.kml,.kmz">
            <span id="file-name">No file selected</span>
              
            <!-- Emergency fallback for file upload -->
            <script>
              document.addEventListener('DOMContentLoaded', function() {
                const fileInput = document.getElementById('data-file');
                const fileNameDisplay = document.getElementById('file-name');
                
                if (fileInput && fileNameDisplay) {
                  console.log("Adding emergency event listener to file input");
                  
                  // Add a direct event listener without relying on the integration script
                  fileInput.addEventListener('change', function(event) {
                    const file = event.target.files[0];
                    if (!file) return;
                    
                    // Update filename display
                    fileNameDisplay.textContent = file.name;
                    console.log("Selected file:", file.name);
                    
                    // Enable mapping button
                    const mapFieldsBtn = document.getElementById('map-fields-btn');
                    if (mapFieldsBtn) {
                      mapFieldsBtn.disabled = false;
                    }
                    
                    // Initialize file preview
                    processCSVFile(file);
                  });
                }
                
                // Simple CSV processor for emergencies
                function processCSVFile(file) {
                  if (!file) return;
                  
                  const reader = new FileReader();
                  reader.onload = function(e) {
                    const text = e.target.result;
                    
                    try {
                      // Simple CSV parsing
                      const lines = text.split('\n');
                      const headers = lines[0].split(',').map(h => h.trim());
                      
                      if (headers.length === 0) {
                        showErrorMessage("No columns detected in CSV file");
                        return;
                      }
                      
                      // Store column names in global state
                      if (window.formatterState) {
                        window.formatterState.sourceColumns = headers;
                        window.formatterState.originalData = true;
                        
                        // Parse a few rows for sample data
                        const sampleData = [];
                        for (let i = 1; i < Math.min(lines.length, 6); i++) {
                          if (lines[i].trim()) {
                            const values = lines[i].split(',');
                            const row = {};
                            
                            headers.forEach((header, index) => {
                              row[header] = values[index] ? values[index].trim() : '';
                            });
                            
                            sampleData.push(row);
                          }
                        }
                        
                        window.formatterState.sampleData = sampleData;
                        
                        // Update UI
                        updatePreview(headers, sampleData);
                        
                        // Log success message
                        const logContainer = document.getElementById('log-container');
                        if (logContainer) {
                          const timestamp = new Date().toLocaleTimeString();
                          logContainer.innerHTML = `<div class="log-entry log-info">
                            <span class="log-time">${timestamp}</span> 
                            File processed in emergency mode. ${headers.length} columns detected.
                          </div>`;
                        }
                      }
                    } catch (error) {
                      console.error("CSV processing error:", error);
                      showErrorMessage("Error processing CSV: " + error.message);
                    }
                  };
                  
                  reader.onerror = function() {
                    showErrorMessage("Error reading file");
                  };
                  
                  reader.readAsText(file);
                }
                
                function updatePreview(headers, rows) {
                  const previewContainer = document.getElementById('input-preview');
                  if (!previewContainer) return;
                  
                  let html = '<table class="preview-table"><thead><tr>';
                  
                  // Add headers
                  headers.forEach(header => {
                    html += `<th>${header}</th>`;
                  });
                  
                  html += '</tr></thead><tbody>';
                  
                  // Add rows
                  rows.forEach(row => {
                    html += '<tr>';
                    headers.forEach(header => {
                      html += `<td>${row[header] || ''}</td>`;
                    });
                    html += '</tr>';
                  });
                  
                  html += '</tbody></table>';
                  previewContainer.innerHTML = html;
                }
                
                function showErrorMessage(message) {
                  const previewContainer = document.getElementById('input-preview');
                  if (previewContainer) {
                    previewContainer.innerHTML = `
                      <div class="error-message">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>${message}</p>
                      </div>
                    `;
                  }
                }
              });
            </script>
          </div>
          
          <div class="format-selector">
            <label for="input-format">Input Format:</label>
            <select id="input-format">
              <option value="auto">Auto-detect</option>
              <option value="csv">CSV</option>
              <option value="excel">Excel</option>
              <option value="json">JSON</option>
              <option value="xml">XML</option>
              <option value="kml">KML/KMZ</option>
            </select>
          </div>
          
          <!-- Excel Sheet Selection (Hidden by default) -->
          <div id="excel-options" style="display: none; margin-top: 10px;">
            <label for="excel-sheet">Excel Sheet:</label>
            <select id="excel-sheet" style="min-width: 150px;">
              <option value="">Loading sheets...</option>
            </select>
          </div>
        </div>
        
        <div class="preview-container">
          <h3>Input Preview</h3>
          <div id="input-preview" class="data-preview">
            <div class="placeholder-message">
              <i class="fas fa-arrow-up"></i>
              <p>Upload a file to preview</p>
            </div>
          </div>
        </div>
      </div>

      <!-- Column Mapping Container -->
      <div id="column-mapping-container" class="column-mapping-container" style="display: none;">
        <!-- React Column Mapping UI will be rendered here -->
        <div class="loading-container">
          <div class="loading-spinner"></div>
          <p>Loading field mapping interface...</p>
        </div>
        
        <!-- Emergency fallback for column mapping -->
        <script>
          // Listen for the button click
          document.addEventListener('DOMContentLoaded', function() {
            const mapFieldsBtn = document.getElementById('map-fields-btn');
            
            if (mapFieldsBtn) {
              // Add a direct handler in case the main one doesn't work
              mapFieldsBtn.addEventListener('click', function() {
                console.log("Emergency column mapping handler activated");
                createEmergencyMappingInterface();
              });
            }
            
            // Function to create a simple mapping interface when the React one fails
            function createEmergencyMappingInterface() {
              const container = document.getElementById('column-mapping-container');
              if (!container) return;
              
              // Don't recreate if already showing our emergency UI
              if (container.querySelector('.emergency-mapping-ui')) return;
              
              // Check if we have state with columns
              if (!window.formatterState || !window.formatterState.sourceColumns || window.formatterState.sourceColumns.length === 0) {
                container.innerHTML = `
                  <div class="error-message" style="padding: 20px; background-color: #f8d7da; border-radius: 5px; margin: 20px;">
                    <h3>Error: No Source Data Available</h3>
                    <p>Please upload a file first and ensure it contains column headers.</p>
                    <button class="primary-btn" onclick="window.showFormatterPanels()">Return to Formatter</button>
                  </div>
                `;
                return;
              }
              
              // Get tool selection
              const toolSelect = document.getElementById('target-tool');
              const selectedTool = toolSelect ? toolSelect.value : '';
              
              if (!selectedTool) {
                container.innerHTML = `
                  <div class="error-message" style="padding: 20px; background-color: #f8d7da; border-radius: 5px; margin: 20px;">
                    <h3>Error: No Target Tool Selected</h3>
                    <p>Please select a target tool before mapping fields.</p>
                    <button class="primary-btn" onclick="window.showFormatterPanels()">Return to Formatter</button>
                  </div>
                `;
                return;
              }
              
              // Basic target fields for all tools
              const targetFields = [
                { id: 'incident_id', name: 'Incident ID', required: true },
                { id: 'incident_date', name: 'Incident Date', required: true },
                { id: 'incident_time', name: 'Incident Time', required: true },
                { id: 'latitude', name: 'Latitude', required: true },
                { id: 'longitude', name: 'Longitude', required: true },
                { id: 'incident_type', name: 'Incident Type', required: true },
                { id: 'address', name: 'Address', required: false }
              ];
              
              // Add tool-specific fields
              if (selectedTool === 'response-time') {
                targetFields.push(
                  { id: 'dispatch_time', name: 'Dispatch Time', required: true },
                  { id: 'en_route_time', name: 'En Route Time', required: true },
                  { id: 'on_scene_time', name: 'On Scene Time', required: true }
                );
              } else if (selectedTool === 'call-density') {
                targetFields.push(
                  { id: 'priority', name: 'Priority Level', required: false }
                );
              } else if (selectedTool === 'incident-logger') {
                targetFields.push(
                  { id: 'patient_age', name: 'Patient Age', required: false },
                  { id: 'patient_gender', name: 'Patient Gender', required: false }
                );
              }
              
              // Build HTML interface
              let html = `
                <div class="emergency-mapping-ui" style="padding: 20px; background-color: #f9f9f9; border-radius: 5px; margin: 20px;">
                  <h2 style="margin-bottom: 20px;">Emergency Field Mapping</h2>
                  <p style="margin-bottom: 15px;">Map your source columns to the required fields for ${selectedTool}:</p>
                  
                  <form id="emergency-mapping-form">
                    <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px;">
                      <thead>
                        <tr>
                          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Target Field</th>
                          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Source Column</th>
                          <th style="text-align: left; padding: 8px; border-bottom: 1px solid #ddd;">Required</th>
                        </tr>
                      </thead>
                      <tbody>
              `;
              
              // Add rows for each target field
              targetFields.forEach(field => {
                html += `
                  <tr>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">${field.name}</td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">
                      <select name="${field.id}" style="width: 100%; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
                        <option value="">-- Select Column --</option>
                `;
                
                // Add options for each source column
                window.formatterState.sourceColumns.forEach(column => {
                  // Automatic matching for common fields
                  const isMatch = column.toLowerCase().includes(field.id.toLowerCase()) || 
                                  field.name.toLowerCase().includes(column.toLowerCase());
                  
                  html += `<option value="${column}" ${isMatch ? 'selected' : ''}>${column}</option>`;
                });
                
                html += `
                      </select>
                    </td>
                    <td style="padding: 8px; border-bottom: 1px solid #eee;">
                      ${field.required ? '<span style="color: #d9534f;">Required</span>' : 'Optional'}
                    </td>
                  </tr>
                `;
              });
              
              html += `
                      </tbody>
                    </table>
                    
                    <div style="display: flex; justify-content: space-between; margin-top: 20px;">
                      <button type="button" class="secondary-btn" onclick="window.showFormatterPanels()" style="padding: 10px 20px; background-color: #f8f9fa; border: 1px solid #ddd; border-radius: 4px; cursor: pointer;">
                        Cancel
                      </button>
                      <button type="button" id="apply-mappings-btn" class="primary-btn" style="padding: 10px 20px; background-color: #2196f3; color: white; border: none; border-radius: 4px; cursor: pointer;">
                        Apply Mappings
                      </button>
                    </div>
                  </form>
                </div>
              `;
              
              // Update the container
              container.innerHTML = html;
              
              // Add event listener for the apply button
              const applyBtn = document.getElementById('apply-mappings-btn');
              if (applyBtn) {
                applyBtn.addEventListener('click', function() {
                  // Collect the mappings
                  const mappings = {};
                  const form = document.getElementById('emergency-mapping-form');
                  if (!form) return;
                  
                  // Get all selects
                  const selects = form.querySelectorAll('select');
                  selects.forEach(select => {
                    if (select.value) {
                      mappings[select.name] = select.value;
                    }
                  });
                  
                  // Check if all required fields are mapped
                  const requiredFields = targetFields.filter(f => f.required);
                  const missingRequired = requiredFields.filter(field => 
                    !mappings[field.id]
                  );
                  
                  if (missingRequired.length > 0) {
                    alert(`Please map all required fields. Missing: ${missingRequired.map(f => f.name).join(', ')}`);
                    return;
                  }
                  
                  // Save mappings to formatterState
                  if (window.formatterState) {
                    // Format mappings correctly
                    const formattedMappings = {};
                    Object.entries(mappings).forEach(([fieldId, columnName]) => {
                      formattedMappings[fieldId] = { sourceId: columnName };
                    });
                    
                    window.formatterState.mappings = formattedMappings;
                    window.formatterState.selectedTool = selectedTool;
                    
                    // Log and enable download
                    const logContainer = document.getElementById('log-container');
                    if (logContainer) {
                      const timestamp = new Date().toLocaleTimeString();
                      logContainer.innerHTML += `<div class="log-entry log-info">
                        <span class="log-time">${timestamp}</span> 
                        Field mapping completed in emergency mode. ${Object.keys(mappings).length} fields mapped.
                      </div>`;
                    }
                    
                    // Enable download button if it exists
                    const downloadBtn = document.getElementById('download-btn');
                    if (downloadBtn) downloadBtn.disabled = false;
                    
                    // Show sample output
                    createSampleOutput();
                    
                    // Return to formatter
                    window.showFormatterPanels();
                  }
                });
              }
            }
            
            // Emergency mode script
            function loadEmergencyLibrary() {
              return new Promise((resolve, reject) => {
                // If already loaded
                if (window.FireEMS && window.FireEMS.EmergencyMode) {
                  console.log('Emergency mode library already loaded');
                  resolve(window.FireEMS.EmergencyMode);
                  return;
                }
                
                // Try to load it
                const script = document.createElement('script');
                script.src = '/app-static/js/emergency-mode.js';
                
                script.onload = function() {
                  console.log('Emergency mode library loaded');
                  if (window.FireEMS && window.FireEMS.EmergencyMode) {
                    resolve(window.FireEMS.EmergencyMode);
                  } else {
                    reject(new Error('Emergency mode library failed to initialize'));
                  }
                };
                
                script.onerror = function() {
                  console.error('Failed to load emergency mode library');
                  reject(new Error('Failed to load emergency mode library'));
                };
                
                document.body.appendChild(script);
              });
            }
            
            // Create a sample output preview
            function createSampleOutput() {
              const outputPreview = document.getElementById('output-preview');
              if (!outputPreview) return;
              
              // Only proceed if we have sample data
              if (!window.formatterState || !window.formatterState.sampleData || !window.formatterState.mappings) {
                return;
              }
              
              const sampleData = window.formatterState.sampleData;
              const mappings = window.formatterState.mappings;
              
              // Transform the data based on mappings
              const transformedData = sampleData.map(row => {
                const transformed = {};
                
                // Apply each mapping
                Object.entries(mappings).forEach(([targetField, mapping]) => {
                  const sourceColumn = mapping.sourceId || mapping;
                  transformed[targetField] = row[sourceColumn] || '';
                });
                
                return transformed;
              });
              
              // Show preview of first 5 rows
              let html = '<table class="preview-table"><thead><tr>';
              
              // Create headers from target fields
              const headers = Object.keys(mappings);
              headers.forEach(header => {
                html += `<th>${header}</th>`;
              });
              
              html += '</tr></thead><tbody>';
              
              // Check if we're processing Data1G.csv
              const filename = sessionStorage.getItem('currentFileName') || localStorage.getItem('currentFileName') || '';
              const isLargeFile = filename.toLowerCase().includes('data1g') || transformedData.length > 1000;
              
              // Use larger preview size for Data1G.csv or other large files
              const previewSize = isLargeFile ? 100 : 5;
              console.log(`Using preview size of ${previewSize} rows for output display (large file: ${isLargeFile})`);
              
              // Add rows to preview
              const rowsToShow = Math.min(transformedData.length, previewSize);
              for (let i = 0; i < rowsToShow; i++) {
                html += '<tr>';
                headers.forEach(header => {
                  html += `<td>${transformedData[i][header] || ''}</td>`;
                });
                html += '</tr>';
              }
              
              html += '</tbody></table>';
              outputPreview.innerHTML = html;
              
              // Save transformed data to state
              window.formatterState.transformedData = transformedData;
              
              // Enable download and send buttons
              const downloadBtn = document.getElementById('download-btn');
              const sendToToolBtn = document.getElementById('send-to-tool-btn');
              
              if (downloadBtn) {
                downloadBtn.disabled = false;
                
                // Add emergency event listener for download button
                downloadBtn.addEventListener('click', function() {
                  downloadTransformedData();
                });
              }
              
              if (sendToToolBtn) {
                sendToToolBtn.disabled = false;
                
                // Add emergency event listener for send to tool button
                sendToToolBtn.addEventListener('click', function() {
                  sendDataToTool();
                });
              }
              
              // Log action
              const logContainer = document.getElementById('log-container');
              if (logContainer) {
                const timestamp = new Date().toLocaleTimeString();
                // Calculate how many rows are actually visible in the preview
                const filename = sessionStorage.getItem('currentFileName') || localStorage.getItem('currentFileName') || '';
                const isLargeFile = filename.toLowerCase().includes('data1g') || transformedData.length > 1000;
                const previewSize = isLargeFile ? 100 : 5;
                const visibleRows = Math.min(transformedData.length, previewSize);
                
                // Include both visible and total count in the message
                logContainer.innerHTML += `<div class="log-entry log-info">
                  <span class="log-time">${timestamp}</span> 
                  Data transformation complete. Preview shows ${visibleRows} of ${transformedData.length} total record(s).
                  ${isLargeFile ? ' <b>(Using enhanced preview for large file)</b>' : ''}
                </div>`;
              }
            }
            
            // Emergency download functionality using shared library
            function downloadTransformedData() {
              console.log("Emergency download functionality activated");
              
              // Check if we have transformed data
              if (!window.formatterState || !window.formatterState.transformedData || window.formatterState.transformedData.length === 0) {
                alert("No transformed data available to download");
                return;
              }
              
              // Get selected output format
              const outputFormat = document.getElementById('output-format');
              const format = outputFormat ? outputFormat.value : 'csv';
              
              // Try to use the emergency mode library
              loadEmergencyLibrary().then(emergencyMode => {
                try {
                  // Get the data
                  const data = window.formatterState.transformedData;
                  
                  // Use the library to download
                  const success = emergencyMode.downloadData(data, {
                    format: format,
                    filename: 'transformed-data'
                  });
                  
                  if (success) {
                    // Log success
                    const logContainer = document.getElementById('log-container');
                    if (logContainer) {
                      const timestamp = new Date().toLocaleTimeString();
                      logContainer.innerHTML += `<div class="log-entry log-success">
                        <span class="log-time">${timestamp}</span> 
                        File downloaded successfully in emergency mode (${format} format).
                      </div>`;
                    }
                  } else {
                    throw new Error("Download failed");
                  }
                } catch (error) {
                  // Log error
                  console.error("Download error:", error);
                  
                  // Show error in log
                  const logContainer = document.getElementById('log-container');
                  if (logContainer) {
                    const timestamp = new Date().toLocaleTimeString();
                    logContainer.innerHTML += `<div class="log-entry log-error">
                      <span class="log-time">${timestamp}</span> 
                      Download failed: ${error.message}
                    </div>`;
                  }
                  
                  alert("Error creating download file: " + error.message);
                  
                  // Fall back to direct implementation if library fails
                  fallbackDownload(data, format);
                }
              }).catch(error => {
                console.error("Failed to load emergency library:", error);
                
                // Fall back to direct implementation
                fallbackDownload(window.formatterState.transformedData, format);
              });
            }
            
            // Fallback download functionality if library fails
            function fallbackDownload(data, format) {
              try {
                console.log("Using fallback download implementation");
                const headers = Object.keys(data[0]);
                
                // Prepare content based on format
                let content = '';
                let fileName = 'transformed-data';
                let mimeType = '';
                
                if (format === 'csv') {
                  // CSV format
                  content = headers.join(',') + '\n';
                  
                  data.forEach(row => {
                    const values = headers.map(header => {
                      // Handle values with commas by wrapping in quotes
                      const value = row[header] || '';
                      return value.includes(',') ? `"${value}"` : value;
                    });
                    content += values.join(',') + '\n';
                  });
                  
                  fileName += '.csv';
                  mimeType = 'text/csv';
                } else if (format === 'json') {
                  // JSON format
                  content = JSON.stringify(data, null, 2);
                  fileName += '.json';
                  mimeType = 'application/json';
                } else if (format === 'excel') {
                  // Fall back to CSV
                  alert("Excel format not available in emergency mode. Downloading as CSV instead.");
                  content = headers.join(',') + '\n';
                  
                  data.forEach(row => {
                    const values = headers.map(header => {
                      const value = row[header] || '';
                      return value.includes(',') ? `"${value}"` : value;
                    });
                    content += values.join(',') + '\n';
                  });
                  
                  fileName += '.csv';
                  mimeType = 'text/csv';
                }
                
                // Create a Blob and download link
                const blob = new Blob([content], { type: mimeType });
                const url = URL.createObjectURL(blob);
                
                // Create temporary link and trigger download
                const link = document.createElement('a');
                link.href = url;
                link.download = fileName;
                document.body.appendChild(link);
                link.click();
                
                // Clean up
                setTimeout(() => {
                  document.body.removeChild(link);
                  URL.revokeObjectURL(url);
                }, 100);
                
                // Log success
                const logContainer = document.getElementById('log-container');
                if (logContainer) {
                  const timestamp = new Date().toLocaleTimeString();
                  logContainer.innerHTML += `<div class="log-entry log-info">
                    <span class="log-time">${timestamp}</span> 
                    File downloaded with fallback method (${format} format).
                  </div>`;
                }
              } catch (error) {
                console.error("Fallback download error:", error);
                alert("Error in fallback download: " + error.message);
              }
            }
            
            // Emergency send to tool functionality
            function sendDataToTool() {
              console.log("Emergency send to tool functionality activated");
              
              // Check if we have transformed data
              if (!window.formatterState || !window.formatterState.transformedData || window.formatterState.transformedData.length === 0) {
                alert("No transformed data available to send");
                return;
              }
              
              // Get target tool
              const toolSelect = document.getElementById('target-tool');
              if (!toolSelect) {
                alert("Cannot identify target tool");
                return;
              }
              
              const selectedTool = toolSelect.value;
              if (!selectedTool) {
                alert("Please select a target tool first");
                return;
              }
              
              // Map tool selection to target URL path
              const toolMapping = {
                'response-time': 'fire-ems-dashboard',
                'isochrone': 'isochrone-map',
                'isochrone-stations': 'isochrone-map',
                'isochrone-incidents': 'isochrone-map',
                'call-density': 'call-density-heatmap',
                'incident-logger': 'incident-logger',
                'coverage-gap': 'coverage-gap-finder',
                'station-overview': 'station-overview',
                'fire-map-pro': 'fire-map-pro'
              };
              
              const targetTool = toolMapping[selectedTool] || selectedTool;
              
              // Try to use the emergency mode library
              loadEmergencyLibrary().then(emergencyMode => {
                try {
                  // Get the data
                  const data = window.formatterState.transformedData;
                  
                  // Use the library to send to tool
                  const success = emergencyMode.sendToTool(data, targetTool, {
                    // Set expiration to 1 hour
                    expiration: 60 * 60 * 1000
                  });
                  
                  if (success) {
                    // Log success (though we'll be redirecting)
                    const logContainer = document.getElementById('log-container');
                    if (logContainer) {
                      const timestamp = new Date().toLocaleTimeString();
                      logContainer.innerHTML += `<div class="log-entry log-success">
                        <span class="log-time">${timestamp}</span> 
                        Data prepared for ${selectedTool}. Redirecting to target tool...
                      </div>`;
                    }
                  } else {
                    throw new Error("Send to tool failed");
                  }
                } catch (error) {
                  // Log error
                  console.error("Send to tool error:", error);
                  
                  // Show error in log
                  const logContainer = document.getElementById('log-container');
                  if (logContainer) {
                    const timestamp = new Date().toLocaleTimeString();
                    logContainer.innerHTML += `<div class="log-entry log-error">
                      <span class="log-time">${timestamp}</span> 
                      Failed to send data to tool: ${error.message}
                    </div>`;
                  }
                  
                  alert("Error sending data to tool: " + error.message);
                  
                  // Fall back to direct implementation if library fails
                  fallbackSendToTool(data, targetTool);
                }
              }).catch(error => {
                console.error("Failed to load emergency library:", error);
                
                // Fall back to direct implementation
                fallbackSendToTool(window.formatterState.transformedData, targetTool);
              });
            }
            
            // Fallback send to tool if library fails
            function fallbackSendToTool(data, targetTool) {
              try {
                console.log("Using fallback send to tool implementation");
                
                // Generate a unique ID for this data transfer
                const dataId = 'emergency_data_' + Date.now();
                
                // Check if the data is too large for localStorage
                // Serialize the data first to check size
                const serializedData = JSON.stringify(data);
                const dataSize = new Blob([serializedData]).size;
                
                if (dataSize > 5000000) { // ~5MB limit for most browsers
                  alert("Data is too large to send directly. Please use the Download option instead and manually upload the file.");
                  return;
                }
                
                // Store data in localStorage
                localStorage.setItem(dataId, serializedData);
                
                // Build target URL
                const targetUrl = `/${targetTool}?emergency_data=${dataId}`;
                
                // Log the action
                const logContainer = document.getElementById('log-container');
                if (logContainer) {
                  const timestamp = new Date().toLocaleTimeString();
                  logContainer.innerHTML += `<div class="log-entry log-info">
                    <span class="log-time">${timestamp}</span> 
                    Using fallback method to send data to ${targetTool}. (${Math.round(dataSize / 1024)} KB)
                  </div>`;
                }
                
                // Navigate to the target tool with a slight delay
                setTimeout(() => {
                  window.location.href = targetUrl;
                }, 1000);
              } catch (error) {
                console.error("Fallback send to tool error:", error);
                alert("Error in fallback send to tool: " + error.message);
              }
            }
          });
        </script>
      </div>
      
      <div class="formatter-panel center-panel">
        <h2>Transformation Settings</h2>
        
        <div class="transformation-options">
          <div class="target-tool-section">
            <label for="target-tool">Target Tool:</label>
            <select id="target-tool">
              <option value="" disabled selected>Select target tool</option>
              <option value="response-time">Response Time Analyzer</option>
              <option value="isochrone">Isochrone Map Generator</option>
              <option value="isochrone-stations">Isochrone Map - Station Locations</option>
              <option value="isochrone-incidents">Isochrone Map - Incident Data</option>
              <option value="call-density">Call Density Heatmap</option>
              <option value="incident-logger">Incident Logger</option>
              <option value="coverage-gap">Coverage Gap Finder</option>
              <option value="station-overview">Station Overview</option>
              <option value="fire-map-pro">FireMapPro</option>
            </select>
            
            <div class="info-tooltip">
              <i class="fas fa-info-circle"></i>
              <div class="tooltip-content">
                Select the tool you want to prepare data for. The formatter will automatically adjust data to meet that tool's requirements.
              </div>
            </div>
          </div>
        </div>
        
        <div class="action-buttons">
          <button id="map-fields-btn" class="primary-btn" disabled>
            <i class="fas fa-exchange-alt"></i> Map Fields
          </button>
          <button id="clear-btn" class="secondary-btn" disabled>
            <i class="fas fa-trash-alt"></i> Clear
          </button>
        </div>
        
        <div class="options-container">
          <div class="options-header collapsed" id="advanced-toggle">
            <h3>Advanced Options</h3>
            <i class="fas fa-chevron-down"></i>
          </div>
          
          <div class="advanced-options" style="display: none;">
            <div class="option-group">
              <label for="date-format">Date Format:</label>
              <select id="date-format">
                <option value="auto">Auto-detect</option>
                <option value="mm/dd/yyyy">MM/DD/YYYY</option>
                <option value="dd/mm/yyyy">DD/MM/YYYY</option>
                <option value="yyyy-mm-dd">YYYY-MM-DD</option>
                <option value="custom">Custom...</option>
              </select>
              <input type="text" id="custom-date-format" placeholder="Custom format" style="display: none;">
            </div>
            
            <div class="option-group">
              <label for="compression">Compression:</label>
              <select id="compression">
                <option value="none">None</option>
                <option value="light">Light</option>
                <option value="medium">Medium</option>
                <option value="high">High</option>
              </select>
            </div>
            
            <div class="option-group checkbox">
              <input type="checkbox" id="remove-duplicates" checked>
              <label for="remove-duplicates">Remove duplicate entries</label>
            </div>
            
            <div class="option-group checkbox">
              <input type="checkbox" id="clean-addresses" checked>
              <label for="clean-addresses">Clean and standardize addresses</label>
            </div>
            
            <div class="option-group checkbox">
              <input type="checkbox" id="handle-missing">
              <label for="handle-missing">Handle missing values</label>
            </div>
            
            <div class="missing-values-options" style="display: none;">
              <label for="missing-strategy">Missing Value Strategy:</label>
              <select id="missing-strategy">
                <option value="remove-rows">Remove rows with missing values</option>
                <option value="fill-default">Fill with default values</option>
                <option value="interpolate">Interpolate where possible</option>
              </select>
            </div>
          </div>
        </div>
        
        <div class="transformation-log">
          <h3>Transformation Log</h3>
          <div id="log-container" class="log-content">
            <p class="log-placeholder">Transformation details will appear here</p>
          </div>
        </div>
      </div>
      
      <div class="formatter-panel right-panel">
        <h2>Output Data</h2>
        
        <div class="output-format-section">
          <label for="output-format">Output Format:</label>
          <select id="output-format">
            <option value="csv">CSV</option>
            <option value="excel">Excel</option>
            <option value="json">JSON</option>
          </select>
        </div>
        
        <div class="preview-container">
          <h3>Output Preview</h3>
          <div id="output-preview" class="data-preview">
            <div class="placeholder-message">
              <i class="fas fa-arrow-left"></i>
              <p>Transform data to preview</p>
            </div>
          </div>
        </div>
        
        <div class="download-section">
          <button id="download-btn" class="primary-btn" disabled>
            <i class="fas fa-download"></i> Download
          </button>
          
          <button id="send-to-tool-btn" class="primary-btn" disabled>
            <i class="fas fa-paper-plane"></i> Send to Tool
          </button>
        </div>
      </div>
    </section>
    
    <section class="requirements-container">
      <div class="requirements-header collapsed" id="requirements-toggle">
        <h2>Tool-specific Data Requirements</h2>
        <i class="fas fa-chevron-down"></i>
      </div>
      
      <div class="requirements-content" style="display: none;">
        <div class="tool-requirements" id="response-time-requirements">
          <h3>Response Time Analyzer</h3>
          <p>Required fields:</p>
          <ul>
            <li>Incident ID</li>
            <li>Incident Date</li>
            <li>Incident Time</li>
            <li>Dispatch Time</li>
            <li>En Route Time</li>
            <li>On Scene Time</li>
            <li>Incident Type</li>
            <li>Latitude</li>
            <li>Longitude</li>
          </ul>
        </div>
        
        <div class="tool-requirements" id="isochrone-requirements">
          <h3>Isochrone Map Generator</h3>
          <p>Required fields:</p>
          <ul>
            <li>Station ID</li>
            <li>Station Name</li>
            <li>Station Address</li>
            <li>Latitude</li>
            <li>Longitude</li>
            <li>Unit Types</li>
          </ul>
        </div>
        
        <div class="tool-requirements" id="call-density-requirements">
          <h3>Call Density Heatmap</h3>
          <p>Required fields:</p>
          <ul>
            <li>Incident ID</li>
            <li>Incident Date</li>
            <li>Incident Time</li>
            <li>Latitude</li>
            <li>Longitude</li>
            <li>Incident Type (optional)</li>
          </ul>
        </div>
        
        <div class="tool-requirements" id="cad-system-requirements">
          <h3>Supported CAD/RMS Systems</h3>
          <p>This tool can automatically detect and process data from:</p>
          <ul>
            <li>Emergency Reporting - NFIRS-compliant format</li>
            <li>ESO FireRMS - Medical/Fire hybrid format</li>
            <li>ImageTrend - EMS/Fire Records Management System</li>
            <li>Spillman Flex (Motorola) - Law enforcement integration</li>
            <li>CentralSquare Small Agency - Simplified exports</li>
            <li>Alpine Software/RedNMX - Rural department focused</li>
            <li>Regional Shared Systems - Standardized formats</li>
            <li>Central Square CAD - Standard format</li>
            <li>Motorola/PremierOne CAD</li>
            <li>Tyler New World CAD</li>
            <li>Hexagon/Intergraph CAD</li>
          </ul>
        </div>
          
        <div class="tool-requirements" id="other-requirements">
          <h3>Other Tools</h3>
          <p>Requirements for other tools will be displayed when selected</p>
        </div>
      </div>
    </section>
  </main>

  <footer>
    <div class="container">
      <p>&copy; 2025 FireEMS.ai - Advanced Analytics for Fire & EMS Agencies</p>
    </div>
  </footer>

  <!-- Core dependencies for React and Material UI -->
  <script src="https://cdn.jsdelivr.net/npm/react@17/umd/react.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/react-dom@17/umd/react-dom.production.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@material-ui/core@4.12.3/umd/material-ui.production.min.js"></script>
  
  <!-- Robust JavaScript loading with fallbacks -->
  <script>
    function loadScript(url, fallbackUrl, callback) {
      console.log(`Attempting to load script: ${url}`);
      const script = document.createElement('script');
      script.src = url;
      
      script.onload = function() {
        console.log(`Successfully loaded: ${url}`);
        if (callback) callback(true);
      };
      
      script.onerror = function() {
        console.warn(`Failed to load script from ${url}, trying fallback...`);
        
        // Try first fallback
        const fallbackScript = document.createElement('script');
        fallbackScript.src = fallbackUrl;
        
        fallbackScript.onload = function() {
          console.log(`Successfully loaded fallback: ${fallbackUrl}`);
          if (callback) callback(true);
        };
        
        fallbackScript.onerror = function() {
          console.error(`Fallback script load failed for ${fallbackUrl}`);
          
          // Try emergency fallback with app-static
          const emergencyScript = document.createElement('script');
          emergencyScript.src = url.replace('/static/', '/app-static/');
          
          emergencyScript.onload = function() {
            console.log(`Emergency load succeeded: ${emergencyScript.src}`);
            if (callback) callback(true);
          };
          
          emergencyScript.onerror = function() {
            console.error(`All script loading attempts failed for ${url}`);
            if (callback) callback(false);
          };
          
          document.body.appendChild(emergencyScript);
        };
        
        document.body.appendChild(fallbackScript);
      };
      
      document.body.appendChild(script);
    }
    
    // Load column mapping CSS with fallback
    loadCSS('/static/column-mapping.css', '/direct-static/column-mapping.css');
    
    // Load main bundle
    loadScript('/static/data-formatter-bundle.js?v=1.0.1', '/direct-static/data-formatter-bundle.js', function(success) {
      if (!success) {
        console.error("Failed to load main bundle even with fallbacks");
        
        // Show error to user
        const container = document.querySelector('.formatter-container');
        if (container) {
          const errorMsg = document.createElement('div');
          errorMsg.className = 'error-message';
          errorMsg.innerHTML = `
            <h3>Error Loading Data Formatter</h3>
            <p>The application components failed to load properly. Please try:</p>
            <ol>
              <li>Refreshing the page</li>
              <li>Clearing your browser cache</li>
              <li>Trying a different browser</li>
            </ol>
            <p>Technical details: Failed to load bundle after multiple attempts.</p>
            <button onclick="location.reload()">Refresh Page</button>
            <button onclick="loadDirect()">Try Emergency Mode</button>
          `;
          container.prepend(errorMsg);
        }
      }
    });
    
    // Emergency direct script loading
    function loadDirect() {
      console.log("Attempting emergency direct loading of critical components");
      
      // Clear any existing error messages
      const existingErrors = document.querySelectorAll('.error-message');
      existingErrors.forEach(el => el.remove());
      
      // Show loading message
      const container = document.querySelector('.formatter-container');
      if (container) {
        const loadingMsg = document.createElement('div');
        loadingMsg.className = 'loading-message';
        loadingMsg.innerHTML = '<h3>Loading Emergency Mode...</h3><p>Please wait while we load critical components...</p>';
        container.prepend(loadingMsg);
      }
      
      // Try to load each component directly
      const scripts = [
        '/app-static/data-formatter-direct.js',
        '/app-static/data-formatter-fix.js',
        '/app-static/data-formatter-integration.js'
      ];
      
      let loaded = 0;
      scripts.forEach(script => {
        const scriptEl = document.createElement('script');
        scriptEl.src = script;
        
        scriptEl.onload = function() {
          console.log(`Emergency loaded: ${script}`);
          loaded++;
          if (loaded === scripts.length) {
            // All scripts loaded, try to initialize
            if (container) {
              const loadingMsg = document.querySelector('.loading-message');
              if (loadingMsg) loadingMsg.remove();
              
              const successMsg = document.createElement('div');
              successMsg.className = 'success-message';
              successMsg.innerHTML = '<h3>Emergency Mode Loaded</h3><p>Basic functionality should now be available.</p>';
              container.prepend(successMsg);
            }
          }
        };
        
        document.body.appendChild(scriptEl);
      });
    }
  </script>
  
  <!-- Simple error detection in case the bundle fails -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Wait 3 seconds then check if the formatter was loaded
      setTimeout(function() {
        if (!window.dataFormatterLoaded) {
          console.error('Data formatter failed to load within timeout period');
          
          // If not already showing an error message, create one
          if (!document.querySelector('.error-message')) {
            // Create error message for user
            var container = document.querySelector('.formatter-container');
            if (container) {
              var errorMsg = document.createElement('div');
              errorMsg.className = 'error-message';
              errorMsg.innerHTML = '<h3>Error Loading Data Formatter</h3>' +
                                  '<p>The application components failed to load properly. Please try:</p>' +
                                  '<ol>' +
                                    '<li>Refreshing the page</li>' +
                                    '<li>Clearing your browser cache</li>' +
                                    '<li>Trying a different browser</li>' +
                                  '</ol>' +
                                  '<button onclick="location.reload()">Refresh Page</button>' +
                                  '<button onclick="loadDirect()">Try Emergency Mode</button>';
              
              container.prepend(errorMsg);
            }
          }
        }
      }, 3000);
    });
  </script>
  
  <!-- Handle tool preselection from URL parameter -->
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Check if tool parameter was passed in URL
      {% if tool %}
        // Pre-select the target tool
        const toolSelect = document.getElementById('target-tool');
        if (toolSelect) {
          toolSelect.value = '{{ tool }}';
          
          // Trigger the change event to update requirements
          const event = new Event('change');
          toolSelect.dispatchEvent(event);
        }
      {% endif %}
      
      // Setup UI events for manual field mapping
      const mapFieldsBtn = document.getElementById('map-fields-btn');
      const clearBtn = document.getElementById('clear-btn');
      const mappingContainer = document.getElementById('column-mapping-container');
      const formatterPanels = document.querySelectorAll('.formatter-panel');
      const showInstructionsBtn = document.getElementById('show-instructions');
      const closeInstructionsBtn = document.getElementById('close-instructions');
      const instructionsPanel = document.getElementById('instructions-panel');
      const advancedToggle = document.getElementById('advanced-toggle');
      const advancedOptions = document.querySelector('.advanced-options');
      const requirementsToggle = document.getElementById('requirements-toggle');
      const requirementsContent = document.querySelector('.requirements-content');
      const dateFormatSelect = document.getElementById('date-format');
      const customDateFormatInput = document.getElementById('custom-date-format');
      const handleMissingCheckbox = document.getElementById('handle-missing');
      const missingValuesOptions = document.querySelector('.missing-values-options');
      
      // Setup instructions toggle
      if (showInstructionsBtn && instructionsPanel) {
        showInstructionsBtn.addEventListener('click', function() {
          instructionsPanel.style.display = 'block';
        });
      }
      
      if (closeInstructionsBtn && instructionsPanel) {
        closeInstructionsBtn.addEventListener('click', function() {
          instructionsPanel.style.display = 'none';
        });
      }
      
      // Setup advanced options toggle
      if (advancedToggle && advancedOptions) {
        advancedToggle.addEventListener('click', function() {
          advancedOptions.style.display = advancedOptions.style.display === 'none' ? 'block' : 'none';
          advancedToggle.classList.toggle('collapsed');
          
          // Update chevron icon
          const chevron = advancedToggle.querySelector('i');
          if (chevron) {
            chevron.classList.toggle('fa-chevron-down');
            chevron.classList.toggle('fa-chevron-up');
          }
        });
      }
      
      // Setup requirements toggle
      if (requirementsToggle && requirementsContent) {
        requirementsToggle.addEventListener('click', function() {
          requirementsContent.style.display = requirementsContent.style.display === 'none' ? 'block' : 'none';
          requirementsToggle.classList.toggle('collapsed');
          
          // Update chevron icon
          const chevron = requirementsToggle.querySelector('i');
          if (chevron) {
            chevron.classList.toggle('fa-chevron-down');
            chevron.classList.toggle('fa-chevron-up');
          }
        });
      }
      
      // Show custom date format input when "Custom" is selected
      if (dateFormatSelect && customDateFormatInput) {
        dateFormatSelect.addEventListener('change', function() {
          customDateFormatInput.style.display = dateFormatSelect.value === 'custom' ? 'block' : 'none';
        });
      }
      
      // Show missing values options when "Handle missing values" is checked
      if (handleMissingCheckbox && missingValuesOptions) {
        handleMissingCheckbox.addEventListener('change', function() {
          missingValuesOptions.style.display = handleMissingCheckbox.checked ? 'block' : 'none';
        });
      }
      
      if (mapFieldsBtn && mappingContainer) {
        mapFieldsBtn.addEventListener('click', function() {
          // Show the mapping interface
          mappingContainer.style.display = 'block';
          
          // Hide the main formatter container
          formatterPanels.forEach(panel => {
            panel.style.display = 'none';
          });
          
          // Log the action
          if (window.appendLog && typeof window.appendLog === 'function') {
            window.appendLog('Opening field mapping interface. Map your source columns to target fields.');
          }
        });
        
        // Add global function to return to formatter
        window.showFormatterPanels = function() {
          // Show formatter panels
          formatterPanels.forEach(panel => {
            panel.style.display = 'block';
          });
          
          // Hide mapping container
          mappingContainer.style.display = 'none';
          
          // Log the action
          if (window.appendLog && typeof window.appendLog === 'function') {
            window.appendLog('Field mapping completed. Review the transformed data in the output preview.');
          }
        };
        
        // Add global function to show a download button
        window.enableDownloadButtons = function() {
          const downloadBtn = document.getElementById('download-btn');
          const sendToToolBtn = document.getElementById('send-to-tool-btn');
          
          if (downloadBtn) downloadBtn.disabled = false;
          if (sendToToolBtn) sendToToolBtn.disabled = false;
          
          // Also focus on the output preview section
          const outputPreview = document.getElementById('output-preview');
          if (outputPreview) {
            // Add a highlight effect to draw attention
            outputPreview.classList.add('highlight-preview');
            setTimeout(() => {
              outputPreview.classList.remove('highlight-preview');
            }, 1500);
            
            // Scroll to the output preview
            outputPreview.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
          }
        };
      }
      
      // Clear button functionality
      if (clearBtn) {
        clearBtn.addEventListener('click', function() {
          // Reset file input
          const fileInput = document.getElementById('data-file');
          const fileNameDisplay = document.getElementById('file-name');
          if (fileInput) {
            fileInput.value = '';
          }
          if (fileNameDisplay) {
            fileNameDisplay.textContent = 'No file selected';
          }
          
          // Clear previews
          const inputPreview = document.getElementById('input-preview');
          const outputPreview = document.getElementById('output-preview');
          
          if (inputPreview) {
            inputPreview.innerHTML = `
              <div class="placeholder-message">
                <i class="fas fa-arrow-up"></i>
                <p>Upload a file to preview</p>
              </div>
            `;
          }
          
          if (outputPreview) {
            outputPreview.innerHTML = `
              <div class="placeholder-message">
                <i class="fas fa-arrow-left"></i>
                <p>Transform data to preview</p>
              </div>
            `;
          }
          
          // Clear log
          const logContainer = document.getElementById('log-container');
          if (logContainer) {
            logContainer.innerHTML = '<p class="log-placeholder">Transformation details will appear here</p>';
          }
          
          // Disable buttons
          if (mapFieldsBtn) mapFieldsBtn.disabled = true;
          const downloadBtn = document.getElementById('download-btn');
          const sendToToolBtn = document.getElementById('send-to-tool-btn');
          if (downloadBtn) downloadBtn.disabled = true;
          if (sendToToolBtn) sendToToolBtn.disabled = true;
          
          // Reset form state
          if (window.formatterState) {
            window.formatterState = {
              fileId: null,
              sourceColumns: [],
              sampleData: [],
              selectedTool: null,
              mappings: null,
              transformedData: null,
              originalData: null
            };
          }
          
          // Log action
          if (window.appendLog && typeof window.appendLog === 'function') {
            window.appendLog('Form cleared. Ready for new data.');
          }
        });
      }
      
      // Add the CSS for highlight effect
      const style = document.createElement('style');
      style.textContent = `
        @keyframes highlight-fade {
          0% { box-shadow: 0 0 0 2px #4caf50; }
          100% { box-shadow: 0 0 0 0 transparent; }
        }
        .highlight-preview {
          animation: highlight-fade 1.5s ease-out;
        }
      `;
      document.head.appendChild(style);
    });
    
    // Load emergency mode test script
    setTimeout(function() {
      const testScript = document.createElement('script');
      testScript.src = '/static/js/data-formatter-emergency-test.js';
      document.body.appendChild(testScript);
    }, 2000);
  </script>
</body>
</html>