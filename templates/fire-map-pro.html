<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireMapPro | FireEMS.ai</title>
    
    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fire-map-pro.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fix-ready-status.css') }}">
    
    <!-- Required scripts before content loads -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    
    <!-- Fix for Leaflet.Draw toolbar visibility -->
    <style>
        /* Comprehensive fix for all Leaflet.Draw elements */
        .leaflet-draw, 
        .leaflet-draw.leaflet-control,
        .leaflet-draw-toolbar, 
        .leaflet-draw-toolbar a, 
        .leaflet-draw-actions, 
        .leaflet-draw-actions a,
        [class*="leaflet-draw-"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 2000 !important;
            pointer-events: auto !important;
        }
        
        /* Ensure toolbar has proper background */
        .leaflet-draw-toolbar {
            background: white !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            border-radius: 4px !important;
        }
        
        /* Style buttons specifically */
        .leaflet-draw-toolbar a {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            text-align: center !important;
        }
        
        /* Make radio buttons more prominent */
        .radio-group input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-group label {
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }
        
        /* Add pointer cursor to all buttons */
        .tool-btn, button {
            cursor: pointer;
        }
    </style>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <a href="/">
                <i class="fas fa-fire"></i> FireEMS.ai
            </a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/fire-ems-dashboard">Response Time Analyzer</a>
            <a href="/isochrone-map">Isochrone Map Generator</a>
            <a href="/call-density-heatmap">Call Density Heatmap</a>
            <a href="/coverage-gap-finder">Coverage Gap Finder</a>
            <a href="/fire-map-pro" class="active">FireMapPro</a>
        </div>
    </div>

    <div class="container">
        <div class="panel-container">
            <div class="left-panel">
                <h2>FireMapPro</h2>
                <p>Advanced interactive map creator for fire department and EMS planning and analysis.</p>
                
                <div class="tools-section">
                    <h3><i class="fas fa-layer-group"></i> Map Layers</h3>
                    <div class="layer-controls">
                        <div class="base-layers">
                            <h4>Base Maps</h4>
                            <div class="radio-group">
                                <input type="radio" id="street-layer" name="base-layer" value="street" checked>
                                <label for="street-layer">Street</label>
                                
                                <input type="radio" id="satellite-layer" name="base-layer" value="satellite">
                                <label for="satellite-layer">Satellite</label>
                                
                                <input type="radio" id="terrain-layer" name="base-layer" value="terrain">
                                <label for="terrain-layer">Terrain</label>
                            </div>
                        </div>
                        
                        <div class="overlay-layers">
                            <h4>Data Overlays</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stations-layer" value="stations">
                                    <label for="stations-layer">Fire Stations</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="incidents-layer" value="incidents">
                                    <label for="incidents-layer">Incidents</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="response-layer" value="response">
                                    <label for="response-layer">Response Areas</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="population-layer" value="population">
                                    <label for="population-layer">Population Density</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hydrants-layer" value="hydrants">
                                    <label for="hydrants-layer">Hydrants</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-file-upload"></i> Custom Data</h3>
                    <div class="upload-section">
                        <h4>Import Data</h4>
                        <div class="file-upload">
                            <label for="geojson-upload" class="upload-btn">
                                <i class="fas fa-file-import"></i> GeoJSON / KML
                            </label>
                            <input type="file" id="geojson-upload" accept=".geojson,.json,.kml">
                        </div>
                        
                        <div class="file-upload">
                            <label for="csv-upload" class="upload-btn">
                                <i class="fas fa-table"></i> CSV with Coordinates
                            </label>
                            <input type="file" id="csv-upload" accept=".csv">
                        </div>
                        
                        <div class="file-upload">
                            <label for="image-upload" class="upload-btn">
                                <i class="fas fa-image"></i> Image Overlay
                            </label>
                            <input type="file" id="image-upload" accept="image/*">
                        </div>
                        <div id="upload-status"></div>
                        
                        <!-- CSV Configuration Options -->
                        <div class="csv-config-section">
                            <h4>CSV Import Settings</h4>
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-preview-enable" checked>
                                <label for="csv-preview-enable">Show preview before import</label>
                            </div>
                            
                            <div class="input-group">
                                <label for="csv-coord-format">Coordinate Format:</label>
                                <select id="csv-coord-format">
                                    <option value="lat_lng">Latitude, Longitude</option>
                                    <option value="lng_lat">Longitude, Latitude</option>
                                </select>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-header-detection" checked>
                                <label for="csv-header-detection">Auto-detect headers</label>
                            </div>
                            
                            <div class="info-text">
                                <i class="fas fa-info-circle"></i> Set coordinate format to "Longitude, Latitude" for Phoenix data
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-tools"></i> Map Tools</h3>
                    <div class="map-tools">
                        <button id="draw-tool" class="tool-btn">
                            <i class="fas fa-draw-polygon"></i> Draw & Measure
                        </button>
                        
                        <button id="search-tool" class="tool-btn">
                            <i class="fas fa-search-location"></i> Search Address
                        </button>
                        
                        <button id="filter-tool" class="tool-btn">
                            <i class="fas fa-filter"></i> Filter Data
                        </button>
                        
                        <button id="export-tool" class="tool-btn">
                            <i class="fas fa-file-export"></i> Export Map
                        </button>
                        
                        <button id="icon-tool" class="tool-btn">
                            <i class="fas fa-icons"></i> Add Icons
                        </button>
                        
                        <button id="clear-map" class="tool-btn danger">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div id="icon-container" class="tools-section" style="display: none;">
                    <!-- Icon content is omitted for brevity, it will be loaded from the original JS -->
                </div>
                
                <div id="search-container" class="tools-section" style="display: none;">
                    <!-- Search content is omitted for brevity, it will be loaded from the original JS -->
                </div>
                
                <div id="filter-container" class="tools-section" style="display: none;">
                    <!-- Filter content is omitted for brevity, it will be loaded from the original JS -->
                </div>
                
                <div id="export-container" class="tools-section" style="display: none;">
                    <!-- Export content is omitted for brevity, it will be loaded from the original JS -->
                </div>
                
                <div id="measurement-info" class="tools-section" style="display: none;">
                    <!-- Measurement content is omitted for brevity, it will be loaded from the original JS -->
                </div>
            </div>
            
            <div class="right-panel">
                <div id="map"></div>
                <div class="map-status-bar">
                    <div class="status-item">
                        <span>Zoom: </span>
                        <span id="zoom-level">-</span>
                    </div>
                    <div class="status-item">
                        <span>Center: </span>
                        <span id="map-center">-</span>
                    </div>
                    <div class="status-item">
                        <span>Mouse: </span>
                        <span id="mouse-position">-</span>
                    </div>
                    <div class="status-item">
                        <span>Scale: </span>
                        <span id="map-scale">-</span>
                    </div>
                </div>
                <div id="legend" class="map-legend">
                    <h4>Legend</h4>
                    <div id="legend-content">
                        <!-- Legend items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="footer-content">
            <div class="copyright">
                &copy; 2025 FireEMS.ai | Advanced Fire &amp; EMS Planning Tools
            </div>
        </div>
    </footer>
    
    <!-- Direct inline script to handle layer switching and drawing tools -->
    <script>
        // Wait for page load
        window.addEventListener('load', function() {
            console.log('*** DIRECT INITIALIZATION STARTING ***');
            
            // Create map and base layers
            var map = L.map('map', {
                center: [33.4484, -112.0740],  // Phoenix
                zoom: 11
            });
            
            // Create the base layers with specific names
            var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19
            });
            
            var satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                attribution: 'Imagery &copy; Esri',
                maxZoom: 19
            });
            
            var terrainLayer = L.tileLayer('https://stamen-tiles-{s}.a.ssl.fastly.net/terrain/{z}/{x}/{y}{r}.png', {
                attribution: 'Map tiles by <a href="http://stamen.com">Stamen Design</a>',
                maxZoom: 18
            });
            
            // Add the street layer by default
            streetLayer.addTo(map);
            
            // Set up layer storage for the main script
            window.map = map;
            window.streetLayer = streetLayer;
            window.satelliteLayer = satelliteLayer;
            window.terrainLayer = terrainLayer;
            
            // Set up direct layer switching
            function switchBaseLayer(layerName) {
                console.log('Switching to layer:', layerName);
                
                // Remove all current base layers
                if (map.hasLayer(streetLayer)) map.removeLayer(streetLayer);
                if (map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer);
                if (map.hasLayer(terrainLayer)) map.removeLayer(terrainLayer);
                
                // Add the selected layer
                if (layerName === 'street') {
                    map.addLayer(streetLayer);
                    document.getElementById('street-layer').checked = true;
                } 
                else if (layerName === 'satellite') {
                    map.addLayer(satelliteLayer);
                    document.getElementById('satellite-layer').checked = true;
                }
                else if (layerName === 'terrain') {
                    map.addLayer(terrainLayer);
                    document.getElementById('terrain-layer').checked = true;
                }
            }
            
            // Add direct event listeners for radio buttons
            document.getElementById('street-layer').addEventListener('click', function() {
                switchBaseLayer('street');
            });
            
            document.getElementById('satellite-layer').addEventListener('click', function() {
                switchBaseLayer('satellite');
            });
            
            document.getElementById('terrain-layer').addEventListener('click', function() {
                switchBaseLayer('terrain');
            });
            
            // Set up drawing tools
            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            var drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polyline: { shapeOptions: { color: '#1976d2', weight: 3 } },
                    polygon: { allowIntersection: false, shapeOptions: { color: '#1976d2', weight: 3 } },
                    rectangle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                    circle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                    marker: true
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            // Storage for toggles
            window.drawControlActive = false;
            
            // Handle draw button
            document.getElementById('draw-tool').addEventListener('click', function() {
                console.log('Draw tool clicked');
                
                var drawButton = this;
                window.drawControlActive = !window.drawControlActive;
                
                if (!window.drawControlActive) {
                    // Remove draw control
                    try {
                        map.removeControl(drawControl);
                        drawButton.classList.remove('active');
                        console.log('Draw control removed');
                    } catch (e) {
                        console.error('Error removing draw control:', e);
                    }
                } else {
                    // Add draw control
                    try {
                        // Create a new draw control each time for reliability
                        drawControl = new L.Control.Draw({
                            position: 'topright',
                            draw: {
                                polyline: { shapeOptions: { color: '#1976d2', weight: 3 } },
                                polygon: { allowIntersection: false, shapeOptions: { color: '#1976d2', weight: 3 } },
                                rectangle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                                circle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                                marker: true
                            },
                            edit: {
                                featureGroup: drawnItems,
                                remove: true
                            }
                        });
                        
                        map.addControl(drawControl);
                        drawButton.classList.add('active');
                        
                        // Add style to ensure visibility
                        var style = document.createElement('style');
                        style.innerHTML = `
                            .leaflet-draw, 
                            .leaflet-draw.leaflet-control,
                            .leaflet-draw-toolbar, 
                            .leaflet-draw-toolbar a, 
                            .leaflet-draw-actions, 
                            .leaflet-draw-actions a,
                            [class*="leaflet-draw-"] {
                                display: block !important;
                                visibility: visible !important;
                                opacity: 1 !important;
                                z-index: 2000 !important;
                                pointer-events: auto !important;
                            }
                        `;
                        document.head.appendChild(style);
                        
                        console.log('Draw control added and visibility enforced');
                        
                        // Ask about measurement mode
                        var measurementMode = confirm('Do you want to activate measurement mode?\n\nClick OK to measure distances and areas.\nClick Cancel to draw features on the map.');
                        console.log('Measurement mode:', measurementMode);
                        
                        // Measurement mode is just for reference - the full implementation
                        // would be handled by the original JS
                    } catch (e) {
                        console.error('Error adding draw control:', e);
                        alert('Error setting up drawing tools. Please refresh the page and try again.');
                    }
                }
            });
            
            // Create draw objects to handle created shapes
            map.on(L.Draw.Event.CREATED, function(event) {
                var layer = event.layer;
                drawnItems.addLayer(layer);
                console.log('Shape created:', event.layerType);
            });
            
            console.log('*** DIRECT INITIALIZATION COMPLETED ***');
        });
    </script>
    
    <!-- Other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <script src="{{ url_for('static', filename='fire-map-pro.js') }}"></script>
</body>
</html>