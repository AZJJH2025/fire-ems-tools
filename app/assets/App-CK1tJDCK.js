var Mr=Object.defineProperty;var Or=(t,n,s)=>n in t?Mr(t,n,{enumerable:!0,configurable:!0,writable:!0,value:s}):t[n]=s;var dt=(t,n,s)=>Or(t,typeof n!="symbol"?n+"":n,s);import{r as O,g as cr,a as dr,u as pr,j as e,s as rt,c as At,b as ur,m as mr,d as De,e as Pr,f as kr,_ as hr,h as ct,i as Be,B as j,t as Ht,k as Nr,C as ze,l as Re,n as Lr,o as zr,p as gr,q as Ne,v as me,R as Xe,w as Me,x as Vr,G as Ur,y as Br,z as Hr,A as Wr}from"./index-CVOEKFPS.js";import{U as Wt,T as Le,A as Yr,E as Gr}from"./Edit-CWiwEOo4.js";import{T as y,c as ce,P as ge,u as zt}from"./Typography-jgWsjJfv.js";import{u as Yt,G as ue,F as Ve,I as He,S as We,A as de,D as xe,a as Ze,b as Qe,c as et,d as qe,C as le,e as tt,f as Ce,T as be,g as qr,L as Ue,h as Se,i as Pe,j as Ee,M as Jr,k as Rt,E as Kr}from"./jspdf.es.min-Bffi0I4P.js";import{M as oe,I as Ae}from"./MenuItem-xiGNFSOm.js";import{B as re}from"./Button-BNqV5esh.js";import{S as Xr,a as fr}from"./Save-ChwblpaP.js";import{C as Zr,S as at}from"./Search-D4RFIelE.js";import{F as Qr}from"./FormGroup-Bx4gFzAm.js";import{T as mt,a as ht,b as ke,c as Fe,d as gt,C as Ke,e as Mt,f as es}from"./CheckCircle-SB6pSv2h.js";import{S as nt,L as ts,C as Ot,T as rs,R as ft,P as xr,B as ss}from"./PictureAsPdf-CxmnTGuV.js";import{D as it}from"./Delete-BaZmojEN.js";import{A as yr,a as br,E as bt,b as jr,G as vr,C as Tr}from"./Warning-DmCqD2CP.js";import{S as Sr}from"./Settings-De2WOY75.js";import{E as Er}from"./Error-DNLncO6s.js";import{T as Gt,E as Fr,D as Et}from"./dataTransformer-CsuqaoFC.js";import{T as jt,a as Ie,S as Cr}from"./Tabs-Bce01sK9.js";import{C as ns}from"./Close-C8nt5GOq.js";import{I as Ft}from"./Business-_Wp1Lsx0.js";import{C as vt,a as Tt}from"./CardContent-hvQ61Msa.js";import{D as os,S as as,a as is,b as ls}from"./Download-X3LLIaq6.js";import{T as cs}from"./TableChart-hcF1bHVD.js";import{R as ds,a as pt}from"./RadioGroup-CUU25n-V.js";import{M as qt}from"./Map-CUwpXrMv.js";import{T as ps}from"./Timeline-CLx7MqRt.js";import{C as us}from"./CardActions-BylJjUZ8.js";import"./Popper-C-Cta3qt.js";const Dr=t=>{const n=O.useRef({});return O.useEffect(()=>{n.current=t}),n.current};function ms(t){return cr("MuiAlertTitle",t)}dr("MuiAlertTitle",["root"]);const hs=t=>{const{classes:n}=t;return ur({root:["root"]},ms,n)},gs=rt(y,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(t,n)=>n.root})(mr(({theme:t})=>({fontWeight:t.typography.fontWeightMedium,marginTop:-2}))),fs=O.forwardRef(function(n,s){const r=pr({props:n,name:"MuiAlertTitle"}),{className:o,...a}=r,l=r,u=hs(l);return e.jsx(gs,{gutterBottom:!0,component:"div",ownerState:l,ref:s,className:At(u.root,o),...a})});function xs(t){const{badgeContent:n,invisible:s=!1,max:r=99,showZero:o=!1}=t,a=Dr({badgeContent:n,max:r});let l=s;s===!1&&n===0&&!o&&(l=!0);const{badgeContent:u,max:p=r}=l?a:t,d=u&&Number(u)>p?`${p}+`:u;return{badgeContent:u,invisible:l,max:p,displayValue:d}}function ys(t){return cr("MuiBadge",t)}const Oe=dr("MuiBadge",["root","badge","dot","standard","anchorOriginTopRight","anchorOriginBottomRight","anchorOriginTopLeft","anchorOriginBottomLeft","invisible","colorError","colorInfo","colorPrimary","colorSecondary","colorSuccess","colorWarning","overlapRectangular","overlapCircular","anchorOriginTopLeftCircular","anchorOriginTopLeftRectangular","anchorOriginTopRightCircular","anchorOriginTopRightRectangular","anchorOriginBottomLeftCircular","anchorOriginBottomLeftRectangular","anchorOriginBottomRightCircular","anchorOriginBottomRightRectangular"]),Ct=10,Dt=4,bs=t=>{const{color:n,anchorOrigin:s,invisible:r,overlap:o,variant:a,classes:l={}}=t,u={root:["root"],badge:["badge",a,r&&"invisible",`anchorOrigin${De(s.vertical)}${De(s.horizontal)}`,`anchorOrigin${De(s.vertical)}${De(s.horizontal)}${De(o)}`,`overlap${De(o)}`,n!=="default"&&`color${De(n)}`]};return ur(u,ys,l)},js=rt("span",{name:"MuiBadge",slot:"Root",overridesResolver:(t,n)=>n.root})({position:"relative",display:"inline-flex",verticalAlign:"middle",flexShrink:0}),vs=rt("span",{name:"MuiBadge",slot:"Badge",overridesResolver:(t,n)=>{const{ownerState:s}=t;return[n.badge,n[s.variant],n[`anchorOrigin${De(s.anchorOrigin.vertical)}${De(s.anchorOrigin.horizontal)}${De(s.overlap)}`],s.color!=="default"&&n[`color${De(s.color)}`],s.invisible&&n.invisible]}})(mr(({theme:t})=>({display:"flex",flexDirection:"row",flexWrap:"wrap",justifyContent:"center",alignContent:"center",alignItems:"center",position:"absolute",boxSizing:"border-box",fontFamily:t.typography.fontFamily,fontWeight:t.typography.fontWeightMedium,fontSize:t.typography.pxToRem(12),minWidth:Ct*2,lineHeight:1,padding:"0 6px",height:Ct*2,borderRadius:Ct,zIndex:1,transition:t.transitions.create("transform",{easing:t.transitions.easing.easeInOut,duration:t.transitions.duration.enteringScreen}),variants:[...Object.entries(t.palette).filter(Pr(["contrastText"])).map(([n])=>({props:{color:n},style:{backgroundColor:(t.vars||t).palette[n].main,color:(t.vars||t).palette[n].contrastText}})),{props:{variant:"dot"},style:{borderRadius:Dt,height:Dt*2,minWidth:Dt*2,padding:0}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="top"&&n.anchorOrigin.horizontal==="right"&&n.overlap==="rectangular",style:{top:0,right:0,transform:"scale(1) translate(50%, -50%)",transformOrigin:"100% 0%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(50%, -50%)"}}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="bottom"&&n.anchorOrigin.horizontal==="right"&&n.overlap==="rectangular",style:{bottom:0,right:0,transform:"scale(1) translate(50%, 50%)",transformOrigin:"100% 100%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(50%, 50%)"}}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="top"&&n.anchorOrigin.horizontal==="left"&&n.overlap==="rectangular",style:{top:0,left:0,transform:"scale(1) translate(-50%, -50%)",transformOrigin:"0% 0%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(-50%, -50%)"}}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="bottom"&&n.anchorOrigin.horizontal==="left"&&n.overlap==="rectangular",style:{bottom:0,left:0,transform:"scale(1) translate(-50%, 50%)",transformOrigin:"0% 100%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(-50%, 50%)"}}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="top"&&n.anchorOrigin.horizontal==="right"&&n.overlap==="circular",style:{top:"14%",right:"14%",transform:"scale(1) translate(50%, -50%)",transformOrigin:"100% 0%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(50%, -50%)"}}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="bottom"&&n.anchorOrigin.horizontal==="right"&&n.overlap==="circular",style:{bottom:"14%",right:"14%",transform:"scale(1) translate(50%, 50%)",transformOrigin:"100% 100%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(50%, 50%)"}}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="top"&&n.anchorOrigin.horizontal==="left"&&n.overlap==="circular",style:{top:"14%",left:"14%",transform:"scale(1) translate(-50%, -50%)",transformOrigin:"0% 0%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(-50%, -50%)"}}},{props:({ownerState:n})=>n.anchorOrigin.vertical==="bottom"&&n.anchorOrigin.horizontal==="left"&&n.overlap==="circular",style:{bottom:"14%",left:"14%",transform:"scale(1) translate(-50%, 50%)",transformOrigin:"0% 100%",[`&.${Oe.invisible}`]:{transform:"scale(0) translate(-50%, 50%)"}}},{props:{invisible:!0},style:{transition:t.transitions.create("transform",{easing:t.transitions.easing.easeInOut,duration:t.transitions.duration.leavingScreen})}}]})));function Jt(t){return{vertical:(t==null?void 0:t.vertical)??"top",horizontal:(t==null?void 0:t.horizontal)??"right"}}const Ts=O.forwardRef(function(n,s){const r=pr({props:n,name:"MuiBadge"}),{anchorOrigin:o,className:a,classes:l,component:u,components:p={},componentsProps:d={},children:m,overlap:x="rectangular",color:T="default",invisible:E=!1,max:$=99,badgeContent:_,slots:U,slotProps:w,showZero:W=!1,variant:k="standard",...S}=r,{badgeContent:B,invisible:q,max:G,displayValue:i}=xs({max:$,invisible:E,badgeContent:_,showZero:W}),c=Dr({anchorOrigin:Jt(o),color:T,overlap:x,variant:k,badgeContent:_}),h=q||B==null&&k!=="dot",{color:D=T,overlap:P=x,anchorOrigin:Y,variant:Z=k}=h?c:r,ie=Jt(Y),M=Z!=="dot"?i:void 0,N={...r,badgeContent:B,invisible:h,max:G,displayValue:M,showZero:W,anchorOrigin:ie,color:D,overlap:P,variant:Z},ee=bs(N),f=(U==null?void 0:U.root)??p.Root??js,L=(U==null?void 0:U.badge)??p.Badge??vs,A=(w==null?void 0:w.root)??d.root,V=(w==null?void 0:w.badge)??d.badge,F=Yt({elementType:f,externalSlotProps:A,externalForwardedProps:S,additionalProps:{ref:s,as:u},ownerState:N,className:At(A==null?void 0:A.className,ee.root,a)}),v=Yt({elementType:L,externalSlotProps:V,ownerState:N,className:At(ee.badge,V==null?void 0:V.className)});return e.jsxs(f,{...F,children:[m,e.jsx(L,{...v,children:M})]})}),Vt=ce(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}));var ut={exports:{}};/* @license
Papa Parse
v5.5.2
https://github.com/mholt/PapaParse
License: MIT
*/var Ss=ut.exports,Kt;function Es(){return Kt||(Kt=1,function(t,n){((s,r)=>{t.exports=r()})(Ss,function s(){var r=typeof self<"u"?self:typeof window<"u"?window:r!==void 0?r:{},o,a=!r.document&&!!r.postMessage,l=r.IS_PAPA_WORKER||!1,u={},p=0,d={};function m(i){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(c){var h=B(c);h.chunkSize=parseInt(h.chunkSize),c.step||c.chunk||(h.chunkSize=null),this._handle=new _(h),(this._handle.streamer=this)._config=h}).call(this,i),this.parseChunk=function(c,h){var D=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<D){let Y=this._config.newline;Y||(P=this._config.quoteChar||'"',Y=this._handle.guessLineEndings(c,P)),c=[...c.split(Y).slice(D)].join(Y)}this.isFirstChunk&&G(this._config.beforeFirstChunk)&&(P=this._config.beforeFirstChunk(c))!==void 0&&(c=P),this.isFirstChunk=!1,this._halted=!1;var D=this._partialLine+c,P=(this._partialLine="",this._handle.parse(D,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(c=P.meta.cursor,D=(this._finished||(this._partialLine=D.substring(c-this._baseIndex),this._baseIndex=c),P&&P.data&&(this._rowCount+=P.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),l)r.postMessage({results:P,workerId:d.WORKER_ID,finished:D});else if(G(this._config.chunk)&&!h){if(this._config.chunk(P,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=P=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(P.data),this._completeResults.errors=this._completeResults.errors.concat(P.errors),this._completeResults.meta=P.meta),this._completed||!D||!G(this._config.complete)||P&&P.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),D||P&&P.meta.paused||this._nextChunk(),P}this._halted=!0},this._sendError=function(c){G(this._config.error)?this._config.error(c):l&&this._config.error&&r.postMessage({workerId:d.WORKER_ID,error:c,finished:!1})}}function x(i){var c;(i=i||{}).chunkSize||(i.chunkSize=d.RemoteChunkSize),m.call(this,i),this._nextChunk=a?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(h){this._input=h,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(c=new XMLHttpRequest,this._config.withCredentials&&(c.withCredentials=this._config.withCredentials),a||(c.onload=q(this._chunkLoaded,this),c.onerror=q(this._chunkError,this)),c.open(this._config.downloadRequestBody?"POST":"GET",this._input,!a),this._config.downloadRequestHeaders){var h,D=this._config.downloadRequestHeaders;for(h in D)c.setRequestHeader(h,D[h])}var P;this._config.chunkSize&&(P=this._start+this._config.chunkSize-1,c.setRequestHeader("Range","bytes="+this._start+"-"+P));try{c.send(this._config.downloadRequestBody)}catch(Y){this._chunkError(Y.message)}a&&c.status===0&&this._chunkError()}},this._chunkLoaded=function(){c.readyState===4&&(c.status<200||400<=c.status?this._chunkError():(this._start+=this._config.chunkSize||c.responseText.length,this._finished=!this._config.chunkSize||this._start>=(h=>(h=h.getResponseHeader("Content-Range"))!==null?parseInt(h.substring(h.lastIndexOf("/")+1)):-1)(c),this.parseChunk(c.responseText)))},this._chunkError=function(h){h=c.statusText||h,this._sendError(new Error(h))}}function T(i){(i=i||{}).chunkSize||(i.chunkSize=d.LocalChunkSize),m.call(this,i);var c,h,D=typeof FileReader<"u";this.stream=function(P){this._input=P,h=P.slice||P.webkitSlice||P.mozSlice,D?((c=new FileReader).onload=q(this._chunkLoaded,this),c.onerror=q(this._chunkError,this)):c=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var P=this._input,Y=(this._config.chunkSize&&(Y=Math.min(this._start+this._config.chunkSize,this._input.size),P=h.call(P,this._start,Y)),c.readAsText(P,this._config.encoding));D||this._chunkLoaded({target:{result:Y}})},this._chunkLoaded=function(P){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(P.target.result)},this._chunkError=function(){this._sendError(c.error)}}function E(i){var c;m.call(this,i=i||{}),this.stream=function(h){return c=h,this._nextChunk()},this._nextChunk=function(){var h,D;if(!this._finished)return h=this._config.chunkSize,c=h?(D=c.substring(0,h),c.substring(h)):(D=c,""),this._finished=!c,this.parseChunk(D)}}function $(i){m.call(this,i=i||{});var c=[],h=!0,D=!1;this.pause=function(){m.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){m.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(P){this._input=P,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){D&&c.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),c.length?this.parseChunk(c.shift()):h=!0},this._streamData=q(function(P){try{c.push(typeof P=="string"?P:P.toString(this._config.encoding)),h&&(h=!1,this._checkIsFinished(),this.parseChunk(c.shift()))}catch(Y){this._streamError(Y)}},this),this._streamError=q(function(P){this._streamCleanUp(),this._sendError(P)},this),this._streamEnd=q(function(){this._streamCleanUp(),D=!0,this._streamData("")},this),this._streamCleanUp=q(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function _(i){var c,h,D,P,Y=Math.pow(2,53),Z=-Y,ie=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,M=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,N=this,ee=0,f=0,L=!1,A=!1,V=[],F={data:[],errors:[],meta:{}};function v(I){return i.skipEmptyLines==="greedy"?I.join("").trim()==="":I.length===1&&I[0].length===0}function C(){if(F&&D&&(K("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),D=!1),i.skipEmptyLines&&(F.data=F.data.filter(function(g){return!v(g)})),J()){let g=function(z,H){G(i.transformHeader)&&(z=i.transformHeader(z,H)),V.push(z)};if(F)if(Array.isArray(F.data[0])){for(var I=0;J()&&I<F.data.length;I++)F.data[I].forEach(g);F.data.splice(0,1)}else F.data.forEach(g)}function R(g,z){for(var H=i.header?{}:[],X=0;X<g.length;X++){var ne=X,te=g[X],te=((je,Q)=>(pe=>(i.dynamicTypingFunction&&i.dynamicTyping[pe]===void 0&&(i.dynamicTyping[pe]=i.dynamicTypingFunction(pe)),(i.dynamicTyping[pe]||i.dynamicTyping)===!0))(je)?Q==="true"||Q==="TRUE"||Q!=="false"&&Q!=="FALSE"&&((pe=>{if(ie.test(pe)&&(pe=parseFloat(pe),Z<pe&&pe<Y))return 1})(Q)?parseFloat(Q):M.test(Q)?new Date(Q):Q===""?null:Q):Q)(ne=i.header?X>=V.length?"__parsed_extra":V[X]:ne,te=i.transform?i.transform(te,ne):te);ne==="__parsed_extra"?(H[ne]=H[ne]||[],H[ne].push(te)):H[ne]=te}return i.header&&(X>V.length?K("FieldMismatch","TooManyFields","Too many fields: expected "+V.length+" fields but parsed "+X,f+z):X<V.length&&K("FieldMismatch","TooFewFields","Too few fields: expected "+V.length+" fields but parsed "+X,f+z)),H}var b;F&&(i.header||i.dynamicTyping||i.transform)&&(b=1,!F.data.length||Array.isArray(F.data[0])?(F.data=F.data.map(R),b=F.data.length):F.data=R(F.data,0),i.header&&F.meta&&(F.meta.fields=V),f+=b)}function J(){return i.header&&V.length===0}function K(I,R,b,g){I={type:I,code:R,message:b},g!==void 0&&(I.row=g),F.errors.push(I)}G(i.step)&&(P=i.step,i.step=function(I){F=I,J()?C():(C(),F.data.length!==0&&(ee+=I.data.length,i.preview&&ee>i.preview?h.abort():(F.data=F.data[0],P(F,N))))}),this.parse=function(I,R,b){var g=i.quoteChar||'"',g=(i.newline||(i.newline=this.guessLineEndings(I,g)),D=!1,i.delimiter?G(i.delimiter)&&(i.delimiter=i.delimiter(I),F.meta.delimiter=i.delimiter):((g=((z,H,X,ne,te)=>{var je,Q,pe,Te;te=te||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var ae=0;ae<te.length;ae++){for(var se,ye=te[ae],he=0,we=0,fe=0,ve=(pe=void 0,new w({comments:ne,delimiter:ye,newline:H,preview:10}).parse(z)),$e=0;$e<ve.data.length;$e++)X&&v(ve.data[$e])?fe++:(se=ve.data[$e].length,we+=se,pe===void 0?pe=se:0<se&&(he+=Math.abs(se-pe),pe=se));0<ve.data.length&&(we/=ve.data.length-fe),(Q===void 0||he<=Q)&&(Te===void 0||Te<we)&&1.99<we&&(Q=he,je=ye,Te=we)}return{successful:!!(i.delimiter=je),bestDelimiter:je}})(I,i.newline,i.skipEmptyLines,i.comments,i.delimitersToGuess)).successful?i.delimiter=g.bestDelimiter:(D=!0,i.delimiter=d.DefaultDelimiter),F.meta.delimiter=i.delimiter),B(i));return i.preview&&i.header&&g.preview++,c=I,h=new w(g),F=h.parse(c,R,b),C(),L?{meta:{paused:!0}}:F||{meta:{paused:!1}}},this.paused=function(){return L},this.pause=function(){L=!0,h.abort(),c=G(i.chunk)?"":c.substring(h.getCharIndex())},this.resume=function(){N.streamer._halted?(L=!1,N.streamer.parseChunk(c,!0)):setTimeout(N.resume,3)},this.aborted=function(){return A},this.abort=function(){A=!0,h.abort(),F.meta.aborted=!0,G(i.complete)&&i.complete(F),c=""},this.guessLineEndings=function(z,g){z=z.substring(0,1048576);var g=new RegExp(U(g)+"([^]*?)"+U(g),"gm"),b=(z=z.replace(g,"")).split("\r"),g=z.split(`
`),z=1<g.length&&g[0].length<b[0].length;if(b.length===1||z)return`
`;for(var H=0,X=0;X<b.length;X++)b[X][0]===`
`&&H++;return H>=b.length/2?`\r
`:"\r"}}function U(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function w(i){var c=(i=i||{}).delimiter,h=i.newline,D=i.comments,P=i.step,Y=i.preview,Z=i.fastMode,ie=null,M=!1,N=i.quoteChar==null?'"':i.quoteChar,ee=N;if(i.escapeChar!==void 0&&(ee=i.escapeChar),(typeof c!="string"||-1<d.BAD_DELIMITERS.indexOf(c))&&(c=","),D===c)throw new Error("Comment character same as delimiter");D===!0?D="#":(typeof D!="string"||-1<d.BAD_DELIMITERS.indexOf(D))&&(D=!1),h!==`
`&&h!=="\r"&&h!==`\r
`&&(h=`
`);var f=0,L=!1;this.parse=function(A,V,F){if(typeof A!="string")throw new Error("Input must be a string");var v=A.length,C=c.length,J=h.length,K=D.length,I=G(P),R=[],b=[],g=[],z=f=0;if(!A)return he();if(Z||Z!==!1&&A.indexOf(N)===-1){for(var H=A.split(h),X=0;X<H.length;X++){if(g=H[X],f+=g.length,X!==H.length-1)f+=h.length;else if(F)return he();if(!D||g.substring(0,K)!==D){if(I){if(R=[],Te(g.split(c)),we(),L)return he()}else Te(g.split(c));if(Y&&Y<=X)return R=R.slice(0,Y),he(!0)}}return he()}for(var ne=A.indexOf(c,f),te=A.indexOf(h,f),je=new RegExp(U(ee)+U(N),"g"),Q=A.indexOf(N,f);;)if(A[f]===N)for(Q=f,f++;;){if((Q=A.indexOf(N,Q+1))===-1)return F||b.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:R.length,index:f}),se();if(Q===v-1)return se(A.substring(f,Q).replace(je,N));if(N===ee&&A[Q+1]===ee)Q++;else if(N===ee||Q===0||A[Q-1]!==ee){ne!==-1&&ne<Q+1&&(ne=A.indexOf(c,Q+1));var pe=ae((te=te!==-1&&te<Q+1?A.indexOf(h,Q+1):te)===-1?ne:Math.min(ne,te));if(A.substr(Q+1+pe,C)===c){g.push(A.substring(f,Q).replace(je,N)),A[f=Q+1+pe+C]!==N&&(Q=A.indexOf(N,f)),ne=A.indexOf(c,f),te=A.indexOf(h,f);break}if(pe=ae(te),A.substring(Q+1+pe,Q+1+pe+J)===h){if(g.push(A.substring(f,Q).replace(je,N)),ye(Q+1+pe+J),ne=A.indexOf(c,f),Q=A.indexOf(N,f),I&&(we(),L))return he();if(Y&&R.length>=Y)return he(!0);break}b.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:R.length,index:f}),Q++}}else if(D&&g.length===0&&A.substring(f,f+K)===D){if(te===-1)return he();f=te+J,te=A.indexOf(h,f),ne=A.indexOf(c,f)}else if(ne!==-1&&(ne<te||te===-1))g.push(A.substring(f,ne)),f=ne+C,ne=A.indexOf(c,f);else{if(te===-1)break;if(g.push(A.substring(f,te)),ye(te+J),I&&(we(),L))return he();if(Y&&R.length>=Y)return he(!0)}return se();function Te(fe){R.push(fe),z=f}function ae(fe){var ve=0;return ve=fe!==-1&&(fe=A.substring(Q+1,fe))&&fe.trim()===""?fe.length:ve}function se(fe){return F||(fe===void 0&&(fe=A.substring(f)),g.push(fe),f=v,Te(g),I&&we()),he()}function ye(fe){f=fe,Te(g),g=[],te=A.indexOf(h,f)}function he(fe){if(i.header&&!V&&R.length&&!M){var ve=R[0],$e={},St=new Set(ve);let Ut=!1;for(let Ye=0;Ye<ve.length;Ye++){let _e=ve[Ye];if($e[_e=G(i.transformHeader)?i.transformHeader(_e,Ye):_e]){let st,Bt=$e[_e];for(;st=_e+"_"+Bt,Bt++,St.has(st););St.add(st),ve[Ye]=st,$e[_e]++,Ut=!0,(ie=ie===null?{}:ie)[st]=_e}else $e[_e]=1,ve[Ye]=_e;St.add(_e)}Ut&&console.warn("Duplicate headers found and renamed."),M=!0}return{data:R,errors:b,meta:{delimiter:c,linebreak:h,aborted:L,truncated:!!fe,cursor:z+(V||0),renamedHeaders:ie}}}function we(){P(he()),R=[],b=[]}},this.abort=function(){L=!0},this.getCharIndex=function(){return f}}function W(i){var c=i.data,h=u[c.workerId],D=!1;if(c.error)h.userError(c.error,c.file);else if(c.results&&c.results.data){var P={abort:function(){D=!0,k(c.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:S,resume:S};if(G(h.userStep)){for(var Y=0;Y<c.results.data.length&&(h.userStep({data:c.results.data[Y],errors:c.results.errors,meta:c.results.meta},P),!D);Y++);delete c.results}else G(h.userChunk)&&(h.userChunk(c.results,P,c.file),delete c.results)}c.finished&&!D&&k(c.workerId,c.results)}function k(i,c){var h=u[i];G(h.userComplete)&&h.userComplete(c),h.terminate(),delete u[i]}function S(){throw new Error("Not implemented.")}function B(i){if(typeof i!="object"||i===null)return i;var c,h=Array.isArray(i)?[]:{};for(c in i)h[c]=B(i[c]);return h}function q(i,c){return function(){i.apply(c,arguments)}}function G(i){return typeof i=="function"}return d.parse=function(i,c){var h=(c=c||{}).dynamicTyping||!1;if(G(h)&&(c.dynamicTypingFunction=h,h={}),c.dynamicTyping=h,c.transform=!!G(c.transform)&&c.transform,!c.worker||!d.WORKERS_SUPPORTED)return h=null,d.NODE_STREAM_INPUT,typeof i=="string"?(i=(D=>D.charCodeAt(0)!==65279?D:D.slice(1))(i),h=new(c.download?x:E)(c)):i.readable===!0&&G(i.read)&&G(i.on)?h=new $(c):(r.File&&i instanceof File||i instanceof Object)&&(h=new T(c)),h.stream(i);(h=(()=>{var D;return!!d.WORKERS_SUPPORTED&&(D=(()=>{var P=r.URL||r.webkitURL||null,Y=s.toString();return d.BLOB_URL||(d.BLOB_URL=P.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",Y,")();"],{type:"text/javascript"})))})(),(D=new r.Worker(D)).onmessage=W,D.id=p++,u[D.id]=D)})()).userStep=c.step,h.userChunk=c.chunk,h.userComplete=c.complete,h.userError=c.error,c.step=G(c.step),c.chunk=G(c.chunk),c.complete=G(c.complete),c.error=G(c.error),delete c.worker,h.postMessage({input:i,config:c,workerId:h.id})},d.unparse=function(i,c){var h=!1,D=!0,P=",",Y=`\r
`,Z='"',ie=Z+Z,M=!1,N=null,ee=!1,f=((()=>{if(typeof c=="object"){if(typeof c.delimiter!="string"||d.BAD_DELIMITERS.filter(function(V){return c.delimiter.indexOf(V)!==-1}).length||(P=c.delimiter),typeof c.quotes!="boolean"&&typeof c.quotes!="function"&&!Array.isArray(c.quotes)||(h=c.quotes),typeof c.skipEmptyLines!="boolean"&&typeof c.skipEmptyLines!="string"||(M=c.skipEmptyLines),typeof c.newline=="string"&&(Y=c.newline),typeof c.quoteChar=="string"&&(Z=c.quoteChar),typeof c.header=="boolean"&&(D=c.header),Array.isArray(c.columns)){if(c.columns.length===0)throw new Error("Option columns is empty");N=c.columns}c.escapeChar!==void 0&&(ie=c.escapeChar+Z),c.escapeFormulae instanceof RegExp?ee=c.escapeFormulae:typeof c.escapeFormulae=="boolean"&&c.escapeFormulae&&(ee=/^[=+\-@\t\r].*$/)}})(),new RegExp(U(Z),"g"));if(typeof i=="string"&&(i=JSON.parse(i)),Array.isArray(i)){if(!i.length||Array.isArray(i[0]))return L(null,i,M);if(typeof i[0]=="object")return L(N||Object.keys(i[0]),i,M)}else if(typeof i=="object")return typeof i.data=="string"&&(i.data=JSON.parse(i.data)),Array.isArray(i.data)&&(i.fields||(i.fields=i.meta&&i.meta.fields||N),i.fields||(i.fields=Array.isArray(i.data[0])?i.fields:typeof i.data[0]=="object"?Object.keys(i.data[0]):[]),Array.isArray(i.data[0])||typeof i.data[0]=="object"||(i.data=[i.data])),L(i.fields||[],i.data||[],M);throw new Error("Unable to serialize unrecognized input");function L(V,F,v){var C="",J=(typeof V=="string"&&(V=JSON.parse(V)),typeof F=="string"&&(F=JSON.parse(F)),Array.isArray(V)&&0<V.length),K=!Array.isArray(F[0]);if(J&&D){for(var I=0;I<V.length;I++)0<I&&(C+=P),C+=A(V[I],I);0<F.length&&(C+=Y)}for(var R=0;R<F.length;R++){var b=(J?V:F[R]).length,g=!1,z=J?Object.keys(F[R]).length===0:F[R].length===0;if(v&&!J&&(g=v==="greedy"?F[R].join("").trim()==="":F[R].length===1&&F[R][0].length===0),v==="greedy"&&J){for(var H=[],X=0;X<b;X++){var ne=K?V[X]:X;H.push(F[R][ne])}g=H.join("").trim()===""}if(!g){for(var te=0;te<b;te++){0<te&&!z&&(C+=P);var je=J&&K?V[te]:te;C+=A(F[R][je],te)}R<F.length-1&&(!v||0<b&&!z)&&(C+=Y)}}return C}function A(V,F){var v,C;return V==null?"":V.constructor===Date?JSON.stringify(V).slice(1,25):(C=!1,ee&&typeof V=="string"&&ee.test(V)&&(V="'"+V,C=!0),v=V.toString().replace(f,ie),(C=C||h===!0||typeof h=="function"&&h(V,F)||Array.isArray(h)&&h[F]||((J,K)=>{for(var I=0;I<K.length;I++)if(-1<J.indexOf(K[I]))return!0;return!1})(v,d.BAD_DELIMITERS)||-1<v.indexOf(P)||v.charAt(0)===" "||v.charAt(v.length-1)===" ")?Z+v+Z:v)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!a&&!!r.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=w,d.ParserHandle=_,d.NetworkStreamer=x,d.FileStreamer=T,d.StringStreamer=E,d.ReadableStreamStreamer=$,r.jQuery&&((o=r.jQuery).fn.parse=function(i){var c=i.config||{},h=[];return this.each(function(Y){if(!(o(this).prop("tagName").toUpperCase()==="INPUT"&&o(this).attr("type").toLowerCase()==="file"&&r.FileReader)||!this.files||this.files.length===0)return!0;for(var Z=0;Z<this.files.length;Z++)h.push({file:this.files[Z],inputElem:this,instanceConfig:o.extend({},c)})}),D(),this;function D(){if(h.length===0)G(i.complete)&&i.complete();else{var Y,Z,ie,M,N=h[0];if(G(i.before)){var ee=i.before(N.file,N.inputElem);if(typeof ee=="object"){if(ee.action==="abort")return Y="AbortError",Z=N.file,ie=N.inputElem,M=ee.reason,void(G(i.error)&&i.error({name:Y},Z,ie,M));if(ee.action==="skip")return void P();typeof ee.config=="object"&&(N.instanceConfig=o.extend(N.instanceConfig,ee.config))}else if(ee==="skip")return void P()}var f=N.instanceConfig.complete;N.instanceConfig.complete=function(L){G(f)&&f(L,N.file,N.inputElem),P()},d.parse(N.file,N.instanceConfig)}}function P(){h.splice(0,1),D()}}),l&&(r.onmessage=function(i){i=i.data,d.WORKER_ID===void 0&&i&&(d.WORKER_ID=i.workerId),typeof i.input=="string"?r.postMessage({workerId:d.WORKER_ID,results:d.parse(i.input,i.config),finished:!0}):(r.File&&i.input instanceof File||i.input instanceof Object)&&(i=d.parse(i.input,i.config))&&r.postMessage({workerId:d.WORKER_ID,results:i,finished:!0})}),(x.prototype=Object.create(m.prototype)).constructor=x,(T.prototype=Object.create(m.prototype)).constructor=T,(E.prototype=Object.create(E.prototype)).constructor=E,($.prototype=Object.create(m.prototype)).constructor=$,d})}(ut)),ut.exports}var Fs=Es();const Cs=kr(Fs),Ds=async(t,n)=>{switch(n){case"csv":return ws(t);case"excel":return _s(t);case"json":return Is(t);case"xml":return $s(t);case"pdf":return As(t);case"txt":return Rs(t);default:throw new Error(`Unsupported file type: ${n}`)}},ws=t=>new Promise((n,s)=>{Cs.parse(t,{header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:r=>{const o=r.meta.fields||[],a=r.data;n({columns:o,data:a.slice(0,100)})},error:r=>{s(new Error(`Error parsing CSV: ${r.message}`))}})}),_s=t=>new Promise((n,s)=>{const r=new FileReader;r.onload=async o=>{var a;try{const l=(a=o.target)==null?void 0:a.result;if(!l){s(new Error("Failed to read Excel file"));return}const u=await hr(()=>import("./xlsx-DkH2s96g.js"),[]),p=u.read(l,{type:"array"}),d=p.SheetNames[0],m=p.Sheets[d],x=u.utils.sheet_to_json(m,{header:1});if(x.length===0){s(new Error("Excel file is empty"));return}const T=x[0].map(String),E=x.slice(1).map($=>{const _={};return $.forEach((U,w)=>{w<T.length&&(_[T[w]]=U)}),_});n({columns:T,data:E.slice(0,100)})}catch(l){s(new Error(`Error parsing Excel file: ${l instanceof Error?l.message:"Unknown error"}`))}},r.onerror=()=>{s(new Error("Error reading Excel file"))},r.readAsArrayBuffer(t)}),Is=t=>new Promise((n,s)=>{const r=new FileReader;r.onload=o=>{var a;try{const l=(a=o.target)==null?void 0:a.result,u=JSON.parse(l);if(Array.isArray(u)){if(u.length===0){s(new Error("JSON file contains an empty array"));return}const p=Array.from(new Set(u.flatMap(d=>Object.keys(d))));n({columns:p,data:u.slice(0,100)})}else if(u&&typeof u=="object"){const p=Object.keys(u).find(d=>Array.isArray(u[d]));if(p&&u[p].length>0){const d=u[p],m=Array.from(new Set(d.flatMap(x=>Object.keys(x))));n({columns:m,data:d.slice(0,100)})}else{const d=Object.keys(u);n({columns:d,data:[u]})}}else s(new Error("JSON file format not recognized"))}catch(l){s(new Error(`Error parsing JSON file: ${l instanceof Error?l.message:"Invalid JSON"}`))}},r.onerror=()=>{s(new Error("Error reading JSON file"))},r.readAsText(t)}),$s=t=>new Promise((n,s)=>{const r=new FileReader;r.onload=o=>{var a,l;try{const u=(a=o.target)==null?void 0:a.result,d=new DOMParser().parseFromString(u,"text/xml"),m=d.getElementsByTagName("*"),x=new Map;for(let k=0;k<m.length;k++){const S=m[k].tagName;x.set(S,(x.get(S)||0)+1)}const T=Array.from(x.entries()).filter(([k,S])=>S>1).map(([k])=>k).sort((k,S)=>(x.get(S)||0)-(x.get(k)||0));if(T.length===0){s(new Error("Could not identify repeating elements in XML"));return}const E=T[0],$=d.getElementsByTagName(E);if($.length===0){s(new Error(`No elements found with tag ${E}`));return}const _=$[0],w=Array.from(_.children).map(k=>k.tagName),W=[];for(let k=0;k<Math.min($.length,100);k++){const S=$[k],B={};for(const q of w){const G=((l=S.getElementsByTagName(q)[0])==null?void 0:l.textContent)||"";B[q]=G}W.push(B)}n({columns:w,data:W})}catch(u){s(new Error(`Error parsing XML file: ${u instanceof Error?u.message:"Invalid XML"}`))}},r.onerror=()=>{s(new Error("Error reading XML file"))},r.readAsText(t)}),As=t=>new Promise((n,s)=>{const r=new FileReader;r.onload=async o=>{var a;try{if(!((a=o.target)==null?void 0:a.result)){s(new Error("Failed to read PDF file"));return}n({columns:["Information"],data:[{Information:"PDF files are not currently supported for direct parsing in the browser."},{Information:"Please convert your PDF to CSV, Excel, or JSON format for processing."},{Information:"Alternatively, copy and paste the data from your PDF into a text file."},{Information:`File name: ${t.name}`},{Information:`File size: ${(t.size/1024).toFixed(2)} KB`},{Information:"Supported formats: CSV, Excel (.xlsx, .xls), JSON, XML, TXT"}]})}catch(l){s(new Error(`Error processing PDF: ${l instanceof Error?l.message:"Unknown error"}`))}},r.onerror=()=>{s(new Error("Error reading PDF file"))},r.readAsArrayBuffer(t)}),Rs=t=>new Promise((n,s)=>{const r=new FileReader;r.onload=o=>{var a;try{const l=(a=o.target)==null?void 0:a.result;if(!l){s(new Error("Failed to read text file"));return}const u=l.split(`
`).map(x=>x.trim()).filter(x=>x.length>0);if(u.length===0){s(new Error("Text file is empty"));return}const p=[",","	","|",";"];let d="",m=0;for(const x of p){const T=u.slice(0,10).map(_=>_.split(x).length),E=T.reduce((_,U)=>_+U,0)/T.length;T.every(_=>Math.abs(_-E)<=1&&_>1)&&E>m&&(m=E,d=x)}if(d&&m>1){const x=u[0].split(d).map(E=>E.trim()),T=[];for(let E=1;E<Math.min(u.length,100);E++){const $=u[E].split(d).map(U=>U.trim()),_={};for(let U=0;U<x.length;U++)_[x[U]]=$[U]||"";T.push(_)}n({columns:x,data:T})}else{const x=u.slice(0,100).map((T,E)=>({LineNumber:E+1,Text:T}));n({columns:["LineNumber","Text"],data:x})}}catch(l){s(new Error(`Error parsing text file: ${l instanceof Error?l.message:"Unknown error"}`))}},r.onerror=()=>{s(new Error("Error reading text file"))},r.readAsText(t)}),Ms=()=>{const t=ct(),n=Be(r=>r.formatter.selectedTool),s=r=>{const o=r.target.value,a=Ht.find(l=>l.id===o);a&&t(Nr(a))};return e.jsxs(j,{sx:{my:3},children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Select Target Tool"}),e.jsxs(ue,{container:!0,spacing:2,children:[e.jsx(ue,{size:{xs:12,md:6},children:e.jsxs(Ve,{fullWidth:!0,children:[e.jsx(He,{id:"tool-select-label",children:"Tool"}),e.jsx(We,{labelId:"tool-select-label",id:"tool-select",value:(n==null?void 0:n.id)||"",label:"Tool",onChange:s,children:Ht.map(r=>e.jsx(oe,{value:r.id,children:r.name},r.id))})]})}),e.jsx(ue,{size:12,children:n&&e.jsxs(ge,{variant:"outlined",sx:{p:2,mt:2,borderColor:"primary.light"},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:n.name}),e.jsx(y,{variant:"body2",paragraph:!0,children:n.description}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Required fields: ",n.requiredFields.map(r=>r.name).join(", ")]})]})})]})]})},Os=()=>{const t=ct(),n=O.useRef(null),{sourceColumns:s,selectedTool:r}=Be(k=>k.formatter),[o,a]=O.useState("csv"),[l,u]=O.useState(!1),[p,d]=O.useState(null),[m,x]=O.useState(null),T=k=>{a(k.target.value)},E=async k=>{var B;const S=(B=k.target.files)==null?void 0:B[0];if(S){x(S.name),u(!0),d(null);try{t(Re("uploading"));const q={id:`file-${Date.now()}`,name:S.name,type:o,size:S.size,lastModified:S.lastModified},{columns:G,data:i}=await Ds(S,o);t(Lr(q)),t(zr(G)),t(gr(i)),t(Re("idle")),setTimeout(()=>{t(Ne(1))},500)}catch(q){d(q instanceof Error?q.message:"Failed to parse file"),t(Re("error"))}finally{u(!1)}}},$=()=>{var k;(k=n.current)==null||k.click()},_=k=>{var B;k.preventDefault(),k.stopPropagation();const S=(B=k.dataTransfer.files)==null?void 0:B[0];if(S&&n.current){const q=new DataTransfer;q.items.add(S),n.current.files=q.files,E({target:{files:q.files}})}},U=k=>{k.preventDefault(),k.stopPropagation()},w=()=>{t(Ne(1))},W=s.length>0&&r!==null;return e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(y,{variant:"h5",gutterBottom:!0,children:"Upload Data File"}),e.jsx(y,{variant:"body1",paragraph:!0,children:"Select a file to upload. The formatter supports CSV, Excel (.xlsx, .xls, .xlsm), PDF, JSON, XML, and plain text files."}),e.jsxs(ue,{container:!0,spacing:3,children:[e.jsx(ue,{size:{xs:12,md:4},children:e.jsxs(Ve,{fullWidth:!0,children:[e.jsx(He,{id:"file-type-select-label",children:"File Type"}),e.jsxs(We,{labelId:"file-type-select-label",id:"file-type-select",value:o,label:"File Type",onChange:T,children:[e.jsx(oe,{value:"csv",children:"CSV"}),e.jsx(oe,{value:"excel",children:"Excel (.xlsx/.xls/.xlsm)"}),e.jsx(oe,{value:"json",children:"JSON"}),e.jsx(oe,{value:"xml",children:"XML"}),e.jsx(oe,{value:"pdf",children:"PDF"}),e.jsx(oe,{value:"txt",children:"Text File"})]})]})}),e.jsxs(ue,{size:12,children:[e.jsx("input",{type:"file",ref:n,onChange:E,style:{display:"none"},accept:o==="csv"?".csv":o==="excel"?".xlsx,.xls,.xlsm":o==="json"?".json":o==="xml"?".xml":o==="pdf"?".pdf":o==="txt"?".txt":void 0}),e.jsx(ge,{elevation:0,onDrop:_,onDragOver:U,sx:{border:"2px dashed #ccc",borderRadius:2,p:3,textAlign:"center",cursor:"pointer",bgcolor:"#f8f9fa","&:hover":{borderColor:"primary.main"}},onClick:$,children:l?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(ze,{}),e.jsx(y,{variant:"body1",sx:{mt:2},children:"Processing file..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(Wt,{fontSize:"large",color:"primary"}),e.jsx(y,{variant:"h6",sx:{mt:2},children:m?`Selected: ${m}`:"Drag & drop file here or click to browse"}),e.jsxs(y,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Supports ",o==="csv"?"CSV":o==="excel"?"Excel (.xlsx, .xls, .xlsm)":o==="json"?"JSON":o==="xml"?"XML":o==="pdf"?"PDF":"Text"," files"]})]})}),p&&e.jsx(de,{severity:"error",sx:{mt:2},children:p}),m&&!l&&!p&&e.jsxs(de,{severity:"success",sx:{mt:2},children:["File selected: ",m]})]}),e.jsx(ue,{size:12,sx:{mt:2,display:"flex",justifyContent:"center"},children:e.jsx(re,{variant:"contained",size:"large",onClick:$,startIcon:e.jsx(Wt,{}),disabled:l,children:"Browse Files"})})]}),e.jsx(xe,{sx:{my:4}}),e.jsx(Ms,{}),e.jsx(j,{sx:{display:"flex",justifyContent:"flex-end",mt:4},children:e.jsx(re,{variant:"contained",size:"large",endIcon:e.jsx(Vt,{}),onClick:w,disabled:!W,children:"Continue to Field Mapping"})}),!W&&e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mt:2,textAlign:"right"},children:s.length?"Select a target tool to continue":"Upload a file to continue"})]})},ot=ce(e.jsx("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Xt=t=>["dispatch_time","enroute_time","arrival_time","clear_time"].includes(t),wt=t=>["incident_date"].includes(t),Ps=t=>{if(!t||typeof t!="string")return t;const n=[/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2})$/,/^.+\s+(\d{1,2}:\d{2}(?::\d{2})?)$/];for(const r of n){const o=t.match(r);if(o&&o[1])return o[1]}return/^\d{1,2}:\d{2}(?::\d{2})?$/.test(t.trim())?t.trim():t},ks=t=>{if(console.log(`🔍 DATE EXTRACTION: Input "${t}" (type: ${typeof t})`),!t||typeof t!="string")return console.log("🔍 DATE EXTRACTION: Invalid input, returning original"),t;const n=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^(\d{4}-\d{2}-\d{2})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^([^\\s]+)\s+\d{1,2}:\d{2}(?::\d{2})?$/];for(let r=0;r<n.length;r++){const o=n[r],a=t.match(o);if(console.log(`🔍 Pattern ${r+1} test: "${t}" → ${a?`MATCH: "${a[1]}"`:"NO MATCH"}`),a&&a[1])return console.log(`🔍 DATE EXTRACTION SUCCESS: "${t}" → "${a[1]}"`),a[1]}const s=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const r of s)if(r.test(t.trim()))return t.trim();return t},wr=(t,n)=>!t||!t.length||!n||!n.length?[]:t.map(s=>{const r={},o=new Set;return n.forEach(a=>{const{sourceField:l,targetField:u,transformations:p}=a;let d;if(l==="__default__"&&p&&p.length>0){const m=p.find(x=>x.type==="convert"&&x.params.defaultValue);m?(console.log(`Using default value for ${u}:`,m.params.defaultValue),d=m.params.defaultValue):(console.log(`No default value found for ${u}, using null`),d=null)}else if(l.includes("_")&&l.split("_").length>=2){const[m,...x]=l.split("_"),T=x.join("_"),E=[`${m}_parsed_${T}`,`${m}_parsed_${u}`,l];console.log(`🤖 DEBUG: Looking for parsed data with sourceField: "${l}"`),console.log("🤖 DEBUG: Trying keys:",E),console.log("🤖 DEBUG: Available row keys:",Object.keys(s));let $=!1;for(const _ of E)if(s[_]!==void 0&&s[_]!==null){d=s[_],console.log(`🤖 ✅ Using PARSED value for ${u} from key "${_}": "${d}"`),$=!0;break}else console.log(`🤖 ❌ No data found at key: "${_}"`);$||(d=s[l],console.log(`🤖 ⚠️ No parsed data found, using source value for ${u} from ${l}:`,d))}else d=s[l],console.log(`Using source value for ${u} from ${l}:`,d);if(p&&p.length>0){console.log(`Applying ${p.length} transformations to ${u}:`,p);const m=d;d=Ns(d,p,u,s),console.log(`Transformation result for ${u}:`,m,"→",d)}if(u==="incident_type"&&d!==null&&d!==void 0&&(typeof d=="number"?(console.log(`🔢 Converting numeric incident_type to string: ${d} → "${String(d)}"`),d=String(d)):typeof d!="string"&&(console.log(`🔄 Converting incident_type to string: ${d} (${typeof d}) → "${String(d)}"`),d=String(d))),console.log(`🔧 CHECKING FIELD: ${u}, isTimeOnly: ${Xt(u)}, isDateOnly: ${wt(u)}, value type: ${typeof d}`),d&&typeof d=="string")if(Xt(u)){const m=Ps(d);m!==d?(console.log(`🕒 Auto-extracted time for ${u}: "${d}" → "${m}"`),d=m):console.log(`🕒 No time extraction needed for ${u}: "${d}"`)}else if(wt(u)){console.log(`📅 ATTEMPTING DATE EXTRACTION for ${u}: Input value "${d}"`);const m=ks(d);console.log(`📅 DATE EXTRACTION RESULT: "${d}" → "${m}" (changed: ${m!==d})`),m!==d?(console.log(`📅 ✅ Auto-extracted date for ${u}: "${d}" → "${m}"`),d=m):console.log(`📅 ❌ No date extraction needed for ${u}: "${d}"`)}else u==="incident_time"&&console.log(`🕒 Keeping full datetime for ${u}: "${d}"`);if(r[u]=d,l!==u&&l!=="__default__"&&!o.has(l)&&!l.includes("_parsed_")){if(n.some(x=>x.targetField===l))console.log(`🚫 SKIPPING PRESERVATION: "${l}" is also a target field - keeping transformed value`);else{let x=d;wt(u)&&s[l]&&typeof s[l]=="string"&&s[l].includes(" ")&&(x=s[l],console.log(`📅 PRESERVING FULL DATETIME for original field "${l}": "${x}" (target "${u}" gets date-only: "${d}")`)),r[l]=x,console.log(`🔄 PRESERVED ORIGINAL FIELD NAME: "${l}" → "${x}" (also mapped to ${u})`)}o.add(l)}else l.includes("_parsed_")&&console.log(`🤖 SKIPPING PARSED FIELD PRESERVATION: "${l}" (parsed field injection key)`)}),Object.keys(r).forEach(a=>{a.includes("_parsed_")&&(console.log(`🧹 CLEANUP: Removing parsed field injection key "${a}" from transformed data`),delete r[a])}),r}),Ns=(t,n,s,r)=>n.reduce((o,a)=>_r(o,a,s,r),t),_r=(t,n,s,r)=>{const{type:o,params:a}=n,l={...a,...s&&{fieldName:s},...r&&{rowData:r}};switch(o){case"split":return Vs(t,l);case"join":return Us(t,l);case"format":return Bs(t,l);case"convert":return Hs(t,l);case"extract":return Ls(t,l);case"replace":return zs(t,l);case"datetime_combine":return Ws(t,l);case"datetime_extract":return Ys(t,l);default:return t}},Ls=(t,n)=>{if(typeof t!="string")return t;const{pattern:s}=n;try{const r=new RegExp(s),o=t.match(r);if(o&&o.length>0)return o[1]||o[0]}catch{console.error("Invalid regex pattern:",s)}return t},zs=(t,n)=>{if(typeof t!="string")return t;const{from:s,to:r="",useRegex:o=!1}=n;if(!s)return t;try{if(o){const a=new RegExp(s,"g");return t.replace(a,r)}else return t.replace(new RegExp(s.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),r)}catch(a){return console.error("Error in replace transformation:",a),t}},Vs=(t,n)=>{if(typeof t!="string")return t;const{delimiter:s,index:r}=n,o=t.split(s);return r!==void 0?o[r]||"":o},Us=(t,n)=>{if(!Array.isArray(t))return t;const{delimiter:s=", "}=n;return t.join(s)},Bs=(t,n)=>{const{format:s,type:r,fieldName:o}=n;if(console.log("applyFormatTransformation called with:",{value:t,format:s,type:r,fieldName:o}),r==="date"&&t)try{const a=new Date(t);if(isNaN(a.getTime()))return t;switch(s){case"MM/DD/YYYY":return`${a.getMonth()+1}/${a.getDate()}/${a.getFullYear()}`;case"YYYY-MM-DD":return`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${a.getDate()}/${a.getMonth()+1}/${a.getFullYear()}`;case"date-only":return a.toLocaleDateString();case"custom":return(n.customFormat||"YYYY-MM-DD").replace("YYYY",a.getFullYear().toString()).replace("MM",(a.getMonth()+1).toString().padStart(2,"0")).replace("DD",a.getDate().toString().padStart(2,"0")).replace("HH",a.getHours().toString().padStart(2,"0")).replace("mm",a.getMinutes().toString().padStart(2,"0")).replace("ss",a.getSeconds().toString().padStart(2,"0"));case"ISO":return a.toISOString();default:return t}}catch{return t}if(r==="number"&&t!==void 0&&t!==null)try{const a=Number(t);if(isNaN(a))return t;switch(s){case"integer":return Math.round(a);case"fixed2":return a.toFixed(2);case"currency":return`$${a.toFixed(2)}`;case"percent":return`${(a*100).toFixed(1)}%`;default:return t}}catch{return t}return t},Hs=(t,n)=>{const{targetType:s}=n;switch(s){case"string":return t!=null?String(t):"";case"number":if(t==null||t==="")return null;const r=Number(t);return isNaN(r)?t:r;case"boolean":return typeof t=="string"?["true","yes","1","y"].includes(t.toLowerCase()):!!t;case"date":if(!t)return null;try{const o=new Date(t);return isNaN(o.getTime())?t:o}catch{return t}default:return t}},Ws=(t,n)=>{const{sourceFields:s,description:r,rowData:o}=n;if(console.log("🕐 DATETIME COMBINE: Starting transformation"),console.log("🕐 Source fields:",s),console.log("🕐 Primary value:",t),console.log("🕐 Description:",r),!s||s.length<2)return console.log("⚠️ DATETIME COMBINE: Need at least 2 source fields"),t;if(!o)return console.log("⚠️ DATETIME COMBINE: No row data provided for field combination"),t;const[a,l]=s,u=String(o[a]||"").trim(),p=String(o[l]||"").trim();if(console.log(`🕐 Date field "${a}":`,u),console.log(`🕐 Time field "${l}":`,p),!u||!p)return console.log("⚠️ DATETIME COMBINE: Missing date or time component"),t;const d=`${u} ${p}`;return console.log("✅ DATETIME COMBINE: Result:",d),d},Ys=(t,n)=>{const{extractType:s,description:r}=n;if(console.log("🕐 DATETIME EXTRACT: Starting transformation"),console.log("🕐 Extract type:",s),console.log("🕐 Input value:",t),console.log("🕐 Description:",r),!t||typeof t!="string")return console.log("⚠️ DATETIME EXTRACT: Invalid input value"),t;const o=t.trim();if(s==="date"){const a=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+/,/^(\d{4}-\d{2}-\d{2})\s+/];for(const u of a){const p=o.match(u);if(p){const d=p[1];return console.log("✅ DATETIME EXTRACT (date):",d),d}}const l=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const u of l)if(u.test(o))return console.log("✅ DATETIME EXTRACT (date): Already date-only format"),o}else if(s==="time"){const a=[/\s+(\d{1,2}:\d{2}:\d{2})$/,/\s+(\d{1,2}:\d{2})$/];for(const u of a){const p=o.match(u);if(p){const d=p[1];return console.log("✅ DATETIME EXTRACT (time):",d),d}}const l=[/^\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}:\d{2}$/];for(const u of l)if(u.test(o))return console.log("✅ DATETIME EXTRACT (time): Already time-only format"),o}return console.log("⚠️ DATETIME EXTRACT: No matching pattern found, returning original value"),t},Gs=(t,n)=>{console.log("🕐 SMART DATETIME DETECTION: Starting analysis..."),console.log("🕐 Column names:",t);const s=n.find(l=>Object.keys(l).length>0)||{};console.log("🕐 Sample data keys:",Object.keys(s));const r=qs(t,s);if(r.confidence>.7)return console.log("✅ DETECTED: Tyler CAD split datetime pattern"),{pattern:r,suggestedMappings:Xs(r)};const o=Js(t,s);if(o.confidence>.7)return console.log("✅ DETECTED: Hexagon/CentralSquare combined datetime pattern"),{pattern:o,suggestedMappings:Zs(o)};const a=Ks(t,s);return a.confidence>.5?(console.log("✅ DETECTED: Volunteer department simple pattern"),{pattern:a,suggestedMappings:Qs(a)}):(console.log("⚠️ NO CLEAR DATETIME PATTERN DETECTED"),{pattern:{type:"unknown",confidence:0,description:"No clear datetime pattern detected - manual mapping required"},suggestedMappings:[]})},qs=(t,n)=>{console.log("🔍 Testing split datetime pattern (Tyler CAD style)...");const s=[/^inc_date$/i,/^incident_date$/i,/^date$/i,/^call_date$/i,/^event_date$/i],r=[/^alarm_time$/i,/^call_time$/i,/^time$/i,/^incident_time$/i,/^receive_time$/i,/^dispatch_time$/i];let o,a,l=0;for(const u of t){for(const p of s)if(p.test(u)){o=u,l+=.3,console.log(`📅 Found potential date field: "${u}"`);break}if(o)break}for(const u of t){for(const p of r)if(p.test(u)){a=u,l+=.3,console.log(`⏰ Found potential time field: "${u}"`);break}if(a)break}if(o&&a&&n[o]&&n[a]){const u=String(n[o]),p=String(n[a]);console.log("🧪 Sample data validation:"),console.log(`  Date field "${o}": "${u}"`),console.log(`  Time field "${a}": "${p}"`);const m=/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(u.trim()),T=/^\d{1,2}:\d{2}(:\d{2})?$/.test(p.trim());m&&T?(l+=.4,console.log("✅ Data validation passed - date-only + time-only pattern confirmed")):(console.log("⚠️ Data validation failed - not clean date-only + time-only pattern"),console.log(`  Date-only check: ${m}, Time-only check: ${T}`))}return{type:"split",confidence:l,dateField:o,timeField:a,description:l>.7?`Split datetime pattern detected: "${o}" + "${a}" should be combined`:"Potential split pattern found but low confidence"}},Js=(t,n)=>{console.log("🔍 Testing combined datetime pattern (Hexagon/CentralSquare style)...");const s=[/^calldatetime$/i,/^call_datetime$/i,/^incident_datetime$/i,/^event_datetime$/i,/^call_received_date\/time$/i,/^call.*time$/i,/^received.*time$/i];let r,o=0;for(const a of t){for(const l of s)if(l.test(a)){r=a,o+=.4,console.log(`📅⏰ Found potential combined datetime field: "${a}"`);break}if(r)break}if(!r)for(const a of t){const l=n[a];if(l&&typeof l=="string"&&/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/.test(l.trim())){r=a,o+=.3,console.log(`📅⏰ Found combined datetime by content analysis: "${a}" = "${l}"`);break}}if(r&&n[r]){const a=String(n[r]);console.log(`🧪 Sample data validation for combined field "${r}": "${a}"`),[/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}$/,/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/].some(p=>p.test(a.trim()))?(o+=.4,console.log("✅ Data validation passed - full datetime pattern confirmed")):console.log("⚠️ Data validation failed - not a full datetime pattern")}return{type:"combined",confidence:o,combinedField:r,description:o>.7?`Combined datetime pattern detected: "${r}" contains full date and time`:"Potential combined pattern found but low confidence"}},Ks=(t,n)=>{console.log("🔍 Testing simple datetime pattern (volunteer department style)...");const s=/^date$/i,r=/^time$/i,o=t.find(u=>s.test(u)),a=t.find(u=>r.test(u));let l=0;return o&&a&&(l+=.4,console.log(`📅 Found simple date field: "${o}"`),console.log(`⏰ Found simple time field: "${a}"`),n[o]&&n[a]&&(l+=.3,console.log("🧪 Sample data available for validation"))),{type:"simple",confidence:l,dateField:o,timeField:a,description:l>.5?`Simple datetime pattern detected: basic "${o}" + "${a}" fields`:"Simple pattern check completed - low confidence"}},Xs=t=>{const n=[];return t.dateField&&t.timeField&&(n.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine "${t.dateField}" + "${t.timeField}" into full datetime for incident time`}),n.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"extract",description:`Extract date from "${t.dateField}" for incident date`})),n},Zs=t=>{const n=[];return t.combinedField&&(n.push({sourceFields:[t.combinedField],targetField:"incident_time",transformationType:"direct",description:`Use "${t.combinedField}" directly for incident time`}),n.push({sourceFields:[t.combinedField],targetField:"incident_date",transformationType:"extract",description:`Extract date portion from "${t.combinedField}" for incident date`})),n},Qs=t=>{const n=[];return t.dateField&&t.timeField&&(n.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine simple "${t.dateField}" + "${t.timeField}" for incident time`}),n.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"direct",description:`Use "${t.dateField}" for incident date`})),n},en=ce(e.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"})),Zt=ce(e.jsx("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"})),tn=ce(e.jsx("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"})),rn=ce(e.jsx("path",{d:"M16.01 11H4v2h12.01v3L20 12l-3.99-4z"})),sn=ce(e.jsx("path",{d:"m19 9 1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25z"})),lt=ce(e.jsx("path",{d:"M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.996.996 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"})),nn=ce(e.jsx("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"})),on=ce(e.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2m-9 14-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),Ir=ce(e.jsx("path",{d:"M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),an=ce(e.jsx("path",{d:"M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6z"})),ln=ce(e.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),Pt=ce(e.jsx("path",{d:"M15 4v2h3v12h-3v2h5V4zM4 20h5v-2H6V6h3V4H4z"})),$r=ce(e.jsx("path",{d:"M4 7v2c0 .55-.45 1-1 1H2v4h1c.55 0 1 .45 1 1v2c0 1.65 1.35 3 3 3h3v-2H7c-.55 0-1-.45-1-1v-2c0-1.3-.84-2.42-2-2.83v-.34C5.16 11.42 6 10.3 6 9V7c0-.55.45-1 1-1h3V4H7C5.35 4 4 5.35 4 7m17 3c-.55 0-1-.45-1-1V7c0-1.65-1.35-3-3-3h-3v2h3c.55 0 1 .45 1 1v2c0 1.3.84 2.42 2 2.83v.34c-1.16.41-2 1.52-2 2.83v2c0 .55-.45 1-1 1h-3v2h3c1.65 0 3-1.35 3-3v-2c0-.55.45-1 1-1h1v-4z"})),xt=ce(e.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),Qt=ce(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2m0 12H4V8h16z"})),cn=ce(e.jsx("path",{d:"M2 17h2v.5H3v1h1v.5H2v1h3v-4H2zm1-9h1V4H2v1h1zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2zm5-6v2h14V5zm0 14h14v-2H7zm0-6h14v-2H7z"})),dn=ce(e.jsx("path",{d:"M11 18h2v-2h-2zm1-16C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8m0-14c-2.21 0-4 1.79-4 4h2c0-1.1.9-2 2-2s2 .9 2 2c0 2-3 1.75-3 5h2c0-2.25 3-2.5 3-5 0-2.21-1.79-4-4-4"})),kt=ce(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"})),er=ce(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),pn=ce(e.jsx("path",{d:"m20.5 10 .5-2h-4l1-4h-2l-1 4h-4l1-4h-2L9 8H5l-.5 2h4l-1 4h-4L3 16h4l-1 4h2l1-4h4l-1 4h2l1-4h4l.5-2h-4l1-4zm-7 4h-4l1-4h4z"})),tr=ce([e.jsx("path",{d:"M13 8.57c-.79 0-1.43.64-1.43 1.43s.64 1.43 1.43 1.43 1.43-.64 1.43-1.43-.64-1.43-1.43-1.43"},"0"),e.jsx("path",{d:"M13 3C9.25 3 6.2 5.94 6.02 9.64L4.1 12.2c-.25.33-.01.8.4.8H6v3c0 1.1.9 2 2 2h1v3h7v-4.68c2.36-1.12 4-3.53 4-6.32 0-3.87-3.13-7-7-7m3 7c0 .13-.01.26-.02.39l.83.66c.08.06.1.16.05.25l-.8 1.39c-.05.09-.16.12-.24.09l-.99-.4c-.21.16-.43.29-.67.39L14 13.83c-.01.1-.1.17-.2.17h-1.6c-.1 0-.18-.07-.2-.17l-.15-1.06c-.25-.1-.47-.23-.68-.39l-.99.4c-.09.03-.2 0-.25-.09l-.8-1.39c-.05-.08-.03-.19.05-.25l.84-.66c-.01-.13-.02-.26-.02-.39s.02-.27.04-.39l-.85-.66c-.08-.06-.1-.16-.05-.26l.8-1.38c.05-.09.15-.12.24-.09l1 .4c.2-.15.43-.29.67-.39L12 6.17c.02-.1.1-.17.2-.17h1.6c.1 0 .18.07.2.17l.15 1.06c.24.1.46.23.67.39l1-.4c.09-.03.2 0 .24.09l.8 1.38c.05.09.03.2-.05.26l-.85.66c.03.12.04.25.04.39"},"1")]),un=ce(e.jsx("path",{d:"M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3m1-4.3h-2V7h2z"})),Ar=ce(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),rr=ce(e.jsx("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3M7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5M16 17H8v-2h8zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13"})),mn=ce(e.jsx("path",{d:"m23 12-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69zm-12.91 4.72-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48z"})),hn=ce([e.jsx("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),e.jsx("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")]),_t=[{id:"incident_type",name:"🔥 Incident Type",description:"Fire, medical, accident, alarm, etc.",pattern:/(fire|medical|ems|accident|mva|alarm|rescue|hazmat)/gi,enabled:!0},{id:"response_time",name:"⏱️ Response Time",description:'Time values like "30 min", "1:20", "half hour"',pattern:/(\d+)\s*(min|minutes|hour|hours|hr|hrs)|(\d{1,2}):(\d{2})|half.hour|quarter.hour/gi,enabled:!0},{id:"location",name:"📍 Location",description:"Addresses, street names, landmarks",pattern:/\d+\s+[\w\s]+(street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd)/gi,enabled:!1},{id:"date_time",name:"📅 Date/Time",description:'Dates like "12/04/25", "April 12", times',pattern:/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})|(\w+\s+\d{1,2})|(\d{1,2}:\d{2})/gi,enabled:!1},{id:"units_resources",name:"🚒 Units/Resources",description:"Fire trucks, ambulances, personnel count",pattern:/(engine|truck|ambulance|rescue|ladder|chief|\d+\s*(firefighter|personnel|crew))/gi,enabled:!1}],gn=({open:t,onClose:n,columnName:s,sampleData:r,onParse:o})=>{const[a,l]=O.useState(["incident_type","response_time"]),[u,p]=O.useState(!1),[d,m]=O.useState([]),[x,T]=O.useState(!1);O.useEffect(()=>{a.length>0&&r.length>0&&$()},[a,r]);const E=i=>{l(c=>c.includes(i)?c.filter(h=>h!==i):[...c,i])},$=async()=>{p(!0);try{await new Promise(c=>setTimeout(c,500));const i=r.slice(0,5).map((c,h)=>({rowIndex:h,originalText:c,parsedFields:_(c,a)}));m(i)}catch(i){console.error("Error generating preview:",i)}finally{p(!1)}},_=(i,c)=>{const h={};return c.forEach(D=>{const P=_t.find(Z=>Z.id===D);if(!P)return;const Y=i.match(P.pattern);if(Y&&Y.length>0){const Z=Y[0];console.log(`🔍 PARSING DEBUG - Field: ${D}, Pattern: ${P.pattern}, Text: "${i}", Match: "${Z}"`),h[D]={value:U(D,Z),confidence:S(D,Z),original:Z}}}),h},U=(i,c)=>{switch(i){case"incident_type":return w(c);case"response_time":return W(c);case"location":return k(c);default:return c}},w=i=>{const c=i.toLowerCase();return c.includes("fire")?"Structure Fire":c.includes("medical")||c.includes("ems")?"Medical Emergency":c.includes("accident")||c.includes("mva")?"Motor Vehicle Accident":c.includes("alarm")?"Alarm Response":i},W=i=>{const c=i.match(/(\d+)\s*(min|minutes|hour|hours|hr|hrs)/i);if(c){const D=parseInt(c[1]);return c[2].toLowerCase().startsWith("h")?`${D} hour${D!==1?"s":""}`:`${D} minute${D!==1?"s":""}`}const h=i.match(/(\d{1,2}):(\d{2})/);if(h){const D=parseInt(h[1]),P=parseInt(h[2]);return`${D}:${P.toString().padStart(2,"0")}`}return i},k=i=>i.replace(/\b\w/g,c=>c.toUpperCase()),S=(i,c,h)=>i==="response_time"&&c.match(/\d+\s*(min|minutes)/i)?.95:i==="incident_type"&&["fire","medical","accident"].includes(c.toLowerCase())?.9:.7,B=async()=>{if(a.length!==0){T(!0);try{await new Promise(c=>setTimeout(c,1e3));const i=r.map((c,h)=>({rowIndex:h,originalText:c,parsedFields:_(c,a)}));o(a,i),n()}catch(i){console.error("Error parsing narrative data:",i)}finally{T(!1)}}},q=()=>a.length,G=()=>d.filter(i=>Object.keys(i.parsedFields).length>0).length;return e.jsxs(Ze,{open:t,onClose:n,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"70vh"}},children:[e.jsxs(Qe,{sx:{display:"flex",alignItems:"center",pb:1},children:[e.jsx(rr,{sx:{mr:1,color:"primary.main"}}),'Parse Narrative: "',s,'"']}),e.jsxs(et,{sx:{pb:1},children:[e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Extract structured data from narrative text using pattern matching and NLP. Select the fields you want to extract and preview the results."}),e.jsx(y,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"1. Select Fields to Extract"}),e.jsx(Qr,{sx:{mb:3},children:_t.map(i=>e.jsx(qe,{control:e.jsx(Zr,{checked:a.includes(i.id),onChange:()=>E(i.id)}),label:e.jsxs(j,{children:[e.jsx(y,{variant:"body2",sx:{fontWeight:"medium"},children:i.name}),e.jsx(y,{variant:"caption",color:"text.secondary",children:i.description})]})},i.id))}),e.jsx(xe,{sx:{my:2}}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(y,{variant:"h6",sx:{flexGrow:1},children:"2. Preview Results"}),u&&e.jsx(ze,{size:20,sx:{ml:2}})]}),a.length===0?e.jsx(de,{severity:"info",sx:{mb:2},children:"Select at least one field to see preview results."}):e.jsxs(e.Fragment,{children:[e.jsxs(j,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(le,{label:`${q()} fields selected`,size:"small",color:"primary"}),e.jsx(le,{label:`${G()}/${d.length} rows with data`,size:"small",color:"success"})]}),e.jsxs(mt,{size:"small",sx:{mb:2},children:[e.jsx(ht,{children:e.jsxs(ke,{children:[e.jsx(Fe,{children:"Original Text"}),a.map(i=>{const c=_t.find(h=>h.id===i);return e.jsx(Fe,{children:c==null?void 0:c.name},i)})]})}),e.jsx(gt,{children:d.map((i,c)=>e.jsxs(ke,{children:[e.jsx(Fe,{sx:{maxWidth:200},children:e.jsx(y,{variant:"body2",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i.originalText})}),a.map(h=>e.jsx(Fe,{children:i.parsedFields[h]?e.jsxs(j,{children:[e.jsx(y,{variant:"body2",children:i.parsedFields[h].value}),e.jsxs(y,{variant:"caption",color:"success.main",children:[Math.round(i.parsedFields[h].confidence*100),"% confident"]})]}):e.jsx(y,{variant:"caption",color:"text.secondary",children:"No match"})},h))]},c))})]}),e.jsx(de,{severity:"info",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:[e.jsx("strong",{children:"Preview shows first 5 rows."})," Parsing accuracy is typically 70-85%. You can edit any incorrect values after parsing."]})})]})]}),e.jsxs(tt,{sx:{p:3,pt:1},children:[e.jsx(re,{onClick:n,children:"Cancel"}),e.jsx(re,{variant:"contained",onClick:B,disabled:a.length===0||x,startIcon:x?e.jsx(ze,{size:20}):e.jsx(rr,{}),children:x?"Parsing...":`Parse ${s}`})]})]})},fn=({columnName:t,onClick:n,variant:s="icon",size:r="small",disabled:o=!1})=>{const a=()=>{n(t)};return s==="button"?e.jsx(re,{size:r,startIcon:e.jsx(lt,{}),onClick:a,disabled:o,sx:{minWidth:"auto",textTransform:"none",color:"primary.main","&:hover":{backgroundColor:"primary.50"}},children:"Parse"}):e.jsx(Le,{title:`Parse narrative text in "${t}" column`,children:e.jsx("span",{children:e.jsx(Ce,{size:r,onClick:a,disabled:o,sx:{color:"primary.main","&:hover":{backgroundColor:"primary.50",transform:"scale(1.1)"},transition:"all 0.2s ease-in-out"},children:e.jsx(lt,{fontSize:r})})})})},xn=({parsedFields:t,onFieldDragStart:n,onDeleteParsedField:s})=>{if(t.length===0)return null;const r=a=>a>=.9?"success":a>=.7?"warning":"error",o=a=>a>=.9?"High confidence":a>=.7?"Medium confidence":"Low confidence";return e.jsxs(j,{sx:{mt:1,ml:2},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(tr,{sx:{fontSize:16,color:"primary.main",mr:.5}}),e.jsx(y,{variant:"caption",color:"primary.main",sx:{fontWeight:"medium"},children:"Parsed Fields"})]}),e.jsx(nt,{spacing:.5,children:t.map(a=>e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(le,{label:a.name,size:"small",color:"secondary",variant:"outlined",draggable:!0,onDragStart:l=>{l.stopPropagation(),n(l,a.id)},sx:{cursor:"grab","&:active":{cursor:"grabbing"},"&:hover":{backgroundColor:"secondary.50"}},icon:e.jsx(tr,{})}),e.jsx(Le,{title:`${a.parsedCount}/${a.totalRows} rows parsed`,children:e.jsxs(y,{variant:"caption",color:"text.secondary",children:[Math.round(a.parsedCount/a.totalRows*100),"%"]})}),e.jsx(Le,{title:o(a.confidence),children:e.jsx(Ke,{sx:{fontSize:14,color:`${r(a.confidence)}.main`}})}),e.jsx(Le,{title:"Delete parsed field",children:e.jsx(Ce,{size:"small",onClick:()=>s(a.id),sx:{ml:.5,"&:hover":{color:"error.main"}},children:e.jsx(it,{sx:{fontSize:14}})})})]},a.id))}),e.jsx(y,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"Drag parsed fields to target fields →"})]})},yn=({id:t,isMapped:n,targetFields:s,sampleValue:r,dataType:o,onParseColumn:a,parsedFields:l=[],onParsedFieldDragStart:u,onDeleteParsedField:p})=>{const d=(o==="Text"||!o&&typeof r=="string")&&typeof r=="string"&&r.length>20;t==="Notes"&&console.log("🔍 NARRATIVE PARSER DEBUG for Notes column:",{fieldId:t,dataType:o,sampleValue:r,sampleValueType:typeof r,sampleValueLength:typeof r=="string"?r.length:"N/A",isTextColumn:d,onParseColumn:!!a});const m={backgroundColor:n?"#f0f7ff":void 0,border:n?"1px solid #90caf9":"1px solid #e0e0e0",cursor:"grab",padding:"8px 12px",borderRadius:"4px",marginBottom:"8px",position:"relative"},x=E=>{console.log("DRAG START on source field:",t),E.dataTransfer.setData("text/plain",t),E.dataTransfer.effectAllowed="move",console.log("Verifying dataTransfer was set:",E.dataTransfer.types);const $=document.createElement("div");$.className="drag-ghost",$.innerHTML=`<div style="padding: 10px; background: #1976d2; color: white; border-radius: 4px;">Dragging: ${t}</div>`,document.body.appendChild($),E.dataTransfer.setDragImage($,20,20);const _=E.currentTarget;_.style.opacity="0.6",_.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.2)",setTimeout(()=>{document.body.removeChild($)},0),console.log("Drag started with field:",t)},T=E=>{const $=E.currentTarget;$.style.opacity="",$.style.boxShadow="",console.log("Drag ended for field:",t)};return e.jsx("div",{style:m,"data-field-id":t,className:"draggable-source-field",draggable:!0,onDragStart:x,onDragEnd:T,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsxs(j,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(y,{variant:"body2",fontWeight:"medium",children:t}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[d&&a&&e.jsx(fn,{columnName:t,onClick:a,variant:"icon",size:"small"}),n&&e.jsx(le,{size:"small",icon:e.jsx(en,{fontSize:"small"}),label:s.length===1?s[0]:`${s.length} fields`,color:"primary",variant:"outlined"})]})]}),r!==void 0&&e.jsxs(j,{sx:{mt:.5,display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.75rem"},children:[e.jsx(y,{variant:"caption",sx:{color:"text.secondary",fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:typeof r=="object"?JSON.stringify(r):String(r)}),o&&e.jsx(le,{label:o,size:"small",variant:"outlined",sx:{height:"16px",fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]}),l.length>0&&e.jsx(xn,{parsedFields:l.map(E=>({id:E.id,name:E.name,sourceColumn:E.sourceColumn,parsedCount:E.parsedCount,totalRows:E.totalRows,confidence:E.confidence})),onFieldDragStart:u||(()=>{}),onDeleteParsedField:p||(()=>{})})]})})},bn=({sourceColumns:t,filter:n,setFilter:s,mappings:r,sampleData:o=[],onAddParsedFields:a})=>{const[l,u]=O.useState(!1),[p,d]=O.useState(""),[m,x]=O.useState({}),T=i=>{d(i),u(!0)},E=()=>{u(!1),d("")},$=(i,c)=>{console.log("🔥 Parsing completed for column:",p),console.log("📊 Selected fields:",i),console.log("📋 Results:",c);const h=i.map(D=>{const P=_(D),Y=[];let Z=0,ie=0;c.forEach(N=>{N.parsedFields[D]?(Y.push(N.parsedFields[D].value),Z++,ie+=N.parsedFields[D].confidence):Y.push(null)});const M=Z>0?ie/Z:0;return{id:`${p}_${D}`,name:P,sourceColumn:p,parsedCount:Z,totalRows:c.length,confidence:M,data:Y}});if(x(D=>({...D,[p]:h})),o&&o.length>0){const D=o.map((P,Y)=>{const Z={...P};return h.forEach(ie=>{if(ie.data[Y]!==null){const M=ie.id.split("_").slice(1).join("_"),N=`${p}_parsed_${M}`;Z[N]=ie.data[Y],console.log(`🤖 INJECTED parsed data: ${N} = "${ie.data[Y]}"`)}}),Z});console.log("🤖 Updated sample data with parsed fields:",D)}a&&a(p,h)},_=i=>({incident_type:"📊 Parsed Incident Type",response_time:"⏱️ Parsed Response Time",location:"📍 Parsed Location",date_time:"📅 Parsed Date/Time",units_resources:"🚒 Parsed Units/Resources"})[i]||`🤖 Parsed ${i}`,U=(i,c)=>{console.log("🔥 Dragging parsed field:",c),i.dataTransfer.setData("text/plain",c),i.dataTransfer.effectAllowed="move"},w=i=>{console.log("🗑️ Deleting parsed field:",i);const c=Object.keys(m).find(h=>m[h].some(D=>D.id===i));c&&x(h=>({...h,[c]:h[c].filter(D=>D.id!==i)}))},W=i=>!o||o.length===0?[]:o.slice(0,10).map(c=>c[i]||"").filter(Boolean),k=O.useMemo(()=>{if(!n)return t;const i=n.toLowerCase();return t.filter(c=>c.toLowerCase().includes(i))},[t,n]),S=O.useMemo(()=>{const i={};return r.forEach(c=>{i[c.sourceField]||(i[c.sourceField]=[]),i[c.sourceField].push(c.targetField)}),i},[r]),B=O.useMemo(()=>Object.keys(S).length,[S]),q=O.useMemo(()=>{if(!o||o.length===0)return{};const i=o[0],c={};return t.forEach(h=>{c[h]=i[h]}),c},[o,t]),G=O.useMemo(()=>{const i={};return Object.entries(q).forEach(([c,h])=>{if(h==null){i[c]="Unknown";return}if(typeof h=="string"){if([/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/,/^\d{4}\/\d{2}\/\d{2}$/].some(Y=>Y.test(h))){i[c]="Date";return}if([/^\d{1,2}:\d{2}(:\d{2})?$/,/^\d{1,2}:\d{2}(:\d{2})?\s*(AM|PM)$/i].some(Y=>Y.test(h))){i[c]="Time";return}if(!isNaN(Number(h))){i[c]="Number";return}i[c]="Text";return}typeof h=="number"?i[c]="Number":typeof h=="boolean"?i[c]="Boolean":Array.isArray(h)?i[c]="Array":typeof h=="object"?i[c]="Object":i[c]=typeof h}),i},[q]);return e.jsxs(ge,{sx:{height:"100%",p:2,display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsx(be,{size:"small",placeholder:"Search source fields...",value:n,onChange:i=>s(i.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(at,{fontSize:"small"})})}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(y,{variant:"body2",color:"text.secondary",children:[k.length," fields"]}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:[B," mapped"]})]}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(y,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drag fields from here to the Target Fields panel"})}),e.jsx(xe,{sx:{mb:2}}),e.jsxs(j,{sx:{flexGrow:1,overflow:"auto",maxHeight:"calc(100% - 180px)",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:[k.map(i=>e.jsx(yn,{id:i,isMapped:!!S[i],targetFields:S[i]||[],sampleValue:q[i],dataType:G[i],onParseColumn:T,parsedFields:m[i]||[],onParsedFieldDragStart:U,onDeleteParsedField:w},i)),k.length===0&&e.jsx(j,{sx:{textAlign:"center",py:4},children:e.jsx(y,{variant:"body2",color:"text.secondary",children:"No fields match your search"})})]}),e.jsx(gn,{open:l,onClose:E,columnName:p,sampleData:W(p),onParse:$})]})},jn=({open:t,onClose:n,fieldName:s,mapping:r,sampleData:o,onSave:a})=>{const[l,u]=O.useState(0),[p,d]=O.useState([]),[m,x]=O.useState("auto"),[T,E]=O.useState(""),[$,_]=O.useState(","),[U,w]=O.useState(0),[W,k]=O.useState("string");O.useEffect(()=>{if(r){if(r.sourceField&&o.length>0){const c=o.map(h=>h[r.sourceField]).filter(h=>h!=null).slice(0,5);d(c)}r.transformations&&r.transformations.length>0&&r.transformations.forEach(c=>{switch(c.type){case"format":const h=c.params.format||c.params.dateFormat;h&&(h==="custom"?(x("custom"),E(c.params.customFormat||"")):x(h));break;case"split":_(c.params.delimiter||","),w(c.params.index||0);break;case"convert":k(c.params.toType||"string");break}})}},[r,o]);const S=(c,h)=>{u(h)},B=()=>{const c=[];l===0&&m!=="auto"&&c.push({type:"format",params:{type:"date",format:m,fieldName:s,...m==="custom"?{customFormat:T}:{}}}),l===1&&c.push({type:"split",params:{delimiter:$,index:U}}),l===2&&c.push({type:"convert",params:{toType:W}}),a(s,c)},q=p.length>0,i=(()=>{if(!q)return[];switch(l){case 0:return p.map(c=>{if(!c)return"N/A";try{const h=new Date(c);if(isNaN(h.getTime()))return"Invalid date";switch(m){case"auto":return h.toLocaleString();case"MM/DD/YYYY":return`${h.getMonth()+1}/${h.getDate()}/${h.getFullYear()}`;case"YYYY-MM-DD":return`${h.getFullYear()}-${(h.getMonth()+1).toString().padStart(2,"0")}-${h.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${h.getDate()}/${h.getMonth()+1}/${h.getFullYear()}`;case"date-only":return new Date(c).toLocaleDateString();case"custom":return T.replace("YYYY",h.getFullYear().toString()).replace("MM",(h.getMonth()+1).toString().padStart(2,"0")).replace("DD",h.getDate().toString().padStart(2,"0")).replace("HH",h.getHours().toString().padStart(2,"0")).replace("mm",h.getMinutes().toString().padStart(2,"0")).replace("ss",h.getSeconds().toString().padStart(2,"0"));default:return h.toLocaleString()}}catch{return"Error formatting date"}});case 1:return p.map(c=>{if(!c)return"N/A";try{return c.toString().split($)[U]||`Index ${U} not found`}catch{return"Error splitting value"}});case 2:return p.map(c=>{if(c==null)return"N/A";try{switch(W){case"string":return String(c);case"number":return Number(c);case"boolean":return(!!c).toString();default:return String(c)}}catch{return"Error converting value"}})}return[]})();return e.jsxs(Ze,{open:t,onClose:n,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Qe,{children:["Transform Field: ",s]}),e.jsx(et,{dividers:!0,children:e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(jt,{value:l,onChange:S,"aria-label":"transformation tabs",children:[e.jsx(Ie,{label:"Date/Time Format"}),e.jsx(Ie,{label:"Split/Extract"}),e.jsx(Ie,{label:"Type Conversion"})]})}),e.jsxs(j,{role:"tabpanel",hidden:l!==0,sx:{p:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Date Format Settings"}),e.jsx(y,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Choose how date and time values should be formatted. Date-only formats automatically strip time components."}),e.jsxs(Ve,{fullWidth:!0,sx:{mb:2},children:[e.jsx(He,{id:"date-format-label",children:"Date Format"}),e.jsxs(We,{labelId:"date-format-label",id:"date-format-select",value:m,label:"Date Format",onChange:c=>x(c.target.value),children:[e.jsx(oe,{value:"auto",children:"Auto-detect"}),e.jsx(oe,{value:"MM/DD/YYYY",children:"MM/DD/YYYY (date only)"}),e.jsx(oe,{value:"DD/MM/YYYY",children:"DD/MM/YYYY (date only)"}),e.jsx(oe,{value:"YYYY-MM-DD",children:"YYYY-MM-DD (date only)"}),e.jsx(oe,{value:"date-only",children:"Date Only (strip time)"}),e.jsx(oe,{value:"custom",children:"Custom Format"})]})]}),m==="custom"&&e.jsx(be,{fullWidth:!0,label:"Custom Format",value:T,onChange:c=>E(c.target.value),helperText:"Use YYYY for year, MM for month, DD for day, HH for hour, mm for minute, ss for second",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==1,sx:{p:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Split or Extract Value"}),e.jsx(y,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Split a field by a delimiter and extract a specific part."}),e.jsx(be,{fullWidth:!0,label:"Delimiter",value:$,onChange:c=>_(c.target.value),helperText:"Character or text that separates the parts",sx:{mb:2}}),e.jsx(be,{fullWidth:!0,label:"Index",type:"number",value:U,onChange:c=>w(parseInt(c.target.value)||0),helperText:"Position of the part to extract (0 = first part)",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:l!==2,sx:{p:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Type Conversion"}),e.jsx(y,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Convert the value to a different data type."}),e.jsxs(Ve,{fullWidth:!0,sx:{mb:2},children:[e.jsx(He,{id:"convert-type-label",children:"Convert To"}),e.jsxs(We,{labelId:"convert-type-label",id:"convert-type-select",value:W,label:"Convert To",onChange:c=>k(c.target.value),children:[e.jsx(oe,{value:"string",children:"Text (String)"}),e.jsx(oe,{value:"number",children:"Number"}),e.jsx(oe,{value:"boolean",children:"True/False (Boolean)"})]})]})]}),e.jsx(xe,{sx:{my:2}}),e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Preview"}),q?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(j,{sx:{display:"flex",borderBottom:1,borderColor:"divider",pb:1},children:[e.jsx(y,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Original Value"}),e.jsx(y,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Transformed Value"})]}),p.map((c,h)=>e.jsxs(j,{sx:{display:"flex",py:1,borderBottom:"1px solid #eee"},children:[e.jsx(y,{variant:"body2",sx:{width:"50%"},children:c==null?"Null/Empty":String(c)}),e.jsx(y,{variant:"body2",sx:{width:"50%"},children:i[h]})]},h))]}):e.jsx(de,{severity:"info",children:"No sample data available for preview."})]})}),e.jsxs(tt,{children:[e.jsx(re,{onClick:n,children:"Cancel"}),e.jsx(re,{onClick:B,variant:"contained",children:"Apply Transformation"})]})]})},vn=t=>{switch(t.dataType){case"string":return`DEFAULT-${t.name}`;case"number":return"0";case"boolean":return"false";case"date":return new Date().toISOString().split("T")[0];case"location":return"0.0,0.0";default:return""}},Tn=({open:t,onClose:n,unmappedRequiredFields:s,onAddDefaultMappings:r})=>{const[o,a]=O.useState(()=>{const d={};return s.forEach(m=>{d[m.name]=vn(m)}),d}),l=(d,m)=>{a(x=>({...x,[d]:m}))},u=()=>{console.log("Creating default mappings for fields:",s),console.log("Default values:",o);const d=s.map(m=>{const x={sourceField:"__default__",targetField:m.name,transformations:[{type:"convert",params:{defaultValue:o[m.name],targetType:m.dataType}}]};return console.log(`Created default mapping for ${m.name}:`,x),x});console.log("All default mappings:",d),r(d),n()},p=d=>{switch(d){case"number":return"number";case"date":return"date";default:return"text"}};return e.jsxs(Ze,{open:t,onClose:n,"aria-labelledby":"default-value-dialog-title",maxWidth:"md",fullWidth:!0,children:[e.jsx(Qe,{id:"default-value-dialog-title",children:"Set Default Values for Required Fields"}),e.jsxs(et,{children:[e.jsx(y,{variant:"body1",sx:{mb:3},children:"The following required fields don't have mappings. Please provide default values for them."}),e.jsx(ue,{container:!0,spacing:3,children:s.map(d=>e.jsxs(ue,{size:{xs:12,sm:6},children:[e.jsxs(j,{sx:{mb:1},children:[e.jsxs(y,{variant:"subtitle2",children:[d.name,e.jsx(le,{size:"small",label:d.dataType,color:"primary",variant:"outlined",sx:{ml:1}})]}),e.jsx(y,{variant:"caption",color:"text.secondary",children:d.description})]}),d.dataType==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:o[d.name]||"false",onChange:m=>l(d.name,m.target.value),variant:"outlined",size:"small",children:[e.jsx(oe,{value:"true",children:"True"}),e.jsx(oe,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:o[d.name]||"",onChange:m=>l(d.name,m.target.value),type:p(d.dataType),variant:"outlined",size:"small",placeholder:`Enter default value for ${d.name}`,InputLabelProps:{shrink:!0}}),e.jsx(qr,{children:"Default value for all records"})]},d.name))})]}),e.jsxs(tt,{children:[e.jsx(re,{onClick:n,color:"primary",children:"Cancel"}),e.jsx(re,{onClick:u,color:"primary",variant:"contained",children:"Apply Default Values"})]})]})},Sn=({mapping:t,sampleData:n,onClose:s})=>{const r=zt(),o=O.useMemo(()=>!t||!n.length?[]:n.slice(0,5).map(l=>({sourceValue:l[t.sourceField],transformedValue:(t.transformations||[]).reduce((u,p)=>_r(u,p,t.targetField),l[t.sourceField])})),[t,n]);if(!t)return e.jsx(ge,{sx:{p:2,mt:2,backgroundColor:me(r.palette.info.light,.1),border:`1px dashed ${r.palette.info.main}`,borderRadius:1},children:e.jsx(y,{variant:"body2",color:"text.secondary",align:"center",children:"Select a field mapping to see transformation preview"})});if(!o.length||!t.sourceField)return e.jsx(ge,{sx:{p:2,mt:2,backgroundColor:me(r.palette.warning.light,.1),border:`1px dashed ${r.palette.warning.main}`,borderRadius:1},children:e.jsxs(y,{variant:"body2",color:"text.secondary",children:["No sample data available for ",t.sourceField||"this field"]})});const a=t.transformations||[];return e.jsxs(ge,{sx:{p:2,mt:2,borderRadius:1,border:`1px solid ${r.palette.divider}`,boxShadow:r.shadows[1],position:"relative"},children:[s&&e.jsx(Ce,{size:"small",onClick:s,sx:{position:"absolute",top:8,right:8,color:r.palette.grey[500],"&:hover":{backgroundColor:me(r.palette.grey[100],.9),color:r.palette.grey[800]}},"aria-label":"close preview",children:e.jsx(ns,{fontSize:"small"})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,pr:4},children:[e.jsxs(y,{variant:"subtitle2",color:"primary",gutterBottom:!0,children:["Field Transformation Preview: ",t.targetField]}),e.jsx(le,{size:"small",label:`${a.length} transformation${a.length!==1?"s":""}`,color:a.length>0?"primary":"default",icon:a.length>0?e.jsx(lt,{}):void 0})]}),e.jsx(xe,{sx:{mb:2}}),e.jsx(j,{sx:{maxHeight:200,overflow:"auto"},children:o.map((l,u)=>{const p=l.sourceValue!==void 0&&l.sourceValue!==null,d=a.length>0,m=typeof l.sourceValue,x=typeof l.transformedValue,T=m!==x;return e.jsxs(j,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:u%2===0?me(r.palette.background.default,.5):"transparent",display:"flex",alignItems:"center"},children:[e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Source (",t.sourceField,")"]}),e.jsx(y,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:p?me(r.palette.success.light,.1):me(r.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:p?String(l.sourceValue):"(empty)"}),e.jsx(y,{variant:"caption",color:"text.secondary",children:m})]}),e.jsx(j,{sx:{flexBasis:"10%",textAlign:"center"},children:e.jsx(rn,{color:d?"primary":"action"})}),e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Result (",t.targetField,")"]}),e.jsx(y,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:l.transformedValue!==void 0?me(r.palette.success.light,.1):me(r.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:l.transformedValue!==void 0?String(l.transformedValue):"(empty)"}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(y,{variant:"caption",color:"text.secondary",children:x}),T&&e.jsx(le,{size:"small",label:`Type: ${m} → ${x}`,color:"warning",variant:"outlined",sx:{height:16,fontSize:"0.6rem"}})]})]})]},u)})}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{my:2}}),e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Transformation Steps Applied:"}),e.jsx(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:a.map((l,u)=>{var p,d,m,x,T,E,$,_,U;return e.jsxs(j,{sx:{display:"flex",alignItems:"center",p:1,borderRadius:1,backgroundColor:me(r.palette.primary.light,.05),border:`1px solid ${me(r.palette.primary.light,.2)}`},children:[e.jsxs(j,{sx:{mr:1,color:r.palette.primary.main},children:[u+1,"."]}),e.jsxs(y,{variant:"body2",children:[e.jsxs("strong",{children:[l.type,":"]})," "," ",l.type==="convert"&&((p=l.params)==null?void 0:p.dataType)&&`Convert to ${l.params.dataType}`,l.type==="convert"&&((d=l.params)==null?void 0:d.defaultValue)!==void 0&&`Set default value to "${l.params.defaultValue}"`,l.type==="format"&&((m=l.params)==null?void 0:m.type)==="date"&&(((x=l.params)==null?void 0:x.format)||((T=l.params)==null?void 0:T.dateFormat))&&`Format date as "${l.params.format||l.params.dateFormat}"${l.params.customFormat?` (${l.params.customFormat})`:""}`,l.type==="format"&&((E=l.params)==null?void 0:E.pattern)&&`Format using pattern "${l.params.pattern}"`,l.type==="extract"&&(($=l.params)==null?void 0:$.pattern)&&`Extract using pattern "${l.params.pattern}"`,l.type==="replace"&&((_=l.params)==null?void 0:_.from)&&((U=l.params)==null?void 0:U.to)&&`Replace "${l.params.from}" with "${l.params.to}"`]})]},u)})})]}),t.targetField&&e.jsxs(j,{sx:{mt:2,p:1,borderRadius:1,display:"flex",alignItems:"center",backgroundColor:o.some(l=>l.transformedValue===void 0||l.transformedValue===null)?me(r.palette.warning.light,.1):me(r.palette.success.light,.1)},children:[o.some(l=>l.transformedValue===void 0||l.transformedValue===null)?e.jsx(xt,{color:"warning",sx:{mr:1}}):e.jsx(Ir,{color:"success",sx:{mr:1}}),e.jsx(y,{variant:"body2",children:o.some(l=>l.transformedValue===void 0||l.transformedValue===null)?"Some values could not be transformed. Consider adding a default value.":"All sample values were successfully transformed."})]})]})},En=rt(({className:t,...n})=>e.jsx(Le,{...n,classes:{popper:t}}))(()=>({"& .MuiTooltip-tooltip":{backgroundColor:"transparent",padding:0,maxWidth:320}})),Fn=rt(ge)(({theme:t})=>({padding:t.spacing(2),backgroundColor:t.palette.background.paper,boxShadow:t.shadows[3],borderRadius:t.shape.borderRadius,border:`1px solid ${t.palette.divider}`,minWidth:200,maxWidth:320})),Cn=rt(y)(({theme:t})=>({fontWeight:600,marginBottom:t.spacing(1),borderBottom:`1px solid ${t.palette.divider}`,paddingBottom:t.spacing(.5),color:t.palette.primary.main})),Ge=({title:t,children:n,content:s,icon:r=!1,placement:o="top",enterDelay:a=100,leaveDelay:l=100})=>{console.log(`EnhancedTooltip rendering: ${t} with icon=${r}`);const u=r?e.jsxs(j,{sx:{display:"inline-flex",alignItems:"center"},children:[n,e.jsx(dn,{color:"action",fontSize:"small",sx:{ml:.5,opacity:.7}})]}):n;return e.jsx(En,{title:e.jsxs(Fn,{children:[e.jsx(Cn,{variant:"subtitle2",children:t}),s]}),placement:o,arrow:!0,enterDelay:a,leaveDelay:l,children:u})},Dn=({toolConfig:t,showAllFields:n,setShowAllFields:s,filter:r,setFilter:o,mappings:a,onMappingChange:l,onRemoveMapping:u,validationErrors:p,sampleData:d,sourceColumns:m=[]})=>{const x=zt();console.log("TargetFieldsPanel received sourceColumns:",m),console.log("TargetFieldsPanel received toolConfig:",t),console.log("TargetFieldsPanel received mappings:",a);const[T,E]=O.useState(null),[$,_]=O.useState(null),[U,w]=O.useState({Timing:!0,Location:!0,"Incident Details":!0}),W=O.useMemo(()=>{const f={};return p.forEach(L=>{f[L.field]={message:L.message,severity:L.severity}}),f},[p]),k=O.useMemo(()=>{const f={};return a.forEach(L=>{f[L.targetField]=L.sourceField}),f},[a]),S=O.useMemo(()=>{const f={};return[...t.requiredFields,...t.optionalFields].forEach(A=>{let V;A.dataType==="date"||A.name.toLowerCase().includes("time")||A.name.toLowerCase().includes("date")?V="Timing":A.dataType==="location"||A.name.toLowerCase().includes("lat")||A.name.toLowerCase().includes("lon")||A.name.toLowerCase().includes("address")?V="Location":V="Incident Details",f[V]||(f[V]=[]),f[V].push(A)}),f},[t]),B=O.useMemo(()=>{if(!r)return n?[...t.requiredFields,...t.optionalFields]:S;const f=r.toLowerCase(),A=[...t.requiredFields,...t.optionalFields].filter(F=>{var v;return F.name.toLowerCase().includes(f)||((v=F.description)==null?void 0:v.toLowerCase().includes(f))});if(n)return A;const V={};return A.forEach(F=>{let v;for(const[C,J]of Object.entries(S))if(J.some(K=>K.id===F.id)){v=C;break}v||(v="Other"),V[v]||(V[v]=[]),V[v].push(F)}),V},[t,r,n,S]),q=f=>{w({...U,[f]:!U[f]})},G=(f,L)=>{console.log("Dropdown selection - mapping",L,"to",f);try{if(!L){u(f);return}l({sourceField:L,targetField:f}),console.log("Mapping updated via dropdown successfully")}catch(A){console.error("Error updating mapping via dropdown:",A)}},i=f=>{E(f)},c=()=>{E(null)},h=f=>{_(L=>L===f?null:f)},D=(f,L)=>{const A=a.find(V=>V.targetField===f);A&&l({...A,transformations:L}),E(null)},P=f=>{switch(f){case"string":return{icon:e.jsx(Gt,{fontSize:"small"}),color:"info"};case"number":return{icon:e.jsx(pn,{fontSize:"small"}),color:"secondary"};case"date":return{icon:e.jsx(nn,{fontSize:"small"}),color:"warning"};case"boolean":return{icon:e.jsx(on,{fontSize:"small"}),color:"success"};case"location":return{icon:e.jsx(ts,{fontSize:"small"}),color:"error"};default:return{icon:e.jsx(Gt,{fontSize:"small"}),color:"default"}}},Y=f=>{const L=k[f.id],A=W[f.id],V=$===f.id;console.log(`🔧 FIELD RENDER: ${f.name} (ID: ${f.id}), mapped to: ${L||"none"}`);const F=R=>{R.preventDefault(),R.stopPropagation(),R.dataTransfer.dropEffect="move";const b=R.currentTarget;b.style.boxShadow="0 0 0 2px #1976d2",b.style.borderColor="#1976d2",b.style.backgroundColor="#f0f7ff",b.style.transform="scale(1.01)",b.style.transition="all 0.2s ease",console.log("DRAG OVER on target field:",f.name)},v=R=>{R.preventDefault(),R.stopPropagation();const b=R.currentTarget;b.style.boxShadow="",b.style.borderColor=A?A.severity==="error"?"#f44336":"#ff9800":L?"#4caf50":"#e0e0e0",b.style.backgroundColor=A?A.severity==="error"?"#fff5f5":"#fffbf0":L?"#f4fbf4":"#ffffff",b.style.transform="",console.log("DRAG LEAVE from field:",f.name)},C=R=>{R.preventDefault(),R.stopPropagation(),console.log("DROP EVENT TRIGGERED on field:",f.name);try{const b=R.dataTransfer.getData("text/plain");if(console.log("Dropped source field data:",b),!b){console.error("No source field data found in the drop event");return}const g=R.currentTarget;g.style.boxShadow="",g.style.borderColor="",g.style.backgroundColor="",g.style.transform="",l({sourceField:b,targetField:f.id}),_(f.id),g.style.boxShadow="0 0 0 2px #4caf50",g.style.borderColor="#4caf50",g.style.backgroundColor="#f4fbf4",g.style.transform="scale(1.02)";const z=b;setTimeout(()=>{try{z?(g.style.borderColor="#4caf50",g.style.backgroundColor="#f4fbf4"):(g.style.borderColor=A?A.severity==="error"?"#f44336":"#ff9800":"#e0e0e0",g.style.backgroundColor=A?A.severity==="error"?"#fff5f5":"#fffbf0":"#ffffff"),g.style.boxShadow="",g.style.transform=""}catch(H){console.error("Error in animation cleanup:",H)}},1e3),console.log(`Successfully dropped ${b} onto ${f.name}`)}catch(b){console.error("Error in drop handler:",b)}},J=()=>{L&&h(f.name)},K=()=>e.jsxs(j,{children:[e.jsxs(y,{variant:"body2",children:[e.jsx("strong",{children:"Required Format:"})," ",f.format||"No specific format required"]}),f.examples&&e.jsxs(j,{sx:{mt:1},children:[e.jsx(y,{variant:"body2",children:e.jsx("strong",{children:"Examples:"})}),e.jsx(j,{component:"ul",sx:{mt:.5,pl:2},children:f.examples.map((R,b)=>e.jsx(j,{component:"li",children:e.jsx(y,{variant:"body2",fontFamily:"monospace",children:R})},b))})]}),f.validation&&e.jsxs(y,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Validation:"})," ",String(f.validation)]})]}),I=()=>{let R="";switch(f.dataType){case"string":R="Text value. Can contain any characters.";break;case"number":R="Numeric value. Can be integer or decimal.";break;case"date":R="Date value. Should be in a standard format.";break;case"boolean":R="True/False value.";break;case"location":R="Geographic coordinates or address.";break;default:R=`${f.dataType} data type.`}return e.jsxs(j,{children:[e.jsx(y,{variant:"body2",children:R}),f.dataType==="date"&&e.jsx(y,{variant:"body2",sx:{mt:1},children:"Common formats: YYYY-MM-DD, MM/DD/YYYY"})]})};return e.jsxs(j,{sx:{p:2,mb:2,border:"1px solid",borderColor:A?A.severity==="error"?"error.main":"warning.main":L?"success.light":"divider",borderRadius:1,bgcolor:A?A.severity==="error"?me(x.palette.error.light,.1):me(x.palette.warning.light,.1):L?me(x.palette.success.light,.1):"background.paper",position:"relative",transition:"all 0.3s ease",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",cursor:L?"pointer":"default",...V&&{boxShadow:"0 0 0 2px #1976d2",border:"1px solid #1976d2"},"&:hover":L?{boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transform:"translateY(-2px)"}:{}},draggable:!1,id:`target-field-${f.id}`,"data-target-field":f.id,onDragOver:F,onDragLeave:v,onDrop:C,onClick:J,children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(j,{children:[e.jsx(Ge,{title:`${f.name} Field`,content:K(),placement:"top-start",icon:!0,children:e.jsxs(y,{variant:"subtitle2",component:"div",sx:{display:"inline-flex",alignItems:"center",cursor:"help"},children:[f.name,f.isRequired&&e.jsx(le,{size:"small",label:"Required",color:"primary",sx:{ml:1,height:20}}),L&&e.jsx(le,{size:"small",label:"Click to preview",color:"info",variant:"outlined",sx:{ml:1,height:20,display:{xs:"none",sm:"flex"},animation:V?"none":"pulse 1.5s infinite","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0.4)"},"70%":{boxShadow:"0 0 0 6px rgba(33, 150, 243, 0)"},"100%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0)"}}}})]})}),f.dataType&&e.jsx(Ge,{title:`${f.dataType} Data Type`,content:I(),children:e.jsx(le,{size:"small",label:f.dataType,color:P(f.dataType).color,variant:"outlined",icon:P(f.dataType).icon,sx:{mt:1,mr:1,height:20}})}),e.jsx(y,{variant:"body2",color:"text.secondary",children:f.description})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"flex-start"},children:[A&&e.jsx(Ge,{title:"Validation Issue",content:e.jsx(y,{variant:"body2",children:A.message}),type:A.severity==="error"?"warning":"info",children:e.jsx(j,{sx:{display:"flex",alignItems:"center",mr:1},children:A.severity==="error"?e.jsx(Er,{color:"error",fontSize:"small"}):e.jsx(vr,{color:"warning",fontSize:"small"})})}),L&&e.jsxs(e.Fragment,{children:[e.jsx(Ge,{title:"Edit Transformations",content:e.jsx(y,{variant:"body2",children:"Configure data transformations for this field mapping. Apply operations like splitting, joining, formatting and type conversion."}),children:e.jsx(Ce,{size:"small",onClick:R=>{R.stopPropagation(),i(f.id)},sx:{mr:1},children:e.jsx(Sr,{fontSize:"small"})})}),e.jsx(Ge,{title:"Remove Mapping",content:e.jsx(y,{variant:"body2",children:"Remove the current mapping between source and target fields."}),type:"warning",children:e.jsx(Ce,{size:"small",onClick:R=>{R.stopPropagation(),u(f.id)},children:e.jsx(it,{fontSize:"small"})})})]})]})]}),e.jsxs(Ve,{fullWidth:!0,size:"small",children:[e.jsx(He,{id:`${f.id}-source-label`,children:"Select source field"}),e.jsxs(We,{labelId:`${f.id}-source-label`,id:`${f.id}-source-select`,value:L||"",label:"Select source field",onChange:R=>{try{G(f.id,R.target.value),R.target.value?_(f.name):$===f.name&&_(null)}catch(b){console.error("Error in dropdown change handler:",b)}},MenuProps:{anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},slotProps:{paper:{elevation:4,style:{maxHeight:300}}}},renderValue:R=>R||e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"}),endAdornment:L&&e.jsx(Ae,{position:"end",children:e.jsx(Ge,{title:"Field is Mapped",content:e.jsxs(y,{variant:"body2",children:['This field is mapped to source field "',L,'". Click the field to preview the mapping.']}),children:e.jsx(Ke,{color:"success",fontSize:"small"})})}),onClick:R=>R.stopPropagation(),children:[e.jsx(oe,{value:"",children:e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"})}),Array.isArray(m)&&m.length>0?m.map(R=>{const b=d&&d.length>0?d[0][R]:void 0;let g="Unknown";b!=null&&(typeof b=="string"?[/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/].some(X=>X.test(b))?g="Date":/^\d{1,2}:\d{2}(:\d{2})?(\s*(AM|PM))?$/i.test(b)?g="Time":isNaN(Number(b))?g="Text":g="Number":g=typeof b);const z=H=>H==null?"":typeof H=="object"?JSON.stringify(H).substring(0,30):String(H).substring(0,30);return e.jsx(oe,{value:R,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsx(y,{variant:"body2",children:R}),b!==void 0&&e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(y,{variant:"caption",sx:{fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"text.secondary"},children:z(b)}),e.jsx(le,{label:g,size:"small",sx:{height:16,fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]})]})},R)}):e.jsx(oe,{disabled:!0,children:e.jsx("em",{children:"No source fields available"})})]})]})]},f.id)},Z=()=>{if(n){const f=Array.isArray(B)?B:Object.values(B).flat();return e.jsx(j,{children:f.map(Y)})}else return Object.entries(B).map(([f,L])=>e.jsxs(yr,{expanded:U[f]||!1,onChange:()=>q(f),sx:{mb:2},children:[e.jsxs(br,{expandIcon:e.jsx(bt,{}),children:[e.jsx(y,{variant:"subtitle1",children:f}),e.jsxs(y,{variant:"body2",color:"text.secondary",sx:{ml:2},children:[L.length," fields"]})]}),e.jsx(jr,{children:L.map(Y)})]},f))},[ie,M]=O.useState(!1),N=O.useMemo(()=>t.requiredFields.filter(L=>!a.some(A=>A.targetField===L.name)),[t.requiredFields,a]),ee=f=>{console.log("Received default mappings:",f),f.forEach(L=>{console.log("Adding default mapping for:",L.targetField,L),l(L)}),console.log("Current mappings after adding defaults:",a)};return e.jsxs(ge,{sx:{p:2,height:"100%",display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[N.length>0&&e.jsxs(re,{variant:"outlined",size:"small",startIcon:e.jsx(Yr,{}),onClick:()=>M(!0),color:"primary",children:["Set Default Values (",N.length,")"]}),e.jsx(qe,{control:e.jsx(Xr,{checked:n,onChange:f=>s(f.target.checked),size:"small"}),label:"Show all fields A-Z"})]}),N.length>0&&e.jsxs(de,{severity:"warning",sx:{mb:2},action:e.jsx(re,{color:"inherit",size:"small",onClick:()=>M(!0),children:"Set Defaults"}),children:[N.length," required ",N.length===1?"field":"fields"," not mapped. Please map or set default values to continue."]}),e.jsx(be,{size:"small",placeholder:"Search target fields...",value:r,onChange:f=>o(f.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(at,{fontSize:"small"})})}}),e.jsx(xe,{sx:{mb:2}}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(y,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drop source fields onto target fields or use the drop-down menus below"})}),$&&e.jsx(Sn,{mapping:a.find(f=>f.targetField===$)||null,sampleData:d,onClose:()=>_(null)}),e.jsx(j,{sx:{flexGrow:1,maxHeight:"calc(100% - 220px)",overflow:"auto",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:Z()}),T&&e.jsx(jn,{open:!!T,onClose:c,fieldName:T,mapping:a.find(f=>f.targetField===T),sampleData:d,onSave:D}),e.jsx(Tn,{open:ie,onClose:()=>M(!1),unmappedRequiredFields:N,onAddDefaultMappings:ee})]})},wn=({validationErrors:t,jumpToField:n})=>{const[s,r]=Xe.useState(!1),o=t.filter(u=>u.severity==="error").length,a=t.filter(u=>u.severity==="warning").length,l=()=>{r(!s)};return e.jsxs(ge,{sx:{p:2,position:"sticky",top:16},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer"},onClick:l,children:[e.jsxs(y,{variant:"h6",color:o>0?"error":"warning",children:["Validation Issues ",o>0?`(${o} errors, ${a} warnings)`:`(${a} warnings)`]}),e.jsx(re,{size:"small",endIcon:s?e.jsx(Fr,{}):e.jsx(bt,{}),children:s?"Collapse":"Expand"})]}),e.jsxs(Tr,{in:s,children:[e.jsx(xe,{sx:{my:1}}),e.jsx(j,{sx:{maxHeight:"200px",overflow:"auto"},children:e.jsx(Ue,{dense:!0,children:t.map((u,p)=>e.jsxs(Se,{sx:{bgcolor:u.severity==="error"?"error.lightest":"warning.lightest",mb:.5,borderRadius:1},children:[e.jsx(Pe,{children:u.severity==="error"?e.jsx(Er,{color:"error"}):e.jsx(vr,{color:"warning"})}),e.jsx(Ee,{primary:u.field,secondary:u.message}),e.jsx(re,{size:"small",variant:"outlined",color:u.severity==="error"?"error":"warning",onClick:()=>n(u.field),children:"Go to Field"})]},p))})})]})]})},_n=({sampleData:t,mappings:n,toolConfig:s})=>{const r=O.useMemo(()=>t.length>0?t[0]:null,[t]),o=O.useMemo(()=>{if(!r||!n.length)return null;const p=wr([r],n);return p.length>0?p[0]:null},[r,n]);if(!r||!o)return e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(y,{variant:"body2",color:"text.secondary",children:"No data available for preview. Upload a file and map fields to see a live preview."})});const a=Object.keys(r),l=Object.keys(o);console.log("🔍 LIVE PREVIEW DEBUG: Transformed row keys:",l),console.log("🔍 LIVE PREVIEW DEBUG: Mappings count:",n.length),console.log("🔍 LIVE PREVIEW DEBUG: Mappings:",n.map(p=>`${p.sourceField} → ${p.targetField}`)),console.log("🔍 LIVE PREVIEW DEBUG: Tool config available:",!!s),console.log("🔍 LIVE PREVIEW DEBUG: Field ID → Display Name conversions incoming...");const u=p=>{if(!s)return console.log(`🔍 LIVE PREVIEW: No toolConfig for field ${p}`),p;const m=[...s.requiredFields||[],...s.optionalFields||[]].find(x=>x.id===p);return console.log(`🔍 LIVE PREVIEW: Converting field ID "${p}" → display name "${m?m.name:p}"`),m?m.name:p};return e.jsxs(j,{children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(y,{variant:"subtitle1",children:"Live Preview"}),e.jsx(y,{variant:"body2",color:"text.secondary",children:"Showing all mapped fields • Scroll horizontally to see more →"})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,overflowX:"auto"},children:[e.jsx(Mt,{component:ge,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(mt,{size:"small",stickyHeader:!0,children:[e.jsx(ht,{children:e.jsx(ke,{children:a.map(p=>e.jsx(Fe,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(y,{variant:"caption",fontWeight:"bold",children:p})},p))})}),e.jsx(gt,{children:e.jsx(ke,{children:a.map(p=>e.jsx(Fe,{sx:{minWidth:"120px"},children:e.jsx(y,{variant:"caption",sx:{wordBreak:"break-word"},children:r[p]!==null&&r[p]!==void 0?String(r[p]):"null"})},p))})})]})}),e.jsx(j,{sx:{display:"flex",justifyContent:"center",alignItems:"center",px:2,flexShrink:0},children:e.jsx(tn,{color:"primary"})}),e.jsx(Mt,{component:ge,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(mt,{size:"small",stickyHeader:!0,children:[e.jsx(ht,{children:e.jsx(ke,{children:l.map(p=>e.jsx(Fe,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(y,{variant:"caption",fontWeight:"bold",children:u(p)})},p))})}),e.jsx(gt,{children:e.jsx(ke,{children:l.map(p=>e.jsx(Fe,{sx:{minWidth:"120px"},children:e.jsx(y,{variant:"caption",sx:{wordBreak:"break-word"},children:o[p]!==null&&o[p]!==void 0?String(o[p]):"null"})},p))})})]})})]})]})},Rr=(t,n)=>{O.useEffect(()=>{if(n)try{localStorage.setItem(`tmpl:${t.id}`,JSON.stringify(t)),console.log(`Template "${t.name}" saved to localStorage`)}catch(m){console.error("Failed to save template to localStorage:",m)}},[t,n]);const s=m=>{try{let E=Object.keys(localStorage).filter($=>$.startsWith("tmpl:")).map($=>{const _=localStorage.getItem($);return _?JSON.parse(_):null}).filter(Boolean);return m&&(E=E.filter($=>$.toolId===m)),E.sort(($,_)=>_.lastModified-$.lastModified)}catch(x){return console.error("Failed to load templates from localStorage:",x),[]}},r=m=>{try{return localStorage.removeItem(`tmpl:${m}`),!0}catch(x){return console.error("Failed to delete template:",x),!1}};return{loadTemplates:s,deleteTemplate:r,saveToServer:async()=>(console.log("Saving template to server:",t),new Promise(m=>{setTimeout(()=>{console.log("Template saved to server successfully"),m()},500)})),loadFromServer:async()=>s(),autoSaveTemplate:(m,x)=>{if(!m||m.length===0)return;const T={id:`auto-${x}-${Date.now()}`,name:`Auto-saved ${x} mapping`,description:"Automatically saved field mapping configuration",toolId:x,mappings:m,lastModified:Date.now()};try{localStorage.setItem(`tmpl:${T.id}`,JSON.stringify(T)),console.log("Template auto-saved:",T.name)}catch(E){console.error("Failed to auto-save template:",E)}},getTemplateStats:()=>{var T;const m=s(),x={total:m.length,byTool:{},mostRecent:((T=m[0])==null?void 0:T.lastModified)||0,totalMappings:m.reduce((E,$)=>{var _;return E+(((_=$.mappings)==null?void 0:_.length)||0)},0)};return m.forEach(E=>{const $=E.toolId||"unknown";x.byTool[$]=(x.byTool[$]||0)+1}),x},findSimilarTemplates:(m,x)=>{if(!m||m.length===0)return[];const T=s(x),E=new Set(m.map($=>$.sourceField.toLowerCase()));return T.map($=>{const _=new Set($.mappings.map(W=>W.sourceField.toLowerCase())),w=new Set([...E].filter(W=>_.has(W))).size/Math.max(E.size,_.size);return{template:$,similarity:w}}).filter(({similarity:$})=>$>.3).sort(($,_)=>_.similarity-$.similarity).map(({template:$})=>$)},cleanupAutoSaved:()=>{try{s().filter(T=>T.name.startsWith("Auto-saved")).sort((T,E)=>E.lastModified-T.lastModified).slice(5).forEach(T=>{r(T.id)})}catch(m){console.error("Failed to cleanup auto-saved templates:",m)}}}},Nt={id:"vendor_console_one_standard",name:"Console One CAD - Standard Template",description:"Professional template for Console One CAD systems with NFIRS code support. Includes incident times, unit information, and location data.",cadVendor:"Console One",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"INC_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_TIME",targetField:"dispatch_time"},{sourceField:"ENROUTE_TIME",targetField:"enroute_time"},{sourceField:"ARRIVAL_TIME",targetField:"arrival_time"},{sourceField:"CLEAR_TIME",targetField:"clear_time"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"UNIT_ID",targetField:"responding_unit"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["INC_DATE_TIME","INC_NUM","INC_DATE","DISPATCH_TIME","ENROUTE_TIME","ARRIVAL_TIME","CLEAR_TIME","PROBLEM_TYPE","UNIT_ID","LOCATION_ADDRESS","LATITUDE","LONGITUDE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Console One"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:95,successRate:100,dataTypes:{},sampleValues:{INC_DATE_TIME:["01/15/2024 14:23:45","01/15/2024 15:30:12"],PROBLEM_TYPE:["111","522","311","651"],UNIT_ID:["E01","T01","M01","BC01"]},tags:["console-one","nfirs","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},In={id:"vendor_tyler_standard",name:"Tyler Technologies CAD - Standard Template",description:"Professional template for Tyler Technologies CAD systems. Handles mixed field naming conventions and date formats common in Tyler exports.",cadVendor:"Tyler",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"ALARM_TIME",targetField:"incident_time"},{sourceField:"INCIDENT_NUMBER",targetField:"incident_id"},{sourceField:"INCIDENT_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_DATE",targetField:"dispatch_time"},{sourceField:"ENROUTE_DATE",targetField:"enroute_time"},{sourceField:"ARRIVAL_DATE",targetField:"arrival_time"},{sourceField:"CLEAR_DATE",targetField:"clear_time"},{sourceField:"NATURE_CODE",targetField:"incident_type"},{sourceField:"PRIMARY_UNIT",targetField:"responding_unit"},{sourceField:"ADDRESS",targetField:"address"},{sourceField:"CITY",targetField:"city"},{sourceField:"STATE",targetField:"state"}],sourceFieldPattern:{fieldNames:["ALARM_TIME","INCIDENT_NUMBER","INCIDENT_DATE","DISPATCH_DATE","ENROUTE_DATE","ARRIVAL_DATE","CLEAR_DATE","NATURE_CODE","PRIMARY_UNIT","ADDRESS","CITY","STATE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Tyler"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:92,successRate:98,dataTypes:{},sampleValues:{ALARM_TIME:["2024-01-15 14:23:45","2024-01-15 15:30:12"],NATURE_CODE:["FIREA","EMSC","FIREB","HAZMAT"],PRIMARY_UNIT:["Engine 1","Truck 1","Medic 1","Chief 1"]},tags:["tyler","tyler-technologies","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},$n={id:"vendor_hexagon_standard",name:"Hexagon/Intergraph CAD - Standard Template",description:"Professional template for Hexagon/Intergraph CAD systems. Handles PascalCase field naming and mixed datetime formats with/without seconds.",cadVendor:"Hexagon",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"CallDateTime",targetField:"incident_time"},{sourceField:"IncidentNumber",targetField:"incident_id"},{sourceField:"CallDate",targetField:"incident_date"},{sourceField:"DispatchDateTime",targetField:"dispatch_time"},{sourceField:"EnRouteDateTime",targetField:"enroute_time"},{sourceField:"ArrivalDateTime",targetField:"arrival_time"},{sourceField:"ClearDateTime",targetField:"clear_time"},{sourceField:"IncidentType",targetField:"incident_type"},{sourceField:"UnitId",targetField:"responding_unit"},{sourceField:"LocationAddress",targetField:"address"},{sourceField:"Latitude",targetField:"latitude"},{sourceField:"Longitude",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["CallDateTime","IncidentNumber","CallDate","DispatchDateTime","EnRouteDateTime","ArrivalDateTime","ClearDateTime","IncidentType","UnitId","LocationAddress","Latitude","Longitude"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Hexagon"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:90,successRate:95,dataTypes:{},sampleValues:{CallDateTime:["01/20/2024 14:28","01/20/2024 15:35:22"],IncidentType:["Structure Fire","Medical Emergency","Vehicle Accident"],UnitId:["ENG001","TRK001","MED001","BC001"]},tags:["hexagon","intergraph","pascalcase","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},An={id:"vendor_tritech_standard",name:"TriTech/CentralSquare CAD - Standard Template",description:"Professional template for TriTech/CentralSquare CAD systems. Handles underscore_case naming conventions and EventNum identifiers.",cadVendor:"TriTech",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"Call_Date_Time",targetField:"incident_time"},{sourceField:"EventNum",targetField:"incident_id"},{sourceField:"Call_Date",targetField:"incident_date"},{sourceField:"Dispatch_Time",targetField:"dispatch_time"},{sourceField:"Enroute_Time",targetField:"enroute_time"},{sourceField:"Arrival_Time",targetField:"arrival_time"},{sourceField:"Clear_Time",targetField:"clear_time"},{sourceField:"Call_Type",targetField:"incident_type"},{sourceField:"Unit_ID",targetField:"responding_unit"},{sourceField:"Address",targetField:"address"},{sourceField:"City",targetField:"city"},{sourceField:"State",targetField:"state"}],sourceFieldPattern:{fieldNames:["Call_Date_Time","EventNum","Call_Date","Dispatch_Time","Enroute_Time","Arrival_Time","Clear_Time","Call_Type","Unit_ID","Address","City","State"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"TriTech"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:88,successRate:93,dataTypes:{},sampleValues:{Call_Date_Time:["2024-01-15 14:23:45","2024-01-15 15:30:12"],Call_Type:["FIRE","EMS","RESCUE","HAZMAT"],Unit_ID:["E1","L1","M1","C1"]},tags:["tritech","centralsquare","underscore","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},Rn={...Nt,id:"vendor_console_one_firemap",name:"Console One CAD - Fire Map Pro Template",description:"Geographic analysis template for Console One CAD data. Optimized for incident mapping and spatial analysis.",targetTool:"fire-map-pro",fieldMappings:[{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"UNIT_ID",targetField:"responding_unit"}],metadata:{...Nt.metadata,tags:["console-one","fire-map-pro","geographic","certified"]}},Lt=[Nt,In,$n,An,Rn],Mn=()=>Lt.filter(t=>{var n;return((n=t.metadata.tags)==null?void 0:n.includes("certified"))&&t.isPublic}),yt=()=>{try{const t=JSON.parse(localStorage.getItem("fireems_field_mapping_templates")||"[]");if(t.some(s=>{var r;return(r=s.id)==null?void 0:r.startsWith("vendor_")}))console.log("📚 Vendor templates already exist, skipping seed");else{console.log("🌱 Seeding vendor templates for first-time user...");const s=[...t,...Lt];localStorage.setItem("fireems_field_mapping_templates",JSON.stringify(s)),console.log(`✅ Seeded ${Lt.length} vendor templates successfully`)}}catch(t){console.error("❌ Error seeding vendor templates:",t)}};class Je{static async saveTemplate(n,s,r,o,a,l,u,p){const d={id:this.generateTemplateId(),name:n.trim(),description:s.trim(),departmentName:u,cadVendor:p,targetTool:l,fieldMappings:r,sourceFieldPattern:this.analyzeSourcePattern(o,a),metadata:this.generateMetadata(r,a),createdAt:new Date().toISOString(),useCount:0,isPublic:!1},m=this.getStoredTemplates();return m.push(d),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(m)),console.log(`✅ Template saved: "${n}" (${d.id})`),d}static getTemplates(){try{yt();const n=this.getStoredTemplates();return console.log("📚 TemplateService.getTemplates() found:",n.length,"templates"),console.log("🏅 Vendor templates:",n.filter(s=>{var r;return(r=s.id)==null?void 0:r.startsWith("vendor_")}).length),n}catch(n){return console.error("❌ Error in getTemplates:",n),[]}}static getTemplatesForTool(n){return yt(),this.getStoredTemplates().filter(s=>s.targetTool===n)}static getCertifiedTemplatesForTool(n){return Mn().filter(s=>s.targetTool===n)}static deleteTemplate(n){const s=this.getStoredTemplates(),r=s.findIndex(o=>o.id===n);return r!==-1?(s.splice(r,1),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)),console.log(`🗑️ Template deleted: ${n}`),!0):!1}static suggestTemplates(n,s,r){var l;const o=this.getTemplatesForTool(r),a=[];for(const u of o){const p=this.calculateSimilarity(n,u.sourceFieldPattern.fieldNames);if(p.score>=30){let d=p.score;(l=u.metadata.tags)!=null&&l.includes("certified")&&u.isPublic&&(d+=10,console.log(`🏅 Certified template boost: "${u.name}" ${p.score}% → ${d}%`)),a.push({template:u,similarityScore:d,matchingFields:p.matchingFields,missingFields:p.missingFields,suggestions:this.generateSuggestions(p,u)})}}return a.sort((u,p)=>{var x,T;const d=(x=u.template.metadata.tags)!=null&&x.includes("certified")?1:0,m=(T=p.template.metadata.tags)!=null&&T.includes("certified")?1:0;return d!==m?m-d:p.similarityScore-u.similarityScore}),console.log(`🔍 Found ${a.length} template suggestions for tool: ${r}`),console.log(`🏅 Certified templates: ${a.filter(u=>{var p;return(p=u.template.metadata.tags)==null?void 0:p.includes("certified")}).length}`),a.slice(0,8)}static applyTemplate(n,s){const r=[];this.incrementTemplateUsage(n.id);for(const o of n.fieldMappings){if(s.includes(o.sourceField)){r.push({...o});continue}const a=s.find(u=>u.toLowerCase()===o.sourceField.toLowerCase());if(a){r.push({...o,sourceField:a});continue}const l=this.findFuzzyMatch(o.sourceField,s);l&&r.push({...o,sourceField:l})}return console.log(`🔧 Applied template "${n.name}": ${r.length} mappings applied`),r}static generateCADSignature(n){const s={"Console One":["INC_DATE_TIME","PROBLEM_TYPE","UNIT_ID"],Tyler:["ALARM_TIME","INCIDENT_DATE","DISPATCH_DATE"],Hexagon:["CallDateTime","DispatchDateTime","ArrivalDateTime"],TriTech:["EventNum","Call_Date_Time","Unit_ID"]};let r="Other",o=0;for(const[a,l]of Object.entries(s)){const u=l.filter(p=>n.some(d=>d.toLowerCase().includes(p.toLowerCase()))).length;u>o&&(o=u,r=a)}return r}static getStoredTemplates(){try{const n=localStorage.getItem(this.STORAGE_KEY);return n?JSON.parse(n):[]}catch(n){return console.warn("Failed to load templates from localStorage:",n),[]}}static generateTemplateId(){return`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static analyzeSourcePattern(n,s){return{fieldNames:[...n],fieldCount:n.length,hasHeaderRow:!0,commonPatterns:this.extractCommonPatterns(n),cadVendorSignature:this.generateCADSignature(n)}}static extractCommonPatterns(n){const s=[],r={datetime:["date","time","datetime"],location:["address","location","lat","lng","coord"],incident:["incident","call","event","alarm"],unit:["unit","apparatus","resource"],type:["type","category","classification"]};for(const[o,a]of Object.entries(r))a.some(l=>n.some(u=>u.toLowerCase().includes(l)))&&s.push(o);return s}static generateMetadata(n,s){const o=Math.min(100,n.length/10*100),a={};if(s.length>0)for(const l of n){const u=s.slice(0,3).map(p=>p[l.sourceField]).filter(p=>p!=null&&p!=="").map(p=>String(p));u.length>0&&(a[l.sourceField]=u)}return{version:this.VERSION,compatibility:["1.0.0"],qualityScore:Math.round(o),successRate:100,dataTypes:{},sampleValues:a,tags:[]}}static calculateSimilarity(n,s){const r=new Set(n.map(u=>u.toLowerCase()));new Set(s.map(u=>u.toLowerCase()));const o=[],a=[];for(const u of s)r.has(u.toLowerCase())?o.push(u):a.push(u);const l=o.length/s.length*100;return{score:Math.round(l),matchingFields:o,missingFields:a}}static generateSuggestions(n,s){const r=[];return n.score>=80?r.push("Excellent match! This template should work with minimal adjustments."):n.score>=60?r.push("Good match. May need minor field mapping adjustments."):n.score>=30&&r.push("Partial match. Review field mappings carefully."),n.missingFields.length>0&&r.push(`Missing fields: ${n.missingFields.slice(0,3).join(", ")}`),r}static findFuzzyMatch(n,s){const r=n.toLowerCase();for(const o of s){const a=o.toLowerCase();if(this.stringSimilarity(r,a)>=.7)return o}return null}static stringSimilarity(n,s){const r=n.length>s.length?n:s,o=n.length>s.length?s:n;if(r.length===0)return 1;const a=this.levenshteinDistance(r,o);return(r.length-a)/r.length}static levenshteinDistance(n,s){const r=[];for(let o=0;o<=s.length;o++)r[o]=[o];for(let o=0;o<=n.length;o++)r[0][o]=o;for(let o=1;o<=s.length;o++)for(let a=1;a<=n.length;a++)s.charAt(o-1)===n.charAt(a-1)?r[o][a]=r[o-1][a-1]:r[o][a]=Math.min(r[o-1][a-1]+1,r[o][a-1]+1,r[o-1][a]+1);return r[s.length][n.length]}static incrementTemplateUsage(n){const s=this.getStoredTemplates(),r=s.find(o=>o.id===n);r&&(r.useCount++,r.lastUsed=new Date().toISOString(),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(s)))}}dt(Je,"STORAGE_KEY","fireems_field_mapping_templates"),dt(Je,"VERSION","1.0.0");const On=({currentTemplate:t,setCurrentTemplate:n,setTemplateDirty:s,onTemplateApplied:r,disabled:o=!1,currentMappings:a=[],sourceFields:l=[],sampleData:u=[],targetTool:p="",onApplyFieldMappings:d})=>{const[m,x]=O.useState(null),[T,E]=O.useState(!1),[$,_]=O.useState(!1),[U,w]=O.useState(t.name),[W,k]=O.useState(t.description||""),[S,B]=O.useState([]),[q,G]=O.useState([]),[i,c]=O.useState(""),[h,D]=O.useState(""),{loadTemplates:P,deleteTemplate:Y,saveToServer:Z}=Rr(t,!1);O.useEffect(()=>{const b=P();B(b),l.length>0&&p&&u.length>0&&ie()},[l,p,u]);const ie=()=>{try{const b=Je.suggestTemplates(l,u,p);G(b);const g=Je.generateCADSignature(l);c(g)}catch(b){console.error("Error loading template suggestions:",b)}},M=b=>{x(b.currentTarget)},N=()=>{x(null)},ee=()=>{const b=t.name==="Untitled Mapping"?R():t.name;w(b),k(t.description||""),E(!0),N()},f=()=>{const b=P();B(b),_(!0),N()},L=async()=>{try{if(a.length>0&&l.length>0&&p)await Je.saveTemplate(U,W,a,l,u,p,h||void 0,i||void 0);else{const g={...t,name:U,description:W,lastModified:Date.now()};n(g),Z()}s(!1);const b=P();B(b),E(!1)}catch(b){console.error("Error saving template:",b)}},A=b=>{n(b),s(!1),r&&r(b),_(!1)},V=b=>{try{const g=Je.applyTemplate(b,l);d&&d(g),_(!1)}catch(g){console.error("Error applying template:",g)}},F=b=>{Y(b);const g=P();B(g)},v=b=>{const g={...b,id:`template-${Date.now()}`,name:`${b.name} (Copy)`,lastModified:Date.now()};localStorage.setItem(`tmpl:${g.id}`,JSON.stringify(g));const z=P();B(z)},C=b=>{const g=new Date(b),H=(new Date().getTime()-g.getTime())/(1e3*60*60);return H<24?`${Math.floor(H)} hours ago`:H<24*7?`${Math.floor(H/24)} days ago`:g.toLocaleDateString()},J=b=>{const g=b.name.toLowerCase(),z=(b.description||"").toLowerCase(),H=`${g} ${z}`;return H.includes("tyler")||H.includes("cad")?"CAD System":H.includes("monthly")||H.includes("export")?"Monthly Report":H.includes("response")||H.includes("time")?"Response Time":H.includes("fire")||H.includes("map")?"Fire Map":H.includes("test")||H.includes("sample")?"Test Data":"General"},K=b=>{switch(b){case"CAD System":return"primary";case"Monthly Report":return"success";case"Response Time":return"info";case"Fire Map":return"warning";case"Test Data":return"secondary";default:return"secondary"}},I=S.reduce((b,g)=>{const z=g.toolId||"unknown";return b[z]||(b[z]=[]),b[z].push(g),b},{}),R=()=>{const b=t.toolId||"Tool",g=new Date,z=g.toLocaleDateString("en-US",{month:"long"});if(t.mappings.length>0){const H=t.mappings.map(X=>X.sourceField.toLowerCase());if(H.some(X=>X.includes("tyler")))return`Tyler CAD Export - ${z} ${g.getFullYear()}`;if(H.some(X=>X.includes("dispatch")||X.includes("call")))return`${b} Monthly Export - ${z}`}return`${b} Mapping Template`};return e.jsxs(e.Fragment,{children:[e.jsx(Le,{title:o?"Complete field mapping to access templates":"Save and load field mapping templates",children:e.jsx("span",{children:e.jsx(re,{variant:"outlined",size:"small",onClick:M,startIcon:e.jsx(Qt,{}),disabled:o,children:"Templates"})})}),e.jsxs(Jr,{anchorEl:m,open:!!m,onClose:N,children:[e.jsxs(oe,{onClick:ee,children:[e.jsx(fr,{fontSize:"small",sx:{mr:1}}),"Save Template As..."]}),e.jsxs(oe,{onClick:f,children:[e.jsx(Qt,{fontSize:"small",sx:{mr:1}}),"Load Template"]}),e.jsxs(oe,{onClick:()=>{yt();const b=P();B(b),console.log("🌱 Vendor templates seeded manually")},children:[e.jsx(Ft,{fontSize:"small",sx:{mr:1}}),"Load Vendor Templates"]})]}),e.jsxs(Ze,{open:T,onClose:()=>E(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Qe,{children:"Save Mapping Template"}),e.jsxs(et,{children:[e.jsx(de,{severity:"info",sx:{mb:3},children:e.jsx(y,{variant:"body2",children:"Save this field mapping configuration for future use. Templates help you quickly map data from the same source system."})}),e.jsx(be,{autoFocus:!0,margin:"dense",label:"Template Name",fullWidth:!0,value:U,onChange:b=>w(b.target.value),sx:{mb:2},placeholder:"e.g., Tyler CAD Monthly Export, Fire Map Pro Standard"}),e.jsx(be,{margin:"dense",label:"Description (optional)",fullWidth:!0,multiline:!0,rows:2,value:W,onChange:b=>k(b.target.value),placeholder:"e.g., Standard monthly incident export from Tyler Technologies CAD system"}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(be,{margin:"dense",label:"Department Name (optional)",fullWidth:!0,value:h,onChange:b=>D(b.target.value),placeholder:"e.g., Houston Fire Department",sx:{mt:2}}),e.jsxs(be,{margin:"dense",label:"CAD Vendor",fullWidth:!0,select:!0,value:i,onChange:b=>c(b.target.value),sx:{mt:2},children:[e.jsx(oe,{value:"Console One",children:"Console One"}),e.jsx(oe,{value:"Tyler",children:"Tyler Technologies"}),e.jsx(oe,{value:"Hexagon",children:"Hexagon/Intergraph"}),e.jsx(oe,{value:"TriTech",children:"TriTech/CentralSquare"}),e.jsx(oe,{value:"Other",children:"Other"})]})]}),e.jsx(vt,{variant:"outlined",sx:{mt:2},children:e.jsxs(Tt,{children:[e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Template Preview"}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Tool: ",t.toolId||"Unknown"]}),e.jsxs(y,{variant:"body2",color:"text.secondary",children:["Mappings: ",t.mappings.length," field mappings"]}),t.mappings.length>0&&e.jsx(j,{sx:{mt:1},children:e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Sample mappings: ",t.mappings.slice(0,3).map(b=>`${b.sourceField} → ${b.targetField}`).join(", "),t.mappings.length>3&&` +${t.mappings.length-3} more`]})})]})})]}),e.jsxs(tt,{children:[e.jsx(re,{onClick:()=>E(!1),children:"Cancel"}),e.jsx(re,{onClick:L,variant:"contained",children:"Save Template"})]})]}),e.jsxs(Ze,{open:$,onClose:()=>_(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Qe,{children:"Load Mapping Template"}),e.jsxs(et,{children:[q.length>0&&e.jsxs(j,{sx:{mb:4},children:[e.jsxs(y,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(sn,{sx:{mr:1,fontSize:20}}),"Smart Template Suggestions",e.jsx(le,{label:q.length,size:"small",sx:{ml:1}})]}),e.jsx(de,{severity:"success",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:["Found ",q.length," template",q.length!==1?"s":""," that match your data structure. These are pre-configured for your CAD system type."]})}),e.jsx(Ue,{children:q.map((b,g)=>{var z;return e.jsx(Se,{component:"button",onClick:()=>V(b.template),sx:{py:2,borderRadius:1,mb:1,border:1,borderColor:b.similarityScore>=80?"success.main":"divider","&:hover":{backgroundColor:"action.hover"}},children:e.jsx(Ee,{primary:e.jsxs(nt,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsxs(j,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(y,{variant:"subtitle1",children:b.template.name}),((z=b.template.metadata.tags)==null?void 0:z.includes("certified"))&&e.jsx(le,{icon:e.jsx(mn,{}),label:"Certified",color:"primary",size:"small",variant:"filled"})]}),e.jsx(le,{label:`${b.similarityScore}% match`,color:b.similarityScore>=80?"success":b.similarityScore>=60?"warning":"default",size:"small"}),b.template.cadVendor&&e.jsx(le,{label:b.template.cadVendor,size:"small",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(y,{variant:"body2",sx:{mb:.5},children:b.template.description}),e.jsxs(y,{variant:"caption",color:"text.secondary",children:["Matching fields: ",b.matchingFields.join(", ")]}),b.missingFields.length>0&&e.jsxs(y,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["Missing: ",b.missingFields.slice(0,3).join(", "),b.missingFields.length>3&&` +${b.missingFields.length-3} more`]})]})})},b.template.id)})})]}),S.length===0&&q.length===0?e.jsxs(j,{sx:{textAlign:"center",py:4},children:[e.jsx(Ft,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(y,{variant:"h6",gutterBottom:!0,children:"No saved templates found"}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Templates save your field mapping configurations for reuse with similar data exports."}),e.jsx(de,{severity:"info",children:e.jsxs(y,{variant:"body2",children:[e.jsx("strong",{children:"Pro Tip:"})," After mapping fields for your CAD system, save it as a template. Next month's export will auto-map instantly!"]})})]}):S.length>0&&e.jsxs(j,{children:[q.length>0&&e.jsxs(y,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mt:2},children:[e.jsx(kt,{sx:{mr:1,fontSize:20}}),"Your Saved Templates"]}),e.jsx(de,{severity:"success",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:["Found ",S.length," saved template",S.length!==1?"s":"",". Click any template to apply its field mappings instantly."]})}),Object.entries(I).map(([b,g])=>e.jsxs(j,{sx:{mb:3},children:[e.jsxs(y,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(Ft,{sx:{mr:1,fontSize:20}}),b==="unknown"?"General Templates":`${b} Templates`,e.jsx(le,{label:g.length,size:"small",sx:{ml:1}})]}),e.jsx(Ue,{children:g.map(z=>{var H;return e.jsx(Xe.Fragment,{children:e.jsxs(Se,{component:"button",onClick:()=>A(z),sx:{py:2,borderRadius:1,mb:1,"&:hover":{backgroundColor:"action.hover"}},children:[e.jsx(Ee,{primary:e.jsxs(nt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(y,{variant:"subtitle1",children:z.name}),e.jsx(le,{label:J(z),size:"small",color:K(J(z)),variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[z.description&&e.jsx(y,{variant:"body2",sx:{mb:.5},children:z.description}),e.jsxs(nt,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(y,{variant:"caption",color:"text.secondary",sx:{display:"flex",alignItems:"center"},children:[e.jsx(kt,{sx:{fontSize:12,mr:.5}}),C(z.lastModified)]}),e.jsxs(y,{variant:"caption",color:"text.secondary",children:[((H=z.mappings)==null?void 0:H.length)||0," field mappings"]})]}),z.mappings&&z.mappings.length>0&&e.jsxs(y,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:["Fields: ",z.mappings.slice(0,2).map(X=>X.sourceField).join(", "),z.mappings.length>2&&` +${z.mappings.length-2} more`]})]})}),e.jsxs(Rt,{children:[e.jsx(Le,{title:"Duplicate template",children:e.jsx(Ce,{edge:"end",onClick:X=>{X.stopPropagation(),v(z)},sx:{mr:1},children:e.jsx(ln,{fontSize:"small"})})}),e.jsx(Le,{title:"Delete template",children:e.jsx(Ce,{edge:"end",onClick:X=>{X.stopPropagation(),F(z.id)},children:e.jsx(it,{fontSize:"small"})})})]})]})},z.id)})})]},b))]})]}),e.jsx(tt,{children:e.jsx(re,{onClick:()=>_(!1),children:"Cancel"})})]})]})},Pn=(t,n)=>{if(!n)return t;const s=[...n.requiredFields,...n.optionalFields];if(s.find(a=>a.id===t))return console.log(`✅ Field ID already correct: "${t}"`),t;const o=s.find(a=>a.name===t);return o?(console.log(`🔄 Converting display name "${t}" to field ID "${o.id}"`),o.id):(console.warn(`⚠️ Unknown target field: "${t}" - keeping as-is`),t)},sr=(t,n)=>{if(!n||!t)return t;console.log("🔄 Starting field mapping migration...");const s=t.map(r=>{const o=r.targetField,a=Pn(r.targetField,n);return o!==a&&console.log(`📋 Migrating: "${r.sourceField}" → "${o}" becomes "${r.sourceField}" → "${a}"`),{...r,targetField:a}});return console.log("✅ Field mapping migration complete"),s},nr=(t,n)=>{if(!n||!t)return{isConsistent:!0,issues:[]};const s=[...n.requiredFields,...n.optionalFields],r=[];return t.forEach(o=>{const a=s.some(u=>u.id===o.targetField),l=s.some(u=>u.name===o.targetField);l&&!a?r.push(`Mapping "${o.sourceField}" → "${o.targetField}" uses display name instead of field ID`):!a&&!l&&r.push(`Mapping "${o.sourceField}" → "${o.targetField}" targets unknown field`)}),{isConsistent:r.length===0,issues:r}},kn=t=>{if(!t||typeof t!="string")return{city:null,state:null};const n=t.trim(),s=new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]),r=[/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s+\d{5}(?:-\d{4})?\s*$/,/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s*$/,/^.+,\s*([A-Za-z][A-Za-z\s]+?),?\s+([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/,/^.+\s{2,}([A-Za-z][A-Za-z\s]+?)\s{2,}([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/];for(const l of r){const u=n.match(l);if(u){let p=u[1].trim();const d=u[2].trim();if(s.has(d)&&p.length>=2&&p.length<=50){const m=/\b(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i;if(p=p.replace(m,"").trim(),p.length>=2)return console.log(`🏠 ENHANCED ADDRESS PARSING: "${t}" → City: "${p}", State: "${d}"`),{city:p,state:d}}}}const o=new RegExp("\\s+([A-Z]{2})(?:\\s+\\d{5}(?:-\\d{4})?)?\\s*$"),a=n.match(o);if(a){const l=a[1];if(s.has(l)){const d=n.substring(0,n.lastIndexOf(l)).trim().split(/\s+/).slice(-3).filter(m=>!/^\d+$/.test(m)&&!/^(north|south|east|west|n|s|e|w)$/i.test(m)&&!/^(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i.test(m));if(d.length>0){const m=d.join(" ");if(m.length>=2&&m.length<=50)return console.log(`🏠 FALLBACK ADDRESS PARSING: "${t}" → City: "${m}", State: "${l}"`),{city:m,state:l}}}}return console.log(`🏠 ADDRESS PARSING FAILED: Could not extract city/state from "${t}"`),{city:null,state:null}},Nn=t=>({incident_id:["incident_number","incidentnumber","incident_num","inc_num","incnum","case_number","call_number","event_id","event_number","report_number","incidentnum","eventnum"],incident_time:["call_received_time","callreceivedtime","received_time","call_time","incident_datetime","receive_time","time_received","incident_date","inc_date_time","alarm_time","calldatetime","call_datetime"],arrival_time:["arrive_time","arrivetime","on_scene_time","onscenetime","scene_time","arrival_datetime","on_scene_datetime","arrivaldatetime","onscenetime"],dispatch_time:["dispatched_time","dispatchedtime","dispatch_datetime","notification_time","notified_time","dispatchdatetime"],enroute_time:["en_route_time","enroutetime","turnout_time","turnouttime","responding_time","travel_start_time","enroutedatetime"],clear_time:["cleared_time","clearedtime","clear_datetime","back_in_service_time","available_time","service_time","unit_clear_time","cleardatetime"],latitude:["lat","y_coord","y_coordinate","gps_lat","coord_y","ycoord"],longitude:["lng","lon","long","x_coord","x_coordinate","gps_lng","gps_lon","coord_x","xcoord"],address:["incident_address","location","street_address","full_address","addr","locationaddress"],responding_unit:["unit","primary_unit","first_unit","apparatus","resource","unit_id","responding_units","primaryunit"],incident_type:["inc_type_code","inctypecode","inc_type_desc","inctypedesc","call_type","emergency_type","event_type","nature_code","problem_type","incidenttype","incidentcategory","calltype"],zip_code:["zip","zipcode","postal_code","postcode","locationzip"],city:["incident_city","location_city","locationcity"],state:["incident_state","location_state","locationstate"],priority:["incident_priority","call_priority","priority_level"],disposition:["incident_disposition","final_disposition","outcome","incident_outcome"],district:["response_district","fire_district","service_district","districts"],cross_streets:["cross_street","nearest_intersection","intersection"]})[t]||[],Ln=()=>{const t=ct(),{sourceColumns:n,sampleData:s,selectedTool:r,mappings:o,processingStatus:a}=Be(v=>v.formatter),[l,u]=O.useState({id:`template-${Date.now()}`,name:"Untitled Mapping",toolId:(r==null?void 0:r.id)||"",mappings:o||[],lastModified:Date.now()}),[p,d]=O.useState(!1),[m,x]=O.useState([]),[T,E]=O.useState(!1),[$,_]=O.useState([]),[U,w]=O.useState({message:"",severity:"info",open:!1}),[W,k]=O.useState(""),[S,B]=O.useState(""),[q,G]=O.useState(!1),i=r||void 0,{saveToServer:c,autoSaveTemplate:h,findSimilarTemplates:D,getTemplateStats:P,cleanupAutoSaved:Y}=Rr(l,p),Z=P();O.useEffect(()=>{Object.keys(localStorage).filter(C=>C.startsWith("tmpl:")).forEach(C=>{var K;const J=localStorage.getItem(C);if(J)try{((K=JSON.parse(J).mappings)==null?void 0:K.some(b=>b.targetField&&b.targetField.includes(" ")))&&(console.log(`🔧 CLEARING OUTDATED TEMPLATE: ${C} (uses display names instead of field IDs)`),localStorage.removeItem(C))}catch{console.log(`🔧 CLEARING CORRUPTED TEMPLATE: ${C}`),localStorage.removeItem(C)}})},[]),O.useEffect(()=>{console.log("Redux mappings changed:",o),u(v=>{const C={...v,mappings:[...o],lastModified:Date.now()};return console.log("Updated template with Redux mappings:",C),C}),o.length>0&&d(!0)},[o]),O.useEffect(()=>{if(!i||!o||o.length===0)return;console.log("🔄 Checking for legacy mappings that need migration...");const v=nr(o,i);if(v.isConsistent)console.log("✅ All mappings already use field IDs - no migration needed");else{console.log("🔄 Legacy mappings detected - auto-migrating to field IDs"),console.log("Issues found:",v.issues);const C=sr(o,i);JSON.stringify(o)!==JSON.stringify(C)&&(console.log("✅ Auto-migration complete - updating mappings"),t(Me(C)))}},[i,o==null?void 0:o.length]),O.useEffect(()=>{N()},[o,i]);const ie=v=>{console.log("handleMappingChange called with:",v);try{const C=[...o],J=C.findIndex(K=>K.targetField===v.targetField);J>=0?(console.log(`Updating existing mapping for ${v.targetField}`),C[J]=v):(console.log(`Adding new mapping for ${v.targetField}`),C.push(v)),t(Me(C)),console.log("Mapping updated successfully:",v),w({message:`Mapped ${v.sourceField} to ${v.targetField}`,severity:"success",open:!0})}catch(C){console.error("Error updating mapping:",C)}},M=v=>{console.log("handleRemoveMapping called for:",v);try{const C=o.filter(J=>J.targetField!==v);t(Me(C)),console.log(`Mapping for ${v} removed successfully`)}catch(C){console.error("Error removing mapping:",C)}},N=()=>{if(!i)return;console.log("🔍 FIELD MAPPING AUDIT - Current State Analysis:"),console.log("=========================================="),console.log("📋 Tool Configuration:"),console.log("  Required Fields:",i.requiredFields.map(I=>({id:I.id,name:I.name}))),console.log("  Optional Fields:",i.optionalFields.map(I=>({id:I.id,name:I.name}))),console.log("🗺️ Current Mappings:"),console.log("  Mappings Array:",o.map(I=>({source:I.sourceField,target:I.targetField})));const v=[...i.requiredFields,...i.optionalFields],C=o.map(I=>{const R=v.find(g=>g.id===I.targetField),b=v.find(g=>g.name===I.targetField);return{source:I.sourceField,target:I.targetField,isFieldId:!!R,isDisplayName:!!b,shouldBeFieldId:b?b.id:I.targetField}});console.log("🔍 Mapping Analysis:"),C.forEach(I=>{console.log(`  "${I.source}" → "${I.target}"`),console.log(`    - Is Field ID: ${I.isFieldId}`),console.log(`    - Is Display Name: ${I.isDisplayName}`),I.isDisplayName&&!I.isFieldId&&console.log(`    - ⚠️ PROBLEM: Should be "${I.shouldBeFieldId}" instead`)});const J=o.find(I=>I.targetField==="Call Received Date/Time");J&&(console.log("🚨 SPECIFIC ISSUE DETECTED:"),console.log(`  Mapping: "${J.sourceField}" → "${J.targetField}"`),console.log(`  Should be: "${J.sourceField}" → "incident_time"`)),console.log("==========================================");const K=[];i.requiredFields.forEach(I=>{const R=o.find(g=>g.targetField===I.id),b=o.find(g=>g.targetField===I.name);if(console.log(`Checking required field ${I.id} (display: ${I.name})`),console.log(`  - Mapping by ID: ${R?`"${R.sourceField}" → ${R.targetField}`:"none"}`),console.log(`  - Mapping by Name: ${b?`"${b.sourceField}" → ${b.targetField}`:"none"}`),R)console.log(`  ✅ Correct mapping found for ${I.id}`);else if(b){console.log(`  🔄 Legacy mapping detected for ${I.id} - migrating from display name to field ID`);const g=o.findIndex(z=>z.targetField===I.name);if(g>=0){const z=[...o];z[g]={...z[g],targetField:I.id},console.log(`  📋 Auto-migrated: "${I.name}" → "${I.id}"`),t(Me(z))}}else console.log(`  ❌ No mapping found for required field ${I.id}`),K.push({field:I.id,message:`Required field ${I.name} is not mapped`,severity:"error"})}),_(K)},ee=async()=>{if(!(!n||!i)){E(!0);try{console.log("🔧 AUTO-MAPPING - Starting with systematic fix approach");const C=[...sr(l.mappings,i)],J=g=>C.some(z=>z.targetField===g),K=g=>g.toLowerCase().replace(/[\s_-]/g,""),I=[...i.requiredFields,...i.optionalFields];console.log("🔧 AUTO-MAPPING - Available target fields:",I.map(g=>({id:g.id,name:g.name}))),console.log("🔧 AUTO-MAPPING - Source columns:",n),console.log("🔧 AUTO-MAPPING - Tool config details:",{toolId:i.id,requiredCount:i.requiredFields.length,optionalCount:i.optionalFields.length,totalFields:I.length,optionalFieldsList:i.optionalFields.map(g=>g.id)}),console.log(`
🕐 === SMART DATETIME DETECTION: Phase 1 Implementation ===`);const R=Gs(n,s||[]);console.log("🕐 Detection result:",{type:R.pattern.type,confidence:R.pattern.confidence,description:R.pattern.description}),R.pattern.confidence>.5?(console.log("✅ High confidence datetime pattern detected - applying smart mappings"),R.suggestedMappings.forEach(g=>{if(!I.some(X=>X.id===g.targetField)){console.log(`⚠️ Skipping suggestion for ${g.targetField} - not in tool config`);return}if(J(g.targetField)){console.log(`🔄 Target ${g.targetField} already mapped - skipping automatic datetime mapping`);return}const H=g.sourceFields[0];g.transformationType==="combine"?(console.log(`🕐 DATETIME COMBINE: Adding mapping "${H}" → "${g.targetField}" (will combine with ${g.sourceFields.join(" + ")})`),C.push({sourceField:H,targetField:g.targetField,transformations:[{type:"datetime_combine",params:{sourceFields:g.sourceFields,description:g.description}}]})):g.transformationType==="extract"?(console.log(`🕐 DATETIME EXTRACT: Adding mapping "${H}" → "${g.targetField}" (will extract date/time component)`),C.push({sourceField:H,targetField:g.targetField,transformations:[{type:"datetime_extract",params:{extractType:g.targetField.includes("date")?"date":"time",description:g.description}}]})):(console.log(`🕐 DATETIME DIRECT: Adding direct mapping "${H}" → "${g.targetField}"`),C.push({sourceField:H,targetField:g.targetField}))}),console.log("🕐 Smart datetime mappings applied:",C.filter(g=>{var z;return(z=g.transformations)==null?void 0:z.some(H=>H.type.startsWith("datetime_"))}).length)):console.log("⚠️ Low confidence datetime pattern - proceeding with standard auto-mapping"),console.log(`🕐 === DATETIME DETECTION COMPLETE - Proceeding with standard field mapping ===
`),I.forEach(g=>{console.log(`
🎯 === DEBUGGING TARGET FIELD: ${g.id} (display: "${g.name}") ===`),J(g.id)&&console.log(`🔄 Target field ${g.id} already mapped - checking for dual mapping opportunity`),console.log("🔍 Available source columns for matching:",n),console.log(`🔍 Attempting to map target field: ${g.id} (display: ${g.name})`),console.log(`🔍 STEP 1: Trying exact match with display name "${g.name}"`);const z=n.find(ae=>ae.toLowerCase()===g.name.toLowerCase());if(console.log("🔍 Exact match result:",z?`FOUND: "${z}"`:"NOT FOUND"),z){C.find(se=>se.sourceField===z&&se.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${z}" → ${g.id}`):(console.log(`✅ EXACT MATCH SUCCESS: "${z}" → ${g.id}`),C.push({sourceField:z,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (exact match) ===
`);return}console.log("🔍 STEP 2: Trying normalized match with display name");const H=K(g.name);console.log(`🔍 Normalized target name: "${g.name}" → "${H}"`);const X=n.find(ae=>{const se=K(ae);return console.log(`🔍   Testing source "${ae}" → "${se}" against "${H}"`),se===H});if(console.log("🔍 Normalized match result:",X?`FOUND: "${X}"`:"NOT FOUND"),X){C.find(se=>se.sourceField===X&&se.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${X}" → ${g.id}`):(console.log(`✅ NORMALIZED MATCH SUCCESS: "${X}" → ${g.id}`),C.push({sourceField:X,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (normalized match) ===
`);return}console.log("🔍 STEP 3: Trying normalized match with field ID");const ne=K(g.id);console.log(`🔍 Normalized field ID: "${g.id}" → "${ne}"`);const te=n.find(ae=>{const se=K(ae);return console.log(`🔍   Testing source "${ae}" → "${se}" against "${ne}"`),se===ne});if(console.log("🔍 Field ID match result:",te?`FOUND: "${te}"`:"NOT FOUND"),te){C.find(se=>se.sourceField===te&&se.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${te}" → ${g.id}`):(console.log(`✅ FIELD ID MATCH SUCCESS: "${te}" → ${g.id}`),C.push({sourceField:te,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (field ID match) ===
`);return}console.log("🔍 STEP 4: Trying field variation matching");const je=Nn(g.id);console.log(`🔍 Field variations for ${g.id}:`,je);let Q;for(const ae of je)if(console.log(`🔍   Testing variation: "${ae}"`),Q=n.find(se=>{const ye=K(se),he=K(ae);return console.log(`🔍     Source "${se}" → "${ye}" vs variation "${he}"`),ye===he}),Q){console.log(`🔍   VARIATION MATCH FOUND: "${Q}" via variation "${ae}"`),C.find(ye=>ye.sourceField===Q&&ye.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${Q}" → ${g.id}`):(console.log(`✅ FIELD VARIATION SUCCESS: "${Q}" → ${g.id} (via variation "${ae}")`),C.push({sourceField:Q,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (variation match) ===
`);return}console.log(`🔍 No variation matches found for ${g.id}`),console.log(`❌ NO MATCH FOUND for target field: ${g.id}`),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (no match) ===
`);const Te=n.map(K).findIndex(ae=>ae.includes(H)||H.includes(ae));if(Te>=0){console.log(`✅ Partial match found: "${n[Te]}" → ${g.id}`),C.push({sourceField:n[Te],targetField:g.id});return}if((g.id==="city"||g.id==="state")&&!J(g.id)){const ae=n.find(se=>K(se).includes("address")||K(se).includes("location")||K(se).includes("addr"));if(ae&&s&&s.length>0){const se=s[0][ae];if(typeof se=="string"&&se.trim()){const ye=kn(se);if(g.id==="city"&&ye.city){console.log(`🏠 Smart address parsing: Extracting city "${ye.city}" from "${ae}"`),C.push({sourceField:ae,targetField:g.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Za-z\\s]+)\\s+[A-Z]{2}\\s*$",description:"Extract city from full address"}}]});return}if(g.id==="state"&&ye.state){console.log(`🏠 Smart address parsing: Extracting state "${ye.state}" from "${ae}"`),C.push({sourceField:ae,targetField:g.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Z]{2})\\s*$",description:"Extract state from full address"}}]});return}}}}console.log(`❌ No match found for target field: ${g.id}`)}),console.log("🔧 AUTO-MAPPING - Final mappings:",C.map(g=>({source:g.sourceField,target:g.targetField})));const b=nr(C,i);if(b.isConsistent||console.warn("⚠️ AUTO-MAPPING - Consistency issues detected:",b.issues),t(Me(C)),C.length>=3&&(r!=null&&r.id)&&(console.log("🔧 AUTO-SAVING TEMPLATE: Significant mappings detected"),h(C,r.id),Y()),r!=null&&r.id){const g=D(C,r.id);x(g.slice(0,3)),console.log("🔧 TEMPLATE SUGGESTIONS:",g.length,"similar templates found")}}finally{E(!1)}}},f=async()=>{try{await c(),d(!1)}catch(v){console.error("Failed to save template:",v)}},L=()=>{t(Ne(0))},A=()=>{try{t(Re("transforming")),console.log("🔧 TRANSFORMATION DEBUG: Using Redux mappings directly for transformation"),console.log("Redux mappings:",o),console.log("currentTemplate.mappings:",l.mappings),console.log("Sample data:",s),console.log("🔍 PRE-TRANSFORMATION DEBUG:"),console.log("  Sample data keys:",s.length>0?Object.keys(s[0]):[]),console.log("  Sample data first row:",s[0]),console.log("  Mappings to apply:",o),console.log("  Mappings breakdown:"),o.forEach((C,J)=>{var I;const K=(I=s[0])==null?void 0:I[C.sourceField];console.log(`    ${J+1}. "${C.sourceField}" → "${C.targetField}" | Sample: "${K}"`)});const v=wr(s,o);console.log("✅ Transformed data with latest mappings:",v),console.log("🔍 POST-TRANSFORMATION DEBUG:"),v.length>0&&(console.log("  Transformed data keys:",Object.keys(v[0])),console.log("  Transformed data first row:",v[0]),console.log("  Specific field checks:"),console.log(`    incident_time: "${v[0].incident_time}"`),console.log(`    incident_date: "${v[0].incident_date}"`),console.log(`    incident_id: "${v[0].incident_id}"`)),t(Vr(v)),t(Re("mapping")),t(Ne(2))}catch(v){console.error("Error transforming data:",v),t(Re("error")),w({message:`Error transforming data: ${v instanceof Error?v.message:"Unknown error"}`,severity:"error",open:!0})}},V=O.useMemo(()=>{if(console.log("Checking if can proceed with validationErrors:",$),console.log("Current mappings:",o),i){const v=i.requiredFields.filter(C=>!o.some(J=>J.targetField===C.id));return console.log("Unmapped required fields:",v),v.length===0}return $.every(v=>v.severity!=="error")},[$,o,i]),F=v=>{var I;v.preventDefault();const C=v.dataTransfer.getData("text/plain");if(!C){w({message:"Drag and drop error: No source field data found",severity:"error",open:!0});return}const K=(I=v.target.closest("[data-target-field]"))==null?void 0:I.getAttribute("data-target-field");if(!K){w({message:"Drag and drop error: No target field found. Try dropping directly on a target field.",severity:"warning",open:!0});return}ie({sourceField:C,targetField:K}),w({message:`Mapped ${C} to ${K}`,severity:"success",open:!0})};return n.length?i?a==="uploading"?e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(ze,{}),e.jsx(y,{sx:{mt:2},children:"Processing file data..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(y,{variant:"h5",children:["Map Fields for ",i.name]}),e.jsxs(nt,{direction:"row",spacing:1,children:[e.jsx(re,{variant:"outlined",size:"small",startIcon:e.jsx(fr,{}),onClick:f,disabled:!p,children:"Save Template"}),e.jsx(On,{currentTemplate:l,setCurrentTemplate:v=>{u(v),v.mappings&&v.mappings.length>0&&(t(Me(v.mappings)),w({message:`Applied template "${v.name}" with ${v.mappings.length} field mappings`,severity:"success",open:!0}))},setTemplateDirty:d,disabled:!r||n.length===0,currentMappings:o,sourceFields:n,sampleData:s,targetTool:(r==null?void 0:r.id)||"",onApplyFieldMappings:v=>{t(Me(v)),w({message:`Applied template with ${v.length} field mappings`,severity:"success",open:!0})}})]})]}),m.length>0&&e.jsxs(de,{severity:"info",sx:{mb:2},children:[e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"💡 Smart Template Suggestions"}),e.jsxs(y,{variant:"body2",sx:{mb:1},children:["Found ",m.length," template",m.length!==1?"s":""," with similar field patterns:"]}),e.jsx(j,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:m.map(v=>e.jsxs(re,{variant:"outlined",size:"small",onClick:()=>{u(v),t(Me(v.mappings)),d(!1),x([]),w({message:`Applied suggested template "${v.name}"`,severity:"success",open:!0})},sx:{textTransform:"none"},children:[v.name,e.jsxs(y,{component:"span",variant:"caption",sx:{ml:1,opacity:.7},children:["(",v.mappings.length," mappings)"]})]},v.id))})]}),Z.total>0&&e.jsx(de,{severity:"success",sx:{mb:2},children:e.jsxs(y,{variant:"body2",children:["📁 You have ",Z.total," saved template",Z.total!==1?"s":"","(",Z.totalMappings," total field mappings).",Z.byTool[(r==null?void 0:r.id)||""]&&e.jsxs("strong",{children:[Z.byTool[(r==null?void 0:r.id)||""]," template",Z.byTool[(r==null?void 0:r.id)||""]!==1?"s":""," for ",r==null?void 0:r.name]})]})}),e.jsxs(j,{sx:{display:"flex",gap:2,height:"700px",minHeight:"700px",border:"1px solid #eaeaea",borderRadius:"4px",padding:"4px"},children:[e.jsxs(j,{sx:{width:"35%",height:"100%",display:"flex",flexDirection:"column",position:"relative",borderRight:"1px solid #eaeaea",paddingRight:"8px"},children:[e.jsx(y,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Source Fields Panel ↕️ (Scrollable)"}),e.jsx(bn,{sourceColumns:n,filter:W,setFilter:k,mappings:o,sampleData:s,onAddParsedFields:(v,C)=>{if(console.log("🤖 PARENT: Received parsed fields for column:",v,C),s&&s.length>0&&C.length>0){const J=s.map((K,I)=>{const R={...K};return C.forEach(b=>{if(b.data[I]!==null){const g=b.id.split("_").slice(1).join("_"),z=`${v}_parsed_${g}`;R[z]=b.data[I],console.log(`🤖 PARENT: Injecting parsed data: ${z} = "${b.data[I]}"`)}}),R});console.log("🤖 PARENT: Updating Redux sampleData with parsed fields"),t(gr(J)),w({message:`Added ${C.length} parsed fields for ${v}`,severity:"success",open:!0})}}})]}),e.jsxs(j,{sx:{width:"65%",height:"100%",display:"flex",flexDirection:"column",gap:2,overflow:"hidden",position:"relative"},onDragOver:v=>{v.target===v.currentTarget&&(v.preventDefault(),console.log("Parent container dragOver"))},onDrop:v=>{v.target===v.currentTarget&&(v.preventDefault(),F(v),console.log("Parent container drop"))},children:[e.jsx(y,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Target Fields Panel ↕️ (Scrollable)"}),e.jsx(Dn,{toolConfig:i,showAllFields:q,setShowAllFields:G,filter:S,setFilter:B,mappings:o,onMappingChange:ie,onRemoveMapping:M,validationErrors:$,sampleData:s,sourceColumns:n}),$.length>0&&e.jsx(j,{sx:{flexShrink:0,marginTop:"auto",borderTop:"1px solid #eaeaea",paddingTop:"8px"},children:e.jsx(wn,{validationErrors:$,jumpToField:v=>{const C=document.getElementById(`target-field-${v}`);C&&(C.scrollIntoView({behavior:"smooth",block:"center"}),C.classList.add("highlight-field"),setTimeout(()=>{C.classList.remove("highlight-field")},2e3))}})})]})]}),e.jsx(ge,{sx:{p:2,mt:2},children:e.jsx(_n,{sampleData:s,mappings:o,toolConfig:i})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(re,{variant:"outlined",startIcon:e.jsx(ot,{}),onClick:L,children:"Back"}),e.jsxs(j,{children:[e.jsx(re,{variant:"outlined",onClick:ee,disabled:T||!n.length,sx:{mr:1},children:T?e.jsxs(e.Fragment,{children:[e.jsx(ze,{size:20,sx:{mr:1}}),"Auto-mapping..."]}):"Auto-Map Fields"}),e.jsx(re,{variant:"contained",endIcon:e.jsx(Vt,{}),onClick:A,disabled:!V,children:"Continue"})]})]}),e.jsx(Cr,{open:U.open,autoHideDuration:6e3,onClose:()=>w({...U,open:!1}),children:e.jsx(de,{onClose:()=>w({...U,open:!1}),severity:U.severity,children:U.message})})]}):e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(de,{severity:"error",children:"No tool selected. Please select a tool first."}),e.jsx(re,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(ot,{}),onClick:L,children:"Go Back to Upload"})]}):e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(de,{severity:"error",children:"No source columns available. Please upload a file first."}),e.jsx(re,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(ot,{}),onClick:L,children:"Go Back to Upload"})]})},zn=({data:t,validationErrors:n,highlightedCell:s})=>{const[r,o]=O.useState(0),[a,l]=O.useState(10),[u,p]=O.useState(""),[d,m]=O.useState("");O.useEffect(()=>{if(s){const S=Math.floor(s.rowIndex/a);S!==r&&o(S)}},[s,a,r]);const x=t.length>0?Object.keys(t[0]):[],T={};n.forEach(S=>{S.rowIndex!==void 0&&(T[S.rowIndex]||(T[S.rowIndex]={}),T[S.rowIndex][S.field]||(T[S.rowIndex][S.field]=[]),T[S.rowIndex][S.field].push(S))});const E=(S,B)=>{o(B)},$=S=>{l(parseInt(S.target.value,10)),o(0)},_=S=>{p(S.target.value),o(0)},U=S=>{m(S.target.value),o(0)},w=()=>{m(""),o(0)},W=t.filter(S=>{if(!d)return!0;if(u){const B=S[u];return B!==void 0&&String(B).toLowerCase().includes(d.toLowerCase())}return Object.values(S).some(B=>B!==void 0&&String(B).toLowerCase().includes(d.toLowerCase()))}),k=W.slice(r*a,r*a+a);return t.length===0?e.jsx(j,{children:e.jsx(y,{variant:"h6",gutterBottom:!0,children:"No data available for preview"})}):e.jsxs(j,{children:[e.jsx(Ur,{styles:{"@keyframes pulse":{"0%":{opacity:.7},"100%":{opacity:1}}}}),e.jsxs(j,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(be,{label:"Search",value:d,onChange:U,sx:{flexGrow:1},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(at,{})}),endAdornment:d&&e.jsx(Ae,{position:"end",children:e.jsx(Ce,{onClick:w,edge:"end",size:"small",children:e.jsx(Ot,{})})})}}),e.jsxs(Ve,{sx:{minWidth:200},children:[e.jsx(He,{id:"filter-field-label",children:"Filter Field"}),e.jsxs(We,{labelId:"filter-field-label",id:"filter-field",value:u,label:"Filter Field",onChange:_,children:[e.jsx(oe,{value:"",children:"All Fields"}),x.map(S=>e.jsx(oe,{value:S,children:S},S))]})]})]}),e.jsxs(ge,{sx:{width:"100%",mb:2},children:[e.jsx(Mt,{sx:{maxHeight:500},children:e.jsxs(mt,{stickyHeader:!0,"aria-label":"data preview table",children:[e.jsx(ht,{children:e.jsxs(ke,{children:[e.jsx(Fe,{children:"#"}),x.map(S=>e.jsx(Fe,{children:S},S))]})}),e.jsx(gt,{children:k.map((S,B)=>{const q=r*a+B,G=T[q];return e.jsxs(ke,{hover:!0,sx:{"&:last-child td, &:last-child th":{border:0},backgroundColor:G?"#fff8f8":"inherit"},children:[e.jsx(Fe,{children:q+1}),x.map(i=>{const c=(G==null?void 0:G[i])||[],h=c.length>0,D=s&&s.rowIndex===q&&s.field===i;return e.jsxs(Fe,{sx:{backgroundColor:D?"#fff3e0":h?"#ffebee":"inherit",position:"relative",border:D?"2px solid #ff9800":"inherit",transition:"all 0.3s ease"},children:[S[i]!==void 0?String(S[i]):"",h&&e.jsx(j,{sx:{position:"absolute",top:0,right:0},children:e.jsx(le,{color:"error",size:"small",label:c.length,sx:{height:16,fontSize:"0.6rem"}})}),D&&e.jsx(j,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid #ff9800",borderRadius:"4px",pointerEvents:"none",animation:"pulse 1s ease-in-out infinite alternate"}})]},i)})]},B)})})]})}),e.jsx(rs,{rowsPerPageOptions:[5,10,25,50,100],component:"div",count:W.length,rowsPerPage:a,page:r,onPageChange:E,onRowsPerPageChange:$})]})]})};class Vn{constructor(){dt(this,"defaultFields",{})}registerField(n,s){console.log(`Registering default value for ${n}:`,s),this.defaultFields[n]=s}hasDefaultValue(n){return this.defaultFields[n]!==void 0}getDefaultValue(n){return this.defaultFields[n]}registerMappings(n){this.defaultFields={},n.forEach(s=>{if(s.sourceField==="__default__"&&s.transformations){const r=s.transformations.find(o=>o.type==="convert"&&o.params&&o.params.defaultValue!==void 0);r&&r.params.defaultValue!==void 0&&this.registerField(s.targetField,r.params.defaultValue)}}),console.log("Registered default values:",this.defaultFields)}clear(){this.defaultFields={}}}const or=new Vn,Un=(t,n)=>{const s=[];return t.forEach((r,o)=>{n.forEach(a=>{let l=r[a.name];const u=or.hasDefaultValue(a.name);if((l==null||l==="")&&u&&(l=or.getDefaultValue(a.name),console.log(`Using default value for validation of ${a.name}:`,l)),a.name==="Incident ID"){a.isRequired&&!u&&(l==null||l==="")&&s.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(a.name.includes("Time")&&typeof l=="string"){a.isRequired&&!u&&(l==null||l==="")&&s.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(a.isRequired&&!u&&(l==null||l==="")){s.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(l==null||l==="")return;const p=Bn(l,a.dataType,a.name,o);if(p){s.push(p);return}a.validationRules&&a.validationRules.forEach(d=>{const m=Hn(l,d,a.name,o);m&&s.push(m)})})}),console.log("Validation completed with errors:",s),s},Bn=(t,n,s,r)=>{switch(n){case"string":if(typeof t!="string")return{rowIndex:r,field:s,message:`${s} must be a string`,type:"custom"};break;case"number":if(typeof t!="number"&&(typeof t!="string"||isNaN(Number(t))))return{rowIndex:r,field:s,message:`${s} must be a number`,type:"custom"};break;case"date":if(!(typeof t=="string"||t instanceof Date))return{rowIndex:r,field:s,message:`${s} must be a date`,type:"custom"};const o=new Date(t);if(isNaN(o.getTime()))return{rowIndex:r,field:s,message:`${s} contains an invalid date format`,type:"custom"};break;case"boolean":if(typeof t!="boolean"&&t!=="true"&&t!=="false"&&t!=="0"&&t!=="1")return{rowIndex:r,field:s,message:`${s} must be a boolean value`,type:"custom"};break;case"location":if(typeof t=="string"){if(!/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(t))return{rowIndex:r,field:s,message:`${s} must be a valid location format (latitude,longitude)`,type:"custom"}}else if(!t.lat||!t.lng)return{rowIndex:r,field:s,message:`${s} must be a valid location object or string`,type:"custom"};break}return null},Hn=(t,n,s,r)=>{switch(n.type){case"required":break;case"min":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)<n.params.value)return{rowIndex:r,field:s,message:`${s} must be at least ${n.params.value}`,type:"min"}}else if(typeof t=="string"&&t.length<n.params.value)return{rowIndex:r,field:s,message:`${s} must be at least ${n.params.value} characters`,type:"min"};break;case"max":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)>n.params.value)return{rowIndex:r,field:s,message:`${s} must be at most ${n.params.value}`,type:"max"}}else if(typeof t=="string"&&t.length>n.params.value)return{rowIndex:r,field:s,message:`${s} must be at most ${n.params.value} characters`,type:"max"};break;case"pattern":if(typeof t=="string"&&!new RegExp(n.params.regex).test(t))return{rowIndex:r,field:s,message:n.params.message||`${s} does not match the required pattern`,type:"pattern"};break;case"oneOf":const o=n.params.values;if(!o.includes(t))return{rowIndex:r,field:s,message:`${s} must be one of: ${o.join(", ")}`,type:"oneOf"};break;case"custom":if(n.params.validateFn&&typeof n.params.validateFn=="function"&&!n.params.validateFn(t))return{rowIndex:r,field:s,message:n.params.message||`${s} is invalid`,type:"custom"};break}return null},Wn=t=>{const n={total:t.length,byType:{},byField:{}};return t.forEach(s=>{n.byType[s.type]||(n.byType[s.type]=0),n.byType[s.type]++,n.byField[s.field]||(n.byField[s.field]=0),n.byField[s.field]++}),n},It=t=>{const{children:n,value:s,index:r,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==r,id:`validation-tabpanel-${r}`,"aria-labelledby":`validation-tab-${r}`,...o,children:s===r&&e.jsx(j,{sx:{p:2},children:n})})},Yn=({errors:t,onJumpToError:n})=>{const[s,r]=O.useState(0),[o,a]=O.useState(""),l=Wn(t),u=(x,T)=>{r(T)},p=t.filter(x=>x.field.toLowerCase().includes(o.toLowerCase())||x.message.toLowerCase().includes(o.toLowerCase())),d={};p.forEach(x=>{d[x.field]||(d[x.field]=[]),d[x.field].push(x)});const m=x=>{let T="default";switch(x){case"required":T="error";break;case"pattern":case"min":case"max":T="warning";break;case"oneOf":case"custom":T="info";break}return e.jsx(le,{size:"small",label:x,color:T})};return e.jsxs(ge,{sx:{p:0,mb:3},children:[e.jsx(j,{sx:{p:2,bgcolor:t.length>0?"#ffebee":"#e8f5e9",borderRadius:"4px 4px 0 0"},children:e.jsxs(y,{variant:"h6",component:"h3",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(xt,{}),"Validation Results",e.jsx(le,{label:`${t.length} ${t.length===1?"error":"errors"}`,color:t.length>0?"error":"success",sx:{ml:2}})]})}),e.jsx(xe,{}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(jt,{value:s,onChange:u,"aria-label":"validation tabs",children:[e.jsx(Ie,{label:"Summary",id:"validation-tab-0","aria-controls":"validation-tabpanel-0"}),e.jsx(Ie,{label:"By Field",id:"validation-tab-1","aria-controls":"validation-tabpanel-1"}),e.jsx(Ie,{label:"All Errors",id:"validation-tab-2","aria-controls":"validation-tabpanel-2"})]})}),e.jsx(It,{value:s,index:0,children:t.length===0?e.jsx(de,{severity:"success",children:"No validation errors found. Your data is ready for export!"}):e.jsxs(e.Fragment,{children:[e.jsxs(de,{severity:"warning",children:["Found ",t.length," validation ",t.length===1?"error":"errors"," that need to be addressed before export."]}),e.jsxs(j,{sx:{mt:2},children:[e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Error Distribution by Field"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:Object.entries(l.byField).map(([x,T])=>e.jsx(le,{label:`${x}: ${T}`,color:"error",variant:"outlined",onClick:()=>r(1)},x))}),e.jsx(y,{variant:"subtitle1",gutterBottom:!0,children:"Error Types"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:Object.entries(l.byType).map(([x,T])=>e.jsx(le,{label:`${x}: ${T}`,color:"primary",variant:"outlined"},x))})]})]})}),e.jsxs(It,{value:s,index:1,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:o,onChange:x=>a(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(at,{})}),endAdornment:o&&e.jsx(Ae,{position:"end",children:e.jsx(Ce,{onClick:()=>a(""),edge:"end",size:"small",children:e.jsx(Ot,{})})})}}),Object.keys(d).length===0?e.jsx(de,{severity:"info",children:"No errors match your search criteria."}):Object.entries(d).map(([x,T])=>e.jsxs(yr,{defaultExpanded:Object.keys(d).length===1,children:[e.jsx(br,{expandIcon:e.jsx(bt,{}),children:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[e.jsx(y,{children:x}),e.jsx(le,{size:"small",label:T.length,color:"error",sx:{ml:"auto"}})]})}),e.jsx(jr,{children:e.jsx(Ue,{dense:!0,disablePadding:!0,children:T.map((E,$)=>e.jsxs(Xe.Fragment,{children:[$>0&&e.jsx(xe,{component:"li"}),e.jsx(Se,{secondaryAction:E.rowIndex!==void 0&&n&&e.jsx(re,{size:"small",variant:"outlined",onClick:()=>E.rowIndex!==void 0&&n(E.rowIndex,E.field),children:"Jump to Row"}),children:e.jsx(Ee,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[E.message,m(E.type)]}),secondary:E.rowIndex!==void 0?`Row ${E.rowIndex+1}`:"Global error"})})]},$))})})]},x))]}),e.jsxs(It,{value:s,index:2,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:o,onChange:x=>a(x.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(at,{})}),endAdornment:o&&e.jsx(Ae,{position:"end",children:e.jsx(Ce,{onClick:()=>a(""),edge:"end",size:"small",children:e.jsx(Ot,{})})})}}),e.jsx(Ue,{dense:!0,children:p.length===0?e.jsx(de,{severity:"info",children:"No errors match your search criteria."}):p.map((x,T)=>e.jsxs(Xe.Fragment,{children:[T>0&&e.jsx(xe,{component:"li"}),e.jsx(Se,{secondaryAction:x.rowIndex!==void 0&&n&&e.jsx(re,{size:"small",variant:"outlined",onClick:()=>x.rowIndex!==void 0&&n(x.rowIndex,x.field),children:"Jump to Row"}),children:e.jsx(Ee,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(y,{component:"span",sx:{fontWeight:500},children:[x.field,":"]}),x.message,m(x.type)]}),secondary:x.rowIndex!==void 0?`Row ${x.rowIndex+1}`:"Global error"})})]},T))})]})]})},Gn=t=>{switch(t){case"string":return"Default Value";case"number":return"0";case"date":return new Date().toISOString().split("T")[0];case"boolean":return"false";case"location":return"0.0,0.0";default:return""}},qn=({errors:t,targetFields:n,mappings:s,onAddDefaultValue:r,onJumpToMapping:o})=>{const a=zt(),[l,u]=O.useState(!1),[p,d]=O.useState(null),[m,x]=O.useState(""),T=O.useMemo(()=>{const w={};return t.forEach(W=>{w[W.field]||(w[W.field]={errors:[],count:0}),w[W.field].errors.push(W),w[W.field].count++}),w},[t]),E=O.useMemo(()=>Object.entries(T).sort((w,W)=>W[1].count-w[1].count).map(([w,W])=>{const k=n.find(i=>i.name===w);if(!k)return null;const S=s.some(i=>i.targetField===w),B=s.some(i=>i.targetField===w&&i.sourceField==="__default__"),q=W.errors.some(i=>i.type==="required");let G="unknown";return q&&!S?G="map_field":q&&!B?G="add_default":!q&&S&&(G="fix_transformation"),{fieldName:w,fieldDef:k,errorCount:W.count,errors:W.errors,hasMapping:S,hasDefaultMapping:B,actionType:G}}).filter(Boolean),[T,n,s]),$=O.useMemo(()=>E.filter(w=>(w==null?void 0:w.actionType)==="add_default").length,[E]),_=w=>{d(w),x(Gn(w.dataType)),u(!0)},U=()=>{if(!p)return;const w={sourceField:"__default__",targetField:p.name,transformations:[{type:"convert",params:{defaultValue:m,targetType:p.dataType}}]};r(w),u(!1)};return t.length===0?e.jsx(de,{severity:"success",sx:{my:2},children:"No validation errors detected. Your data is ready for export!"}):e.jsxs(ge,{sx:{p:0,my:2,borderRadius:1,border:`1px solid ${a.palette.divider}`,overflow:"hidden"},elevation:2,children:[e.jsxs(j,{sx:{p:2,bgcolor:a.palette.mode==="dark"?me(a.palette.error.dark,.2):me(a.palette.error.light,.1),borderBottom:`1px solid ${a.palette.divider}`},children:[e.jsxs(y,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(xt,{color:"error"}),"Validation Solutions",e.jsx(le,{label:`${t.length} ${t.length===1?"issue":"issues"}`,color:"error",size:"small",sx:{ml:1}})]}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:$>0?`${$} ${$===1?"issue":"issues"} can be fixed with default values.`:"Review the suggested actions to resolve validation issues."})]}),e.jsxs(Ue,{sx:{py:0},children:[$>0&&e.jsxs(Se,{sx:{bgcolor:me(a.palette.success.light,.1),borderBottom:`1px solid ${a.palette.divider}`,"&:hover":{bgcolor:me(a.palette.success.light,.2)}},children:[e.jsx(Pe,{children:e.jsx(lt,{color:"success"})}),e.jsx(Ee,{primary:"Fix Required Fields with Default Values",secondary:`Add default values to ${$} unmapped required ${$===1?"field":"fields"}`}),e.jsx(Rt,{children:e.jsx(re,{variant:"outlined",color:"success",size:"small",onClick:()=>{const w=E.find(W=>(W==null?void 0:W.actionType)==="add_default");w!=null&&w.fieldDef&&_(w.fieldDef)},children:"Set Default Values"})})]}),E.map((w,W)=>{var q;if(!w)return null;let k=e.jsx(xt,{color:"error"}),S="error",B="";switch(w.actionType){case"map_field":k=e.jsx(cn,{color:"info"}),S="info",B="Field requires mapping to source data";break;case"add_default":k=e.jsx(Zt,{color:"success"}),S="success",B="Field requires a value, add a default";break;case"fix_transformation":k=e.jsx(Sr,{color:"warning"}),S="warning",B="Field has validation issues with current mapping";break}return e.jsxs(Xe.Fragment,{children:[W>0&&e.jsx(xe,{}),e.jsxs(Se,{sx:{py:1.5,"&:hover":{bgcolor:me(a.palette.primary.light,.05)}},children:[e.jsx(Pe,{children:k}),e.jsx(Ee,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(y,{variant:"subtitle2",children:w.fieldName}),e.jsx(le,{size:"small",label:`${w.errorCount} ${w.errorCount===1?"error":"errors"}`,color:"error",variant:"outlined"}),w.fieldDef&&e.jsx(le,{size:"small",label:w.fieldDef.dataType,color:"default",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(y,{variant:"body2",color:"text.secondary",children:B}),e.jsxs(y,{variant:"caption",color:"error",sx:{display:"block",mt:.5},children:[(q=w.errors[0])==null?void 0:q.message,w.errors.length>1&&` (+ ${w.errors.length-1} more)`]})]})}),e.jsxs(Rt,{children:[w.actionType==="add_default"&&w.fieldDef&&e.jsx(re,{variant:"outlined",color:S,size:"small",startIcon:e.jsx(Zt,{}),onClick:()=>_(w.fieldDef),children:"Add Default"}),(w.actionType==="map_field"||w.actionType==="fix_transformation")&&e.jsx(re,{variant:"outlined",color:S,size:"small",startIcon:e.jsx(Gr,{}),onClick:()=>o(w.fieldName),children:w.actionType==="map_field"?"Map Field":"Fix Mapping"})]})]})]},w.fieldName)})]}),e.jsxs(Ze,{open:l,onClose:()=>u(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Qe,{children:["Set Default Value for ",p==null?void 0:p.name]}),e.jsx(et,{children:e.jsxs(j,{sx:{mt:1},children:[e.jsx(y,{variant:"body2",gutterBottom:!0,children:p==null?void 0:p.description}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(y,{variant:"caption",children:"Data Type:"}),e.jsx(le,{size:"small",label:p==null?void 0:p.dataType,color:"primary",variant:"outlined"})]}),(p==null?void 0:p.dataType)==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:m,onChange:w=>x(w.target.value),label:"Default Value",variant:"outlined",margin:"normal",children:[e.jsx(oe,{value:"true",children:"True"}),e.jsx(oe,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:m,onChange:w=>x(w.target.value),label:"Default Value",variant:"outlined",margin:"normal",type:(p==null?void 0:p.dataType)==="number"?"number":"text",helperText:`This value will be used for all records where ${p==null?void 0:p.name} is not mapped or empty`})]})}),e.jsxs(tt,{children:[e.jsx(re,{onClick:()=>u(!1),children:"Cancel"}),e.jsx(re,{onClick:U,variant:"contained",color:"primary",startIcon:e.jsx(lt,{}),children:"Apply Default Value"})]})]})]})},ar=t=>{const{children:n,value:s,index:r,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==r,id:`preview-tabpanel-${r}`,"aria-labelledby":`preview-tab-${r}`,...o,children:s===r&&e.jsx(j,{sx:{p:2},children:n})})},Jn=()=>{const t=ct(),{sourceFile:n,transformedData:s,validationErrors:r,selectedTool:o,mappings:a}=Be(S=>S.formatter),[l,u]=O.useState(0),[p,d]=O.useState(!1),[m,x]=O.useState(null),T=O.useRef(null),E=(S,B)=>{u(B)},$=()=>{t(Ne(1))},_=()=>{t(Ne(3))},U=()=>{if(!(!s||!o)){d(!0);try{const S=[...o.requiredFields,...o.optionalFields],B=Be(c=>c.formatter.mappings),q={};B&&B.forEach(c=>{if(c.sourceField==="__default__"&&c.transformations){const h=c.transformations.find(D=>D.type==="convert"&&D.params&&D.params.defaultValue!==void 0);h&&(q[c.targetField]=!0,console.log(`Field ${c.targetField} has default value: ${h.params.defaultValue}`))}});const G=s.map(c=>{const h={...c};return Object.keys(q).forEach(D=>{typeof window<"u"&&window.defaultValueRegistry&&window.defaultValueRegistry.register(D,!0)}),h}),i=Un(G,S);t(Br(i)),i.length===0?t(Re("complete")):t(Re("error"))}catch(S){console.error("Validation error:",S),t(Re("error"))}finally{d(!1)}}},w=(S,B)=>{u(0),x({rowIndex:S,field:B}),setTimeout(()=>{T.current&&T.current.scrollIntoView({behavior:"smooth"})},100),setTimeout(()=>{x(null)},3e3)},W=S=>{console.log("Adding default value mapping:",S),t(Hr(S)),setTimeout(()=>{U()},100)},k=S=>{t(Ne(1))};return O.useEffect(()=>{s&&s.length>0&&U()},[s]),!s||s.length===0?e.jsxs(ge,{sx:{p:3,textAlign:"center"},children:[e.jsxs(de,{severity:"warning",sx:{mb:2},children:[e.jsx(fs,{children:"No Data Available"}),"There is no transformed data to preview. Please go back to the field mapping step."]}),e.jsx(re,{variant:"contained",startIcon:e.jsx(er,{}),onClick:$,children:"Back to Field Mapping"})]}):e.jsxs(j,{children:[e.jsx(y,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Preview & Validate Data"}),e.jsx(ge,{sx:{p:2,mb:3},children:e.jsxs(ue,{container:!0,spacing:2,children:[e.jsx(ue,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(y,{variant:"body1",children:[(n==null?void 0:n.name)||"No file"," (",n==null?void 0:n.type,")"]})]})}),e.jsx(ue,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(y,{variant:"body1",children:[s.length," records processed"]})]})}),e.jsx(ue,{size:12,children:e.jsxs(j,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:p?e.jsxs(e.Fragment,{children:[e.jsx(ze,{size:20}),e.jsx(y,{children:"Validating data..."})]}):r.length===0?e.jsxs(e.Fragment,{children:[e.jsx(Ir,{color:"success"}),e.jsx(y,{color:"success.main",children:"Data validation passed! Ready for export."})]}):e.jsxs(e.Fragment,{children:[e.jsx(hn,{color:"error"}),e.jsxs(y,{color:"error",children:[r.length," validation ",r.length===1?"error":"errors"," found"]})]})})]})})]})}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(jt,{value:l,onChange:E,"aria-label":"preview and validation tabs",children:[e.jsx(Ie,{label:"Data Preview",id:"preview-tab-0","aria-controls":"preview-tabpanel-0"}),e.jsx(Ie,{label:`Validation & Solutions ${r.length>0?`(${r.length})`:""}`,id:"preview-tab-1","aria-controls":"preview-tabpanel-1",sx:{color:r.length>0?"error.main":"inherit"}})]})}),e.jsx(ar,{value:l,index:0,children:e.jsx(j,{ref:T,children:e.jsx(zn,{data:s,validationErrors:r,highlightedCell:m})})}),e.jsxs(ar,{value:l,index:1,children:[r.length>0&&o&&e.jsx(qn,{errors:r,targetFields:[...o.requiredFields,...o.optionalFields],mappings:a,onAddDefaultValue:W,onJumpToMapping:k}),e.jsx(Yn,{errors:r,onJumpToError:w})]}),e.jsx(xe,{sx:{my:3}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(re,{variant:"outlined",startIcon:e.jsx(er,{}),onClick:$,children:"Back to Field Mapping"}),e.jsx(re,{variant:"contained",endIcon:e.jsx(Vt,{}),onClick:_,disabled:r.length>0,children:"Continue to Export"})]})]})},Kn=({selectedFormat:t,onFormatChange:n})=>{const s=r=>{n(r.target.value)};return e.jsx(vt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(Tt,{children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Select Export Format"}),e.jsx(Ve,{component:"fieldset",children:e.jsxs(ds,{"aria-label":"export-format",name:"export-format",value:t,onChange:s,children:[e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="csv"?"primary.main":"divider",borderRadius:1,bgcolor:t==="csv"?"action.hover":"transparent"},children:[e.jsx(qe,{value:"csv",control:e.jsx(pt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",flexWrap:"wrap",gap:1},children:[e.jsx(cs,{color:"primary"}),e.jsx(y,{variant:"body1",children:"CSV"}),e.jsx(le,{size:"small",label:"Most Compatible",color:"success"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Comma-separated values format, widely supported by spreadsheet applications like Excel and Google Sheets."})]}),e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="json"?"primary.main":"divider",borderRadius:1,bgcolor:t==="json"?"action.hover":"transparent"},children:[e.jsx(qe,{value:"json",control:e.jsx(pt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(an,{color:"info"}),e.jsx(y,{variant:"body1",children:"JSON"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"JavaScript Object Notation, ideal for programmatic use or importing into other applications."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="excel"?"primary.main":"divider",borderRadius:1,bgcolor:t==="excel"?"action.hover":"transparent"},children:[e.jsx(qe,{value:"excel",control:e.jsx(pt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ft,{color:"success"}),e.jsx(y,{variant:"body1",children:"Excel"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Export directly to native Excel format (.xlsx) with proper formatting and column sizing."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="pdf"?"primary.main":"divider",borderRadius:1,bgcolor:t==="pdf"?"action.hover":"transparent"},children:[e.jsx(qe,{value:"pdf",control:e.jsx(pt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(xr,{color:"error"}),e.jsx(y,{variant:"body1",children:"PDF"}),e.jsx(le,{size:"small",label:"Professional",color:"secondary"})]})}),e.jsx(y,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Create a professional PDF document with formatted data table, ideal for reports and presentations."})]})]})})]})})},$t=[{id:"fire-map-pro",name:"Fire Map Pro",description:"Professional mapping and visualization for incident locations and analysis",icon:e.jsx(qt,{fontSize:"large",sx:{color:"#dc2626"}}),requiredFields:["incidentId","latitude","longitude"],optionalFields:["incidentType","incidentDate","incidentTime","address","city","state","priority","respondingUnit","responseCategory"]},{id:"response-time-analyzer",name:"Response Time Analyzer",description:"Analyze incident response times and visualize performance metrics",icon:e.jsx(es,{fontSize:"large",sx:{color:"#2196f3"}}),requiredFields:["incidentId","incidentDate"],optionalFields:["dispatchTime","enRouteTime","arrivalTime","latitude","longitude"]},{id:"call-density-heatmap",name:"Call Density Heatmap",description:"Visualize incident density across geographic areas",icon:e.jsx(qt,{fontSize:"large",sx:{color:"#ff9800"}}),requiredFields:["incidentId","latitude","longitude"]},{id:"incident-dashboard",name:"Incident Dashboard",description:"Interactive dashboard for incident analysis and reporting",icon:e.jsx(ss,{fontSize:"large",sx:{color:"#4caf50"}}),requiredFields:["incidentId","incidentType","incidentDate"]},{id:"trend-analyzer",name:"Trend Analyzer",description:"Identify incident trends and patterns over time",icon:e.jsx(ps,{fontSize:"large",sx:{color:"#9c27b0"}}),requiredFields:["incidentId","incidentDate","incidentType"]}],Xn=({selectedTool:t,onToolSelect:n,transformedData:s,onSendToTool:r,isSending:o,preTransformedData:a})=>{console.log("📡📡📡 SEND TO TOOL PANEL RENDER - FRESH BUILD JUN 13 2025 16:48 - selectedTool:",t),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - onSendToTool function:",!!r),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - transformedData length:",s==null?void 0:s.length),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData exists:",!!a),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData length:",a==null?void 0:a.length),a&&a.length>0&&console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData sample:",a[0]);const l=d=>{n(d.target.value)},p=t?(d=>{const m=$t.find(_=>_.id===d);if(!m)return{compatible:!1,missingFields:[]};if(d==="fire-map-pro")if(console.log("🔍 FIRE MAP PRO COMPATIBILITY CHECK - ENHANCED FOR ADDRESS PARSING"),console.log("preTransformedData exists:",!!a),console.log("preTransformedData length:",a==null?void 0:a.length),console.log("transformedData sample:",s[0]),a&&a.length>0){const _=Object.keys(s[0]);console.log("🔍 Available transformed data fields:",_);const U=m.optionalFields?m.optionalFields.filter(W=>{const k=_.includes(W);return console.log(`🔍 Fire Map Pro optional field ${W}: ${k?"AVAILABLE":"NOT AVAILABLE"}`),k}):[],w=m.optionalFields?m.optionalFields.filter(W=>!_.includes(W)):[];return console.log("✅ Fire Map Pro data is compatible - features exist"),console.log("📊 Available optional fields:",U),console.log("📋 Missing optional fields:",w),{compatible:!0,missingFields:[],hasOptionalFields:U,missingOptionalFields:w}}else return console.log("❌ Fire Map Pro data not compatible - no features"),{compatible:!1,missingFields:["incidentId","latitude","longitude"],hasOptionalFields:[],missingOptionalFields:m.optionalFields||[]};if(d==="response-time-analyzer"){console.log("🔍 RESPONSE TIME ANALYZER COMPATIBILITY CHECK - FLEXIBLE FIELD MATCHING");const _=Object.keys(s[0]);console.log("🔍 Available data fields:",_),console.log("🔍 Required fields (camelCase):",m.requiredFields);const U=m.requiredFields.filter(k=>{if(_.includes(k))return console.log(`✅ Found exact match for ${k}`),!1;const S=k.replace(/[A-Z]/g,B=>`_${B.toLowerCase()}`);return _.includes(S)?(console.log(`✅ Found snake_case match for ${k} -> ${S}`),!1):(console.log(`❌ No match found for ${k} (tried ${k} and ${S})`),!0)});console.log("🔍 CHECKING OPTIONAL FIELDS:"),console.log("🔍 Tool optional fields:",m.optionalFields);const w=m.optionalFields?m.optionalFields.filter(k=>{let S=k.replace(/[A-Z]/g,G=>`_${G.toLowerCase()}`);k==="enRouteTime"&&(S="enroute_time");const B=_.includes(k),q=_.includes(S);return console.log(`🔍 Optional field ${k}: camelCase=${B}, snake_case(${S})=${q}`),B||q}):[],W=m.optionalFields?m.optionalFields.filter(k=>{let S=k.replace(/[A-Z]/g,B=>`_${B.toLowerCase()}`);return k==="enRouteTime"&&(S="enroute_time"),!_.includes(k)&&!_.includes(S)}):[];return console.log("🔍 OPTIONAL FIELDS RESULT:"),console.log("✅ Has optional fields:",w),console.log("❌ Missing optional fields:",W),{compatible:U.length===0,missingFields:U,hasOptionalFields:w,missingOptionalFields:W}}const x=Object.keys(s[0]);console.log(`🔍 ${d.toUpperCase()} COMPATIBILITY CHECK`),console.log("Available fields:",x),console.log("Required fields:",m.requiredFields);const T=m.requiredFields.filter(_=>!x.includes(_)),E=m.optionalFields?m.optionalFields.filter(_=>x.includes(_)):[],$=m.optionalFields?m.optionalFields.filter(_=>!x.includes(_)):[];return{compatible:T.length===0,missingFields:T,hasOptionalFields:E,missingOptionalFields:$}})(t):{compatible:!1,missingFields:[]};return e.jsxs(j,{children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Send to FireEMS Tool"}),e.jsx(de,{severity:"info",sx:{mb:3},children:"Send your formatted data directly to another FireEMS tool for analysis and visualization."}),e.jsxs(Ve,{fullWidth:!0,sx:{mb:3},children:[e.jsx(He,{id:"tool-select-label",children:"Select Tool"}),e.jsxs(We,{labelId:"tool-select-label",id:"tool-select",value:t||"",label:"Select Tool",onChange:l,children:[e.jsx(oe,{value:"",children:e.jsx("em",{children:"Select a tool..."})}),$t.map(d=>e.jsx(oe,{value:d.id,children:d.name},d.id))]})]}),t&&e.jsx(ue,{container:!0,spacing:3,children:$t.filter(d=>d.id===t).map(d=>e.jsx(ue,{size:12,children:e.jsxs(vt,{variant:"outlined",children:[e.jsxs(Tt,{children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[d.icon,e.jsxs(j,{sx:{ml:2},children:[e.jsx(y,{variant:"h6",children:d.name}),e.jsx(y,{variant:"body2",color:"text.secondary",children:d.description})]})]}),e.jsx(xe,{sx:{mb:2}}),e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Required Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.requiredFields.map((m,x)=>e.jsx(y,{variant:"body2",sx:{backgroundColor:p.missingFields.includes(m)?"error.light":"success.light",color:p.missingFields.includes(m)?"error.contrastText":"success.contrastText",borderRadius:1,px:1,py:.5},children:m},x))}),d.optionalFields&&e.jsxs(e.Fragment,{children:[e.jsx(y,{variant:"subtitle2",gutterBottom:!0,children:"Optional Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.optionalFields.map((m,x)=>{var T,E;return e.jsx(y,{variant:"body2",sx:{backgroundColor:(T=p.hasOptionalFields)!=null&&T.includes(m)?"info.light":"action.disabledBackground",color:(E=p.hasOptionalFields)!=null&&E.includes(m)?"info.contrastText":"text.secondary",borderRadius:1,px:1,py:.5},children:m},x)})})]}),!p.compatible&&e.jsxs(de,{severity:"warning",icon:e.jsx(un,{}),sx:{mb:2},children:[e.jsx(y,{variant:"body2",gutterBottom:!0,children:"Your data is missing required fields for this tool:"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:p.missingFields.map((m,x)=>e.jsx("li",{children:m},x))})]}),p.compatible&&e.jsxs(de,{severity:"success",sx:{mb:2},children:[e.jsx(y,{variant:"body2",gutterBottom:!0,children:"Your data is compatible with this tool. All required fields are present."}),d.optionalFields&&p.hasOptionalFields&&p.hasOptionalFields.length>0&&e.jsxs(y,{variant:"body2",children:[p.hasOptionalFields.length," of ",d.optionalFields.length," optional fields are available for enhanced analysis."]})]})]}),e.jsx(us,{children:e.jsx(re,{type:"button",variant:"contained",color:"primary",fullWidth:!0,disabled:!p.compatible||o,startIcon:o?e.jsx(ze,{size:20}):e.jsx(Ar,{}),onClick:m=>{m.preventDefault(),m.stopPropagation(),console.log("🚀🚀🚀 SEND TO TOOL BUTTON CLICKED - FRESH BUILD JUN 13 2025 16:49 - tool.id:",d.id),console.log("🚀🚀🚀 SEND TO TOOL BUTTON - onSendToTool function:",r),r()},children:o?"Sending...":`Send to ${d.name}`})})]})},d.id))})]})},Zn=({dataCount:t,fields:n,format:s})=>{const r=()=>{let a=15;s==="json"?a=25:s==="excel"?a=30:s==="pdf"&&(a=40);const l=t*n.length*a;let u=0;s==="excel"?u=5120:s==="pdf"&&(u=15360);const p=l+u;return p<1048576?`${Math.round(p/1024)} KB`:`${(p/1048576).toFixed(2)} MB`},o=()=>{switch(s){case"csv":return e.jsx(Pt,{color:"primary"});case"json":return e.jsx($r,{color:"info"});case"excel":return e.jsx(ft,{color:"success"});case"pdf":return e.jsx(xr,{color:"error"});default:return e.jsx(Pt,{})}};return e.jsx(vt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(Tt,{children:[e.jsx(y,{variant:"h6",gutterBottom:!0,children:"Export Summary"}),e.jsxs(Ue,{disablePadding:!0,children:[e.jsxs(Se,{children:[e.jsx(Pe,{sx:{minWidth:"40px"},children:o()}),e.jsx(Ee,{primary:"Format",secondary:s.toUpperCase()})]}),e.jsx(xe,{component:"li"}),e.jsxs(Se,{children:[e.jsx(Pe,{sx:{minWidth:"40px"},children:e.jsx(Ke,{color:"success"})}),e.jsx(Ee,{primary:"Records",secondary:`${t} records will be exported`})]}),e.jsx(xe,{component:"li"}),e.jsxs(Se,{children:[e.jsx(Pe,{sx:{minWidth:"40px"},children:e.jsx(Ke,{color:"success"})}),e.jsx(Ee,{primary:"Fields",secondary:`${n.length} fields per record`})]}),e.jsx(xe,{component:"li"}),e.jsxs(Se,{children:[e.jsx(Pe,{sx:{minWidth:"40px"},children:e.jsx(Ke,{color:"success"})}),e.jsx(Ee,{primary:"Estimated Size",secondary:r()})]})]}),e.jsx(y,{variant:"subtitle2",sx:{mt:2},children:"Fields included:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mt:1},children:n.map((a,l)=>e.jsx(le,{label:a,size:"small"},l))})]})})};console.log("🚨🚨🚨 EXPORT CONTAINER LOADED - NEW VERSION WITH UPFRONT TRANSFORMATION AT",new Date().toISOString());const Qn=t=>!t||t.length===0?t:JSON.parse(JSON.stringify(t)).map(s=>{const r={...s};return["Incident Date"].forEach(l=>{if(r[l]&&typeof r[l]=="string")try{const u=new Date(r[l]);if(isNaN(u.getTime()))r[l].includes(" ")&&(r[l]=r[l].split(" ")[0]);else{const p=(u.getMonth()+1).toString().padStart(2,"0"),d=u.getDate().toString().padStart(2,"0"),m=u.getFullYear();r[l]=`${p}/${d}/${m}`}}catch{r[l].includes(" ")&&(r[l]=r[l].split(" ")[0])}}),["Dispatch Time","En Route Time","Arrival Time","Incident Time"].forEach(l=>{if(r[l]&&typeof r[l]=="string")try{const u=new Date(r[l]);if(isNaN(u.getTime())){if(r[l].includes(" ")){const p=r[l].split(" ");p.length>1&&(r[l]=p[1])}}else{const p=u.getHours().toString().padStart(2,"0"),d=u.getMinutes().toString().padStart(2,"0"),m=u.getSeconds().toString().padStart(2,"0");r[l]=`${p}:${d}:${m}`}}catch{if(r[l].includes(" ")){const p=r[l].split(" ");p.length>1&&(r[l]=p[1])}}}),r}),ir=t=>{const{children:n,value:s,index:r,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:s!==r,id:`export-tabpanel-${r}`,"aria-labelledby":`export-tab-${r}`,...o,children:s===r&&e.jsx(j,{sx:{p:2},children:n})})},eo=()=>{const t=ct(),{sourceFile:n,transformedData:s,validationErrors:r}=Be(M=>M.formatter),[o,a]=O.useState(0),[l,u]=O.useState("csv"),[p,d]=O.useState(null),[m,x]=O.useState(null),[T,E]=O.useState(!1),[$,_]=O.useState({success:!1,message:"",open:!1}),[U,w]=O.useState([]),[W,k]=O.useState(!1);O.useEffect(()=>{try{const M=localStorage.getItem("fireEmsExportHistory");M&&w(JSON.parse(M))}catch(M){console.error("Error loading export history:",M)}},[]),O.useEffect(()=>{try{localStorage.setItem("fireEmsExportHistory",JSON.stringify(U))}catch(M){console.error("Error saving export history:",M)}},[U]);const S=(M,N)=>{a(N)},B=M=>{u(M)},q=M=>{var N,ee;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleToolChange CALLED AT",new Date().toISOString()),console.log("🔧 TOOL SELECTION CHANGED - TRANSFORMING DATA UPFRONT:",M),console.log("🔧 transformedData exists:",!!s),console.log("🔧 transformedData length:",s==null?void 0:s.length),console.log('🔧 toolId === "response-time-analyzer":',M==="response-time-analyzer"),d(M),M==="response-time-analyzer"&&s&&s.length>0){console.log("🔧 APPLYING RESPONSE TIME ANALYZER TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",s[0]),console.log("Original field names:",Object.keys(s[0]));try{const f=Et.transformToResponseTimeAnalyzer(s);if(!f.success){console.error("❌ Data transformation failed:",f.errors),x(null);return}const L=f.data||[];console.log("✅ UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed data sample (first record):",L[0]),console.log("Transformed field names:",Object.keys(L[0])),console.log("incidentTime value:",(N=L[0])==null?void 0:N.incidentTime),x(L)}catch(f){console.error("❌ Error during upfront transformation:",f),x(null)}}else if(M==="fire-map-pro"&&s&&s.length>0){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",s[0]),console.log("Original field names:",Object.keys(s[0]));try{const f=Et.transformToFireMapPro(s);if(!f.success){console.error("❌ Fire Map Pro transformation failed:",f.errors),x(null);return}const L=((ee=f.data)==null?void 0:ee.features)||[];console.log("✅ FIRE MAP PRO UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed features count:",L.length),console.log("Sample feature:",L[0]),x(L)}catch(f){console.error("❌ Error during Fire Map Pro upfront transformation:",f),x(null)}}else x(null)},G=(M,N,ee,f,L)=>{const A={id:`export-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,timestamp:Date.now(),format:M,recordCount:N,success:ee,destination:f,fileName:L};w(V=>[A,...V].slice(0,20))},i=()=>{w([])},c=()=>{const M=new Date;return M.toLocaleDateString()+" "+M.toLocaleTimeString()},h=async()=>{if(!s||s.length===0){_({success:!1,message:"No data to export",open:!0});return}E(!0);try{const M=Qn(s);let N=`formatted_data_${Date.now()}`;if(l==="excel"){const F=await hr(()=>import("./xlsx-DkH2s96g.js"),[]),v=F.utils.json_to_sheet(M),C={},J=Object.keys(s[0]);J.forEach(I=>{C[I]=Math.max(10,I.length+2)}),s.forEach(I=>{J.forEach(R=>{const b=String(I[R]||"");C[R]=Math.min(50,Math.max(C[R],b.length+2))})}),v["!cols"]=J.map(I=>({wch:C[I]}));const K=F.utils.book_new();K.Props={Title:"FireEMS Formatted Data",Subject:"Incident Data",Author:"FireEMS Data Formatter",CreatedDate:new Date},F.utils.book_append_sheet(K,v,"Formatted Data"),N=`formatted_data_${Date.now()}.xlsx`,F.writeFile(K,N),G("Excel",M.length,!0,"File Download",N),_({success:!0,message:"Data exported successfully as EXCEL",open:!0}),E(!1);return}if(l==="pdf"){const F=new Kr;F.setFontSize(18),F.text("FireEMS Formatted Data",14,22),F.setFontSize(11),F.text(`Export Date: ${c()}`,14,30),F.text(`Records: ${M.length}`,14,36);const v=Object.keys(M[0]);M.length>500&&F.text("Note: Export limited to 500 records for PDF format.",14,42);const C=M.length>500?48:42,J=30,K=10,I=10;F.setFontSize(10),F.setTextColor(0,0,0),F.setFillColor(220,220,220),v.forEach((b,g)=>{F.rect(I+g*J,C,J,K,"FD"),F.text(b,I+g*J+2,C+7)});const R=Math.min(M.length,20);for(let b=0;b<R;b++){const g=C+(b+1)*K;v.forEach((z,H)=>{F.rect(I+H*J,g,J,K,"S");const X=M[b][z]||"";let ne=String(X);ne.length>10&&(ne=ne.substring(0,8)+"..."),F.text(ne,I+H*J+2,g+7)})}F.setFontSize(8),F.text(`Generated by FireEMS Tools - ${new Date().toLocaleString()}`,F.internal.pageSize.width/2,F.internal.pageSize.height-10,{align:"center"}),N=`formatted_data_${Date.now()}.pdf`,F.save(N),G("PDF",M.length,!0,"File Download",N),_({success:!0,message:"Data exported successfully as PDF",open:!0}),E(!1);return}let ee="",f="";if(l==="csv"){const F=Object.keys(M[0]);ee=F.join(",")+`
`,M.forEach(v=>{const C=F.map(J=>{const K=v[J];return K==null?"":typeof K=="string"&&(K.includes(",")||K.includes('"')||K.includes(`
`))?`"${K.replace(/"/g,'""')}"`:K});ee+=C.join(",")+`
`}),N=`formatted_data_${Date.now()}.csv`,f="text/csv"}else l==="json"&&(ee=JSON.stringify(M,null,2),N=`formatted_data_${Date.now()}.json`,f="application/json");const L=new Blob([ee],{type:f}),A=URL.createObjectURL(L),V=document.createElement("a");V.href=A,V.download=N,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL(A),G(l.toUpperCase(),M.length,!0,"File Download",N),_({success:!0,message:`Data exported successfully as ${l.toUpperCase()}`,open:!0})}catch(M){console.error("Export error:",M),_({success:!1,message:`Error exporting data: ${M instanceof Error?M.message:"Unknown error"}`,open:!0}),G(l.toUpperCase(),s.length,!1,"File Download")}finally{E(!1)}},D=M=>({"response-time-analyzer":"Response Time Analyzer","call-density-heatmap":"Call Density Heatmap","incident-dashboard":"Incident Dashboard","trend-analyzer":"Trend Analyzer"})[M]||M,P=async()=>{var N,ee;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleSendToTool FUNCTION CALLED AT",new Date().toISOString()),console.log("🚀🚀🚀 selectedExportTool:",p),console.log("🚀🚀🚀 transformedData length:",s==null?void 0:s.length),console.log("🚀🚀🚀 preTransformedData length:",m==null?void 0:m.length),console.log("🚀🚀🚀 transformedData sample:",s==null?void 0:s[0]),!s||s.length===0||!p){console.log("❌ SEND TO TOOL FAILED - Missing data or tool selection"),console.log("❌ transformedData:",!!s),console.log("❌ transformedData.length:",s==null?void 0:s.length),console.log("❌ selectedExportTool:",p),_({success:!1,message:"No data or tool selected",open:!0});return}E(!0);const M=D(p);console.log("🚀 Tool name resolved:",M);try{let f;if(console.log('🔧 CHECKING TOOL TYPE - selectedExportTool === "response-time-analyzer":',p==="response-time-analyzer"),console.log("🔧 CHECKING PRE-TRANSFORMED DATA AVAILABILITY:",!!m),p==="response-time-analyzer"&&m&&m.length>0)console.log("✅ USING PRE-TRANSFORMED DATA FROM TOOL SELECTION - NO REDUNDANT TRANSFORMATION"),console.log("Pre-transformed data sample (first record):",m[0]),console.log("Pre-transformed field names:",Object.keys(m[0])),console.log("incidentTime value:",(N=m[0])==null?void 0:N.incidentTime),f=m;else if(p==="fire-map-pro"){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION");const A=Et.transformToFireMapPro(s);if(!A.success)throw console.error("❌ Data transformation failed:",A.errors),new Error(`Data transformation failed: ${A.errors.join(", ")}`);f=((ee=A.data)==null?void 0:ee.features)||[]}else console.log("🔧 USING STANDARD DATA FORMATTING"),console.log("DEBUG - USING ALREADY TRANSFORMED DATA: Sample data fields:",s.length>0?Object.keys(s[0]):"No data"),f=s.map(A=>{const V={...A};return console.log("DEBUG - USING MAPPED DATA: Record fields:",Object.keys(A)),Object.keys(V).forEach(F=>{if(V[F]&&typeof V[F]=="string"&&V[F].includes(" ")){const[v,C]=V[F].split(" ");console.log(`DATETIME SPLIT: Field "${F}" = "${V[F]}" -> Date: "${v}", Time: "${C}"`),F.toLowerCase().includes("date")?(console.log(`SETTING DATE FIELD "${F}" to "${v}"`),V[F]=v):F.toLowerCase().includes("time")&&(console.log(`SETTING TIME FIELD "${F}" to "${C}"`),V[F]=C)}}),V});const L={toolId:p,toolName:M,data:f,sourceFile:n==null?void 0:n.name,timestamp:Date.now(),fields:Object.keys(f[0]),recordCount:f.length,exportVersion:"2.0"};if(f.length>0){console.log("Sample record being sent (using user-mapped fields):",f[0]);const A=f[0],V=Object.keys(A);console.log("All field names (as mapped by user):",V),console.log("Field values:",A)}sessionStorage.removeItem("fireEmsExportedData"),console.log("VERIFY: Field names being stored in sessionStorage:",L.data&&L.data.length>0?Object.keys(L.data[0]):"No data"),sessionStorage.setItem("fireEmsExportedData",JSON.stringify(L)),console.log(`Data prepared for ${p}. Data size: ${f.length} records`),f.length>0&&(console.log("FIELD NAMES CHECK - Sample record being sent to session storage:"),console.log(JSON.stringify(f[0]))),G("Data Transfer",f.length,!0,M),_({success:!0,message:`Data sent to ${M} successfully!`,open:!0}),setTimeout(()=>{const F=`http://${window.location.hostname}:5006`;let v="";if(p==="fire-map-pro")v=`${window.location.origin}/app/fire-map-pro`;else if(p==="response-time-analyzer")v=`${window.location.origin}/app/response-time-analyzer`;else if(p==="call-density-heatmap")v=`${F}/call-density-heatmap`;else if(p==="incident-dashboard")v=`${F}/incident-dashboard`;else if(p==="trend-analyzer")v=`${F}/trend-analyzer`;else{console.log(`Tool ID not recognized: ${p}`);return}console.log(`Redirecting to: ${v}`),window.location.href=v},500)}catch(f){console.error("Send to tool error:",f),_({success:!1,message:`Error sending data to tool: ${f instanceof Error?f.message:"Unknown error"}`,open:!0}),G("Data Transfer",s.length,!1,M)}finally{E(!1)}},Y=()=>{t(Ne(2))};if(!s||s.length===0)return e.jsxs(j,{children:[e.jsx(de,{severity:"warning",sx:{mb:2},children:"No data available to export. Please go back and ensure your data is processed correctly."}),e.jsx(re,{variant:"outlined",startIcon:e.jsx(ot,{}),onClick:Y,children:"Back to Validation"})]});const Z=M=>new Date(M).toLocaleString(),ie=()=>U.length===0?e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(y,{color:"text.secondary",children:"No export history available"})}):e.jsx(Ue,{sx:{width:"100%",bgcolor:"background.paper"},dense:!0,children:U.map(M=>e.jsxs(Se,{secondaryAction:e.jsx(Ce,{edge:"end","aria-label":"delete",onClick:()=>{w(N=>N.filter(ee=>ee.id!==M.id))},children:e.jsx(it,{fontSize:"small"})}),sx:{borderLeft:"4px solid",borderColor:M.success?"success.main":"error.main",mb:1,bgcolor:"background.paper","&:hover":{bgcolor:"action.hover"}},children:[e.jsxs(Pe,{children:[M.format==="Excel"&&e.jsx(ft,{color:"success"}),M.format==="CSV"&&e.jsx(Pt,{color:"primary"}),M.format==="JSON"&&e.jsx($r,{color:"info"}),M.format==="PDF"&&e.jsx(ft,{color:"error"}),M.format==="Data Transfer"&&e.jsx(Ar,{color:"secondary"})]}),e.jsx(Ee,{primary:e.jsx(y,{variant:"body2",fontWeight:"medium",children:M.format==="Data Transfer"?`Sent to ${M.destination}`:`${M.format} Export${M.fileName?` - ${M.fileName}`:""}`}),secondary:e.jsxs(y,{variant:"caption",display:"block",children:[Z(M.timestamp)," • ",M.recordCount," records",!M.success&&" • Failed"]})})]},M.id))});return console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - FRESH BUILD JUN 13 2025 16:47 - transformedData length:",s==null?void 0:s.length),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - selectedExportTool:",p),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - tabValue:",o),e.jsxs(j,{children:[e.jsx(y,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Export Formatted Data"}),e.jsxs(ge,{sx:{p:2,mb:3},children:[e.jsxs(ue,{container:!0,spacing:2,children:[e.jsx(ue,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(y,{variant:"body1",children:[(n==null?void 0:n.name)||"No file"," (",n==null?void 0:n.type,")"]})]})}),e.jsx(ue,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(y,{variant:"body1",children:[s.length," records processed"]})]})}),e.jsx(ue,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:r.length===0?e.jsxs(e.Fragment,{children:[e.jsx(Ke,{color:"success"}),e.jsx(y,{color:"success.main",children:"All data is valid"})]}):e.jsx(e.Fragment,{children:e.jsxs(de,{severity:"warning",sx:{mt:1},children:[r.length," validation issues found. Consider reviewing before export."]})})})]})})]}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(kt,{color:"action",fontSize:"small"}),e.jsx(y,{variant:"subtitle2",color:"text.secondary",children:"Export History"}),U.length>0&&e.jsx(Ts,{badgeContent:U.length,color:"primary",sx:{ml:1}})]}),e.jsxs(j,{children:[e.jsx(Ce,{size:"small",onClick:()=>k(!W),"aria-label":W?"Hide history":"Show history",children:W?e.jsx(Fr,{}):e.jsx(bt,{})}),U.length>0&&W&&e.jsx(re,{size:"small",startIcon:e.jsx(it,{}),onClick:i,sx:{ml:1},children:"Clear"})]})]}),e.jsx(Tr,{in:W,children:e.jsx(j,{sx:{mt:2},children:ie()})})]}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(jt,{value:o,onChange:S,"aria-label":"export options tabs",children:[e.jsx(Ie,{label:"Download File",id:"export-tab-0","aria-controls":"export-tabpanel-0"}),e.jsx(Ie,{label:"Send to Tool",id:"export-tab-1","aria-controls":"export-tabpanel-1"})]})}),e.jsx(ir,{value:o,index:0,children:e.jsxs(ue,{container:!0,spacing:3,children:[e.jsx(ue,{size:{xs:12,md:6},children:e.jsx(Kn,{selectedFormat:l,onFormatChange:B})}),e.jsx(ue,{size:{xs:12,md:6},children:e.jsx(Zn,{dataCount:s.length,fields:Object.keys(s[0]),format:l})}),e.jsx(ue,{size:12,children:e.jsx(re,{variant:"contained",color:"primary",fullWidth:!0,size:"large",onClick:h,disabled:T,startIcon:T?e.jsx(ze,{size:20}):e.jsx(os,{}),sx:{mt:2},children:T?"Exporting...":`Download as ${l.toUpperCase()}`})})]})}),e.jsx(ir,{value:o,index:1,children:e.jsx(Xn,{selectedTool:p,onToolSelect:q,transformedData:s,onSendToTool:P,isSending:T,preTransformedData:m})}),e.jsx(xe,{sx:{my:3}}),e.jsx(j,{sx:{display:"flex",justifyContent:"space-between"},children:e.jsx(re,{variant:"outlined",startIcon:e.jsx(ot,{}),onClick:Y,children:"Back to Validation"})}),e.jsx(Cr,{open:$.open,autoHideDuration:6e3,onClose:()=>_({...$,open:!1}),children:e.jsx(de,{onClose:()=>_({...$,open:!1}),severity:$.success?"success":"error",children:$.message})})]})},lr={log:(...t)=>{},warn:(...t)=>{},error:(...t)=>{console.error(...t)},debug:(...t)=>{},info:(...t)=>{}},to=["Upload File","Map Fields","Preview & Validate","Export"],$o=()=>{const{currentStep:t}=Be(r=>r.formatter),n=()=>{const r=window.location.pathname;return r.includes("fire-map-pro")?"FireEMS Fire Map Pro":r.includes("response-time-analyzer")?"FireEMS Response Time Analyzer":"FireEMS Data Formatter"};Xe.useEffect(()=>{const r=n();document.title=r;try{yt(),lr.debug("[DEBUG] Vendor templates seeded successfully")}catch(o){lr.error("[ERROR] Failed to seed vendor templates:",o)}},[]);const s=r=>{switch(r){case 0:return e.jsx(Os,{});case 1:return e.jsx(Ln,{});case 2:return e.jsx(Jn,{});case 3:return e.jsx(eo,{});default:return e.jsx(y,{children:"Unknown step"})}};return e.jsx(Wr,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(ge,{elevation:3,sx:{p:3},children:[e.jsx(y,{variant:"h4",component:"h1",gutterBottom:!0,children:n()}),e.jsx(as,{activeStep:t,sx:{mb:4},children:to.map(r=>e.jsx(is,{children:e.jsx(ls,{children:r})},r))}),e.jsx(j,{sx:{mt:2},children:s(t)})]})})};export{$o as default};
