<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FireMapPro | FireEMS.ai</title>
    
    <!-- External CSS Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fire-map-pro.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='fix-ready-status.css') }}">
    
    <!-- Required scripts before content loads -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet-draw@1.0.4/dist/leaflet.draw.js"></script>
    <!-- Font Awesome JS is conflicting with our custom styles, removing -->
    <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script> -->
    
    <!-- Export libraries (lazy loaded, but defined here for faster response) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <!-- Additional print export libraries -->
    <script src="https://cdn.jsdelivr.net/npm/kmcconverter@1.0.1/dist/index.js"></script> <!-- For RGB to CMYK conversion -->
    
    <!-- Fix for Leaflet.Draw toolbar visibility and styling -->
    <style>
        /* Ensure left panel scrolls properly with all the new content */
        .left-panel {
            max-height: calc(100vh - 240px);
            overflow-y: auto;
            overflow-x: hidden;
            scroll-behavior: smooth;
            padding-right: 10px;
        }
        
        /* Additional styles for the icon palette */
        .icon-category {
            margin-bottom: 15px;
        }
        
        /* Logo upload button styling */
        .logo-upload-btn {
            display: inline-block;
            background-color: #1976d2;
            color: white;
            padding: 6px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background-color 0.2s;
        }
        
        .logo-upload-btn:hover {
            background-color: #0d47a1;
        }
        
        #print-logo-filename {
            font-size: 0.85rem;
            color: #666;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 150px;
        }
        
        .icon-category h4 {
            background-color: #f5f5f5;
            padding: 5px 10px;
            border-radius: 4px;
            margin-bottom: 10px;
            font-size: 0.95rem;
            color: #333;
            border-left: 3px solid #d32f2f;
        }
        
        .icon-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
            margin-bottom: 10px;
        }
        
        .draggable-icon {
            background-color: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 10px 5px;
            text-align: center;
            cursor: grab;
            transition: all 0.2s;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 5px;
        }
        
        .draggable-icon:hover {
            background-color: #f9f9f9;
            transform: translateY(-2px);
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }
        
        .draggable-icon i {
            font-size: 1.2rem;
            margin-bottom: 5px;
        }
        
        .draggable-icon span {
            font-size: 0.8rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 100%;
        }
        
        @media (max-width: 768px) {
            .icon-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }
        
        /* Super high z-index fix for all Leaflet.Draw elements */
        .leaflet-draw, 
        .leaflet-draw.leaflet-control {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 99999 !important; /* Extreme z-index to ensure it stays above everything */
            pointer-events: auto !important;
            position: absolute !important; /* Absolute positioning to break out of stacking context */
            top: 10px !important;
            right: 10px !important;
        }
        
        .leaflet-draw-toolbar {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 99999 !important;
            background: white !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            border-radius: 4px !important;
            padding: 2px !important;
            position: relative !important;
        }
        
        .leaflet-draw-toolbar a, 
        [class*="leaflet-draw-toolbar-button"] {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 99999 !important;
            pointer-events: auto !important;
        }
        
        .leaflet-draw-actions {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 100000 !important; /* Even higher than toolbar */
            pointer-events: auto !important;
            position: absolute !important;
            left: 36px !important;
        }
        
        .leaflet-draw-actions a {
            display: block !important;
            visibility: visible !important;
            opacity: 1 !important;
            z-index: 100000 !important;
            pointer-events: auto !important;
        }
        
        /* Force controls to stay on top of all map layers */
        .leaflet-top, 
        .leaflet-bottom {
            z-index: 10000 !important;
            position: absolute !important;
        }
        
        /* Override map pane z-indices */
        .leaflet-map-pane {
            z-index: 1 !important; /* Lower than controls */
        }
        
        .leaflet-tile-pane {
            z-index: 2 !important;
        }
        
        /* Ensure toolbar has proper background */
        .leaflet-draw-toolbar {
            background: white !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            border-radius: 4px !important;
            padding: 2px !important;
        }
        
        /* Style buttons specifically */
        .leaflet-draw-toolbar a {
            width: 30px !important;
            height: 30px !important;
            line-height: 30px !important;
            text-align: center !important;
            margin-bottom: 2px !important;
            border-radius: 4px !important;
            color: #333 !important;
        }
        
        /* Use Font Awesome icons for drawing toolbar */
        .leaflet-draw-toolbar a:before {
            font-family: 'Font Awesome 5 Free';
            font-weight: 900;
            font-size: 16px;
            line-height: 30px;
            width: 30px;
            text-align: center;
            display: inline-block;
        }
        
        .leaflet-draw-toolbar a.leaflet-draw-draw-polyline:before {
            content: "\f1e0"; /* fa-share-alt - good for lines */
        }
        
        .leaflet-draw-toolbar a.leaflet-draw-draw-polygon:before {
            content: "\f5ee"; /* fa-draw-polygon */
        }
        
        .leaflet-draw-toolbar a.leaflet-draw-draw-rectangle:before {
            content: "\f0c8"; /* fa-square */
        }
        
        .leaflet-draw-toolbar a.leaflet-draw-draw-circle:before {
            content: "\f111"; /* fa-circle */
        }
        
        .leaflet-draw-toolbar a.leaflet-draw-draw-marker:before {
            content: "\f3c5"; /* fa-map-marker-alt */
        }
        
        .leaflet-draw-toolbar a.leaflet-draw-edit-edit:before {
            content: "\f044"; /* fa-edit */
        }
        
        .leaflet-draw-toolbar a.leaflet-draw-edit-remove:before {
            content: "\f2ed"; /* fa-trash-alt */
        }
        
        /* Remove default background images */
        .leaflet-draw-toolbar a {
            background-image: none !important;
            background-color: white !important;
        }
        
        /* Add labels to make it clearer what each tool does */
        .leaflet-draw-tooltip {
            background: rgba(0, 0, 0, 0.7) !important;
            color: white !important;
            border: none !important;
            box-shadow: 0 1px 7px rgba(0,0,0,0.4) !important;
            border-radius: 4px !important;
            padding: 5px 10px !important;
            font-size: 13px !important;
            white-space: nowrap !important;
        }
        
        .leaflet-draw-toolbar a:hover {
            background-color: #f4f4f4 !important;
        }
        
        .leaflet-draw-actions {
            left: 35px !important;
            box-shadow: 0 1px 5px rgba(0,0,0,0.4) !important;
            border-radius: 4px !important;
        }
        
        .leaflet-draw-actions a {
            background: white !important;
            color: #333 !important;
            font-size: 13px !important;
            line-height: 28px !important;
            text-decoration: none !important;
        }
        
        .leaflet-draw-actions a:hover {
            background-color: #f4f4f4 !important;
        }
        
        /* Custom div icons styling */
        .custom-div-icon {
            background: transparent;
            border: none;
        }
        
        .custom-div-icon i {
            font-size: 24px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.5);
        }
        
        /* Make radio buttons more prominent */
        .radio-group input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }
        
        .radio-group label {
            cursor: pointer;
            font-weight: bold;
            padding: 5px;
        }
        
        /* Add pointer cursor to all buttons */
        .tool-btn, button {
            cursor: pointer;
        }
    </style>
    
    <!-- Favicon -->
    <link rel="shortcut icon" href="{{ url_for('static', filename='favicon.ico') }}">
    
    <!-- Additional styles for print export functionality -->
    <style>
        /* Premium button styling */
        .premium-btn {
            background: linear-gradient(135deg, #1976d2 0%, #00b0ff 100%);
            color: white !important;
            border: none !important;
            position: relative;
            overflow: hidden;
        }
        
        .premium-btn i {
            color: white !important;
        }
        
        .premium-btn::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: all 0.6s;
        }
        
        .premium-btn:hover::before {
            left: 100%;
        }
        
        /* Print options styling */
        .print-option-group {
            margin-bottom: 12px;
            display: flex;
            align-items: center;
        }
        
        .print-option-group label {
            min-width: 120px;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .print-option-group.checkbox {
            display: flex;
            align-items: center;
        }
        
        .print-option-group.checkbox label {
            margin-left: 8px;
            min-width: auto;
        }
        
        .print-option {
            padding: 6px 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            flex: 1;
        }
        
        input.slider {
            flex: 1;
            margin-right: 10px;
        }
        
        /* Print preview modal */
        #print-preview-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.85);
            z-index: 9999999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .print-preview-content {
            background: white;
            border-radius: 8px;
            max-width: 90%;
            max-height: 90%;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            box-shadow: 0 5px 15px rgba(0,0,0,0.5);
        }
        
        .print-preview-header {
            padding: 15px;
            background: #f5f5f5;
            border-bottom: 1px solid #ddd;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .print-preview-header h2 {
            margin: 0;
            font-size: 1.2rem;
            color: #333;
        }
        
        .print-preview-close {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #666;
        }
        
        .print-preview-body {
            padding: 20px;
            overflow: auto;
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 400px;
            max-height: 70vh;
        }
        
        .print-preview-canvas-container {
            position: relative;
            box-shadow: 0 0 20px rgba(0,0,0,0.2);
        }
        
        .print-preview-canvas {
            display: block;
        }
        
        .print-preview-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }
        
        .print-preview-info {
            font-size: 0.9rem;
            color: #666;
            margin-top: 15px;
            text-align: center;
        }
        
        .print-preview-footer {
            padding: 15px;
            background: #f5f5f5;
            border-top: 1px solid #ddd;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        
        .print-preview-footer button {
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        
        .print-preview-footer .cancel-btn {
            background: #f5f5f5;
            border: 1px solid #ddd;
            color: #333;
        }
        
        .print-preview-footer .export-btn {
            background: #1976d2;
            border: none;
            color: white;
        }
    </style>
</head>
<body>
    <div class="navbar">
        <div class="logo">
            <a href="/">
                <i class="fas fa-fire" style="color: #ff6b4a;"></i> FireEMS.ai
            </a>
        </div>
        <div class="nav-links">
            <a href="/">Home</a>
            <a href="/fire-ems-dashboard">Response Time Analyzer</a>
            <a href="/isochrone-map">Isochrone Map</a>
            <a href="/call-density-heatmap">Call Density</a>
            <a href="/station-overview">Station Overview</a>
            <a href="/incident-logger">Incident Logger</a>
            <a href="/coverage-gap-finder">Coverage Gap Finder</a>
            <a href="/fire-map-pro" class="active">FireMapPro</a>
            <a href="/data-formatter">Data Formatter</a>
        </div>
    </div>
    
    <header class="tool-header">
        <div class="container">
            <h1><i class="fas fa-map-marked-alt"></i> FireMapPro</h1>
            <p>Advanced interactive map creator for fire department and EMS planning</p>
        </div>
    </header>
    
    <!-- Print Preview Modal -->
    <div id="print-preview-modal">
        <div class="print-preview-content">
            <div class="print-preview-header">
                <h2><i class="fas fa-print"></i> Print Preview</h2>
                <button class="print-preview-close">&times;</button>
            </div>
            <div class="print-preview-body">
                <div class="print-preview-canvas-container">
                    <canvas id="print-preview-canvas" class="print-preview-canvas"></canvas>
                    <canvas id="print-preview-overlay" class="print-preview-overlay"></canvas>
                </div>
            </div>
            <div class="print-preview-info">
                <p>Preview shows bleed area (red), trim line (black), and safe zone (blue).</p>
                <p>For best results, keep important content inside the safe zone.</p>
            </div>
            <div class="print-preview-footer">
                <button class="cancel-btn" id="print-preview-cancel">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button class="export-btn" id="print-preview-export">
                    <i class="fas fa-file-export"></i> Export for Print
                </button>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="panel-container">
            <div class="left-panel">
                <h2>FireMapPro</h2>
                <p>Advanced interactive map creator for fire department and EMS planning and analysis.</p>
                
                <div class="tools-section">
                    <h3><i class="fas fa-layer-group"></i> Map Layers</h3>
                    <div class="layer-controls">
                        <div class="base-layers">
                            <h4>Base Maps</h4>
                            <div class="radio-group">
                                <input type="radio" id="street-layer" name="base-layer" value="street" checked>
                                <label for="street-layer">Street</label>
                                
                                <input type="radio" id="satellite-layer" name="base-layer" value="satellite">
                                <label for="satellite-layer">Satellite</label>
                                
                                <input type="radio" id="terrain-layer" name="base-layer" value="terrain">
                                <label for="terrain-layer">Terrain</label>
                            </div>
                        </div>
                        
                        <div class="overlay-layers">
                            <h4>Data Overlays</h4>
                            <div class="checkbox-group">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="stations-layer" value="stations">
                                    <label for="stations-layer">Fire Stations</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="incidents-layer" value="incidents">
                                    <label for="incidents-layer">Incidents</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="response-layer" value="response">
                                    <label for="response-layer">Response Areas</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="population-layer" value="population">
                                    <label for="population-layer">Population Density</label>
                                </div>
                                
                                <div class="checkbox-item">
                                    <input type="checkbox" id="hydrants-layer" value="hydrants">
                                    <label for="hydrants-layer">Hydrants</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-file-upload"></i> Custom Data</h3>
                    <div class="upload-section">
                        <h4>Import Data</h4>
                        <div class="file-upload">
                            <label for="geojson-upload" class="upload-btn">
                                <i class="fas fa-file-import"></i> GeoJSON / KML
                            </label>
                            <input type="file" id="geojson-upload" accept=".geojson,.json,.kml">
                        </div>
                        
                        <div class="file-upload">
                            <label for="csv-upload" class="upload-btn">
                                <i class="fas fa-table"></i> CSV with Coordinates
                            </label>
                            <input type="file" id="csv-upload" accept=".csv">
                        </div>
                        
                        <div class="file-upload">
                            <label for="image-upload" class="upload-btn">
                                <i class="fas fa-image"></i> Image Overlay
                            </label>
                            <input type="file" id="image-upload" accept="image/*">
                        </div>
                        <div id="upload-status"></div>
                        
                        <!-- CSV Configuration Options -->
                        <div class="csv-config-section">
                            <h4>CSV Import Settings</h4>
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-preview-enable" checked>
                                <label for="csv-preview-enable">Show preview before import</label>
                            </div>
                            
                            <div class="input-group">
                                <label for="csv-coord-format">Coordinate Format:</label>
                                <select id="csv-coord-format">
                                    <option value="lat_lng">Latitude, Longitude</option>
                                    <option value="lng_lat">Longitude, Latitude</option>
                                </select>
                            </div>
                            
                            <div class="checkbox-item">
                                <input type="checkbox" id="csv-header-detection" checked>
                                <label for="csv-header-detection">Auto-detect headers</label>
                            </div>
                            
                            <div class="info-text">
                                <i class="fas fa-info-circle"></i> Set coordinate format to "Longitude, Latitude" for Phoenix data
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="tools-section">
                    <h3><i class="fas fa-tools"></i> Map Tools</h3>
                    <div class="map-tools">
                        <button id="draw-tool" class="tool-btn">
                            <i class="fas fa-draw-polygon"></i> Draw & Measure
                        </button>
                        
                        <button id="search-tool" class="tool-btn">
                            <i class="fas fa-search-location"></i> Search Address
                        </button>
                        
                        <button id="filter-tool" class="tool-btn">
                            <i class="fas fa-filter"></i> Filter Data
                        </button>
                        
                        <button id="export-tool" class="tool-btn">
                            <i class="fas fa-file-export"></i> Export Map
                        </button>
                        
                        <button id="icon-tool" class="tool-btn">
                            <i class="fas fa-icons"></i> Add Icons
                        </button>
                        
                        <button id="clear-map" class="tool-btn danger">
                            <i class="fas fa-trash"></i> Clear All
                        </button>
                    </div>
                </div>
                
                <div id="icon-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-icons"></i> Drag Icons To Map</h3>
                    <p class="hint-text"><i class="fas fa-info-circle"></i> Drag and drop icons onto the map</p>
                    <div class="icon-palette">
                        <div class="icon-category">
                            <h4>Fire Department</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="fire-station">
                                    <i class="fas fa-fire-extinguisher"></i>
                                    <span>Fire Station</span>
                                </div>
                                <div class="draggable-icon" data-icon="fire-engine">
                                    <i class="fas fa-truck"></i>
                                    <span>Fire Engine</span>
                                </div>
                                <div class="draggable-icon" data-icon="ladder-truck">
                                    <i class="fas fa-truck-moving"></i>
                                    <span>Ladder Truck</span>
                                </div>
                                <div class="draggable-icon" data-icon="hydrant">
                                    <i class="fas fa-tint"></i>
                                    <span>Hydrant</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-category">
                            <h4>Emergency Services</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="ambulance">
                                    <i class="fas fa-ambulance"></i>
                                    <span>Ambulance</span>
                                </div>
                                <div class="draggable-icon" data-icon="hospital">
                                    <i class="fas fa-hospital"></i>
                                    <span>Hospital</span>
                                </div>
                                <div class="draggable-icon" data-icon="medic">
                                    <i class="fas fa-user-md"></i>
                                    <span>Medic</span>
                                </div>
                                <div class="draggable-icon" data-icon="police">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Police</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-category">
                            <h4>Hazards & Warnings</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="hazard">
                                    <i class="fas fa-exclamation-triangle"></i>
                                    <span>Hazard</span>
                                </div>
                                <div class="draggable-icon" data-icon="hazmat">
                                    <i class="fas fa-biohazard"></i>
                                    <span>Hazmat</span>
                                </div>
                                <div class="draggable-icon" data-icon="radiation">
                                    <i class="fas fa-radiation"></i>
                                    <span>Radiation</span>
                                </div>
                                <div class="draggable-icon" data-icon="chemical">
                                    <i class="fas fa-flask"></i>
                                    <span>Chemical</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-category">
                            <h4>DOT Placard Types</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="placard-flammable">
                                    <i class="fas fa-fire"></i>
                                    <span>Flammable</span>
                                </div>
                                <div class="draggable-icon" data-icon="placard-explosive">
                                    <i class="fas fa-bomb"></i>
                                    <span>Explosive</span>
                                </div>
                                <div class="draggable-icon" data-icon="placard-gas">
                                    <i class="fas fa-wind"></i>
                                    <span>Gas</span>
                                </div>
                                <div class="draggable-icon" data-icon="placard-corrosive">
                                    <i class="fas fa-skull-crossbones"></i>
                                    <span>Corrosive</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-category">
                            <h4>Energy Systems</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="bess">
                                    <i class="fas fa-car-battery"></i>
                                    <span>BESS</span>
                                </div>
                                <div class="draggable-icon" data-icon="solar">
                                    <i class="fas fa-solar-panel"></i>
                                    <span>Solar Panel</span>
                                </div>
                                <div class="draggable-icon" data-icon="electric">
                                    <i class="fas fa-bolt"></i>
                                    <span>Electric</span>
                                </div>
                                <div class="draggable-icon" data-icon="utility-pole">
                                    <i class="fas fa-broadcast-tower"></i>
                                    <span>Utility Pole</span>
                                </div>
                            </div>
                        </div>
                                                
                        <div class="icon-category">
                            <h4>Command & Control</h4>
                            <div class="icon-grid">
                                <div class="draggable-icon" data-icon="command-post">
                                    <i class="fas fa-laptop-house"></i>
                                    <span>Command Post</span>
                                </div>
                                <div class="draggable-icon" data-icon="staging-area">
                                    <i class="fas fa-people-carry"></i>
                                    <span>Staging Area</span>
                                </div>
                                <div class="draggable-icon" data-icon="evacuation">
                                    <i class="fas fa-running"></i>
                                    <span>Evacuation</span>
                                </div>
                                <div class="draggable-icon" data-icon="helicopter">
                                    <i class="fas fa-helicopter"></i>
                                    <span>Helicopter</span>
                                </div>
                            </div>
                        </div>
                        
                        <div class="icon-options">
                            <div class="color-selector">
                                <label for="icon-color">Icon Color:</label>
                                <select id="icon-color">
                                    <option value="#d32f2f" selected>Red</option>
                                    <option value="#1976d2">Blue</option>
                                    <option value="#388e3c">Green</option>
                                    <option value="#f57c00">Orange</option>
                                    <option value="#5e35b1">Purple</option>
                                    <option value="#000000">Black</option>
                                    <option value="#ffeb3b">Yellow</option>
                                    <option value="#795548">Brown</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="search-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-search"></i> Search</h3>
                    <div class="search-box">
                        <input type="text" id="address-search" placeholder="Enter an address to search...">
                        <button id="search-btn" class="primary-btn">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    <div id="search-results"></div>
                </div>
                
                <div id="filter-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-filter"></i> Filter Data</h3>
                    <div class="filter-options">
                        <div class="filter-group">
                            <label for="filter-type">Type:</label>
                            <select id="filter-type">
                                <option value="all">All</option>
                                <option value="fire">Fire</option>
                                <option value="ems">EMS</option>
                                <option value="hazmat">Hazmat</option>
                                <option value="rescue">Rescue</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button id="apply-filter" class="primary-btn">Apply Filter</button>
                            <button id="reset-filter" class="secondary-btn">Reset</button>
                        </div>
                    </div>
                </div>
                
                <div id="export-container" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-file-export"></i> Export Map</h3>
                    <div class="export-options">
                        <p>Choose export format:</p>
                        <div class="export-buttons">
                            <button id="export-pdf" class="export-btn">
                                <i class="fas fa-file-pdf"></i> PDF
                            </button>
                            <button id="export-png" class="export-btn">
                                <i class="fas fa-file-image"></i> PNG Image
                            </button>
                            <button id="export-geojson" class="export-btn">
                                <i class="fas fa-file-code"></i> GeoJSON
                            </button>
                            <button id="export-print" class="export-btn premium-btn">
                                <i class="fas fa-print"></i> Print Quality
                            </button>
                        </div>
                        
                        <!-- Print Export Options (hidden by default) -->
                        <div id="print-export-options" style="display: none; margin-top: 20px; background: #f9f9f9; padding: 15px; border-radius: 6px; border-left: 3px solid #1976d2;">
                            <h4 style="margin-top: 0; margin-bottom: 10px; color: #1976d2;"><i class="fas fa-cog"></i> Print Settings</h4>
                            
                            <div class="print-option-group">
                                <label for="print-size">Paper Size:</label>
                                <select id="print-size" class="print-option">
                                    <option value="letter">Letter (8.5" x 11")</option>
                                    <option value="legal">Legal (8.5" x 14")</option>
                                    <option value="tabloid">Tabloid (11" x 17")</option>
                                    <option value="a4">A4 (210 x 297 mm)</option>
                                    <option value="a3">A3 (297 x 420 mm)</option>
                                </select>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-orientation">Orientation:</label>
                                <select id="print-orientation" class="print-option">
                                    <option value="landscape">Landscape</option>
                                    <option value="portrait">Portrait</option>
                                </select>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-dpi">Resolution (DPI):</label>
                                <select id="print-dpi" class="print-option">
                                    <option value="150">150 DPI</option>
                                    <option value="300" selected>300 DPI (Recommended)</option>
                                    <option value="600">600 DPI (Large File)</option>
                                </select>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-line-thickness">Line Thickness:</label>
                                <input type="range" id="print-line-thickness" min="1" max="5" value="2" class="print-option slider">
                                <span id="print-line-thickness-value">2</span>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-text-size">Text Size:</label>
                                <input type="range" id="print-text-size" min="1" max="5" value="3" class="print-option slider">
                                <span id="print-text-size-value">3</span>
                            </div>
                            
                            <h4 style="margin-top: 20px; margin-bottom: 10px; color: #1976d2; border-top: 1px solid #ddd; padding-top: 15px;">
                                <i class="fas fa-image"></i> Logo & Title
                            </h4>
                            
                            <div class="print-option-group">
                                <label for="print-map-title">Map Title:</label>
                                <input type="text" id="print-map-title" class="print-option" placeholder="Enter a title for your map">
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-title-position">Title Position:</label>
                                <select id="print-title-position" class="print-option">
                                    <option value="top">Top</option>
                                    <option value="bottom">Bottom</option>
                                </select>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-title-font">Title Font:</label>
                                <select id="print-title-font" class="print-option">
                                    <option value="Arial">Arial</option>
                                    <option value="Helvetica">Helvetica</option>
                                    <option value="Times New Roman">Times New Roman</option>
                                    <option value="Georgia">Georgia</option>
                                    <option value="Verdana">Verdana</option>
                                    <option value="Tahoma">Tahoma</option>
                                </select>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-title-size">Title Size:</label>
                                <input type="range" id="print-title-size" min="1" max="5" value="3" class="print-option slider">
                                <span id="print-title-size-value">3</span>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-title-color">Title Color:</label>
                                <input type="color" id="print-title-color" value="#000000" class="print-option">
                            </div>
                            
                            <div class="print-option-group logo-upload">
                                <label for="print-logo-upload">Logo:</label>
                                <div style="display: flex; gap: 10px; align-items: center;">
                                    <label for="print-logo-upload" class="logo-upload-btn">
                                        <i class="fas fa-upload"></i> Upload Logo
                                    </label>
                                    <input type="file" id="print-logo-upload" accept="image/*" style="display: none;">
                                    <span id="print-logo-filename">No file selected</span>
                                </div>
                            </div>
                            
                            <div id="print-logo-preview" style="display: none; margin-top: 10px; text-align: center; border: 1px dashed #ddd; padding: 10px; border-radius: 4px;">
                                <img id="print-logo-preview-img" style="max-width: 200px; max-height: 80px;">
                                <button id="print-logo-remove" class="secondary-btn" style="margin-top: 10px; font-size: 0.8rem; padding: 3px 8px;">
                                    <i class="fas fa-times"></i> Remove Logo
                                </button>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-logo-position">Logo Position:</label>
                                <select id="print-logo-position" class="print-option">
                                    <option value="top-left">Top Left</option>
                                    <option value="top-right">Top Right</option>
                                    <option value="bottom-left">Bottom Left</option>
                                    <option value="bottom-right">Bottom Right</option>
                                </select>
                            </div>
                            
                            <div class="print-option-group">
                                <label for="print-logo-size">Logo Size:</label>
                                <input type="range" id="print-logo-size" min="1" max="5" value="3" class="print-option slider">
                                <span id="print-logo-size-value">3</span>
                            </div>
                            
                            <h4 style="margin-top: 20px; margin-bottom: 10px; color: #1976d2; border-top: 1px solid #ddd; padding-top: 15px;">
                                <i class="fas fa-sliders-h"></i> Print Options
                            </h4>
                            
                            <div class="print-option-group checkbox">
                                <input type="checkbox" id="print-show-bleed" checked class="print-option">
                                <label for="print-show-bleed">Show bleed area (0.125")</label>
                            </div>
                            
                            <div class="print-option-group checkbox">
                                <input type="checkbox" id="print-show-safe" checked class="print-option">
                                <label for="print-show-safe">Show safe zone</label>
                            </div>
                            
                            <div class="print-option-group checkbox">
                                <input type="checkbox" id="print-cmyk" checked class="print-option">
                                <label for="print-cmyk">Use CMYK color profile</label>
                            </div>
                            
                            <div class="print-actions" style="margin-top: 15px; display: flex; gap: 10px;">
                                <button id="print-preview-btn" class="primary-btn">
                                    <i class="fas fa-eye"></i> Preview
                                </button>
                                <button id="print-export-btn" class="primary-btn">
                                    <i class="fas fa-file-export"></i> Export for Print
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="measurement-info" class="tools-section" style="display: none;">
                    <h3><i class="fas fa-ruler"></i> Measurement Info</h3>
                    <div id="measurement-display">
                        <p>Draw a shape on the map to measure:</p>
                        <ul>
                            <li>Line: Distance</li>
                            <li>Polygon/Rectangle: Area</li>
                            <li>Circle: Radius and Area</li>
                        </ul>
                    </div>
                    <div id="measurement-results">
                        <p>No measurements yet</p>
                    </div>
                </div>
            </div>
            
            <div class="right-panel">
                <div id="map"></div>
                <div class="map-status-bar">
                    <div class="status-item">
                        <span>Zoom: </span>
                        <span id="zoom-level">-</span>
                    </div>
                    <div class="status-item">
                        <span>Center: </span>
                        <span id="map-center">-</span>
                    </div>
                    <div class="status-item">
                        <span>Mouse: </span>
                        <span id="mouse-position">-</span>
                    </div>
                    <div class="status-item">
                        <span>Scale: </span>
                        <span id="map-scale">-</span>
                    </div>
                </div>
                <div id="legend" class="map-legend">
                    <h4>Legend</h4>
                    <div id="legend-content">
                        <!-- Legend items will be added here dynamically -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <footer>
        <div class="footer-content">
            <div class="copyright">
                &copy; 2025 FireEMS.ai | Advanced Fire &amp; EMS Planning Tools
            </div>
        </div>
    </footer>
    
    <!-- Direct inline script to handle layer switching and drawing tools -->
    <script>
        // Add Leaflet.GeometryUtil for area calculations
        // Fixed version with Leaflet.Draw compatibility functions added
(function() {
    // Helper function for Leaflet.Draw compatibility
    var formatNum = function(num, digits) {
        var pow = Math.pow(10, (digits === undefined ? 0 : digits));
        return Math.round(num * pow) / pow;
    };
    
    // Required by Leaflet.Draw
    L.GeometryUtil = L.extend(L.GeometryUtil || {}, {
        // This function is specifically required by Leaflet.Draw
        isVersion07x: function() {
            // Check Leaflet version based on the most reliable method
            return true; // Default to true for our implementation
        },
        
        // All other functions from the original GeometryUtil
        distancePointLine: function(p, p1, p2) {
            var point = L.point(p),
                p1 = L.point(p1),
                p2 = L.point(p2),
                x = p2.x - p1.x,
                y = p2.y - p1.y,
                dot = x * x + y * y,
                t;

            if (dot > 0) {
                t = ((point.x - p1.x) * x + (point.y - p1.y) * y) / dot;
                if (t < 0) {
                    return point.distanceTo(p1);
                }
                if (t > 1) {
                    return point.distanceTo(p2);
                }
                return point.distanceTo(L.point(p1.x + t * x, p1.y + t * y));
            }
            return point.distanceTo(p1);
        },
        
        closest: function(map, layer, latlng, vertices) {
            if (!vertices || vertices.length === 0) {
                return null;
            }
            
            var mindist = Number.MAX_VALUE,
                result = null,
                distance,
                i, n, d;
                
            // Iterate through vertices
            for (i = 0, n = vertices.length; i < n-1; i++) {
                d = this.distanceSegment(map, latlng, vertices[i], vertices[i+1]);
                if (d < mindist) {
                    mindist = d;
                    result = this.closestOnSegment(map, latlng, vertices[i], vertices[i+1]);
                }
            }
            return result;
        },
        
        closestOnSegment: function(map, latlng, latlngA, latlngB) {
            var maxzoom = map.getMaxZoom();
            if (maxzoom === Infinity)
                maxzoom = map.getZoom();
            var p = map.project(latlng, maxzoom),
                p1 = map.project(latlngA, maxzoom),
                p2 = map.project(latlngB, maxzoom),
                closest = L.LineUtil.closestPointOnSegment(p, p1, p2);
            return map.unproject(closest, maxzoom);
        },
        
        distanceSegment: function(map, latlng, latlngA, latlngB) {
            var p = map.latLngToLayerPoint(latlng),
                p1 = map.latLngToLayerPoint(latlngA),
                p2 = map.latLngToLayerPoint(latlngB);
            return L.LineUtil.pointToSegmentDistance(p, p1, p2);
        },
        
        readableDistance: function(distance, unit, precision) {
            var precision = precision || 0;
            var units = {
                meters: 'm',
                kilometers: 'km',
                feet: 'ft',
                miles: 'mi'
            };
            
            if (unit === 'metric' || unit === undefined) {
                if (distance >= 1000) {
                    return formatNum(distance / 1000, precision) + ' ' + units.kilometers;
                } else {
                    return formatNum(distance, precision) + ' ' + units.meters;
                }
            } else {
                distance *= 3.28084; // Meters to feet
                if (distance >= 5280) {
                    return formatNum(distance / 5280, precision) + ' ' + units.miles;
                } else {
                    return formatNum(distance, precision) + ' ' + units.feet;
                }
            }
        },
        
        readableArea: function(area, unit, precision) {
            var precision = precision || 0;
            var units = {
                metric: ['m²', 'ha', 'km²'],
                imperial: ['ft²', 'ac', 'mi²']
            };
            
            if (unit === 'metric' || unit === undefined) {
                if (area >= 1000000) {
                    return formatNum(area / 1000000, precision) + ' ' + units.metric[2];
                } else if (area >= 10000) {
                    return formatNum(area / 10000, precision) + ' ' + units.metric[1];
                } else {
                    return formatNum(area, precision) + ' ' + units.metric[0];
                }
            } else {
                area *= 10.7639; // m² to ft²
                if (area >= 27878400) {
                    return formatNum(area / 27878400, precision) + ' ' + units.imperial[2];
                } else if (area >= 43560) {
                    return formatNum(area / 43560, precision) + ' ' + units.imperial[1];
                } else {
                    return formatNum(area, precision) + ' ' + units.imperial[0];
                }
            }
        },
        
        geodesicArea: function(latLngs) {
            var pointsCount = latLngs.length,
                area = 0,
                d2r = Math.PI / 180,
                p1, p2;

            if (pointsCount > 2) {
                for (var i = 0; i < pointsCount; i++) {
                    p1 = latLngs[i];
                    p2 = latLngs[(i + 1) % pointsCount];
                    area += ((p2.lng - p1.lng) * d2r) *
                            (2 + Math.sin(p1.lat * d2r) + Math.sin(p2.lat * d2r));
                }
                area = area * 6378137.0 * 6378137.0 / 2.0;
            }

            return Math.abs(area);
        },
        
        // Additional extensions for proper Leaflet.Draw compatibility
        formattedNumber: function(num, precision) {
            return formatNum(num, precision);
        }
    });
    
    // Add polygon getArea method
    L.Polygon.include({
        getArea: function() {
            return L.GeometryUtil.geodesicArea(this.getLatLngs()[0]);
        }
    });
    
    // Add polyline getDistance method
    L.Polyline.include({
        getDistance: function() {
            var distance = 0,
                i, len, latlngs = this.getLatLngs();
            
            for (i = 0, len = latlngs.length - 1; i < len; i++) {
                distance += latlngs[i].distanceTo(latlngs[i + 1]);
            }
            
            return distance;
        }
    });
})();
        
        // Wait for page load
        // Add a super high priority style before anything else loads
        (function() {
            var criticalStyle = document.createElement('style');
            criticalStyle.setAttribute('id', 'emergency-toolbar-fix');
            criticalStyle.innerHTML = `
                /* Critical toolbar visibility fixes with !important on everything */
                .leaflet-draw,
                .leaflet-draw.leaflet-control,
                .leaflet-draw-toolbar,
                .leaflet-draw-toolbar-top,
                .leaflet-draw-toolbar-bottom,
                .leaflet-draw-edit-edit,
                .leaflet-draw-edit-remove,
                .leaflet-draw-draw-polygon,
                .leaflet-draw-draw-rectangle,
                .leaflet-draw-draw-circle,
                .leaflet-draw-draw-marker,
                .leaflet-draw-draw-circlemarker,
                .leaflet-draw-draw-polyline {
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    z-index: 9999999 !important; /* Ultra-high z-index */
                    position: relative !important;
                    pointer-events: auto !important;
                }

                /* Force the map panes to stay behind */
                .leaflet-map-pane,
                .leaflet-objects-pane,
                .leaflet-tile-pane,
                .leaflet-overlay-pane,
                .leaflet-shadow-pane,
                .leaflet-marker-pane,
                .leaflet-popup-pane,
                .leaflet-tooltip-pane,
                .leaflet-zoom-animated {
                    z-index: 1 !important;
                }

                /* Ensure controls always appear */
                .leaflet-top, 
                .leaflet-right {
                    z-index: 9000000 !important;
                    position: absolute !important;
                    display: block !important;
                    visibility: visible !important;
                    opacity: 1 !important;
                    top: 10px !important;
                    right: 10px !important;
                }
            `;
            document.head.appendChild(criticalStyle);
        })();

        window.addEventListener('load', function() {
            console.log('*** DIRECT INITIALIZATION STARTING ***');
            
            // Create map and base layers
            var map = L.map('map', {
                center: [33.4484, -112.0740],  // Phoenix
                zoom: 11
            });
            
            // Create the base layers with specific names and CORS headers
            var streetLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                maxZoom: 19,
                crossOrigin: "anonymous"
            });
            
            var satelliteLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=s&x={x}&y={y}&z={z}', {
                attribution: 'Imagery &copy; Google',
                maxZoom: 20,
                crossOrigin: "anonymous"
            });
            
            var terrainLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
                attribution: 'Terrain &copy; Google',
                maxZoom: 20,
                crossOrigin: "anonymous"
            });
            
            // Add the street layer by default
            streetLayer.addTo(map);
            
            // Set up layer storage for the main script
            window.map = map;
            window.streetLayer = streetLayer;
            window.satelliteLayer = satelliteLayer;
            window.terrainLayer = terrainLayer;
            
            // Set up direct layer switching
            function switchBaseLayer(layerName) {
                console.log('Switching to layer:', layerName);
                
                // Remove all current base layers
                if (map.hasLayer(streetLayer)) map.removeLayer(streetLayer);
                if (map.hasLayer(satelliteLayer)) map.removeLayer(satelliteLayer);
                if (map.hasLayer(terrainLayer)) map.removeLayer(terrainLayer);
                
                // Add the selected layer
                if (layerName === 'street') {
                    map.addLayer(streetLayer);
                    document.getElementById('street-layer').checked = true;
                } 
                else if (layerName === 'satellite') {
                    map.addLayer(satelliteLayer);
                    document.getElementById('satellite-layer').checked = true;
                }
                else if (layerName === 'terrain') {
                    map.addLayer(terrainLayer);
                    document.getElementById('terrain-layer').checked = true;
                }
            }
            
            // Add direct event listeners for radio buttons
            document.getElementById('street-layer').addEventListener('click', function() {
                switchBaseLayer('street');
            });
            
            document.getElementById('satellite-layer').addEventListener('click', function() {
                switchBaseLayer('satellite');
            });
            
            document.getElementById('terrain-layer').addEventListener('click', function() {
                switchBaseLayer('terrain');
            });
            
            // Set up drawing tools
            var drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            
            var drawControl = new L.Control.Draw({
                position: 'topright',
                draw: {
                    polyline: { shapeOptions: { color: '#1976d2', weight: 3 } },
                    polygon: { allowIntersection: false, shapeOptions: { color: '#1976d2', weight: 3 } },
                    rectangle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                    circle: { shapeOptions: { color: '#1976d2', weight: 2 } },
                    marker: true
                },
                edit: {
                    featureGroup: drawnItems,
                    remove: true
                }
            });
            
            // Storage for toggles
            window.drawControlActive = false;
            
            // Initialize the controls with empty objects to prevent null errors
            var searchControl, mapStatusUpdater;
            
            // Add search control to find addresses
            searchControl = new L.Control.Search({
                position: 'topright',
                layer: L.layerGroup(),
                initial: false,
                propertyName: 'addr',
                zoom: 16,
                marker: false,
                textErr: 'Address not found',
                textCancel: 'Cancel',
                textPlaceholder: 'Search...',
                collapsed: false,
                autoCollapse: false,
                autoType: false,
                minLength: 2
            });
            
            // Add OSM geocoding provider (doesn't require API key)
            searchControl.on('search:locationfound', function(e) {
                var latlng = e.latlng;
                var marker = L.marker(latlng).addTo(map);
                var msg = 'Address found: ' + e.text;
                document.getElementById('search-results').innerHTML = '<p>' + msg + '</p>';
            });
            
            // COMPLETELY NEW APPROACH - Fixed position toolbar at the bottom of the screen
            document.getElementById('draw-tool').addEventListener('click', function() {
                console.log('Draw tool clicked');
                
                var drawButton = this;
                window.drawControlActive = !window.drawControlActive;
                document.getElementById('measurement-info').style.display = window.drawControlActive ? 'block' : 'none';
                
                if (!window.drawControlActive) {
                    // Remove floating toolbar if it exists
                    try {
                        var floatingToolbar = document.getElementById('floating-draw-toolbar');
                        if (floatingToolbar) {
                            document.body.removeChild(floatingToolbar);
                        }
                        
                        var drawOverlay = document.getElementById('draw-mode-overlay');
                        if (drawOverlay) {
                            document.body.removeChild(drawOverlay);
                        }
                        
                        // Disable any active handlers
                        if (window.activeHandler) {
                            window.activeHandler.disable();
                            window.activeHandler = null;
                        }
                        
                        drawButton.classList.remove('active');
                    } catch (e) {
                        console.error('Error removing drawing toolbar:', e);
                    }
                } else {
                    try {
                        // Create a fixed position toolbar at the BOTTOM of the screen
                        var toolbar = document.createElement('div');
                        toolbar.id = 'floating-draw-toolbar';
                        
                        // NOTE: We're applying styles directly as inline style attributes for maximum compatibility
                        toolbar.style.position = 'fixed';
                        toolbar.style.bottom = '20px';
                        toolbar.style.left = '50%';
                        toolbar.style.transform = 'translateX(-50%)';
                        toolbar.style.backgroundColor = 'white';
                        toolbar.style.boxShadow = '0 0 10px rgba(0,0,0,0.3)';
                        toolbar.style.borderRadius = '8px';
                        toolbar.style.padding = '10px 15px';
                        toolbar.style.display = 'flex';
                        toolbar.style.gap = '15px';
                        toolbar.style.alignItems = 'center';
                        toolbar.style.zIndex = '999999999'; // Ultra-high z-index
                        
                        // Create the drawing tools
                        var tools = [
                            { name: 'Line', icon: 'fa-share-alt', type: 'polyline' },
                            { name: 'Polygon', icon: 'fa-draw-polygon', type: 'polygon' },
                            { name: 'Rectangle', icon: 'fa-square', type: 'rectangle' },
                            { name: 'Circle', icon: 'fa-circle', type: 'circle' },
                            { name: 'Marker', icon: 'fa-map-marker-alt', type: 'marker' },
                            { name: 'Edit', icon: 'fa-edit', type: 'edit' },
                            { name: 'Delete', icon: 'fa-trash-alt', type: 'remove' },
                            { name: 'Close', icon: 'fa-times', type: 'close' }
                        ];
                        
                        // Create Draw control for the options (but don't add it to the map)
                        drawControl = new L.Control.Draw({
                            position: 'topright', // Won't matter since we're not adding it to the map
                            draw: {
                                polyline: { 
                                    shapeOptions: { color: '#1976d2', weight: 3 },
                                    metric: true,
                                    showLength: true
                                },
                                polygon: { 
                                    allowIntersection: false,
                                    showArea: true,
                                    metric: true,
                                    shapeOptions: { color: '#1976d2', weight: 3 }
                                },
                                rectangle: { 
                                    showArea: true,
                                    metric: true,
                                    shapeOptions: { color: '#1976d2', weight: 2 }
                                },
                                circle: { 
                                    showRadius: true,
                                    metric: true,
                                    shapeOptions: { color: '#1976d2', weight: 2 }
                                },
                                marker: true
                            },
                            edit: {
                                featureGroup: drawnItems,
                                remove: true
                            }
                        });
                        
                        // Function to handle tool activation
                        function activateDrawingTool(type) {
                            console.log('Activating drawing tool:', type);
                            
                            // First disable any active handlers
                            if (window.activeHandler) {
                                window.activeHandler.disable();
                                window.activeHandler = null;
                            }
                            
                            // Handle close button
                            if (type === 'close') {
                                // Toggle off drawing mode
                                document.getElementById('draw-tool').click();
                                return;
                            }
                            
                            // Update visual state of buttons
                            tools.forEach(function(t) {
                                var btn = document.getElementById('tool-' + t.type);
                                if (btn) {
                                    if (t.type === type) {
                                        // Active button
                                        btn.style.backgroundColor = '#1976d2';
                                        var icon = btn.querySelector('i');
                                        if (icon) icon.style.color = 'white';
                                    } else if (t.type !== 'close') {
                                        // Inactive buttons (except close)
                                        btn.style.backgroundColor = 'white';
                                        var icon = btn.querySelector('i');
                                        if (icon) icon.style.color = '#333';
                                    }
                                }
                            });
                            
                            // Create and enable the appropriate handler
                            if (type === 'polyline') {
                                window.activeHandler = new L.Draw.Polyline(map, drawControl.options.draw.polyline);
                                window.activeHandler.enable();
                            } 
                            else if (type === 'polygon') {
                                window.activeHandler = new L.Draw.Polygon(map, drawControl.options.draw.polygon);
                                window.activeHandler.enable();
                            }
                            else if (type === 'rectangle') {
                                window.activeHandler = new L.Draw.Rectangle(map, drawControl.options.draw.rectangle);
                                window.activeHandler.enable();
                            }
                            else if (type === 'circle') {
                                window.activeHandler = new L.Draw.Circle(map, drawControl.options.draw.circle);
                                window.activeHandler.enable();
                            }
                            else if (type === 'marker') {
                                window.activeHandler = new L.Draw.Marker(map, drawControl.options.draw.marker);
                                window.activeHandler.enable();
                            }
                            else if (type === 'edit') {
                                window.activeHandler = new L.EditToolbar.Edit(map, {
                                    featureGroup: drawnItems,
                                    selectedPathOptions: {
                                        maintainColor: true,
                                        dashArray: '10, 10'
                                    }
                                });
                                window.activeHandler.enable();
                            }
                            else if (type === 'remove') {
                                window.activeHandler = new L.EditToolbar.Delete(map, {
                                    featureGroup: drawnItems
                                });
                                window.activeHandler.enable();
                            }
                            
                            // Update measurement panel
                            var measurementResults = document.getElementById('measurement-results');
                            if (measurementResults) {
                                measurementResults.innerHTML = '<p>Active tool: ' + type + '</p>';
                            }
                        }
                        
                        // Add buttons to the toolbar
                        tools.forEach(function(tool) {
                            var button = document.createElement('button');
                            button.id = 'tool-' + tool.type;
                            
                            // Apply all styles directly to button
                            button.style.width = tool.type === 'close' ? '40px' : '60px';
                            button.style.height = tool.type === 'close' ? '40px' : '60px';
                            button.style.border = tool.type === 'close' ? 'none' : '1px solid #ddd';
                            button.style.borderRadius = '8px';
                            button.style.backgroundColor = 'white';
                            button.style.cursor = 'pointer';
                            button.style.display = 'flex';
                            button.style.flexDirection = 'column';
                            button.style.alignItems = 'center';
                            button.style.justifyContent = 'center';
                            button.style.padding = '5px';
                            
                            // Create icon
                            var icon = document.createElement('i');
                            icon.className = 'fas ' + tool.icon;
                            icon.style.fontSize = tool.type === 'close' ? '18px' : '22px';
                            icon.style.marginBottom = '5px';
                            icon.style.color = tool.type === 'close' ? '#f44336' : '#333';
                            button.appendChild(icon);
                            
                            // Add label for everything except close
                            if (tool.type !== 'close') {
                                var label = document.createElement('span');
                                label.textContent = tool.name;
                                label.style.fontSize = '12px';
                                button.appendChild(label);
                            }
                            
                            // Add click handler
                            button.addEventListener('click', function() {
                                activateDrawingTool(tool.type);
                            });
                            
                            // Add to toolbar
                            toolbar.appendChild(button);
                        });
                        
                        // Add the toolbar to the document body (completely outside the map)
                        document.body.appendChild(toolbar);
                        
                        // Create a semi-transparent overlay to indicate drawing mode is active
                        var overlay = document.createElement('div');
                        overlay.id = 'draw-mode-overlay';
                        
                        // Apply styles directly to ensure maximum compatibility
                        overlay.style.position = 'fixed';
                        overlay.style.top = '0';
                        overlay.style.left = '0';
                        overlay.style.right = '0';
                        overlay.style.bottom = '0';
                        overlay.style.backgroundColor = 'rgba(0,0,0,0.05)';
                        overlay.style.pointerEvents = 'none';
                        overlay.style.zIndex = '1000000'; // High but below toolbar
                        
                        // Add the overlay to the document body
                        document.body.appendChild(overlay);
                        
                        // Update button state
                        drawButton.classList.add('active');
                        
                        // Show the measurement info panel
                        document.getElementById('measurement-info').style.display = 'block';
                        
                        // Update measurement instructions
                        var measurementDisplay = document.getElementById('measurement-display');
                        if (measurementDisplay) {
                            measurementDisplay.innerHTML = `
                                <p>Drawing mode is active. Use the toolbar at the bottom of the screen:</p>
                                <ul>
                                    <li>Select a tool from the toolbar</li>
                                    <li>Click or drag on the map to draw</li>
                                    <li>Use Edit to modify shapes</li>
                                    <li>Use Delete to remove shapes</li>
                                </ul>
                            `;
                        }
                    } catch (e) {
                        console.error('Error adding draw control:', e);
                        alert('Error setting up drawing tools. Please refresh the page and try again.');
                    }
                }
            });
            
            // Create draw objects to handle created shapes
            map.on(L.Draw.Event.CREATED, function(event) {
                var layer = event.layer;
                drawnItems.addLayer(layer);
                console.log('Shape created:', event.layerType);
                
                // Calculate measurements for the created shape
                var measurementDiv = document.getElementById('measurement-results');
                if (measurementDiv) {
                    var measurementText = '';
                    
                    // Handle different shape types
                    if (event.layerType === 'polyline') {
                        // Get total distance of the line
                        var latlngs = layer.getLatLngs();
                        var totalDistance = 0;
                        
                        for (var i = 0; i < latlngs.length - 1; i++) {
                            totalDistance += latlngs[i].distanceTo(latlngs[i + 1]);
                        }
                        
                        // Format distance (meters to kilometers if applicable)
                        if (totalDistance >= 1000) {
                            measurementText = 'Distance: ' + (totalDistance / 1000).toFixed(2) + ' km';
                        } else {
                            measurementText = 'Distance: ' + Math.round(totalDistance) + ' m';
                        }
                    } 
                    else if (event.layerType === 'polygon' || event.layerType === 'rectangle') {
                        // Calculate area in square meters
                        var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                        
                        // Format area (m² to km² or hectares if applicable)
                        if (area >= 1000000) {
                            measurementText = 'Area: ' + (area / 1000000).toFixed(2) + ' km²';
                        } else if (area >= 10000) {
                            measurementText = 'Area: ' + (area / 10000).toFixed(2) + ' hectares';
                        } else {
                            measurementText = 'Area: ' + Math.round(area) + ' m²';
                        }
                    }
                    else if (event.layerType === 'circle') {
                        // Get radius in meters
                        var radius = layer.getRadius();
                        var area = Math.PI * radius * radius;
                        
                        // Format radius and area
                        if (radius >= 1000) {
                            measurementText = 'Radius: ' + (radius / 1000).toFixed(2) + ' km<br>';
                        } else {
                            measurementText = 'Radius: ' + Math.round(radius) + ' m<br>';
                        }
                        
                        if (area >= 1000000) {
                            measurementText += 'Area: ' + (area / 1000000).toFixed(2) + ' km²';
                        } else if (area >= 10000) {
                            measurementText += 'Area: ' + (area / 10000).toFixed(2) + ' hectares';
                        } else {
                            measurementText += 'Area: ' + Math.round(area) + ' m²';
                        }
                    }
                    else if (event.layerType === 'marker') {
                        var latlng = layer.getLatLng();
                        measurementText = 'Coordinates: ' + 
                            latlng.lat.toFixed(6) + ', ' + 
                            latlng.lng.toFixed(6);
                    }
                    
                    // Display the measurement
                    if (measurementText) {
                        measurementDiv.innerHTML = '<p>' + measurementText + '</p>';
                        
                        // Show the measurement panel if not already visible
                        document.getElementById('measurement-info').style.display = 'block';
                    }
                }
            });
            
            // Update map status bar
            function updateMapStatus() {
                var center = map.getCenter();
                var zoom = map.getZoom();
                
                document.getElementById('zoom-level').textContent = zoom;
                document.getElementById('map-center').textContent = center.lat.toFixed(4) + ', ' + center.lng.toFixed(4);
                
                // Calculate scale in meters/km at current zoom
                var bounds = map.getBounds();
                var centerLat = center.lat;
                var distance = bounds.getNorthEast().distanceTo(bounds.getSouthWest());
                var scale = distance / Math.sqrt(2);
                
                var scaleText = scale >= 1000 ? (scale / 1000).toFixed(1) + ' km' : Math.round(scale) + ' m';
                document.getElementById('map-scale').textContent = scaleText;
            }
            
            // Update mouse position on mousemove
            map.on('mousemove', function(e) {
                document.getElementById('mouse-position').textContent = 
                    e.latlng.lat.toFixed(4) + ', ' + e.latlng.lng.toFixed(4);
            });
            
            // Update map status on zoom/move
            map.on('zoomend moveend', updateMapStatus);
            updateMapStatus();
            
            // Set up search button functionality
            document.getElementById('search-btn').addEventListener('click', function() {
                var searchInput = document.getElementById('address-search').value;
                if (searchInput) {
                    // Use Nominatim for geocoding (no API key required)
                    var url = 'https://nominatim.openstreetmap.org/search?format=json&q=' + encodeURIComponent(searchInput);
                    
                    // Show searching status
                    document.getElementById('search-results').innerHTML = '<p>Searching...</p>';
                    
                    // Make the request
                    fetch(url)
                        .then(response => response.json())
                        .then(data => {
                            if (data && data.length > 0) {
                                var location = data[0];
                                var lat = parseFloat(location.lat);
                                var lon = parseFloat(location.lon);
                                
                                // Center map on result
                                map.setView([lat, lon], 15);
                                
                                // Add marker
                                var marker = L.marker([lat, lon]).addTo(map);
                                marker.bindPopup(location.display_name).openPopup();
                                
                                // Show result
                                document.getElementById('search-results').innerHTML = 
                                    '<p>Found: ' + location.display_name + '</p>';
                            } else {
                                document.getElementById('search-results').innerHTML = 
                                    '<p>No results found. Try a different search term.</p>';
                            }
                        })
                        .catch(error => {
                            console.error('Error searching:', error);
                            document.getElementById('search-results').innerHTML = 
                                '<p>Error searching. Please try again.</p>';
                        });
                }
            });
            
            // Search on Enter key
            document.getElementById('address-search').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    document.getElementById('search-btn').click();
                }
            });
            
            // Implement drag and drop functionality for icons
            function setupIconDragAndDrop() {
                console.log('Setting up icon drag functionality');
                
                // Get all draggable icons
                var draggableIcons = document.querySelectorAll('.draggable-icon');
                
                draggableIcons.forEach(function(icon) {
                    // Make them draggable
                    icon.setAttribute('draggable', 'true');
                    
                    // Set up drag start event
                    icon.addEventListener('dragstart', function(e) {
                        console.log('Drag started for icon:', this.dataset.icon);
                        // Store the icon type and color
                        var iconType = this.dataset.icon;
                        var iconColor = document.getElementById('icon-color').value;
                        
                        e.dataTransfer.setData('text/plain', JSON.stringify({
                            type: iconType,
                            color: iconColor
                        }));
                        
                        // Set drag image
                        var dragIcon = document.createElement('img');
                        dragIcon.src = 'data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7'; // 1px transparent
                        dragIcon.style.visibility = 'hidden';
                        document.body.appendChild(dragIcon);
                        e.dataTransfer.setDragImage(dragIcon, 0, 0);
                    });
                });
                
                // Set up the map as a drop target
                map.getContainer().addEventListener('dragover', function(e) {
                    e.preventDefault(); // Allow drop
                });
                
                map.getContainer().addEventListener('drop', function(e) {
                    e.preventDefault();
                    
                    try {
                        // Get drop coordinates
                        var rect = map.getContainer().getBoundingClientRect();
                        var x = e.clientX - rect.left;
                        var y = e.clientY - rect.top;
                        var latlng = map.containerPointToLatLng([x, y]);
                        
                        // Get icon data
                        var iconData = JSON.parse(e.dataTransfer.getData('text/plain'));
                        var iconType = iconData.type;
                        var iconColor = iconData.color;
                        
                        console.log('Dropped icon:', iconType, 'at', latlng.toString());
                        
                        // Create an appropriate icon based on the type
                        var iconHtml = '';
                        switch(iconType) {
                            // Fire Department icons
                            case 'fire-station':
                                iconHtml = '<i class="fas fa-fire-extinguisher"></i>';
                                break;
                            case 'fire-engine':
                                iconHtml = '<i class="fas fa-truck"></i>';
                                break;
                            case 'ladder-truck':
                                iconHtml = '<i class="fas fa-truck-moving"></i>';
                                break;
                            case 'hydrant':
                                iconHtml = '<i class="fas fa-tint"></i>';
                                break;
                                
                            // Emergency Services icons
                            case 'hospital':
                                iconHtml = '<i class="fas fa-hospital"></i>';
                                break;
                            case 'ambulance':
                                iconHtml = '<i class="fas fa-ambulance"></i>';
                                break;
                            case 'medic':
                                iconHtml = '<i class="fas fa-user-md"></i>';
                                break;
                            case 'police':
                                iconHtml = '<i class="fas fa-shield-alt"></i>';
                                break;
                                
                            // Hazards & Warnings icons
                            case 'hazard':
                                iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
                                break;
                            case 'hazmat':
                                iconHtml = '<i class="fas fa-biohazard"></i>';
                                break;
                            case 'radiation':
                                iconHtml = '<i class="fas fa-radiation"></i>';
                                break;
                            case 'chemical':
                                iconHtml = '<i class="fas fa-flask"></i>';
                                break;
                                
                            // DOT Placard Types
                            case 'placard-flammable':
                                iconHtml = '<i class="fas fa-fire"></i>';
                                break;
                            case 'placard-explosive':
                                iconHtml = '<i class="fas fa-bomb"></i>';
                                break;
                            case 'placard-gas':
                                iconHtml = '<i class="fas fa-wind"></i>';
                                break;
                            case 'placard-corrosive':
                                iconHtml = '<i class="fas fa-skull-crossbones"></i>';
                                break;
                                
                            // Energy Systems
                            case 'bess':
                                iconHtml = '<i class="fas fa-car-battery"></i>';
                                break;
                            case 'solar':
                                iconHtml = '<i class="fas fa-solar-panel"></i>';
                                break;
                            case 'electric':
                                iconHtml = '<i class="fas fa-bolt"></i>';
                                break;
                            case 'utility-pole':
                                iconHtml = '<i class="fas fa-broadcast-tower"></i>';
                                break;
                                
                            // Command & Control
                            case 'command-post':
                                iconHtml = '<i class="fas fa-laptop-house"></i>';
                                break;
                            case 'staging-area':
                                iconHtml = '<i class="fas fa-people-carry"></i>';
                                break;
                            case 'evacuation':
                                iconHtml = '<i class="fas fa-running"></i>';
                                break;
                            case 'helicopter':
                                iconHtml = '<i class="fas fa-helicopter"></i>';
                                break;
                                
                            // Legacy icons (keeping for compatibility)
                            case 'school':
                                iconHtml = '<i class="fas fa-school"></i>';
                                break;
                            case 'building':
                                iconHtml = '<i class="fas fa-building"></i>';
                                break;
                            case 'landmark':
                                iconHtml = '<i class="fas fa-landmark"></i>';
                                break;
                            case 'warning':
                                iconHtml = '<i class="fas fa-exclamation-triangle"></i>';
                                break;
                            case 'biohazard':
                                iconHtml = '<i class="fas fa-biohazard"></i>';
                                break;
                            case 'marker':
                                iconHtml = '<i class="fas fa-map-marker-alt"></i>';
                                break;
                            case 'target':
                                iconHtml = '<i class="fas fa-crosshairs"></i>';
                                break;
                                
                            // Default fallback
                            default:
                                iconHtml = '<i class="fas fa-map-marker-alt"></i>';
                        }
                        
                        // Create a divIcon with the font awesome icon
                        var customIcon = L.divIcon({
                            html: iconHtml,
                            className: 'custom-div-icon',
                            iconSize: [30, 30],
                            iconAnchor: [15, 15]
                        });
                        
                        // Create marker with the icon
                        var marker = L.marker(latlng, {
                            icon: customIcon,
                            draggable: true
                        }).addTo(map);
                        
                        // Format icon type name for display
                        var iconTypeName = iconType
                            .split('-')
                            .map(word => word.charAt(0).toUpperCase() + word.slice(1))
                            .join(' ');
                            
                        // Create more descriptive popups for special icon types
                        var popupContent = '<div style="text-align:center;">';
                        
                        // Add icon
                        popupContent += '<div style="font-size: 24px; margin-bottom: 5px; color:' + iconColor + ';">' + iconHtml + '</div>';
                        
                        // Add title
                        popupContent += '<b>' + iconTypeName + '</b><br>';
                        
                        // Add specific descriptions for special icon types
                        if (iconType === 'bess') {
                            popupContent += '<span style="font-size: 0.9em; display: block; margin: 5px 0;">Battery Energy Storage System</span>';
                        } 
                        else if (iconType.startsWith('placard-')) {
                            popupContent += '<span style="font-size: 0.9em; display: block; margin: 5px 0;">DOT Placard: ' + 
                                iconType.replace('placard-', '').toUpperCase() + '</span>';
                        }
                        
                        // Add delete button
                        popupContent += '<button class="delete-marker" style="margin-top: 8px; background-color: #f44336; color: white; border: none; padding: 5px 10px; border-radius: 3px; cursor: pointer;">Delete</button>';
                        
                        popupContent += '</div>';
                        
                        // Bind popup
                        marker.bindPopup(popupContent);
                        
                        // Style the icon with selected color
                        marker.getElement().querySelector('i').style.color = iconColor;
                        
                        // Add delete functionality
                        marker.on('popupopen', function() {
                            setTimeout(function() {
                                document.querySelector('.delete-marker').addEventListener('click', function() {
                                    map.removeLayer(marker);
                                });
                            }, 10);
                        });
                        
                        // Flash confirmation
                        var flashDiv = document.createElement('div');
                        flashDiv.innerHTML = 'Icon added!';
                        flashDiv.style.position = 'fixed';
                        flashDiv.style.left = (e.clientX + 10) + 'px';
                        flashDiv.style.top = (e.clientY - 20) + 'px';
                        flashDiv.style.backgroundColor = 'rgba(0,0,0,0.7)';
                        flashDiv.style.color = 'white';
                        flashDiv.style.padding = '5px 10px';
                        flashDiv.style.borderRadius = '3px';
                        flashDiv.style.zIndex = '10000';
                        document.body.appendChild(flashDiv);
                        
                        setTimeout(function() {
                            document.body.removeChild(flashDiv);
                        }, 1000);
                    } catch (error) {
                        console.error('Error dropping icon:', error);
                    }
                });
                
                console.log('Icon drag and drop set up complete');
            }
            
            // We need to update the setupIconDragAndDrop function to make sure it properly binds to all new icons
            // Call this function only after the page is fully loaded
            window.addEventListener('load', function() {
                // Ensure that all icon elements are fully loaded in the DOM
                setTimeout(function() {
                    setupIconDragAndDrop();
                    console.log('Icon drag and drop initialized with all new icons');
                }, 500);
            });
            
            // Fix for common measurement issues
            function improveDrawMeasurements() {
                // Create measurement styles
                var measureStyle = document.createElement('style');
                measureStyle.textContent = `
                    .leaflet-popup-content {
                        min-width: 150px;
                    }
                    .measurement-popup {
                        padding: 5px;
                        text-align: center;
                    }
                    .measurement-value {
                        font-weight: bold;
                        font-size: 1.1em;
                    }
                `;
                document.head.appendChild(measureStyle);
                
                // Helper function for measuring polylines
                function measurePolyline(latlngs) {
                    var totalLength = 0;
                    for (var i = 0; i < latlngs.length - 1; i++) {
                        totalLength += latlngs[i].distanceTo(latlngs[i + 1]);
                    }
                    return totalLength;
                }
                
                // Helper function for formatting distances
                function formatDistance(meters) {
                    if (meters >= 1000) {
                        return (meters / 1000).toFixed(2) + ' km';
                    } else {
                        return Math.round(meters) + ' m';
                    }
                }
                
                // Helper function for formatting areas
                function formatArea(sqMeters) {
                    if (sqMeters >= 1000000) {
                        return (sqMeters / 1000000).toFixed(2) + ' km²';
                    } else if (sqMeters >= 10000) {
                        return (sqMeters / 10000).toFixed(2) + ' ha';
                    } else {
                        return Math.round(sqMeters) + ' m²';
                    }
                }
                
                // Make sure the L.Draw.Event listeners add measurements
                map.on(L.Draw.Event.CREATED, function(e) {
                    var layer = e.layer;
                    drawnItems.addLayer(layer);
                    
                    var popup = document.createElement('div');
                    popup.className = 'measurement-popup';
                    var heading = document.createElement('div');
                    heading.style.fontWeight = 'bold';
                    
                    var measurementValue = document.createElement('div');
                    measurementValue.className = 'measurement-value';
                    
                    switch (e.layerType) {
                        case 'polyline':
                            var distance = measurePolyline(layer.getLatLngs());
                            heading.textContent = 'Distance:';
                            measurementValue.textContent = formatDistance(distance);
                            break;
                            
                        case 'polygon':
                        case 'rectangle':
                            var area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                            heading.textContent = 'Area:';
                            measurementValue.textContent = formatArea(area);
                            break;
                            
                        case 'circle':
                            var radius = layer.getRadius();
                            var area = Math.PI * radius * radius;
                            heading.textContent = 'Circle:';
                            measurementValue.innerHTML = 'Radius: ' + formatDistance(radius) + '<br>Area: ' + formatArea(area);
                            break;
                            
                        case 'marker':
                            var latlng = layer.getLatLng();
                            heading.textContent = 'Coordinates:';
                            measurementValue.textContent = latlng.lat.toFixed(6) + ', ' + latlng.lng.toFixed(6);
                            break;
                    }
                    
                    popup.appendChild(heading);
                    popup.appendChild(measurementValue);
                    
                    // Bind popup to shape
                    layer.bindPopup(popup).openPopup();
                    
                    // Update measurement display panel
                    var measurementDiv = document.getElementById('measurement-results');
                    if (measurementDiv) {
                        measurementDiv.innerHTML = popup.outerHTML;
                    }
                });
            }
            
            // Initialize measurement improvements
            improveDrawMeasurements();
            
            // Set up other tool buttons
            document.getElementById('search-tool').addEventListener('click', function() {
                var panel = document.getElementById('search-container');
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    this.classList.toggle('active');
                }
            });
            
            document.getElementById('filter-tool').addEventListener('click', function() {
                var panel = document.getElementById('filter-container');
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    this.classList.toggle('active');
                }
            });
            
            document.getElementById('export-tool').addEventListener('click', function() {
                var panel = document.getElementById('export-container');
                if (panel) {
                    panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
                    this.classList.toggle('active');
                }
            });
            
            // Implement export functionality
            function setupExportFunctions() {
                // Print Quality Export Button - Show/Hide Print Settings
                document.getElementById('export-print').addEventListener('click', function() {
                    var printOptions = document.getElementById('print-export-options');
                    if (printOptions) {
                        var isHidden = printOptions.style.display === 'none';
                        printOptions.style.display = isHidden ? 'block' : 'none';
                        
                        // Update button state
                        if (isHidden) {
                            this.classList.add('active');
                        } else {
                            this.classList.remove('active');
                        }
                    }
                });
                
                // Slider value display updates
                document.getElementById('print-line-thickness').addEventListener('input', function() {
                    document.getElementById('print-line-thickness-value').textContent = this.value;
                });
                
                document.getElementById('print-text-size').addEventListener('input', function() {
                    document.getElementById('print-text-size-value').textContent = this.value;
                });
                
                document.getElementById('print-logo-size').addEventListener('input', function() {
                    document.getElementById('print-logo-size-value').textContent = this.value;
                });
                
                document.getElementById('print-title-size').addEventListener('input', function() {
                    document.getElementById('print-title-size-value').textContent = this.value;
                });
                
                // Logo upload handling
                var logoFile = null;
                document.getElementById('print-logo-upload').addEventListener('change', function(e) {
                    var file = e.target.files[0];
                    if (file) {
                        if (file.type.match('image.*')) {
                            var reader = new FileReader();
                            
                            reader.onload = function(e) {
                                // Store the logo file data
                                logoFile = e.target.result;
                                
                                // Update filename display
                                document.getElementById('print-logo-filename').textContent = file.name;
                                
                                // Show logo preview
                                var preview = document.getElementById('print-logo-preview');
                                preview.style.display = 'block';
                                
                                var previewImg = document.getElementById('print-logo-preview-img');
                                previewImg.src = logoFile;
                            };
                            
                            reader.readAsDataURL(file);
                        } else {
                            alert('Please select an image file.');
                        }
                    }
                });
                
                // Remove logo button
                document.getElementById('print-logo-remove').addEventListener('click', function() {
                    logoFile = null;
                    document.getElementById('print-logo-filename').textContent = 'No file selected';
                    document.getElementById('print-logo-preview').style.display = 'none';
                    document.getElementById('print-logo-upload').value = '';
                });
                
                // Print Preview Button
                document.getElementById('print-preview-btn').addEventListener('click', function() {
                    try {
                        showPrintPreview();
                    } catch (error) {
                        console.error('Error showing print preview:', error);
                        alert('Error creating print preview: ' + error.message);
                    }
                });
                
                // Close Print Preview Modal
                document.querySelector('.print-preview-close').addEventListener('click', function() {
                    document.getElementById('print-preview-modal').style.display = 'none';
                });
                
                // Cancel Print Preview Button
                document.getElementById('print-preview-cancel').addEventListener('click', function() {
                    document.getElementById('print-preview-modal').style.display = 'none';
                });
                
                // Export from Print Preview
                document.getElementById('print-preview-export').addEventListener('click', function() {
                    try {
                        exportPrintQuality();
                    } catch (error) {
                        console.error('Error exporting print quality:', error);
                        alert('Error creating print export: ' + error.message);
                    }
                });
                
                // Direct Export Print Quality Button (without preview)
                document.getElementById('print-export-btn').addEventListener('click', function() {
                    try {
                        exportPrintQuality();
                    } catch (error) {
                        console.error('Error exporting print quality:', error);
                        alert('Error creating print export: ' + error.message);
                    }
                });
                
                /**
                 * Creates a print preview with bleed, trim, and safe zones
                 */
                function showPrintPreview() {
                    // Show the modal
                    var modal = document.getElementById('print-preview-modal');
                    modal.style.display = 'flex';
                    
                    // Get print settings
                    var paperSize = document.getElementById('print-size').value;
                    var orientation = document.getElementById('print-orientation').value;
                    var dpi = parseInt(document.getElementById('print-dpi').value);
                    var showBleed = document.getElementById('print-show-bleed').checked;
                    var showSafe = document.getElementById('print-show-safe').checked;
                    
                    // Get title and logo settings
                    var mapTitle = document.getElementById('print-map-title').value;
                    var titlePosition = document.getElementById('print-title-position').value;
                    var titleFont = document.getElementById('print-title-font').value;
                    var titleSize = parseInt(document.getElementById('print-title-size').value);
                    var titleColor = document.getElementById('print-title-color').value;
                    var logoPosition = document.getElementById('print-logo-position').value;
                    var logoSize = parseInt(document.getElementById('print-logo-size').value);
                    
                    // Calculate dimensions in pixels based on the selected paper size and DPI
                    var dimensions = calculatePaperDimensions(paperSize, orientation, dpi);
                    
                    // Set up the canvas dimensions
                    var canvas = document.getElementById('print-preview-canvas');
                    var ctx = canvas.getContext('2d');
                    
                    canvas.width = dimensions.width;
                    canvas.height = dimensions.height;
                    
                    // Set up the overlay canvas for bleed, trim and safe zones
                    var overlay = document.getElementById('print-preview-overlay');
                    overlay.width = dimensions.width;
                    overlay.height = dimensions.height;
                    
                    // Scale the preview canvas to fit the modal
                    var scaleFactor = Math.min(
                        (window.innerWidth * 0.8) / dimensions.width,
                        (window.innerHeight * 0.7) / dimensions.height
                    );
                    
                    if (scaleFactor < 1) {
                        canvas.style.width = (dimensions.width * scaleFactor) + 'px';
                        canvas.style.height = (dimensions.height * scaleFactor) + 'px';
                        overlay.style.width = (dimensions.width * scaleFactor) + 'px';
                        overlay.style.height = (dimensions.height * scaleFactor) + 'px';
                    } else {
                        canvas.style.width = dimensions.width + 'px';
                        canvas.style.height = dimensions.height + 'px';
                        overlay.style.width = dimensions.width + 'px';
                        overlay.style.height = dimensions.height + 'px';
                    }
                    
                    // Fill with white background
                    ctx.fillStyle = 'white';
                    ctx.fillRect(0, 0, dimensions.width, dimensions.height);
                    
                    // Render the map to the canvas
                    renderMapForPrint(map, canvas, dimensions, function() {
                        // Add title and logo after map is rendered
                        if (mapTitle || logoFile) {
                            addTitleAndLogo(canvas, dimensions, mapTitle, titlePosition, titleFont, titleSize, titleColor, logoFile, logoPosition, logoSize);
                        }
                        
                        // Draw the bleed, trim, and safe zones on the overlay
                        if (showBleed || showSafe) {
                            drawPrintGuides(overlay, dimensions, showBleed, showSafe);
                        }
                    });
                }
                
                /**
                 * Adds a title and logo to the canvas
                 */
                function addTitleAndLogo(canvas, dimensions, title, titlePosition, titleFont, titleSize, titleColor, logo, logoPosition, logoSize) {
                    var ctx = canvas.getContext('2d');
                    var titleHeight = 0;
                    var titlePadding = Math.round(dimensions.height * 0.03); // 3% of canvas height
                    var safeAreaWidth = dimensions.width - (dimensions.bleedOffset + dimensions.safeZoneInset) * 2;
                    
                    // Add title if provided
                    if (title) {
                        // Calculate font size based on dimensions and user setting
                        var baseFontSize = Math.round(dimensions.height * 0.03); // 3% of height as base
                        var fontSize = baseFontSize * (titleSize / 2);
                        
                        // Use the selected font and color
                        ctx.font = 'bold ' + fontSize + 'px ' + titleFont;
                        ctx.textAlign = 'center';
                        ctx.fillStyle = titleColor;
                        
                        // Measure text for positioning
                        var titleWidth = ctx.measureText(title).width;
                        titleHeight = fontSize * 1.5; // Approximate height of text
                        
                        // Position the title
                        var titleX = dimensions.width / 2;
                        var titleY;
                        
                        if (titlePosition === 'top') {
                            // Title at top with padding from top of safe area
                            titleY = dimensions.bleedOffset + dimensions.safeZoneInset + titleHeight;
                        } else {
                            // Title at bottom with padding from bottom of safe area
                            titleY = dimensions.height - dimensions.bleedOffset - dimensions.safeZoneInset - titlePadding;
                        }
                        
                        // Draw title
                        ctx.fillText(title, titleX, titleY);
                    }
                    
                    // Add logo if provided
                    if (logo) {
                        var img = new Image();
                        img.src = logo;
                        
                        img.onload = function() {
                            // Determine logo dimensions with aspect ratio preserved
                            var maxLogoWidth = safeAreaWidth * 0.2 * logoSize/3; // 20% of safe width * size factor
                            var maxLogoHeight = dimensions.height * 0.15 * logoSize/3; // 15% of height * size factor
                            
                            var logoWidth, logoHeight;
                            
                            if (img.width / img.height > maxLogoWidth / maxLogoHeight) {
                                // Width constrained
                                logoWidth = maxLogoWidth;
                                logoHeight = logoWidth * (img.height / img.width);
                            } else {
                                // Height constrained
                                logoHeight = maxLogoHeight;
                                logoWidth = logoHeight * (img.width / img.height);
                            }
                            
                            // Determine logo position
                            var logoX, logoY;
                            var logoPadding = Math.round(dimensions.height * 0.02); // 2% padding
                            
                            switch (logoPosition) {
                                case 'top-left':
                                    logoX = dimensions.bleedOffset + dimensions.safeZoneInset + logoPadding;
                                    logoY = dimensions.bleedOffset + dimensions.safeZoneInset + logoPadding;
                                    break;
                                case 'top-right':
                                    logoX = dimensions.width - dimensions.bleedOffset - dimensions.safeZoneInset - logoPadding - logoWidth;
                                    logoY = dimensions.bleedOffset + dimensions.safeZoneInset + logoPadding;
                                    break;
                                case 'bottom-left':
                                    logoX = dimensions.bleedOffset + dimensions.safeZoneInset + logoPadding;
                                    logoY = dimensions.height - dimensions.bleedOffset - dimensions.safeZoneInset - logoPadding - logoHeight;
                                    break;
                                case 'bottom-right':
                                default:
                                    logoX = dimensions.width - dimensions.bleedOffset - dimensions.safeZoneInset - logoPadding - logoWidth;
                                    logoY = dimensions.height - dimensions.bleedOffset - dimensions.safeZoneInset - logoPadding - logoHeight;
                            }
                            
                            // Draw logo
                            ctx.drawImage(img, logoX, logoY, logoWidth, logoHeight);
                        };
                    }
                }
                
                /**
                 * Returns dimensions in pixels for various paper sizes at a given DPI
                 */
                function calculatePaperDimensions(paperSize, orientation, dpi) {
                    // Paper sizes in inches (width, height)
                    var sizes = {
                        'letter': [8.5, 11],
                        'legal': [8.5, 14],
                        'tabloid': [11, 17],
                        'a4': [8.27, 11.69],   // A4 in inches
                        'a3': [11.69, 16.54]   // A3 in inches
                    };
                    
                    // Get the base dimensions
                    var baseDimensions = sizes[paperSize];
                    if (!baseDimensions) {
                        baseDimensions = sizes['letter']; // Default to letter if not found
                    }
                    
                    // Adjust for orientation
                    var dimensions = {
                        width: baseDimensions[0] * dpi,
                        height: baseDimensions[1] * dpi
                    };
                    
                    if (orientation === 'landscape') {
                        dimensions = {
                            width: baseDimensions[1] * dpi,
                            height: baseDimensions[0] * dpi
                        };
                    }
                    
                    // Add bleed dimensions (0.125 inches on each side)
                    dimensions.bleedWidth = dimensions.width + (0.125 * dpi * 2);
                    dimensions.bleedHeight = dimensions.height + (0.125 * dpi * 2);
                    
                    // Calculate safe zone (0.25 inches inside the trim)
                    dimensions.safeZoneInset = 0.25 * dpi;
                    
                    // Bleed offset
                    dimensions.bleedOffset = 0.125 * dpi;
                    
                    return dimensions;
                }
                
                /**
                 * Renders the map to a canvas, optimized for print
                 */
                function renderMapForPrint(map, canvas, dimensions, callback) {
                    var ctx = canvas.getContext('2d');
                    
                    // Get current map bounds
                    var bounds = map.getBounds();
                    
                    // Create a hidden div for rendering
                    var renderContainer = document.createElement('div');
                    renderContainer.style.width = dimensions.width + 'px';
                    renderContainer.style.height = dimensions.height + 'px';
                    renderContainer.style.position = 'absolute';
                    renderContainer.style.top = '-9999px';
                    renderContainer.style.left = '-9999px';
                    document.body.appendChild(renderContainer);
                    
                    // Create a temporary map for rendering at high resolution
                    var tempMap = L.map(renderContainer, {
                        center: map.getCenter(),
                        zoom: map.getZoom(),
                        zoomControl: false,
                        attributionControl: false,
                        dragging: false,
                        touchZoom: false,
                        scrollWheelZoom: false,
                        doubleClickZoom: false,
                        boxZoom: false,
                        tap: false
                    });
                    
                    // Add the same base layer as the main map
                    var activeLayer = null;
                    if (map.hasLayer(window.streetLayer)) {
                        activeLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                            attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
                            maxZoom: 19
                        }).addTo(tempMap);
                    } else if (map.hasLayer(window.satelliteLayer)) {
                        activeLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                            attribution: 'Imagery &copy; Esri',
                            maxZoom: 19
                        }).addTo(tempMap);
                    } else if (map.hasLayer(window.terrainLayer)) {
                        activeLayer = L.tileLayer('https://mt1.google.com/vt/lyrs=p&x={x}&y={y}&z={z}', {
                            attribution: 'Terrain &copy; Google',
                            maxZoom: 20,
                            crossOrigin: "anonymous"
                        }).addTo(tempMap);
                    }
                    
                    // Set the map to the same bounds as the original map
                    tempMap.fitBounds(bounds);
                    
                    // Apply custom styling based on print settings
                    var lineThickness = parseInt(document.getElementById('print-line-thickness').value);
                    var textSize = parseInt(document.getElementById('print-text-size').value);
                    
                    // Copy drawn items to the temp map with adjusted styles
                    var drawnItemsCopy = new L.FeatureGroup();
                    tempMap.addLayer(drawnItemsCopy);
                    
                    drawnItems.eachLayer(function(layer) {
                        var copyLayer;
                        
                        if (layer instanceof L.Polyline) {
                            // This handles polylines and polygons
                            var options = {
                                color: layer.options.color,
                                weight: layer.options.weight * lineThickness,
                                opacity: 1,
                                fillOpacity: layer.options.fillOpacity ? 0.8 : 0
                            };
                            
                            if (layer instanceof L.Polygon) {
                                copyLayer = L.polygon(layer.getLatLngs(), options);
                            } else {
                                copyLayer = L.polyline(layer.getLatLngs(), options);
                            }
                        } 
                        else if (layer instanceof L.Circle) {
                            copyLayer = L.circle(layer.getLatLng(), {
                                radius: layer.getRadius(),
                                color: layer.options.color,
                                weight: layer.options.weight * lineThickness,
                                opacity: 1,
                                fillOpacity: 0.8
                            });
                        }
                        else if (layer instanceof L.Marker) {
                            copyLayer = L.marker(layer.getLatLng(), {
                                icon: layer.options.icon
                            });
                        }
                        
                        if (copyLayer) {
                            drawnItemsCopy.addLayer(copyLayer);
                        }
                    });
                    
                    // Wait for the map to stabilize, then render to canvas
                    setTimeout(function() {
                        html2canvas(renderContainer, {
                            useCORS: true,
                            allowTaint: true,
                            backgroundColor: '#ffffff',
                            scale: 1
                        }).then(function(renderedCanvas) {
                            // Copy the rendered canvas to our preview canvas
                            ctx.drawImage(renderedCanvas, 0, 0, dimensions.width, dimensions.height);
                            
                            // Clean up the temporary map
                            tempMap.remove();
                            document.body.removeChild(renderContainer);
                            
                            // Execute callback
                            if (callback) callback();
                        });
                    }, 1000);
                }
                
                /**
                 * Draws print guides (bleed, trim, safe zone) on the overlay canvas
                 */
                function drawPrintGuides(canvas, dimensions, showBleed, showSafe) {
                    var ctx = canvas.getContext('2d');
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    
                    // Draw bleed area (red)
                    if (showBleed) {
                        ctx.strokeStyle = 'rgba(255, 0, 0, 0.7)';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(0, 0, dimensions.width, dimensions.height);
                        
                        // Draw bleed edge explanation
                        ctx.fillStyle = 'rgba(255, 0, 0, 0.7)';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText('Bleed Edge', 10, 16);
                    }
                    
                    // Draw trim line (black)
                    ctx.strokeStyle = 'rgba(0, 0, 0, 0.7)';
                    ctx.lineWidth = 1;
                    ctx.strokeRect(
                        dimensions.bleedOffset, 
                        dimensions.bleedOffset, 
                        dimensions.width - (dimensions.bleedOffset * 2), 
                        dimensions.height - (dimensions.bleedOffset * 2)
                    );
                    
                    // Draw safe zone (blue)
                    if (showSafe) {
                        ctx.strokeStyle = 'rgba(0, 0, 255, 0.5)';
                        ctx.lineWidth = 1;
                        ctx.setLineDash([5, 5]);
                        ctx.strokeRect(
                            dimensions.bleedOffset + dimensions.safeZoneInset, 
                            dimensions.bleedOffset + dimensions.safeZoneInset, 
                            dimensions.width - ((dimensions.bleedOffset + dimensions.safeZoneInset) * 2), 
                            dimensions.height - ((dimensions.bleedOffset + dimensions.safeZoneInset) * 2)
                        );
                        ctx.setLineDash([]);
                        
                        // Draw safe zone explanation
                        ctx.fillStyle = 'rgba(0, 0, 255, 0.7)';
                        ctx.font = '12px Arial';
                        ctx.textAlign = 'left';
                        ctx.fillText('Safe Zone', 10, 36);
                    }
                }
                
                /**
                 * Convert RGB to CMYK for print-ready PDF
                 */
                function rgbToCmyk(r, g, b) {
                    try {
                        // Use the converter library if available
                        if (typeof kmc !== 'undefined') {
                            var cmyk = kmc.ColorConverter.rgbToCmyk(r, g, b);
                            return cmyk;
                        } else {
                            // Fallback manual conversion
                            // Normalize RGB values
                            var r1 = r / 255;
                            var g1 = g / 255;
                            var b1 = b / 255;
                            
                            // Calculate CMY
                            var k = Math.min(1 - r1, 1 - g1, 1 - b1);
                            var c = (1 - r1 - k) / (1 - k) || 0;
                            var m = (1 - g1 - k) / (1 - k) || 0;
                            var y = (1 - b1 - k) / (1 - k) || 0;
                            
                            // Convert to 0-100 range for printing
                            return {
                                c: Math.round(c * 100),
                                m: Math.round(m * 100),
                                y: Math.round(y * 100),
                                k: Math.round(k * 100)
                            };
                        }
                    } catch (error) {
                        console.error('Error converting RGB to CMYK:', error);
                        return { c: 0, m: 0, y: 0, k: 100 }; // Default to black on error
                    }
                }
                
                /**
                 * Export the map as a high-quality print PDF
                 */
                function exportPrintQuality() {
                    try {
                        // Get print settings
                        var paperSize = document.getElementById('print-size').value;
                        var orientation = document.getElementById('print-orientation').value;
                        var dpi = parseInt(document.getElementById('print-dpi').value);
                        var useCmyk = document.getElementById('print-cmyk').checked;
                        
                        // Get title and logo settings
                        var mapTitle = document.getElementById('print-map-title').value;
                        var titlePosition = document.getElementById('print-title-position').value;
                        var titleFont = document.getElementById('print-title-font').value;
                        var titleSize = parseInt(document.getElementById('print-title-size').value);
                        var titleColor = document.getElementById('print-title-color').value;
                        var logoPosition = document.getElementById('print-logo-position').value;
                        var logoSize = parseInt(document.getElementById('print-logo-size').value);
                        
                        // Calculate dimensions
                        var dimensions = calculatePaperDimensions(paperSize, orientation, dpi);
                        
                        // Get the current preview canvas if preview is active, or create a new one
                        var canvas;
                        
                        if (document.getElementById('print-preview-modal').style.display === 'flex') {
                            canvas = document.getElementById('print-preview-canvas');
                            
                            // Create PDF immediately if using preview
                            createPrintPdf(canvas, dimensions, paperSize, orientation, useCmyk);
                        } else {
                            // Show loading status
                            var statusDiv = document.createElement('div');
                            statusDiv.innerHTML = 'Preparing high-quality print export, please wait...';
                            statusDiv.style.position = 'fixed';
                            statusDiv.style.top = '50%';
                            statusDiv.style.left = '50%';
                            statusDiv.style.transform = 'translate(-50%, -50%)';
                            statusDiv.style.padding = '20px';
                            statusDiv.style.background = 'rgba(0,0,0,0.8)';
                            statusDiv.style.color = 'white';
                            statusDiv.style.borderRadius = '10px';
                            statusDiv.style.zIndex = '999999';
                            document.body.appendChild(statusDiv);
                            
                            // Create a new canvas
                            canvas = document.createElement('canvas');
                            canvas.width = dimensions.width;
                            canvas.height = dimensions.height;
                            
                            var ctx = canvas.getContext('2d');
                            ctx.fillStyle = 'white';
                            ctx.fillRect(0, 0, dimensions.width, dimensions.height);
                            
                            // Render the map to the canvas
                            renderMapForPrint(map, canvas, dimensions, function() {
                                // Add title and logo
                                if (mapTitle || logoFile) {
                                    // Add title and logo
                                    addTitleAndLogo(canvas, dimensions, mapTitle, titlePosition, titleFont, titleSize, titleColor, logoFile, logoPosition, logoSize);
                                    
                                    // Wait a bit for the logo to be loaded and rendered
                                    setTimeout(function() {
                                        // Continue with PDF creation
                                        createPrintPdf(canvas, dimensions, paperSize, orientation, useCmyk);
                                        
                                        // Remove status message
                                        document.body.removeChild(statusDiv);
                                    }, 500);
                                } else {
                                    // Continue with PDF creation immediately
                                    createPrintPdf(canvas, dimensions, paperSize, orientation, useCmyk);
                                    
                                    // Remove status message
                                    document.body.removeChild(statusDiv);
                                }
                            });
                        }
                    } catch (error) {
                        console.error('Error exporting for print:', error);
                        alert('Error creating print export: ' + error.message);
                    }
                }
                
                /**
                 * Create a print-ready PDF from the canvas
                 */
                function createPrintPdf(canvas, dimensions, paperSize, orientation, useCmyk) {
                    try {
                        // Get base paper size in points (72 points per inch)
                        var sizes = {
                            'letter': [612, 792],     // 8.5" x 11" in points
                            'legal': [612, 1008],     // 8.5" x 14" in points
                            'tabloid': [792, 1224],   // 11" x 17" in points
                            'a4': [595, 842],         // A4 in points
                            'a3': [842, 1191]         // A3 in points
                        };
                        
                        var pdfSize = sizes[paperSize] || sizes['letter'];
                        
                        // Adjust for orientation
                        if (orientation === 'landscape') {
                            pdfSize = [pdfSize[1], pdfSize[0]];
                        }
                        
                        // Create PDF with jsPDF
                        var pdf = new jspdf.jsPDF({
                            orientation: orientation,
                            unit: 'pt',
                            format: paperSize
                        });
                        
                        // Get image data from canvas
                        var imgData = canvas.toDataURL('image/jpeg', 1.0);
                        
                        // Process for CMYK if requested
                        if (useCmyk) {
                            var tempCanvas = document.createElement('canvas');
                            tempCanvas.width = canvas.width;
                            tempCanvas.height = canvas.height;
                            var tempCtx = tempCanvas.getContext('2d');
                            
                            // Draw the original image
                            var img = new Image();
                            img.src = imgData;
                            
                            // Process the image data for CMYK conversion
                            img.onload = function() {
                                tempCtx.drawImage(img, 0, 0);
                                var imageData = tempCtx.getImageData(0, 0, tempCanvas.width, tempCanvas.height);
                                var data = imageData.data;
                                
                                // Add black channel text
                                tempCtx.fillStyle = 'black';
                                tempCtx.font = 'bold 16pt Arial';
                                tempCtx.fillText('CMYK Optimized for Print', 20, canvas.height - 30);
                                tempCtx.fillText('FireMapPro Export - ' + new Date().toISOString().split('T')[0], 20, canvas.height - 10);
                                
                                // Get the updated image with text
                                imgData = tempCanvas.toDataURL('image/jpeg', 1.0);
                                
                                // Add the processed image to PDF
                                pdf.addImage(imgData, 'JPEG', 0, 0, pdfSize[0], pdfSize[1]);
                                
                                // Save the PDF
                                pdf.save('firemap-print-export-' + new Date().toISOString().split('T')[0] + '.pdf');
                            };
                        } else {
                            // Use the image directly without CMYK conversion
                            pdf.addImage(imgData, 'JPEG', 0, 0, pdfSize[0], pdfSize[1]);
                            
                            // Add metadata
                            pdf.setFontSize(12);
                            pdf.setTextColor(0, 0, 0);
                            pdf.text('FireMapPro Export - ' + new Date().toISOString().split('T')[0], 20, pdfSize[1] - 20);
                            
                            // Save the PDF
                            pdf.save('firemap-print-export-' + new Date().toISOString().split('T')[0] + '.pdf');
                        }
                        
                        // Hide the preview modal if it's open
                        document.getElementById('print-preview-modal').style.display = 'none';
                        
                    } catch (error) {
                        console.error('Error creating PDF:', error);
                        alert('Error creating PDF: ' + error.message);
                    }
                }
                // PDF Export
                document.getElementById('export-pdf').addEventListener('click', function() {
                    try {
                        console.log('Exporting map as PDF');
                        // Use html2canvas and jsPDF libraries for PDF export
                        if (typeof html2canvas === 'undefined' || typeof jspdf === 'undefined') {
                            // Load required libraries if not available
                            var html2canvasScript = document.createElement('script');
                            html2canvasScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                            document.head.appendChild(html2canvasScript);
                            
                            var jsPDFScript = document.createElement('script');
                            jsPDFScript.src = 'https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js';
                            document.head.appendChild(jsPDFScript);
                            
                            // Show message to wait
                            alert('PDF export libraries are loading. Please try again in a few seconds.');
                            return;
                        }
                        
                        // Create status message
                        var statusDiv = document.createElement('div');
                        statusDiv.innerHTML = 'Preparing PDF, please wait...';
                        statusDiv.style.position = 'fixed';
                        statusDiv.style.top = '50%';
                        statusDiv.style.left = '50%';
                        statusDiv.style.transform = 'translate(-50%, -50%)';
                        statusDiv.style.padding = '20px';
                        statusDiv.style.background = 'rgba(0,0,0,0.8)';
                        statusDiv.style.color = 'white';
                        statusDiv.style.borderRadius = '10px';
                        statusDiv.style.zIndex = '999999';
                        document.body.appendChild(statusDiv);
                        
                        var mapContainer = document.getElementById('map');
                        
                        // Temporarily remove any fixed position elements that could interfere
                        var fixedElements = document.querySelectorAll('#floating-draw-toolbar, #draw-mode-overlay');
                        fixedElements.forEach(function(el) {
                            if (el) el.style.display = 'none';
                        });
                        
                        setTimeout(function() {
                            html2canvas(mapContainer, {
                                useCORS: true,
                                allowTaint: true,
                                scale: 2 // Higher quality
                            }).then(function(canvas) {
                                // Restore any hidden elements
                                fixedElements.forEach(function(el) {
                                    if (el) el.style.display = '';
                                });
                                
                                // Get the image data
                                var imgData = canvas.toDataURL('image/jpeg', 0.9);
                                
                                // Create PDF with jsPDF
                                var pdf = new jspdf.jsPDF({
                                    orientation: 'landscape',
                                    unit: 'mm'
                                });
                                
                                // Calculate dimensions
                                var pdfWidth = pdf.internal.pageSize.getWidth();
                                var pdfHeight = pdf.internal.pageSize.getHeight();
                                var ratio = canvas.width / canvas.height;
                                var pdfImgWidth = pdfWidth;
                                var pdfImgHeight = pdfImgWidth / ratio;
                                
                                // Check if image is too tall for the page
                                if (pdfImgHeight > pdfHeight) {
                                    pdfImgHeight = pdfHeight;
                                    pdfImgWidth = pdfImgHeight * ratio;
                                }
                                
                                // Calculate centering
                                var x = (pdfWidth - pdfImgWidth) / 2;
                                var y = (pdfHeight - pdfImgHeight) / 2;
                                
                                // Add title
                                pdf.setFontSize(16);
                                pdf.text('FireMapPro - Map Export', pdfWidth / 2, 10, { align: 'center' });
                                
                                // Add timestamp
                                var now = new Date();
                                var timestamp = 'Created: ' + now.toLocaleDateString() + ' ' + now.toLocaleTimeString();
                                pdf.setFontSize(10);
                                pdf.text(timestamp, pdfWidth - 10, pdfHeight - 5, { align: 'right' });
                                
                                // Add the map image
                                pdf.addImage(imgData, 'JPEG', x, 15, pdfImgWidth, pdfImgHeight - 15);
                                
                                // Save the PDF
                                pdf.save('firemap-export-' + new Date().toISOString().split('T')[0] + '.pdf');
                                
                                // Remove status message
                                document.body.removeChild(statusDiv);
                            });
                        }, 500);
                    } catch (error) {
                        console.error('Error exporting PDF:', error);
                        alert('Error creating PDF export. Please make sure you have a stable internet connection and try again.');
                    }
                });
                
                // PNG Export
                document.getElementById('export-png').addEventListener('click', function() {
                    try {
                        console.log('Exporting map as PNG');
                        
                        // Check if html2canvas is available
                        if (typeof html2canvas === 'undefined') {
                            // Load html2canvas if not available
                            var script = document.createElement('script');
                            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js';
                            document.head.appendChild(script);
                            
                            // Show message to wait
                            alert('Image export library is loading. Please try again in a few seconds.');
                            return;
                        }
                        
                        // Create status message
                        var statusDiv = document.createElement('div');
                        statusDiv.innerHTML = 'Preparing PNG image, please wait...';
                        statusDiv.style.position = 'fixed';
                        statusDiv.style.top = '50%';
                        statusDiv.style.left = '50%';
                        statusDiv.style.transform = 'translate(-50%, -50%)';
                        statusDiv.style.padding = '20px';
                        statusDiv.style.background = 'rgba(0,0,0,0.8)';
                        statusDiv.style.color = 'white';
                        statusDiv.style.borderRadius = '10px';
                        statusDiv.style.zIndex = '999999';
                        document.body.appendChild(statusDiv);
                        
                        var mapContainer = document.getElementById('map');
                        
                        // Temporarily remove any fixed position elements that could interfere
                        var fixedElements = document.querySelectorAll('#floating-draw-toolbar, #draw-mode-overlay');
                        fixedElements.forEach(function(el) {
                            if (el) el.style.display = 'none';
                        });
                        
                        setTimeout(function() {
                            html2canvas(mapContainer, {
                                useCORS: true,
                                allowTaint: true,
                                scale: 2 // Higher quality
                            }).then(function(canvas) {
                                // Restore any hidden elements
                                fixedElements.forEach(function(el) {
                                    if (el) el.style.display = '';
                                });
                                
                                // Create download link
                                var link = document.createElement('a');
                                link.download = 'firemap-export-' + new Date().toISOString().split('T')[0] + '.png';
                                link.href = canvas.toDataURL('image/png');
                                link.click();
                                
                                // Remove status message
                                document.body.removeChild(statusDiv);
                            });
                        }, 500);
                    } catch (error) {
                        console.error('Error exporting PNG:', error);
                        alert('Error creating PNG export. Please make sure you have a stable internet connection and try again.');
                    }
                });
                
                // GeoJSON Export
                document.getElementById('export-geojson').addEventListener('click', function() {
                    try {
                        console.log('Exporting map as GeoJSON');
                        
                        // Check if we have any drawn items to export
                        if (drawnItems.getLayers().length === 0) {
                            alert('No shapes to export. Please draw something on the map first.');
                            return;
                        }
                        
                        // Convert the drawn items to GeoJSON
                        var geoJson = drawnItems.toGeoJSON();
                        
                        // Add some metadata to the GeoJSON
                        geoJson.properties = {
                            created: new Date().toISOString(),
                            creator: 'FireMapPro',
                            description: 'Exported map data'
                        };
                        
                        // Convert to string with pretty printing
                        var dataStr = JSON.stringify(geoJson, null, 2);
                        
                        // Create blob and download link
                        var blob = new Blob([dataStr], {type: 'application/json'});
                        var url = URL.createObjectURL(blob);
                        
                        var link = document.createElement('a');
                        link.download = 'firemap-export-' + new Date().toISOString().split('T')[0] + '.geojson';
                        link.href = url;
                        link.click();
                        
                        // Clean up
                        setTimeout(function() {
                            URL.revokeObjectURL(url);
                        }, 1000);
                        
                    } catch (error) {
                        console.error('Error exporting GeoJSON:', error);
                        alert('Error creating GeoJSON export: ' + error.message);
                    }
                });
            }
            
            // Initialize export functions
            setupExportFunctions();
            
            document.getElementById('icon-tool').addEventListener('click', function() {
                var panel = document.getElementById('icon-container');
                if (panel) {
                    var isHidden = panel.style.display === 'none';
                    panel.style.display = isHidden ? 'block' : 'none';
                    this.classList.toggle('active');
                    
                    // If showing the panel, ensure it's fully visible
                    if (isHidden) {
                        // Force a reflow to ensure all icon categories are displayed
                        panel.style.opacity = '0.99';
                        setTimeout(function() {
                            panel.style.opacity = '1';
                            
                            // Make sure the panel is scrolled to the top
                            var leftPanel = document.querySelector('.left-panel');
                            if (leftPanel) {
                                leftPanel.scrollTop = panel.offsetTop - 20;
                            }
                            
                            // Make sure draggable icons are properly initialized
                            setupIconDragAndDrop();
                        }, 100);
                    }
                }
            });
            
            document.getElementById('clear-map').addEventListener('click', function() {
                if (confirm('Are you sure you want to clear all items from the map?')) {
                    drawnItems.clearLayers();
                    console.log('Map cleared');
                }
            });
            
            console.log('*** DIRECT INITIALIZATION COMPLETED ***');
        });
    </script>
    
    <!-- Other scripts -->
    <script src="https://cdn.jsdelivr.net/npm/leaflet-search@3.0.2/dist/leaflet-search.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/leaflet-easybutton@2/src/easy-button.js"></script>
    <!-- Disable the main JS to use our inline solution instead -->
    <!-- <script src="{{ url_for('static', filename='fire-map-pro.js') }}"></script> -->
</body>
</html>