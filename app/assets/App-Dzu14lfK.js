var vs=Object.defineProperty;var Ts=(t,n,r)=>n in t?vs(t,n,{enumerable:!0,configurable:!0,writable:!0,value:r}):t[n]=r;var it=(t,n,r)=>Ts(t,typeof n!="symbol"?n+"":n,r);import{g as Ss,a as Es,r as O,u as Fs,j as e,s as ft,c as Cs,b as Ds,m as ws,d as _s,_ as ss,e as at,f as Ve,B as j,t as Lt,h as Is,C as Pe,i as $e,k as As,l as $s,n as rs,o as ke,p as me,R as Je,q as Me,v as Ms,G as Rs,w as Os,x as ks,y as Ns}from"./index-B5lWbLwU.js";import{U as zt}from"./CloudUpload-CPQfdteL.js";import{T as x,c as de,P as ge,u as Ot}from"./Typography-DMki5wnW.js";import{G as pe,C as ie}from"./listItemTextClasses-BBIYtGfQ.js";import{F as Le,I as Ue,S as Be,A as ce,a as Ce,T as be,b as Ps,M as Ls}from"./TextField-IG2KVE_R.js";import{M as oe}from"./MenuItem-D-W07C7S.js";import{B as se,L as ze}from"./List-CQy5Q7ZD.js";import{D as xe}from"./Divider-ENMwQoXd.js";import{S as zs,a as ns}from"./Save-C4nYe6TS.js";import{C as Vs,S as rt}from"./Search-BUDaZt1M.js";import{D as Ke,a as Xe,b as Ze,F as We,c as Qe}from"./FormControlLabel-B5iWds0E.js";import{F as Us}from"./FormGroup-DRWeJjo0.js";import{T as dt,a as ut,b as Re,c as Se,d as pt,e as wt}from"./TableRow-CFytwN-F.js";import{T as Ne,A as Bs,E as Hs}from"./Edit-DGBm2ePC.js";import{S as tt,L as Ys,C as _t,T as Ws,P as os,B as Gs}from"./PictureAsPdf-Dq9aIjy3.js";import{C as qe}from"./CheckCircle-Dy4GHrei.js";import{D as nt}from"./Delete-C9od7NLq.js";import{I as Ae}from"./InputAdornment-BCMbdPi4.js";import{A as as,a as is,E as xt,b as ls,C as cs}from"./ExpandMore-2m21-5Dd.js";import{S as ds}from"./Settings-BHa4_Mxn.js";import{E as us}from"./Error-K9_VR1yC.js";import{W as ps}from"./Warning-CscJ2g6K.js";import{T as Vt,E as ms,D as Tt}from"./dataTransformer-Dc4t_Gc0.js";import{T as yt,a as _e}from"./Tabs-_nsw1xEA.js";import{C as qs}from"./Close-C7VukF-C.js";import{H as Js}from"./HelpOutline-BHz4SJPA.js";import{L as Ee,a as Oe,b as Fe,c as It}from"./ListItemText-C9-x4uJu.js";import{B as St}from"./Business-aC2fwAnK.js";import{C as bt,a as jt}from"./CardContent-BDm5pA-7.js";import{S as hs}from"./Snackbar-BxOg0eMW.js";import{D as Ks}from"./Download-BslD_Al2.js";import{D as mt}from"./Description-CkKVmEGB.js";import{E as Xs}from"./jspdf.es.min-C0MDiPiq.js";import{T as Zs}from"./TableChart-BQbx0Upi.js";import{R as Qs,a as lt}from"./RadioGroup-ChQhlNUA.js";import{M as Ut}from"./Map-icACIrG4.js";import{T as er}from"./AccessTime-CfEYyQNr.js";import{T as tr}from"./Timeline-BCU9e6E_.js";import{C as sr}from"./CardActions-B38x-gIU.js";import{B as rr}from"./Badge-DCwCKRaG.js";import{S as nr,a as or,b as ar}from"./Stepper-ByrpAwZW.js";import"./Popper-Bnp4qOP1.js";function ir(t){return Ss("MuiAlertTitle",t)}Es("MuiAlertTitle",["root"]);const lr=t=>{const{classes:n}=t;return Ds({root:["root"]},ir,n)},cr=ft(x,{name:"MuiAlertTitle",slot:"Root",overridesResolver:(t,n)=>n.root})(ws(({theme:t})=>({fontWeight:t.typography.fontWeightMedium,marginTop:-2}))),dr=O.forwardRef(function(n,r){const s=Fs({props:n,name:"MuiAlertTitle"}),{className:o,...a}=s,c=s,p=lr(c);return e.jsx(cr,{gutterBottom:!0,component:"div",ownerState:c,ref:r,className:Cs(p.root,o),...a})}),kt=de(e.jsx("path",{d:"M10 6 8.59 7.41 13.17 12l-4.58 4.59L10 18l6-6z"}));var ct={exports:{}};/* @license
Papa Parse
v5.5.2
https://github.com/mholt/PapaParse
License: MIT
*/var ur=ct.exports,Bt;function pr(){return Bt||(Bt=1,function(t,n){((r,s)=>{t.exports=s()})(ur,function r(){var s=typeof self<"u"?self:typeof window<"u"?window:s!==void 0?s:{},o,a=!s.document&&!!s.postMessage,c=s.IS_PAPA_WORKER||!1,p={},u=0,d={};function m(i){this._handle=null,this._finished=!1,this._completed=!1,this._halted=!1,this._input=null,this._baseIndex=0,this._partialLine="",this._rowCount=0,this._start=0,this._nextChunk=null,this.isFirstChunk=!0,this._completeResults={data:[],errors:[],meta:{}},(function(l){var h=H(l);h.chunkSize=parseInt(h.chunkSize),l.step||l.chunk||(h.chunkSize=null),this._handle=new _(h),(this._handle.streamer=this)._config=h}).call(this,i),this.parseChunk=function(l,h){var D=parseInt(this._config.skipFirstNLines)||0;if(this.isFirstChunk&&0<D){let W=this._config.newline;W||(k=this._config.quoteChar||'"',W=this._handle.guessLineEndings(l,k)),l=[...l.split(W).slice(D)].join(W)}this.isFirstChunk&&G(this._config.beforeFirstChunk)&&(k=this._config.beforeFirstChunk(l))!==void 0&&(l=k),this.isFirstChunk=!1,this._halted=!1;var D=this._partialLine+l,k=(this._partialLine="",this._handle.parse(D,this._baseIndex,!this._finished));if(!this._handle.paused()&&!this._handle.aborted()){if(l=k.meta.cursor,D=(this._finished||(this._partialLine=D.substring(l-this._baseIndex),this._baseIndex=l),k&&k.data&&(this._rowCount+=k.data.length),this._finished||this._config.preview&&this._rowCount>=this._config.preview),c)s.postMessage({results:k,workerId:d.WORKER_ID,finished:D});else if(G(this._config.chunk)&&!h){if(this._config.chunk(k,this._handle),this._handle.paused()||this._handle.aborted())return void(this._halted=!0);this._completeResults=k=void 0}return this._config.step||this._config.chunk||(this._completeResults.data=this._completeResults.data.concat(k.data),this._completeResults.errors=this._completeResults.errors.concat(k.errors),this._completeResults.meta=k.meta),this._completed||!D||!G(this._config.complete)||k&&k.meta.aborted||(this._config.complete(this._completeResults,this._input),this._completed=!0),D||k&&k.meta.paused||this._nextChunk(),k}this._halted=!0},this._sendError=function(l){G(this._config.error)?this._config.error(l):c&&this._config.error&&s.postMessage({workerId:d.WORKER_ID,error:l,finished:!1})}}function y(i){var l;(i=i||{}).chunkSize||(i.chunkSize=d.RemoteChunkSize),m.call(this,i),this._nextChunk=a?function(){this._readChunk(),this._chunkLoaded()}:function(){this._readChunk()},this.stream=function(h){this._input=h,this._nextChunk()},this._readChunk=function(){if(this._finished)this._chunkLoaded();else{if(l=new XMLHttpRequest,this._config.withCredentials&&(l.withCredentials=this._config.withCredentials),a||(l.onload=K(this._chunkLoaded,this),l.onerror=K(this._chunkError,this)),l.open(this._config.downloadRequestBody?"POST":"GET",this._input,!a),this._config.downloadRequestHeaders){var h,D=this._config.downloadRequestHeaders;for(h in D)l.setRequestHeader(h,D[h])}var k;this._config.chunkSize&&(k=this._start+this._config.chunkSize-1,l.setRequestHeader("Range","bytes="+this._start+"-"+k));try{l.send(this._config.downloadRequestBody)}catch(W){this._chunkError(W.message)}a&&l.status===0&&this._chunkError()}},this._chunkLoaded=function(){l.readyState===4&&(l.status<200||400<=l.status?this._chunkError():(this._start+=this._config.chunkSize||l.responseText.length,this._finished=!this._config.chunkSize||this._start>=(h=>(h=h.getResponseHeader("Content-Range"))!==null?parseInt(h.substring(h.lastIndexOf("/")+1)):-1)(l),this.parseChunk(l.responseText)))},this._chunkError=function(h){h=l.statusText||h,this._sendError(new Error(h))}}function T(i){(i=i||{}).chunkSize||(i.chunkSize=d.LocalChunkSize),m.call(this,i);var l,h,D=typeof FileReader<"u";this.stream=function(k){this._input=k,h=k.slice||k.webkitSlice||k.mozSlice,D?((l=new FileReader).onload=K(this._chunkLoaded,this),l.onerror=K(this._chunkError,this)):l=new FileReaderSync,this._nextChunk()},this._nextChunk=function(){this._finished||this._config.preview&&!(this._rowCount<this._config.preview)||this._readChunk()},this._readChunk=function(){var k=this._input,W=(this._config.chunkSize&&(W=Math.min(this._start+this._config.chunkSize,this._input.size),k=h.call(k,this._start,W)),l.readAsText(k,this._config.encoding));D||this._chunkLoaded({target:{result:W}})},this._chunkLoaded=function(k){this._start+=this._config.chunkSize,this._finished=!this._config.chunkSize||this._start>=this._input.size,this.parseChunk(k.target.result)},this._chunkError=function(){this._sendError(l.error)}}function F(i){var l;m.call(this,i=i||{}),this.stream=function(h){return l=h,this._nextChunk()},this._nextChunk=function(){var h,D;if(!this._finished)return h=this._config.chunkSize,l=h?(D=l.substring(0,h),l.substring(h)):(D=l,""),this._finished=!l,this.parseChunk(D)}}function A(i){m.call(this,i=i||{});var l=[],h=!0,D=!1;this.pause=function(){m.prototype.pause.apply(this,arguments),this._input.pause()},this.resume=function(){m.prototype.resume.apply(this,arguments),this._input.resume()},this.stream=function(k){this._input=k,this._input.on("data",this._streamData),this._input.on("end",this._streamEnd),this._input.on("error",this._streamError)},this._checkIsFinished=function(){D&&l.length===1&&(this._finished=!0)},this._nextChunk=function(){this._checkIsFinished(),l.length?this.parseChunk(l.shift()):h=!0},this._streamData=K(function(k){try{l.push(typeof k=="string"?k:k.toString(this._config.encoding)),h&&(h=!1,this._checkIsFinished(),this.parseChunk(l.shift()))}catch(W){this._streamError(W)}},this),this._streamError=K(function(k){this._streamCleanUp(),this._sendError(k)},this),this._streamEnd=K(function(){this._streamCleanUp(),D=!0,this._streamData("")},this),this._streamCleanUp=K(function(){this._input.removeListener("data",this._streamData),this._input.removeListener("end",this._streamEnd),this._input.removeListener("error",this._streamError)},this)}function _(i){var l,h,D,k,W=Math.pow(2,53),Z=-W,le=/^\s*-?(\d+\.?|\.\d+|\d+\.\d+)([eE][-+]?\d+)?\s*$/,R=/^((\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d\.\d+([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z))|(\d{4}-[01]\d-[0-3]\dT[0-2]\d:[0-5]\d([+-][0-2]\d:[0-5]\d|Z)))$/,L=this,ee=0,f=0,z=!1,$=!1,V=[],C={data:[],errors:[],meta:{}};function v(w){return i.skipEmptyLines==="greedy"?w.join("").trim()==="":w.length===1&&w[0].length===0}function E(){if(C&&D&&(J("Delimiter","UndetectableDelimiter","Unable to auto-detect delimiting character; defaulted to '"+d.DefaultDelimiter+"'"),D=!1),i.skipEmptyLines&&(C.data=C.data.filter(function(g){return!v(g)})),q()){let g=function(N,U){G(i.transformHeader)&&(N=i.transformHeader(N,U)),V.push(N)};if(C)if(Array.isArray(C.data[0])){for(var w=0;q()&&w<C.data.length;w++)C.data[w].forEach(g);C.data.splice(0,1)}else C.data.forEach(g)}function M(g,N){for(var U=i.header?{}:[],X=0;X<g.length;X++){var ne=X,te=g[X],te=((je,Q)=>(ue=>(i.dynamicTypingFunction&&i.dynamicTyping[ue]===void 0&&(i.dynamicTyping[ue]=i.dynamicTypingFunction(ue)),(i.dynamicTyping[ue]||i.dynamicTyping)===!0))(je)?Q==="true"||Q==="TRUE"||Q!=="false"&&Q!=="FALSE"&&((ue=>{if(le.test(ue)&&(ue=parseFloat(ue),Z<ue&&ue<W))return 1})(Q)?parseFloat(Q):R.test(Q)?new Date(Q):Q===""?null:Q):Q)(ne=i.header?X>=V.length?"__parsed_extra":V[X]:ne,te=i.transform?i.transform(te,ne):te);ne==="__parsed_extra"?(U[ne]=U[ne]||[],U[ne].push(te)):U[ne]=te}return i.header&&(X>V.length?J("FieldMismatch","TooManyFields","Too many fields: expected "+V.length+" fields but parsed "+X,f+N):X<V.length&&J("FieldMismatch","TooFewFields","Too few fields: expected "+V.length+" fields but parsed "+X,f+N)),U}var b;C&&(i.header||i.dynamicTyping||i.transform)&&(b=1,!C.data.length||Array.isArray(C.data[0])?(C.data=C.data.map(M),b=C.data.length):C.data=M(C.data,0),i.header&&C.meta&&(C.meta.fields=V),f+=b)}function q(){return i.header&&V.length===0}function J(w,M,b,g){w={type:w,code:M,message:b},g!==void 0&&(w.row=g),C.errors.push(w)}G(i.step)&&(k=i.step,i.step=function(w){C=w,q()?E():(E(),C.data.length!==0&&(ee+=w.data.length,i.preview&&ee>i.preview?h.abort():(C.data=C.data[0],k(C,L))))}),this.parse=function(w,M,b){var g=i.quoteChar||'"',g=(i.newline||(i.newline=this.guessLineEndings(w,g)),D=!1,i.delimiter?G(i.delimiter)&&(i.delimiter=i.delimiter(w),C.meta.delimiter=i.delimiter):((g=((N,U,X,ne,te)=>{var je,Q,ue,Te;te=te||[",","	","|",";",d.RECORD_SEP,d.UNIT_SEP];for(var ae=0;ae<te.length;ae++){for(var re,ye=te[ae],he=0,De=0,fe=0,ve=(ue=void 0,new I({comments:ne,delimiter:ye,newline:U,preview:10}).parse(N)),Ie=0;Ie<ve.data.length;Ie++)X&&v(ve.data[Ie])?fe++:(re=ve.data[Ie].length,De+=re,ue===void 0?ue=re:0<re&&(he+=Math.abs(re-ue),ue=re));0<ve.data.length&&(De/=ve.data.length-fe),(Q===void 0||he<=Q)&&(Te===void 0||Te<De)&&1.99<De&&(Q=he,je=ye,Te=De)}return{successful:!!(i.delimiter=je),bestDelimiter:je}})(w,i.newline,i.skipEmptyLines,i.comments,i.delimitersToGuess)).successful?i.delimiter=g.bestDelimiter:(D=!0,i.delimiter=d.DefaultDelimiter),C.meta.delimiter=i.delimiter),H(i));return i.preview&&i.header&&g.preview++,l=w,h=new I(g),C=h.parse(l,M,b),E(),z?{meta:{paused:!0}}:C||{meta:{paused:!1}}},this.paused=function(){return z},this.pause=function(){z=!0,h.abort(),l=G(i.chunk)?"":l.substring(h.getCharIndex())},this.resume=function(){L.streamer._halted?(z=!1,L.streamer.parseChunk(l,!0)):setTimeout(L.resume,3)},this.aborted=function(){return $},this.abort=function(){$=!0,h.abort(),C.meta.aborted=!0,G(i.complete)&&i.complete(C),l=""},this.guessLineEndings=function(N,g){N=N.substring(0,1048576);var g=new RegExp(B(g)+"([^]*?)"+B(g),"gm"),b=(N=N.replace(g,"")).split("\r"),g=N.split(`
`),N=1<g.length&&g[0].length<b[0].length;if(b.length===1||N)return`
`;for(var U=0,X=0;X<b.length;X++)b[X][0]===`
`&&U++;return U>=b.length/2?`\r
`:"\r"}}function B(i){return i.replace(/[.*+?^${}()|[\]\\]/g,"\\$&")}function I(i){var l=(i=i||{}).delimiter,h=i.newline,D=i.comments,k=i.step,W=i.preview,Z=i.fastMode,le=null,R=!1,L=i.quoteChar==null?'"':i.quoteChar,ee=L;if(i.escapeChar!==void 0&&(ee=i.escapeChar),(typeof l!="string"||-1<d.BAD_DELIMITERS.indexOf(l))&&(l=","),D===l)throw new Error("Comment character same as delimiter");D===!0?D="#":(typeof D!="string"||-1<d.BAD_DELIMITERS.indexOf(D))&&(D=!1),h!==`
`&&h!=="\r"&&h!==`\r
`&&(h=`
`);var f=0,z=!1;this.parse=function($,V,C){if(typeof $!="string")throw new Error("Input must be a string");var v=$.length,E=l.length,q=h.length,J=D.length,w=G(k),M=[],b=[],g=[],N=f=0;if(!$)return he();if(Z||Z!==!1&&$.indexOf(L)===-1){for(var U=$.split(h),X=0;X<U.length;X++){if(g=U[X],f+=g.length,X!==U.length-1)f+=h.length;else if(C)return he();if(!D||g.substring(0,J)!==D){if(w){if(M=[],Te(g.split(l)),De(),z)return he()}else Te(g.split(l));if(W&&W<=X)return M=M.slice(0,W),he(!0)}}return he()}for(var ne=$.indexOf(l,f),te=$.indexOf(h,f),je=new RegExp(B(ee)+B(L),"g"),Q=$.indexOf(L,f);;)if($[f]===L)for(Q=f,f++;;){if((Q=$.indexOf(L,Q+1))===-1)return C||b.push({type:"Quotes",code:"MissingQuotes",message:"Quoted field unterminated",row:M.length,index:f}),re();if(Q===v-1)return re($.substring(f,Q).replace(je,L));if(L===ee&&$[Q+1]===ee)Q++;else if(L===ee||Q===0||$[Q-1]!==ee){ne!==-1&&ne<Q+1&&(ne=$.indexOf(l,Q+1));var ue=ae((te=te!==-1&&te<Q+1?$.indexOf(h,Q+1):te)===-1?ne:Math.min(ne,te));if($.substr(Q+1+ue,E)===l){g.push($.substring(f,Q).replace(je,L)),$[f=Q+1+ue+E]!==L&&(Q=$.indexOf(L,f)),ne=$.indexOf(l,f),te=$.indexOf(h,f);break}if(ue=ae(te),$.substring(Q+1+ue,Q+1+ue+q)===h){if(g.push($.substring(f,Q).replace(je,L)),ye(Q+1+ue+q),ne=$.indexOf(l,f),Q=$.indexOf(L,f),w&&(De(),z))return he();if(W&&M.length>=W)return he(!0);break}b.push({type:"Quotes",code:"InvalidQuotes",message:"Trailing quote on quoted field is malformed",row:M.length,index:f}),Q++}}else if(D&&g.length===0&&$.substring(f,f+J)===D){if(te===-1)return he();f=te+q,te=$.indexOf(h,f),ne=$.indexOf(l,f)}else if(ne!==-1&&(ne<te||te===-1))g.push($.substring(f,ne)),f=ne+E,ne=$.indexOf(l,f);else{if(te===-1)break;if(g.push($.substring(f,te)),ye(te+q),w&&(De(),z))return he();if(W&&M.length>=W)return he(!0)}return re();function Te(fe){M.push(fe),N=f}function ae(fe){var ve=0;return ve=fe!==-1&&(fe=$.substring(Q+1,fe))&&fe.trim()===""?fe.length:ve}function re(fe){return C||(fe===void 0&&(fe=$.substring(f)),g.push(fe),f=v,Te(g),w&&De()),he()}function ye(fe){f=fe,Te(g),g=[],te=$.indexOf(h,f)}function he(fe){if(i.header&&!V&&M.length&&!R){var ve=M[0],Ie={},vt=new Set(ve);let Nt=!1;for(let He=0;He<ve.length;He++){let we=ve[He];if(Ie[we=G(i.transformHeader)?i.transformHeader(we,He):we]){let et,Pt=Ie[we];for(;et=we+"_"+Pt,Pt++,vt.has(et););vt.add(et),ve[He]=et,Ie[we]++,Nt=!0,(le=le===null?{}:le)[et]=we}else Ie[we]=1,ve[He]=we;vt.add(we)}Nt&&console.warn("Duplicate headers found and renamed."),R=!0}return{data:M,errors:b,meta:{delimiter:l,linebreak:h,aborted:z,truncated:!!fe,cursor:N+(V||0),renamedHeaders:le}}}function De(){k(he()),M=[],b=[]}},this.abort=function(){z=!0},this.getCharIndex=function(){return f}}function Y(i){var l=i.data,h=p[l.workerId],D=!1;if(l.error)h.userError(l.error,l.file);else if(l.results&&l.results.data){var k={abort:function(){D=!0,P(l.workerId,{data:[],errors:[],meta:{aborted:!0}})},pause:S,resume:S};if(G(h.userStep)){for(var W=0;W<l.results.data.length&&(h.userStep({data:l.results.data[W],errors:l.results.errors,meta:l.results.meta},k),!D);W++);delete l.results}else G(h.userChunk)&&(h.userChunk(l.results,k,l.file),delete l.results)}l.finished&&!D&&P(l.workerId,l.results)}function P(i,l){var h=p[i];G(h.userComplete)&&h.userComplete(l),h.terminate(),delete p[i]}function S(){throw new Error("Not implemented.")}function H(i){if(typeof i!="object"||i===null)return i;var l,h=Array.isArray(i)?[]:{};for(l in i)h[l]=H(i[l]);return h}function K(i,l){return function(){i.apply(l,arguments)}}function G(i){return typeof i=="function"}return d.parse=function(i,l){var h=(l=l||{}).dynamicTyping||!1;if(G(h)&&(l.dynamicTypingFunction=h,h={}),l.dynamicTyping=h,l.transform=!!G(l.transform)&&l.transform,!l.worker||!d.WORKERS_SUPPORTED)return h=null,d.NODE_STREAM_INPUT,typeof i=="string"?(i=(D=>D.charCodeAt(0)!==65279?D:D.slice(1))(i),h=new(l.download?y:F)(l)):i.readable===!0&&G(i.read)&&G(i.on)?h=new A(l):(s.File&&i instanceof File||i instanceof Object)&&(h=new T(l)),h.stream(i);(h=(()=>{var D;return!!d.WORKERS_SUPPORTED&&(D=(()=>{var k=s.URL||s.webkitURL||null,W=r.toString();return d.BLOB_URL||(d.BLOB_URL=k.createObjectURL(new Blob(["var global = (function() { if (typeof self !== 'undefined') { return self; } if (typeof window !== 'undefined') { return window; } if (typeof global !== 'undefined') { return global; } return {}; })(); global.IS_PAPA_WORKER=true; ","(",W,")();"],{type:"text/javascript"})))})(),(D=new s.Worker(D)).onmessage=Y,D.id=u++,p[D.id]=D)})()).userStep=l.step,h.userChunk=l.chunk,h.userComplete=l.complete,h.userError=l.error,l.step=G(l.step),l.chunk=G(l.chunk),l.complete=G(l.complete),l.error=G(l.error),delete l.worker,h.postMessage({input:i,config:l,workerId:h.id})},d.unparse=function(i,l){var h=!1,D=!0,k=",",W=`\r
`,Z='"',le=Z+Z,R=!1,L=null,ee=!1,f=((()=>{if(typeof l=="object"){if(typeof l.delimiter!="string"||d.BAD_DELIMITERS.filter(function(V){return l.delimiter.indexOf(V)!==-1}).length||(k=l.delimiter),typeof l.quotes!="boolean"&&typeof l.quotes!="function"&&!Array.isArray(l.quotes)||(h=l.quotes),typeof l.skipEmptyLines!="boolean"&&typeof l.skipEmptyLines!="string"||(R=l.skipEmptyLines),typeof l.newline=="string"&&(W=l.newline),typeof l.quoteChar=="string"&&(Z=l.quoteChar),typeof l.header=="boolean"&&(D=l.header),Array.isArray(l.columns)){if(l.columns.length===0)throw new Error("Option columns is empty");L=l.columns}l.escapeChar!==void 0&&(le=l.escapeChar+Z),l.escapeFormulae instanceof RegExp?ee=l.escapeFormulae:typeof l.escapeFormulae=="boolean"&&l.escapeFormulae&&(ee=/^[=+\-@\t\r].*$/)}})(),new RegExp(B(Z),"g"));if(typeof i=="string"&&(i=JSON.parse(i)),Array.isArray(i)){if(!i.length||Array.isArray(i[0]))return z(null,i,R);if(typeof i[0]=="object")return z(L||Object.keys(i[0]),i,R)}else if(typeof i=="object")return typeof i.data=="string"&&(i.data=JSON.parse(i.data)),Array.isArray(i.data)&&(i.fields||(i.fields=i.meta&&i.meta.fields||L),i.fields||(i.fields=Array.isArray(i.data[0])?i.fields:typeof i.data[0]=="object"?Object.keys(i.data[0]):[]),Array.isArray(i.data[0])||typeof i.data[0]=="object"||(i.data=[i.data])),z(i.fields||[],i.data||[],R);throw new Error("Unable to serialize unrecognized input");function z(V,C,v){var E="",q=(typeof V=="string"&&(V=JSON.parse(V)),typeof C=="string"&&(C=JSON.parse(C)),Array.isArray(V)&&0<V.length),J=!Array.isArray(C[0]);if(q&&D){for(var w=0;w<V.length;w++)0<w&&(E+=k),E+=$(V[w],w);0<C.length&&(E+=W)}for(var M=0;M<C.length;M++){var b=(q?V:C[M]).length,g=!1,N=q?Object.keys(C[M]).length===0:C[M].length===0;if(v&&!q&&(g=v==="greedy"?C[M].join("").trim()==="":C[M].length===1&&C[M][0].length===0),v==="greedy"&&q){for(var U=[],X=0;X<b;X++){var ne=J?V[X]:X;U.push(C[M][ne])}g=U.join("").trim()===""}if(!g){for(var te=0;te<b;te++){0<te&&!N&&(E+=k);var je=q&&J?V[te]:te;E+=$(C[M][je],te)}M<C.length-1&&(!v||0<b&&!N)&&(E+=W)}}return E}function $(V,C){var v,E;return V==null?"":V.constructor===Date?JSON.stringify(V).slice(1,25):(E=!1,ee&&typeof V=="string"&&ee.test(V)&&(V="'"+V,E=!0),v=V.toString().replace(f,le),(E=E||h===!0||typeof h=="function"&&h(V,C)||Array.isArray(h)&&h[C]||((q,J)=>{for(var w=0;w<J.length;w++)if(-1<q.indexOf(J[w]))return!0;return!1})(v,d.BAD_DELIMITERS)||-1<v.indexOf(k)||v.charAt(0)===" "||v.charAt(v.length-1)===" ")?Z+v+Z:v)}},d.RECORD_SEP="",d.UNIT_SEP="",d.BYTE_ORDER_MARK="\uFEFF",d.BAD_DELIMITERS=["\r",`
`,'"',d.BYTE_ORDER_MARK],d.WORKERS_SUPPORTED=!a&&!!s.Worker,d.NODE_STREAM_INPUT=1,d.LocalChunkSize=10485760,d.RemoteChunkSize=5242880,d.DefaultDelimiter=",",d.Parser=I,d.ParserHandle=_,d.NetworkStreamer=y,d.FileStreamer=T,d.StringStreamer=F,d.ReadableStreamStreamer=A,s.jQuery&&((o=s.jQuery).fn.parse=function(i){var l=i.config||{},h=[];return this.each(function(W){if(!(o(this).prop("tagName").toUpperCase()==="INPUT"&&o(this).attr("type").toLowerCase()==="file"&&s.FileReader)||!this.files||this.files.length===0)return!0;for(var Z=0;Z<this.files.length;Z++)h.push({file:this.files[Z],inputElem:this,instanceConfig:o.extend({},l)})}),D(),this;function D(){if(h.length===0)G(i.complete)&&i.complete();else{var W,Z,le,R,L=h[0];if(G(i.before)){var ee=i.before(L.file,L.inputElem);if(typeof ee=="object"){if(ee.action==="abort")return W="AbortError",Z=L.file,le=L.inputElem,R=ee.reason,void(G(i.error)&&i.error({name:W},Z,le,R));if(ee.action==="skip")return void k();typeof ee.config=="object"&&(L.instanceConfig=o.extend(L.instanceConfig,ee.config))}else if(ee==="skip")return void k()}var f=L.instanceConfig.complete;L.instanceConfig.complete=function(z){G(f)&&f(z,L.file,L.inputElem),k()},d.parse(L.file,L.instanceConfig)}}function k(){h.splice(0,1),D()}}),c&&(s.onmessage=function(i){i=i.data,d.WORKER_ID===void 0&&i&&(d.WORKER_ID=i.workerId),typeof i.input=="string"?s.postMessage({workerId:d.WORKER_ID,results:d.parse(i.input,i.config),finished:!0}):(s.File&&i.input instanceof File||i.input instanceof Object)&&(i=d.parse(i.input,i.config))&&s.postMessage({workerId:d.WORKER_ID,results:i,finished:!0})}),(y.prototype=Object.create(m.prototype)).constructor=y,(T.prototype=Object.create(m.prototype)).constructor=T,(F.prototype=Object.create(F.prototype)).constructor=F,(A.prototype=Object.create(m.prototype)).constructor=A,d})}(ct)),ct.exports}var mr=pr();const hr=_s(mr),gr=async(t,n)=>{switch(n){case"csv":return fr(t);case"excel":return xr(t);case"json":return yr(t);case"xml":return br(t);case"pdf":return jr(t);case"txt":return vr(t);default:throw new Error(`Unsupported file type: ${n}`)}},fr=t=>new Promise((n,r)=>{hr.parse(t,{header:!0,skipEmptyLines:!0,dynamicTyping:!0,complete:s=>{const o=s.meta.fields||[],a=s.data;n({columns:o,data:a.slice(0,100)})},error:s=>{r(new Error(`Error parsing CSV: ${s.message}`))}})}),xr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=async o=>{var a;try{const c=(a=o.target)==null?void 0:a.result;if(!c){r(new Error("Failed to read Excel file"));return}const p=await ss(()=>import("./xlsx-DkH2s96g.js"),[]),u=p.read(c,{type:"array"}),d=u.SheetNames[0],m=u.Sheets[d],y=p.utils.sheet_to_json(m,{header:1});if(y.length===0){r(new Error("Excel file is empty"));return}const T=y[0].map(String),F=y.slice(1).map(A=>{const _={};return A.forEach((B,I)=>{I<T.length&&(_[T[I]]=B)}),_});n({columns:T,data:F.slice(0,100)})}catch(c){r(new Error(`Error parsing Excel file: ${c instanceof Error?c.message:"Unknown error"}`))}},s.onerror=()=>{r(new Error("Error reading Excel file"))},s.readAsArrayBuffer(t)}),yr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=o=>{var a;try{const c=(a=o.target)==null?void 0:a.result,p=JSON.parse(c);if(Array.isArray(p)){if(p.length===0){r(new Error("JSON file contains an empty array"));return}const u=Array.from(new Set(p.flatMap(d=>Object.keys(d))));n({columns:u,data:p.slice(0,100)})}else if(p&&typeof p=="object"){const u=Object.keys(p).find(d=>Array.isArray(p[d]));if(u&&p[u].length>0){const d=p[u],m=Array.from(new Set(d.flatMap(y=>Object.keys(y))));n({columns:m,data:d.slice(0,100)})}else{const d=Object.keys(p);n({columns:d,data:[p]})}}else r(new Error("JSON file format not recognized"))}catch(c){r(new Error(`Error parsing JSON file: ${c instanceof Error?c.message:"Invalid JSON"}`))}},s.onerror=()=>{r(new Error("Error reading JSON file"))},s.readAsText(t)}),br=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=o=>{var a,c;try{const p=(a=o.target)==null?void 0:a.result,d=new DOMParser().parseFromString(p,"text/xml"),m=d.getElementsByTagName("*"),y=new Map;for(let P=0;P<m.length;P++){const S=m[P].tagName;y.set(S,(y.get(S)||0)+1)}const T=Array.from(y.entries()).filter(([P,S])=>S>1).map(([P])=>P).sort((P,S)=>(y.get(S)||0)-(y.get(P)||0));if(T.length===0){r(new Error("Could not identify repeating elements in XML"));return}const F=T[0],A=d.getElementsByTagName(F);if(A.length===0){r(new Error(`No elements found with tag ${F}`));return}const _=A[0],I=Array.from(_.children).map(P=>P.tagName),Y=[];for(let P=0;P<Math.min(A.length,100);P++){const S=A[P],H={};for(const K of I){const G=((c=S.getElementsByTagName(K)[0])==null?void 0:c.textContent)||"";H[K]=G}Y.push(H)}n({columns:I,data:Y})}catch(p){r(new Error(`Error parsing XML file: ${p instanceof Error?p.message:"Invalid XML"}`))}},s.onerror=()=>{r(new Error("Error reading XML file"))},s.readAsText(t)}),jr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=async o=>{var a;try{if(!((a=o.target)==null?void 0:a.result)){r(new Error("Failed to read PDF file"));return}n({columns:["Information"],data:[{Information:"PDF files are not currently supported for direct parsing in the browser."},{Information:"Please convert your PDF to CSV, Excel, or JSON format for processing."},{Information:"Alternatively, copy and paste the data from your PDF into a text file."},{Information:`File name: ${t.name}`},{Information:`File size: ${(t.size/1024).toFixed(2)} KB`},{Information:"Supported formats: CSV, Excel (.xlsx, .xls), JSON, XML, TXT"}]})}catch(c){r(new Error(`Error processing PDF: ${c instanceof Error?c.message:"Unknown error"}`))}},s.onerror=()=>{r(new Error("Error reading PDF file"))},s.readAsArrayBuffer(t)}),vr=t=>new Promise((n,r)=>{const s=new FileReader;s.onload=o=>{var a;try{const c=(a=o.target)==null?void 0:a.result;if(!c){r(new Error("Failed to read text file"));return}const p=c.split(`
`).map(y=>y.trim()).filter(y=>y.length>0);if(p.length===0){r(new Error("Text file is empty"));return}const u=[",","	","|",";"];let d="",m=0;for(const y of u){const T=p.slice(0,10).map(_=>_.split(y).length),F=T.reduce((_,B)=>_+B,0)/T.length;T.every(_=>Math.abs(_-F)<=1&&_>1)&&F>m&&(m=F,d=y)}if(d&&m>1){const y=p[0].split(d).map(F=>F.trim()),T=[];for(let F=1;F<Math.min(p.length,100);F++){const A=p[F].split(d).map(B=>B.trim()),_={};for(let B=0;B<y.length;B++)_[y[B]]=A[B]||"";T.push(_)}n({columns:y,data:T})}else{const y=p.slice(0,100).map((T,F)=>({LineNumber:F+1,Text:T}));n({columns:["LineNumber","Text"],data:y})}}catch(c){r(new Error(`Error parsing text file: ${c instanceof Error?c.message:"Unknown error"}`))}},s.onerror=()=>{r(new Error("Error reading text file"))},s.readAsText(t)}),Tr=()=>{const t=at(),n=Ve(s=>s.formatter.selectedTool),r=s=>{const o=s.target.value,a=Lt.find(c=>c.id===o);a&&t(Is(a))};return e.jsxs(j,{sx:{my:3},children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Select Target Tool"}),e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(Le,{fullWidth:!0,children:[e.jsx(Ue,{id:"tool-select-label",children:"Tool"}),e.jsx(Be,{labelId:"tool-select-label",id:"tool-select",value:(n==null?void 0:n.id)||"",label:"Tool",onChange:r,children:Lt.map(s=>e.jsx(oe,{value:s.id,children:s.name},s.id))})]})}),e.jsx(pe,{size:12,children:n&&e.jsxs(ge,{variant:"outlined",sx:{p:2,mt:2,borderColor:"primary.light"},children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:n.name}),e.jsx(x,{variant:"body2",paragraph:!0,children:n.description}),e.jsxs(x,{variant:"body2",color:"text.secondary",children:["Required fields: ",n.requiredFields.map(s=>s.name).join(", ")]})]})})]})]})},Sr=()=>{const t=at(),n=O.useRef(null),{sourceColumns:r,selectedTool:s}=Ve(P=>P.formatter),[o,a]=O.useState("csv"),[c,p]=O.useState(!1),[u,d]=O.useState(null),[m,y]=O.useState(null),T=P=>{a(P.target.value)},F=async P=>{var H;const S=(H=P.target.files)==null?void 0:H[0];if(S){y(S.name),p(!0),d(null);try{t($e("uploading"));const K={id:`file-${Date.now()}`,name:S.name,type:o,size:S.size,lastModified:S.lastModified},{columns:G,data:i}=await gr(S,o);t(As(K)),t($s(G)),t(rs(i)),t($e("idle")),setTimeout(()=>{t(ke(1))},500)}catch(K){d(K instanceof Error?K.message:"Failed to parse file"),t($e("error"))}finally{p(!1)}}},A=()=>{var P;(P=n.current)==null||P.click()},_=P=>{var H;P.preventDefault(),P.stopPropagation();const S=(H=P.dataTransfer.files)==null?void 0:H[0];if(S&&n.current){const K=new DataTransfer;K.items.add(S),n.current.files=K.files,F({target:{files:K.files}})}},B=P=>{P.preventDefault(),P.stopPropagation()},I=()=>{t(ke(1))},Y=r.length>0&&s!==null;return e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(x,{variant:"h5",gutterBottom:!0,children:"Upload Data File"}),e.jsx(x,{variant:"body1",paragraph:!0,children:"Select a file to upload. The formatter supports CSV, Excel (.xlsx, .xls, .xlsm), PDF, JSON, XML, and plain text files."}),e.jsxs(pe,{container:!0,spacing:3,children:[e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(Le,{fullWidth:!0,children:[e.jsx(Ue,{id:"file-type-select-label",children:"File Type"}),e.jsxs(Be,{labelId:"file-type-select-label",id:"file-type-select",value:o,label:"File Type",onChange:T,children:[e.jsx(oe,{value:"csv",children:"CSV"}),e.jsx(oe,{value:"excel",children:"Excel (.xlsx/.xls/.xlsm)"}),e.jsx(oe,{value:"json",children:"JSON"}),e.jsx(oe,{value:"xml",children:"XML"}),e.jsx(oe,{value:"pdf",children:"PDF"}),e.jsx(oe,{value:"txt",children:"Text File"})]})]})}),e.jsxs(pe,{size:12,children:[e.jsx("input",{type:"file",ref:n,onChange:F,style:{display:"none"},accept:o==="csv"?".csv":o==="excel"?".xlsx,.xls,.xlsm":o==="json"?".json":o==="xml"?".xml":o==="pdf"?".pdf":o==="txt"?".txt":void 0}),e.jsx(ge,{elevation:0,onDrop:_,onDragOver:B,sx:{border:"2px dashed #ccc",borderRadius:2,p:3,textAlign:"center",cursor:"pointer",bgcolor:"#f8f9fa","&:hover":{borderColor:"primary.main"}},onClick:A,children:c?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(Pe,{}),e.jsx(x,{variant:"body1",sx:{mt:2},children:"Processing file..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",alignItems:"center"},children:[e.jsx(zt,{fontSize:"large",color:"primary"}),e.jsx(x,{variant:"h6",sx:{mt:2},children:m?`Selected: ${m}`:"Drag & drop file here or click to browse"}),e.jsxs(x,{variant:"body2",color:"text.secondary",sx:{mt:1},children:["Supports ",o==="csv"?"CSV":o==="excel"?"Excel (.xlsx, .xls, .xlsm)":o==="json"?"JSON":o==="xml"?"XML":o==="pdf"?"PDF":"Text"," files"]})]})}),u&&e.jsx(ce,{severity:"error",sx:{mt:2},children:u}),m&&!c&&!u&&e.jsxs(ce,{severity:"success",sx:{mt:2},children:["File selected: ",m]})]}),e.jsx(pe,{size:12,sx:{mt:2,display:"flex",justifyContent:"center"},children:e.jsx(se,{variant:"contained",size:"large",onClick:A,startIcon:e.jsx(zt,{}),disabled:c,children:"Browse Files"})})]}),e.jsx(xe,{sx:{my:4}}),e.jsx(Tr,{}),e.jsx(j,{sx:{display:"flex",justifyContent:"flex-end",mt:4},children:e.jsx(se,{variant:"contained",size:"large",endIcon:e.jsx(kt,{}),onClick:I,disabled:!Y,children:"Continue to Field Mapping"})}),!Y&&e.jsx(x,{variant:"body2",color:"text.secondary",sx:{mt:2,textAlign:"right"},children:r.length?"Select a target tool to continue":"Upload a file to continue"})]})},st=de(e.jsx("path",{d:"M20 11H7.83l5.59-5.59L12 4l-8 8 8 8 1.41-1.41L7.83 13H20z"})),Ht=t=>["dispatch_time","enroute_time","arrival_time","clear_time"].includes(t),Et=t=>["incident_date"].includes(t),Er=t=>{if(!t||typeof t!="string")return t;const n=[/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2}:\d{2})$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+(\d{1,2}:\d{2})$/,/^\d{4}-\d{2}-\d{2}\s+(\d{1,2}:\d{2})$/,/^.+\s+(\d{1,2}:\d{2}(?::\d{2})?)$/];for(const s of n){const o=t.match(s);if(o&&o[1])return o[1]}return/^\d{1,2}:\d{2}(?::\d{2})?$/.test(t.trim())?t.trim():t},Fr=t=>{if(console.log(`🔍 DATE EXTRACTION: Input "${t}" (type: ${typeof t})`),!t||typeof t!="string")return console.log("🔍 DATE EXTRACTION: Invalid input, returning original"),t;const n=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^(\d{4}-\d{2}-\d{2})\s+\d{1,2}:\d{2}(?::\d{2})?$/,/^([^\\s]+)\s+\d{1,2}:\d{2}(?::\d{2})?$/];for(let s=0;s<n.length;s++){const o=n[s],a=t.match(o);if(console.log(`🔍 Pattern ${s+1} test: "${t}" → ${a?`MATCH: "${a[1]}"`:"NO MATCH"}`),a&&a[1])return console.log(`🔍 DATE EXTRACTION SUCCESS: "${t}" → "${a[1]}"`),a[1]}const r=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const s of r)if(s.test(t.trim()))return t.trim();return t},gs=(t,n)=>!t||!t.length||!n||!n.length?[]:t.map(r=>{const s={},o=new Set;return n.forEach(a=>{const{sourceField:c,targetField:p,transformations:u}=a;let d;if(c==="__default__"&&u&&u.length>0){const m=u.find(y=>y.type==="convert"&&y.params.defaultValue);m?(console.log(`Using default value for ${p}:`,m.params.defaultValue),d=m.params.defaultValue):(console.log(`No default value found for ${p}, using null`),d=null)}else if(c.includes("_")&&c.split("_").length>=2){const[m,...y]=c.split("_"),T=y.join("_"),F=[`${m}_parsed_${T}`,`${m}_parsed_${p}`,c];console.log(`🤖 DEBUG: Looking for parsed data with sourceField: "${c}"`),console.log("🤖 DEBUG: Trying keys:",F),console.log("🤖 DEBUG: Available row keys:",Object.keys(r));let A=!1;for(const _ of F)if(r[_]!==void 0&&r[_]!==null){d=r[_],console.log(`🤖 ✅ Using PARSED value for ${p} from key "${_}": "${d}"`),A=!0;break}else console.log(`🤖 ❌ No data found at key: "${_}"`);A||(d=r[c],console.log(`🤖 ⚠️ No parsed data found, using source value for ${p} from ${c}:`,d))}else d=r[c],console.log(`Using source value for ${p} from ${c}:`,d);if(u&&u.length>0){console.log(`Applying ${u.length} transformations to ${p}:`,u);const m=d;d=Cr(d,u,p,r),console.log(`Transformation result for ${p}:`,m,"→",d)}if(p==="incident_type"&&d!==null&&d!==void 0&&(typeof d=="number"?(console.log(`🔢 Converting numeric incident_type to string: ${d} → "${String(d)}"`),d=String(d)):typeof d!="string"&&(console.log(`🔄 Converting incident_type to string: ${d} (${typeof d}) → "${String(d)}"`),d=String(d))),console.log(`🔧 CHECKING FIELD: ${p}, isTimeOnly: ${Ht(p)}, isDateOnly: ${Et(p)}, value type: ${typeof d}`),d&&typeof d=="string")if(Ht(p)){const m=Er(d);m!==d?(console.log(`🕒 Auto-extracted time for ${p}: "${d}" → "${m}"`),d=m):console.log(`🕒 No time extraction needed for ${p}: "${d}"`)}else if(Et(p)){console.log(`📅 ATTEMPTING DATE EXTRACTION for ${p}: Input value "${d}"`);const m=Fr(d);console.log(`📅 DATE EXTRACTION RESULT: "${d}" → "${m}" (changed: ${m!==d})`),m!==d?(console.log(`📅 ✅ Auto-extracted date for ${p}: "${d}" → "${m}"`),d=m):console.log(`📅 ❌ No date extraction needed for ${p}: "${d}"`)}else p==="incident_time"&&console.log(`🕒 Keeping full datetime for ${p}: "${d}"`);if(s[p]=d,c!==p&&c!=="__default__"&&!o.has(c)&&!c.includes("_parsed_")){if(n.some(y=>y.targetField===c))console.log(`🚫 SKIPPING PRESERVATION: "${c}" is also a target field - keeping transformed value`);else{let y=d;Et(p)&&r[c]&&typeof r[c]=="string"&&r[c].includes(" ")&&(y=r[c],console.log(`📅 PRESERVING FULL DATETIME for original field "${c}": "${y}" (target "${p}" gets date-only: "${d}")`)),s[c]=y,console.log(`🔄 PRESERVED ORIGINAL FIELD NAME: "${c}" → "${y}" (also mapped to ${p})`)}o.add(c)}else c.includes("_parsed_")&&console.log(`🤖 SKIPPING PARSED FIELD PRESERVATION: "${c}" (parsed field injection key)`)}),Object.keys(s).forEach(a=>{a.includes("_parsed_")&&(console.log(`🧹 CLEANUP: Removing parsed field injection key "${a}" from transformed data`),delete s[a])}),s}),Cr=(t,n,r,s)=>n.reduce((o,a)=>fs(o,a,r,s),t),fs=(t,n,r,s)=>{const{type:o,params:a}=n,c={...a,...r&&{fieldName:r},...s&&{rowData:s}};switch(o){case"split":return _r(t,c);case"join":return Ir(t,c);case"format":return Ar(t,c);case"convert":return $r(t,c);case"extract":return Dr(t,c);case"replace":return wr(t,c);case"datetime_combine":return Mr(t,c);case"datetime_extract":return Rr(t,c);default:return t}},Dr=(t,n)=>{if(typeof t!="string")return t;const{pattern:r}=n;try{const s=new RegExp(r),o=t.match(s);if(o&&o.length>0)return o[1]||o[0]}catch{console.error("Invalid regex pattern:",r)}return t},wr=(t,n)=>{if(typeof t!="string")return t;const{from:r,to:s="",useRegex:o=!1}=n;if(!r)return t;try{if(o){const a=new RegExp(r,"g");return t.replace(a,s)}else return t.replace(new RegExp(r.replace(/[.*+?^${}()|[\]\\]/g,"\\$&"),"g"),s)}catch(a){return console.error("Error in replace transformation:",a),t}},_r=(t,n)=>{if(typeof t!="string")return t;const{delimiter:r,index:s}=n,o=t.split(r);return s!==void 0?o[s]||"":o},Ir=(t,n)=>{if(!Array.isArray(t))return t;const{delimiter:r=", "}=n;return t.join(r)},Ar=(t,n)=>{const{format:r,type:s,fieldName:o}=n;if(console.log("applyFormatTransformation called with:",{value:t,format:r,type:s,fieldName:o}),s==="date"&&t)try{const a=new Date(t);if(isNaN(a.getTime()))return t;switch(r){case"MM/DD/YYYY":return`${a.getMonth()+1}/${a.getDate()}/${a.getFullYear()}`;case"YYYY-MM-DD":return`${a.getFullYear()}-${(a.getMonth()+1).toString().padStart(2,"0")}-${a.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${a.getDate()}/${a.getMonth()+1}/${a.getFullYear()}`;case"date-only":return a.toLocaleDateString();case"custom":return(n.customFormat||"YYYY-MM-DD").replace("YYYY",a.getFullYear().toString()).replace("MM",(a.getMonth()+1).toString().padStart(2,"0")).replace("DD",a.getDate().toString().padStart(2,"0")).replace("HH",a.getHours().toString().padStart(2,"0")).replace("mm",a.getMinutes().toString().padStart(2,"0")).replace("ss",a.getSeconds().toString().padStart(2,"0"));case"ISO":return a.toISOString();default:return t}}catch{return t}if(s==="number"&&t!==void 0&&t!==null)try{const a=Number(t);if(isNaN(a))return t;switch(r){case"integer":return Math.round(a);case"fixed2":return a.toFixed(2);case"currency":return`$${a.toFixed(2)}`;case"percent":return`${(a*100).toFixed(1)}%`;default:return t}}catch{return t}return t},$r=(t,n)=>{const{targetType:r}=n;switch(r){case"string":return t!=null?String(t):"";case"number":if(t==null||t==="")return null;const s=Number(t);return isNaN(s)?t:s;case"boolean":return typeof t=="string"?["true","yes","1","y"].includes(t.toLowerCase()):!!t;case"date":if(!t)return null;try{const o=new Date(t);return isNaN(o.getTime())?t:o}catch{return t}default:return t}},Mr=(t,n)=>{const{sourceFields:r,description:s,rowData:o}=n;if(console.log("🕐 DATETIME COMBINE: Starting transformation"),console.log("🕐 Source fields:",r),console.log("🕐 Primary value:",t),console.log("🕐 Description:",s),!r||r.length<2)return console.log("⚠️ DATETIME COMBINE: Need at least 2 source fields"),t;if(!o)return console.log("⚠️ DATETIME COMBINE: No row data provided for field combination"),t;const[a,c]=r,p=String(o[a]||"").trim(),u=String(o[c]||"").trim();if(console.log(`🕐 Date field "${a}":`,p),console.log(`🕐 Time field "${c}":`,u),!p||!u)return console.log("⚠️ DATETIME COMBINE: Missing date or time component"),t;const d=`${p} ${u}`;return console.log("✅ DATETIME COMBINE: Result:",d),d},Rr=(t,n)=>{const{extractType:r,description:s}=n;if(console.log("🕐 DATETIME EXTRACT: Starting transformation"),console.log("🕐 Extract type:",r),console.log("🕐 Input value:",t),console.log("🕐 Description:",s),!t||typeof t!="string")return console.log("⚠️ DATETIME EXTRACT: Invalid input value"),t;const o=t.trim();if(r==="date"){const a=[/^(\d{1,2}\/\d{1,2}\/\d{4})\s+/,/^(\d{4}-\d{2}-\d{2})\s+/];for(const p of a){const u=o.match(p);if(u){const d=u[1];return console.log("✅ DATETIME EXTRACT (date):",d),d}}const c=[/^\d{1,2}\/\d{1,2}\/\d{4}$/,/^\d{4}-\d{2}-\d{2}$/];for(const p of c)if(p.test(o))return console.log("✅ DATETIME EXTRACT (date): Already date-only format"),o}else if(r==="time"){const a=[/\s+(\d{1,2}:\d{2}:\d{2})$/,/\s+(\d{1,2}:\d{2})$/];for(const p of a){const u=o.match(p);if(u){const d=u[1];return console.log("✅ DATETIME EXTRACT (time):",d),d}}const c=[/^\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}:\d{2}$/];for(const p of c)if(p.test(o))return console.log("✅ DATETIME EXTRACT (time): Already time-only format"),o}return console.log("⚠️ DATETIME EXTRACT: No matching pattern found, returning original value"),t},Or=(t,n)=>{console.log("🕐 SMART DATETIME DETECTION: Starting analysis..."),console.log("🕐 Column names:",t);const r=n.find(c=>Object.keys(c).length>0)||{};console.log("🕐 Sample data keys:",Object.keys(r));const s=kr(t,r);if(s.confidence>.7)return console.log("✅ DETECTED: Tyler CAD split datetime pattern"),{pattern:s,suggestedMappings:Lr(s)};const o=Nr(t,r);if(o.confidence>.7)return console.log("✅ DETECTED: Hexagon/CentralSquare combined datetime pattern"),{pattern:o,suggestedMappings:zr(o)};const a=Pr(t,r);return a.confidence>.5?(console.log("✅ DETECTED: Volunteer department simple pattern"),{pattern:a,suggestedMappings:Vr(a)}):(console.log("⚠️ NO CLEAR DATETIME PATTERN DETECTED"),{pattern:{type:"unknown",confidence:0,description:"No clear datetime pattern detected - manual mapping required"},suggestedMappings:[]})},kr=(t,n)=>{console.log("🔍 Testing split datetime pattern (Tyler CAD style)...");const r=[/^inc_date$/i,/^incident_date$/i,/^date$/i,/^call_date$/i,/^event_date$/i],s=[/^alarm_time$/i,/^call_time$/i,/^time$/i,/^incident_time$/i,/^receive_time$/i,/^dispatch_time$/i];let o,a,c=0;for(const p of t){for(const u of r)if(u.test(p)){o=p,c+=.3,console.log(`📅 Found potential date field: "${p}"`);break}if(o)break}for(const p of t){for(const u of s)if(u.test(p)){a=p,c+=.3,console.log(`⏰ Found potential time field: "${p}"`);break}if(a)break}if(o&&a&&n[o]&&n[a]){const p=String(n[o]),u=String(n[a]);console.log("🧪 Sample data validation:"),console.log(`  Date field "${o}": "${p}"`),console.log(`  Time field "${a}": "${u}"`);const m=/^\d{1,2}\/\d{1,2}\/\d{4}$/.test(p.trim()),T=/^\d{1,2}:\d{2}(:\d{2})?$/.test(u.trim());m&&T?(c+=.4,console.log("✅ Data validation passed - date-only + time-only pattern confirmed")):(console.log("⚠️ Data validation failed - not clean date-only + time-only pattern"),console.log(`  Date-only check: ${m}, Time-only check: ${T}`))}return{type:"split",confidence:c,dateField:o,timeField:a,description:c>.7?`Split datetime pattern detected: "${o}" + "${a}" should be combined`:"Potential split pattern found but low confidence"}},Nr=(t,n)=>{console.log("🔍 Testing combined datetime pattern (Hexagon/CentralSquare style)...");const r=[/^calldatetime$/i,/^call_datetime$/i,/^incident_datetime$/i,/^event_datetime$/i,/^call_received_date\/time$/i,/^call.*time$/i,/^received.*time$/i];let s,o=0;for(const a of t){for(const c of r)if(c.test(a)){s=a,o+=.4,console.log(`📅⏰ Found potential combined datetime field: "${a}"`);break}if(s)break}if(!s)for(const a of t){const c=n[a];if(c&&typeof c=="string"&&/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}/.test(c.trim())){s=a,o+=.3,console.log(`📅⏰ Found combined datetime by content analysis: "${a}" = "${c}"`);break}}if(s&&n[s]){const a=String(n[s]);console.log(`🧪 Sample data validation for combined field "${s}": "${a}"`),[/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}:\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{4}\s+\d{1,2}:\d{2}$/,/^\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2}$/].some(u=>u.test(a.trim()))?(o+=.4,console.log("✅ Data validation passed - full datetime pattern confirmed")):console.log("⚠️ Data validation failed - not a full datetime pattern")}return{type:"combined",confidence:o,combinedField:s,description:o>.7?`Combined datetime pattern detected: "${s}" contains full date and time`:"Potential combined pattern found but low confidence"}},Pr=(t,n)=>{console.log("🔍 Testing simple datetime pattern (volunteer department style)...");const r=/^date$/i,s=/^time$/i,o=t.find(p=>r.test(p)),a=t.find(p=>s.test(p));let c=0;return o&&a&&(c+=.4,console.log(`📅 Found simple date field: "${o}"`),console.log(`⏰ Found simple time field: "${a}"`),n[o]&&n[a]&&(c+=.3,console.log("🧪 Sample data available for validation"))),{type:"simple",confidence:c,dateField:o,timeField:a,description:c>.5?`Simple datetime pattern detected: basic "${o}" + "${a}" fields`:"Simple pattern check completed - low confidence"}},Lr=t=>{const n=[];return t.dateField&&t.timeField&&(n.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine "${t.dateField}" + "${t.timeField}" into full datetime for incident time`}),n.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"extract",description:`Extract date from "${t.dateField}" for incident date`})),n},zr=t=>{const n=[];return t.combinedField&&(n.push({sourceFields:[t.combinedField],targetField:"incident_time",transformationType:"direct",description:`Use "${t.combinedField}" directly for incident time`}),n.push({sourceFields:[t.combinedField],targetField:"incident_date",transformationType:"extract",description:`Extract date portion from "${t.combinedField}" for incident date`})),n},Vr=t=>{const n=[];return t.dateField&&t.timeField&&(n.push({sourceFields:[t.dateField,t.timeField],targetField:"incident_time",transformationType:"combine",description:`Combine simple "${t.dateField}" + "${t.timeField}" for incident time`}),n.push({sourceFields:[t.dateField],targetField:"incident_date",transformationType:"direct",description:`Use "${t.dateField}" for incident date`})),n},Ur=de(e.jsx("path",{d:"M3.9 12c0-1.71 1.39-3.1 3.1-3.1h4V7H7c-2.76 0-5 2.24-5 5s2.24 5 5 5h4v-1.9H7c-1.71 0-3.1-1.39-3.1-3.1M8 13h8v-2H8zm9-6h-4v1.9h4c1.71 0 3.1 1.39 3.1 3.1s-1.39 3.1-3.1 3.1h-4V17h4c2.76 0 5-2.24 5-5s-2.24-5-5-5"})),Yt=de(e.jsx("path",{d:"M13 7h-2v4H7v2h4v4h2v-4h4v-2h-4zm-1-5C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8"})),Br=de(e.jsx("path",{d:"m12 4-1.41 1.41L16.17 11H4v2h12.17l-5.58 5.59L12 20l8-8z"})),Hr=de(e.jsx("path",{d:"M16.01 11H4v2h12.01v3L20 12l-3.99-4z"})),Yr=de(e.jsx("path",{d:"m19 9 1.25-2.75L23 5l-2.75-1.25L19 1l-1.25 2.75L15 5l2.75 1.25zm-7.5.5L9 4 6.5 9.5 1 12l5.5 2.5L9 20l2.5-5.5L17 12zM19 15l-1.25 2.75L15 19l2.75 1.25L19 23l1.25-2.75L23 19l-2.75-1.25z"})),ot=de(e.jsx("path",{d:"M7.5 5.6 10 7 8.6 4.5 10 2 7.5 3.4 5 2l1.4 2.5L5 7zm12 9.8L17 14l1.4 2.5L17 19l2.5-1.4L22 19l-1.4-2.5L22 14zM22 2l-2.5 1.4L17 2l1.4 2.5L17 7l2.5-1.4L22 7l-1.4-2.5zm-7.63 5.29a.996.996 0 0 0-1.41 0L1.29 18.96c-.39.39-.39 1.02 0 1.41l2.34 2.34c.39.39 1.02.39 1.41 0L16.7 11.05c.39-.39.39-1.02 0-1.41zm-1.03 5.49-2.12-2.12 2.44-2.44 2.12 2.12z"})),Wr=de(e.jsx("path",{d:"M20 3h-1V1h-2v2H7V1H5v2H4c-1.1 0-2 .9-2 2v16c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m0 18H4V8h16z"})),Gr=de(e.jsx("path",{d:"M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.11 0 2-.9 2-2V5c0-1.1-.89-2-2-2m-9 14-5-5 1.41-1.41L10 14.17l7.59-7.59L19 8z"})),xs=de(e.jsx("path",{d:"M16.59 7.58 10 14.17l-3.59-3.58L5 12l5 5 8-8zM12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2m0 18c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),qr=de(e.jsx("path",{d:"M9.4 16.6 4.8 12l4.6-4.6L8 6l-6 6 6 6zm5.2 0 4.6-4.6-4.6-4.6L16 6l6 6-6 6z"})),Jr=de(e.jsx("path",{d:"M16 1H4c-1.1 0-2 .9-2 2v14h2V3h12zm3 4H8c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h11c1.1 0 2-.9 2-2V7c0-1.1-.9-2-2-2m0 16H8V7h11z"})),At=de(e.jsx("path",{d:"M15 4v2h3v12h-3v2h5V4zM4 20h5v-2H6V6h3V4H4z"})),ys=de(e.jsx("path",{d:"M4 7v2c0 .55-.45 1-1 1H2v4h1c.55 0 1 .45 1 1v2c0 1.65 1.35 3 3 3h3v-2H7c-.55 0-1-.45-1-1v-2c0-1.3-.84-2.42-2-2.83v-.34C5.16 11.42 6 10.3 6 9V7c0-.55.45-1 1-1h3V4H7C5.35 4 4 5.35 4 7m17 3c-.55 0-1-.45-1-1V7c0-1.65-1.35-3-3-3h-3v2h3c.55 0 1 .45 1 1v2c0 1.3.84 2.42 2 2.83v.34c-1.16.41-2 1.52-2 2.83v2c0 .55-.45 1-1 1h-3v2h3c1.65 0 3-1.35 3-3v-2c0-.55.45-1 1-1h1v-4z"})),ht=de(e.jsx("path",{d:"M11 15h2v2h-2zm0-8h2v6h-2zm.99-5C6.47 2 2 6.48 2 12s4.47 10 9.99 10C17.52 22 22 17.52 22 12S17.52 2 11.99 2M12 20c-4.42 0-8-3.58-8-8s3.58-8 8-8 8 3.58 8 8-3.58 8-8 8"})),Wt=de(e.jsx("path",{d:"M20 6h-8l-2-2H4c-1.1 0-1.99.9-1.99 2L2 18c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2m0 12H4V8h16z"})),Kr=de(e.jsx("path",{d:"M2 17h2v.5H3v1h1v.5H2v1h3v-4H2zm1-9h1V4H2v1h1zm-1 3h1.8L2 13.1v.9h3v-1H3.2L5 10.9V10H2zm5-6v2h14V5zm0 14h14v-2H7zm0-6h14v-2H7z"})),$t=de(e.jsx("path",{d:"M13 3c-4.97 0-9 4.03-9 9H1l3.89 3.89.07.14L9 12H6c0-3.87 3.13-7 7-7s7 3.13 7 7-3.13 7-7 7c-1.93 0-3.68-.79-4.94-2.06l-1.42 1.42C8.27 19.99 10.51 21 13 21c4.97 0 9-4.03 9-9s-4.03-9-9-9m-1 5v5l4.28 2.54.72-1.21-3.5-2.08V8z"})),Gt=de(e.jsx("path",{d:"M15.41 7.41 14 6l-6 6 6 6 1.41-1.41L10.83 12z"})),Xr=de(e.jsx("path",{d:"m20.5 10 .5-2h-4l1-4h-2l-1 4h-4l1-4h-2L9 8H5l-.5 2h4l-1 4h-4L3 16h4l-1 4h2l1-4h4l-1 4h2l1-4h4l.5-2h-4l1-4zm-7 4h-4l1-4h4z"})),qt=de([e.jsx("path",{d:"M13 8.57c-.79 0-1.43.64-1.43 1.43s.64 1.43 1.43 1.43 1.43-.64 1.43-1.43-.64-1.43-1.43-1.43"},"0"),e.jsx("path",{d:"M13 3C9.25 3 6.2 5.94 6.02 9.64L4.1 12.2c-.25.33-.01.8.4.8H6v3c0 1.1.9 2 2 2h1v3h7v-4.68c2.36-1.12 4-3.53 4-6.32 0-3.87-3.13-7-7-7m3 7c0 .13-.01.26-.02.39l.83.66c.08.06.1.16.05.25l-.8 1.39c-.05.09-.16.12-.24.09l-.99-.4c-.21.16-.43.29-.67.39L14 13.83c-.01.1-.1.17-.2.17h-1.6c-.1 0-.18-.07-.2-.17l-.15-1.06c-.25-.1-.47-.23-.68-.39l-.99.4c-.09.03-.2 0-.25-.09l-.8-1.39c-.05-.08-.03-.19.05-.25l.84-.66c-.01-.13-.02-.26-.02-.39s.02-.27.04-.39l-.85-.66c-.08-.06-.1-.16-.05-.26l.8-1.38c.05-.09.15-.12.24-.09l1 .4c.2-.15.43-.29.67-.39L12 6.17c.02-.1.1-.17.2-.17h1.6c.1 0 .18.07.2.17l.15 1.06c.24.1.46.23.67.39l1-.4c.09-.03.2 0 .24.09l.8 1.38c.05.09.03.2-.05.26l-.85.66c.03.12.04.25.04.39"},"1")]),Zr=de(e.jsx("path",{d:"M15.73 3H8.27L3 8.27v7.46L8.27 21h7.46L21 15.73V8.27zM12 17.3c-.72 0-1.3-.58-1.3-1.3s.58-1.3 1.3-1.3 1.3.58 1.3 1.3-.58 1.3-1.3 1.3m1-4.3h-2V7h2z"})),bs=de(e.jsx("path",{d:"M2.01 21 23 12 2.01 3 2 10l15 2-15 2z"})),Jt=de(e.jsx("path",{d:"M20 9V7c0-1.1-.9-2-2-2h-3c0-1.66-1.34-3-3-3S9 3.34 9 5H6c-1.1 0-2 .9-2 2v2c-1.66 0-3 1.34-3 3s1.34 3 3 3v4c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2v-4c1.66 0 3-1.34 3-3s-1.34-3-3-3M7.5 11.5c0-.83.67-1.5 1.5-1.5s1.5.67 1.5 1.5S9.83 13 9 13s-1.5-.67-1.5-1.5M16 17H8v-2h8zm-1-4c-.83 0-1.5-.67-1.5-1.5S14.17 10 15 10s1.5.67 1.5 1.5S15.83 13 15 13"})),Qr=de(e.jsx("path",{d:"m23 12-2.44-2.79.34-3.69-3.61-.82-1.89-3.2L12 2.96 8.6 1.5 6.71 4.69 3.1 5.5l.34 3.7L1 12l2.44 2.79-.34 3.7 3.61.82L8.6 22.5l3.4-1.47 3.4 1.46 1.89-3.19 3.61-.82-.34-3.69zm-12.91 4.72-3.8-3.81 1.48-1.48 2.32 2.33 5.85-5.87 1.48 1.48z"})),en=de([e.jsx("path",{d:"M12 5.99 19.53 19H4.47zM12 2 1 21h22z"},"0"),e.jsx("path",{d:"M13 16h-2v2h2zm0-6h-2v5h2z"},"1")]),Ft=[{id:"incident_type",name:"🔥 Incident Type",description:"Fire, medical, accident, alarm, etc.",pattern:/(fire|medical|ems|accident|mva|alarm|rescue|hazmat)/gi,enabled:!0},{id:"response_time",name:"⏱️ Response Time",description:'Time values like "30 min", "1:20", "half hour"',pattern:/(\d+)\s*(min|minutes|hour|hours|hr|hrs)|(\d{1,2}):(\d{2})|half.hour|quarter.hour/gi,enabled:!0},{id:"location",name:"📍 Location",description:"Addresses, street names, landmarks",pattern:/\d+\s+[\w\s]+(street|st|avenue|ave|road|rd|drive|dr|lane|ln|boulevard|blvd)/gi,enabled:!1},{id:"date_time",name:"📅 Date/Time",description:'Dates like "12/04/25", "April 12", times',pattern:/(\d{1,2}[\/\-]\d{1,2}[\/\-]\d{2,4})|(\w+\s+\d{1,2})|(\d{1,2}:\d{2})/gi,enabled:!1},{id:"units_resources",name:"🚒 Units/Resources",description:"Fire trucks, ambulances, personnel count",pattern:/(engine|truck|ambulance|rescue|ladder|chief|\d+\s*(firefighter|personnel|crew))/gi,enabled:!1}],tn=({open:t,onClose:n,columnName:r,sampleData:s,onParse:o})=>{const[a,c]=O.useState(["incident_type","response_time"]),[p,u]=O.useState(!1),[d,m]=O.useState([]),[y,T]=O.useState(!1);O.useEffect(()=>{a.length>0&&s.length>0&&A()},[a,s]);const F=i=>{c(l=>l.includes(i)?l.filter(h=>h!==i):[...l,i])},A=async()=>{u(!0);try{await new Promise(l=>setTimeout(l,500));const i=s.slice(0,5).map((l,h)=>({rowIndex:h,originalText:l,parsedFields:_(l,a)}));m(i)}catch(i){console.error("Error generating preview:",i)}finally{u(!1)}},_=(i,l)=>{const h={};return l.forEach(D=>{const k=Ft.find(Z=>Z.id===D);if(!k)return;const W=i.match(k.pattern);if(W&&W.length>0){const Z=W[0];console.log(`🔍 PARSING DEBUG - Field: ${D}, Pattern: ${k.pattern}, Text: "${i}", Match: "${Z}"`),h[D]={value:B(D,Z),confidence:S(D,Z),original:Z}}}),h},B=(i,l)=>{switch(i){case"incident_type":return I(l);case"response_time":return Y(l);case"location":return P(l);default:return l}},I=i=>{const l=i.toLowerCase();return l.includes("fire")?"Structure Fire":l.includes("medical")||l.includes("ems")?"Medical Emergency":l.includes("accident")||l.includes("mva")?"Motor Vehicle Accident":l.includes("alarm")?"Alarm Response":i},Y=i=>{const l=i.match(/(\d+)\s*(min|minutes|hour|hours|hr|hrs)/i);if(l){const D=parseInt(l[1]);return l[2].toLowerCase().startsWith("h")?`${D} hour${D!==1?"s":""}`:`${D} minute${D!==1?"s":""}`}const h=i.match(/(\d{1,2}):(\d{2})/);if(h){const D=parseInt(h[1]),k=parseInt(h[2]);return`${D}:${k.toString().padStart(2,"0")}`}return i},P=i=>i.replace(/\b\w/g,l=>l.toUpperCase()),S=(i,l,h)=>i==="response_time"&&l.match(/\d+\s*(min|minutes)/i)?.95:i==="incident_type"&&["fire","medical","accident"].includes(l.toLowerCase())?.9:.7,H=async()=>{if(a.length!==0){T(!0);try{await new Promise(l=>setTimeout(l,1e3));const i=s.map((l,h)=>({rowIndex:h,originalText:l,parsedFields:_(l,a)}));o(a,i),n()}catch(i){console.error("Error parsing narrative data:",i)}finally{T(!1)}}},K=()=>a.length,G=()=>d.filter(i=>Object.keys(i.parsedFields).length>0).length;return e.jsxs(Ke,{open:t,onClose:n,maxWidth:"md",fullWidth:!0,PaperProps:{sx:{minHeight:"70vh"}},children:[e.jsxs(Xe,{sx:{display:"flex",alignItems:"center",pb:1},children:[e.jsx(Jt,{sx:{mr:1,color:"primary.main"}}),'Parse Narrative: "',r,'"']}),e.jsxs(Ze,{sx:{pb:1},children:[e.jsx(x,{variant:"body2",color:"text.secondary",sx:{mb:3},children:"Extract structured data from narrative text using pattern matching and NLP. Select the fields you want to extract and preview the results."}),e.jsx(x,{variant:"h6",gutterBottom:!0,sx:{mt:2},children:"1. Select Fields to Extract"}),e.jsx(Us,{sx:{mb:3},children:Ft.map(i=>e.jsx(We,{control:e.jsx(Vs,{checked:a.includes(i.id),onChange:()=>F(i.id)}),label:e.jsxs(j,{children:[e.jsx(x,{variant:"body2",sx:{fontWeight:"medium"},children:i.name}),e.jsx(x,{variant:"caption",color:"text.secondary",children:i.description})]})},i.id))}),e.jsx(xe,{sx:{my:2}}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[e.jsx(x,{variant:"h6",sx:{flexGrow:1},children:"2. Preview Results"}),p&&e.jsx(Pe,{size:20,sx:{ml:2}})]}),a.length===0?e.jsx(ce,{severity:"info",sx:{mb:2},children:"Select at least one field to see preview results."}):e.jsxs(e.Fragment,{children:[e.jsxs(j,{sx:{display:"flex",gap:1,mb:2},children:[e.jsx(ie,{label:`${K()} fields selected`,size:"small",color:"primary"}),e.jsx(ie,{label:`${G()}/${d.length} rows with data`,size:"small",color:"success"})]}),e.jsxs(dt,{size:"small",sx:{mb:2},children:[e.jsx(ut,{children:e.jsxs(Re,{children:[e.jsx(Se,{children:"Original Text"}),a.map(i=>{const l=Ft.find(h=>h.id===i);return e.jsx(Se,{children:l==null?void 0:l.name},i)})]})}),e.jsx(pt,{children:d.map((i,l)=>e.jsxs(Re,{children:[e.jsx(Se,{sx:{maxWidth:200},children:e.jsx(x,{variant:"body2",sx:{overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:i.originalText})}),a.map(h=>e.jsx(Se,{children:i.parsedFields[h]?e.jsxs(j,{children:[e.jsx(x,{variant:"body2",children:i.parsedFields[h].value}),e.jsxs(x,{variant:"caption",color:"success.main",children:[Math.round(i.parsedFields[h].confidence*100),"% confident"]})]}):e.jsx(x,{variant:"caption",color:"text.secondary",children:"No match"})},h))]},l))})]}),e.jsx(ce,{severity:"info",sx:{mb:2},children:e.jsxs(x,{variant:"body2",children:[e.jsx("strong",{children:"Preview shows first 5 rows."})," Parsing accuracy is typically 70-85%. You can edit any incorrect values after parsing."]})})]})]}),e.jsxs(Qe,{sx:{p:3,pt:1},children:[e.jsx(se,{onClick:n,children:"Cancel"}),e.jsx(se,{variant:"contained",onClick:H,disabled:a.length===0||y,startIcon:y?e.jsx(Pe,{size:20}):e.jsx(Jt,{}),children:y?"Parsing...":`Parse ${r}`})]})]})},sn=({columnName:t,onClick:n,variant:r="icon",size:s="small",disabled:o=!1})=>{const a=()=>{n(t)};return r==="button"?e.jsx(se,{size:s,startIcon:e.jsx(ot,{}),onClick:a,disabled:o,sx:{minWidth:"auto",textTransform:"none",color:"primary.main","&:hover":{backgroundColor:"primary.50"}},children:"Parse"}):e.jsx(Ne,{title:`Parse narrative text in "${t}" column`,children:e.jsx("span",{children:e.jsx(Ce,{size:s,onClick:a,disabled:o,sx:{color:"primary.main","&:hover":{backgroundColor:"primary.50",transform:"scale(1.1)"},transition:"all 0.2s ease-in-out"},children:e.jsx(ot,{fontSize:s})})})})},rn=({parsedFields:t,onFieldDragStart:n,onDeleteParsedField:r})=>{if(t.length===0)return null;const s=a=>a>=.9?"success":a>=.7?"warning":"error",o=a=>a>=.9?"High confidence":a>=.7?"Medium confidence":"Low confidence";return e.jsxs(j,{sx:{mt:1,ml:2},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:1},children:[e.jsx(qt,{sx:{fontSize:16,color:"primary.main",mr:.5}}),e.jsx(x,{variant:"caption",color:"primary.main",sx:{fontWeight:"medium"},children:"Parsed Fields"})]}),e.jsx(tt,{spacing:.5,children:t.map(a=>e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:.5},children:[e.jsx(ie,{label:a.name,size:"small",color:"secondary",variant:"outlined",draggable:!0,onDragStart:c=>{c.stopPropagation(),n(c,a.id)},sx:{cursor:"grab","&:active":{cursor:"grabbing"},"&:hover":{backgroundColor:"secondary.50"}},icon:e.jsx(qt,{})}),e.jsx(Ne,{title:`${a.parsedCount}/${a.totalRows} rows parsed`,children:e.jsxs(x,{variant:"caption",color:"text.secondary",children:[Math.round(a.parsedCount/a.totalRows*100),"%"]})}),e.jsx(Ne,{title:o(a.confidence),children:e.jsx(qe,{sx:{fontSize:14,color:`${s(a.confidence)}.main`}})}),e.jsx(Ne,{title:"Delete parsed field",children:e.jsx(Ce,{size:"small",onClick:()=>r(a.id),sx:{ml:.5,"&:hover":{color:"error.main"}},children:e.jsx(nt,{sx:{fontSize:14}})})})]},a.id))}),e.jsx(x,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:"Drag parsed fields to target fields →"})]})},nn=({id:t,isMapped:n,targetFields:r,sampleValue:s,dataType:o,onParseColumn:a,parsedFields:c=[],onParsedFieldDragStart:p,onDeleteParsedField:u})=>{const d=(o==="Text"||!o&&typeof s=="string")&&typeof s=="string"&&s.length>20;t==="Notes"&&console.log("🔍 NARRATIVE PARSER DEBUG for Notes column:",{fieldId:t,dataType:o,sampleValue:s,sampleValueType:typeof s,sampleValueLength:typeof s=="string"?s.length:"N/A",isTextColumn:d,onParseColumn:!!a});const m={backgroundColor:n?"#f0f7ff":void 0,border:n?"1px solid #90caf9":"1px solid #e0e0e0",cursor:"grab",padding:"8px 12px",borderRadius:"4px",marginBottom:"8px",position:"relative"},y=F=>{console.log("DRAG START on source field:",t),F.dataTransfer.setData("text/plain",t),F.dataTransfer.effectAllowed="move",console.log("Verifying dataTransfer was set:",F.dataTransfer.types);const A=document.createElement("div");A.className="drag-ghost",A.innerHTML=`<div style="padding: 10px; background: #1976d2; color: white; border-radius: 4px;">Dragging: ${t}</div>`,document.body.appendChild(A),F.dataTransfer.setDragImage(A,20,20);const _=F.currentTarget;_.style.opacity="0.6",_.style.boxShadow="0 0 10px rgba(0, 0, 0, 0.2)",setTimeout(()=>{document.body.removeChild(A)},0),console.log("Drag started with field:",t)},T=F=>{const A=F.currentTarget;A.style.opacity="",A.style.boxShadow="",console.log("Drag ended for field:",t)};return e.jsx("div",{style:m,"data-field-id":t,className:"draggable-source-field",draggable:!0,onDragStart:y,onDragEnd:T,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsxs(j,{display:"flex",alignItems:"center",justifyContent:"space-between",children:[e.jsx(x,{variant:"body2",fontWeight:"medium",children:t}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[d&&a&&e.jsx(sn,{columnName:t,onClick:a,variant:"icon",size:"small"}),n&&e.jsx(ie,{size:"small",icon:e.jsx(Ur,{fontSize:"small"}),label:r.length===1?r[0]:`${r.length} fields`,color:"primary",variant:"outlined"})]})]}),s!==void 0&&e.jsxs(j,{sx:{mt:.5,display:"flex",alignItems:"center",justifyContent:"space-between",fontSize:"0.75rem"},children:[e.jsx(x,{variant:"caption",sx:{color:"text.secondary",fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"150px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap"},children:typeof s=="object"?JSON.stringify(s):String(s)}),o&&e.jsx(ie,{label:o,size:"small",variant:"outlined",sx:{height:"16px",fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]}),c.length>0&&e.jsx(rn,{parsedFields:c.map(F=>({id:F.id,name:F.name,sourceColumn:F.sourceColumn,parsedCount:F.parsedCount,totalRows:F.totalRows,confidence:F.confidence})),onFieldDragStart:p||(()=>{}),onDeleteParsedField:u||(()=>{})})]})})},on=({sourceColumns:t,filter:n,setFilter:r,mappings:s,sampleData:o=[],onAddParsedFields:a})=>{const[c,p]=O.useState(!1),[u,d]=O.useState(""),[m,y]=O.useState({}),T=i=>{d(i),p(!0)},F=()=>{p(!1),d("")},A=(i,l)=>{console.log("🔥 Parsing completed for column:",u),console.log("📊 Selected fields:",i),console.log("📋 Results:",l);const h=i.map(D=>{const k=_(D),W=[];let Z=0,le=0;l.forEach(L=>{L.parsedFields[D]?(W.push(L.parsedFields[D].value),Z++,le+=L.parsedFields[D].confidence):W.push(null)});const R=Z>0?le/Z:0;return{id:`${u}_${D}`,name:k,sourceColumn:u,parsedCount:Z,totalRows:l.length,confidence:R,data:W}});if(y(D=>({...D,[u]:h})),o&&o.length>0){const D=o.map((k,W)=>{const Z={...k};return h.forEach(le=>{if(le.data[W]!==null){const R=le.id.split("_").slice(1).join("_"),L=`${u}_parsed_${R}`;Z[L]=le.data[W],console.log(`🤖 INJECTED parsed data: ${L} = "${le.data[W]}"`)}}),Z});console.log("🤖 Updated sample data with parsed fields:",D)}a&&a(u,h)},_=i=>({incident_type:"📊 Parsed Incident Type",response_time:"⏱️ Parsed Response Time",location:"📍 Parsed Location",date_time:"📅 Parsed Date/Time",units_resources:"🚒 Parsed Units/Resources"})[i]||`🤖 Parsed ${i}`,B=(i,l)=>{console.log("🔥 Dragging parsed field:",l),i.dataTransfer.setData("text/plain",l),i.dataTransfer.effectAllowed="move"},I=i=>{console.log("🗑️ Deleting parsed field:",i);const l=Object.keys(m).find(h=>m[h].some(D=>D.id===i));l&&y(h=>({...h,[l]:h[l].filter(D=>D.id!==i)}))},Y=i=>!o||o.length===0?[]:o.slice(0,10).map(l=>l[i]||"").filter(Boolean),P=O.useMemo(()=>{if(!n)return t;const i=n.toLowerCase();return t.filter(l=>l.toLowerCase().includes(i))},[t,n]),S=O.useMemo(()=>{const i={};return s.forEach(l=>{i[l.sourceField]||(i[l.sourceField]=[]),i[l.sourceField].push(l.targetField)}),i},[s]),H=O.useMemo(()=>Object.keys(S).length,[S]),K=O.useMemo(()=>{if(!o||o.length===0)return{};const i=o[0],l={};return t.forEach(h=>{l[h]=i[h]}),l},[o,t]),G=O.useMemo(()=>{const i={};return Object.entries(K).forEach(([l,h])=>{if(h==null){i[l]="Unknown";return}if(typeof h=="string"){if([/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/,/^\d{4}\/\d{2}\/\d{2}$/].some(W=>W.test(h))){i[l]="Date";return}if([/^\d{1,2}:\d{2}(:\d{2})?$/,/^\d{1,2}:\d{2}(:\d{2})?\s*(AM|PM)$/i].some(W=>W.test(h))){i[l]="Time";return}if(!isNaN(Number(h))){i[l]="Number";return}i[l]="Text";return}typeof h=="number"?i[l]="Number":typeof h=="boolean"?i[l]="Boolean":Array.isArray(h)?i[l]="Array":typeof h=="object"?i[l]="Object":i[l]=typeof h}),i},[K]);return e.jsxs(ge,{sx:{height:"100%",p:2,display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsx(be,{size:"small",placeholder:"Search source fields...",value:n,onChange:i=>r(i.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(rt,{fontSize:"small"})})}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(x,{variant:"body2",color:"text.secondary",children:[P.length," fields"]}),e.jsxs(x,{variant:"body2",color:"text.secondary",children:[H," mapped"]})]}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(x,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drag fields from here to the Target Fields panel"})}),e.jsx(xe,{sx:{mb:2}}),e.jsxs(j,{sx:{flexGrow:1,overflow:"auto",maxHeight:"calc(100% - 180px)",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:[P.map(i=>e.jsx(nn,{id:i,isMapped:!!S[i],targetFields:S[i]||[],sampleValue:K[i],dataType:G[i],onParseColumn:T,parsedFields:m[i]||[],onParsedFieldDragStart:B,onDeleteParsedField:I},i)),P.length===0&&e.jsx(j,{sx:{textAlign:"center",py:4},children:e.jsx(x,{variant:"body2",color:"text.secondary",children:"No fields match your search"})})]}),e.jsx(tn,{open:c,onClose:F,columnName:u,sampleData:Y(u),onParse:A})]})},an=({open:t,onClose:n,fieldName:r,mapping:s,sampleData:o,onSave:a})=>{const[c,p]=O.useState(0),[u,d]=O.useState([]),[m,y]=O.useState("auto"),[T,F]=O.useState(""),[A,_]=O.useState(","),[B,I]=O.useState(0),[Y,P]=O.useState("string");O.useEffect(()=>{if(s){if(s.sourceField&&o.length>0){const l=o.map(h=>h[s.sourceField]).filter(h=>h!=null).slice(0,5);d(l)}s.transformations&&s.transformations.length>0&&s.transformations.forEach(l=>{switch(l.type){case"format":const h=l.params.format||l.params.dateFormat;h&&(h==="custom"?(y("custom"),F(l.params.customFormat||"")):y(h));break;case"split":_(l.params.delimiter||","),I(l.params.index||0);break;case"convert":P(l.params.toType||"string");break}})}},[s,o]);const S=(l,h)=>{p(h)},H=()=>{const l=[];c===0&&m!=="auto"&&l.push({type:"format",params:{type:"date",format:m,fieldName:r,...m==="custom"?{customFormat:T}:{}}}),c===1&&l.push({type:"split",params:{delimiter:A,index:B}}),c===2&&l.push({type:"convert",params:{toType:Y}}),a(r,l)},K=u.length>0,i=(()=>{if(!K)return[];switch(c){case 0:return u.map(l=>{if(!l)return"N/A";try{const h=new Date(l);if(isNaN(h.getTime()))return"Invalid date";switch(m){case"auto":return h.toLocaleString();case"MM/DD/YYYY":return`${h.getMonth()+1}/${h.getDate()}/${h.getFullYear()}`;case"YYYY-MM-DD":return`${h.getFullYear()}-${(h.getMonth()+1).toString().padStart(2,"0")}-${h.getDate().toString().padStart(2,"0")}`;case"DD/MM/YYYY":return`${h.getDate()}/${h.getMonth()+1}/${h.getFullYear()}`;case"date-only":return new Date(l).toLocaleDateString();case"custom":return T.replace("YYYY",h.getFullYear().toString()).replace("MM",(h.getMonth()+1).toString().padStart(2,"0")).replace("DD",h.getDate().toString().padStart(2,"0")).replace("HH",h.getHours().toString().padStart(2,"0")).replace("mm",h.getMinutes().toString().padStart(2,"0")).replace("ss",h.getSeconds().toString().padStart(2,"0"));default:return h.toLocaleString()}}catch{return"Error formatting date"}});case 1:return u.map(l=>{if(!l)return"N/A";try{return l.toString().split(A)[B]||`Index ${B} not found`}catch{return"Error splitting value"}});case 2:return u.map(l=>{if(l==null)return"N/A";try{switch(Y){case"string":return String(l);case"number":return Number(l);case"boolean":return(!!l).toString();default:return String(l)}}catch{return"Error converting value"}})}return[]})();return e.jsxs(Ke,{open:t,onClose:n,maxWidth:"md",fullWidth:!0,children:[e.jsxs(Xe,{children:["Transform Field: ",r]}),e.jsx(Ze,{dividers:!0,children:e.jsxs(j,{sx:{width:"100%"},children:[e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:c,onChange:S,"aria-label":"transformation tabs",children:[e.jsx(_e,{label:"Date/Time Format"}),e.jsx(_e,{label:"Split/Extract"}),e.jsx(_e,{label:"Type Conversion"})]})}),e.jsxs(j,{role:"tabpanel",hidden:c!==0,sx:{p:2},children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:"Date Format Settings"}),e.jsx(x,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Choose how date and time values should be formatted. Date-only formats automatically strip time components."}),e.jsxs(Le,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ue,{id:"date-format-label",children:"Date Format"}),e.jsxs(Be,{labelId:"date-format-label",id:"date-format-select",value:m,label:"Date Format",onChange:l=>y(l.target.value),children:[e.jsx(oe,{value:"auto",children:"Auto-detect"}),e.jsx(oe,{value:"MM/DD/YYYY",children:"MM/DD/YYYY (date only)"}),e.jsx(oe,{value:"DD/MM/YYYY",children:"DD/MM/YYYY (date only)"}),e.jsx(oe,{value:"YYYY-MM-DD",children:"YYYY-MM-DD (date only)"}),e.jsx(oe,{value:"date-only",children:"Date Only (strip time)"}),e.jsx(oe,{value:"custom",children:"Custom Format"})]})]}),m==="custom"&&e.jsx(be,{fullWidth:!0,label:"Custom Format",value:T,onChange:l=>F(l.target.value),helperText:"Use YYYY for year, MM for month, DD for day, HH for hour, mm for minute, ss for second",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:c!==1,sx:{p:2},children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:"Split or Extract Value"}),e.jsx(x,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Split a field by a delimiter and extract a specific part."}),e.jsx(be,{fullWidth:!0,label:"Delimiter",value:A,onChange:l=>_(l.target.value),helperText:"Character or text that separates the parts",sx:{mb:2}}),e.jsx(be,{fullWidth:!0,label:"Index",type:"number",value:B,onChange:l=>I(parseInt(l.target.value)||0),helperText:"Position of the part to extract (0 = first part)",sx:{mb:2}})]}),e.jsxs(j,{role:"tabpanel",hidden:c!==2,sx:{p:2},children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:"Type Conversion"}),e.jsx(x,{variant:"body2",color:"text.secondary",paragraph:!0,children:"Convert the value to a different data type."}),e.jsxs(Le,{fullWidth:!0,sx:{mb:2},children:[e.jsx(Ue,{id:"convert-type-label",children:"Convert To"}),e.jsxs(Be,{labelId:"convert-type-label",id:"convert-type-select",value:Y,label:"Convert To",onChange:l=>P(l.target.value),children:[e.jsx(oe,{value:"string",children:"Text (String)"}),e.jsx(oe,{value:"number",children:"Number"}),e.jsx(oe,{value:"boolean",children:"True/False (Boolean)"})]})]})]}),e.jsx(xe,{sx:{my:2}}),e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:"Preview"}),K?e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:[e.jsxs(j,{sx:{display:"flex",borderBottom:1,borderColor:"divider",pb:1},children:[e.jsx(x,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Original Value"}),e.jsx(x,{variant:"body2",fontWeight:"bold",sx:{width:"50%"},children:"Transformed Value"})]}),u.map((l,h)=>e.jsxs(j,{sx:{display:"flex",py:1,borderBottom:"1px solid #eee"},children:[e.jsx(x,{variant:"body2",sx:{width:"50%"},children:l==null?"Null/Empty":String(l)}),e.jsx(x,{variant:"body2",sx:{width:"50%"},children:i[h]})]},h))]}):e.jsx(ce,{severity:"info",children:"No sample data available for preview."})]})}),e.jsxs(Qe,{children:[e.jsx(se,{onClick:n,children:"Cancel"}),e.jsx(se,{onClick:H,variant:"contained",children:"Apply Transformation"})]})]})},ln=t=>{switch(t.dataType){case"string":return`DEFAULT-${t.name}`;case"number":return"0";case"boolean":return"false";case"date":return new Date().toISOString().split("T")[0];case"location":return"0.0,0.0";default:return""}},cn=({open:t,onClose:n,unmappedRequiredFields:r,onAddDefaultMappings:s})=>{const[o,a]=O.useState(()=>{const d={};return r.forEach(m=>{d[m.name]=ln(m)}),d}),c=(d,m)=>{a(y=>({...y,[d]:m}))},p=()=>{console.log("Creating default mappings for fields:",r),console.log("Default values:",o);const d=r.map(m=>{const y={sourceField:"__default__",targetField:m.name,transformations:[{type:"convert",params:{defaultValue:o[m.name],targetType:m.dataType}}]};return console.log(`Created default mapping for ${m.name}:`,y),y});console.log("All default mappings:",d),s(d),n()},u=d=>{switch(d){case"number":return"number";case"date":return"date";default:return"text"}};return e.jsxs(Ke,{open:t,onClose:n,"aria-labelledby":"default-value-dialog-title",maxWidth:"md",fullWidth:!0,children:[e.jsx(Xe,{id:"default-value-dialog-title",children:"Set Default Values for Required Fields"}),e.jsxs(Ze,{children:[e.jsx(x,{variant:"body1",sx:{mb:3},children:"The following required fields don't have mappings. Please provide default values for them."}),e.jsx(pe,{container:!0,spacing:3,children:r.map(d=>e.jsxs(pe,{size:{xs:12,sm:6},children:[e.jsxs(j,{sx:{mb:1},children:[e.jsxs(x,{variant:"subtitle2",children:[d.name,e.jsx(ie,{size:"small",label:d.dataType,color:"primary",variant:"outlined",sx:{ml:1}})]}),e.jsx(x,{variant:"caption",color:"text.secondary",children:d.description})]}),d.dataType==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:o[d.name]||"false",onChange:m=>c(d.name,m.target.value),variant:"outlined",size:"small",children:[e.jsx(oe,{value:"true",children:"True"}),e.jsx(oe,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:o[d.name]||"",onChange:m=>c(d.name,m.target.value),type:u(d.dataType),variant:"outlined",size:"small",placeholder:`Enter default value for ${d.name}`,InputLabelProps:{shrink:!0}}),e.jsx(Ps,{children:"Default value for all records"})]},d.name))})]}),e.jsxs(Qe,{children:[e.jsx(se,{onClick:n,color:"primary",children:"Cancel"}),e.jsx(se,{onClick:p,color:"primary",variant:"contained",children:"Apply Default Values"})]})]})},dn=({mapping:t,sampleData:n,onClose:r})=>{const s=Ot(),o=O.useMemo(()=>!t||!n.length?[]:n.slice(0,5).map(c=>({sourceValue:c[t.sourceField],transformedValue:(t.transformations||[]).reduce((p,u)=>fs(p,u,t.targetField),c[t.sourceField])})),[t,n]);if(!t)return e.jsx(ge,{sx:{p:2,mt:2,backgroundColor:me(s.palette.info.light,.1),border:`1px dashed ${s.palette.info.main}`,borderRadius:1},children:e.jsx(x,{variant:"body2",color:"text.secondary",align:"center",children:"Select a field mapping to see transformation preview"})});if(!o.length||!t.sourceField)return e.jsx(ge,{sx:{p:2,mt:2,backgroundColor:me(s.palette.warning.light,.1),border:`1px dashed ${s.palette.warning.main}`,borderRadius:1},children:e.jsxs(x,{variant:"body2",color:"text.secondary",children:["No sample data available for ",t.sourceField||"this field"]})});const a=t.transformations||[];return e.jsxs(ge,{sx:{p:2,mt:2,borderRadius:1,border:`1px solid ${s.palette.divider}`,boxShadow:s.shadows[1],position:"relative"},children:[r&&e.jsx(Ce,{size:"small",onClick:r,sx:{position:"absolute",top:8,right:8,color:s.palette.grey[500],"&:hover":{backgroundColor:me(s.palette.grey[100],.9),color:s.palette.grey[800]}},"aria-label":"close preview",children:e.jsx(qs,{fontSize:"small"})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:1,pr:4},children:[e.jsxs(x,{variant:"subtitle2",color:"primary",gutterBottom:!0,children:["Field Transformation Preview: ",t.targetField]}),e.jsx(ie,{size:"small",label:`${a.length} transformation${a.length!==1?"s":""}`,color:a.length>0?"primary":"default",icon:a.length>0?e.jsx(ot,{}):void 0})]}),e.jsx(xe,{sx:{mb:2}}),e.jsx(j,{sx:{maxHeight:200,overflow:"auto"},children:o.map((c,p)=>{const u=c.sourceValue!==void 0&&c.sourceValue!==null,d=a.length>0,m=typeof c.sourceValue,y=typeof c.transformedValue,T=m!==y;return e.jsxs(j,{sx:{mb:1,p:1,borderRadius:1,backgroundColor:p%2===0?me(s.palette.background.default,.5):"transparent",display:"flex",alignItems:"center"},children:[e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(x,{variant:"caption",color:"text.secondary",children:["Source (",t.sourceField,")"]}),e.jsx(x,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:u?me(s.palette.success.light,.1):me(s.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:u?String(c.sourceValue):"(empty)"}),e.jsx(x,{variant:"caption",color:"text.secondary",children:m})]}),e.jsx(j,{sx:{flexBasis:"10%",textAlign:"center"},children:e.jsx(Hr,{color:d?"primary":"action"})}),e.jsxs(j,{sx:{flexBasis:"45%"},children:[e.jsxs(x,{variant:"caption",color:"text.secondary",children:["Result (",t.targetField,")"]}),e.jsx(x,{variant:"body2",sx:{fontFamily:"monospace",backgroundColor:c.transformedValue!==void 0?me(s.palette.success.light,.1):me(s.palette.error.light,.1),p:.5,borderRadius:.5,wordBreak:"break-all"},children:c.transformedValue!==void 0?String(c.transformedValue):"(empty)"}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(x,{variant:"caption",color:"text.secondary",children:y}),T&&e.jsx(ie,{size:"small",label:`Type: ${m} → ${y}`,color:"warning",variant:"outlined",sx:{height:16,fontSize:"0.6rem"}})]})]})]},p)})}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(xe,{sx:{my:2}}),e.jsx(x,{variant:"subtitle2",gutterBottom:!0,children:"Transformation Steps Applied:"}),e.jsx(j,{sx:{display:"flex",flexDirection:"column",gap:1},children:a.map((c,p)=>{var u,d,m,y,T,F,A,_,B;return e.jsxs(j,{sx:{display:"flex",alignItems:"center",p:1,borderRadius:1,backgroundColor:me(s.palette.primary.light,.05),border:`1px solid ${me(s.palette.primary.light,.2)}`},children:[e.jsxs(j,{sx:{mr:1,color:s.palette.primary.main},children:[p+1,"."]}),e.jsxs(x,{variant:"body2",children:[e.jsxs("strong",{children:[c.type,":"]})," "," ",c.type==="convert"&&((u=c.params)==null?void 0:u.dataType)&&`Convert to ${c.params.dataType}`,c.type==="convert"&&((d=c.params)==null?void 0:d.defaultValue)!==void 0&&`Set default value to "${c.params.defaultValue}"`,c.type==="format"&&((m=c.params)==null?void 0:m.type)==="date"&&(((y=c.params)==null?void 0:y.format)||((T=c.params)==null?void 0:T.dateFormat))&&`Format date as "${c.params.format||c.params.dateFormat}"${c.params.customFormat?` (${c.params.customFormat})`:""}`,c.type==="format"&&((F=c.params)==null?void 0:F.pattern)&&`Format using pattern "${c.params.pattern}"`,c.type==="extract"&&((A=c.params)==null?void 0:A.pattern)&&`Extract using pattern "${c.params.pattern}"`,c.type==="replace"&&((_=c.params)==null?void 0:_.from)&&((B=c.params)==null?void 0:B.to)&&`Replace "${c.params.from}" with "${c.params.to}"`]})]},p)})})]}),t.targetField&&e.jsxs(j,{sx:{mt:2,p:1,borderRadius:1,display:"flex",alignItems:"center",backgroundColor:o.some(c=>c.transformedValue===void 0||c.transformedValue===null)?me(s.palette.warning.light,.1):me(s.palette.success.light,.1)},children:[o.some(c=>c.transformedValue===void 0||c.transformedValue===null)?e.jsx(ht,{color:"warning",sx:{mr:1}}):e.jsx(xs,{color:"success",sx:{mr:1}}),e.jsx(x,{variant:"body2",children:o.some(c=>c.transformedValue===void 0||c.transformedValue===null)?"Some values could not be transformed. Consider adding a default value.":"All sample values were successfully transformed."})]})]})},un=ft(({className:t,...n})=>e.jsx(Ne,{...n,classes:{popper:t}}))(()=>({"& .MuiTooltip-tooltip":{backgroundColor:"transparent",padding:0,maxWidth:320}})),pn=ft(ge)(({theme:t})=>({padding:t.spacing(2),backgroundColor:t.palette.background.paper,boxShadow:t.shadows[3],borderRadius:t.shape.borderRadius,border:`1px solid ${t.palette.divider}`,minWidth:200,maxWidth:320})),mn=ft(x)(({theme:t})=>({fontWeight:600,marginBottom:t.spacing(1),borderBottom:`1px solid ${t.palette.divider}`,paddingBottom:t.spacing(.5),color:t.palette.primary.main})),Ye=({title:t,children:n,content:r,icon:s=!1,placement:o="top",enterDelay:a=100,leaveDelay:c=100})=>{console.log(`EnhancedTooltip rendering: ${t} with icon=${s}`);const p=s?e.jsxs(j,{sx:{display:"inline-flex",alignItems:"center"},children:[n,e.jsx(Js,{color:"action",fontSize:"small",sx:{ml:.5,opacity:.7}})]}):n;return e.jsx(un,{title:e.jsxs(pn,{children:[e.jsx(mn,{variant:"subtitle2",children:t}),r]}),placement:o,arrow:!0,enterDelay:a,leaveDelay:c,children:p})},hn=({toolConfig:t,showAllFields:n,setShowAllFields:r,filter:s,setFilter:o,mappings:a,onMappingChange:c,onRemoveMapping:p,validationErrors:u,sampleData:d,sourceColumns:m=[]})=>{const y=Ot();console.log("TargetFieldsPanel received sourceColumns:",m),console.log("TargetFieldsPanel received toolConfig:",t),console.log("TargetFieldsPanel received mappings:",a);const[T,F]=O.useState(null),[A,_]=O.useState(null),[B,I]=O.useState({Timing:!0,Location:!0,"Incident Details":!0}),Y=O.useMemo(()=>{const f={};return u.forEach(z=>{f[z.field]={message:z.message,severity:z.severity}}),f},[u]),P=O.useMemo(()=>{const f={};return a.forEach(z=>{f[z.targetField]=z.sourceField}),f},[a]),S=O.useMemo(()=>{const f={};return[...t.requiredFields,...t.optionalFields].forEach($=>{let V;$.dataType==="date"||$.name.toLowerCase().includes("time")||$.name.toLowerCase().includes("date")?V="Timing":$.dataType==="location"||$.name.toLowerCase().includes("lat")||$.name.toLowerCase().includes("lon")||$.name.toLowerCase().includes("address")?V="Location":V="Incident Details",f[V]||(f[V]=[]),f[V].push($)}),f},[t]),H=O.useMemo(()=>{if(!s)return n?[...t.requiredFields,...t.optionalFields]:S;const f=s.toLowerCase(),$=[...t.requiredFields,...t.optionalFields].filter(C=>{var v;return C.name.toLowerCase().includes(f)||((v=C.description)==null?void 0:v.toLowerCase().includes(f))});if(n)return $;const V={};return $.forEach(C=>{let v;for(const[E,q]of Object.entries(S))if(q.some(J=>J.id===C.id)){v=E;break}v||(v="Other"),V[v]||(V[v]=[]),V[v].push(C)}),V},[t,s,n,S]),K=f=>{I({...B,[f]:!B[f]})},G=(f,z)=>{console.log("Dropdown selection - mapping",z,"to",f);try{if(!z){p(f);return}c({sourceField:z,targetField:f}),console.log("Mapping updated via dropdown successfully")}catch($){console.error("Error updating mapping via dropdown:",$)}},i=f=>{F(f)},l=()=>{F(null)},h=f=>{_(z=>z===f?null:f)},D=(f,z)=>{const $=a.find(V=>V.targetField===f);$&&c({...$,transformations:z}),F(null)},k=f=>{switch(f){case"string":return{icon:e.jsx(Vt,{fontSize:"small"}),color:"info"};case"number":return{icon:e.jsx(Xr,{fontSize:"small"}),color:"secondary"};case"date":return{icon:e.jsx(Wr,{fontSize:"small"}),color:"warning"};case"boolean":return{icon:e.jsx(Gr,{fontSize:"small"}),color:"success"};case"location":return{icon:e.jsx(Ys,{fontSize:"small"}),color:"error"};default:return{icon:e.jsx(Vt,{fontSize:"small"}),color:"default"}}},W=f=>{const z=P[f.id],$=Y[f.id],V=A===f.id;console.log(`🔧 FIELD RENDER: ${f.name} (ID: ${f.id}), mapped to: ${z||"none"}`);const C=M=>{M.preventDefault(),M.stopPropagation(),M.dataTransfer.dropEffect="move";const b=M.currentTarget;b.style.boxShadow="0 0 0 2px #1976d2",b.style.borderColor="#1976d2",b.style.backgroundColor="#f0f7ff",b.style.transform="scale(1.01)",b.style.transition="all 0.2s ease",console.log("DRAG OVER on target field:",f.name)},v=M=>{M.preventDefault(),M.stopPropagation();const b=M.currentTarget;b.style.boxShadow="",b.style.borderColor=$?$.severity==="error"?"#f44336":"#ff9800":z?"#4caf50":"#e0e0e0",b.style.backgroundColor=$?$.severity==="error"?"#fff5f5":"#fffbf0":z?"#f4fbf4":"#ffffff",b.style.transform="",console.log("DRAG LEAVE from field:",f.name)},E=M=>{M.preventDefault(),M.stopPropagation(),console.log("DROP EVENT TRIGGERED on field:",f.name);try{const b=M.dataTransfer.getData("text/plain");if(console.log("Dropped source field data:",b),!b){console.error("No source field data found in the drop event");return}const g=M.currentTarget;g.style.boxShadow="",g.style.borderColor="",g.style.backgroundColor="",g.style.transform="",c({sourceField:b,targetField:f.id}),_(f.id),g.style.boxShadow="0 0 0 2px #4caf50",g.style.borderColor="#4caf50",g.style.backgroundColor="#f4fbf4",g.style.transform="scale(1.02)";const N=b;setTimeout(()=>{try{N?(g.style.borderColor="#4caf50",g.style.backgroundColor="#f4fbf4"):(g.style.borderColor=$?$.severity==="error"?"#f44336":"#ff9800":"#e0e0e0",g.style.backgroundColor=$?$.severity==="error"?"#fff5f5":"#fffbf0":"#ffffff"),g.style.boxShadow="",g.style.transform=""}catch(U){console.error("Error in animation cleanup:",U)}},1e3),console.log(`Successfully dropped ${b} onto ${f.name}`)}catch(b){console.error("Error in drop handler:",b)}},q=()=>{z&&h(f.name)},J=()=>e.jsxs(j,{children:[e.jsxs(x,{variant:"body2",children:[e.jsx("strong",{children:"Required Format:"})," ",f.format||"No specific format required"]}),f.examples&&e.jsxs(j,{sx:{mt:1},children:[e.jsx(x,{variant:"body2",children:e.jsx("strong",{children:"Examples:"})}),e.jsx(j,{component:"ul",sx:{mt:.5,pl:2},children:f.examples.map((M,b)=>e.jsx(j,{component:"li",children:e.jsx(x,{variant:"body2",fontFamily:"monospace",children:M})},b))})]}),f.validation&&e.jsxs(x,{variant:"body2",sx:{mt:1},children:[e.jsx("strong",{children:"Validation:"})," ",String(f.validation)]})]}),w=()=>{let M="";switch(f.dataType){case"string":M="Text value. Can contain any characters.";break;case"number":M="Numeric value. Can be integer or decimal.";break;case"date":M="Date value. Should be in a standard format.";break;case"boolean":M="True/False value.";break;case"location":M="Geographic coordinates or address.";break;default:M=`${f.dataType} data type.`}return e.jsxs(j,{children:[e.jsx(x,{variant:"body2",children:M}),f.dataType==="date"&&e.jsx(x,{variant:"body2",sx:{mt:1},children:"Common formats: YYYY-MM-DD, MM/DD/YYYY"})]})};return e.jsxs(j,{sx:{p:2,mb:2,border:"1px solid",borderColor:$?$.severity==="error"?"error.main":"warning.main":z?"success.light":"divider",borderRadius:1,bgcolor:$?$.severity==="error"?me(y.palette.error.light,.1):me(y.palette.warning.light,.1):z?me(y.palette.success.light,.1):"background.paper",position:"relative",transition:"all 0.3s ease",userSelect:"none",WebkitUserSelect:"none",MozUserSelect:"none",msUserSelect:"none",cursor:z?"pointer":"default",...V&&{boxShadow:"0 0 0 2px #1976d2",border:"1px solid #1976d2"},"&:hover":z?{boxShadow:"0 2px 4px rgba(0,0,0,0.1)",transform:"translateY(-2px)"}:{}},draggable:!1,id:`target-field-${f.id}`,"data-target-field":f.id,onDragOver:C,onDragLeave:v,onDrop:E,onClick:q,children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mb:1},children:[e.jsxs(j,{children:[e.jsx(Ye,{title:`${f.name} Field`,content:J(),placement:"top-start",icon:!0,children:e.jsxs(x,{variant:"subtitle2",component:"div",sx:{display:"inline-flex",alignItems:"center",cursor:"help"},children:[f.name,f.isRequired&&e.jsx(ie,{size:"small",label:"Required",color:"primary",sx:{ml:1,height:20}}),z&&e.jsx(ie,{size:"small",label:"Click to preview",color:"info",variant:"outlined",sx:{ml:1,height:20,display:{xs:"none",sm:"flex"},animation:V?"none":"pulse 1.5s infinite","@keyframes pulse":{"0%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0.4)"},"70%":{boxShadow:"0 0 0 6px rgba(33, 150, 243, 0)"},"100%":{boxShadow:"0 0 0 0 rgba(33, 150, 243, 0)"}}}})]})}),f.dataType&&e.jsx(Ye,{title:`${f.dataType} Data Type`,content:w(),children:e.jsx(ie,{size:"small",label:f.dataType,color:k(f.dataType).color,variant:"outlined",icon:k(f.dataType).icon,sx:{mt:1,mr:1,height:20}})}),e.jsx(x,{variant:"body2",color:"text.secondary",children:f.description})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"flex-start"},children:[$&&e.jsx(Ye,{title:"Validation Issue",content:e.jsx(x,{variant:"body2",children:$.message}),type:$.severity==="error"?"warning":"info",children:e.jsx(j,{sx:{display:"flex",alignItems:"center",mr:1},children:$.severity==="error"?e.jsx(us,{color:"error",fontSize:"small"}):e.jsx(ps,{color:"warning",fontSize:"small"})})}),z&&e.jsxs(e.Fragment,{children:[e.jsx(Ye,{title:"Edit Transformations",content:e.jsx(x,{variant:"body2",children:"Configure data transformations for this field mapping. Apply operations like splitting, joining, formatting and type conversion."}),children:e.jsx(Ce,{size:"small",onClick:M=>{M.stopPropagation(),i(f.id)},sx:{mr:1},children:e.jsx(ds,{fontSize:"small"})})}),e.jsx(Ye,{title:"Remove Mapping",content:e.jsx(x,{variant:"body2",children:"Remove the current mapping between source and target fields."}),type:"warning",children:e.jsx(Ce,{size:"small",onClick:M=>{M.stopPropagation(),p(f.id)},children:e.jsx(nt,{fontSize:"small"})})})]})]})]}),e.jsxs(Le,{fullWidth:!0,size:"small",children:[e.jsx(Ue,{id:`${f.id}-source-label`,children:"Select source field"}),e.jsxs(Be,{labelId:`${f.id}-source-label`,id:`${f.id}-source-select`,value:z||"",label:"Select source field",onChange:M=>{try{G(f.id,M.target.value),M.target.value?_(f.name):A===f.name&&_(null)}catch(b){console.error("Error in dropdown change handler:",b)}},MenuProps:{anchorOrigin:{vertical:"bottom",horizontal:"left"},transformOrigin:{vertical:"top",horizontal:"left"},slotProps:{paper:{elevation:4,style:{maxHeight:300}}}},renderValue:M=>M||e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"}),endAdornment:z&&e.jsx(Ae,{position:"end",children:e.jsx(Ye,{title:"Field is Mapped",content:e.jsxs(x,{variant:"body2",children:['This field is mapped to source field "',z,'". Click the field to preview the mapping.']}),children:e.jsx(qe,{color:"success",fontSize:"small"})})}),onClick:M=>M.stopPropagation(),children:[e.jsx(oe,{value:"",children:e.jsx("em",{style:{color:"rgba(0, 0, 0, 0.54)"},children:"Select field or drag from left"})}),Array.isArray(m)&&m.length>0?m.map(M=>{const b=d&&d.length>0?d[0][M]:void 0;let g="Unknown";b!=null&&(typeof b=="string"?[/^\d{4}-\d{2}-\d{2}$/,/^\d{1,2}\/\d{1,2}\/\d{2,4}$/].some(X=>X.test(b))?g="Date":/^\d{1,2}:\d{2}(:\d{2})?(\s*(AM|PM))?$/i.test(b)?g="Time":isNaN(Number(b))?g="Text":g="Number":g=typeof b);const N=U=>U==null?"":typeof U=="object"?JSON.stringify(U).substring(0,30):String(U).substring(0,30);return e.jsx(oe,{value:M,children:e.jsxs(j,{sx:{display:"flex",flexDirection:"column",width:"100%"},children:[e.jsx(x,{variant:"body2",children:M}),b!==void 0&&e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:.5},children:[e.jsx(x,{variant:"caption",sx:{fontFamily:"monospace",bgcolor:"grey.100",px:.5,borderRadius:.5,maxWidth:"120px",overflow:"hidden",textOverflow:"ellipsis",whiteSpace:"nowrap",color:"text.secondary"},children:N(b)}),e.jsx(ie,{label:g,size:"small",sx:{height:16,fontSize:"0.65rem","& .MuiChip-label":{px:.5,py:0}}})]})]})},M)}):e.jsx(oe,{disabled:!0,children:e.jsx("em",{children:"No source fields available"})})]})]})]},f.id)},Z=()=>{if(n){const f=Array.isArray(H)?H:Object.values(H).flat();return e.jsx(j,{children:f.map(W)})}else return Object.entries(H).map(([f,z])=>e.jsxs(as,{expanded:B[f]||!1,onChange:()=>K(f),sx:{mb:2},children:[e.jsxs(is,{expandIcon:e.jsx(xt,{}),children:[e.jsx(x,{variant:"subtitle1",children:f}),e.jsxs(x,{variant:"body2",color:"text.secondary",sx:{ml:2},children:[z.length," fields"]})]}),e.jsx(ls,{children:z.map(W)})]},f))},[le,R]=O.useState(!1),L=O.useMemo(()=>t.requiredFields.filter(z=>!a.some($=>$.targetField===z.name)),[t.requiredFields,a]),ee=f=>{console.log("Received default mappings:",f),f.forEach(z=>{console.log("Adding default mapping for:",z.targetField,z),c(z)}),console.log("Current mappings after adding defaults:",a)};return e.jsxs(ge,{sx:{p:2,height:"100%",display:"flex",flexDirection:"column",boxShadow:"0 4px 6px rgba(0,0,0,0.1)",border:"2px solid #e0e0e0",borderRadius:"8px",overflow:"hidden"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,mb:2},children:[L.length>0&&e.jsxs(se,{variant:"outlined",size:"small",startIcon:e.jsx(Bs,{}),onClick:()=>R(!0),color:"primary",children:["Set Default Values (",L.length,")"]}),e.jsx(We,{control:e.jsx(zs,{checked:n,onChange:f=>r(f.target.checked),size:"small"}),label:"Show all fields A-Z"})]}),L.length>0&&e.jsxs(ce,{severity:"warning",sx:{mb:2},action:e.jsx(se,{color:"inherit",size:"small",onClick:()=>R(!0),children:"Set Defaults"}),children:[L.length," required ",L.length===1?"field":"fields"," not mapped. Please map or set default values to continue."]}),e.jsx(be,{size:"small",placeholder:"Search target fields...",value:s,onChange:f=>o(f.target.value),fullWidth:!0,sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(rt,{fontSize:"small"})})}}),e.jsx(xe,{sx:{mb:2}}),e.jsx(j,{sx:{mb:2,p:1,bgcolor:"rgba(25, 118, 210, 0.08)",borderRadius:1,border:"1px dashed",borderColor:"primary.main"},children:e.jsx(x,{variant:"body2",color:"primary",sx:{fontWeight:"bold"},children:"Drop source fields onto target fields or use the drop-down menus below"})}),A&&e.jsx(dn,{mapping:a.find(f=>f.targetField===A)||null,sampleData:d,onClose:()=>_(null)}),e.jsx(j,{sx:{flexGrow:1,maxHeight:"calc(100% - 220px)",overflow:"auto",scrollbarWidth:"thin",border:"1px solid #e0e0e0",borderRadius:"4px",padding:"8px",backgroundColor:"#fafafa","&::-webkit-scrollbar":{width:"10px"},"&::-webkit-scrollbar-track":{background:"#f1f1f1",borderRadius:"4px"},"&::-webkit-scrollbar-thumb":{background:"#2196f3",borderRadius:"4px","&:hover":{background:"#1976d2"}}},children:Z()}),T&&e.jsx(an,{open:!!T,onClose:l,fieldName:T,mapping:a.find(f=>f.targetField===T),sampleData:d,onSave:D}),e.jsx(cn,{open:le,onClose:()=>R(!1),unmappedRequiredFields:L,onAddDefaultMappings:ee})]})},gn=({validationErrors:t,jumpToField:n})=>{const[r,s]=Je.useState(!1),o=t.filter(p=>p.severity==="error").length,a=t.filter(p=>p.severity==="warning").length,c=()=>{s(!r)};return e.jsxs(ge,{sx:{p:2,position:"sticky",top:16},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",cursor:"pointer"},onClick:c,children:[e.jsxs(x,{variant:"h6",color:o>0?"error":"warning",children:["Validation Issues ",o>0?`(${o} errors, ${a} warnings)`:`(${a} warnings)`]}),e.jsx(se,{size:"small",endIcon:r?e.jsx(ms,{}):e.jsx(xt,{}),children:r?"Collapse":"Expand"})]}),e.jsxs(cs,{in:r,children:[e.jsx(xe,{sx:{my:1}}),e.jsx(j,{sx:{maxHeight:"200px",overflow:"auto"},children:e.jsx(ze,{dense:!0,children:t.map((p,u)=>e.jsxs(Ee,{sx:{bgcolor:p.severity==="error"?"error.lightest":"warning.lightest",mb:.5,borderRadius:1},children:[e.jsx(Oe,{children:p.severity==="error"?e.jsx(us,{color:"error"}):e.jsx(ps,{color:"warning"})}),e.jsx(Fe,{primary:p.field,secondary:p.message}),e.jsx(se,{size:"small",variant:"outlined",color:p.severity==="error"?"error":"warning",onClick:()=>n(p.field),children:"Go to Field"})]},u))})})]})]})},fn=({sampleData:t,mappings:n,toolConfig:r})=>{const s=O.useMemo(()=>t.length>0?t[0]:null,[t]),o=O.useMemo(()=>{if(!s||!n.length)return null;const u=gs([s],n);return u.length>0?u[0]:null},[s,n]);if(!s||!o)return e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(x,{variant:"body2",color:"text.secondary",children:"No data available for preview. Upload a file and map fields to see a live preview."})});const a=Object.keys(s),c=Object.keys(o);console.log("🔍 LIVE PREVIEW DEBUG: Transformed row keys:",c),console.log("🔍 LIVE PREVIEW DEBUG: Mappings count:",n.length),console.log("🔍 LIVE PREVIEW DEBUG: Mappings:",n.map(u=>`${u.sourceField} → ${u.targetField}`)),console.log("🔍 LIVE PREVIEW DEBUG: Tool config available:",!!r),console.log("🔍 LIVE PREVIEW DEBUG: Field ID → Display Name conversions incoming...");const p=u=>{if(!r)return console.log(`🔍 LIVE PREVIEW: No toolConfig for field ${u}`),u;const m=[...r.requiredFields||[],...r.optionalFields||[]].find(y=>y.id===u);return console.log(`🔍 LIVE PREVIEW: Converting field ID "${u}" → display name "${m?m.name:u}"`),m?m.name:u};return e.jsxs(j,{children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsx(x,{variant:"subtitle1",children:"Live Preview"}),e.jsx(x,{variant:"body2",color:"text.secondary",children:"Showing all mapped fields • Scroll horizontally to see more →"})]}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:2,overflowX:"auto"},children:[e.jsx(wt,{component:ge,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(dt,{size:"small",stickyHeader:!0,children:[e.jsx(ut,{children:e.jsx(Re,{children:a.map(u=>e.jsx(Se,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(x,{variant:"caption",fontWeight:"bold",children:u})},u))})}),e.jsx(pt,{children:e.jsx(Re,{children:a.map(u=>e.jsx(Se,{sx:{minWidth:"120px"},children:e.jsx(x,{variant:"caption",sx:{wordBreak:"break-word"},children:s[u]!==null&&s[u]!==void 0?String(s[u]):"null"})},u))})})]})}),e.jsx(j,{sx:{display:"flex",justifyContent:"center",alignItems:"center",px:2,flexShrink:0},children:e.jsx(Br,{color:"primary"})}),e.jsx(wt,{component:ge,variant:"outlined",sx:{flex:1,minWidth:"400px",maxHeight:"200px",overflowX:"auto"},children:e.jsxs(dt,{size:"small",stickyHeader:!0,children:[e.jsx(ut,{children:e.jsx(Re,{children:c.map(u=>e.jsx(Se,{sx:{minWidth:"120px",whiteSpace:"nowrap"},children:e.jsx(x,{variant:"caption",fontWeight:"bold",children:p(u)})},u))})}),e.jsx(pt,{children:e.jsx(Re,{children:c.map(u=>e.jsx(Se,{sx:{minWidth:"120px"},children:e.jsx(x,{variant:"caption",sx:{wordBreak:"break-word"},children:o[u]!==null&&o[u]!==void 0?String(o[u]):"null"})},u))})})]})})]})]})},js=(t,n)=>{O.useEffect(()=>{if(n)try{localStorage.setItem(`tmpl:${t.id}`,JSON.stringify(t)),console.log(`Template "${t.name}" saved to localStorage`)}catch(m){console.error("Failed to save template to localStorage:",m)}},[t,n]);const r=m=>{try{let F=Object.keys(localStorage).filter(A=>A.startsWith("tmpl:")).map(A=>{const _=localStorage.getItem(A);return _?JSON.parse(_):null}).filter(Boolean);return m&&(F=F.filter(A=>A.toolId===m)),F.sort((A,_)=>_.lastModified-A.lastModified)}catch(y){return console.error("Failed to load templates from localStorage:",y),[]}},s=m=>{try{return localStorage.removeItem(`tmpl:${m}`),!0}catch(y){return console.error("Failed to delete template:",y),!1}};return{loadTemplates:r,deleteTemplate:s,saveToServer:async()=>(console.log("Saving template to server:",t),new Promise(m=>{setTimeout(()=>{console.log("Template saved to server successfully"),m()},500)})),loadFromServer:async()=>r(),autoSaveTemplate:(m,y)=>{if(!m||m.length===0)return;const T={id:`auto-${y}-${Date.now()}`,name:`Auto-saved ${y} mapping`,description:"Automatically saved field mapping configuration",toolId:y,mappings:m,lastModified:Date.now()};try{localStorage.setItem(`tmpl:${T.id}`,JSON.stringify(T)),console.log("Template auto-saved:",T.name)}catch(F){console.error("Failed to auto-save template:",F)}},getTemplateStats:()=>{var T;const m=r(),y={total:m.length,byTool:{},mostRecent:((T=m[0])==null?void 0:T.lastModified)||0,totalMappings:m.reduce((F,A)=>{var _;return F+(((_=A.mappings)==null?void 0:_.length)||0)},0)};return m.forEach(F=>{const A=F.toolId||"unknown";y.byTool[A]=(y.byTool[A]||0)+1}),y},findSimilarTemplates:(m,y)=>{if(!m||m.length===0)return[];const T=r(y),F=new Set(m.map(A=>A.sourceField.toLowerCase()));return T.map(A=>{const _=new Set(A.mappings.map(Y=>Y.sourceField.toLowerCase())),I=new Set([...F].filter(Y=>_.has(Y))).size/Math.max(F.size,_.size);return{template:A,similarity:I}}).filter(({similarity:A})=>A>.3).sort((A,_)=>_.similarity-A.similarity).map(({template:A})=>A)},cleanupAutoSaved:()=>{try{r().filter(T=>T.name.startsWith("Auto-saved")).sort((T,F)=>F.lastModified-T.lastModified).slice(5).forEach(T=>{s(T.id)})}catch(m){console.error("Failed to cleanup auto-saved templates:",m)}}}},Mt={id:"vendor_console_one_standard",name:"Console One CAD - Standard Template",description:"Professional template for Console One CAD systems with NFIRS code support. Includes incident times, unit information, and location data.",cadVendor:"Console One",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"INC_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_TIME",targetField:"dispatch_time"},{sourceField:"ENROUTE_TIME",targetField:"enroute_time"},{sourceField:"ARRIVAL_TIME",targetField:"arrival_time"},{sourceField:"CLEAR_TIME",targetField:"clear_time"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"UNIT_ID",targetField:"responding_unit"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["INC_DATE_TIME","INC_NUM","INC_DATE","DISPATCH_TIME","ENROUTE_TIME","ARRIVAL_TIME","CLEAR_TIME","PROBLEM_TYPE","UNIT_ID","LOCATION_ADDRESS","LATITUDE","LONGITUDE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Console One"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:95,successRate:100,dataTypes:{},sampleValues:{INC_DATE_TIME:["01/15/2024 14:23:45","01/15/2024 15:30:12"],PROBLEM_TYPE:["111","522","311","651"],UNIT_ID:["E01","T01","M01","BC01"]},tags:["console-one","nfirs","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},xn={id:"vendor_tyler_standard",name:"Tyler Technologies CAD - Standard Template",description:"Professional template for Tyler Technologies CAD systems. Handles mixed field naming conventions and date formats common in Tyler exports.",cadVendor:"Tyler",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"ALARM_TIME",targetField:"incident_time"},{sourceField:"INCIDENT_NUMBER",targetField:"incident_id"},{sourceField:"INCIDENT_DATE",targetField:"incident_date"},{sourceField:"DISPATCH_DATE",targetField:"dispatch_time"},{sourceField:"ENROUTE_DATE",targetField:"enroute_time"},{sourceField:"ARRIVAL_DATE",targetField:"arrival_time"},{sourceField:"CLEAR_DATE",targetField:"clear_time"},{sourceField:"NATURE_CODE",targetField:"incident_type"},{sourceField:"PRIMARY_UNIT",targetField:"responding_unit"},{sourceField:"ADDRESS",targetField:"address"},{sourceField:"CITY",targetField:"city"},{sourceField:"STATE",targetField:"state"}],sourceFieldPattern:{fieldNames:["ALARM_TIME","INCIDENT_NUMBER","INCIDENT_DATE","DISPATCH_DATE","ENROUTE_DATE","ARRIVAL_DATE","CLEAR_DATE","NATURE_CODE","PRIMARY_UNIT","ADDRESS","CITY","STATE"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Tyler"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:92,successRate:98,dataTypes:{},sampleValues:{ALARM_TIME:["2024-01-15 14:23:45","2024-01-15 15:30:12"],NATURE_CODE:["FIREA","EMSC","FIREB","HAZMAT"],PRIMARY_UNIT:["Engine 1","Truck 1","Medic 1","Chief 1"]},tags:["tyler","tyler-technologies","standard","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},yn={id:"vendor_hexagon_standard",name:"Hexagon/Intergraph CAD - Standard Template",description:"Professional template for Hexagon/Intergraph CAD systems. Handles PascalCase field naming and mixed datetime formats with/without seconds.",cadVendor:"Hexagon",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"CallDateTime",targetField:"incident_time"},{sourceField:"IncidentNumber",targetField:"incident_id"},{sourceField:"CallDate",targetField:"incident_date"},{sourceField:"DispatchDateTime",targetField:"dispatch_time"},{sourceField:"EnRouteDateTime",targetField:"enroute_time"},{sourceField:"ArrivalDateTime",targetField:"arrival_time"},{sourceField:"ClearDateTime",targetField:"clear_time"},{sourceField:"IncidentType",targetField:"incident_type"},{sourceField:"UnitId",targetField:"responding_unit"},{sourceField:"LocationAddress",targetField:"address"},{sourceField:"Latitude",targetField:"latitude"},{sourceField:"Longitude",targetField:"longitude"}],sourceFieldPattern:{fieldNames:["CallDateTime","IncidentNumber","CallDate","DispatchDateTime","EnRouteDateTime","ArrivalDateTime","ClearDateTime","IncidentType","UnitId","LocationAddress","Latitude","Longitude"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"Hexagon"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:90,successRate:95,dataTypes:{},sampleValues:{CallDateTime:["01/20/2024 14:28","01/20/2024 15:35:22"],IncidentType:["Structure Fire","Medical Emergency","Vehicle Accident"],UnitId:["ENG001","TRK001","MED001","BC001"]},tags:["hexagon","intergraph","pascalcase","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},bn={id:"vendor_tritech_standard",name:"TriTech/CentralSquare CAD - Standard Template",description:"Professional template for TriTech/CentralSquare CAD systems. Handles underscore_case naming conventions and EventNum identifiers.",cadVendor:"TriTech",targetTool:"response-time-analyzer",fieldMappings:[{sourceField:"Call_Date_Time",targetField:"incident_time"},{sourceField:"EventNum",targetField:"incident_id"},{sourceField:"Call_Date",targetField:"incident_date"},{sourceField:"Dispatch_Time",targetField:"dispatch_time"},{sourceField:"Enroute_Time",targetField:"enroute_time"},{sourceField:"Arrival_Time",targetField:"arrival_time"},{sourceField:"Clear_Time",targetField:"clear_time"},{sourceField:"Call_Type",targetField:"incident_type"},{sourceField:"Unit_ID",targetField:"responding_unit"},{sourceField:"Address",targetField:"address"},{sourceField:"City",targetField:"city"},{sourceField:"State",targetField:"state"}],sourceFieldPattern:{fieldNames:["Call_Date_Time","EventNum","Call_Date","Dispatch_Time","Enroute_Time","Arrival_Time","Clear_Time","Call_Type","Unit_ID","Address","City","State"],fieldCount:12,hasHeaderRow:!0,commonPatterns:["datetime","incident","unit","location"],cadVendorSignature:"TriTech"},metadata:{version:"1.0.0",compatibility:["1.0.0"],qualityScore:88,successRate:93,dataTypes:{},sampleValues:{Call_Date_Time:["2024-01-15 14:23:45","2024-01-15 15:30:12"],Call_Type:["FIRE","EMS","RESCUE","HAZMAT"],Unit_ID:["E1","L1","M1","C1"]},tags:["tritech","centralsquare","underscore","certified"]},createdAt:new Date("2025-06-19").toISOString(),useCount:0,isPublic:!0},jn={...Mt,id:"vendor_console_one_firemap",name:"Console One CAD - Fire Map Pro Template",description:"Geographic analysis template for Console One CAD data. Optimized for incident mapping and spatial analysis.",targetTool:"fire-map-pro",fieldMappings:[{sourceField:"INC_NUM",targetField:"incident_id"},{sourceField:"LATITUDE",targetField:"latitude"},{sourceField:"LONGITUDE",targetField:"longitude"},{sourceField:"PROBLEM_TYPE",targetField:"incident_type"},{sourceField:"INC_DATE_TIME",targetField:"incident_time"},{sourceField:"LOCATION_ADDRESS",targetField:"address"},{sourceField:"UNIT_ID",targetField:"responding_unit"}],metadata:{...Mt.metadata,tags:["console-one","fire-map-pro","geographic","certified"]}},Rt=[Mt,xn,yn,bn,jn],vn=()=>Rt.filter(t=>{var n;return((n=t.metadata.tags)==null?void 0:n.includes("certified"))&&t.isPublic}),gt=()=>{try{const t=JSON.parse(localStorage.getItem("fireems_field_mapping_templates")||"[]");if(t.some(r=>{var s;return(s=r.id)==null?void 0:s.startsWith("vendor_")}))console.log("📚 Vendor templates already exist, skipping seed");else{console.log("🌱 Seeding vendor templates for first-time user...");const r=[...t,...Rt];localStorage.setItem("fireems_field_mapping_templates",JSON.stringify(r)),console.log(`✅ Seeded ${Rt.length} vendor templates successfully`)}}catch(t){console.error("❌ Error seeding vendor templates:",t)}};class Ge{static async saveTemplate(n,r,s,o,a,c,p,u){const d={id:this.generateTemplateId(),name:n.trim(),description:r.trim(),departmentName:p,cadVendor:u,targetTool:c,fieldMappings:s,sourceFieldPattern:this.analyzeSourcePattern(o,a),metadata:this.generateMetadata(s,a),createdAt:new Date().toISOString(),useCount:0,isPublic:!1},m=this.getStoredTemplates();return m.push(d),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(m)),console.log(`✅ Template saved: "${n}" (${d.id})`),d}static getTemplates(){try{gt();const n=this.getStoredTemplates();return console.log("📚 TemplateService.getTemplates() found:",n.length,"templates"),console.log("🏅 Vendor templates:",n.filter(r=>{var s;return(s=r.id)==null?void 0:s.startsWith("vendor_")}).length),n}catch(n){return console.error("❌ Error in getTemplates:",n),[]}}static getTemplatesForTool(n){return gt(),this.getStoredTemplates().filter(r=>r.targetTool===n)}static getCertifiedTemplatesForTool(n){return vn().filter(r=>r.targetTool===n)}static deleteTemplate(n){const r=this.getStoredTemplates(),s=r.findIndex(o=>o.id===n);return s!==-1?(r.splice(s,1),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)),console.log(`🗑️ Template deleted: ${n}`),!0):!1}static suggestTemplates(n,r,s){var c;const o=this.getTemplatesForTool(s),a=[];for(const p of o){const u=this.calculateSimilarity(n,p.sourceFieldPattern.fieldNames);if(u.score>=30){let d=u.score;(c=p.metadata.tags)!=null&&c.includes("certified")&&p.isPublic&&(d+=10,console.log(`🏅 Certified template boost: "${p.name}" ${u.score}% → ${d}%`)),a.push({template:p,similarityScore:d,matchingFields:u.matchingFields,missingFields:u.missingFields,suggestions:this.generateSuggestions(u,p)})}}return a.sort((p,u)=>{var y,T;const d=(y=p.template.metadata.tags)!=null&&y.includes("certified")?1:0,m=(T=u.template.metadata.tags)!=null&&T.includes("certified")?1:0;return d!==m?m-d:u.similarityScore-p.similarityScore}),console.log(`🔍 Found ${a.length} template suggestions for tool: ${s}`),console.log(`🏅 Certified templates: ${a.filter(p=>{var u;return(u=p.template.metadata.tags)==null?void 0:u.includes("certified")}).length}`),a.slice(0,8)}static applyTemplate(n,r){const s=[];this.incrementTemplateUsage(n.id);for(const o of n.fieldMappings){if(r.includes(o.sourceField)){s.push({...o});continue}const a=r.find(p=>p.toLowerCase()===o.sourceField.toLowerCase());if(a){s.push({...o,sourceField:a});continue}const c=this.findFuzzyMatch(o.sourceField,r);c&&s.push({...o,sourceField:c})}return console.log(`🔧 Applied template "${n.name}": ${s.length} mappings applied`),s}static generateCADSignature(n){const r={"Console One":["INC_DATE_TIME","PROBLEM_TYPE","UNIT_ID"],Tyler:["ALARM_TIME","INCIDENT_DATE","DISPATCH_DATE"],Hexagon:["CallDateTime","DispatchDateTime","ArrivalDateTime"],TriTech:["EventNum","Call_Date_Time","Unit_ID"]};let s="Other",o=0;for(const[a,c]of Object.entries(r)){const p=c.filter(u=>n.some(d=>d.toLowerCase().includes(u.toLowerCase()))).length;p>o&&(o=p,s=a)}return s}static getStoredTemplates(){try{const n=localStorage.getItem(this.STORAGE_KEY);return n?JSON.parse(n):[]}catch(n){return console.warn("Failed to load templates from localStorage:",n),[]}}static generateTemplateId(){return`template_${Date.now()}_${Math.random().toString(36).substr(2,9)}`}static analyzeSourcePattern(n,r){return{fieldNames:[...n],fieldCount:n.length,hasHeaderRow:!0,commonPatterns:this.extractCommonPatterns(n),cadVendorSignature:this.generateCADSignature(n)}}static extractCommonPatterns(n){const r=[],s={datetime:["date","time","datetime"],location:["address","location","lat","lng","coord"],incident:["incident","call","event","alarm"],unit:["unit","apparatus","resource"],type:["type","category","classification"]};for(const[o,a]of Object.entries(s))a.some(c=>n.some(p=>p.toLowerCase().includes(c)))&&r.push(o);return r}static generateMetadata(n,r){const o=Math.min(100,n.length/10*100),a={};if(r.length>0)for(const c of n){const p=r.slice(0,3).map(u=>u[c.sourceField]).filter(u=>u!=null&&u!=="").map(u=>String(u));p.length>0&&(a[c.sourceField]=p)}return{version:this.VERSION,compatibility:["1.0.0"],qualityScore:Math.round(o),successRate:100,dataTypes:{},sampleValues:a,tags:[]}}static calculateSimilarity(n,r){const s=new Set(n.map(p=>p.toLowerCase()));new Set(r.map(p=>p.toLowerCase()));const o=[],a=[];for(const p of r)s.has(p.toLowerCase())?o.push(p):a.push(p);const c=o.length/r.length*100;return{score:Math.round(c),matchingFields:o,missingFields:a}}static generateSuggestions(n,r){const s=[];return n.score>=80?s.push("Excellent match! This template should work with minimal adjustments."):n.score>=60?s.push("Good match. May need minor field mapping adjustments."):n.score>=30&&s.push("Partial match. Review field mappings carefully."),n.missingFields.length>0&&s.push(`Missing fields: ${n.missingFields.slice(0,3).join(", ")}`),s}static findFuzzyMatch(n,r){const s=n.toLowerCase();for(const o of r){const a=o.toLowerCase();if(this.stringSimilarity(s,a)>=.7)return o}return null}static stringSimilarity(n,r){const s=n.length>r.length?n:r,o=n.length>r.length?r:n;if(s.length===0)return 1;const a=this.levenshteinDistance(s,o);return(s.length-a)/s.length}static levenshteinDistance(n,r){const s=[];for(let o=0;o<=r.length;o++)s[o]=[o];for(let o=0;o<=n.length;o++)s[0][o]=o;for(let o=1;o<=r.length;o++)for(let a=1;a<=n.length;a++)r.charAt(o-1)===n.charAt(a-1)?s[o][a]=s[o-1][a-1]:s[o][a]=Math.min(s[o-1][a-1]+1,s[o][a-1]+1,s[o-1][a]+1);return s[r.length][n.length]}static incrementTemplateUsage(n){const r=this.getStoredTemplates(),s=r.find(o=>o.id===n);s&&(s.useCount++,s.lastUsed=new Date().toISOString(),localStorage.setItem(this.STORAGE_KEY,JSON.stringify(r)))}}it(Ge,"STORAGE_KEY","fireems_field_mapping_templates"),it(Ge,"VERSION","1.0.0");const Tn=({currentTemplate:t,setCurrentTemplate:n,setTemplateDirty:r,onTemplateApplied:s,disabled:o=!1,currentMappings:a=[],sourceFields:c=[],sampleData:p=[],targetTool:u="",onApplyFieldMappings:d})=>{const[m,y]=O.useState(null),[T,F]=O.useState(!1),[A,_]=O.useState(!1),[B,I]=O.useState(t.name),[Y,P]=O.useState(t.description||""),[S,H]=O.useState([]),[K,G]=O.useState([]),[i,l]=O.useState(""),[h,D]=O.useState(""),{loadTemplates:k,deleteTemplate:W,saveToServer:Z}=js(t,!1);O.useEffect(()=>{const b=k();H(b),c.length>0&&u&&p.length>0&&le()},[c,u,p]);const le=()=>{try{const b=Ge.suggestTemplates(c,p,u);G(b);const g=Ge.generateCADSignature(c);l(g)}catch(b){console.error("Error loading template suggestions:",b)}},R=b=>{y(b.currentTarget)},L=()=>{y(null)},ee=()=>{const b=t.name==="Untitled Mapping"?M():t.name;I(b),P(t.description||""),F(!0),L()},f=()=>{const b=k();H(b),_(!0),L()},z=async()=>{try{if(a.length>0&&c.length>0&&u)await Ge.saveTemplate(B,Y,a,c,p,u,h||void 0,i||void 0);else{const g={...t,name:B,description:Y,lastModified:Date.now()};n(g),Z()}r(!1);const b=k();H(b),F(!1)}catch(b){console.error("Error saving template:",b)}},$=b=>{n(b),r(!1),s&&s(b),_(!1)},V=b=>{try{const g=Ge.applyTemplate(b,c);d&&d(g),_(!1)}catch(g){console.error("Error applying template:",g)}},C=b=>{W(b);const g=k();H(g)},v=b=>{const g={...b,id:`template-${Date.now()}`,name:`${b.name} (Copy)`,lastModified:Date.now()};localStorage.setItem(`tmpl:${g.id}`,JSON.stringify(g));const N=k();H(N)},E=b=>{const g=new Date(b),U=(new Date().getTime()-g.getTime())/(1e3*60*60);return U<24?`${Math.floor(U)} hours ago`:U<24*7?`${Math.floor(U/24)} days ago`:g.toLocaleDateString()},q=b=>{const g=b.name.toLowerCase(),N=(b.description||"").toLowerCase(),U=`${g} ${N}`;return U.includes("tyler")||U.includes("cad")?"CAD System":U.includes("monthly")||U.includes("export")?"Monthly Report":U.includes("response")||U.includes("time")?"Response Time":U.includes("fire")||U.includes("map")?"Fire Map":U.includes("test")||U.includes("sample")?"Test Data":"General"},J=b=>{switch(b){case"CAD System":return"primary";case"Monthly Report":return"success";case"Response Time":return"info";case"Fire Map":return"warning";case"Test Data":return"secondary";default:return"secondary"}},w=S.reduce((b,g)=>{const N=g.toolId||"unknown";return b[N]||(b[N]=[]),b[N].push(g),b},{}),M=()=>{const b=t.toolId||"Tool",g=new Date,N=g.toLocaleDateString("en-US",{month:"long"});if(t.mappings.length>0){const U=t.mappings.map(X=>X.sourceField.toLowerCase());if(U.some(X=>X.includes("tyler")))return`Tyler CAD Export - ${N} ${g.getFullYear()}`;if(U.some(X=>X.includes("dispatch")||X.includes("call")))return`${b} Monthly Export - ${N}`}return`${b} Mapping Template`};return e.jsxs(e.Fragment,{children:[e.jsx(Ne,{title:o?"Complete field mapping to access templates":"Save and load field mapping templates",children:e.jsx("span",{children:e.jsx(se,{variant:"outlined",size:"small",onClick:R,startIcon:e.jsx(Wt,{}),disabled:o,children:"Templates"})})}),e.jsxs(Ls,{anchorEl:m,open:!!m,onClose:L,children:[e.jsxs(oe,{onClick:ee,children:[e.jsx(ns,{fontSize:"small",sx:{mr:1}}),"Save Template As..."]}),e.jsxs(oe,{onClick:f,children:[e.jsx(Wt,{fontSize:"small",sx:{mr:1}}),"Load Template"]}),e.jsxs(oe,{onClick:()=>{gt();const b=k();H(b),console.log("🌱 Vendor templates seeded manually")},children:[e.jsx(St,{fontSize:"small",sx:{mr:1}}),"Load Vendor Templates"]})]}),e.jsxs(Ke,{open:T,onClose:()=>F(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsx(Xe,{children:"Save Mapping Template"}),e.jsxs(Ze,{children:[e.jsx(ce,{severity:"info",sx:{mb:3},children:e.jsx(x,{variant:"body2",children:"Save this field mapping configuration for future use. Templates help you quickly map data from the same source system."})}),e.jsx(be,{autoFocus:!0,margin:"dense",label:"Template Name",fullWidth:!0,value:B,onChange:b=>I(b.target.value),sx:{mb:2},placeholder:"e.g., Tyler CAD Monthly Export, Fire Map Pro Standard"}),e.jsx(be,{margin:"dense",label:"Description (optional)",fullWidth:!0,multiline:!0,rows:2,value:Y,onChange:b=>P(b.target.value),placeholder:"e.g., Standard monthly incident export from Tyler Technologies CAD system"}),a.length>0&&e.jsxs(e.Fragment,{children:[e.jsx(be,{margin:"dense",label:"Department Name (optional)",fullWidth:!0,value:h,onChange:b=>D(b.target.value),placeholder:"e.g., Houston Fire Department",sx:{mt:2}}),e.jsxs(be,{margin:"dense",label:"CAD Vendor",fullWidth:!0,select:!0,value:i,onChange:b=>l(b.target.value),sx:{mt:2},children:[e.jsx(oe,{value:"Console One",children:"Console One"}),e.jsx(oe,{value:"Tyler",children:"Tyler Technologies"}),e.jsx(oe,{value:"Hexagon",children:"Hexagon/Intergraph"}),e.jsx(oe,{value:"TriTech",children:"TriTech/CentralSquare"}),e.jsx(oe,{value:"Other",children:"Other"})]})]}),e.jsx(bt,{variant:"outlined",sx:{mt:2},children:e.jsxs(jt,{children:[e.jsx(x,{variant:"subtitle2",gutterBottom:!0,children:"Template Preview"}),e.jsxs(x,{variant:"body2",color:"text.secondary",children:["Tool: ",t.toolId||"Unknown"]}),e.jsxs(x,{variant:"body2",color:"text.secondary",children:["Mappings: ",t.mappings.length," field mappings"]}),t.mappings.length>0&&e.jsx(j,{sx:{mt:1},children:e.jsxs(x,{variant:"caption",color:"text.secondary",children:["Sample mappings: ",t.mappings.slice(0,3).map(b=>`${b.sourceField} → ${b.targetField}`).join(", "),t.mappings.length>3&&` +${t.mappings.length-3} more`]})})]})})]}),e.jsxs(Qe,{children:[e.jsx(se,{onClick:()=>F(!1),children:"Cancel"}),e.jsx(se,{onClick:z,variant:"contained",children:"Save Template"})]})]}),e.jsxs(Ke,{open:A,onClose:()=>_(!1),maxWidth:"md",fullWidth:!0,children:[e.jsx(Xe,{children:"Load Mapping Template"}),e.jsxs(Ze,{children:[K.length>0&&e.jsxs(j,{sx:{mb:4},children:[e.jsxs(x,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(Yr,{sx:{mr:1,fontSize:20}}),"Smart Template Suggestions",e.jsx(ie,{label:K.length,size:"small",sx:{ml:1}})]}),e.jsx(ce,{severity:"success",sx:{mb:2},children:e.jsxs(x,{variant:"body2",children:["Found ",K.length," template",K.length!==1?"s":""," that match your data structure. These are pre-configured for your CAD system type."]})}),e.jsx(ze,{children:K.map((b,g)=>{var N;return e.jsx(Ee,{component:"button",onClick:()=>V(b.template),sx:{py:2,borderRadius:1,mb:1,border:1,borderColor:b.similarityScore>=80?"success.main":"divider","&:hover":{backgroundColor:"action.hover"}},children:e.jsx(Fe,{primary:e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",flexWrap:"wrap",children:[e.jsxs(j,{display:"flex",alignItems:"center",gap:1,children:[e.jsx(x,{variant:"subtitle1",children:b.template.name}),((N=b.template.metadata.tags)==null?void 0:N.includes("certified"))&&e.jsx(ie,{icon:e.jsx(Qr,{}),label:"Certified",color:"primary",size:"small",variant:"filled"})]}),e.jsx(ie,{label:`${b.similarityScore}% match`,color:b.similarityScore>=80?"success":b.similarityScore>=60?"warning":"default",size:"small"}),b.template.cadVendor&&e.jsx(ie,{label:b.template.cadVendor,size:"small",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(x,{variant:"body2",sx:{mb:.5},children:b.template.description}),e.jsxs(x,{variant:"caption",color:"text.secondary",children:["Matching fields: ",b.matchingFields.join(", ")]}),b.missingFields.length>0&&e.jsxs(x,{variant:"caption",color:"text.secondary",sx:{display:"block"},children:["Missing: ",b.missingFields.slice(0,3).join(", "),b.missingFields.length>3&&` +${b.missingFields.length-3} more`]})]})})},b.template.id)})})]}),S.length===0&&K.length===0?e.jsxs(j,{sx:{textAlign:"center",py:4},children:[e.jsx(St,{sx:{fontSize:48,color:"text.secondary",mb:2}}),e.jsx(x,{variant:"h6",gutterBottom:!0,children:"No saved templates found"}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{mb:2},children:"Templates save your field mapping configurations for reuse with similar data exports."}),e.jsx(ce,{severity:"info",children:e.jsxs(x,{variant:"body2",children:[e.jsx("strong",{children:"Pro Tip:"})," After mapping fields for your CAD system, save it as a template. Next month's export will auto-map instantly!"]})})]}):S.length>0&&e.jsxs(j,{children:[K.length>0&&e.jsxs(x,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center",mt:2},children:[e.jsx($t,{sx:{mr:1,fontSize:20}}),"Your Saved Templates"]}),e.jsx(ce,{severity:"success",sx:{mb:2},children:e.jsxs(x,{variant:"body2",children:["Found ",S.length," saved template",S.length!==1?"s":"",". Click any template to apply its field mappings instantly."]})}),Object.entries(w).map(([b,g])=>e.jsxs(j,{sx:{mb:3},children:[e.jsxs(x,{variant:"h6",gutterBottom:!0,sx:{display:"flex",alignItems:"center"},children:[e.jsx(St,{sx:{mr:1,fontSize:20}}),b==="unknown"?"General Templates":`${b} Templates`,e.jsx(ie,{label:g.length,size:"small",sx:{ml:1}})]}),e.jsx(ze,{children:g.map(N=>{var U;return e.jsx(Je.Fragment,{children:e.jsxs(Ee,{component:"button",onClick:()=>$(N),sx:{py:2,borderRadius:1,mb:1,"&:hover":{backgroundColor:"action.hover"}},children:[e.jsx(Fe,{primary:e.jsxs(tt,{direction:"row",spacing:1,alignItems:"center",children:[e.jsx(x,{variant:"subtitle1",children:N.name}),e.jsx(ie,{label:q(N),size:"small",color:J(q(N)),variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[N.description&&e.jsx(x,{variant:"body2",sx:{mb:.5},children:N.description}),e.jsxs(tt,{direction:"row",spacing:2,alignItems:"center",children:[e.jsxs(x,{variant:"caption",color:"text.secondary",sx:{display:"flex",alignItems:"center"},children:[e.jsx($t,{sx:{fontSize:12,mr:.5}}),E(N.lastModified)]}),e.jsxs(x,{variant:"caption",color:"text.secondary",children:[((U=N.mappings)==null?void 0:U.length)||0," field mappings"]})]}),N.mappings&&N.mappings.length>0&&e.jsxs(x,{variant:"caption",color:"text.secondary",sx:{mt:.5,display:"block"},children:["Fields: ",N.mappings.slice(0,2).map(X=>X.sourceField).join(", "),N.mappings.length>2&&` +${N.mappings.length-2} more`]})]})}),e.jsxs(It,{children:[e.jsx(Ne,{title:"Duplicate template",children:e.jsx(Ce,{edge:"end",onClick:X=>{X.stopPropagation(),v(N)},sx:{mr:1},children:e.jsx(Jr,{fontSize:"small"})})}),e.jsx(Ne,{title:"Delete template",children:e.jsx(Ce,{edge:"end",onClick:X=>{X.stopPropagation(),C(N.id)},children:e.jsx(nt,{fontSize:"small"})})})]})]})},N.id)})})]},b))]})]}),e.jsx(Qe,{children:e.jsx(se,{onClick:()=>_(!1),children:"Cancel"})})]})]})},Sn=(t,n)=>{if(!n)return t;const r=[...n.requiredFields,...n.optionalFields];if(r.find(a=>a.id===t))return console.log(`✅ Field ID already correct: "${t}"`),t;const o=r.find(a=>a.name===t);return o?(console.log(`🔄 Converting display name "${t}" to field ID "${o.id}"`),o.id):(console.warn(`⚠️ Unknown target field: "${t}" - keeping as-is`),t)},Kt=(t,n)=>{if(!n||!t)return t;console.log("🔄 Starting field mapping migration...");const r=t.map(s=>{const o=s.targetField,a=Sn(s.targetField,n);return o!==a&&console.log(`📋 Migrating: "${s.sourceField}" → "${o}" becomes "${s.sourceField}" → "${a}"`),{...s,targetField:a}});return console.log("✅ Field mapping migration complete"),r},Xt=(t,n)=>{if(!n||!t)return{isConsistent:!0,issues:[]};const r=[...n.requiredFields,...n.optionalFields],s=[];return t.forEach(o=>{const a=r.some(p=>p.id===o.targetField),c=r.some(p=>p.name===o.targetField);c&&!a?s.push(`Mapping "${o.sourceField}" → "${o.targetField}" uses display name instead of field ID`):!a&&!c&&s.push(`Mapping "${o.sourceField}" → "${o.targetField}" targets unknown field`)}),{isConsistent:s.length===0,issues:s}},En=t=>{if(!t||typeof t!="string")return{city:null,state:null};const n=t.trim(),r=new Set(["AL","AK","AZ","AR","CA","CO","CT","DE","FL","GA","HI","ID","IL","IN","IA","KS","KY","LA","ME","MD","MA","MI","MN","MS","MO","MT","NE","NV","NH","NJ","NM","NY","NC","ND","OH","OK","OR","PA","RI","SC","SD","TN","TX","UT","VT","VA","WA","WV","WI","WY","DC"]),s=[/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s+\d{5}(?:-\d{4})?\s*$/,/^.+\s+([A-Za-z][A-Za-z\s]+?)\s+([A-Z]{2})\s*$/,/^.+,\s*([A-Za-z][A-Za-z\s]+?),?\s+([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/,/^.+\s{2,}([A-Za-z][A-Za-z\s]+?)\s{2,}([A-Z]{2})(?:\s+\d{5}(?:-\d{4})?)?\s*$/];for(const c of s){const p=n.match(c);if(p){let u=p[1].trim();const d=p[2].trim();if(r.has(d)&&u.length>=2&&u.length<=50){const m=/\b(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i;if(u=u.replace(m,"").trim(),u.length>=2)return console.log(`🏠 ENHANCED ADDRESS PARSING: "${t}" → City: "${u}", State: "${d}"`),{city:u,state:d}}}}const o=new RegExp("\\s+([A-Z]{2})(?:\\s+\\d{5}(?:-\\d{4})?)?\\s*$"),a=n.match(o);if(a){const c=a[1];if(r.has(c)){const d=n.substring(0,n.lastIndexOf(c)).trim().split(/\s+/).slice(-3).filter(m=>!/^\d+$/.test(m)&&!/^(north|south|east|west|n|s|e|w)$/i.test(m)&&!/^(st|ave|blvd|rd|dr|ln|way|ct|pl|pkwy)\.?$/i.test(m));if(d.length>0){const m=d.join(" ");if(m.length>=2&&m.length<=50)return console.log(`🏠 FALLBACK ADDRESS PARSING: "${t}" → City: "${m}", State: "${c}"`),{city:m,state:c}}}}return console.log(`🏠 ADDRESS PARSING FAILED: Could not extract city/state from "${t}"`),{city:null,state:null}},Fn=t=>({incident_id:["incident_number","incidentnumber","incident_num","inc_num","incnum","case_number","call_number","event_id","event_number","report_number","incidentnum","eventnum"],incident_time:["call_received_time","callreceivedtime","received_time","call_time","incident_datetime","receive_time","time_received","incident_date","inc_date_time","alarm_time","calldatetime","call_datetime"],arrival_time:["arrive_time","arrivetime","on_scene_time","onscenetime","scene_time","arrival_datetime","on_scene_datetime","arrivaldatetime","onscenetime"],dispatch_time:["dispatched_time","dispatchedtime","dispatch_datetime","notification_time","notified_time","dispatchdatetime"],enroute_time:["en_route_time","enroutetime","turnout_time","turnouttime","responding_time","travel_start_time","enroutedatetime"],clear_time:["cleared_time","clearedtime","clear_datetime","back_in_service_time","available_time","service_time","unit_clear_time","cleardatetime"],latitude:["lat","y_coord","y_coordinate","gps_lat","coord_y","ycoord"],longitude:["lng","lon","long","x_coord","x_coordinate","gps_lng","gps_lon","coord_x","xcoord"],address:["incident_address","location","street_address","full_address","addr","locationaddress"],responding_unit:["unit","primary_unit","first_unit","apparatus","resource","unit_id","responding_units","primaryunit"],incident_type:["inc_type_code","inctypecode","inc_type_desc","inctypedesc","call_type","emergency_type","event_type","nature_code","problem_type","incidenttype","incidentcategory","calltype"],zip_code:["zip","zipcode","postal_code","postcode","locationzip"],city:["incident_city","location_city","locationcity"],state:["incident_state","location_state","locationstate"],priority:["incident_priority","call_priority","priority_level"],disposition:["incident_disposition","final_disposition","outcome","incident_outcome"],district:["response_district","fire_district","service_district","districts"],cross_streets:["cross_street","nearest_intersection","intersection"]})[t]||[],Cn=()=>{const t=at(),{sourceColumns:n,sampleData:r,selectedTool:s,mappings:o,processingStatus:a}=Ve(v=>v.formatter),[c,p]=O.useState({id:`template-${Date.now()}`,name:"Untitled Mapping",toolId:(s==null?void 0:s.id)||"",mappings:o||[],lastModified:Date.now()}),[u,d]=O.useState(!1),[m,y]=O.useState([]),[T,F]=O.useState(!1),[A,_]=O.useState([]),[B,I]=O.useState({message:"",severity:"info",open:!1}),[Y,P]=O.useState(""),[S,H]=O.useState(""),[K,G]=O.useState(!1),i=s||void 0,{saveToServer:l,autoSaveTemplate:h,findSimilarTemplates:D,getTemplateStats:k,cleanupAutoSaved:W}=js(c,u),Z=k();O.useEffect(()=>{Object.keys(localStorage).filter(E=>E.startsWith("tmpl:")).forEach(E=>{var J;const q=localStorage.getItem(E);if(q)try{((J=JSON.parse(q).mappings)==null?void 0:J.some(b=>b.targetField&&b.targetField.includes(" ")))&&(console.log(`🔧 CLEARING OUTDATED TEMPLATE: ${E} (uses display names instead of field IDs)`),localStorage.removeItem(E))}catch{console.log(`🔧 CLEARING CORRUPTED TEMPLATE: ${E}`),localStorage.removeItem(E)}})},[]),O.useEffect(()=>{console.log("Redux mappings changed:",o),p(v=>{const E={...v,mappings:[...o],lastModified:Date.now()};return console.log("Updated template with Redux mappings:",E),E}),o.length>0&&d(!0)},[o]),O.useEffect(()=>{if(!i||!o||o.length===0)return;console.log("🔄 Checking for legacy mappings that need migration...");const v=Xt(o,i);if(v.isConsistent)console.log("✅ All mappings already use field IDs - no migration needed");else{console.log("🔄 Legacy mappings detected - auto-migrating to field IDs"),console.log("Issues found:",v.issues);const E=Kt(o,i);JSON.stringify(o)!==JSON.stringify(E)&&(console.log("✅ Auto-migration complete - updating mappings"),t(Me(E)))}},[i,o==null?void 0:o.length]),O.useEffect(()=>{L()},[o,i]);const le=v=>{console.log("handleMappingChange called with:",v);try{const E=[...o],q=E.findIndex(J=>J.targetField===v.targetField);q>=0?(console.log(`Updating existing mapping for ${v.targetField}`),E[q]=v):(console.log(`Adding new mapping for ${v.targetField}`),E.push(v)),t(Me(E)),console.log("Mapping updated successfully:",v),I({message:`Mapped ${v.sourceField} to ${v.targetField}`,severity:"success",open:!0})}catch(E){console.error("Error updating mapping:",E)}},R=v=>{console.log("handleRemoveMapping called for:",v);try{const E=o.filter(q=>q.targetField!==v);t(Me(E)),console.log(`Mapping for ${v} removed successfully`)}catch(E){console.error("Error removing mapping:",E)}},L=()=>{if(!i)return;console.log("🔍 FIELD MAPPING AUDIT - Current State Analysis:"),console.log("=========================================="),console.log("📋 Tool Configuration:"),console.log("  Required Fields:",i.requiredFields.map(w=>({id:w.id,name:w.name}))),console.log("  Optional Fields:",i.optionalFields.map(w=>({id:w.id,name:w.name}))),console.log("🗺️ Current Mappings:"),console.log("  Mappings Array:",o.map(w=>({source:w.sourceField,target:w.targetField})));const v=[...i.requiredFields,...i.optionalFields],E=o.map(w=>{const M=v.find(g=>g.id===w.targetField),b=v.find(g=>g.name===w.targetField);return{source:w.sourceField,target:w.targetField,isFieldId:!!M,isDisplayName:!!b,shouldBeFieldId:b?b.id:w.targetField}});console.log("🔍 Mapping Analysis:"),E.forEach(w=>{console.log(`  "${w.source}" → "${w.target}"`),console.log(`    - Is Field ID: ${w.isFieldId}`),console.log(`    - Is Display Name: ${w.isDisplayName}`),w.isDisplayName&&!w.isFieldId&&console.log(`    - ⚠️ PROBLEM: Should be "${w.shouldBeFieldId}" instead`)});const q=o.find(w=>w.targetField==="Call Received Date/Time");q&&(console.log("🚨 SPECIFIC ISSUE DETECTED:"),console.log(`  Mapping: "${q.sourceField}" → "${q.targetField}"`),console.log(`  Should be: "${q.sourceField}" → "incident_time"`)),console.log("==========================================");const J=[];i.requiredFields.forEach(w=>{const M=o.find(g=>g.targetField===w.id),b=o.find(g=>g.targetField===w.name);if(console.log(`Checking required field ${w.id} (display: ${w.name})`),console.log(`  - Mapping by ID: ${M?`"${M.sourceField}" → ${M.targetField}`:"none"}`),console.log(`  - Mapping by Name: ${b?`"${b.sourceField}" → ${b.targetField}`:"none"}`),M)console.log(`  ✅ Correct mapping found for ${w.id}`);else if(b){console.log(`  🔄 Legacy mapping detected for ${w.id} - migrating from display name to field ID`);const g=o.findIndex(N=>N.targetField===w.name);if(g>=0){const N=[...o];N[g]={...N[g],targetField:w.id},console.log(`  📋 Auto-migrated: "${w.name}" → "${w.id}"`),t(Me(N))}}else console.log(`  ❌ No mapping found for required field ${w.id}`),J.push({field:w.id,message:`Required field ${w.name} is not mapped`,severity:"error"})}),_(J)},ee=async()=>{if(!(!n||!i)){F(!0);try{console.log("🔧 AUTO-MAPPING - Starting with systematic fix approach");const E=[...Kt(c.mappings,i)],q=g=>E.some(N=>N.targetField===g),J=g=>g.toLowerCase().replace(/[\s_-]/g,""),w=[...i.requiredFields,...i.optionalFields];console.log("🔧 AUTO-MAPPING - Available target fields:",w.map(g=>({id:g.id,name:g.name}))),console.log("🔧 AUTO-MAPPING - Source columns:",n),console.log("🔧 AUTO-MAPPING - Tool config details:",{toolId:i.id,requiredCount:i.requiredFields.length,optionalCount:i.optionalFields.length,totalFields:w.length,optionalFieldsList:i.optionalFields.map(g=>g.id)}),console.log(`
🕐 === SMART DATETIME DETECTION: Phase 1 Implementation ===`);const M=Or(n,r||[]);console.log("🕐 Detection result:",{type:M.pattern.type,confidence:M.pattern.confidence,description:M.pattern.description}),M.pattern.confidence>.5?(console.log("✅ High confidence datetime pattern detected - applying smart mappings"),M.suggestedMappings.forEach(g=>{if(!w.some(X=>X.id===g.targetField)){console.log(`⚠️ Skipping suggestion for ${g.targetField} - not in tool config`);return}if(q(g.targetField)){console.log(`🔄 Target ${g.targetField} already mapped - skipping automatic datetime mapping`);return}const U=g.sourceFields[0];g.transformationType==="combine"?(console.log(`🕐 DATETIME COMBINE: Adding mapping "${U}" → "${g.targetField}" (will combine with ${g.sourceFields.join(" + ")})`),E.push({sourceField:U,targetField:g.targetField,transformations:[{type:"datetime_combine",params:{sourceFields:g.sourceFields,description:g.description}}]})):g.transformationType==="extract"?(console.log(`🕐 DATETIME EXTRACT: Adding mapping "${U}" → "${g.targetField}" (will extract date/time component)`),E.push({sourceField:U,targetField:g.targetField,transformations:[{type:"datetime_extract",params:{extractType:g.targetField.includes("date")?"date":"time",description:g.description}}]})):(console.log(`🕐 DATETIME DIRECT: Adding direct mapping "${U}" → "${g.targetField}"`),E.push({sourceField:U,targetField:g.targetField}))}),console.log("🕐 Smart datetime mappings applied:",E.filter(g=>{var N;return(N=g.transformations)==null?void 0:N.some(U=>U.type.startsWith("datetime_"))}).length)):console.log("⚠️ Low confidence datetime pattern - proceeding with standard auto-mapping"),console.log(`🕐 === DATETIME DETECTION COMPLETE - Proceeding with standard field mapping ===
`),w.forEach(g=>{console.log(`
🎯 === DEBUGGING TARGET FIELD: ${g.id} (display: "${g.name}") ===`),q(g.id)&&console.log(`🔄 Target field ${g.id} already mapped - checking for dual mapping opportunity`),console.log("🔍 Available source columns for matching:",n),console.log(`🔍 Attempting to map target field: ${g.id} (display: ${g.name})`),console.log(`🔍 STEP 1: Trying exact match with display name "${g.name}"`);const N=n.find(ae=>ae.toLowerCase()===g.name.toLowerCase());if(console.log("🔍 Exact match result:",N?`FOUND: "${N}"`:"NOT FOUND"),N){E.find(re=>re.sourceField===N&&re.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${N}" → ${g.id}`):(console.log(`✅ EXACT MATCH SUCCESS: "${N}" → ${g.id}`),E.push({sourceField:N,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (exact match) ===
`);return}console.log("🔍 STEP 2: Trying normalized match with display name");const U=J(g.name);console.log(`🔍 Normalized target name: "${g.name}" → "${U}"`);const X=n.find(ae=>{const re=J(ae);return console.log(`🔍   Testing source "${ae}" → "${re}" against "${U}"`),re===U});if(console.log("🔍 Normalized match result:",X?`FOUND: "${X}"`:"NOT FOUND"),X){E.find(re=>re.sourceField===X&&re.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${X}" → ${g.id}`):(console.log(`✅ NORMALIZED MATCH SUCCESS: "${X}" → ${g.id}`),E.push({sourceField:X,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (normalized match) ===
`);return}console.log("🔍 STEP 3: Trying normalized match with field ID");const ne=J(g.id);console.log(`🔍 Normalized field ID: "${g.id}" → "${ne}"`);const te=n.find(ae=>{const re=J(ae);return console.log(`🔍   Testing source "${ae}" → "${re}" against "${ne}"`),re===ne});if(console.log("🔍 Field ID match result:",te?`FOUND: "${te}"`:"NOT FOUND"),te){E.find(re=>re.sourceField===te&&re.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${te}" → ${g.id}`):(console.log(`✅ FIELD ID MATCH SUCCESS: "${te}" → ${g.id}`),E.push({sourceField:te,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (field ID match) ===
`);return}console.log("🔍 STEP 4: Trying field variation matching");const je=Fn(g.id);console.log(`🔍 Field variations for ${g.id}:`,je);let Q;for(const ae of je)if(console.log(`🔍   Testing variation: "${ae}"`),Q=n.find(re=>{const ye=J(re),he=J(ae);return console.log(`🔍     Source "${re}" → "${ye}" vs variation "${he}"`),ye===he}),Q){console.log(`🔍   VARIATION MATCH FOUND: "${Q}" via variation "${ae}"`),E.find(ye=>ye.sourceField===Q&&ye.targetField===g.id)?console.log(`🔄 Dual mapping already exists: "${Q}" → ${g.id}`):(console.log(`✅ FIELD VARIATION SUCCESS: "${Q}" → ${g.id} (via variation "${ae}")`),E.push({sourceField:Q,targetField:g.id})),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (variation match) ===
`);return}console.log(`🔍 No variation matches found for ${g.id}`),console.log(`❌ NO MATCH FOUND for target field: ${g.id}`),console.log(`🎯 === COMPLETED TARGET FIELD: ${g.id} (no match) ===
`);const Te=n.map(J).findIndex(ae=>ae.includes(U)||U.includes(ae));if(Te>=0){console.log(`✅ Partial match found: "${n[Te]}" → ${g.id}`),E.push({sourceField:n[Te],targetField:g.id});return}if((g.id==="city"||g.id==="state")&&!q(g.id)){const ae=n.find(re=>J(re).includes("address")||J(re).includes("location")||J(re).includes("addr"));if(ae&&r&&r.length>0){const re=r[0][ae];if(typeof re=="string"&&re.trim()){const ye=En(re);if(g.id==="city"&&ye.city){console.log(`🏠 Smart address parsing: Extracting city "${ye.city}" from "${ae}"`),E.push({sourceField:ae,targetField:g.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Za-z\\s]+)\\s+[A-Z]{2}\\s*$",description:"Extract city from full address"}}]});return}if(g.id==="state"&&ye.state){console.log(`🏠 Smart address parsing: Extracting state "${ye.state}" from "${ae}"`),E.push({sourceField:ae,targetField:g.id,transformations:[{type:"extract",params:{pattern:"\\s+([A-Z]{2})\\s*$",description:"Extract state from full address"}}]});return}}}}console.log(`❌ No match found for target field: ${g.id}`)}),console.log("🔧 AUTO-MAPPING - Final mappings:",E.map(g=>({source:g.sourceField,target:g.targetField})));const b=Xt(E,i);if(b.isConsistent||console.warn("⚠️ AUTO-MAPPING - Consistency issues detected:",b.issues),t(Me(E)),E.length>=3&&(s!=null&&s.id)&&(console.log("🔧 AUTO-SAVING TEMPLATE: Significant mappings detected"),h(E,s.id),W()),s!=null&&s.id){const g=D(E,s.id);y(g.slice(0,3)),console.log("🔧 TEMPLATE SUGGESTIONS:",g.length,"similar templates found")}}finally{F(!1)}}},f=async()=>{try{await l(),d(!1)}catch(v){console.error("Failed to save template:",v)}},z=()=>{t(ke(0))},$=()=>{try{t($e("transforming")),console.log("🔧 TRANSFORMATION DEBUG: Using Redux mappings directly for transformation"),console.log("Redux mappings:",o),console.log("currentTemplate.mappings:",c.mappings),console.log("Sample data:",r),console.log("🔍 PRE-TRANSFORMATION DEBUG:"),console.log("  Sample data keys:",r.length>0?Object.keys(r[0]):[]),console.log("  Sample data first row:",r[0]),console.log("  Mappings to apply:",o),console.log("  Mappings breakdown:"),o.forEach((E,q)=>{var w;const J=(w=r[0])==null?void 0:w[E.sourceField];console.log(`    ${q+1}. "${E.sourceField}" → "${E.targetField}" | Sample: "${J}"`)});const v=gs(r,o);console.log("✅ Transformed data with latest mappings:",v),console.log("🔍 POST-TRANSFORMATION DEBUG:"),v.length>0&&(console.log("  Transformed data keys:",Object.keys(v[0])),console.log("  Transformed data first row:",v[0]),console.log("  Specific field checks:"),console.log(`    incident_time: "${v[0].incident_time}"`),console.log(`    incident_date: "${v[0].incident_date}"`),console.log(`    incident_id: "${v[0].incident_id}"`)),t(Ms(v)),t($e("mapping")),t(ke(2))}catch(v){console.error("Error transforming data:",v),t($e("error")),I({message:`Error transforming data: ${v instanceof Error?v.message:"Unknown error"}`,severity:"error",open:!0})}},V=O.useMemo(()=>{if(console.log("Checking if can proceed with validationErrors:",A),console.log("Current mappings:",o),i){const v=i.requiredFields.filter(E=>!o.some(q=>q.targetField===E.id));return console.log("Unmapped required fields:",v),v.length===0}return A.every(v=>v.severity!=="error")},[A,o,i]),C=v=>{var w;v.preventDefault();const E=v.dataTransfer.getData("text/plain");if(!E){I({message:"Drag and drop error: No source field data found",severity:"error",open:!0});return}const J=(w=v.target.closest("[data-target-field]"))==null?void 0:w.getAttribute("data-target-field");if(!J){I({message:"Drag and drop error: No target field found. Try dropping directly on a target field.",severity:"warning",open:!0});return}le({sourceField:E,targetField:J}),I({message:`Mapped ${E} to ${J}`,severity:"success",open:!0})};return n.length?i?a==="uploading"?e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(Pe,{}),e.jsx(x,{sx:{mt:2},children:"Processing file data..."})]}):e.jsxs(j,{sx:{display:"flex",flexDirection:"column",gap:2},children:[e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mb:2},children:[e.jsxs(x,{variant:"h5",children:["Map Fields for ",i.name]}),e.jsxs(tt,{direction:"row",spacing:1,children:[e.jsx(se,{variant:"outlined",size:"small",startIcon:e.jsx(ns,{}),onClick:f,disabled:!u,children:"Save Template"}),e.jsx(Tn,{currentTemplate:c,setCurrentTemplate:v=>{p(v),v.mappings&&v.mappings.length>0&&(t(Me(v.mappings)),I({message:`Applied template "${v.name}" with ${v.mappings.length} field mappings`,severity:"success",open:!0}))},setTemplateDirty:d,disabled:!s||n.length===0,currentMappings:o,sourceFields:n,sampleData:r,targetTool:(s==null?void 0:s.id)||"",onApplyFieldMappings:v=>{t(Me(v)),I({message:`Applied template with ${v.length} field mappings`,severity:"success",open:!0})}})]})]}),m.length>0&&e.jsxs(ce,{severity:"info",sx:{mb:2},children:[e.jsx(x,{variant:"subtitle2",gutterBottom:!0,children:"💡 Smart Template Suggestions"}),e.jsxs(x,{variant:"body2",sx:{mb:1},children:["Found ",m.length," template",m.length!==1?"s":""," with similar field patterns:"]}),e.jsx(j,{sx:{display:"flex",gap:1,flexWrap:"wrap"},children:m.map(v=>e.jsxs(se,{variant:"outlined",size:"small",onClick:()=>{p(v),t(Me(v.mappings)),d(!1),y([]),I({message:`Applied suggested template "${v.name}"`,severity:"success",open:!0})},sx:{textTransform:"none"},children:[v.name,e.jsxs(x,{component:"span",variant:"caption",sx:{ml:1,opacity:.7},children:["(",v.mappings.length," mappings)"]})]},v.id))})]}),Z.total>0&&e.jsx(ce,{severity:"success",sx:{mb:2},children:e.jsxs(x,{variant:"body2",children:["📁 You have ",Z.total," saved template",Z.total!==1?"s":"","(",Z.totalMappings," total field mappings).",Z.byTool[(s==null?void 0:s.id)||""]&&e.jsxs("strong",{children:[Z.byTool[(s==null?void 0:s.id)||""]," template",Z.byTool[(s==null?void 0:s.id)||""]!==1?"s":""," for ",s==null?void 0:s.name]})]})}),e.jsxs(j,{sx:{display:"flex",gap:2,height:"700px",minHeight:"700px",border:"1px solid #eaeaea",borderRadius:"4px",padding:"4px"},children:[e.jsxs(j,{sx:{width:"35%",height:"100%",display:"flex",flexDirection:"column",position:"relative",borderRight:"1px solid #eaeaea",paddingRight:"8px"},children:[e.jsx(x,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Source Fields Panel ↕️ (Scrollable)"}),e.jsx(on,{sourceColumns:n,filter:Y,setFilter:P,mappings:o,sampleData:r,onAddParsedFields:(v,E)=>{if(console.log("🤖 PARENT: Received parsed fields for column:",v,E),r&&r.length>0&&E.length>0){const q=r.map((J,w)=>{const M={...J};return E.forEach(b=>{if(b.data[w]!==null){const g=b.id.split("_").slice(1).join("_"),N=`${v}_parsed_${g}`;M[N]=b.data[w],console.log(`🤖 PARENT: Injecting parsed data: ${N} = "${b.data[w]}"`)}}),M});console.log("🤖 PARENT: Updating Redux sampleData with parsed fields"),t(rs(q)),I({message:`Added ${E.length} parsed fields for ${v}`,severity:"success",open:!0})}}})]}),e.jsxs(j,{sx:{width:"65%",height:"100%",display:"flex",flexDirection:"column",gap:2,overflow:"hidden",position:"relative"},onDragOver:v=>{v.target===v.currentTarget&&(v.preventDefault(),console.log("Parent container dragOver"))},onDrop:v=>{v.target===v.currentTarget&&(v.preventDefault(),C(v),console.log("Parent container drop"))},children:[e.jsx(x,{variant:"h6",sx:{position:"sticky",top:0,zIndex:10,backgroundColor:"#fff",paddingBottom:"8px",borderBottom:"2px solid #1976d2",marginBottom:"8px",color:"#1976d2",fontWeight:"bold",textAlign:"center"},children:"Target Fields Panel ↕️ (Scrollable)"}),e.jsx(hn,{toolConfig:i,showAllFields:K,setShowAllFields:G,filter:S,setFilter:H,mappings:o,onMappingChange:le,onRemoveMapping:R,validationErrors:A,sampleData:r,sourceColumns:n}),A.length>0&&e.jsx(j,{sx:{flexShrink:0,marginTop:"auto",borderTop:"1px solid #eaeaea",paddingTop:"8px"},children:e.jsx(gn,{validationErrors:A,jumpToField:v=>{const E=document.getElementById(`target-field-${v}`);E&&(E.scrollIntoView({behavior:"smooth",block:"center"}),E.classList.add("highlight-field"),setTimeout(()=>{E.classList.remove("highlight-field")},2e3))}})})]})]}),e.jsx(ge,{sx:{p:2,mt:2},children:e.jsx(fn,{sampleData:r,mappings:o,toolConfig:i})}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",mt:2},children:[e.jsx(se,{variant:"outlined",startIcon:e.jsx(st,{}),onClick:z,children:"Back"}),e.jsxs(j,{children:[e.jsx(se,{variant:"outlined",onClick:ee,disabled:T||!n.length,sx:{mr:1},children:T?e.jsxs(e.Fragment,{children:[e.jsx(Pe,{size:20,sx:{mr:1}}),"Auto-mapping..."]}):"Auto-Map Fields"}),e.jsx(se,{variant:"contained",endIcon:e.jsx(kt,{}),onClick:$,disabled:!V,children:"Continue"})]})]}),e.jsx(hs,{open:B.open,autoHideDuration:6e3,onClose:()=>I({...B,open:!1}),children:e.jsx(ce,{onClose:()=>I({...B,open:!1}),severity:B.severity,children:B.message})})]}):e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(ce,{severity:"error",children:"No tool selected. Please select a tool first."}),e.jsx(se,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(st,{}),onClick:z,children:"Go Back to Upload"})]}):e.jsxs(j,{sx:{p:3,textAlign:"center"},children:[e.jsx(ce,{severity:"error",children:"No source columns available. Please upload a file first."}),e.jsx(se,{sx:{mt:2},variant:"outlined",startIcon:e.jsx(st,{}),onClick:z,children:"Go Back to Upload"})]})},Dn=({data:t,validationErrors:n,highlightedCell:r})=>{const[s,o]=O.useState(0),[a,c]=O.useState(10),[p,u]=O.useState(""),[d,m]=O.useState("");O.useEffect(()=>{if(r){const S=Math.floor(r.rowIndex/a);S!==s&&o(S)}},[r,a,s]);const y=t.length>0?Object.keys(t[0]):[],T={};n.forEach(S=>{S.rowIndex!==void 0&&(T[S.rowIndex]||(T[S.rowIndex]={}),T[S.rowIndex][S.field]||(T[S.rowIndex][S.field]=[]),T[S.rowIndex][S.field].push(S))});const F=(S,H)=>{o(H)},A=S=>{c(parseInt(S.target.value,10)),o(0)},_=S=>{u(S.target.value),o(0)},B=S=>{m(S.target.value),o(0)},I=()=>{m(""),o(0)},Y=t.filter(S=>{if(!d)return!0;if(p){const H=S[p];return H!==void 0&&String(H).toLowerCase().includes(d.toLowerCase())}return Object.values(S).some(H=>H!==void 0&&String(H).toLowerCase().includes(d.toLowerCase()))}),P=Y.slice(s*a,s*a+a);return t.length===0?e.jsx(j,{children:e.jsx(x,{variant:"h6",gutterBottom:!0,children:"No data available for preview"})}):e.jsxs(j,{children:[e.jsx(Rs,{styles:{"@keyframes pulse":{"0%":{opacity:.7},"100%":{opacity:1}}}}),e.jsxs(j,{sx:{display:"flex",gap:2,mb:2},children:[e.jsx(be,{label:"Search",value:d,onChange:B,sx:{flexGrow:1},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(rt,{})}),endAdornment:d&&e.jsx(Ae,{position:"end",children:e.jsx(Ce,{onClick:I,edge:"end",size:"small",children:e.jsx(_t,{})})})}}),e.jsxs(Le,{sx:{minWidth:200},children:[e.jsx(Ue,{id:"filter-field-label",children:"Filter Field"}),e.jsxs(Be,{labelId:"filter-field-label",id:"filter-field",value:p,label:"Filter Field",onChange:_,children:[e.jsx(oe,{value:"",children:"All Fields"}),y.map(S=>e.jsx(oe,{value:S,children:S},S))]})]})]}),e.jsxs(ge,{sx:{width:"100%",mb:2},children:[e.jsx(wt,{sx:{maxHeight:500},children:e.jsxs(dt,{stickyHeader:!0,"aria-label":"data preview table",children:[e.jsx(ut,{children:e.jsxs(Re,{children:[e.jsx(Se,{children:"#"}),y.map(S=>e.jsx(Se,{children:S},S))]})}),e.jsx(pt,{children:P.map((S,H)=>{const K=s*a+H,G=T[K];return e.jsxs(Re,{hover:!0,sx:{"&:last-child td, &:last-child th":{border:0},backgroundColor:G?"#fff8f8":"inherit"},children:[e.jsx(Se,{children:K+1}),y.map(i=>{const l=(G==null?void 0:G[i])||[],h=l.length>0,D=r&&r.rowIndex===K&&r.field===i;return e.jsxs(Se,{sx:{backgroundColor:D?"#fff3e0":h?"#ffebee":"inherit",position:"relative",border:D?"2px solid #ff9800":"inherit",transition:"all 0.3s ease"},children:[S[i]!==void 0?String(S[i]):"",h&&e.jsx(j,{sx:{position:"absolute",top:0,right:0},children:e.jsx(ie,{color:"error",size:"small",label:l.length,sx:{height:16,fontSize:"0.6rem"}})}),D&&e.jsx(j,{sx:{position:"absolute",top:0,left:0,width:"100%",height:"100%",border:"2px solid #ff9800",borderRadius:"4px",pointerEvents:"none",animation:"pulse 1s ease-in-out infinite alternate"}})]},i)})]},H)})})]})}),e.jsx(Ws,{rowsPerPageOptions:[5,10,25,50,100],component:"div",count:Y.length,rowsPerPage:a,page:s,onPageChange:F,onRowsPerPageChange:A})]})]})};class wn{constructor(){it(this,"defaultFields",{})}registerField(n,r){console.log(`Registering default value for ${n}:`,r),this.defaultFields[n]=r}hasDefaultValue(n){return this.defaultFields[n]!==void 0}getDefaultValue(n){return this.defaultFields[n]}registerMappings(n){this.defaultFields={},n.forEach(r=>{if(r.sourceField==="__default__"&&r.transformations){const s=r.transformations.find(o=>o.type==="convert"&&o.params&&o.params.defaultValue!==void 0);s&&s.params.defaultValue!==void 0&&this.registerField(r.targetField,s.params.defaultValue)}}),console.log("Registered default values:",this.defaultFields)}clear(){this.defaultFields={}}}const Zt=new wn,_n=(t,n)=>{const r=[];return t.forEach((s,o)=>{n.forEach(a=>{let c=s[a.name];const p=Zt.hasDefaultValue(a.name);if((c==null||c==="")&&p&&(c=Zt.getDefaultValue(a.name),console.log(`Using default value for validation of ${a.name}:`,c)),a.name==="Incident ID"){a.isRequired&&!p&&(c==null||c==="")&&r.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(a.name.includes("Time")&&typeof c=="string"){a.isRequired&&!p&&(c==null||c==="")&&r.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(a.isRequired&&!p&&(c==null||c==="")){r.push({rowIndex:o,field:a.name,message:`${a.name} is required`,type:"required"});return}if(c==null||c==="")return;const u=In(c,a.dataType,a.name,o);if(u){r.push(u);return}a.validationRules&&a.validationRules.forEach(d=>{const m=An(c,d,a.name,o);m&&r.push(m)})})}),console.log("Validation completed with errors:",r),r},In=(t,n,r,s)=>{switch(n){case"string":if(typeof t!="string")return{rowIndex:s,field:r,message:`${r} must be a string`,type:"custom"};break;case"number":if(typeof t!="number"&&(typeof t!="string"||isNaN(Number(t))))return{rowIndex:s,field:r,message:`${r} must be a number`,type:"custom"};break;case"date":if(!(typeof t=="string"||t instanceof Date))return{rowIndex:s,field:r,message:`${r} must be a date`,type:"custom"};const o=new Date(t);if(isNaN(o.getTime()))return{rowIndex:s,field:r,message:`${r} contains an invalid date format`,type:"custom"};break;case"boolean":if(typeof t!="boolean"&&t!=="true"&&t!=="false"&&t!=="0"&&t!=="1")return{rowIndex:s,field:r,message:`${r} must be a boolean value`,type:"custom"};break;case"location":if(typeof t=="string"){if(!/^-?\d+(\.\d+)?,\s*-?\d+(\.\d+)?$/.test(t))return{rowIndex:s,field:r,message:`${r} must be a valid location format (latitude,longitude)`,type:"custom"}}else if(!t.lat||!t.lng)return{rowIndex:s,field:r,message:`${r} must be a valid location object or string`,type:"custom"};break}return null},An=(t,n,r,s)=>{switch(n.type){case"required":break;case"min":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)<n.params.value)return{rowIndex:s,field:r,message:`${r} must be at least ${n.params.value}`,type:"min"}}else if(typeof t=="string"&&t.length<n.params.value)return{rowIndex:s,field:r,message:`${r} must be at least ${n.params.value} characters`,type:"min"};break;case"max":if(typeof t=="number"||!isNaN(Number(t))){if(Number(t)>n.params.value)return{rowIndex:s,field:r,message:`${r} must be at most ${n.params.value}`,type:"max"}}else if(typeof t=="string"&&t.length>n.params.value)return{rowIndex:s,field:r,message:`${r} must be at most ${n.params.value} characters`,type:"max"};break;case"pattern":if(typeof t=="string"&&!new RegExp(n.params.regex).test(t))return{rowIndex:s,field:r,message:n.params.message||`${r} does not match the required pattern`,type:"pattern"};break;case"oneOf":const o=n.params.values;if(!o.includes(t))return{rowIndex:s,field:r,message:`${r} must be one of: ${o.join(", ")}`,type:"oneOf"};break;case"custom":if(n.params.validateFn&&typeof n.params.validateFn=="function"&&!n.params.validateFn(t))return{rowIndex:s,field:r,message:n.params.message||`${r} is invalid`,type:"custom"};break}return null},$n=t=>{const n={total:t.length,byType:{},byField:{}};return t.forEach(r=>{n.byType[r.type]||(n.byType[r.type]=0),n.byType[r.type]++,n.byField[r.field]||(n.byField[r.field]=0),n.byField[r.field]++}),n},Ct=t=>{const{children:n,value:r,index:s,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==s,id:`validation-tabpanel-${s}`,"aria-labelledby":`validation-tab-${s}`,...o,children:r===s&&e.jsx(j,{sx:{p:2},children:n})})},Mn=({errors:t,onJumpToError:n})=>{const[r,s]=O.useState(0),[o,a]=O.useState(""),c=$n(t),p=(y,T)=>{s(T)},u=t.filter(y=>y.field.toLowerCase().includes(o.toLowerCase())||y.message.toLowerCase().includes(o.toLowerCase())),d={};u.forEach(y=>{d[y.field]||(d[y.field]=[]),d[y.field].push(y)});const m=y=>{let T="default";switch(y){case"required":T="error";break;case"pattern":case"min":case"max":T="warning";break;case"oneOf":case"custom":T="info";break}return e.jsx(ie,{size:"small",label:y,color:T})};return e.jsxs(ge,{sx:{p:0,mb:3},children:[e.jsx(j,{sx:{p:2,bgcolor:t.length>0?"#ffebee":"#e8f5e9",borderRadius:"4px 4px 0 0"},children:e.jsxs(x,{variant:"h6",component:"h3",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ht,{}),"Validation Results",e.jsx(ie,{label:`${t.length} ${t.length===1?"error":"errors"}`,color:t.length>0?"error":"success",sx:{ml:2}})]})}),e.jsx(xe,{}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:r,onChange:p,"aria-label":"validation tabs",children:[e.jsx(_e,{label:"Summary",id:"validation-tab-0","aria-controls":"validation-tabpanel-0"}),e.jsx(_e,{label:"By Field",id:"validation-tab-1","aria-controls":"validation-tabpanel-1"}),e.jsx(_e,{label:"All Errors",id:"validation-tab-2","aria-controls":"validation-tabpanel-2"})]})}),e.jsx(Ct,{value:r,index:0,children:t.length===0?e.jsx(ce,{severity:"success",children:"No validation errors found. Your data is ready for export!"}):e.jsxs(e.Fragment,{children:[e.jsxs(ce,{severity:"warning",children:["Found ",t.length," validation ",t.length===1?"error":"errors"," that need to be addressed before export."]}),e.jsxs(j,{sx:{mt:2},children:[e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:"Error Distribution by Field"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1,mb:2},children:Object.entries(c.byField).map(([y,T])=>e.jsx(ie,{label:`${y}: ${T}`,color:"error",variant:"outlined",onClick:()=>s(1)},y))}),e.jsx(x,{variant:"subtitle1",gutterBottom:!0,children:"Error Types"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:1},children:Object.entries(c.byType).map(([y,T])=>e.jsx(ie,{label:`${y}: ${T}`,color:"primary",variant:"outlined"},y))})]})]})}),e.jsxs(Ct,{value:r,index:1,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:o,onChange:y=>a(y.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(rt,{})}),endAdornment:o&&e.jsx(Ae,{position:"end",children:e.jsx(Ce,{onClick:()=>a(""),edge:"end",size:"small",children:e.jsx(_t,{})})})}}),Object.keys(d).length===0?e.jsx(ce,{severity:"info",children:"No errors match your search criteria."}):Object.entries(d).map(([y,T])=>e.jsxs(as,{defaultExpanded:Object.keys(d).length===1,children:[e.jsx(is,{expandIcon:e.jsx(xt,{}),children:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,width:"100%"},children:[e.jsx(x,{children:y}),e.jsx(ie,{size:"small",label:T.length,color:"error",sx:{ml:"auto"}})]})}),e.jsx(ls,{children:e.jsx(ze,{dense:!0,disablePadding:!0,children:T.map((F,A)=>e.jsxs(Je.Fragment,{children:[A>0&&e.jsx(xe,{component:"li"}),e.jsx(Ee,{secondaryAction:F.rowIndex!==void 0&&n&&e.jsx(se,{size:"small",variant:"outlined",onClick:()=>F.rowIndex!==void 0&&n(F.rowIndex,F.field),children:"Jump to Row"}),children:e.jsx(Fe,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[F.message,m(F.type)]}),secondary:F.rowIndex!==void 0?`Row ${F.rowIndex+1}`:"Global error"})})]},A))})})]},y))]}),e.jsxs(Ct,{value:r,index:2,children:[e.jsx(be,{fullWidth:!0,placeholder:"Search errors by field or message",value:o,onChange:y=>a(y.target.value),sx:{mb:2},InputProps:{startAdornment:e.jsx(Ae,{position:"start",children:e.jsx(rt,{})}),endAdornment:o&&e.jsx(Ae,{position:"end",children:e.jsx(Ce,{onClick:()=>a(""),edge:"end",size:"small",children:e.jsx(_t,{})})})}}),e.jsx(ze,{dense:!0,children:u.length===0?e.jsx(ce,{severity:"info",children:"No errors match your search criteria."}):u.map((y,T)=>e.jsxs(Je.Fragment,{children:[T>0&&e.jsx(xe,{component:"li"}),e.jsx(Ee,{secondaryAction:y.rowIndex!==void 0&&n&&e.jsx(se,{size:"small",variant:"outlined",onClick:()=>y.rowIndex!==void 0&&n(y.rowIndex,y.field),children:"Jump to Row"}),children:e.jsx(Fe,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsxs(x,{component:"span",sx:{fontWeight:500},children:[y.field,":"]}),y.message,m(y.type)]}),secondary:y.rowIndex!==void 0?`Row ${y.rowIndex+1}`:"Global error"})})]},T))})]})]})},Rn=t=>{switch(t){case"string":return"Default Value";case"number":return"0";case"date":return new Date().toISOString().split("T")[0];case"boolean":return"false";case"location":return"0.0,0.0";default:return""}},On=({errors:t,targetFields:n,mappings:r,onAddDefaultValue:s,onJumpToMapping:o})=>{const a=Ot(),[c,p]=O.useState(!1),[u,d]=O.useState(null),[m,y]=O.useState(""),T=O.useMemo(()=>{const I={};return t.forEach(Y=>{I[Y.field]||(I[Y.field]={errors:[],count:0}),I[Y.field].errors.push(Y),I[Y.field].count++}),I},[t]),F=O.useMemo(()=>Object.entries(T).sort((I,Y)=>Y[1].count-I[1].count).map(([I,Y])=>{const P=n.find(i=>i.name===I);if(!P)return null;const S=r.some(i=>i.targetField===I),H=r.some(i=>i.targetField===I&&i.sourceField==="__default__"),K=Y.errors.some(i=>i.type==="required");let G="unknown";return K&&!S?G="map_field":K&&!H?G="add_default":!K&&S&&(G="fix_transformation"),{fieldName:I,fieldDef:P,errorCount:Y.count,errors:Y.errors,hasMapping:S,hasDefaultMapping:H,actionType:G}}).filter(Boolean),[T,n,r]),A=O.useMemo(()=>F.filter(I=>(I==null?void 0:I.actionType)==="add_default").length,[F]),_=I=>{d(I),y(Rn(I.dataType)),p(!0)},B=()=>{if(!u)return;const I={sourceField:"__default__",targetField:u.name,transformations:[{type:"convert",params:{defaultValue:m,targetType:u.dataType}}]};s(I),p(!1)};return t.length===0?e.jsx(ce,{severity:"success",sx:{my:2},children:"No validation errors detected. Your data is ready for export!"}):e.jsxs(ge,{sx:{p:0,my:2,borderRadius:1,border:`1px solid ${a.palette.divider}`,overflow:"hidden"},elevation:2,children:[e.jsxs(j,{sx:{p:2,bgcolor:a.palette.mode==="dark"?me(a.palette.error.dark,.2):me(a.palette.error.light,.1),borderBottom:`1px solid ${a.palette.divider}`},children:[e.jsxs(x,{variant:"h6",sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(ht,{color:"error"}),"Validation Solutions",e.jsx(ie,{label:`${t.length} ${t.length===1?"issue":"issues"}`,color:"error",size:"small",sx:{ml:1}})]}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{mt:.5},children:A>0?`${A} ${A===1?"issue":"issues"} can be fixed with default values.`:"Review the suggested actions to resolve validation issues."})]}),e.jsxs(ze,{sx:{py:0},children:[A>0&&e.jsxs(Ee,{sx:{bgcolor:me(a.palette.success.light,.1),borderBottom:`1px solid ${a.palette.divider}`,"&:hover":{bgcolor:me(a.palette.success.light,.2)}},children:[e.jsx(Oe,{children:e.jsx(ot,{color:"success"})}),e.jsx(Fe,{primary:"Fix Required Fields with Default Values",secondary:`Add default values to ${A} unmapped required ${A===1?"field":"fields"}`}),e.jsx(It,{children:e.jsx(se,{variant:"outlined",color:"success",size:"small",onClick:()=>{const I=F.find(Y=>(Y==null?void 0:Y.actionType)==="add_default");I!=null&&I.fieldDef&&_(I.fieldDef)},children:"Set Default Values"})})]}),F.map((I,Y)=>{var K;if(!I)return null;let P=e.jsx(ht,{color:"error"}),S="error",H="";switch(I.actionType){case"map_field":P=e.jsx(Kr,{color:"info"}),S="info",H="Field requires mapping to source data";break;case"add_default":P=e.jsx(Yt,{color:"success"}),S="success",H="Field requires a value, add a default";break;case"fix_transformation":P=e.jsx(ds,{color:"warning"}),S="warning",H="Field has validation issues with current mapping";break}return e.jsxs(Je.Fragment,{children:[Y>0&&e.jsx(xe,{}),e.jsxs(Ee,{sx:{py:1.5,"&:hover":{bgcolor:me(a.palette.primary.light,.05)}},children:[e.jsx(Oe,{children:P}),e.jsx(Fe,{primary:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(x,{variant:"subtitle2",children:I.fieldName}),e.jsx(ie,{size:"small",label:`${I.errorCount} ${I.errorCount===1?"error":"errors"}`,color:"error",variant:"outlined"}),I.fieldDef&&e.jsx(ie,{size:"small",label:I.fieldDef.dataType,color:"default",variant:"outlined"})]}),secondary:e.jsxs(j,{sx:{mt:.5},children:[e.jsx(x,{variant:"body2",color:"text.secondary",children:H}),e.jsxs(x,{variant:"caption",color:"error",sx:{display:"block",mt:.5},children:[(K=I.errors[0])==null?void 0:K.message,I.errors.length>1&&` (+ ${I.errors.length-1} more)`]})]})}),e.jsxs(It,{children:[I.actionType==="add_default"&&I.fieldDef&&e.jsx(se,{variant:"outlined",color:S,size:"small",startIcon:e.jsx(Yt,{}),onClick:()=>_(I.fieldDef),children:"Add Default"}),(I.actionType==="map_field"||I.actionType==="fix_transformation")&&e.jsx(se,{variant:"outlined",color:S,size:"small",startIcon:e.jsx(Hs,{}),onClick:()=>o(I.fieldName),children:I.actionType==="map_field"?"Map Field":"Fix Mapping"})]})]})]},I.fieldName)})]}),e.jsxs(Ke,{open:c,onClose:()=>p(!1),maxWidth:"sm",fullWidth:!0,children:[e.jsxs(Xe,{children:["Set Default Value for ",u==null?void 0:u.name]}),e.jsx(Ze,{children:e.jsxs(j,{sx:{mt:1},children:[e.jsx(x,{variant:"body2",gutterBottom:!0,children:u==null?void 0:u.description}),e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1,mb:2},children:[e.jsx(x,{variant:"caption",children:"Data Type:"}),e.jsx(ie,{size:"small",label:u==null?void 0:u.dataType,color:"primary",variant:"outlined"})]}),(u==null?void 0:u.dataType)==="boolean"?e.jsxs(be,{select:!0,fullWidth:!0,value:m,onChange:I=>y(I.target.value),label:"Default Value",variant:"outlined",margin:"normal",children:[e.jsx(oe,{value:"true",children:"True"}),e.jsx(oe,{value:"false",children:"False"})]}):e.jsx(be,{fullWidth:!0,value:m,onChange:I=>y(I.target.value),label:"Default Value",variant:"outlined",margin:"normal",type:(u==null?void 0:u.dataType)==="number"?"number":"text",helperText:`This value will be used for all records where ${u==null?void 0:u.name} is not mapped or empty`})]})}),e.jsxs(Qe,{children:[e.jsx(se,{onClick:()=>p(!1),children:"Cancel"}),e.jsx(se,{onClick:B,variant:"contained",color:"primary",startIcon:e.jsx(ot,{}),children:"Apply Default Value"})]})]})]})},Qt=t=>{const{children:n,value:r,index:s,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==s,id:`preview-tabpanel-${s}`,"aria-labelledby":`preview-tab-${s}`,...o,children:r===s&&e.jsx(j,{sx:{p:2},children:n})})},kn=()=>{const t=at(),{sourceFile:n,transformedData:r,validationErrors:s,selectedTool:o,mappings:a}=Ve(S=>S.formatter),[c,p]=O.useState(0),[u,d]=O.useState(!1),[m,y]=O.useState(null),T=O.useRef(null),F=(S,H)=>{p(H)},A=()=>{t(ke(1))},_=()=>{t(ke(3))},B=()=>{if(!(!r||!o)){d(!0);try{const S=[...o.requiredFields,...o.optionalFields],H=Ve(l=>l.formatter.mappings),K={};H&&H.forEach(l=>{if(l.sourceField==="__default__"&&l.transformations){const h=l.transformations.find(D=>D.type==="convert"&&D.params&&D.params.defaultValue!==void 0);h&&(K[l.targetField]=!0,console.log(`Field ${l.targetField} has default value: ${h.params.defaultValue}`))}});const G=r.map(l=>{const h={...l};return Object.keys(K).forEach(D=>{typeof window<"u"&&window.defaultValueRegistry&&window.defaultValueRegistry.register(D,!0)}),h}),i=_n(G,S);t(Os(i)),i.length===0?t($e("complete")):t($e("error"))}catch(S){console.error("Validation error:",S),t($e("error"))}finally{d(!1)}}},I=(S,H)=>{p(0),y({rowIndex:S,field:H}),setTimeout(()=>{T.current&&T.current.scrollIntoView({behavior:"smooth"})},100),setTimeout(()=>{y(null)},3e3)},Y=S=>{console.log("Adding default value mapping:",S),t(ks(S)),setTimeout(()=>{B()},100)},P=S=>{t(ke(1))};return O.useEffect(()=>{r&&r.length>0&&B()},[r]),!r||r.length===0?e.jsxs(ge,{sx:{p:3,textAlign:"center"},children:[e.jsxs(ce,{severity:"warning",sx:{mb:2},children:[e.jsx(dr,{children:"No Data Available"}),"There is no transformed data to preview. Please go back to the field mapping step."]}),e.jsx(se,{variant:"contained",startIcon:e.jsx(Gt,{}),onClick:A,children:"Back to Field Mapping"})]}):e.jsxs(j,{children:[e.jsx(x,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Preview & Validate Data"}),e.jsx(ge,{sx:{p:2,mb:3},children:e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(x,{variant:"body1",children:[(n==null?void 0:n.name)||"No file"," (",n==null?void 0:n.type,")"]})]})}),e.jsx(pe,{size:{xs:12,md:6},children:e.jsxs(j,{children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(x,{variant:"body1",children:[r.length," records processed"]})]})}),e.jsx(pe,{size:12,children:e.jsxs(j,{children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:u?e.jsxs(e.Fragment,{children:[e.jsx(Pe,{size:20}),e.jsx(x,{children:"Validating data..."})]}):s.length===0?e.jsxs(e.Fragment,{children:[e.jsx(xs,{color:"success"}),e.jsx(x,{color:"success.main",children:"Data validation passed! Ready for export."})]}):e.jsxs(e.Fragment,{children:[e.jsx(en,{color:"error"}),e.jsxs(x,{color:"error",children:[s.length," validation ",s.length===1?"error":"errors"," found"]})]})})]})})]})}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:c,onChange:F,"aria-label":"preview and validation tabs",children:[e.jsx(_e,{label:"Data Preview",id:"preview-tab-0","aria-controls":"preview-tabpanel-0"}),e.jsx(_e,{label:`Validation & Solutions ${s.length>0?`(${s.length})`:""}`,id:"preview-tab-1","aria-controls":"preview-tabpanel-1",sx:{color:s.length>0?"error.main":"inherit"}})]})}),e.jsx(Qt,{value:c,index:0,children:e.jsx(j,{ref:T,children:e.jsx(Dn,{data:r,validationErrors:s,highlightedCell:m})})}),e.jsxs(Qt,{value:c,index:1,children:[s.length>0&&o&&e.jsx(On,{errors:s,targetFields:[...o.requiredFields,...o.optionalFields],mappings:a,onAddDefaultValue:Y,onJumpToMapping:P}),e.jsx(Mn,{errors:s,onJumpToError:I})]}),e.jsx(xe,{sx:{my:3}}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between"},children:[e.jsx(se,{variant:"outlined",startIcon:e.jsx(Gt,{}),onClick:A,children:"Back to Field Mapping"}),e.jsx(se,{variant:"contained",endIcon:e.jsx(kt,{}),onClick:_,disabled:s.length>0,children:"Continue to Export"})]})]})},Nn=({selectedFormat:t,onFormatChange:n})=>{const r=s=>{n(s.target.value)};return e.jsx(bt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(jt,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Select Export Format"}),e.jsx(Le,{component:"fieldset",children:e.jsxs(Qs,{"aria-label":"export-format",name:"export-format",value:t,onChange:r,children:[e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="csv"?"primary.main":"divider",borderRadius:1,bgcolor:t==="csv"?"action.hover":"transparent"},children:[e.jsx(We,{value:"csv",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",flexWrap:"wrap",gap:1},children:[e.jsx(Zs,{color:"primary"}),e.jsx(x,{variant:"body1",children:"CSV"}),e.jsx(ie,{size:"small",label:"Most Compatible",color:"success"})]})}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Comma-separated values format, widely supported by spreadsheet applications like Excel and Google Sheets."})]}),e.jsxs(j,{sx:{mb:2,p:1,border:"1px solid",borderColor:t==="json"?"primary.main":"divider",borderRadius:1,bgcolor:t==="json"?"action.hover":"transparent"},children:[e.jsx(We,{value:"json",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(qr,{color:"info"}),e.jsx(x,{variant:"body1",children:"JSON"})]})}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"JavaScript Object Notation, ideal for programmatic use or importing into other applications."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="excel"?"primary.main":"divider",borderRadius:1,bgcolor:t==="excel"?"action.hover":"transparent"},children:[e.jsx(We,{value:"excel",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(mt,{color:"success"}),e.jsx(x,{variant:"body1",children:"Excel"})]})}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Export directly to native Excel format (.xlsx) with proper formatting and column sizing."})]}),e.jsxs(j,{sx:{p:1,border:"1px solid",borderColor:t==="pdf"?"primary.main":"divider",borderRadius:1,bgcolor:t==="pdf"?"action.hover":"transparent"},children:[e.jsx(We,{value:"pdf",control:e.jsx(lt,{}),label:e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx(os,{color:"error"}),e.jsx(x,{variant:"body1",children:"PDF"}),e.jsx(ie,{size:"small",label:"Professional",color:"secondary"})]})}),e.jsx(x,{variant:"body2",color:"text.secondary",sx:{ml:4},children:"Create a professional PDF document with formatted data table, ideal for reports and presentations."})]})]})})]})})},Dt=[{id:"fire-map-pro",name:"Fire Map Pro",description:"Professional mapping and visualization for incident locations and analysis",icon:e.jsx(Ut,{fontSize:"large",sx:{color:"#dc2626"}}),requiredFields:["incidentId","latitude","longitude"],optionalFields:["incidentType","incidentDate","incidentTime","address","city","state","priority","respondingUnit","responseCategory"]},{id:"response-time-analyzer",name:"Response Time Analyzer",description:"Analyze incident response times and visualize performance metrics",icon:e.jsx(er,{fontSize:"large",sx:{color:"#2196f3"}}),requiredFields:["incidentId","incidentDate"],optionalFields:["dispatchTime","enRouteTime","arrivalTime","latitude","longitude"]},{id:"call-density-heatmap",name:"Call Density Heatmap",description:"Visualize incident density across geographic areas",icon:e.jsx(Ut,{fontSize:"large",sx:{color:"#ff9800"}}),requiredFields:["incidentId","latitude","longitude"]},{id:"incident-dashboard",name:"Incident Dashboard",description:"Interactive dashboard for incident analysis and reporting",icon:e.jsx(Gs,{fontSize:"large",sx:{color:"#4caf50"}}),requiredFields:["incidentId","incidentType","incidentDate"]},{id:"trend-analyzer",name:"Trend Analyzer",description:"Identify incident trends and patterns over time",icon:e.jsx(tr,{fontSize:"large",sx:{color:"#9c27b0"}}),requiredFields:["incidentId","incidentDate","incidentType"]}],Pn=({selectedTool:t,onToolSelect:n,transformedData:r,onSendToTool:s,isSending:o,preTransformedData:a})=>{console.log("📡📡📡 SEND TO TOOL PANEL RENDER - FRESH BUILD JUN 13 2025 16:48 - selectedTool:",t),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - onSendToTool function:",!!s),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - transformedData length:",r==null?void 0:r.length),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData exists:",!!a),console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData length:",a==null?void 0:a.length),a&&a.length>0&&console.log("📡📡📡 SEND TO TOOL PANEL RENDER - preTransformedData sample:",a[0]);const c=d=>{n(d.target.value)},u=t?(d=>{const m=Dt.find(_=>_.id===d);if(!m)return{compatible:!1,missingFields:[]};if(d==="fire-map-pro")if(console.log("🔍 FIRE MAP PRO COMPATIBILITY CHECK - ENHANCED FOR ADDRESS PARSING"),console.log("preTransformedData exists:",!!a),console.log("preTransformedData length:",a==null?void 0:a.length),console.log("transformedData sample:",r[0]),a&&a.length>0){const _=Object.keys(r[0]);console.log("🔍 Available transformed data fields:",_);const B=m.optionalFields?m.optionalFields.filter(Y=>{const P=_.includes(Y);return console.log(`🔍 Fire Map Pro optional field ${Y}: ${P?"AVAILABLE":"NOT AVAILABLE"}`),P}):[],I=m.optionalFields?m.optionalFields.filter(Y=>!_.includes(Y)):[];return console.log("✅ Fire Map Pro data is compatible - features exist"),console.log("📊 Available optional fields:",B),console.log("📋 Missing optional fields:",I),{compatible:!0,missingFields:[],hasOptionalFields:B,missingOptionalFields:I}}else return console.log("❌ Fire Map Pro data not compatible - no features"),{compatible:!1,missingFields:["incidentId","latitude","longitude"],hasOptionalFields:[],missingOptionalFields:m.optionalFields||[]};if(d==="response-time-analyzer"){console.log("🔍 RESPONSE TIME ANALYZER COMPATIBILITY CHECK - FLEXIBLE FIELD MATCHING");const _=Object.keys(r[0]);console.log("🔍 Available data fields:",_),console.log("🔍 Required fields (camelCase):",m.requiredFields);const B=m.requiredFields.filter(P=>{if(_.includes(P))return console.log(`✅ Found exact match for ${P}`),!1;const S=P.replace(/[A-Z]/g,H=>`_${H.toLowerCase()}`);return _.includes(S)?(console.log(`✅ Found snake_case match for ${P} -> ${S}`),!1):(console.log(`❌ No match found for ${P} (tried ${P} and ${S})`),!0)});console.log("🔍 CHECKING OPTIONAL FIELDS:"),console.log("🔍 Tool optional fields:",m.optionalFields);const I=m.optionalFields?m.optionalFields.filter(P=>{let S=P.replace(/[A-Z]/g,G=>`_${G.toLowerCase()}`);P==="enRouteTime"&&(S="enroute_time");const H=_.includes(P),K=_.includes(S);return console.log(`🔍 Optional field ${P}: camelCase=${H}, snake_case(${S})=${K}`),H||K}):[],Y=m.optionalFields?m.optionalFields.filter(P=>{let S=P.replace(/[A-Z]/g,H=>`_${H.toLowerCase()}`);return P==="enRouteTime"&&(S="enroute_time"),!_.includes(P)&&!_.includes(S)}):[];return console.log("🔍 OPTIONAL FIELDS RESULT:"),console.log("✅ Has optional fields:",I),console.log("❌ Missing optional fields:",Y),{compatible:B.length===0,missingFields:B,hasOptionalFields:I,missingOptionalFields:Y}}const y=Object.keys(r[0]);console.log(`🔍 ${d.toUpperCase()} COMPATIBILITY CHECK`),console.log("Available fields:",y),console.log("Required fields:",m.requiredFields);const T=m.requiredFields.filter(_=>!y.includes(_)),F=m.optionalFields?m.optionalFields.filter(_=>y.includes(_)):[],A=m.optionalFields?m.optionalFields.filter(_=>!y.includes(_)):[];return{compatible:T.length===0,missingFields:T,hasOptionalFields:F,missingOptionalFields:A}})(t):{compatible:!1,missingFields:[]};return e.jsxs(j,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Send to FireEMS Tool"}),e.jsx(ce,{severity:"info",sx:{mb:3},children:"Send your formatted data directly to another FireEMS tool for analysis and visualization."}),e.jsxs(Le,{fullWidth:!0,sx:{mb:3},children:[e.jsx(Ue,{id:"tool-select-label",children:"Select Tool"}),e.jsxs(Be,{labelId:"tool-select-label",id:"tool-select",value:t||"",label:"Select Tool",onChange:c,children:[e.jsx(oe,{value:"",children:e.jsx("em",{children:"Select a tool..."})}),Dt.map(d=>e.jsx(oe,{value:d.id,children:d.name},d.id))]})]}),t&&e.jsx(pe,{container:!0,spacing:3,children:Dt.filter(d=>d.id===t).map(d=>e.jsx(pe,{size:12,children:e.jsxs(bt,{variant:"outlined",children:[e.jsxs(jt,{children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",mb:2},children:[d.icon,e.jsxs(j,{sx:{ml:2},children:[e.jsx(x,{variant:"h6",children:d.name}),e.jsx(x,{variant:"body2",color:"text.secondary",children:d.description})]})]}),e.jsx(xe,{sx:{mb:2}}),e.jsx(x,{variant:"subtitle2",gutterBottom:!0,children:"Required Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.requiredFields.map((m,y)=>e.jsx(x,{variant:"body2",sx:{backgroundColor:u.missingFields.includes(m)?"error.light":"success.light",color:u.missingFields.includes(m)?"error.contrastText":"success.contrastText",borderRadius:1,px:1,py:.5},children:m},y))}),d.optionalFields&&e.jsxs(e.Fragment,{children:[e.jsx(x,{variant:"subtitle2",gutterBottom:!0,children:"Optional Fields:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mb:2},children:d.optionalFields.map((m,y)=>{var T,F;return e.jsx(x,{variant:"body2",sx:{backgroundColor:(T=u.hasOptionalFields)!=null&&T.includes(m)?"info.light":"action.disabledBackground",color:(F=u.hasOptionalFields)!=null&&F.includes(m)?"info.contrastText":"text.secondary",borderRadius:1,px:1,py:.5},children:m},y)})})]}),!u.compatible&&e.jsxs(ce,{severity:"warning",icon:e.jsx(Zr,{}),sx:{mb:2},children:[e.jsx(x,{variant:"body2",gutterBottom:!0,children:"Your data is missing required fields for this tool:"}),e.jsx("ul",{style:{margin:0,paddingLeft:"20px"},children:u.missingFields.map((m,y)=>e.jsx("li",{children:m},y))})]}),u.compatible&&e.jsxs(ce,{severity:"success",sx:{mb:2},children:[e.jsx(x,{variant:"body2",gutterBottom:!0,children:"Your data is compatible with this tool. All required fields are present."}),d.optionalFields&&u.hasOptionalFields&&u.hasOptionalFields.length>0&&e.jsxs(x,{variant:"body2",children:[u.hasOptionalFields.length," of ",d.optionalFields.length," optional fields are available for enhanced analysis."]})]})]}),e.jsx(sr,{children:e.jsx(se,{type:"button",variant:"contained",color:"primary",fullWidth:!0,disabled:!u.compatible||o,startIcon:o?e.jsx(Pe,{size:20}):e.jsx(bs,{}),onClick:m=>{m.preventDefault(),m.stopPropagation(),console.log("🚀🚀🚀 SEND TO TOOL BUTTON CLICKED - FRESH BUILD JUN 13 2025 16:49 - tool.id:",d.id),console.log("🚀🚀🚀 SEND TO TOOL BUTTON - onSendToTool function:",s),s()},children:o?"Sending...":`Send to ${d.name}`})})]})},d.id))})]})},Ln=({dataCount:t,fields:n,format:r})=>{const s=()=>{let a=15;r==="json"?a=25:r==="excel"?a=30:r==="pdf"&&(a=40);const c=t*n.length*a;let p=0;r==="excel"?p=5120:r==="pdf"&&(p=15360);const u=c+p;return u<1048576?`${Math.round(u/1024)} KB`:`${(u/1048576).toFixed(2)} MB`},o=()=>{switch(r){case"csv":return e.jsx(At,{color:"primary"});case"json":return e.jsx(ys,{color:"info"});case"excel":return e.jsx(mt,{color:"success"});case"pdf":return e.jsx(os,{color:"error"});default:return e.jsx(At,{})}};return e.jsx(bt,{variant:"outlined",sx:{height:"100%"},children:e.jsxs(jt,{children:[e.jsx(x,{variant:"h6",gutterBottom:!0,children:"Export Summary"}),e.jsxs(ze,{disablePadding:!0,children:[e.jsxs(Ee,{children:[e.jsx(Oe,{sx:{minWidth:"40px"},children:o()}),e.jsx(Fe,{primary:"Format",secondary:r.toUpperCase()})]}),e.jsx(xe,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(Oe,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(Fe,{primary:"Records",secondary:`${t} records will be exported`})]}),e.jsx(xe,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(Oe,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(Fe,{primary:"Fields",secondary:`${n.length} fields per record`})]}),e.jsx(xe,{component:"li"}),e.jsxs(Ee,{children:[e.jsx(Oe,{sx:{minWidth:"40px"},children:e.jsx(qe,{color:"success"})}),e.jsx(Fe,{primary:"Estimated Size",secondary:s()})]})]}),e.jsx(x,{variant:"subtitle2",sx:{mt:2},children:"Fields included:"}),e.jsx(j,{sx:{display:"flex",flexWrap:"wrap",gap:.5,mt:1},children:n.map((a,c)=>e.jsx(ie,{label:a,size:"small"},c))})]})})};console.log("🚨🚨🚨 EXPORT CONTAINER LOADED - NEW VERSION WITH UPFRONT TRANSFORMATION AT",new Date().toISOString());const zn=t=>!t||t.length===0?t:JSON.parse(JSON.stringify(t)).map(r=>{const s={...r};return["Incident Date"].forEach(c=>{if(s[c]&&typeof s[c]=="string")try{const p=new Date(s[c]);if(isNaN(p.getTime()))s[c].includes(" ")&&(s[c]=s[c].split(" ")[0]);else{const u=(p.getMonth()+1).toString().padStart(2,"0"),d=p.getDate().toString().padStart(2,"0"),m=p.getFullYear();s[c]=`${u}/${d}/${m}`}}catch{s[c].includes(" ")&&(s[c]=s[c].split(" ")[0])}}),["Dispatch Time","En Route Time","Arrival Time","Incident Time"].forEach(c=>{if(s[c]&&typeof s[c]=="string")try{const p=new Date(s[c]);if(isNaN(p.getTime())){if(s[c].includes(" ")){const u=s[c].split(" ");u.length>1&&(s[c]=u[1])}}else{const u=p.getHours().toString().padStart(2,"0"),d=p.getMinutes().toString().padStart(2,"0"),m=p.getSeconds().toString().padStart(2,"0");s[c]=`${u}:${d}:${m}`}}catch{if(s[c].includes(" ")){const u=s[c].split(" ");u.length>1&&(s[c]=u[1])}}}),s}),es=t=>{const{children:n,value:r,index:s,...o}=t;return e.jsx("div",{role:"tabpanel",hidden:r!==s,id:`export-tabpanel-${s}`,"aria-labelledby":`export-tab-${s}`,...o,children:r===s&&e.jsx(j,{sx:{p:2},children:n})})},Vn=()=>{const t=at(),{sourceFile:n,transformedData:r,validationErrors:s}=Ve(R=>R.formatter),[o,a]=O.useState(0),[c,p]=O.useState("csv"),[u,d]=O.useState(null),[m,y]=O.useState(null),[T,F]=O.useState(!1),[A,_]=O.useState({success:!1,message:"",open:!1}),[B,I]=O.useState([]),[Y,P]=O.useState(!1);O.useEffect(()=>{try{const R=localStorage.getItem("fireEmsExportHistory");R&&I(JSON.parse(R))}catch(R){console.error("Error loading export history:",R)}},[]),O.useEffect(()=>{try{localStorage.setItem("fireEmsExportHistory",JSON.stringify(B))}catch(R){console.error("Error saving export history:",R)}},[B]);const S=(R,L)=>{a(L)},H=R=>{p(R)},K=R=>{var L,ee;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleToolChange CALLED AT",new Date().toISOString()),console.log("🔧 TOOL SELECTION CHANGED - TRANSFORMING DATA UPFRONT:",R),console.log("🔧 transformedData exists:",!!r),console.log("🔧 transformedData length:",r==null?void 0:r.length),console.log('🔧 toolId === "response-time-analyzer":',R==="response-time-analyzer"),d(R),R==="response-time-analyzer"&&r&&r.length>0){console.log("🔧 APPLYING RESPONSE TIME ANALYZER TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",r[0]),console.log("Original field names:",Object.keys(r[0]));try{const f=Tt.transformToResponseTimeAnalyzer(r);if(!f.success){console.error("❌ Data transformation failed:",f.errors),y(null);return}const z=f.data||[];console.log("✅ UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed data sample (first record):",z[0]),console.log("Transformed field names:",Object.keys(z[0])),console.log("incidentTime value:",(L=z[0])==null?void 0:L.incidentTime),y(z)}catch(f){console.error("❌ Error during upfront transformation:",f),y(null)}}else if(R==="fire-map-pro"&&r&&r.length>0){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION - UPFRONT METHOD"),console.log("Original data sample (first record):",r[0]),console.log("Original field names:",Object.keys(r[0]));try{const f=Tt.transformToFireMapPro(r);if(!f.success){console.error("❌ Fire Map Pro transformation failed:",f.errors),y(null);return}const z=((ee=f.data)==null?void 0:ee.features)||[];console.log("✅ FIRE MAP PRO UPFRONT TRANSFORMATION SUCCESS"),console.log("Transformed features count:",z.length),console.log("Sample feature:",z[0]),y(z)}catch(f){console.error("❌ Error during Fire Map Pro upfront transformation:",f),y(null)}}else y(null)},G=(R,L,ee,f,z)=>{const $={id:`export-${Date.now()}-${Math.random().toString(36).substr(2,5)}`,timestamp:Date.now(),format:R,recordCount:L,success:ee,destination:f,fileName:z};I(V=>[$,...V].slice(0,20))},i=()=>{I([])},l=()=>{const R=new Date;return R.toLocaleDateString()+" "+R.toLocaleTimeString()},h=async()=>{if(!r||r.length===0){_({success:!1,message:"No data to export",open:!0});return}F(!0);try{const R=zn(r);let L=`formatted_data_${Date.now()}`;if(c==="excel"){const C=await ss(()=>import("./xlsx-DkH2s96g.js"),[]),v=C.utils.json_to_sheet(R),E={},q=Object.keys(r[0]);q.forEach(w=>{E[w]=Math.max(10,w.length+2)}),r.forEach(w=>{q.forEach(M=>{const b=String(w[M]||"");E[M]=Math.min(50,Math.max(E[M],b.length+2))})}),v["!cols"]=q.map(w=>({wch:E[w]}));const J=C.utils.book_new();J.Props={Title:"FireEMS Formatted Data",Subject:"Incident Data",Author:"FireEMS Data Formatter",CreatedDate:new Date},C.utils.book_append_sheet(J,v,"Formatted Data"),L=`formatted_data_${Date.now()}.xlsx`,C.writeFile(J,L),G("Excel",R.length,!0,"File Download",L),_({success:!0,message:"Data exported successfully as EXCEL",open:!0}),F(!1);return}if(c==="pdf"){const C=new Xs;C.setFontSize(18),C.text("FireEMS Formatted Data",14,22),C.setFontSize(11),C.text(`Export Date: ${l()}`,14,30),C.text(`Records: ${R.length}`,14,36);const v=Object.keys(R[0]);R.length>500&&C.text("Note: Export limited to 500 records for PDF format.",14,42);const E=R.length>500?48:42,q=30,J=10,w=10;C.setFontSize(10),C.setTextColor(0,0,0),C.setFillColor(220,220,220),v.forEach((b,g)=>{C.rect(w+g*q,E,q,J,"FD"),C.text(b,w+g*q+2,E+7)});const M=Math.min(R.length,20);for(let b=0;b<M;b++){const g=E+(b+1)*J;v.forEach((N,U)=>{C.rect(w+U*q,g,q,J,"S");const X=R[b][N]||"";let ne=String(X);ne.length>10&&(ne=ne.substring(0,8)+"..."),C.text(ne,w+U*q+2,g+7)})}C.setFontSize(8),C.text(`Generated by FireEMS Tools - ${new Date().toLocaleString()}`,C.internal.pageSize.width/2,C.internal.pageSize.height-10,{align:"center"}),L=`formatted_data_${Date.now()}.pdf`,C.save(L),G("PDF",R.length,!0,"File Download",L),_({success:!0,message:"Data exported successfully as PDF",open:!0}),F(!1);return}let ee="",f="";if(c==="csv"){const C=Object.keys(R[0]);ee=C.join(",")+`
`,R.forEach(v=>{const E=C.map(q=>{const J=v[q];return J==null?"":typeof J=="string"&&(J.includes(",")||J.includes('"')||J.includes(`
`))?`"${J.replace(/"/g,'""')}"`:J});ee+=E.join(",")+`
`}),L=`formatted_data_${Date.now()}.csv`,f="text/csv"}else c==="json"&&(ee=JSON.stringify(R,null,2),L=`formatted_data_${Date.now()}.json`,f="application/json");const z=new Blob([ee],{type:f}),$=URL.createObjectURL(z),V=document.createElement("a");V.href=$,V.download=L,document.body.appendChild(V),V.click(),document.body.removeChild(V),URL.revokeObjectURL($),G(c.toUpperCase(),R.length,!0,"File Download",L),_({success:!0,message:`Data exported successfully as ${c.toUpperCase()}`,open:!0})}catch(R){console.error("Export error:",R),_({success:!1,message:`Error exporting data: ${R instanceof Error?R.message:"Unknown error"}`,open:!0}),G(c.toUpperCase(),r.length,!1,"File Download")}finally{F(!1)}},D=R=>({"response-time-analyzer":"Response Time Analyzer","call-density-heatmap":"Call Density Heatmap","incident-dashboard":"Incident Dashboard","trend-analyzer":"Trend Analyzer"})[R]||R,k=async()=>{var L,ee;if(console.log("🚨🚨🚨 CRITICAL DEBUG: handleSendToTool FUNCTION CALLED AT",new Date().toISOString()),console.log("🚀🚀🚀 selectedExportTool:",u),console.log("🚀🚀🚀 transformedData length:",r==null?void 0:r.length),console.log("🚀🚀🚀 preTransformedData length:",m==null?void 0:m.length),console.log("🚀🚀🚀 transformedData sample:",r==null?void 0:r[0]),!r||r.length===0||!u){console.log("❌ SEND TO TOOL FAILED - Missing data or tool selection"),console.log("❌ transformedData:",!!r),console.log("❌ transformedData.length:",r==null?void 0:r.length),console.log("❌ selectedExportTool:",u),_({success:!1,message:"No data or tool selected",open:!0});return}F(!0);const R=D(u);console.log("🚀 Tool name resolved:",R);try{let f;if(console.log('🔧 CHECKING TOOL TYPE - selectedExportTool === "response-time-analyzer":',u==="response-time-analyzer"),console.log("🔧 CHECKING PRE-TRANSFORMED DATA AVAILABILITY:",!!m),u==="response-time-analyzer"&&m&&m.length>0)console.log("✅ USING PRE-TRANSFORMED DATA FROM TOOL SELECTION - NO REDUNDANT TRANSFORMATION"),console.log("Pre-transformed data sample (first record):",m[0]),console.log("Pre-transformed field names:",Object.keys(m[0])),console.log("incidentTime value:",(L=m[0])==null?void 0:L.incidentTime),f=m;else if(u==="fire-map-pro"){console.log("🔧 APPLYING FIRE MAP PRO TRANSFORMATION");const $=Tt.transformToFireMapPro(r);if(!$.success)throw console.error("❌ Data transformation failed:",$.errors),new Error(`Data transformation failed: ${$.errors.join(", ")}`);f=((ee=$.data)==null?void 0:ee.features)||[]}else console.log("🔧 USING STANDARD DATA FORMATTING"),console.log("DEBUG - USING ALREADY TRANSFORMED DATA: Sample data fields:",r.length>0?Object.keys(r[0]):"No data"),f=r.map($=>{const V={...$};return console.log("DEBUG - USING MAPPED DATA: Record fields:",Object.keys($)),Object.keys(V).forEach(C=>{if(V[C]&&typeof V[C]=="string"&&V[C].includes(" ")){const[v,E]=V[C].split(" ");console.log(`DATETIME SPLIT: Field "${C}" = "${V[C]}" -> Date: "${v}", Time: "${E}"`),C.toLowerCase().includes("date")?(console.log(`SETTING DATE FIELD "${C}" to "${v}"`),V[C]=v):C.toLowerCase().includes("time")&&(console.log(`SETTING TIME FIELD "${C}" to "${E}"`),V[C]=E)}}),V});const z={toolId:u,toolName:R,data:f,sourceFile:n==null?void 0:n.name,timestamp:Date.now(),fields:Object.keys(f[0]),recordCount:f.length,exportVersion:"2.0"};if(f.length>0){console.log("Sample record being sent (using user-mapped fields):",f[0]);const $=f[0],V=Object.keys($);console.log("All field names (as mapped by user):",V),console.log("Field values:",$)}sessionStorage.removeItem("fireEmsExportedData"),console.log("VERIFY: Field names being stored in sessionStorage:",z.data&&z.data.length>0?Object.keys(z.data[0]):"No data"),sessionStorage.setItem("fireEmsExportedData",JSON.stringify(z)),console.log(`Data prepared for ${u}. Data size: ${f.length} records`),f.length>0&&(console.log("FIELD NAMES CHECK - Sample record being sent to session storage:"),console.log(JSON.stringify(f[0]))),G("Data Transfer",f.length,!0,R),_({success:!0,message:`Data sent to ${R} successfully!`,open:!0}),setTimeout(()=>{const C=`http://${window.location.hostname}:5006`;let v="";if(u==="fire-map-pro")v=`${window.location.origin}/app/fire-map-pro`;else if(u==="response-time-analyzer")v=`${window.location.origin}/app/response-time-analyzer`;else if(u==="call-density-heatmap")v=`${C}/call-density-heatmap`;else if(u==="incident-dashboard")v=`${C}/incident-dashboard`;else if(u==="trend-analyzer")v=`${C}/trend-analyzer`;else{console.log(`Tool ID not recognized: ${u}`);return}console.log(`Redirecting to: ${v}`),window.location.href=v},500)}catch(f){console.error("Send to tool error:",f),_({success:!1,message:`Error sending data to tool: ${f instanceof Error?f.message:"Unknown error"}`,open:!0}),G("Data Transfer",r.length,!1,R)}finally{F(!1)}},W=()=>{t(ke(2))};if(!r||r.length===0)return e.jsxs(j,{children:[e.jsx(ce,{severity:"warning",sx:{mb:2},children:"No data available to export. Please go back and ensure your data is processed correctly."}),e.jsx(se,{variant:"outlined",startIcon:e.jsx(st,{}),onClick:W,children:"Back to Validation"})]});const Z=R=>new Date(R).toLocaleString(),le=()=>B.length===0?e.jsx(j,{sx:{p:2,textAlign:"center"},children:e.jsx(x,{color:"text.secondary",children:"No export history available"})}):e.jsx(ze,{sx:{width:"100%",bgcolor:"background.paper"},dense:!0,children:B.map(R=>e.jsxs(Ee,{secondaryAction:e.jsx(Ce,{edge:"end","aria-label":"delete",onClick:()=>{I(L=>L.filter(ee=>ee.id!==R.id))},children:e.jsx(nt,{fontSize:"small"})}),sx:{borderLeft:"4px solid",borderColor:R.success?"success.main":"error.main",mb:1,bgcolor:"background.paper","&:hover":{bgcolor:"action.hover"}},children:[e.jsxs(Oe,{children:[R.format==="Excel"&&e.jsx(mt,{color:"success"}),R.format==="CSV"&&e.jsx(At,{color:"primary"}),R.format==="JSON"&&e.jsx(ys,{color:"info"}),R.format==="PDF"&&e.jsx(mt,{color:"error"}),R.format==="Data Transfer"&&e.jsx(bs,{color:"secondary"})]}),e.jsx(Fe,{primary:e.jsx(x,{variant:"body2",fontWeight:"medium",children:R.format==="Data Transfer"?`Sent to ${R.destination}`:`${R.format} Export${R.fileName?` - ${R.fileName}`:""}`}),secondary:e.jsxs(x,{variant:"caption",display:"block",children:[Z(R.timestamp)," • ",R.recordCount," records",!R.success&&" • Failed"]})})]},R.id))});return console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - FRESH BUILD JUN 13 2025 16:47 - transformedData length:",r==null?void 0:r.length),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - selectedExportTool:",u),console.log("🔥🔥🔥 EXPORT CONTAINER RENDER - tabValue:",o),e.jsxs(j,{children:[e.jsx(x,{variant:"h5",gutterBottom:!0,sx:{mb:3},children:"Export Formatted Data"}),e.jsxs(ge,{sx:{p:2,mb:3},children:[e.jsxs(pe,{container:!0,spacing:2,children:[e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Source File"}),e.jsxs(x,{variant:"body1",children:[(n==null?void 0:n.name)||"No file"," (",n==null?void 0:n.type,")"]})]})}),e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Records"}),e.jsxs(x,{variant:"body1",children:[r.length," records processed"]})]})}),e.jsx(pe,{size:{xs:12,md:4},children:e.jsxs(j,{children:[e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Validation Status"}),e.jsx(j,{sx:{display:"flex",alignItems:"center",gap:1},children:s.length===0?e.jsxs(e.Fragment,{children:[e.jsx(qe,{color:"success"}),e.jsx(x,{color:"success.main",children:"All data is valid"})]}):e.jsx(e.Fragment,{children:e.jsxs(ce,{severity:"warning",sx:{mt:1},children:[s.length," validation issues found. Consider reviewing before export."]})})})]})})]}),e.jsxs(j,{sx:{display:"flex",justifyContent:"space-between",alignItems:"center",mt:2,pt:2,borderTop:"1px solid",borderColor:"divider"},children:[e.jsxs(j,{sx:{display:"flex",alignItems:"center",gap:1},children:[e.jsx($t,{color:"action",fontSize:"small"}),e.jsx(x,{variant:"subtitle2",color:"text.secondary",children:"Export History"}),B.length>0&&e.jsx(rr,{badgeContent:B.length,color:"primary",sx:{ml:1}})]}),e.jsxs(j,{children:[e.jsx(Ce,{size:"small",onClick:()=>P(!Y),"aria-label":Y?"Hide history":"Show history",children:Y?e.jsx(ms,{}):e.jsx(xt,{})}),B.length>0&&Y&&e.jsx(se,{size:"small",startIcon:e.jsx(nt,{}),onClick:i,sx:{ml:1},children:"Clear"})]})]}),e.jsx(cs,{in:Y,children:e.jsx(j,{sx:{mt:2},children:le()})})]}),e.jsx(j,{sx:{borderBottom:1,borderColor:"divider"},children:e.jsxs(yt,{value:o,onChange:S,"aria-label":"export options tabs",children:[e.jsx(_e,{label:"Download File",id:"export-tab-0","aria-controls":"export-tabpanel-0"}),e.jsx(_e,{label:"Send to Tool",id:"export-tab-1","aria-controls":"export-tabpanel-1"})]})}),e.jsx(es,{value:o,index:0,children:e.jsxs(pe,{container:!0,spacing:3,children:[e.jsx(pe,{size:{xs:12,md:6},children:e.jsx(Nn,{selectedFormat:c,onFormatChange:H})}),e.jsx(pe,{size:{xs:12,md:6},children:e.jsx(Ln,{dataCount:r.length,fields:Object.keys(r[0]),format:c})}),e.jsx(pe,{size:12,children:e.jsx(se,{variant:"contained",color:"primary",fullWidth:!0,size:"large",onClick:h,disabled:T,startIcon:T?e.jsx(Pe,{size:20}):e.jsx(Ks,{}),sx:{mt:2},children:T?"Exporting...":`Download as ${c.toUpperCase()}`})})]})}),e.jsx(es,{value:o,index:1,children:e.jsx(Pn,{selectedTool:u,onToolSelect:K,transformedData:r,onSendToTool:k,isSending:T,preTransformedData:m})}),e.jsx(xe,{sx:{my:3}}),e.jsx(j,{sx:{display:"flex",justifyContent:"space-between"},children:e.jsx(se,{variant:"outlined",startIcon:e.jsx(st,{}),onClick:W,children:"Back to Validation"})}),e.jsx(hs,{open:A.open,autoHideDuration:6e3,onClose:()=>_({...A,open:!1}),children:e.jsx(ce,{onClose:()=>_({...A,open:!1}),severity:A.success?"success":"error",children:A.message})})]})},ts={log:(...t)=>{},warn:(...t)=>{},error:(...t)=>{console.error(...t)},debug:(...t)=>{},info:(...t)=>{}},Un=["Upload File","Map Fields","Preview & Validate","Export"],Mo=()=>{const{currentStep:t}=Ve(s=>s.formatter),n=()=>{const s=window.location.pathname;return s.includes("fire-map-pro")?"FireEMS Fire Map Pro":s.includes("response-time-analyzer")?"FireEMS Response Time Analyzer":"FireEMS Data Formatter"};Je.useEffect(()=>{const s=n();document.title=s;try{gt(),ts.debug("[DEBUG] Vendor templates seeded successfully")}catch(o){ts.error("[ERROR] Failed to seed vendor templates:",o)}},[]);const r=s=>{switch(s){case 0:return e.jsx(Sr,{});case 1:return e.jsx(Cn,{});case 2:return e.jsx(kn,{});case 3:return e.jsx(Vn,{});default:return e.jsx(x,{children:"Unknown step"})}};return e.jsx(Ns,{maxWidth:"lg",sx:{mt:4,mb:4},children:e.jsxs(ge,{elevation:3,sx:{p:3},children:[e.jsx(x,{variant:"h4",component:"h1",gutterBottom:!0,children:n()}),e.jsx(nr,{activeStep:t,sx:{mb:4},children:Un.map(s=>e.jsx(or,{children:e.jsx(ar,{children:s})},s))}),e.jsx(j,{sx:{mt:2},children:r(t)})]})})};export{Mo as default};
