<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Data Transfer Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            line-height: 1.6;
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        .panel {
            border: 1px solid #ccc;
            padding: 15px;
            margin-bottom: 20px;
            border-radius: 4px;
        }
        .panel-header {
            margin-top: 0;
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
        }
        button {
            background-color: #4CAF50;
            color: white;
            border: none;
            padding: 10px 15px;
            margin: 5px;
            border-radius: 4px;
            cursor: pointer;
        }
        button:hover {
            background-color: #45a049;
        }
        .log-panel {
            background-color: #f5f5f5;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            margin-top: 10px;
            font-family: monospace;
        }
        .success {
            color: green;
        }
        .error {
            color: red;
        }
        .warning {
            color: orange;
        }
        .tab-buttons {
            display: flex;
            margin-bottom: 10px;
        }
        .tab-button {
            background-color: #f1f1f1;
            border: 1px solid #ccc;
            border-bottom: none;
            padding: 10px 20px;
            cursor: pointer;
            border-radius: 4px 4px 0 0;
            margin-right: 5px;
            color: #333;
        }
        .tab-button.active {
            background-color: white;
            border-bottom: 1px solid white;
        }
        .tab-content {
            display: none;
            border: 1px solid #ccc;
            padding: 15px;
            border-radius: 0 4px 4px 4px;
        }
        .tab-content.active {
            display: block;
        }
        pre {
            background-color: #f8f8f8;
            padding: 10px;
            border-radius: 4px;
            overflow-x: auto;
        }
        .status-indicator {
            padding: 5px 10px;
            border-radius: 3px;
            font-weight: bold;
            display: inline-block;
            margin-top: 5px;
        }
        .input-row {
            margin-bottom: 10px;
        }
        label {
            display: inline-block;
            width: 150px;
        }
        input[type="text"], input[type="number"] {
            padding: 5px;
            width: 300px;
        }
        select {
            padding: 5px;
            width: 312px;
        }
    </style>
</head>
<body>
    <h1>🔄 Data Transfer Test Utility</h1>
    <p>This utility helps test different methods of transferring data between pages to debug the Fire-EMS tools.</p>
    
    <div class="tab-buttons">
        <button class="tab-button active" onclick="openTab(event, 'send-tab')">Send Data</button>
        <button class="tab-button" onclick="openTab(event, 'receive-tab')">Receive Data</button>
        <button class="tab-button" onclick="openTab(event, 'debug-tab')">Debug Info</button>
    </div>
    
    <div id="send-tab" class="tab-content active">
        <h2 class="panel-header">Send Test Data</h2>
        
        <div class="panel">
            <h3>1. Configure Test Data</h3>
            <div class="input-row">
                <label for="record-count">Number of Records:</label>
                <input type="number" id="record-count" value="10" min="1" max="1000">
            </div>
            <div class="input-row">
                <label for="record-size">Approximate Size:</label>
                <select id="record-size">
                    <option value="small">Small (few fields)</option>
                    <option value="medium" selected>Medium (typical data)</option>
                    <option value="large">Large (many fields)</option>
                </select>
            </div>
            <button onclick="generateTestData()">Generate Test Data</button>
            <div id="data-preview" class="log-panel"></div>
        </div>
        
        <div class="panel">
            <h3>2. Choose Storage Method</h3>
            <div class="input-row">
                <label for="storage-method">Storage Method:</label>
                <select id="storage-method">
                    <option value="sessionStorage">sessionStorage (Default)</option>
                    <option value="localStorage">localStorage</option>
                    <option value="server">Server API</option>
                    <option value="all">All Methods (Fallback Chain)</option>
                </select>
            </div>
            <div class="input-row">
                <label for="target-page">Target Page:</label>
                <select id="target-page">
                    <option value="test-data-transfer.html?page=receiver">This Page (Receiver Mode)</option>
                    <option value="/fire-ems-dashboard">Response Time Analyzer</option>
                    <option value="/call-density-heatmap">Call Density Heatmap</option>
                </select>
            </div>
            <button onclick="storeAndRedirect()">Store Data & Redirect</button>
        </div>
    </div>
    
    <div id="receive-tab" class="tab-content">
        <h2 class="panel-header">Check Received Data</h2>
        
        <div class="panel">
            <h3>Transfer Status</h3>
            <div id="transfer-status">
                <p>Checking for transferred data...</p>
            </div>
            
            <h3>Attempt Recovery</h3>
            <button onclick="checkAllStorageMethods()">Try All Recovery Methods</button>
            <button onclick="checkSessionStorage()">Check sessionStorage</button>
            <button onclick="checkLocalStorage()">Check localStorage</button>
            <button onclick="checkServerStorage()">Check Server Storage</button>
        </div>
        
        <div class="panel">
            <h3>Received Data</h3>
            <div id="received-data-info"></div>
            <div id="received-data" class="log-panel"></div>
        </div>
    </div>
    
    <div id="debug-tab" class="tab-content">
        <h2 class="panel-header">Debug Information</h2>
        
        <div class="panel">
            <h3>Browser Storage Info</h3>
            <button onclick="checkBrowserStorage()">Check Storage Usage</button>
            <div id="storage-info" class="log-panel"></div>
        </div>
        
        <div class="panel">
            <h3>URL Parameters</h3>
            <div id="url-params"></div>
            <button onclick="updateUrlInfo()">Refresh URL Info</button>
        </div>
        
        <div class="panel">
            <h3>Console Log</h3>
            <div id="console-log" class="log-panel"></div>
        </div>
    </div>
    
    <script>
        // Global variables
        let testData = null;
        
        // Tab functionality
        function openTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
            }
            
            const tabButtons = document.getElementsByClassName("tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }
        
        // Log to both console and display
        function log(message, type = 'info') {
            const now = new Date().toLocaleTimeString();
            console.log(`[${type.toUpperCase()}] ${message}`);
            
            const logEl = document.getElementById('console-log');
            const logEntry = document.createElement('div');
            logEntry.className = type;
            logEntry.textContent = `[${now}] ${message}`;
            logEl.appendChild(logEntry);
            logEl.scrollTop = logEl.scrollHeight;
        }
        
        // Generate sample test data
        function generateTestData() {
            const count = parseInt(document.getElementById('record-count').value);
            const size = document.getElementById('record-size').value;
            
            testData = [];
            
            // Create sample data based on size selection
            for (let i = 0; i < count; i++) {
                const baseRecord = {
                    'Incident ID': `TEST-${i+1000}`,
                    'Incident Date': '2023-05-15',
                    'Incident Time': '08:00:00',
                    'Latitude': (33.4484 + (i * 0.01)).toFixed(4),
                    'Longitude': (-112.0740 - (i * 0.01)).toFixed(4),
                    'Unit': `Engine-${(i % 5) + 1}`,
                    'Reported': '08:00:00',
                    'Unit Dispatched': '08:01:30',
                    'Unit Enroute': '08:02:45',
                    'Unit Onscene': '08:07:15',
                    'Incident Type': ['FIRE', 'EMS', 'RESCUE', 'HAZMAT', 'OTHER'][i % 5]
                };
                
                // Add more fields for medium and large sizes
                if (size === 'medium' || size === 'large') {
                    baseRecord['Incident Address'] = `${1000 + i} Main St`;
                    baseRecord['Incident City'] = 'Phoenix';
                    baseRecord['Incident State'] = 'AZ';
                    baseRecord['Priority'] = (i % 3) + 1;
                    baseRecord['Station'] = `Station ${(i % 5) + 1}`;
                }
                
                // Add even more fields for large size
                if (size === 'large') {
                    baseRecord['Unit Cleared'] = '09:15:00';
                    baseRecord['Response Time'] = 5.75;
                    baseRecord['On Scene Time'] = 68.25;
                    baseRecord['Personnel Count'] = (i % 3) + 2;
                    baseRecord['Weather Conditions'] = 'Clear';
                    baseRecord['Temperature'] = 85 + (i % 10);
                    baseRecord['Wind Speed'] = 5 + (i % 8);
                    baseRecord['Wind Direction'] = ['N', 'NE', 'E', 'SE', 'S', 'SW', 'W', 'NW'][i % 8];
                    baseRecord['Humidity'] = 30 + (i % 20);
                    baseRecord['Pressure'] = 1010 + (i % 15);
                    baseRecord['Visibility'] = 10;
                    baseRecord['Call Taker'] = `Operator ${(i % 4) + 1}`;
                    baseRecord['Call Origin'] = ['911', 'Non-Emergency', 'Transfer', 'App', 'Alarm'][i % 5];
                    baseRecord['Duplicate'] = (i % 10 === 0) ? 'Yes' : 'No';
                    baseRecord['Notes'] = 'This is a sample record with many fields for testing large data transfers.';
                }
                
                testData.push(baseRecord);
            }
            
            // Preview the data
            const dataPreview = document.getElementById('data-preview');
            dataPreview.innerHTML = '';
            
            const totalSizeBytes = new Blob([JSON.stringify(testData)]).size;
            const totalSizeKB = (totalSizeBytes / 1024).toFixed(2);
            
            const infoDiv = document.createElement('div');
            infoDiv.innerHTML = `<strong>Generated ${count} records (${totalSizeKB} KB)</strong><br>
                                 Fields per record: ${Object.keys(testData[0]).length}<br>
                                 Sample first record:`;
            dataPreview.appendChild(infoDiv);
            
            const pre = document.createElement('pre');
            pre.textContent = JSON.stringify(testData[0], null, 2);
            dataPreview.appendChild(pre);
            
            log(`Generated ${count} test records of size ${size} (${totalSizeKB} KB)`, 'success');
        }
        
        // Store data using selected method and redirect
        async function storeAndRedirect() {
            if (!testData || testData.length === 0) {
                alert('Please generate test data first');
                return;
            }
            
            const method = document.getElementById('storage-method').value;
            const targetPage = document.getElementById('target-page').value;
            
            log(`Starting data transfer using ${method} method to ${targetPage}`, 'info');
            
            // Generate a unique key/token for storage
            const timestamp = Date.now();
            const randomString = Math.random().toString(36).substring(2, 10);
            const storageKey = `test_data_${timestamp}_${randomString}`;
            
            let storageSuccess = false;
            let redirectUrl = targetPage;
            
            // Storage functions - returns success status
            const storeInSessionStorage = () => {
                try {
                    log('Storing in sessionStorage...', 'info');
                    sessionStorage.setItem('formattedData', JSON.stringify(testData));
                    sessionStorage.setItem('dataSource', 'test-utility');
                    sessionStorage.setItem('testDataKey', storageKey);
                    sessionStorage.setItem('timestamp', timestamp);
                    log(`Successfully stored ${testData.length} records in sessionStorage`, 'success');
                    return true;
                } catch (error) {
                    log(`Error storing in sessionStorage: ${error.message}`, 'error');
                    return false;
                }
            };
            
            const storeInLocalStorage = () => {
                try {
                    log('Storing in localStorage...', 'info');
                    localStorage.setItem(storageKey, JSON.stringify({
                        data: testData,
                        metadata: {
                            source: 'test-utility',
                            timestamp: new Date().toISOString(),
                            recordCount: testData.length,
                            expiration: new Date(Date.now() + 1000 * 60 * 10).toISOString() // 10 minutes expiration
                        }
                    }));
                    log(`Successfully stored ${testData.length} records in localStorage with key: ${storageKey}`, 'success');
                    return true;
                } catch (error) {
                    log(`Error storing in localStorage: ${error.message}`, 'error');
                    return false;
                }
            };
            
            const storeOnServer = async () => {
                try {
                    log('Storing on server...', 'info');
                    const response = await fetch('/api/store-temp-data', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            token: storageKey,
                            data: testData,
                            expiry: Date.now() + (10 * 60 * 1000) // 10 minute expiry
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        log(`Successfully stored ${testData.length} records on server with token: ${storageKey}`, 'success');
                        return true;
                    } else {
                        log(`Server storage failed: ${result.error}`, 'error');
                        return false;
                    }
                } catch (error) {
                    log(`Error storing on server: ${error.message}`, 'error');
                    return false;
                }
            };
            
            // Apply the selected storage method(s)
            if (method === 'sessionStorage' || method === 'all') {
                const sessionSuccess = storeInSessionStorage();
                storageSuccess = storageSuccess || sessionSuccess;
                
                if (sessionSuccess) {
                    redirectUrl += (redirectUrl.includes('?') ? '&' : '?') + 
                                  `from_test=true&storage_method=sessionStorage&t=${timestamp}`;
                }
            }
            
            if (method === 'localStorage' || method === 'all') {
                const localSuccess = storeInLocalStorage();
                storageSuccess = storageSuccess || localSuccess;
                
                if (localSuccess) {
                    redirectUrl += (redirectUrl.includes('?') ? '&' : '?') + 
                                  `from_test=true&storage_method=localStorage&formatter_data=${storageKey}&t=${timestamp}`;
                }
            }
            
            if (method === 'server' || method === 'all') {
                const serverSuccess = await storeOnServer();
                storageSuccess = storageSuccess || serverSuccess;
                
                if (serverSuccess) {
                    redirectUrl += (redirectUrl.includes('?') ? '&' : '?') + 
                                  `from_test=true&storage_method=server&data_token=${storageKey}&t=${timestamp}`;
                }
            }
            
            if (!storageSuccess) {
                log('All storage methods failed!', 'error');
                alert('All storage methods failed! Check the console log for details.');
                return;
            }
            
            // Add test data info to the URL
            redirectUrl += (redirectUrl.includes('?') ? '&' : '?') + 
                          `records=${testData.length}`;
            
            // Redirect to the target page
            log(`Redirecting to: ${redirectUrl}`, 'info');
            window.location.href = redirectUrl;
        }
        
        // Check for received data in sessionStorage
        function checkSessionStorage() {
            log('Checking sessionStorage...', 'info');
            
            try {
                const formattedData = sessionStorage.getItem('formattedData');
                const dataSource = sessionStorage.getItem('dataSource');
                const testDataKey = sessionStorage.getItem('testDataKey');
                const timestamp = sessionStorage.getItem('timestamp');
                
                if (formattedData) {
                    try {
                        const data = JSON.parse(formattedData);
                        
                        log(`Found data in sessionStorage: ${data.length} records`, 'success');
                        updateReceivedData({
                            method: 'sessionStorage',
                            data,
                            metadata: {
                                source: dataSource || 'unknown',
                                key: testDataKey || 'unknown',
                                timestamp: timestamp || 'unknown'
                            }
                        });
                        
                        return true;
                    } catch (error) {
                        log(`Error parsing sessionStorage data: ${error.message}`, 'error');
                    }
                } else {
                    log('No data found in sessionStorage', 'warning');
                }
            } catch (error) {
                log(`Error accessing sessionStorage: ${error.message}`, 'error');
            }
            
            return false;
        }
        
        // Check for received data in localStorage
        function checkLocalStorage() {
            log('Checking localStorage...', 'info');
            
            try {
                // Get the key from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const formatterData = urlParams.get('formatter_data');
                
                if (formatterData) {
                    log(`Found formatter_data parameter: ${formatterData}`, 'info');
                    
                    try {
                        const storedData = localStorage.getItem(formatterData);
                        
                        if (storedData) {
                            try {
                                const parsedData = JSON.parse(storedData);
                                
                                if (parsedData.data) {
                                    log(`Found data in localStorage with key ${formatterData}: ${parsedData.data.length} records`, 'success');
                                    updateReceivedData({
                                        method: 'localStorage',
                                        data: parsedData.data,
                                        metadata: parsedData.metadata || {
                                            source: 'unknown',
                                            key: formatterData
                                        }
                                    });
                                    
                                    // Optionally copy to sessionStorage for normal processing
                                    try {
                                        sessionStorage.setItem('formattedData', JSON.stringify(parsedData.data));
                                        log('Copied data from localStorage to sessionStorage', 'success');
                                    } catch (e) {
                                        log(`Error copying to sessionStorage: ${e.message}`, 'error');
                                    }
                                    
                                    return true;
                                } else {
                                    log('Data found in localStorage but missing data field', 'warning');
                                }
                            } catch (error) {
                                log(`Error parsing localStorage data: ${error.message}`, 'error');
                            }
                        } else {
                            log(`No data found in localStorage with key: ${formatterData}`, 'warning');
                            
                            // Try alternate keys
                            log('Searching for data with similar keys...', 'info');
                            const foundKey = findSimilarLocalStorageKey(formatterData);
                            
                            if (foundKey) {
                                log(`Found similar key: ${foundKey}`, 'success');
                                try {
                                    const alternateData = localStorage.getItem(foundKey);
                                    const parsedAlternateData = JSON.parse(alternateData);
                                    
                                    if (parsedAlternateData.data) {
                                        log(`Found data with alternate key: ${parsedAlternateData.data.length} records`, 'success');
                                        updateReceivedData({
                                            method: 'localStorage (alternate key)',
                                            data: parsedAlternateData.data,
                                            metadata: parsedAlternateData.metadata || {
                                                source: 'unknown',
                                                key: foundKey
                                            }
                                        });
                                        
                                        // Copy to sessionStorage
                                        try {
                                            sessionStorage.setItem('formattedData', JSON.stringify(parsedAlternateData.data));
                                            log('Copied data from localStorage to sessionStorage', 'success');
                                        } catch (e) {
                                            log(`Error copying to sessionStorage: ${e.message}`, 'error');
                                        }
                                        
                                        return true;
                                    }
                                } catch (e) {
                                    log(`Error processing alternate key: ${e.message}`, 'error');
                                }
                            }
                        }
                    } catch (error) {
                        log(`Error accessing localStorage: ${error.message}`, 'error');
                    }
                } else {
                    log('No formatter_data parameter found in URL', 'info');
                    
                    // Scan all keys
                    log('Scanning localStorage for recent data...', 'info');
                    
                    const recentKey = findMostRecentLocalStorageData();
                    if (recentKey) {
                        log(`Found recent data with key: ${recentKey}`, 'success');
                        try {
                            const recentData = localStorage.getItem(recentKey);
                            const parsedRecentData = JSON.parse(recentData);
                            
                            if (parsedRecentData.data) {
                                log(`Found recent data: ${parsedRecentData.data.length} records`, 'success');
                                updateReceivedData({
                                    method: 'localStorage (scanned)',
                                    data: parsedRecentData.data,
                                    metadata: parsedRecentData.metadata || {
                                        source: 'unknown',
                                        key: recentKey
                                    }
                                });
                                
                                return true;
                            }
                        } catch (e) {
                            log(`Error processing recent data: ${e.message}`, 'error');
                        }
                    }
                }
            } catch (error) {
                log(`Error in localStorage check: ${error.message}`, 'error');
            }
            
            return false;
        }
        
        // Find similar localStorage key
        function findSimilarLocalStorageKey(keyPattern) {
            try {
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    // Check if key matches pattern or contains similar components
                    if (key && (
                        key.includes('formatter_data') || 
                        key.includes('test_data') || 
                        key.startsWith('formatter_') || 
                        key.startsWith('test_')
                    )) {
                        return key;
                    }
                }
            } catch (e) {
                log(`Error searching for similar keys: ${e.message}`, 'error');
            }
            
            return null;
        }
        
        // Find most recent localStorage data
        function findMostRecentLocalStorageData() {
            try {
                let latestKey = null;
                let latestTime = 0;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    
                    // Check if key matches data patterns
                    if (key && (
                        key.includes('data') || 
                        key.includes('formatter') || 
                        key.includes('test')
                    )) {
                        try {
                            const storedData = localStorage.getItem(key);
                            const parsedData = JSON.parse(storedData);
                            
                            // Check if it has a timestamp in metadata
                            if (parsedData.metadata && parsedData.metadata.timestamp) {
                                const timestamp = new Date(parsedData.metadata.timestamp).getTime();
                                
                                if (timestamp > latestTime) {
                                    latestTime = timestamp;
                                    latestKey = key;
                                }
                            }
                            // Otherwise check if it has a numeric component in the key
                            else if (key.match(/\d+/)) {
                                const numbers = key.match(/\d+/g);
                                const keyTime = parseInt(numbers[0]);
                                
                                if (!isNaN(keyTime) && keyTime > latestTime) {
                                    latestTime = keyTime;
                                    latestKey = key;
                                }
                            }
                        } catch (e) {
                            // Ignore parsing errors for non-data entries
                            console.log(`Skipping non-data key: ${key}`);
                        }
                    }
                }
                
                return latestKey;
            } catch (e) {
                log(`Error finding most recent data: ${e.message}`, 'error');
                return null;
            }
        }
        
        // Check for received data in server storage
        async function checkServerStorage() {
            log('Checking server storage...', 'info');
            
            try {
                // Get the token from URL parameters
                const urlParams = new URLSearchParams(window.location.search);
                const dataToken = urlParams.get('data_token');
                
                if (dataToken) {
                    log(`Found data_token parameter: ${dataToken}`, 'info');
                    
                    try {
                        const response = await fetch(`/api/get-temp-data?token=${dataToken}`);
                        const result = await response.json();
                        
                        if (result.success && result.data) {
                            log(`Retrieved data from server: ${result.data.length} records`, 'success');
                            updateReceivedData({
                                method: 'server',
                                data: result.data,
                                metadata: {
                                    source: 'server',
                                    token: dataToken,
                                    created: result.created,
                                    expires_at: result.expires_at
                                }
                            });
                            
                            // Optionally copy to sessionStorage for normal processing
                            try {
                                sessionStorage.setItem('formattedData', JSON.stringify(result.data));
                                log('Copied data from server to sessionStorage', 'success');
                            } catch (e) {
                                log(`Error copying to sessionStorage: ${e.message}`, 'error');
                            }
                            
                            return true;
                        } else {
                            log(`Server returned error: ${result.error || 'Unknown error'}`, 'error');
                        }
                    } catch (error) {
                        log(`Error retrieving from server: ${error.message}`, 'error');
                    }
                } else {
                    log('No data_token parameter found in URL', 'warning');
                }
            } catch (error) {
                log(`Error in server storage check: ${error.message}`, 'error');
            }
            
            return false;
        }
        
        // Check all storage methods in sequence
        async function checkAllStorageMethods() {
            log('Checking all storage methods...', 'info');
            
            // First try sessionStorage (fastest and simplest)
            if (checkSessionStorage()) {
                return true;
            }
            
            // Next try localStorage (more reliable between pages)
            if (checkLocalStorage()) {
                return true;
            }
            
            // Finally try server storage (most reliable)
            if (await checkServerStorage()) {
                return true;
            }
            
            log('No data found in any storage location', 'error');
            return false;
        }
        
        // Update received data display
        function updateReceivedData(result) {
            const infoDiv = document.getElementById('received-data-info');
            const dataDiv = document.getElementById('received-data');
            const statusDiv = document.getElementById('transfer-status');
            
            if (result && result.data) {
                // Update status
                statusDiv.innerHTML = `
                    <div class="status-indicator" style="background-color: #e8f5e9; color: #2e7d32;">
                        ✅ Data transfer successful via ${result.method}
                    </div>
                    <p>Retrieved ${result.data.length} records</p>
                `;
                
                // Update info
                infoDiv.innerHTML = `
                    <p><strong>Records:</strong> ${result.data.length}</p>
                    <p><strong>Method:</strong> ${result.method}</p>
                    <p><strong>Source:</strong> ${result.metadata?.source || 'Unknown'}</p>
                    <p><strong>Key/Token:</strong> ${result.metadata?.key || result.metadata?.token || 'Unknown'}</p>
                    <p><strong>Fields:</strong> ${Object.keys(result.data[0]).length}</p>
                    <p><strong>Size:</strong> ${(new Blob([JSON.stringify(result.data)]).size / 1024).toFixed(2)} KB</p>
                `;
                
                // Show sample data
                dataDiv.innerHTML = '';
                const pre = document.createElement('pre');
                pre.textContent = JSON.stringify(result.data[0], null, 2);
                dataDiv.appendChild(pre);
            } else {
                statusDiv.innerHTML = `
                    <div class="status-indicator" style="background-color: #ffebee; color: #c62828;">
                        ❌ No data found
                    </div>
                    <p>Could not find any transferred data.</p>
                `;
                
                infoDiv.innerHTML = '<p>No data available</p>';
                dataDiv.innerHTML = '<p>No data to display</p>';
            }
        }
        
        // Check browser storage usage
        function checkBrowserStorage() {
            log('Checking browser storage usage...', 'info');
            const infoDiv = document.getElementById('storage-info');
            infoDiv.innerHTML = '';
            
            try {
                // Check localStorage
                let localStorageSize = 0;
                let itemCount = 0;
                let dataItems = 0;
                
                const storageInfo = document.createElement('div');
                
                // Calculate localStorage usage
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    localStorageSize += (key.length + value.length) * 2; // Rough estimate in bytes (UTF-16)
                    itemCount++;
                    
                    if (key.includes('data') || key.includes('formatter') || key.includes('test')) {
                        dataItems++;
                    }
                }
                
                // Check sessionStorage
                let sessionStorageSize = 0;
                let sessionItemCount = 0;
                
                for (let i = 0; i < sessionStorage.length; i++) {
                    const key = sessionStorage.key(i);
                    const value = sessionStorage.getItem(key);
                    sessionStorageSize += (key.length + value.length) * 2;
                    sessionItemCount++;
                }
                
                // Create summary
                storageInfo.innerHTML = `
                    <h4>localStorage</h4>
                    <p>Total Size: ${(localStorageSize / 1024).toFixed(2)} KB</p>
                    <p>Items: ${itemCount} (${dataItems} data-related)</p>
                    <p>Limit: ~5-10 MB (varies by browser)</p>
                    
                    <h4>sessionStorage</h4>
                    <p>Total Size: ${(sessionStorageSize / 1024).toFixed(2)} KB</p>
                    <p>Items: ${sessionItemCount}</p>
                    <p>Limit: ~5-10 MB (varies by browser)</p>
                `;
                
                infoDiv.appendChild(storageInfo);
                
                // List keys
                const keyList = document.createElement('div');
                keyList.innerHTML = '<h4>localStorage Keys</h4>';
                
                const keyTable = document.createElement('table');
                keyTable.style.width = '100%';
                keyTable.style.borderCollapse = 'collapse';
                keyTable.innerHTML = `
                    <tr>
                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd;">Key</th>
                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd;">Size</th>
                        <th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd;">Type</th>
                    </tr>
                `;
                
                for (let i = 0; i < localStorage.length; i++) {
                    const key = localStorage.key(i);
                    const value = localStorage.getItem(key);
                    const size = (value.length * 2) / 1024; // KB
                    
                    let type = 'Unknown';
                    try {
                        const parsed = JSON.parse(value);
                        type = Array.isArray(parsed) ? 'Array' : 'Object';
                        if (parsed.data && Array.isArray(parsed.data)) {
                            type = `Data Array (${parsed.data.length} items)`;
                        }
                    } catch (e) {
                        type = 'String';
                    }
                    
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td style="padding: 5px; border-bottom: 1px solid #eee;">${key}</td>
                        <td style="padding: 5px; border-bottom: 1px solid #eee;">${size.toFixed(2)} KB</td>
                        <td style="padding: 5px; border-bottom: 1px solid #eee;">${type}</td>
                    `;
                    keyTable.appendChild(row);
                }
                
                keyList.appendChild(keyTable);
                infoDiv.appendChild(keyList);
                
                log('Storage usage summary generated', 'success');
            } catch (error) {
                infoDiv.innerHTML = `<p class="error">Error checking storage: ${error.message}</p>`;
                log(`Error checking storage: ${error.message}`, 'error');
            }
        }
        
        // Update URL parameter information
        function updateUrlInfo() {
            const urlParamsDiv = document.getElementById('url-params');
            const urlParams = new URLSearchParams(window.location.search);
            
            if (urlParams.toString()) {
                let paramHtml = '<h4>Current URL Parameters</h4><table style="width: 100%; border-collapse: collapse;">';
                paramHtml += `<tr><th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd;">Parameter</th><th style="text-align: left; padding: 5px; border-bottom: 1px solid #ddd;">Value</th></tr>`;
                
                urlParams.forEach((value, key) => {
                    paramHtml += `<tr><td style="padding: 5px; border-bottom: 1px solid #eee;">${key}</td><td style="padding: 5px; border-bottom: 1px solid #eee;">${value}</td></tr>`;
                });
                
                paramHtml += '</table>';
                urlParamsDiv.innerHTML = paramHtml;
            } else {
                urlParamsDiv.innerHTML = '<p>No URL parameters found</p>';
            }
        }
        
        // Initialize the page
        document.addEventListener('DOMContentLoaded', function() {
            // Set up logging
            const originalConsoleLog = console.log;
            const originalConsoleError = console.error;
            const originalConsoleWarn = console.warn;
            
            console.log = function() {
                originalConsoleLog.apply(console, arguments);
                const message = Array.from(arguments).join(' ');
                
                // Log to our UI
                const logEl = document.getElementById('console-log');
                if (logEl) {
                    const logEntry = document.createElement('div');
                    logEntry.textContent = message;
                    logEl.appendChild(logEntry);
                    logEl.scrollTop = logEl.scrollHeight;
                }
            };
            
            console.error = function() {
                originalConsoleError.apply(console, arguments);
                const message = Array.from(arguments).join(' ');
                
                // Log to our UI
                const logEl = document.getElementById('console-log');
                if (logEl) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'error';
                    logEntry.textContent = message;
                    logEl.appendChild(logEntry);
                    logEl.scrollTop = logEl.scrollHeight;
                }
            };
            
            console.warn = function() {
                originalConsoleWarn.apply(console, arguments);
                const message = Array.from(arguments).join(' ');
                
                // Log to our UI
                const logEl = document.getElementById('console-log');
                if (logEl) {
                    const logEntry = document.createElement('div');
                    logEntry.className = 'warning';
                    logEntry.textContent = message;
                    logEl.appendChild(logEntry);
                    logEl.scrollTop = logEl.scrollHeight;
                }
            };
            
            // Initialize
            updateUrlInfo();
            
            // Check if we're in receiver mode
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('page') === 'receiver' || urlParams.has('from_test')) {
                // Switch to receiver tab
                document.querySelector(`button[onclick="openTab(event, 'receive-tab')"]`).click();
                
                // Try to find data
                checkAllStorageMethods();
            } else {
                // Generate some test data
                generateTestData();
            }
        });
    </script>
</body>
</html>